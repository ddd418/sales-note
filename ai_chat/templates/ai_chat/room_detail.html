{% extends 'reporting/base.html' %}
{% load static %}

{% block title %}{{ room.followup.customer_name }} - AI 분석{% endblock %}

{% block extra_css %}
<style>
  /* ============================================
     모달 Z-INDEX 및 오버레이 수정 (CRITICAL FIX)
     ============================================ */
  .modal-backdrop {
    display: none !important;
  }
  .modal {
    z-index: 1055 !important;
    pointer-events: none !important;
  }
  .modal-dialog {
    z-index: 1056 !important;
    pointer-events: auto !important;
  }
  .modal-content {
    position: relative;
    z-index: 1057 !important;
    pointer-events: auto !important;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
  }
  .modal-header,
  .modal-body,
  .modal-footer,
  .modal-header *,
  .modal-body *,
  .modal-footer * {
    pointer-events: auto !important;
  }

  /* ============================================
     AI Chat Room - 다크 테마 채팅 UI
     ============================================ */
  .ai-chat-container {
    display: flex;
    gap: 1rem;
    max-width: 1400px;
    margin: 0 auto;
    padding: 1rem;
    height: calc(100vh - 120px);
  }

  /* ---------- 왼쪽: 채팅 영역 ---------- */
  .ai-chat-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
  }
  .ai-chat-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px 12px 0 0;
  }
  .ai-chat-header .back-btn {
    color: var(--text-secondary);
    text-decoration: none;
    font-size: 1.1rem;
  }
  .ai-chat-header .back-btn:hover { color: var(--primary); }
  .ai-chat-header h5 {
    margin: 0;
    color: var(--text-primary);
    font-weight: 600;
    font-size: 1rem;
  }
  .ai-chat-header .badge-ai {
    background: linear-gradient(135deg, #8b5cf6, #6366f1);
    color: #fff;
    font-size: 0.65rem;
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
    font-weight: 600;
  }

  /* 채팅 메시지 영역 */
  .ai-chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    background: var(--background);
    border-left: 1px solid var(--border);
    border-right: 1px solid var(--border);
  }
  .chat-msg {
    margin-bottom: 1rem;
    display: flex;
    gap: 0.5rem;
  }
  .chat-msg.user-msg { justify-content: flex-end; }
  .chat-msg.ai-msg { justify-content: flex-start; }

  .chat-bubble {
    max-width: 80%;
    padding: 0.75rem 1rem;
    border-radius: 12px;
    font-size: 0.9rem;
    line-height: 1.5;
    word-break: break-word;
  }
  .user-msg .chat-bubble {
    background: var(--primary);
    color: #fff;
    border-bottom-right-radius: 4px;
  }
  .ai-msg .chat-bubble {
    background: var(--surface);
    color: var(--text-primary);
    border: 1px solid var(--border);
    border-bottom-left-radius: 4px;
  }
  .chat-bubble .msg-time {
    font-size: 0.7rem;
    color: rgba(255,255,255,0.6);
    margin-top: 0.25rem;
    text-align: right;
  }
  .ai-msg .chat-bubble .msg-time {
    color: var(--text-secondary);
  }

  /* AI 구조화 응답 표시 */
  .ai-structured {
    margin-top: 0.75rem;
    padding: 0.75rem;
    background: rgba(99, 102, 241, 0.05);
    border: 1px solid rgba(99, 102, 241, 0.15);
    border-radius: 8px;
  }
  .ai-structured h6 {
    font-size: 0.8rem;
    font-weight: 700;
    color: #8b5cf6;
    margin-bottom: 0.5rem;
  }
  .ai-summary-list {
    list-style: none;
    padding: 0;
    margin: 0 0 0.5rem 0;
  }
  .ai-summary-list li {
    font-size: 0.85rem;
    padding: 0.2rem 0;
    color: var(--text-primary);
  }

  /* 입력 영역 */
  .ai-chat-input {
    display: flex;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 0 0 12px 12px;
  }
  .ai-chat-input textarea {
    flex: 1;
    background: var(--background);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-primary);
    padding: 0.5rem 0.75rem;
    font-size: 0.9rem;
    resize: none;
    min-height: 42px;
    max-height: 120px;
  }
  .ai-chat-input textarea:focus {
    outline: none;
    border-color: var(--primary);
  }
  .ai-chat-input textarea::placeholder { color: var(--text-secondary); }
  .ai-chat-input .btn-send {
    background: var(--primary);
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 0 1rem;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    white-space: nowrap;
  }
  .ai-chat-input .btn-send:hover { opacity: 0.9; }
  .ai-chat-input .btn-send:disabled { opacity: 0.5; cursor: not-allowed; }

  /* ---------- 오른쪽: PainPoint 카드 패널 ---------- */
  .ai-card-panel {
    width: 380px;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    overflow-y: auto;
    max-height: calc(100vh - 120px);
  }
  .ai-panel-title {
    font-size: 0.9rem;
    font-weight: 700;
    color: var(--text-primary);
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--border);
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  /* 미팅록 분석 버튼 영역 */
  .ai-history-section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
  }
  .ai-history-section h6 {
    font-size: 0.8rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
  }
  .history-analyze-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    width: 100%;
    background: rgba(99, 102, 241, 0.08);
    border: 1px solid rgba(99, 102, 241, 0.2);
    border-radius: 8px;
    padding: 0.5rem 0.75rem;
    color: var(--text-primary);
    font-size: 0.8rem;
    cursor: pointer;
    margin-bottom: 0.4rem;
    transition: all 0.2s;
  }
  .history-analyze-btn:hover {
    background: rgba(99, 102, 241, 0.15);
    border-color: var(--primary);
  }
  .history-analyze-btn .date-label {
    font-weight: 600;
    color: #8b5cf6;
    min-width: 70px;
  }
  .history-analyze-btn .history-preview {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: var(--text-secondary);
  }
  .history-analyze-btn i.fa-wand-magic-sparkles {
    color: #8b5cf6;
  }

  /* PainPoint 카드 */
  .painpoint-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0.75rem;
    transition: all 0.2s;
  }
  .painpoint-card:hover {
    border-color: var(--primary);
  }
  .painpoint-card.verified-confirmed {
    border-left: 3px solid var(--success);
  }
  .painpoint-card.verified-denied {
    border-left: 3px solid var(--danger);
    opacity: 0.7;
  }

  .card-header-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.4rem;
  }
  .card-category {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
    background: rgba(99, 102, 241, 0.12);
    color: #8b5cf6;
  }
  .card-confidence {
    font-size: 0.7rem;
    font-weight: 700;
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
  }
  .confidence-high { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
  .confidence-med  { background: rgba(251, 191, 36, 0.15); color: #fbbf24; }
  .confidence-low  { background: rgba(239, 68, 68, 0.15); color: #ef4444; }

  .card-hypothesis {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.3rem;
    line-height: 1.4;
  }
  .card-evidence {
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-bottom: 0.3rem;
    padding-left: 0.5rem;
    border-left: 2px solid var(--border);
  }
  .card-evidence .ev-type {
    font-size: 0.65rem;
    font-weight: 600;
    padding: 0.1rem 0.3rem;
    border-radius: 3px;
    margin-right: 0.25rem;
  }
  .ev-type-quote { background: rgba(99, 102, 241, 0.15); color: #818cf8; }
  .ev-type-fact  { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
  .ev-type-guess { background: rgba(251, 191, 36, 0.15); color: #fbbf24; }

  .card-question {
    font-size: 0.8rem;
    color: var(--primary-light);
    font-style: italic;
    margin: 0.3rem 0;
    padding: 0.4rem 0.5rem;
    background: rgba(99, 102, 241, 0.05);
    border-radius: 6px;
  }

  .card-actions-row {
    display: flex;
    gap: 0.4rem;
    margin-top: 0.5rem;
  }
  .card-actions-row details {
    flex: 1;
    font-size: 0.75rem;
  }
  .card-actions-row summary {
    cursor: pointer;
    color: var(--text-secondary);
    padding: 0.2rem 0;
  }
  .card-actions-row .detail-content {
    padding: 0.3rem 0;
    color: var(--text-primary);
  }

  .card-verify-btns {
    display: flex;
    gap: 0.4rem;
    margin-top: 0.5rem;
  }
  .btn-verify {
    font-size: 0.75rem;
    padding: 0.3rem 0.6rem;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: transparent;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s;
  }
  .btn-verify-yes { color: #22c55e; border-color: rgba(34, 197, 94, 0.3); }
  .btn-verify-yes:hover { background: rgba(34, 197, 94, 0.15); }
  .btn-verify-no  { color: #ef4444; border-color: rgba(239, 68, 68, 0.3); }
  .btn-verify-no:hover  { background: rgba(239, 68, 68, 0.15); }
  .card-verification-status {
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.3rem 0.6rem;
    border-radius: 6px;
  }

  /* 로딩 */
  .ai-loading {
    display: none;
    text-align: center;
    padding: 1rem;
    color: var(--text-secondary);
  }
  .ai-loading.active { display: block; }
  .ai-loading .spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid var(--border);
    border-top-color: #8b5cf6;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* 반응형: 모바일 */
  @media (max-width: 1024px) {
    .ai-chat-container {
      flex-direction: column;
      height: auto;
    }
    .ai-card-panel {
      width: 100%;
      max-height: none;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="ai-chat-container">

  <!-- ========== 왼쪽: 채팅 ========== -->
  <div class="ai-chat-main">
    <div class="ai-chat-header">
      <a href="{% url 'ai_chat:room_list' %}" class="back-btn">
        <i class="fas fa-arrow-left"></i>
      </a>
      <h5>{{ room.followup.customer_name }}
        {% if room.followup.department %}
          <span style="color: var(--text-secondary); font-weight: 400; font-size: 0.85rem;">
            / {{ room.followup.department.name }}
          </span>
        {% endif %}
      </h5>
      <span class="badge-ai">AI</span>
    </div>

    <div class="ai-chat-messages" id="chatMessages">
      {% for msg in messages %}
        <div class="chat-msg {% if msg.role == 'user' %}user-msg{% else %}ai-msg{% endif %}">
          <div class="chat-bubble">
            {% if msg.role == 'assistant' and msg.structured_data %}
              <!-- 구조화 응답: 요약 표시 -->
              {% if msg.structured_data.summary_3lines %}
                <div class="ai-structured">
                  <h6><i class="fas fa-list-check"></i> 3줄 요약</h6>
                  <ul class="ai-summary-list">
                    {% for line in msg.structured_data.summary_3lines %}
                      <li>• {{ line }}</li>
                    {% endfor %}
                  </ul>
                </div>
              {% endif %}
              {% if msg.structured_data.crm_update %}
                <div class="ai-structured" style="margin-top: 0.5rem;">
                  <h6><i class="fas fa-bullseye"></i> CRM 추천</h6>
                  {% with crm=msg.structured_data.crm_update %}
                    {% if crm.stage %}<div style="font-size:0.8rem;"><strong>스테이지:</strong> {{ crm.stage }}</div>{% endif %}
                    {% if crm.must_get_next_visit %}<div style="font-size:0.8rem;"><strong>다음 방문 필수:</strong> {{ crm.must_get_next_visit }}</div>{% endif %}
                    {% if crm.reminder %}<div style="font-size:0.8rem;"><strong>리마인더:</strong> {{ crm.reminder }}</div>{% endif %}
                  {% endwith %}
                </div>
              {% endif %}
              {% if msg.structured_data.next_action_feedback %}
                {% with naf=msg.structured_data.next_action_feedback %}
                <div class="ai-structured" style="margin-top: 0.5rem;">
                  <h6><i class="fas fa-forward"></i> 다음 액션 피드백
                    {% if naf.evaluation == 'good' %}<span style="color:#22c55e;">✔ Good</span>
                    {% elif naf.evaluation == 'weak' %}<span style="color:#fbbf24;">⚠ Weak</span>
                    {% elif naf.evaluation == 'risky' %}<span style="color:#ef4444;">⚠ Risky</span>
                    {% elif naf.evaluation == 'missing' %}<span style="color:#94a3b8;">❓ Missing</span>
                    {% endif %}
                  </h6>
                  {% if naf.original_action %}<div style="font-size:0.8rem; margin-bottom:0.3rem;"><strong>원래 액션:</strong> {{ naf.original_action }}</div>{% endif %}
                  {% if naf.feedback %}<div style="font-size:0.8rem; margin-bottom:0.3rem;">{{ naf.feedback }}</div>{% endif %}
                  {% if naf.suggested_actions %}
                    <div style="font-size:0.8rem; margin-top:0.3rem;"><strong>추천 액션:</strong></div>
                    {% for action in naf.suggested_actions %}
                      <div style="font-size:0.8rem; padding-left:0.5rem;">→ {{ action }}</div>
                    {% endfor %}
                  {% endif %}
                </div>
                {% endwith %}
              {% endif %}
              {% if msg.structured_data.missing_info.items %}
                <div class="ai-structured" style="margin-top: 0.5rem;">
                  <h6><i class="fas fa-question-circle"></i> 누락/확인 필요</h6>
                  {% for item in msg.structured_data.missing_info.items %}
                    <div style="font-size:0.8rem; color: #fbbf24;">⚠ {{ item }}</div>
                  {% endfor %}
                </div>
              {% endif %}
            {% else %}
              {{ msg.content|linebreaksbr }}
            {% endif %}
            <div class="msg-time">{{ msg.created_at|date:"H:i" }}</div>
          </div>
        </div>
      {% empty %}
        <div style="text-align: center; color: var(--text-secondary); padding: 3rem 1rem;">
          <i class="fas fa-robot" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
          <p>오른쪽 패널에서 미팅록을 선택하거나,<br>자유롭게 질문을 입력하세요.</p>
        </div>
      {% endfor %}

      <div class="ai-loading" id="aiLoading">
        <span class="spinner"></span>
        <span style="margin-left: 0.5rem;">AI가 분석 중...</span>
      </div>
    </div>

    <div class="ai-chat-input">
      <textarea id="chatInput" placeholder="예: 이 고객 다음 방문 시 어떤 질문을 하면 좋을까? / 경쟁사 대비 어떻게 어필할까?" rows="1"></textarea>
      <button class="btn-send" id="btnSend" onclick="sendMessage()">
        <i class="fas fa-paper-plane"></i> 전송
      </button>
    </div>
  </div>

  <!-- ========== 오른쪽: 카드 패널 ========== -->
  <div class="ai-card-panel">

    <!-- 미팅록 분석 실행 -->
    {% if histories %}
    <div class="ai-history-section">
      <h6><i class="fas fa-clipboard-list"></i> 미팅록에서 분석</h6>
      {% for h in histories %}
        <button class="history-analyze-btn" onclick="analyzeHistory({{ h.id }}, this)">
          <span class="date-label">{{ h.meeting_date|date:"m/d"|default:h.created_at|date:"m/d" }}</span>
          <span class="history-preview">
            {{ h.meeting_situation|default:h.content|truncatechars:40 }}
          </span>
          <i class="fas fa-wand-magic-sparkles"></i>
        </button>
      {% endfor %}
    </div>
    {% endif %}

    <!-- PainPoint 카드 목록 -->
    <div class="ai-panel-title">
      <i class="fas fa-cards-blank" style="color: #8b5cf6;"></i>
      PainPoint 카드 <span style="color: var(--text-secondary); font-size: 0.75rem;">( {{ cards|length }} )</span>
    </div>

    <div id="cardList">
      {% for card in cards %}
        {% include 'ai_chat/partials/painpoint_card.html' with card=card %}
      {% empty %}
        <div style="text-align: center; color: var(--text-secondary); padding: 2rem 1rem; font-size: 0.85rem;">
          미팅록을 분석하면 여기에<br>PainPoint 카드가 생성됩니다.
        </div>
      {% endfor %}
    </div>
  </div>
</div>

<!-- 검증 메모 모달 -->
<div class="modal fade" id="verifyModal" tabindex="-1">
  <div class="modal-dialog modal-sm">
    <div class="modal-content" style="background: var(--surface); border: 1px solid var(--border);">
      <div class="modal-header" style="border-bottom: 1px solid var(--border); padding: 0.75rem 1rem;">
        <h6 class="modal-title" style="color: var(--text-primary); font-size: 0.9rem;" id="verifyModalTitle">검증 결과</h6>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" style="padding: 1rem;">
        <input type="hidden" id="verifyCardId">
        <input type="hidden" id="verifyStatus">
        <textarea id="verifyNote" class="form-control" rows="3"
          style="background: var(--background); color: var(--text-primary); border: 1px solid var(--border); font-size: 0.85rem;"
          placeholder="연구원 반응, 메모 등..."></textarea>
      </div>
      <div class="modal-footer" style="border-top: 1px solid var(--border); padding: 0.5rem 1rem;">
        <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">취소</button>
        <button type="button" class="btn btn-sm btn-primary" onclick="submitVerification()">저장</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const ROOM_ID = {{ room.id }};
const CSRF = '{{ csrf_token }}';

// ========== 채팅 전송 ==========
function sendMessage() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text) return;

  appendMessage('user', text);
  input.value = '';
  showLoading(true);
  document.getElementById('btnSend').disabled = true;

  fetch(`/ai/room/${ROOM_ID}/send/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-CSRFToken': CSRF,
    },
    body: `message=${encodeURIComponent(text)}`
  })
  .then(r => r.json())
  .then(data => {
    showLoading(false);
    document.getElementById('btnSend').disabled = false;
    if (data.error) {
      appendMessage('ai', `⚠️ ${data.error}`);
      return;
    }
    // AI 응답 표시
    if (data.ai_message.structured_data) {
      appendStructuredMessage(data.ai_message);
    } else {
      appendMessage('ai', data.ai_message.content);
    }
    // 카드가 생성되었으면 페이지 새로고침 (카드 렌더링)
    if (data.cards_created > 0) {
      setTimeout(() => location.reload(), 500);
    }
  })
  .catch(err => {
    showLoading(false);
    document.getElementById('btnSend').disabled = false;
    appendMessage('ai', `⚠️ 오류: ${err.message}`);
  });
}

// Enter 키로 전송 (Shift+Enter는 줄바꿈)
document.getElementById('chatInput').addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

// ========== 미팅록 분석 ==========
function analyzeHistory(historyId, btn) {
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner" style="width:14px;height:14px;border-width:2px;"></span> 분석 중...';
  showLoading(true);

  fetch(`/ai/analyze/${historyId}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': CSRF,
    },
  })
  .then(r => r.json())
  .then(data => {
    showLoading(false);
    if (data.error) {
      alert(data.error);
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-wand-magic-sparkles"></i> 재시도';
      return;
    }
    // 분석 완료 → 페이지 새로고침
    location.reload();
  })
  .catch(err => {
    showLoading(false);
    alert(`분석 실패: ${err.message}`);
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-wand-magic-sparkles"></i> 재시도';
  });
}

// ========== PainPoint 카드 검증 ==========
function openVerifyModal(cardId, status) {
  document.getElementById('verifyCardId').value = cardId;
  document.getElementById('verifyStatus').value = status;
  document.getElementById('verifyNote').value = '';
  document.getElementById('verifyModalTitle').textContent =
    status === 'confirmed' ? '✅ 확인됨으로 변경' : '❌ 부정됨으로 변경';
  new bootstrap.Modal(document.getElementById('verifyModal')).show();
}

function submitVerification() {
  const cardId = document.getElementById('verifyCardId').value;
  const status = document.getElementById('verifyStatus').value;
  const note = document.getElementById('verifyNote').value;

  fetch(`/ai/card/${cardId}/verify/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-CSRFToken': CSRF,
    },
    body: `status=${status}&note=${encodeURIComponent(note)}`
  })
  .then(r => r.json())
  .then(data => {
    if (data.error) {
      alert(data.error);
      return;
    }
    bootstrap.Modal.getInstance(document.getElementById('verifyModal')).hide();
    location.reload();
  })
  .catch(err => alert(`검증 저장 실패: ${err.message}`));
}

// ========== 유틸 ==========
function appendMessage(role, text) {
  const container = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = `chat-msg ${role === 'user' ? 'user-msg' : 'ai-msg'}`;
  const now = new Date();
  const time = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  div.innerHTML = `<div class="chat-bubble">${escapeHtml(text).replace(/\n/g, '<br>')}<div class="msg-time">${time}</div></div>`;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

function appendStructuredMessage(aiMsg) {
  const container = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = 'chat-msg ai-msg';

  let html = '<div class="chat-bubble">';
  const sd = aiMsg.structured_data;
  if (sd && sd.summary_3lines) {
    html += '<div class="ai-structured"><h6><i class="fas fa-list-check"></i> 3줄 요약</h6><ul class="ai-summary-list">';
    sd.summary_3lines.forEach(l => { html += `<li>• ${escapeHtml(l)}</li>`; });
    html += '</ul></div>';
  }
  if (sd && sd.crm_update) {
    html += '<div class="ai-structured" style="margin-top:0.5rem"><h6><i class="fas fa-bullseye"></i> CRM 추천</h6>';
    if (sd.crm_update.stage) html += `<div style="font-size:0.8rem"><strong>스테이지:</strong> ${escapeHtml(sd.crm_update.stage)}</div>`;
    if (sd.crm_update.must_get_next_visit) html += `<div style="font-size:0.8rem"><strong>다음 방문 필수:</strong> ${escapeHtml(sd.crm_update.must_get_next_visit)}</div>`;
    html += '</div>';
  }
  if (sd && sd.next_action_feedback) {
    const naf = sd.next_action_feedback;
    const evalMap = {good:'<span style="color:#22c55e">✔ Good</span>', weak:'<span style="color:#fbbf24">⚠ Weak</span>', risky:'<span style="color:#ef4444">⚠ Risky</span>', missing:'<span style="color:#94a3b8">❓ Missing</span>'};
    html += `<div class="ai-structured" style="margin-top:0.5rem"><h6><i class="fas fa-forward"></i> 다음 액션 피드백 ${evalMap[naf.evaluation]||''}</h6>`;
    if (naf.original_action) html += `<div style="font-size:0.8rem;margin-bottom:0.3rem"><strong>원래 액션:</strong> ${escapeHtml(naf.original_action)}</div>`;
    if (naf.feedback) html += `<div style="font-size:0.8rem;margin-bottom:0.3rem">${escapeHtml(naf.feedback)}</div>`;
    if (naf.suggested_actions && naf.suggested_actions.length) {
      html += '<div style="font-size:0.8rem;margin-top:0.3rem"><strong>추천 액션:</strong></div>';
      naf.suggested_actions.forEach(a => { html += `<div style="font-size:0.8rem;padding-left:0.5rem">→ ${escapeHtml(a)}</div>`; });
    }
    html += '</div>';
  }
  html += `<div class="msg-time">${aiMsg.created_at}</div></div>`;
  div.innerHTML = html;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

function showLoading(show) {
  document.getElementById('aiLoading').classList.toggle('active', show);
  if (show) {
    const container = document.getElementById('chatMessages');
    container.scrollTop = container.scrollHeight;
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// 페이지 로드 시 스크롤 하단
document.addEventListener('DOMContentLoaded', function() {
  const container = document.getElementById('chatMessages');
  container.scrollTop = container.scrollHeight;
});
</script>
{% endblock %}
