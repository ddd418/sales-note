{% load static %}

<div class="list-group-item list-group-item-action d-flex align-items-center py-3 {% if todo.status == 'done' %}bg-light{% endif %}" 
     id="todo-row-{{ todo.pk }}"
     data-status="{{ todo.status }}"
     data-tab="{{ tab|default:'my' }}">
    <!-- 체크박스 -->
    <div class="me-3">
        {% if todo.status == 'pending' %}
        <!-- 승인 대기 상태 - 버튼 비활성화 -->
        <button type="button" 
                class="btn btn-sm btn-outline-warning rounded-circle"
                style="width: 32px; height: 32px; padding: 0;"
                disabled
                title="승인 후 완료 처리 가능">
            <i class="fas fa-clock"></i>
        </button>
        {% else %}
        <button type="button" 
                class="btn btn-sm {% if todo.status == 'done' %}btn-success{% else %}btn-outline-secondary{% endif %} rounded-circle todo-toggle-btn"
                style="width: 32px; height: 32px; padding: 0;"
                hx-post="{% url 'todos:api_toggle_status' todo.pk %}"
                hx-vals='{"tab": "{{ tab|default:'my' }}"}'
                hx-swap="outerHTML"
                hx-target="#todo-row-{{ todo.pk }}"
                title="{% if todo.status == 'done' %}진행중으로 변경{% else %}완료 처리{% endif %}">
            {% if todo.status == 'done' %}
            <i class="fas fa-check"></i>
            {% else %}
            <i class="far fa-circle"></i>
            {% endif %}
        </button>
        {% endif %}
    </div>
    
    <!-- 내용 -->
    <div class="flex-grow-1">
        <div class="d-flex align-items-center mb-1">
            <!-- 제목 -->
            <a href="{% url 'todos:detail' todo.pk %}" 
               class="text-decoration-none {% if todo.status == 'done' %}text-muted text-decoration-line-through{% else %}text-dark{% endif %} fw-medium">
                {{ todo.title }}
            </a>
            
            <!-- 출처 배지 -->
            {% if todo.source_type != 'self' %}
            <span class="badge {{ todo.source_badge_class }} ms-2">{{ todo.get_source_type_display }}</span>
            {% endif %}
            
            <!-- 마감일 경고 -->
            {% if todo.is_overdue %}
            <span class="badge bg-danger ms-2">
                <i class="fas fa-exclamation-triangle me-1"></i>마감 초과
            </span>
            {% endif %}
        </div>
        
        <div class="d-flex align-items-center text-muted small">
            <!-- 상태 -->
            <span class="badge {{ todo.status_badge_class }} me-2">{{ todo.get_status_display }}</span>
            
            <!-- 관련 고객 -->
            {% if todo.related_client %}
            <span class="me-3">
                <i class="fas fa-building me-1"></i>{{ todo.related_client.customer_name }} ({{ todo.related_client.company }})
            </span>
            {% endif %}
            
            <!-- 마감일 -->
            {% if todo.due_date %}
            <span class="me-3 {% if todo.is_overdue %}text-danger{% endif %}">
                <i class="fas fa-calendar me-1"></i>{{ todo.due_date|date:"m/d" }}
            </span>
            {% endif %}
            
            <!-- 예상 시간 -->
            {% if todo.expected_duration %}
            <span class="me-3">
                <i class="fas fa-clock me-1"></i>{{ todo.get_expected_duration_display }}
            </span>
            {% endif %}
            
            <!-- 생성일 -->
            <span>
                <i class="fas fa-calendar-plus me-1"></i>{{ todo.created_at|date:"m/d H:i" }}
            </span>
        </div>
    </div>
    
    <!-- 액션 버튼 -->
    <div class="ms-2">
        <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                <i class="fas fa-ellipsis-v"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li>
                    <a class="dropdown-item" href="{% url 'todos:detail' todo.pk %}">
                        <i class="fas fa-eye me-2"></i>상세 보기
                    </a>
                </li>
                {% if todo.source_type != 'manager_assign' %}
                <!-- 매니저 하달 업무가 아닌 경우만 수정 가능 -->
                <li>
                    <a class="dropdown-item" href="{% url 'todos:edit' todo.pk %}">
                        <i class="fas fa-edit me-2"></i>수정
                    </a>
                </li>
                {% endif %}
                <li><hr class="dropdown-divider"></li>
                {% if todo.status != 'done' %}
                <li>
                    <button class="dropdown-item text-success" 
                            hx-post="{% url 'todos:complete' todo.pk %}"
                            hx-confirm="이 TODO를 완료 처리하시겠습니까?">
                        <i class="fas fa-check me-2"></i>완료 처리
                    </button>
                </li>
                {% endif %}
                {% if todo.source_type != 'manager_assign' %}
                <!-- 매니저 하달 업무가 아닌 경우만 삭제 가능 -->
                <li>
                    <button class="dropdown-item text-danger" 
                            hx-post="{% url 'todos:delete' todo.pk %}"
                            hx-confirm="정말 삭제하시겠습니까?"
                            hx-target="closest .list-group-item"
                            hx-swap="outerHTML">
                        <i class="fas fa-trash me-2"></i>삭제
                    </button>
                </li>
                {% endif %}
            </ul>
        </div>
    </div>
</div>