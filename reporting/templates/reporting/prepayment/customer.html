{% extends "reporting/base.html" %}
{% load static %}
{% load humanize %}

{% block extra_css %}
<style>
    .customer-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }
    
    .customer-name {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .customer-company {
        font-size: 1.1rem;
        opacity: 0.95;
    }
    
    .stats-card {
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        transition: all 0.3s ease;
        border: none;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        height: 100%;
    }
    
    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.12);
    }
    
    .stats-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        margin-bottom: 1rem;
    }
    
    .stats-value {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
    }
    
    .stats-label {
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    .bg-gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .bg-gradient-success {
        background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
    }
    
    .bg-gradient-warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .bg-gradient-info {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .table-card {
        border-radius: 15px;
        border: none;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    
    .table-card .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px 15px 0 0 !important;
        padding: 1.25rem;
    }
    
    .table-card .card-body {
        padding: 0;
    }
    
    .prepayment-table {
        margin-bottom: 0;
    }
    
    .prepayment-table thead th {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
        padding: 1rem;
    }
    
    .prepayment-table tbody tr {
        transition: all 0.2s ease;
    }
    
    .prepayment-table tbody tr:hover {
        background-color: #f8f9fa;
        transform: scale(1.01);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .prepayment-table td {
        vertical-align: middle;
        padding: 1rem;
    }
    
    .btn-excel {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        border: none;
        color: white;
        padding: 0.75rem 2rem;
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(17, 153, 142, 0.3);
    }
    
    .btn-excel:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(17, 153, 142, 0.4);
        color: white;
    }
    
    .btn-back {
        background: linear-gradient(135deg, #868f96 0%, #596164 100%);
        border: none;
        color: white;
        padding: 0.75rem 2rem;
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-back:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        color: white;
    }
    
    .badge {
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.85rem;
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #6c757d;
    }
    
    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.3;
    }
    
    @media print {
        .no-print {
            display: none !important;
        }
        
        .customer-header,
        .stats-card {
            box-shadow: none !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 고객 헤더 -->
    <div class="customer-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <div class="customer-name">
                    <i class="fas fa-user-circle me-2"></i>{{ customer.customer_name }}
                </div>
                <div class="customer-company">
                    <i class="fas fa-building me-2"></i>{{ customer.company.company_name|default:"업체 정보 없음" }}
                </div>
            </div>
            <div class="no-print">
                <a href="{% url 'reporting:prepayment_customer_excel' customer.id %}" class="btn btn-excel me-2">
                    <i class="fas fa-file-excel me-2"></i>엑셀 다운로드
                </a>
                <a href="{% url 'reporting:prepayment_list' %}" class="btn btn-back">
                    <i class="fas fa-arrow-left me-2"></i>목록으로
                </a>
            </div>
        </div>
    </div>
    
    <!-- 통계 카드 -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card stats-card">
                <div class="stats-icon bg-gradient-primary text-white">
                    <i class="fas fa-list"></i>
                </div>
                <div class="stats-value">{{ stats.count|default:0 }}건</div>
                <div class="stats-label">총 선결제 건수</div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card stats-card">
                <div class="stats-icon bg-gradient-success text-white">
                    <i class="fas fa-won-sign"></i>
                </div>
                <div class="stats-value">{{ stats.total_amount|default:0|intcomma }}원</div>
                <div class="stats-label">총 선결제 금액</div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card stats-card">
                <div class="stats-icon bg-gradient-warning text-white">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stats-value">{{ stats.total_used|default:0|intcomma }}원</div>
                <div class="stats-label">총 사용 금액</div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card stats-card">
                <div class="stats-icon bg-gradient-info text-white">
                    <i class="fas fa-piggy-bank"></i>
                </div>
                <div class="stats-value">{{ stats.total_balance|default:0|intcomma }}원</div>
                <div class="stats-label">남은 잔액</div>
            </div>
        </div>
    </div>
    
    <!-- 상태별 통계 -->
    <div class="row mb-4 no-print">
        <div class="col-12">
            <div class="alert alert-light border-0 shadow-sm" style="border-radius: 12px;">
                <div class="d-flex justify-content-around text-center">
                    <div>
                        <div class="h5 mb-1">
                            <span class="badge bg-success">{{ active_count }}건</span>
                        </div>
                        <small class="text-muted">사용가능</small>
                    </div>
                    <div>
                        <div class="h5 mb-1">
                            <span class="badge bg-secondary">{{ depleted_count }}건</span>
                        </div>
                        <small class="text-muted">소진</small>
                    </div>
                    <div>
                        <div class="h5 mb-1">
                            <span class="badge bg-danger">{{ cancelled_count }}건</span>
                        </div>
                        <small class="text-muted">취소</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 선결제 목록 테이블 -->
    <div class="card table-card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-list-ul me-2"></i>선결제 내역
            </h5>
        </div>
        <div class="card-body">
            {% if prepayments %}
            <div class="table-responsive">
                <table class="table prepayment-table">
                    <thead>
                        <tr>
                            <th style="width: 5%;">No</th>
                            <th style="width: 10%;">결제일</th>
                            <th style="width: 12%;">지불자</th>
                            <th style="width: 10%;">결제방법</th>
                            <th style="width: 13%;" class="text-end">선결제금액</th>
                            <th style="width: 13%;" class="text-end">사용금액</th>
                            <th style="width: 13%;" class="text-end">남은잔액</th>
                            <th style="width: 8%;" class="text-center">상태</th>
                            <th style="width: 10%;">등록자</th>
                            <th style="width: 6%;" class="text-center no-print">작업</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for prepayment in prepayments %}
                        <tr>
                            <td class="text-center">{{ forloop.counter }}</td>
                            <td>{{ prepayment.payment_date|date:"Y-m-d" }}</td>
                            <td>{{ prepayment.payer_name|default:"-" }}</td>
                            <td>
                                {% if prepayment.payment_method == 'cash' %}
                                    <i class="fas fa-money-bill-wave text-success me-1"></i>현금
                                {% elif prepayment.payment_method == 'transfer' %}
                                    <i class="fas fa-exchange-alt text-primary me-1"></i>계좌이체
                                {% elif prepayment.payment_method == 'card' %}
                                    <i class="fas fa-credit-card text-info me-1"></i>카드
                                {% endif %}
                            </td>
                            <td class="text-end fw-bold">{{ prepayment.amount|intcomma }}원</td>
                            <td class="text-end text-danger">{{ prepayment.amount|add:prepayment.balance|add:"-"|add:prepayment.balance|intcomma }}원</td>
                            <td class="text-end text-primary">{{ prepayment.balance|intcomma }}원</td>
                            <td class="text-center">
                                {% if prepayment.status == 'active' %}
                                    <span class="badge bg-success">사용가능</span>
                                {% elif prepayment.status == 'depleted' %}
                                    <span class="badge bg-secondary">소진</span>
                                {% elif prepayment.status == 'cancelled' %}
                                    <span class="badge bg-danger">취소</span>
                                {% endif %}
                            </td>
                            <td>
                                <small>{{ prepayment.created_by.get_full_name|default:prepayment.created_by.username }}</small>
                            </td>
                            <td class="text-center no-print">
                                <a href="{% url 'reporting:prepayment_detail' prepayment.pk %}" 
                                   class="btn btn-sm btn-outline-primary"
                                   title="상세보기">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr class="table-light fw-bold">
                            <td colspan="4" class="text-center">합계</td>
                            <td class="text-end">{{ stats.total_amount|default:0|intcomma }}원</td>
                            <td class="text-end text-danger">{{ stats.total_used|default:0|intcomma }}원</td>
                            <td class="text-end text-primary">{{ stats.total_balance|default:0|intcomma }}원</td>
                            <td colspan="3"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <h5 class="mt-3">선결제 내역이 없습니다</h5>
                <p class="text-muted">아직 등록된 선결제 내역이 없습니다.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 인쇄 버튼 추가 (필요시)
    document.addEventListener('DOMContentLoaded', function() {
        // 엑셀 다운로드 알림
        const excelBtn = document.querySelector('.btn-excel');
        if (excelBtn) {
            excelBtn.addEventListener('click', function(e) {
                // 로딩 표시 등 추가 가능
            });
        }
    });
</script>
{% endblock %}
