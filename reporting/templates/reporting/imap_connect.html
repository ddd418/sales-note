{% extends 'reporting/base.html' %}
{% load static %}

{% block title %}이메일 연동 설정{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="bi bi-envelope-at"></i> 이메일 연동 설정
                    </h4>
                    <p class="text-muted mb-0 mt-2">
                        Gmail IMAP/SMTP를 통해 모든 이메일을 연동할 수 있습니다. (회사 이메일, 네이버, 기타 도메인)
                    </p>
                </div>
                <div class="card-body">
                    
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                    
                    <form method="post" id="imapForm">
                        {% csrf_token %}
                        
                        <!-- Gmail 고정 설정 (숨김) -->
                        <input type="hidden" name="provider" value="gmail">
                        <input type="hidden" name="imap_host" value="imap.gmail.com">
                        <input type="hidden" name="imap_port" value="993">
                        <input type="hidden" name="imap_use_ssl" value="on">
                        <input type="hidden" name="smtp_host" value="smtp.gmail.com">
                        <input type="hidden" name="smtp_port" value="587">
                        <input type="hidden" name="smtp_use_tls" value="on">
                        
                        <!-- 기본 정보 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="mb-3">1. 기본 정보</h5>
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i>
                                    <strong>Gmail 서버를 통해 모든 이메일이 연동됩니다.</strong><br>
                                    회사 이메일도(user@company.com) Gmail의 IMAP/SMTP 서버 설정으로 사용할 수 있습니다.
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label required">이메일 주소</label>
                                <input type="email" class="form-control" name="imap_email" id="imap_email"
                                       value="{{ form_data.imap_email|default:user_profile.imap_email }}" 
                                       placeholder="user@company.com" required>
                                <small class="text-muted">연동할 이메일 주소를 입력하세요.</small>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <!-- 계정 정보 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="mb-3">2. 계정 정보 입력</h5>
                                <p class="text-muted mb-3">
                                    <i class="bi bi-info-circle"></i> Gmail 서버 정보는 자동으로 설정됩니다. 
                                    <strong>이메일 주소와 비밀번호(또는 앱 비밀번호)만 입력</strong>하면 됩니다.
                                </p>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label required">이메일 사용자명</label>
                                <input type="text" class="form-control" name="imap_username" id="imap_username"
                                       value="{{ form_data.imap_username|default:user_profile.imap_username }}" 
                                       placeholder="user@company.com" required>
                                <small class="text-muted">대부분 이메일 주소와 동일</small>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label required">이메일 비밀번호</label>
                                <input type="password" class="form-control" name="imap_password" id="imap_password"
                                       placeholder="앱 비밀번호 16자리 입력" required>
                                <small class="text-muted">암호화되어 안전하게 저장됩니다</small>
                                
                                <div class="alert alert-warning mt-2 mb-0">
                                    <i class="bi bi-exclamation-triangle"></i>
                                    <strong>Gmail 사용자는 반드시 앱 비밀번호를 사용하세요!</strong><br>
                                    <small>
                                        1. <a href="https://myaccount.google.com/apppasswords" target="_blank" class="alert-link">Google 앱 비밀번호 페이지</a>에서 16자리 앱 비밀번호 생성<br>
                                        2. 2단계 인증이 활성화되어 있어야 합니다<br>
                                        3. 일반 계정 비밀번호는 보안상 사용할 수 없습니다
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <!-- 연결 테스트 버튼 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="mb-3">3. 연결 테스트 (선택사항)</h5>
                                <p class="text-muted mb-3">
                                    <i class="bi bi-info-circle"></i> 저장하기 전에 연결을 테스트할 수 있습니다.
                                </p>
                                <div class="d-flex gap-2">
                                    <button type="submit" name="test_connection" value="imap" class="btn btn-outline-primary">
                                        <i class="bi bi-plug"></i> 수신 서버 테스트
                                    </button>
                                    <button type="submit" name="test_connection" value="smtp" class="btn btn-outline-primary">
                                        <i class="bi bi-plug"></i> 발송 서버 테스트
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <!-- 저장 -->
                        <div class="row">
                            <div class="col-12">
                                <button type="submit" name="action" value="save" class="btn btn-primary btn-lg">
                                    <i class="bi bi-check-circle"></i> 연동 완료
                                </button>
                                <a href="{% url 'reporting:profile' %}" class="btn btn-secondary btn-lg">
                                    <i class="bi bi-x-circle"></i> 취소
                                </a>
                            </div>
                        </div>
                    </form>
                    
                    <!-- 참고 정보 -->
                    <div class="alert alert-info mt-4">
                        <h6><i class="bi bi-info-circle"></i> 간편 연동 가이드</h6>
                        <ol class="mb-0">
                            <li><strong>1단계:</strong> 이메일 주소 입력 (Gmail, 회사 이메일, 네이버 등 모두 가능)</li>
                            <li><strong>2단계:</strong> 사용자명과 비밀번호 입력 (대부분 이메일 주소와 동일)</li>
                            <li><strong>3단계:</strong> "연동 완료" 버튼 클릭</li>
                        </ol>
                        <hr class="my-2">
                        <small class="text-muted">
                            <strong>중요:</strong><br>
                            • 2단계 인증 사용 중이면 <strong>앱 비밀번호</strong>를 생성하여 입력하세요.<br>
                            • Gmail 앱 비밀번호: <a href="https://myaccount.google.com/apppasswords" target="_blank">Google 계정 &gt; 앱 비밀번호</a><br>
                            • 모든 이메일이 Gmail의 안전한 IMAP/SMTP 서버를 통해 연동됩니다.
                        </small>
                    </div>
                    
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 이메일 주소 입력 시 사용자명 자동 채우기
    const emailInput = document.getElementById('imap_email');
    const usernameInput = document.getElementById('imap_username');
    
    if (emailInput && usernameInput) {
        emailInput.addEventListener('input', function() {
            if (this.value && !usernameInput.value) {
                usernameInput.value = this.value;
            }
        });
    }
});
</script>

<style>
.required::after {
    content: " *";
    color: red;
}
</style>

{% endblock %}
