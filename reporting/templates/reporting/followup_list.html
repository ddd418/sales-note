{% extends "reporting/base.html" %} 
{% block title %}{{ page_title }} - ì˜ì—…ë³´ê³  ì‹œìŠ¤í…œ{% endblock %} 
{% block page_title %}íŒ”ë¡œì—… ê´€ë¦¬{% endblock %} 

{% block content %}
<style>
/* ============================================
   ëª¨ë‹¬ Z-INDEX ë° ì˜¤ë²„ë ˆì´ ìˆ˜ì • (CRITICAL FIX)
   ============================================ */

/* backdropì„ ì™„ì „íˆ íˆ¬ëª…í•˜ê²Œ (ë°°ê²½ ì—†ìŒ) */
.modal-backdrop {
  display: none !important; /* backdrop ìì²´ë¥¼ ìˆ¨ê¹€ */
}

/* ëª¨ë‹¬ ìì²´ëŠ” backdropë³´ë‹¤ ë†’ê²Œ */
.modal {
  z-index: 1055 !important;
  pointer-events: none !important; /* ëª¨ë‹¬ ì»¨í…Œì´ë„ˆë„ íˆ¬ëª…í•˜ê²Œ */
}

/* ëª¨ë‹¬ ë‹¤ì´ì–¼ë¡œê·¸ë§Œ í´ë¦­ ê°€ëŠ¥í•˜ê²Œ */
.modal-dialog {
  z-index: 1056 !important;
  pointer-events: auto !important; /* ë‹¤ì´ì–¼ë¡œê·¸ëŠ” í´ë¦­ ê°€ëŠ¥ */
}

/* ëª¨ë‹¬ ì»¨í…ì¸ ë¥¼ í™•ì‹¤íˆ í´ë¦­ ê°€ëŠ¥í•˜ê²Œ */
.modal-content {
  position: relative;
  z-index: 1057 !important;
  pointer-events: auto !important; /* ì»¨í…ì¸  í´ë¦­ ê°€ëŠ¥ */
  background-color: #fff;
  border: 1px solid rgba(0, 0, 0, 0.2);
  border-radius: 0.3rem;
  box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15); /* ëª¨ë‹¬ì— ê·¸ë¦¼ì ì¶”ê°€ */
}

/* ëª¨ë‹¬ ë‚´ë¶€ì˜ ëª¨ë“  ìš”ì†Œê°€ í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡ */
.modal-header,
.modal-body,
.modal-footer,
.modal-header *,
.modal-body *,
.modal-footer * {
  pointer-events: auto !important;
}

/* í”„ë¦¬ë¯¸ì—„ íŒ”ë¡œìš°ì—… í˜ì´ì§€ ìŠ¤íƒ€ì¼ */
.followup-page-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2.5rem 2rem;
    margin: -2rem -2rem 2rem 0;
    border-radius: 0 0 20px 20px;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
}

.followup-page-header h1 {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
}

.followup-page-header .subtitle {
    font-size: 1.1rem;
    opacity: 0.95;
}

.followup-header-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.btn-premium-white {
    background: white;
    color: #667eea;
    border: none;
    border-radius: 12px;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-premium-white:hover {
    background: #f8f9fa;
    color: #5568d3;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 255, 255, 0.3);
}

.btn-premium-success {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    border: none;
    border-radius: 12px;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-premium-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
    color: white;
}

.premium-search-card {
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    border: none;
    margin-bottom: 2rem;
}

.premium-search-card .card-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-bottom: 2px solid #667eea;
    border-radius: 16px 16px 0 0 !important;
    padding: 1.25rem 1.5rem;
}

.premium-search-card .card-title {
    font-weight: 700;
    color: #2d3748;
    margin: 0;
}

.premium-search-card .card-body {
    padding: 1.5rem;
}

.filter-box-premium {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.filter-box-premium .btn-group .btn {
    border-radius: 8px;
    margin: 0 0.25rem;
    transition: all 0.2s ease;
}

.filter-box-premium .btn-outline-primary {
    border-color: #667eea;
    color: #667eea;
}

.filter-box-premium .btn-outline-primary:hover,
.filter-box-premium .btn-outline-primary.active {
    background: #667eea;
    border-color: #667eea;
    color: white;
}

/* Premium Followup Cards */
.followup-card {
    border: none;
    border-radius: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    transition: all 0.3s ease;
    overflow: hidden;
    background: white;
}

.followup-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 24px rgba(102, 126, 234, 0.15);
}

.followup-card .card-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-bottom: 2px solid #e9ecef;
    padding: 1rem 1.25rem;
}

.followup-card .card-header h6 {
    font-weight: 700;
    color: #2d3748;
    margin: 0;
}

.followup-card .card-header h6 a {
    color: #2d3748;
    transition: color 0.2s;
}

.followup-card .card-header h6 a:hover {
    color: #667eea;
}

.followup-card .badge {
    font-size: 0.75rem;
    padding: 0.4rem 0.8rem;
    border-radius: 20px;
    font-weight: 600;
}

.followup-card .card-body {
    padding: 1.25rem;
}

.followup-card .card-text {
    font-size: 0.9rem;
    line-height: 1.8;
    color: #4a5568;
}

.followup-card .card-text strong {
    color: #2d3748;
    font-weight: 600;
    min-width: 70px;
    display: inline-block;
}

.followup-card .alert-light {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 0.75rem;
}

.followup-card .card-footer {
    background: transparent;
    border-top: 1px solid #e9ecef;
    padding: 1rem 1.25rem;
}

.followup-card .btn-group .btn {
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.85rem;
    padding: 0.5rem 1rem;
    transition: all 0.2s;
}

.followup-card .btn-outline-primary:hover {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-color: transparent;
    transform: translateY(-1px);
}

.followup-card .btn-outline-secondary:hover {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    border-color: transparent;
    transform: translateY(-1px);
}

.followup-card .btn-outline-danger:hover {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    border-color: transparent;
    transform: translateY(-1px);
}

/* Empty State */
.empty-state-card {
    border: none;
    border-radius: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    background: white;
}

.empty-state-card .card-body {
    padding: 4rem 2rem;
}

.empty-state-card i {
    color: #cbd5e0;
}

.empty-state-card h5 {
    color: #2d3748;
    font-weight: 700;
    margin-top: 1rem;
}

.empty-state-card .card-text {
    color: #718096;
}

/* Premium Pagination */
.pagination-premium {
    gap: 0.5rem;
}

.pagination-premium .page-item .page-link {
    border: 2px solid #e9ecef;
    border-radius: 10px;
    color: #4a5568;
    font-weight: 600;
    padding: 0.5rem 0.9rem;
    transition: all 0.2s;
    margin: 0 0.2rem;
}

.pagination-premium .page-item .page-link:hover {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-color: transparent;
    transform: translateY(-2px);
}

.pagination-premium .page-item.active .page-link {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-color: transparent;
    color: white;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.pagination-premium .page-item.disabled .page-link {
    background: #f8f9fa;
    border-color: #e9ecef;
    color: #cbd5e0;
}

.pagination-info {
    color: #718096;
    font-size: 0.9rem;
    font-weight: 500;
}

/* ë¦¬ìŠ¤íŠ¸ í˜ì´ì§€ ëª¨ë°”ì¼ ìµœì í™” */
@media (max-width: 1200px) {
  /* í—¤ë” ëª¨ë°”ì¼ ìµœì í™” */
  .page-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 15px;
    position: sticky;
    top: 60px;
    background: #fcfcfc;
    z-index: 98;
    padding: 15px 0;
    margin-bottom: 15px;
    border-bottom: 1px solid #edecec;
  }

  .page-header .btn-group {
    width: 100%;
  }

  .page-header .btn {
    flex: 1;
    min-width: 120px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* ê²€ìƒ‰ ì¹´ë“œ ëª¨ë°”ì¼ ìµœì í™” */
  .card {
    margin-bottom: 15px;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .card-title {
    font-size: 14px;
    margin-bottom: 15px !important;
  }
  /* ê²€ìƒ‰ í¼ ëª¨ë°”ì¼ ìµœì í™” */
  .row.g-3 {
    gap: 15px !important;
  }

  /* ë¹ ë¥¸ í•„í„° ëª¨ë°”ì¼ ìµœì í™” */
  .filter-box .btn-group {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .filter-box .btn {
    flex: 1;
    min-width: auto;
    padding: 8px 12px;
    font-size: 12px;
    min-height: 36px;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* íŒ”ë¡œìš°ì—… ì¹´ë“œ ëª¨ë°”ì¼ ìµœì í™” */
  .col-md-6.col-lg-4 {
    padding: 0 8px;
    margin-bottom: 15px;
  }

  .card.h-100 {
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .card-header {
    padding: 12px 15px;
    font-size: 14px;
  }

  .card-body {
    padding: 15px;
    font-size: 13px;
  }

  /* ì•¡ì…˜ ë²„íŠ¼ ëª¨ë°”ì¼ ìµœì í™” */
  .card-footer .btn {
    padding: 6px 10px;
    font-size: 11px;
    min-height: 32px;
  }

  .btn-group .btn {
    flex: 1;
    min-width: auto;
  }

  .col-md-4,
  .col-md-2,
  .col-md-3 {
    width: 100%;
    max-width: none;
  }

  .form-label {
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 5px;
  }

  .form-control,
  .form-select {
    min-height: 44px;
    font-size: 16px;
    border-radius: 8px;
    border: 1px solid #e3e2e0;
  }

  .form-control:focus,
  .form-select:focus {
    border-color: #2563eb;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  /* ë²„íŠ¼ ëª¨ë°”ì¼ ìµœì í™” */
  .btn {
    min-height: 44px;
    padding: 12px 16px;
    font-size: 16px;
    border-radius: 8px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.2s ease;
  }

  .btn:active {
    transform: scale(0.98);
  }

  .btn-group .btn {
    border-radius: 8px !important;
  }

  /* í…Œì´ë¸” ëª¨ë°”ì¼ ìµœì í™” */
  .table-responsive {
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  .table {
    margin-bottom: 0;
    font-size: 12px;
    min-width: 600px; /* ìµœì†Œ ë„ˆë¹„ ë³´ì¥ */
  }

  .table th {
    background-color: #f8f9fa;
    border-bottom: 2px solid #e9ecef;
    padding: 12px 8px;
    font-weight: 600;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
  }

  .table td {
    padding: 12px 8px;
    vertical-align: middle;
    border-bottom: 1px solid #f1f3f4;
  }

  .table tbody tr:hover {
    background-color: rgba(37, 99, 235, 0.02);
  }

  /* í…Œì´ë¸” ì•¡ì…˜ ë²„íŠ¼ */
  .table .btn {
    min-height: 32px;
    padding: 6px 12px;
    font-size: 12px;
    margin: 2px;
  }

  /* ë°°ì§€ ëª¨ë°”ì¼ ìµœì í™” */
  .badge {
    font-size: 10px;
    padding: 4px 8px;
    border-radius: 12px;
    font-weight: 500;
  }

  /* í˜ì´ì§€ë„¤ì´ì…˜ ëª¨ë°”ì¼ ìµœì í™” */
  .pagination {
    justify-content: center;
    margin-top: 20px;
    gap: 5px;
  }

  .page-link {
    min-height: 44px;
    min-width: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    border: 1px solid #e3e2e0;
    font-size: 14px;
  }

  .page-item.active .page-link {
    background-color: #2563eb;
    border-color: #2563eb;
  }

  /* ëª¨ë°”ì¼ ì¹´ë“œ ë ˆì´ì•„ì›ƒ (í…Œì´ë¸” ëŒ€ì•ˆ) */
  .mobile-card-list {
    display: none;
  }

  /* ë“œë¡­ë‹¤ìš´ ëª¨ë°”ì¼ ìµœì í™” */
  .dropdown-menu {
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    border: none;
    margin-top: 8px;
    min-width: 200px;
  }

  .dropdown-item {
    padding: 12px 16px;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .dropdown-item:hover {
    background-color: #f8f9fa;
  }

  /* í†µê³„ ì •ë³´ ëª¨ë°”ì¼ ìµœì í™” */
  .alert {
    border-radius: 8px;
    border: none;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  /* ë¡œë”© ìƒíƒœ */
  .loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
  }
}

/* ì•„ì£¼ ì‘ì€ í™”ë©´ì—ì„œëŠ” ì¹´ë“œ ë ˆì´ì•„ì›ƒ ì‚¬ìš© */
@media (max-width: 480px) {
  .table-responsive {
    display: none;
  }

  .mobile-card-list {
    display: block;
  }

  .mobile-card {
    background: white;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    border: 1px solid #e9ecef;
  }

  .mobile-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 10px;
  }

  .mobile-card-title {
    font-weight: 600;
    font-size: 16px;
    color: #1f1e1c;
    margin: 0;
  }

  .mobile-card-subtitle {
    color: #6c757d;
    font-size: 14px;
    margin: 2px 0 0 0;
  }

  .mobile-card-body {
    margin-bottom: 15px;
  }

  .mobile-card-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px 0;
    border-bottom: 1px solid #f1f3f4;
  }

  .mobile-card-row:last-child {
    border-bottom: none;
  }

  .mobile-card-label {
    font-weight: 500;
    color: #5c5a53;
    font-size: 13px;
  }

  .mobile-card-value {
    color: #37352f;
    font-size: 14px;
    text-align: right;
  }

  .mobile-card-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .mobile-card-actions .btn {
    flex: 1;
    min-width: 80px;
    font-size: 12px;
    padding: 8px 12px;
    min-height: 36px;
  }
}

/* ëª¨ë‹¬ í˜ì´ì§€ë„¤ì´ì…˜ ìŠ¤íƒ€ì¼ */
.modal-body .pagination {
  margin-top: 15px;
  margin-bottom: 0;
  gap: 5px;
}

.modal-body .page-link {
  min-height: 36px;
  min-width: 36px;
  font-size: 13px;
  padding: 6px 10px;
  border-radius: 8px;
  border: 2px solid #e9ecef;
  color: #4a5568;
  font-weight: 600;
  transition: all 0.2s;
}

.modal-body .pagination .page-item.active .page-link {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-color: transparent;
  color: white;
  box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

.modal-body .pagination .page-link:hover {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-color: transparent;
  color: white;
  transform: translateY(-1px);
}

.modal-body .pagination .page-item.disabled .page-link {
  background: #f8f9fa;
  border-color: #e9ecef;
  color: #cbd5e0;
}

/* Premium Modal Styles */
.modal-content {
  border: none;
  border-radius: 16px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.modal-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 16px 16px 0 0;
  padding: 1.5rem;
  border-bottom: none;
}

.modal-header .modal-title {
  font-weight: 700;
  font-size: 1.25rem;
}

.modal-header .btn-close {
  filter: brightness(0) invert(1);
  opacity: 0.8;
}

.modal-header .btn-close:hover {
  opacity: 1;
}

.modal-body {
  padding: 1.5rem;
}

.modal-body .company-item .btn {
  border-radius: 10px;
  font-weight: 600;
  transition: all 0.2s;
}

.modal-body .company-item .btn:hover {
  transform: translateX(4px);
}
</style>
<div class="container-fluid px-4">
    <!-- í”„ë¦¬ë¯¸ì—„ í—¤ë” -->
    <div class="followup-page-header">
        <div class="container">
            <h1>
                <i class="fas fa-user-check me-3"></i>{{ page_title }}
            </h1>
            <p class="subtitle mb-3">
                ê³ ê° íŒ”ë¡œìš°ì—… ë° ê´€ê³„ ê´€ë¦¬ ì‹œìŠ¤í…œ
            </p>
            
            <div class="followup-header-actions">
                {% if user.is_authenticated %}
                {% if user.userprofile.role == 'manager' %}
                <!-- ë§¤ë‹ˆì €ìš© ì—‘ì…€ ë‹¤ìš´ë¡œë“œ -->
                <div class="btn-group" role="group">
          <!-- ë§¤ë‹ˆì €ìš© ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ë“œë¡­ë‹¤ìš´ -->
          {% if user_profile.can_excel_download %}
          <div class="btn-group">
            <button type="button" class="btn btn-premium-success dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="fas fa-download me-2"></i>ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
            </button>
            <ul class="dropdown-menu">
              <li>
                <a class="dropdown-item" href="{% url 'reporting:followup_excel_download' %}{% if request.GET.urlencode %}?{{ request.GET.urlencode }}{% endif %}">
                  <i class="fas fa-file-excel me-2"></i>ì „ì²´ ë‹¤ìš´ë¡œë“œ
                  <small class="text-muted d-block">ê³ ê°ì •ë³´ + í™œë™ì´ë ¥ í¬í•¨</small>
                </a>
              </li>
              <li>
                <a class="dropdown-item" href="{% url 'reporting:followup_basic_excel_download' %}{% if request.GET.urlencode %}?{{ request.GET.urlencode }}{% endif %}">
                  <i class="fas fa-file-alt me-2"></i>ê¸°ë³¸ ì •ë³´ ë‹¤ìš´ë¡œë“œ
                  <small class="text-muted d-block">ê³ ê° ê¸°ë³¸ì •ë³´ë§Œ</small>
                </a>
              </li>
            </ul>
          </div>
          {% else %}
          <div class="btn-group">
            <button type="button" class="btn btn-secondary" disabled title="ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤">
              <i class="fas fa-download me-1"></i>ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
              <i class="fas fa-lock ms-1"></i>
            </button>
          </div>
          {% endif %}
        </div>
        {% else %}
        <!-- ì‹¤ë¬´ììš© ì¶”ê°€ ë²„íŠ¼ ë° ì—‘ì…€ ë‹¤ìš´ë¡œë“œ -->
        <div class="btn-group" role="group">
          <a href="{% url 'reporting:followup_create' %}" class="btn btn-premium-white">
            <i class="fas fa-plus me-2"></i>ìƒˆ ê³ ê° ì •ë³´ ì¶”ê°€
          </a>
          
          <!-- ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ë“œë¡­ë‹¤ìš´ -->
          {% if user_profile.can_excel_download %}
          <div class="btn-group" role="group">
            <button type="button" class="btn btn-premium-success dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="fas fa-download me-2"></i>ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
            </button>
            <ul class="dropdown-menu">
              <li>
                <a class="dropdown-item" href="{% url 'reporting:followup_excel_download' %}{% if request.GET.urlencode %}?{{ request.GET.urlencode }}{% endif %}">
                  <i class="fas fa-file-excel me-2"></i>ì „ì²´ ë‹¤ìš´ë¡œë“œ
                  <small class="text-muted d-block">ê³ ê°ì •ë³´ + í™œë™ì´ë ¥ í¬í•¨</small>
                </a>
              </li>
              <li>
                <a class="dropdown-item" href="{% url 'reporting:followup_basic_excel_download' %}{% if request.GET.urlencode %}?{{ request.GET.urlencode }}{% endif %}">
                  <i class="fas fa-file-alt me-2"></i>ê¸°ë³¸ ì •ë³´ ë‹¤ìš´ë¡œë“œ
                  <small class="text-muted d-block">ê³ ê° ê¸°ë³¸ì •ë³´ë§Œ</small>
                </a>
              </li>
            </ul>
          </div>
          {% else %}
          <div class="btn-group" role="group">
            <button type="button" class="btn btn-secondary" onclick="showExcelPermissionAlert()" title="ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤">
              <i class="fas fa-download me-1"></i>ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
              <i class="fas fa-lock ms-1"></i>
            </button>
          </div>
          {% endif %}
        </div>
        {% endif %}
        {% endif %}
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <div class="container">
        <div class="row">
            <div class="col-12">
                <!-- ê²€ìƒ‰ ì„¹ì…˜ -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card premium-search-card">
                            <div class="card-header">
                                <h6 class="card-title">
                                    <i class="fas fa-search me-2"></i>ê³ ê° ê²€ìƒ‰ ë° í•„í„°
                                </h6>
                            </div>
                            <div class="card-body">
              </h6>
              
              {% if request.user.userprofile.can_use_ai %}
              <!-- AI íŒ”ë¡œìš°ì—… ìš°ì„ ìˆœìœ„ ì œì•ˆ -->
              <div class="mb-3 p-3 bg-gradient rounded border border-primary">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div class="d-flex align-items-center">
                    <i class="fas fa-brain text-primary me-2"></i>
                    <strong>AI íŒ”ë¡œìš°ì—… ìš°ì„ ìˆœìœ„ ì œì•ˆ</strong>
                    <span class="badge bg-primary ms-2">NEW</span>
                  </div>
                  <button class="btn btn-sm btn-primary" type="button" id="suggest-followups-btn">
                    <i class="fas fa-magic me-1"></i>ìš°ì„ ìˆœìœ„ ë¶„ì„
                  </button>
                </div>
                <small class="text-muted d-block">
                  ğŸ’¡ AIê°€ ê³ ê° íˆìŠ¤í† ë¦¬/ì´ë©”ì¼ì„ ë¶„ì„í•˜ì—¬ <strong>ì¤‘ìš”í•œ ë‚´ìš©ì´ ìˆëŠ” ê³ ê°</strong>ì„ ìš°ì„  ì¶”ì²œí•©ë‹ˆë‹¤.
                </small>
              </div>
              
              <!-- AI íŒ”ë¡œìš°ì—… ì œì•ˆ ê²°ê³¼ ì˜ì—­ -->
              <div id="ai-followup-suggestions" class="mb-3" style="display: none;"></div>
              
              <!-- AI ìì—°ì–´ ê²€ìƒ‰ -->
              <div class="mb-3 p-3 bg-light rounded border">
                <div class="d-flex align-items-center mb-2">
                  <i class="fas fa-magic text-primary me-2"></i>
                  <strong>AI ìì—°ì–´ ê²€ìƒ‰</strong>
                  <span class="badge bg-primary ms-2">Beta</span>
                </div>
                <div class="input-group">
                  <input 
                    type="text" 
                    class="form-control" 
                    id="ai-search-input"
                    placeholder='ì˜ˆ: "ì§€ë‚œë‹¬ ê²¬ì  ì¤€ ëŒ€í•™êµ ê³ ê°" ë˜ëŠ” "3ê°œì›” ì´ìƒ ì—°ë½ ì•ˆ í•œ Aë“±ê¸‰ ê³ ê°"'
                    autocomplete="off"
                  >
                  <button class="btn btn-primary" type="button" id="ai-search-btn">
                    <i class="fas fa-search me-1"></i>AI ê²€ìƒ‰
                  </button>
                </div>
                <small class="text-muted d-block mt-1">
                  ğŸ’¡ ìì—°ìŠ¤ëŸ¬ìš´ ë§ë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”. AIê°€ ì¡°ê±´ì„ ì´í•´í•˜ê³  ê²°ê³¼ë¥¼ ì°¾ì•„ë“œë¦½ë‹ˆë‹¤.
                </small>
              </div>
              
              <!-- AI ê²€ìƒ‰ ê²°ê³¼ ì˜ì—­ -->
              <div id="ai-search-results" class="mb-3" style="display: none;"></div>
              {% endif %}
              
              <form method="GET" action="{% url 'reporting:followup_list' %}" id="followup-search-form">
                <div class="row g-3">
                  <!-- ê²€ìƒ‰ì–´ -->
                  <div class="col-md-4">
                    <label for="search" class="form-label">ê²€ìƒ‰ì–´ <small class="text-muted">(ì‰¼í‘œë¡œ ë‹¤ì¤‘ ê²€ìƒ‰)</small></label>
                    <input 
                      type="text" 
                      class="form-control" 
                      id="search"
                      name="search" 
                      value="{{ search_query|default:'' }}"
                      placeholder="ê³ ê°ëª…, ì—…ì²´ëª…, ë¶€ì„œëª…, ì±…ì„ì, ë©”ëª¨..."
                      autocomplete="off"
                    >
                  </div>
                  
                  <!-- ì—…ì²´ë³„ í•„í„° -->
                  <div class="col-md-2">
                    <label for="company" class="form-label">ì—…ì²´/í•™êµ</label>
                    <select class="form-control" id="company" name="company">
                      <option value="">ì „ì²´</option>
                      {% for company in companies %}
                      <option value="{{ company.id }}" {% if company_filter == company.id|stringformat:"s" %}selected{% endif %}>{{ company.name }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  
                  <!-- ê³ ê° ìš°ì„ ìˆœìœ„ í•„í„° -->
                  <div class="col-md-2">
                    <label for="priority" class="form-label">ìš°ì„ ìˆœìœ„</label>
                    <select class="form-control" id="priority" name="priority">
                      <option value="">ì „ì²´</option>
                      {% for priority_value, priority_display in priority_choices %}
                      <option value="{{ priority_value }}" {% if priority_filter == priority_value %}selected{% endif %}>
                        {{ priority_display }}
                      </option>
                      {% endfor %}
                    </select>
                  </div>
                  
                  {% if request.user.userprofile.can_use_ai %}
                  <!-- AI ì‚¬ìš©ì: ê³ ê° ë“±ê¸‰ í•„í„° -->
                  <div class="col-md-2">
                    <label for="grade" class="form-label">ê³ ê° ë“±ê¸‰</label>
                    <select class="form-control" id="grade" name="grade">
                      <option value="">ì „ì²´</option>
                      {% for grade_value, grade_display in grade_choices %}
                      <option value="{{ grade_value }}" {% if grade_filter == grade_value %}selected{% endif %}>
                        {{ grade_display }}
                      </option>
                      {% endfor %}
                    </select>
                  </div>
                  
                  <!-- AI ì‚¬ìš©ì: ì¢…í•© ì ìˆ˜ ë ˆë²¨ í•„í„° -->
                  <div class="col-md-3">
                    <label for="level" class="form-label">ì¢…í•© ìš°ì„ ìˆœìœ„</label>
                    <select class="form-control" id="level" name="level">
                      <option value="">ì „ì²´</option>
                      {% for level_value, level_display in level_choices %}
                      <option value="{{ level_value }}" {% if level_filter == level_value %}selected{% endif %}>
                        {{ level_display }}
                      </option>
                      {% endfor %}
                    </select>
                  </div>
                  {% endif %}
                  
                  <!-- ë²„íŠ¼ë“¤ -->
                  <div class="col-md-3 d-flex align-items-end">
                    <div class="btn-group">
                      <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search me-1"></i>ê²€ìƒ‰
                      </button>
                      <a href="{% url 'reporting:followup_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-1"></i>ì´ˆê¸°í™”
                      </a>
                    </div>
                  </div>
                </div>
                
                <!-- ê²€ìƒ‰ ê²°ê³¼ ì •ë³´ ë° AI ë²„íŠ¼ -->
                <div class="mt-3 d-flex justify-content-between align-items-center">
                  <div>
                    {% if search_query or company_filter or priority_filter or grade_filter or level_filter %}
                    <small class="text-muted">
                      ê²€ìƒ‰ ê²°ê³¼: {{ total_count }}ê±´
                      {% if search_query %} | ê²€ìƒ‰ì–´: "<strong>{{ search_query }}</strong>"{% endif %}
                      {% if selected_company %} | ì—…ì²´/í•™êµ: <strong>{{ selected_company.name }}</strong>{% endif %}
                      {% if selected_priority_display %} | ìš°ì„ ìˆœìœ„: <strong>{{ selected_priority_display }}</strong>{% endif %}
                      {% if grade_filter %} | ê³ ê°ë“±ê¸‰: <strong>{{ grade_filter }}</strong>{% endif %}
                      {% if level_filter %} | ì¢…í•©ìš°ì„ ìˆœìœ„: <strong>{% for lv, ld in level_choices %}{% if lv == level_filter %}{{ ld }}{% endif %}{% endfor %}</strong>{% endif %}
                    </small>
                    {% endif %}
                  </div>
                  
                  {% if request.user.userprofile.can_use_ai %}
                  <button type="button" class="btn btn-sm btn-info" id="refresh-all-grades-btn">
                    <i class="fas fa-sync-alt me-1"></i>ì „ì²´ ê³ ê° ë“±ê¸‰ ìƒˆë¡œê³ ì¹¨
                  </button>
                  {% endif %}
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- ì—…ì²´ë³„ í•„í„° ë²„íŠ¼ -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card filter-box-premium">
            <div class="card-body">
              <h6 class="mb-3" style="font-weight: 700; color: #2d3748;">
                <i class="fas fa-building me-2"></i>ì—…ì²´/í•™êµë³„ ë¹ ë¥¸ í•„í„°
              </h6>
              
              <div class="btn-group" role="group" style="flex-wrap: wrap; gap: 5px;">
                <a href="{% url 'reporting:followup_list' %}{% if search_query or user_filter %}?{% if search_query %}search={{ search_query }}{% endif %}{% if search_query and user_filter %}&{% endif %}{% if user_filter %}user={{ user_filter }}{% endif %}{% endif %}" class="btn {% if not company_filter %}btn-primary{% else %}btn-outline-primary{% endif %}">
                  <i class="fas fa-list me-1"></i>ì „ì²´ ({{ total_count }})
                </a>
                {% for company in companies|slice:":5" %}
                <a href="{% url 'reporting:followup_list' %}?company={{ company.id }}{% if search_query %}&search={{ search_query }}{% endif %}{% if user_filter %}&user={{ user_filter }}{% endif %}" class="btn {% if company_filter == company.id|stringformat:'s' %}btn-success{% else %}btn-outline-success{% endif %}">
                  <i class="fas fa-building me-1"></i>{{ company.name }} ({{ company.followup_count }})
                </a>
                {% endfor %}
                {% if companies|length > 5 %}
                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#companyModal">
                  <i class="fas fa-ellipsis-h me-1"></i>+{{ companies|length|add:"-5" }}ê°œ ë”ë³´ê¸°
                </button>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>

      {% if followups %}
      <div class="row">
        {% for followup in followups %}
        <div class="col-md-6 col-lg-4 mb-4">
          <div class="card followup-card h-100">
            <div
              class="card-header d-flex justify-content-between align-items-center"
            >
              <h6 class="mb-0">
                <a
                  href="{% url 'reporting:followup_detail' followup.pk %}"
                  class="text-decoration-none"
                >
                  {{ followup.customer_name|default:"ê³ ê°ëª… ë¯¸ì •" }}
                </a>
              </h6>
              <div class="d-flex gap-1">
                {% if request.user.userprofile.can_use_ai %}
                <!-- AI ì‚¬ìš©ì: ì¢…í•© ìš°ì„ ìˆœìœ„ + ê³ ê° ë“±ê¸‰ í‘œì‹œ -->
                <span class="badge" style="background-color: {{ followup.get_priority_level.color }}; color: white;">
                  {{ followup.get_priority_level.icon }} {{ followup.get_priority_level.label }}
                </span>
                {% if followup.customer_grade %}
                <span class="badge" style="
                  {% if followup.customer_grade == 'VIP' %}background: linear-gradient(135deg, #ffd700, #ffed4e);{% endif %}
                  {% if followup.customer_grade == 'A' %}background: linear-gradient(135deg, #667eea, #764ba2);{% endif %}
                  {% if followup.customer_grade == 'B' %}background: linear-gradient(135deg, #10b981, #059669);{% endif %}
                  {% if followup.customer_grade == 'C' %}background: linear-gradient(135deg, #64748b, #475569);{% endif %}
                  {% if followup.customer_grade == 'D' %}background: linear-gradient(135deg, #94a3b8, #64748b);{% endif %}
                  color: white;">
                  {{ followup.customer_grade }}
                </span>
                {% endif %}
                {% else %}
                <!-- ì¼ë°˜ ì‚¬ìš©ì: ìš°ì„ ìˆœìœ„ë§Œ í‘œì‹œ -->
                <span
                  class="badge bg-{% if followup.priority == 'urgent' %}danger{% elif followup.priority == 'followup' %}warning{% elif followup.priority == 'scheduled' %}info{% else %}secondary{% endif %}"
                >
                  {{ followup.get_priority_display }}
                </span>
                {% endif %}
              </div>
            </div>

            <div class="card-body">
              <p class="card-text">
                <strong>ì—…ì²´:</strong> {{ followup.company.name|default:"ì—…ì²´ëª… ë¯¸ì •"}}<br />
                {% if followup.department %}
                <strong>ë¶€ì„œ:</strong> {{ followup.department.name }}<br />
                {% endif %}
                <strong>ë‹´ë‹¹ì:</strong> {{ followup.user.username }}<br />
                {% if request.user.userprofile.can_use_ai %}
                <strong>ì¢…í•©ì ìˆ˜:</strong> <span class="badge bg-secondary">{{ followup.get_combined_score }}ì </span><br />
                {% endif %}
                {% if followup.manager %}
                <strong>ì±…ì„ì:</strong> {{ followup.manager }}<br />
                {% endif %}
                {% if followup.phone_number %}
                <strong>ì—°ë½ì²˜:</strong> {{ followup.phone_number }}<br />
                {% endif %}
                {% if followup.email %}
                <strong>ë©”ì¼:</strong> <a href="mailto:{{ followup.email }}" class="text-decoration-none">{{ followup.email }}</a><br />
                {% endif %}
                {% if followup.address %}
                <strong>ì£¼ì†Œ:</strong> {{ followup.address|truncatechars:50}}<br />
                {% endif %}
                <strong>ìƒì„±ì¼:</strong> {{ followup.created_at|date:"Yë…„ mì›” dì¼" }}
              </p>
              {% if followup.notes %}
              <div class="alert alert-light mb-3">
                <small>{{ followup.notes|truncatechars:100 }}</small>
              </div>
              {% endif %}
            </div>

            <div class="card-footer bg-transparent">
              <div class="btn-group w-100" role="group">
                <a
                  href="{% url 'reporting:followup_detail' followup.pk %}"
                  class="btn btn-outline-primary btn-sm"
                >
                  <i class="fas fa-eye me-1"></i>ìƒì„¸
                </a>
                {% if followup.user == request.user and user_profile.role != 'manager' or user_profile.is_admin %}
                <a
                  href="{% url 'reporting:followup_edit' followup.pk %}"
                  class="btn btn-outline-secondary btn-sm"
                >
                  <i class="fas fa-edit me-1"></i>ìˆ˜ì •
                </a>
                <a
                  href="{% url 'reporting:followup_delete' followup.pk %}"
                  class="btn btn-outline-danger btn-sm"
                >
                  <i class="fas fa-trash me-1"></i>ì‚­ì œ
                </a>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="row">
        <div class="col-12">
          <div class="card empty-state-card">
            <div class="card-body text-center py-5">
              <i class="fas fa-users fa-3x text-muted mb-3"></i>
              {% if search_query %}
              <h5 class="card-title">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h5>
              <p class="card-text text-muted">
                "<strong>{{ search_query }}</strong>"ì™€ ì¼ì¹˜í•˜ëŠ” ê³ ê° ì •ë³´ê°€
                ì—†ìŠµë‹ˆë‹¤.<br />
                ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”.
              </p>
              <a
                href="{% url 'reporting:followup_list' %}"
                class="btn btn-outline-primary"
              >
                <i class="fas fa-times me-1"></i>ê²€ìƒ‰ ì´ˆê¸°í™”
              </a>
              {% else %}
              <h5 class="card-title">ë“±ë¡ëœ ê³ ê° ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤</h5>
              <p class="card-text text-muted">
                ì²« ë²ˆì§¸ ê³ ê° ì •ë³´ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”.
              </p>
              {% if user.is_authenticated %}
              <a
                href="{% url 'reporting:followup_create' %}"
                class="btn btn-primary"
              >
                <i class="fas fa-plus me-1"></i>ìƒˆ ê³ ê° ì •ë³´ ì¶”ê°€
              </a>
              {% endif %} {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% endif %}
      
      <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
      {% if followups.has_other_pages %}
      <div class="row mt-4">
        <div class="col-12">
          <nav aria-label="íŒ”ë¡œìš°ì—… ëª©ë¡ í˜ì´ì§€ë„¤ì´ì…˜">
            <ul class="pagination pagination-premium justify-content-center">
              <!-- ì²« í˜ì´ì§€ -->
              {% if followups.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if company_filter %}company={{ company_filter }}&{% endif %}{% if priority_filter %}priority={{ priority_filter }}&{% endif %}{% if user_filter %}user={{ user_filter }}&{% endif %}page=1" aria-label="ì²« í˜ì´ì§€">
                  <span aria-hidden="true">&laquo;&laquo;</span>
                </a>
              </li>
              <!-- ì´ì „ í˜ì´ì§€ -->
              <li class="page-item">
                <a class="page-link" href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if company_filter %}company={{ company_filter }}&{% endif %}{% if priority_filter %}priority={{ priority_filter }}&{% endif %}{% if user_filter %}user={{ user_filter }}&{% endif %}page={{ followups.previous_page_number }}" aria-label="ì´ì „ í˜ì´ì§€">
                  <span aria-hidden="true">&laquo;</span>
                </a>
              </li>
              {% else %}
              <li class="page-item disabled">
                <span class="page-link">&laquo;&laquo;</span>
              </li>
              <li class="page-item disabled">
                <span class="page-link">&laquo;</span>
              </li>
              {% endif %}
              
              <!-- í˜ì´ì§€ ë²ˆí˜¸ë“¤ -->
              {% if followups.paginator.num_pages <= 5 %}
                <!-- ì „ì²´ í˜ì´ì§€ê°€ 5ê°œ ì´í•˜ë©´ ëª¨ë‘ í‘œì‹œ -->
                {% for num in followups.paginator.page_range %}
                  {% if num == followups.number %}
                  <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                  </li>
                  {% else %}
                  <li class="page-item">
                    <a class="page-link" href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if company_filter %}company={{ company_filter }}&{% endif %}{% if priority_filter %}priority={{ priority_filter }}&{% endif %}{% if user_filter %}user={{ user_filter }}&{% endif %}page={{ num }}">{{ num }}</a>
                  </li>
                  {% endif %}
                {% endfor %}
              {% else %}
                <!-- ì „ì²´ í˜ì´ì§€ê°€ 5ê°œ ì´ˆê³¼ë©´ 1~5ë§Œ í‘œì‹œ -->
                {% for num in followups.paginator.page_range %}
                  {% if num <= 5 %}
                    {% if num == followups.number %}
                    <li class="page-item active">
                      <span class="page-link">{{ num }}</span>
                    </li>
                    {% else %}
                    <li class="page-item">
                      <a class="page-link" href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if company_filter %}company={{ company_filter }}&{% endif %}{% if priority_filter %}priority={{ priority_filter }}&{% endif %}{% if user_filter %}user={{ user_filter }}&{% endif %}page={{ num }}">{{ num }}</a>
                    </li>
                    {% endif %}
                  {% endif %}
                {% endfor %}
                {% if followups.number > 5 %}
                  <li class="page-item disabled">
                    <span class="page-link">...</span>
                  </li>
                  <li class="page-item active">
                    <span class="page-link">{{ followups.number }}</span>
                  </li>
                {% endif %}
              {% endif %}
              
              <!-- ë‹¤ìŒ í˜ì´ì§€ -->
              {% if followups.has_next %}
              <li class="page-item">
                <a class="page-link" href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if company_filter %}company={{ company_filter }}&{% endif %}{% if priority_filter %}priority={{ priority_filter }}&{% endif %}{% if user_filter %}user={{ user_filter }}&{% endif %}page={{ followups.next_page_number }}" aria-label="ë‹¤ìŒ í˜ì´ì§€">
                  <span aria-hidden="true">&raquo;</span>
                </a>
              </li>
              <!-- ë§ˆì§€ë§‰ í˜ì´ì§€ -->
              <li class="page-item">
                <a class="page-link" href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if company_filter %}company={{ company_filter }}&{% endif %}{% if priority_filter %}priority={{ priority_filter }}&{% endif %}{% if user_filter %}user={{ user_filter }}&{% endif %}page={{ followups.paginator.num_pages }}" aria-label="ë§ˆì§€ë§‰ í˜ì´ì§€">
                  <span aria-hidden="true">&raquo;&raquo;</span>
                </a>
              </li>
              {% else %}
              <li class="page-item disabled">
                <span class="page-link">&raquo;</span>
              </li>
              <li class="page-item disabled">
                <span class="page-link">&raquo;&raquo;</span>
              </li>
              {% endif %}
            </ul>
          </nav>
          
          <!-- í˜ì´ì§€ ì •ë³´ -->
          <div class="text-center pagination-info mt-3">
            {{ followups.start_index }}~{{ followups.end_index }}ë²ˆ (ì „ì²´ {{ followups.paginator.count }}ê°œ)
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- ì—…ì²´/í•™êµ ì „ì²´ ëª©ë¡ ëª¨ë‹¬ -->
<div class="modal fade" id="companyModal" tabindex="-1" aria-labelledby="companyModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="companyModalLabel">
          <i class="fas fa-building me-2"></i>ì—…ì²´/í•™êµ ì „ì²´ ëª©ë¡ ({{ companies|length }}ê°œ)
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- ê²€ìƒ‰ ê¸°ëŠ¥ -->
        <div class="mb-3">
          <div class="input-group">
            <span class="input-group-text">
              <i class="fas fa-search"></i>
            </span>
            <input type="text" class="form-control" id="companySearch" placeholder="ì—…ì²´/í•™êµëª…ì„ ê²€ìƒ‰í•˜ì„¸ìš”..." autocomplete="off">
          </div>
        </div>
        
        <!-- ì—…ì²´ ëª©ë¡ -->
        <div class="row g-2" id="companyList">
          {% for company in companies %}
          <div class="col-md-6 company-item" data-name="{{ company.name|lower }}">
            <a href="{% url 'reporting:followup_list' %}?company={{ company.id }}{% if search_query %}&search={{ search_query }}{% endif %}{% if user_filter %}&user={{ user_filter }}{% endif %}" 
               class="btn {% if company_filter == company.id|stringformat:'s' %}btn-success{% else %}btn-outline-success{% endif %} w-100 text-start">
              <i class="fas fa-building me-2"></i>{{ company.name }}
              <span class="badge bg-secondary ms-auto">{{ company.followup_count }}ê±´</span>
            </a>
          </div>
          {% endfor %}
        </div>
        
        <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
        <nav aria-label="ì—…ì²´ ëª©ë¡ í˜ì´ì§€ë„¤ì´ì…˜" class="mt-3">
          <ul class="pagination justify-content-center" id="companyPagination">
            <!-- í˜ì´ì§€ë„¤ì´ì…˜ì€ JavaScriptë¡œ ë™ì  ìƒì„± -->
          </ul>
        </nav>
        
        <!-- ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ -->
        <div id="noResults" class="text-center py-4" style="display: none;">
          <i class="fas fa-search fa-2x text-muted mb-2"></i>
          <p class="text-muted">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i>ë‹«ê¸°
        </button>
      </div>
    </div>
  </div>
</div>

<!-- AI ë“±ê¸‰ ìƒˆë¡œê³ ì¹¨ ëª¨ë‹¬ -->
<div class="modal fade" id="gradeRefreshModal" tabindex="-1" aria-labelledby="gradeRefreshModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="gradeRefreshModalLabel">
          <i class="fas fa-sync-alt me-2"></i>ì „ì²´ ê³ ê° ë“±ê¸‰ ì—…ë°ì´íŠ¸
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="grade-refresh-status">
        <!-- ë™ì ìœ¼ë¡œ ë‚´ìš©ì´ ì±„ì›Œì§‘ë‹ˆë‹¤ -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
      </div>
    </div>
  </div>
</div>

<script>
// ì—…ì²´ ê²€ìƒ‰ ë° í˜ì´ì§€ë„¤ì´ì…˜ ê¸°ëŠ¥
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('companySearch');
    const companyItems = document.querySelectorAll('.company-item');
    const companyList = document.getElementById('companyList');
    const companyPagination = document.getElementById('companyPagination');
    const noResults = document.getElementById('noResults');
    
    // í˜ì´ì§€ë„¤ì´ì…˜ ì„¤ì •
    const itemsPerPage = 10;
    let currentPage = 1;
    let filteredItems = Array.from(companyItems);
    
    // í˜ì´ì§€ë„¤ì´ì…˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updatePagination() {
        const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
        
        // í˜ì´ì§€ë„¤ì´ì…˜ ì´ˆê¸°í™”
        companyPagination.innerHTML = '';
        
        if (totalPages <= 1) {
            companyPagination.style.display = 'none';
            return;
        }
        
        companyPagination.style.display = 'flex';
        
        // ì´ì „ í˜ì´ì§€ ë²„íŠ¼
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `
            <a class="page-link" href="#" aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
            </a>
        `;
        prevLi.addEventListener('click', function(e) {
            e.preventDefault();
            if (currentPage > 1) {
                currentPage--;
                showPage(currentPage);
                updatePagination();
            }
        });
        companyPagination.appendChild(prevLi);
        
        // í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼ë“¤
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, startPage + 4);
        
        for (let i = startPage; i <= endPage; i++) {
            const pageLi = document.createElement('li');
            pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
            pageLi.innerHTML = `<a class="page-link" href="#">${i}</a>`;
            
            pageLi.addEventListener('click', function(e) {
                e.preventDefault();
                currentPage = i;
                showPage(currentPage);
                updatePagination();
            });
            
            companyPagination.appendChild(pageLi);
        }
        
        // ë‹¤ìŒ í˜ì´ì§€ ë²„íŠ¼
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `
            <a class="page-link" href="#" aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
            </a>
        `;
        nextLi.addEventListener('click', function(e) {
            e.preventDefault();
            if (currentPage < totalPages) {
                currentPage++;
                showPage(currentPage);
                updatePagination();
            }
        });
        companyPagination.appendChild(nextLi);
    }
    
    // íŠ¹ì • í˜ì´ì§€ í‘œì‹œ í•¨ìˆ˜
    function showPage(page) {
        const startIndex = (page - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        
        
        // ëª¨ë“  ì—…ì²´ í•­ëª© ìˆ¨ê¸°ê¸° (ì „ì²´ ëª©ë¡ì—ì„œ)
        companyItems.forEach(function(item) {
            item.style.display = 'none';
        });
        
        // í•„í„°ë§ëœ ì•„ì´í…œë§Œ í‘œì‹œ
        filteredItems.forEach(function(item, index) {
            if (index >= startIndex && index < endIndex) {
                item.style.display = 'block';
            }
        });
        
        // ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ í‘œì‹œ ì²˜ë¦¬
        if (filteredItems.length === 0) {
            noResults.style.display = 'block';
        } else {
            noResults.style.display = 'none';
        }
    }
    
    // ê²€ìƒ‰ ê¸°ëŠ¥
    if (searchInput) {
        
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            
            // ê²€ìƒ‰ì–´ê°€ ë¹„ì–´ìˆìœ¼ë©´ ëª¨ë“  í•­ëª©ì„ í‘œì‹œ
            if (searchTerm === '') {
                filteredItems = Array.from(companyItems);
            } else {
                // í•„í„°ë§ëœ ì•„ì´í…œ ì—…ë°ì´íŠ¸
                filteredItems = Array.from(companyItems).filter(function(item) {
                    const companyName = item.getAttribute('data-name');
                    const matches = companyName && companyName.includes(searchTerm);
                    if (matches) {
                    }
                    return matches;
                });
            }
            
            // ì²« í˜ì´ì§€ë¡œ ë¦¬ì…‹
            currentPage = 1;
            
            // í˜ì´ì§€ í‘œì‹œ ë° í˜ì´ì§€ë„¤ì´ì…˜ ì—…ë°ì´íŠ¸
            showPage(currentPage);
            updatePagination();
        });
        
        // ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œ ì´ˆê¸°í™”
        const companyModal = document.getElementById('companyModal');
        if (companyModal) {
            companyModal.addEventListener('shown.bs.modal', function() {
                searchInput.value = '';
                filteredItems = Array.from(companyItems);
                currentPage = 1;
                showPage(currentPage);
                updatePagination();
                searchInput.focus();
            });
        }
    }
    
    // ì´ˆê¸° í˜ì´ì§€ë„¤ì´ì…˜ ì„¤ì •
    showPage(currentPage);
    updatePagination();
});

// AI íŒ”ë¡œìš°ì—… ìš°ì„ ìˆœìœ„ ì œì•ˆ
{% if request.user.userprofile.can_use_ai %}
document.addEventListener('DOMContentLoaded', function() {
    const suggestBtn = document.getElementById('suggest-followups-btn');
    const suggestionsDiv = document.getElementById('ai-followup-suggestions');
    
    if (suggestBtn && suggestionsDiv) {
        suggestBtn.addEventListener('click', async function() {
            await runAITaskWithDetails(
                'íŒ”ë¡œìš°ì—… ìš°ì„ ìˆœìœ„ ì œì•ˆ',
                '/reporting/ai/suggest-follow-ups/',
                {},
                // ìƒì„¸ ë¡œê·¸ ì½œë°±
                async function() {
                    addAILog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
                    addAILog('ğŸ¯ íŒ”ë¡œìš°ì—… ìš°ì„ ìˆœìœ„ ë¶„ì„ ì‹œì‘', 'info');
                    addAILog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
                    await sleep(300);
                    addAILog('ğŸ” ê³ ê°ë³„ í™œë™ ì´ë ¥ ë¶„ì„ ì¤‘...', 'info');
                    await sleep(300);
                    addAILog('ğŸ“ íˆìŠ¤í† ë¦¬/ì´ë©”ì¼ì—ì„œ ì¤‘ìš” ì‹ í˜¸ íƒìƒ‰ ì¤‘...', 'info');
                    await sleep(300);
                    addAILog('ğŸ’¡ ìš°ì„ ìˆœìœ„ ì•Œê³ ë¦¬ì¦˜ ì ìš© ì¤‘...', 'info');
                },
                // ì„±ê³µ ì½œë°±
                function(data) {
                    if (data.suggestions && data.suggestions.length > 0) {
                        displayFollowUpSuggestions(data);
                        suggestionsDiv.style.display = 'block';
                    } else {
                        suggestionsDiv.innerHTML = `
                            <div class="alert alert-warning">
                                <i class="fas fa-info-circle me-2"></i>
                                ${data.error || 'ë¶„ì„í•  ê³ ê°ì´ ì—†ìŠµë‹ˆë‹¤.'}
                            </div>
                        `;
                        suggestionsDiv.style.display = 'block';
                    }
                },
                // ì—ëŸ¬ ì½œë°±
                function(error) {
                    suggestionsDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>ë¶„ì„ ì¤‘ ì˜¤ë¥˜: ${error.message}
                        </div>
                    `;
                    suggestionsDiv.style.display = 'block';
                }
            );
        });
    }
    
    function displayFollowUpSuggestions(data) {
        const suggestions = data.suggestions;
        const totalAnalyzed = data.total_analyzed || 0;
        const filters = data.filters_applied || {};
        
        // í•„í„° ì •ë³´ í…ìŠ¤íŠ¸
        let filterText = '';
        if (filters.grade && filters.grade !== 'ì „ì²´') filterText += `ë“±ê¸‰: ${filters.grade}, `;
        if (filters.company_id && filters.company_id !== 'ì „ì²´') filterText += `ì—…ì²´ í•„í„° ì ìš©, `;
        filterText += `ê¸°ê°„: ${filters.period_months === 'all' ? 'ì „ì²´' : filters.period_months + 'ê°œì›”'}`;
        
        // ìš°ì„ ìˆœìœ„ ë ˆë²¨ë³„ ìƒ‰ìƒ ë° ì•„ì´ì½˜
        const priorityConfig = {
            'urgent': { color: 'danger', icon: 'ğŸ”´', label: 'ê¸´ê¸‰' },
            'high': { color: 'warning', icon: 'ğŸŸ ', label: 'ë†’ìŒ' },
            'medium': { color: 'info', icon: 'ğŸŸ¡', label: 'ë³´í†µ' },
            'low': { color: 'secondary', icon: 'ğŸŸ¢', label: 'ë‚®ìŒ' }
        };
        
        // ê³ ê°ëª… ëª©ë¡ (ê²€ìƒ‰ ê²°ê³¼ë¡œ í•„í„°ë§ìš©)
        const customerNames = suggestions.map(s => s.customer_name).join(',');
        
        let html = `
            <div class="alert alert-success">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>AI ë¶„ì„ ì™„ë£Œ</strong>
                    </div>
                    <button type="button" class="btn-close" onclick="document.getElementById('ai-followup-suggestions').style.display='none'"></button>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-2">
                    <small class="text-muted">
                        ì´ ${totalAnalyzed}ëª…ì˜ ê³ ê°ì„ ë¶„ì„í–ˆìŠµë‹ˆë‹¤. 
                        <span class="badge bg-light text-dark ms-2">${filterText}</span>
                    </small>
                    <button type="button" class="btn btn-primary btn-sm" onclick="applyFollowUpSuggestionsToSearch('${customerNames.replace(/'/g, "\\'")}')">
                        <i class="fas fa-filter me-1"></i>ê²€ìƒ‰ ê²°ê³¼ë¡œ í•„í„°ë§
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <span class="text-dark"><i class="fas fa-list-ol me-2"></i>ìš°ì„ ìˆœìœ„ TOP ${suggestions.length}</span>
                    <small class="text-dark">ğŸ’¡ íˆìŠ¤í† ë¦¬/ì´ë©”ì¼ì—ì„œ ì¤‘ìš” ì‹ í˜¸ê°€ ìˆëŠ” ê³ ê° ìš°ì„ </small>
                </div>
                <div class="list-group list-group-flush">
        `;
        
        suggestions.forEach((item, index) => {
            const config = priorityConfig[item.priority_level] || priorityConfig['medium'];
            const rank = index + 1;
            
            html += `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <span class="badge bg-dark" style="font-size: 1.1rem; padding: 0.5rem 0.7rem;">#${rank}</span>
                            </div>
                            <div>
                                <h6 class="mb-1">
                                    <a href="/reporting/followups/${item.customer_id}/" class="text-decoration-none">
                                        ${item.customer_name}
                                    </a>
                                    ${item.company ? `<small class="text-muted ms-2">${item.company}</small>` : ''}
                                </h6>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="badge bg-${config.color}">${config.icon} ${config.label}</span>
                                    <span class="badge bg-secondary">${item.priority_score}ì </span>
                                    ${item.customer_grade ? `<span class="badge bg-info">${item.customer_grade}ë“±ê¸‰</span>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row g-2 small mb-2">
                        <div class="col-md-12">
                            <div class="p-2 bg-light rounded">
                                <strong class="text-primary">
                                    <i class="fas fa-lightbulb me-1"></i>ìš°ì„ ìˆœìœ„ ì´ìœ :
                                </strong>
                                <p class="mb-0 mt-1">${item.reason}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row g-2 small">
                        <div class="col-md-6">
                            <div class="p-2 bg-success bg-opacity-10 rounded">
                                <strong class="text-success">
                                    <i class="fas fa-tasks me-1"></i>ì œì•ˆ ì•¡ì…˜:
                                </strong>
                                <p class="mb-0 mt-1">${item.suggested_action}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="p-2 bg-info bg-opacity-10 rounded">
                                <strong class="text-info">
                                    <i class="fas fa-clock me-1"></i>ìµœì  ì—°ë½ ì‹œê°„:
                                </strong>
                                <p class="mb-0 mt-1">${item.best_contact_time || 'ì–¸ì œë“ ì§€ ê°€ëŠ¥'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-2 d-flex gap-2">
                        <a href="/reporting/followups/${item.customer_id}/" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye me-1"></i>ê³ ê° ìƒì„¸
                        </a>
                    </div>
                </div>
            `;
        });
        
        html += `
                </div>
                <div class="card-footer text-center">
                    <small class="text-muted">
                        ğŸ’¡ ìš°ì„ ìˆœìœ„ëŠ” ê³ ê° ë“±ê¸‰, ë§ˆì§€ë§‰ ì—°ë½ì¼, ì§„í–‰ ì¤‘ì¸ ê¸°íšŒ, ê³¼ê±° êµ¬ë§¤ ì´ë ¥ ë“±ì„ ì¢…í•©ì ìœ¼ë¡œ ë¶„ì„í•˜ì—¬ ì‚°ì •ë©ë‹ˆë‹¤.
                    </small>
                </div>
            </div>
        `;
        
        suggestionsDiv.innerHTML = html;
        suggestionsDiv.style.display = 'block';
        
        // ê²°ê³¼ ì˜ì—­ìœ¼ë¡œ ìŠ¤í¬ë¡¤
        suggestionsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    
    // AI íŒ”ë¡œìš°ì—… ì œì•ˆ ê²°ê³¼ë¥¼ ê²€ìƒ‰ì°½ì— ì ìš©í•˜ëŠ” í•¨ìˆ˜
    window.applyFollowUpSuggestionsToSearch = function(customerNames) {
        const searchInput = document.getElementById('search');
        if (searchInput) {
            searchInput.value = customerNames;
            // í¼ ì œì¶œ
            const form = searchInput.closest('form');
            if (form) {
                form.submit();
            }
        }
    };
});
{% endif %}

// AI ìì—°ì–´ ê²€ìƒ‰
{% if request.user.userprofile.can_use_ai %}
document.addEventListener('DOMContentLoaded', function() {
    const aiSearchBtn = document.getElementById('ai-search-btn');
    const aiSearchInput = document.getElementById('ai-search-input');
    const aiSearchResults = document.getElementById('ai-search-results');
    
    if (aiSearchBtn && aiSearchInput) {
        // Enter í‚¤ ì§€ì›
        aiSearchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                aiSearchBtn.click();
            }
        });
        
        aiSearchBtn.addEventListener('click', function() {
            const query = aiSearchInput.value.trim();
            
            if (!query) {
                alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // í”„ë¡œê·¸ë ˆìŠ¤ ëª¨ë‹¬ í‘œì‹œ
            showProgressModal('AI ìì—°ì–´ ê²€ìƒ‰ ì¤‘...', [
                'ê²€ìƒ‰ì–´ ë¶„ì„ ì¤‘...',
                'AI ì¿¼ë¦¬ ìƒì„± ì¤‘...',
                'ë°ì´í„°ë² ì´ìŠ¤ ê²€ìƒ‰ ì¤‘...',
                'ê²°ê³¼ ì •ë¦¬ ì¤‘...'
            ]);
            
            aiSearchResults.style.display = 'none';
            
            updateProgress(0, 'ê²€ìƒ‰ì–´ ë¶„ì„ ì¤‘...');
            
            fetch('/reporting/ai/search/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    query: query,
                    search_type: 'customers'  // ê³ ê°ë§Œ ê²€ìƒ‰
                })
            })
            .then(response => {
                updateProgress(50, 'AI ì¿¼ë¦¬ ìƒì„± ì™„ë£Œ');
                return response.json();
            })
            .then(data => {
                updateProgress(75, 'ë°ì´í„°ë² ì´ìŠ¤ ê²€ìƒ‰ ì™„ë£Œ');
                
                // í”„ë¡œê·¸ë ˆìŠ¤ ëª¨ë‹¬ ë‹«ê¸°
                closeProgressModal();
                
                if (data.success) {
                    displayAISearchResults(data);
                } else {
                    aiSearchResults.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>${data.error || 'AI ê²€ìƒ‰ ì‹¤íŒ¨'}
                        </div>
                    `;
                    aiSearchResults.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                closeProgressModal();
                aiSearchResults.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
                    </div>
                `;
                aiSearchResults.style.display = 'block';
            });
        });
    }
    
    function displayAISearchResults(data) {
        const results = data.results;
        const totalCount = data.total_count || 0;
        
        // ê³ ê°ëª… ëª©ë¡ ì¶”ì¶œ (ë‹¤ì¤‘ ê²€ìƒ‰ìš©)
        const customerNames = results.customers ? results.customers.map(c => c.name) : [];
        const searchParam = customerNames.join(',');
        
        let html = `
            <div class="alert alert-info">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-lightbulb me-2"></i>
                        <strong>AI ë¶„ì„:</strong> ${results.interpretation || 'ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.'}
                    </div>
                    <button type="button" class="btn-close" onclick="document.getElementById('ai-search-results').style.display='none'"></button>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-2">
                    <small class="text-muted">ì´ ${totalCount}ê°œì˜ ê²°ê³¼ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.</small>
                    ${customerNames.length > 0 ? `
                        <button type="button" class="btn btn-sm btn-primary" onclick="applyAISearchToList('${searchParam.replace(/'/g, "\\'")}')">
                            <i class="fas fa-filter me-1"></i>ê²€ìƒ‰ ê²°ê³¼ë¡œ í•„í„°ë§
                        </button>
                    ` : ''}
                </div>
            </div>
        `;
        
        // ê³ ê° ê²°ê³¼
        if (results.customers && results.customers.length > 0) {
            html += `
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-users me-2"></i>ê³ ê° (${results.customers.length}ê±´)</span>
                        <button type="button" class="btn btn-sm btn-light" onclick="applyAISearchToList('${searchParam.replace(/'/g, "\\'")}')">
                            <i class="fas fa-search me-1"></i>ì „ì²´ ê²€ìƒ‰
                        </button>
                    </div>
                    <div class="list-group list-group-flush">
            `;
            results.customers.forEach(customer => {
                const gradeColor = {
                    'A+': 'danger', 'A': 'warning', 'B': 'info', 'C': 'secondary', 'D': 'dark'
                }[customer.grade] || 'secondary';
                
                html += `
                    <a href="/reporting/followups/${customer.id}/" class="list-group-item list-group-item-action">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${customer.name}</strong>
                                ${customer.company ? `<span class="text-muted ms-2">${customer.company}</span>` : ''}
                            </div>
                            <div>
                                ${customer.grade ? `<span class="badge bg-${gradeColor}">${customer.grade}</span>` : ''}
                                ${customer.last_contact ? `<small class="text-muted ms-2">${customer.last_contact}</small>` : ''}
                            </div>
                        </div>
                    </a>
                `;
            });
            html += `
                    </div>
                </div>
            `;
        }
        
        // ì¼ì • ê²°ê³¼
        if (results.schedules && results.schedules.length > 0) {
            html += `
                <div class="card mb-3">
                    <div class="card-header bg-success text-white">
                        <i class="fas fa-calendar me-2"></i>ì¼ì • (${results.schedules.length}ê±´)
                    </div>
                    <div class="list-group list-group-flush">
            `;
            results.schedules.forEach(schedule => {
                const typeLabels = {
                    'meeting': 'ë¯¸íŒ…', 'quote': 'ê²¬ì ', 'delivery': 'ë‚©í’ˆ', 'call': 'ì „í™”', 'email': 'ì´ë©”ì¼'
                };
                const typeLabel = typeLabels[schedule.type] || schedule.type;
                
                html += `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <span class="badge bg-success">${typeLabel}</span>
                                <strong class="ms-2">${schedule.customer}</strong>
                                ${schedule.content ? `<p class="mb-0 mt-1 small text-muted">${schedule.content}</p>` : ''}
                            </div>
                            <small class="text-muted">${schedule.start_date}</small>
                        </div>
                    </div>
                `;
            });
            html += `
                    </div>
                </div>
            `;
        }
        
        // ì˜ì—…ê¸°íšŒ ê²°ê³¼
        if (results.opportunities && results.opportunities.length > 0) {
            html += `
                <div class="card mb-3">
                    <div class="card-header bg-warning text-dark">
                        <i class="fas fa-bullseye me-2"></i>ì˜ì—…ê¸°íšŒ (${results.opportunities.length}ê±´)
                    </div>
                    <div class="list-group list-group-flush">
            `;
            results.opportunities.forEach(opp => {
                html += `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${opp.title}</strong>
                                <span class="text-muted ms-2">${opp.customer}</span>
                                <span class="badge bg-secondary ms-2">${opp.stage}</span>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold">${opp.value.toLocaleString()}ì›</div>
                                <small class="text-muted">${opp.created}</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += `
                    </div>
                </div>
            `;
        }
        
        if (totalCount === 0) {
            html += `
                <div class="alert alert-warning">
                    <i class="fas fa-search me-2"></i>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”.
                </div>
            `;
        }
        
        aiSearchResults.innerHTML = html;
        aiSearchResults.style.display = 'block';
    }
    
    // AI ê²€ìƒ‰ ê²°ê³¼ë¥¼ ê²€ìƒ‰ í¼ì— ì ìš©í•˜ëŠ” í•¨ìˆ˜ (ì „ì—­)
    window.applyAISearchToList = function(searchTerms) {
        const searchInput = document.getElementById('search');
        const searchForm = document.getElementById('followup-search-form');
        
        if (searchInput && searchForm) {
            searchInput.value = searchTerms;
            // AI ê²€ìƒ‰ ê²°ê³¼ ì˜ì—­ ìˆ¨ê¸°ê¸°
            const aiSearchResults = document.getElementById('ai-search-results');
            if (aiSearchResults) {
                aiSearchResults.style.display = 'none';
            }
            searchForm.submit();
        }
    };
});
{% endif %}

// AI ì „ì²´ ê³ ê° ë“±ê¸‰ ìƒˆë¡œê³ ì¹¨
{% if request.user.userprofile.can_use_ai %}
document.addEventListener('DOMContentLoaded', function() {
    const refreshBtn = document.getElementById('refresh-all-grades-btn');
    
    if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
            // ëª¨ë‹¬ í‘œì‹œ
            const modal = new bootstrap.Modal(document.getElementById('gradeRefreshModal'));
            modal.show();
            
            const modalBody = document.getElementById('grade-refresh-status');
            const closeBtn = document.querySelector('#gradeRefreshModal .btn-close');
            const closeFooterBtn = document.querySelector('#gradeRefreshModal .btn-secondary');
            
            // ë‹«ê¸° ë²„íŠ¼ ë¹„í™œì„±í™”
            if (closeBtn) closeBtn.disabled = true;
            if (closeFooterBtn) closeFooterBtn.disabled = true;
            
            modalBody.innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">ë¡œë”© ì¤‘...</span>
                    </div>
                    <p class="mb-0">ë“±ê¸‰ ì—…ë°ì´íŠ¸ë¥¼ ì‹œì‘í•˜ëŠ” ì¤‘...</p>
                </div>
            `;
            
            // AJAX ìš”ì²­ìœ¼ë¡œ ë°±ê·¸ë¼ìš´ë“œ ì‘ì—… ì‹œì‘
            fetch('/reporting/ai/refresh-all-grades/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    limit: null,
                    background: true
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.task_id) {
                    // ì‘ì—… ì‹œì‘ ì„±ê³µ - í´ë§ ì‹œì‘
                    modalBody.innerHTML = `
                        <div class="alert alert-info">
                            <h5 class="alert-heading">
                                <i class="fas fa-sync-alt fa-spin me-2"></i>ë“±ê¸‰ ì—…ë°ì´íŠ¸ ì§„í–‰ ì¤‘
                            </h5>
                            <hr>
                            <p class="mb-2"><strong>ê°±ì‹  ì •ë³´:</strong> ${data.refresh_info || 'ì „ì²´ ê³ ê° ê°±ì‹ '}</p>
                            <p class="mb-2"><strong>ë§ˆì§€ë§‰ ê°±ì‹ :</strong> ${data.last_refresh || 'ì²« ê°±ì‹ '}</p>
                            <p class="mb-2"><strong>ì²˜ë¦¬ ëŒ€ìƒ:</strong> ${data.total_count}ëª…</p>
                            <p class="mb-2"><strong>ì˜ˆìƒ ì†Œìš” ì‹œê°„:</strong> ${data.estimated_time}</p>
                            <hr>
                            <div class="progress mb-2">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%" id="update-progress"></div>
                            </div>
                            <p class="mb-0 small text-muted" id="update-status">ì²˜ë¦¬ ì¤‘...</p>
                        </div>
                    `;
                    
                    // í´ë§ ì‹œì‘ (2ì´ˆë§ˆë‹¤ ìƒíƒœ í™•ì¸)
                    const pollInterval = setInterval(function() {
                        fetch(`/reporting/ai/check-grade-update-status/${data.task_id}/`, {
                            method: 'GET',
                            headers: {
                                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                            }
                        })
                        .then(response => response.json())
                        .then(statusData => {
                            if (statusData.success && statusData.status) {
                                const status = statusData.status;
                                const progressBar = document.getElementById('update-progress');
                                const statusText = document.getElementById('update-status');
                                
                                if (status.status === 'completed') {
                                    // ì™„ë£Œ
                                    clearInterval(pollInterval);
                                    
                                    // ë‹«ê¸° ë²„íŠ¼ í™œì„±í™”
                                    if (closeBtn) closeBtn.disabled = false;
                                    if (closeFooterBtn) closeFooterBtn.disabled = false;
                                    
                                    // ë“±ê¸‰ ë³€ê²½ ìƒì„¸ ë‚´ì—­ HTML ìƒì„±
                                    let changesHTML = '';
                                    if (status.changes && status.changes.length > 0) {
                                        changesHTML = `
                                            <hr>
                                            <h6 class="mb-3">
                                                <i class="fas fa-exchange-alt me-2"></i>ë“±ê¸‰ ë³€ê²½ ìƒì„¸ ë‚´ì—­ (${status.grade_changes}ê±´)
                                            </h6>
                                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                                <table class="table table-sm table-hover">
                                                    <thead class="table-light sticky-top">
                                                        <tr>
                                                            <th>ê³ ê°ëª…</th>
                                                            <th>ì—…ì²´</th>
                                                            <th>ì´ì „ ë“±ê¸‰</th>
                                                            <th></th>
                                                            <th>ë³€ê²½ ë“±ê¸‰</th>
                                                            <th>ì ìˆ˜</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                        `;
                                        
                                        status.changes.forEach(change => {
                                            const scoreDiff = change.new_score - change.old_score;
                                            const arrowColor = scoreDiff > 0 ? 'text-success' : (scoreDiff < 0 ? 'text-danger' : 'text-muted');
                                            const arrowIcon = scoreDiff > 0 ? 'fa-arrow-up' : (scoreDiff < 0 ? 'fa-arrow-down' : 'fa-minus');
                                            
                                            changesHTML += `
                                                <tr>
                                                    <td><strong>${change.customer_name}</strong></td>
                                                    <td class="text-muted small">${change.company}</td>
                                                    <td>
                                                        <span class="badge bg-secondary">${change.old_grade}</span>
                                                        <small class="text-muted">(${change.old_score}ì )</small>
                                                    </td>
                                                    <td class="text-center">
                                                        <i class="fas ${arrowIcon} ${arrowColor}"></i>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-primary">${change.new_grade}</span>
                                                        <small class="text-muted">(${change.new_score}ì )</small>
                                                    </td>
                                                    <td class="${arrowColor}">
                                                        ${scoreDiff > 0 ? '+' : ''}${scoreDiff}
                                                    </td>
                                                </tr>
                                            `;
                                        });
                                        
                                        changesHTML += `
                                                    </tbody>
                                                </table>
                                            </div>
                                        `;
                                    } else {
                                        changesHTML = `
                                            <hr>
                                            <div class="alert alert-info mb-0">
                                                <i class="fas fa-info-circle me-2"></i>
                                                ëª¨ë“  ê³ ê°ì˜ ë“±ê¸‰ì´ ê¸°ì¡´ê³¼ ë™ì¼í•©ë‹ˆë‹¤.
                                            </div>
                                        `;
                                    }
                                    
                                    modalBody.innerHTML = `
                                        <div class="alert alert-success">
                                            <h5 class="alert-heading">
                                                <i class="fas fa-check-circle me-2"></i>ë“±ê¸‰ ì—…ë°ì´íŠ¸ ì™„ë£Œ
                                            </h5>
                                            <hr>
                                            <div class="row text-center mb-3">
                                                <div class="col-3">
                                                    <h3 class="mb-0 text-primary">${status.total}</h3>
                                                    <small class="text-muted">ì²˜ë¦¬ ëŒ€ìƒ</small>
                                                </div>
                                                <div class="col-3">
                                                    <h3 class="mb-0 text-success">${status.success}</h3>
                                                    <small class="text-muted">ì„±ê³µ</small>
                                                </div>
                                                <div class="col-3">
                                                    <h3 class="mb-0 text-warning">${status.grade_changes || 0}</h3>
                                                    <small class="text-muted">ë“±ê¸‰ ë³€ê²½</small>
                                                </div>
                                                <div class="col-3">
                                                    <h3 class="mb-0 text-danger">${status.failed || 0}</h3>
                                                    <small class="text-muted">ì‹¤íŒ¨</small>
                                                </div>
                                            </div>
                                            <hr>
                                            <p class="mb-2"><strong>ì†Œìš” ì‹œê°„:</strong> ${status.elapsed_time || 'ì•Œ ìˆ˜ ì—†ìŒ'}</p>
                                            ${changesHTML}
                                        </div>
                                        <div class="text-center">
                                            <button type="button" class="btn btn-primary" onclick="location.reload()">
                                                <i class="fas fa-sync-alt me-1"></i>í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                                            </button>
                                        </div>
                                    `;
                                } else if (status.status === 'failed') {
                                    // ì‹¤íŒ¨
                                    clearInterval(pollInterval);
                                    
                                    // ë‹«ê¸° ë²„íŠ¼ í™œì„±í™”
                                    if (closeBtn) closeBtn.disabled = false;
                                    if (closeFooterBtn) closeFooterBtn.disabled = false;
                                    
                                    modalBody.innerHTML = `
                                        <div class="alert alert-danger mb-0">
                                            <h5 class="alert-heading">
                                                <i class="fas fa-exclamation-circle me-2"></i>ì—…ë°ì´íŠ¸ ì‹¤íŒ¨
                                            </h5>
                                            <hr>
                                            <p class="mb-0">${status.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}</p>
                                        </div>
                                    `;
                                } else if (status.status === 'running') {
                                    // ì§„í–‰ ì¤‘ - ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                                    const progress = (status.processed / status.total) * 100;
                                    if (progressBar) {
                                        progressBar.style.width = progress + '%';
                                        progressBar.textContent = Math.round(progress) + '%';
                                    }
                                    if (statusText) {
                                        statusText.textContent = `${status.processed} / ${status.total} ì²˜ë¦¬ ì¤‘...`;
                                    }
                                }
                            }
                        })
                        .catch(error => {
                            console.error('Polling error:', error);
                        });
                    }, 2000);  // 2ì´ˆë§ˆë‹¤ í™•ì¸
                    
                } else {
                    // ì‘ì—… ì‹œì‘ ì‹¤íŒ¨
                    if (closeBtn) closeBtn.disabled = false;
                    if (closeFooterBtn) closeFooterBtn.disabled = false;
                    
                    modalBody.innerHTML = `
                        <div class="alert alert-danger mb-0">
                            <h5 class="alert-heading">
                                <i class="fas fa-exclamation-circle me-2"></i>ì˜¤ë¥˜ ë°œìƒ
                            </h5>
                            <hr>
                            <p class="mb-0">${data.error || 'ë“±ê¸‰ ì—…ë°ì´íŠ¸ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                
                // ë‹«ê¸° ë²„íŠ¼ í™œì„±í™”
                if (closeBtn) closeBtn.disabled = false;
                if (closeFooterBtn) closeFooterBtn.disabled = false;
                
                modalBody.innerHTML = `
                    <div class="alert alert-danger mb-0">
                        <h5 class="alert-heading">
                            <i class="fas fa-exclamation-circle me-2"></i>ìš”ì²­ ì‹¤íŒ¨
                        </h5>
                        <hr>
                        <p class="mb-0">ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</p>
                    </div>
                `;
            });
        });
    }
});
{% endif %}

// í”„ë¡œê·¸ë ˆìŠ¤ ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
let progressModal = null;

function showProgressModal(title, steps) {
    // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
    const existingModal = document.getElementById('progressModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    const modalHTML = `
        <div class="modal fade" id="progressModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content" style="border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                    <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                        <h5 class="modal-title">
                            <i class="fas fa-robot fa-spin"></i> ${title}
                        </h5>
                    </div>
                    <div class="modal-body" style="padding: 2rem;">
                        <div class="progress" style="height: 30px; border-radius: 15px; background-color: #e9ecef;">
                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" 
                                 style="width: 0%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); font-weight: 700; font-size: 0.9rem;"
                                 aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                        </div>
                        <div id="progressLog" class="mt-3" style="max-height: 200px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.85rem; background-color: #1a1a1a; color: #0f0; padding: 1rem; border-radius: 8px;">
                            ${steps.map(step => `<div style="opacity: 0.5;">â³ ${step}</div>`).join('')}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
    progressModal.show();
}

function updateProgress(percent, message) {
    const progressBar = document.getElementById('progressBar');
    const progressLog = document.getElementById('progressLog');
    
    if (progressBar) {
        progressBar.style.width = percent + '%';
        progressBar.setAttribute('aria-valuenow', percent);
        progressBar.textContent = percent + '%';
    }
    
    if (progressLog && message) {
        const timestamp = new Date().toLocaleTimeString('ko-KR');
        progressLog.innerHTML += `<div style="color: #0f0;">âœ“ [${timestamp}] ${message}</div>`;
        progressLog.scrollTop = progressLog.scrollHeight;
    }
}

function closeProgressModal() {
    if (progressModal) {
        progressModal.hide();
        progressModal = null;
    }
    const modalElement = document.getElementById('progressModal');
    if (modalElement) {
        modalElement.remove();
    }
    // backdrop ì œê±°
    document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
}

// ê´€ë¦¬ì ê¶Œí•œ í•„ìš” ì•Œë¦¼ í•¨ìˆ˜
function showAdminRequiredAlert() {
    alert('ì—‘ì…€ ë‹¤ìš´ë¡œë“œëŠ” ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.\nê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.');
}

// ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ê¶Œí•œ í•„ìš” ì•Œë¦¼ í•¨ìˆ˜
function showExcelPermissionAlert() {
    alert('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.\nê´€ë¦¬ìì—ê²Œ ê¶Œí•œì„ ìš”ì²­í•´ì£¼ì„¸ìš”.');
}
</script>

{% endblock %}
