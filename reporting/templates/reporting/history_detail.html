{% extends "reporting/base.html" %} {% block title %}히스토리 상세 - 영업 보고
시스템{% endblock %} {% block content %}
<div class="container">
  <div class="row">
    <div class="col-12">
      <!-- 헤더 섹션 -->
      <div
        class="page-header d-flex justify-content-between align-items-center mb-4"
      >
        <h1 class="page-title mb-0">
          <i class="fas fa-history me-2"></i>활동 기록 상세
        </h1>
        <div>
          {% if history.followup %}
          <a
            href="{% url 'reporting:followup_detail' history.followup.pk %}"
            class="btn btn-info me-2"
          >
            <i class="fas fa-user-tie me-1"></i>고객 상세
          </a>
          {% endif %}
          <a
            href="{% url 'reporting:history_list' %}{% if user_filter %}?user={{ user_filter }}{% endif %}"
            class="btn btn-secondary me-2"
          >
            <i class="fas fa-arrow-left me-1"></i>목록으로
          </a>
          {% if can_modify %}
            {% if history.action_type == 'memo' %}
              <!-- 메모인 경우 편집/삭제 버튼 -->
              <button
                id="edit-memo-btn"
                class="btn btn-outline-primary me-2"
                onclick="toggleEditMode()"
              >
                <i class="fas fa-edit me-1"></i>수정
              </button>
              <button
                id="save-memo-btn"
                class="btn btn-success me-2"
                style="display: none;"
                onclick="saveMemo()"
              >
                <i class="fas fa-save me-1"></i>저장
              </button>
              <button
                id="cancel-memo-btn"
                class="btn btn-outline-secondary me-2"
                style="display: none;"
                onclick="cancelEdit()"
              >
                <i class="fas fa-times me-1"></i>취소
              </button>
              <button
                class="btn btn-danger"
                onclick="deleteMemo()"
              >
                <i class="fas fa-trash me-1"></i>삭제
              </button>
            {% endif %}
          {% endif %}
        </div>
      </div>

      <!-- 히스토리 상세 정보 -->
      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
              <span
                class="badge {% if history.action_type == 'customer_meeting' %}bg-primary {% elif history.action_type == 'delivery_schedule' %}bg-success {% else %}bg-light text-dark {% endif %} me-2"
              >
                <i
                  class="fas {% if history.action_type == 'customer_meeting' %}fa-handshake {% elif history.action_type == 'delivery_schedule' %}fa-truck {% else %}fa-circle {% endif %} me-1"
                ></i>
                {{ history.get_action_type_display }}
              </span>
              {% if history.action_type == 'delivery_schedule' and history.delivery_amount is not None %}
              <span class="badge bg-success ms-2">
                {% load currency_filters %}
                <i class="fas fa-won-sign me-1"></i
                >{{history.delivery_amount|currency_format }}원
              </span>
              {% endif %}
              {% if history.action_type == 'service' and history.service_status %}
              <span class="badge 
                {% if history.service_status == 'completed' %}bg-success
                {% elif history.service_status == 'in_progress' %}bg-primary
                {% elif history.service_status == 'cancelled' %}bg-danger
                {% else %}bg-secondary{% endif %} ms-2">
                {{ history.get_service_status_display }}
              </span>
              {% endif %}
            </h5>
            <small class="text-muted">
              <i class="fas fa-clock me-1"></i>
              {{ history.created_at|date:"Y년 m월 d일 H:i" }}
            </small>
          </div>
        </div>

        <div class="card-body">
          <!-- 기본 정보 -->
          <div class="row mb-4">
            <div class="col-md-4">
              <h6 class="text-muted mb-2">
                <i class="fas fa-user me-1"></i>작성자
              </h6>
              <p class="mb-3">{{ history.user.username }}</p>
            </div>
            <div class="col-md-4">
              <h6 class="text-muted mb-2">
                <i class="fas fa-calendar me-1"></i>작성일시
              </h6>
              <p class="mb-3">
                {{ history.created_at|date:"Y년 m월 d일 H:i:s" }}
              </p>
            </div>
            {% if history.action_type == 'delivery_schedule' and history.delivery_amount is not None %}
            <div class="col-md-4">
              <h6 class="text-muted mb-2">
                <i class="fas fa-won-sign me-1"></i>납품 금액
              </h6>
              <p class="mb-3">
                {% load currency_filters %}
                <span class="badge bg-success fs-6"
                  >{{ history.delivery_amount|currency_format }}원</span
                >
              </p>
            </div>
            {% endif %} {% if history.action_type == 'delivery_schedule' and history.delivery_items %}
            <div class="col-md-4">
              <h6 class="text-muted mb-2">
                <i class="fas fa-boxes me-1"></i>납품 품목
              </h6>
              <p class="mb-3">{{ history.delivery_items }}</p>
            </div>
            {% endif %} {% if history.action_type == 'delivery_schedule' and history.delivery_date %}
            <div class="col-md-4">
              <h6 class="text-muted mb-2">
                <i class="fas fa-calendar-alt me-1"></i>납품 날짜
              </h6>
              <p class="mb-3">
                <span class="badge bg-info fs-6"
                  >{{ history.delivery_date|date:"Y년 m월 d일" }}</span
                >
              </p>
            </div>
            {% endif %} {% if history.action_type == 'customer_meeting' and history.meeting_date %}
            <div class="col-md-4">
              <h6 class="text-muted mb-2">
                <i class="fas fa-calendar-check me-1"></i>미팅 날짜
              </h6>
              <p class="mb-3">
                <span class="badge bg-warning fs-6"
                  >{{ history.meeting_date|date:"Y년 m월 d일" }}</span
                >
              </p>
            </div>
            {% endif %} {% if history.action_type == 'service' and history.service_status %}
            <div class="col-md-4">
              <h6 class="text-muted mb-2">
                <i class="fas fa-tasks me-1"></i>서비스 상태
              </h6>
              <p class="mb-3">
                <span class="badge 
                  {% if history.service_status == 'completed' %}bg-success
                  {% elif history.service_status == 'in_progress' %}bg-primary
                  {% elif history.service_status == 'cancelled' %}bg-danger
                  {% else %}bg-secondary{% endif %} fs-6">
                  {{ history.get_service_status_display }}
                </span>
              </p>
            </div>
            {% endif %}
          </div>

          <!-- 관련 연결 정보 -->
          {% if history.followup or history.schedule %}
          <div class="row mb-4">
            {% if history.followup %}
            <div class="col-md-6">
              <h6 class="text-muted mb-2">
                <i class="fas fa-user-tie me-1"></i>관련 고객 정보
              </h6>
              <div class="p-3 bg-light rounded">
                <p class="mb-2">
                  <strong
                    >{{ history.followup.customer_name|default:"고객명 미정"}}</strong
                  >
                </p>
                <p class="mb-2 text-muted small">
                  {{ history.followup.company|default:"업체명 미정" }}{% if history.followup.department %} - {{ history.followup.department }}{% endif %}
                </p>
                <a
                  href="{% url 'reporting:followup_detail' history.followup.pk %}"
                  class="btn btn-sm btn-outline-primary"
                >
                  <i class="fas fa-eye me-1"></i>고객 정보 보기
                </a>
              </div>
            </div>
            {% endif %} {% if history.schedule %}
            <div class="col-md-6">
              <h6 class="text-muted mb-2">
                <i class="fas fa-calendar me-1"></i>관련 일정
              </h6>
              <div class="p-3 bg-light rounded">
                <p class="mb-2">
                  <strong
                    >{{ history.schedule.followup.customer_name|default:"고객명 미정" }} 방문</strong
                  >
                </p>
                <p class="mb-1 text-muted small">
                  <i class="fas fa-calendar me-1"></i>
                  {{ history.schedule.visit_date|date:"Y년 m월 d일" }}
                </p>
                <p class="mb-1 text-muted small">
                  <i class="fas fa-clock me-1"></i>
                  {{ history.schedule.visit_time|date:"H:i" }}
                </p>
                {% if history.schedule.location %}
                <p class="mb-2 text-muted small">
                  <i class="fas fa-map-marker-alt me-1"></i>
                  {{ history.schedule.location }}
                </p>
                {% endif %}
                <a
                  href="{% url 'reporting:schedule_detail' history.schedule.pk %}"
                  class="btn btn-sm btn-outline-success"
                >
                  <i class="fas fa-eye me-1"></i>일정 보기
                </a>
              </div>
            </div>
            {% endif %}
          </div>
          {% endif %}

          <!-- 설명/내용 -->
          {% if history.content %}
          <div class="mb-4">
            <h6 class="text-muted mb-2">
              <i class="fas fa-file-text me-1"></i>상세 내용
            </h6>
            <div class="p-3 bg-light rounded">
              {% if not history.followup and history.action_type == 'memo' and user.is_authenticated and user == history.user and user.userprofile.role != 'manager' %}
                <!-- 팔로우업이 없는 메모의 경우 인라인 편집 가능 -->
                <div id="memo-display">
                  <p class="mb-0 whitespace-pre-line">{{ history.content }}</p>
                </div>
                <div id="memo-edit" style="display: none;">
                  <textarea id="memo-content" class="form-control" rows="6">{{ history.content }}</textarea>
                </div>
              {% else %}
                <!-- 일반 히스토리의 경우 읽기 전용 -->
                <p class="mb-0 whitespace-pre-line">{{ history.content }}</p>
              {% endif %}
            </div>
          </div>
          {% endif %}

          <!-- 첨부파일 -->
          <div class="mb-4">
            <h6 class="text-muted mb-2">
              <i class="fas fa-paperclip me-1"></i>첨부파일
            </h6>
            <div id="attached-files" class="p-3 border rounded bg-light">
              <div class="text-center text-muted">
                <i class="fas fa-spinner fa-spin me-2"></i>파일 목록을 불러오는 중...
              </div>
            </div>
          </div>

          <!-- 이전/다음 변경 사항 -->
          {% if history.old_value or history.new_value %}
          <div class="mb-4">
            <h6 class="text-muted mb-3">
              <i class="fas fa-exchange-alt me-1"></i>변경 사항
            </h6>
            <div class="row">
              {% if history.old_value %}
              <div class="col-md-6">
                <div class="p-3 border rounded bg-light">
                  <h6 class="text-danger mb-2">
                    <i class="fas fa-minus-circle me-1"></i>이전 값
                  </h6>
                  <p class="mb-0 font-monospace">{{ history.old_value }}</p>
                </div>
              </div>
              {% endif %} {% if history.new_value %}
              <div class="col-md-6">
                <div class="p-3 border rounded bg-light">
                  <h6 class="text-success mb-2">
                    <i class="fas fa-plus-circle me-1"></i>새로운 값
                  </h6>
                  <p class="mb-0 font-monospace">{{ history.new_value }}</p>
                </div>
              </div>
              {% endif %}
            </div>
          </div>
          {% endif %}
        </div>

        <div class="card-footer bg-white">
          <!-- 관련 히스토리 목록 (팔로우업이 있는 경우만 표시) -->
          {% if related_histories and history.followup %}
          <div class="related-histories mb-3">
            <h6 class="text-muted mb-2">
              <i class="fas fa-history me-1"></i>관련 활동 기록
            </h6>
            <div class="list-group list-group-flush" style="max-height: 300px; overflow-y: auto;">
              {% for related in related_histories %}
              <div class="list-group-item border-0 px-0 py-2 {% if related.id == history.id %}bg-light{% endif %}">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="flex-grow-1">
                    <h6 class="mb-1 {% if related.id == history.id %}text-primary{% endif %}">
                      {{ related.get_action_type_display }}
                      {% if related.created_by and related.created_by != related.user %}
                      <span class="badge bg-info ms-1">{{ related.created_by.username }}</span>
                      {% endif %}
                    </h6>
                    <p class="mb-1 text-muted small">{{ related.content|truncatechars:100 }}</p>
                    <small class="text-muted">{{ related.created_at|date:"m-d H:i" }}</small>
                  </div>
                  {% if related.id != history.id %}
                  <a href="{% url 'reporting:history_detail' related.id %}" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-eye"></i>
                  </a>
                  {% endif %}
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          <hr>
          {% endif %}

          <div class="text-center">
            <small class="text-muted">
              <i class="fas fa-info-circle me-1"></i>
              이 활동 기록은 {{ history.created_at|timesince }} 전에
              생성되었습니다.
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .whitespace-pre-line {
    white-space: pre-line;
  }
  
  #memo-content {
    resize: vertical;
    min-height: 120px;
  }
</style>

<script>
let originalContent = '';

function toggleEditMode() {
    const displayDiv = document.getElementById('memo-display');
    const editDiv = document.getElementById('memo-edit');
    const editBtn = document.getElementById('edit-memo-btn');
    const saveBtn = document.getElementById('save-memo-btn');
    const cancelBtn = document.getElementById('cancel-memo-btn');
    const textarea = document.getElementById('memo-content');
    
    // 현재 화면에 표시된 내용을 원본으로 저장 (수정된 내용 반영)
    const currentDisplayContent = document.querySelector('#memo-display p').textContent;
    textarea.value = currentDisplayContent;
    originalContent = currentDisplayContent;
    
    // UI 토글
    displayDiv.style.display = 'none';
    editDiv.style.display = 'block';
    editBtn.style.display = 'none';
    saveBtn.style.display = 'inline-block';
    cancelBtn.style.display = 'inline-block';
    
    // 텍스트영역에 포커스
    textarea.focus();
}

function cancelEdit() {
    const displayDiv = document.getElementById('memo-display');
    const editDiv = document.getElementById('memo-edit');
    const editBtn = document.getElementById('edit-memo-btn');
    const saveBtn = document.getElementById('save-memo-btn');
    const cancelBtn = document.getElementById('cancel-memo-btn');
    const textarea = document.getElementById('memo-content');
    
    // 원본 내용으로 복원
    textarea.value = originalContent;
    
    // UI 토글
    displayDiv.style.display = 'block';
    editDiv.style.display = 'none';
    editBtn.style.display = 'inline-block';
    saveBtn.style.display = 'none';
    cancelBtn.style.display = 'none';
}

function saveMemo() {
    const textarea = document.getElementById('memo-content');
    const newContent = textarea.value.trim();
    
    if (!newContent) {
        alert('내용을 입력해주세요.');
        return;
    }
    
    // 저장 버튼 비활성화
    const saveBtn = document.getElementById('save-memo-btn');
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>저장 중...';
    
    // AJAX 요청으로 서버에 업데이트
    fetch(`{% url 'reporting:history_update_memo' history.pk %}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            content: newContent
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 성공 시 화면 업데이트
            const displayP = document.querySelector('#memo-display p');
            displayP.textContent = newContent;
            
            // 편집 모드 종료
            cancelEdit();
            
            // 성공 메시지
            showSuccessMessage('메모가 성공적으로 수정되었습니다.');
        } else {
            throw new Error(data.error || '저장 중 오류가 발생했습니다.');
        }
    })
    .catch(error => {
        alert('저장 중 오류가 발생했습니다: ' + error.message);
    })
    .finally(() => {
        // 버튼 복원
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>저장';
    });
}

function showSuccessMessage(message) {
    // 간단한 성공 메시지 표시
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // 페이지 상단에 메시지 삽입
    const container = document.querySelector('.container');
    container.insertBefore(alertDiv, container.firstChild);
    
    // 3초 후 자동 제거
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 3000);
}

// 첨부파일 목록 로드
function loadAttachedFiles() {
    fetch('{% url "reporting:history_files_api" history.pk %}')
        .then(response => response.json())
        .then(data => {
            const filesList = document.getElementById('attached-files');
            if (data.success && data.files.length > 0) {
                let html = '';
                data.files.forEach(file => {
                    html += `
                        <div class="file-item d-flex justify-content-between align-items-center p-2 border rounded mb-2 bg-white">
                            <div class="file-info">
                                <a href="/reporting/files/${file.id}/download/" 
                                   class="text-decoration-none fw-bold">
                                    <i class="fas fa-file me-2"></i>${file.filename}
                                </a>
                                <small class="text-muted d-block">${file.size}</small>
                            </div>
                            {% if user.is_authenticated and user == history.user and user.userprofile.role != 'manager' %}
                            <button class="btn btn-sm btn-outline-danger" 
                                    onclick="deleteFile(${file.id})" 
                                    title="파일 삭제">
                                <i class="fas fa-trash"></i>
                            </button>
                            {% endif %}
                        </div>
                    `;
                });
                filesList.innerHTML = html;
            } else {
                filesList.innerHTML = '<div class="text-center text-muted p-3">첨부된 파일이 없습니다.</div>';
            }
        })
        .catch(error => {
            document.getElementById('attached-files').innerHTML = 
                '<div class="text-center text-danger p-3">파일 목록을 불러올 수 없습니다.</div>';
        });
}

// 파일 삭제
function deleteFile(fileId) {
    if (!confirm('이 파일을 삭제하시겠습니까?')) {
        return;
    }
    
    fetch(`/reporting/files/${fileId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadAttachedFiles(); // 파일 목록 새로고침
            showSuccessMessage('파일이 삭제되었습니다.');
        } else {
            alert('파일 삭제 실패: ' + data.error);
        }
    })
    .catch(error => {
        alert('파일 삭제 중 오류가 발생했습니다: ' + error.message);
    });
}

// 페이지 로드 시 첨부파일 목록 로드
document.addEventListener('DOMContentLoaded', function() {
    loadAttachedFiles();
    loadReplyMemos();
});

// 답글 메모 관련 함수들
function loadReplyMemos() {
    const memosList = document.getElementById('reply-memos-list');
    if (!memosList) return;
    
    // 서버에서 이미 렌더링된 메모들이 있으므로 이벤트 리스너만 등록
    setupReplyMemoEvents();
}

function setupReplyMemoEvents() {
    // 답글 메모 추가 폼 이벤트
    const memoForm = document.getElementById('add-reply-memo-form');
    if (memoForm) {
        memoForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const memoInput = document.getElementById('reply-memo-input');
            const memo = memoInput.value.trim();
            
            if (!memo) {
                alert('댓글 내용을 입력해주세요.');
                return;
            }
            
            addReplyMemo(memo, memoInput);
        });
    }
}

function addReplyMemo(memo, inputElement) {
    const historyId = {{ history.id }};
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    const formData = new FormData();
    formData.append('memo', memo);
    
    fetch(`{% url 'reporting:add_manager_memo_to_history_api' 999 %}`.replace('999', historyId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            inputElement.value = '';
            location.reload(); // 페이지 새로고침
        } else {
            alert('댓글 추가 실패: ' + (data.error || '알 수 없는 오류'));
        }
    })
    .catch(error => {
        alert('댓글 추가 중 오류가 발생했습니다: ' + error.message);
    });
}

function deleteReplyMemo(memoId) {
    if (!confirm('정말로 이 댓글을 삭제하시겠습니까?')) {
        return;
    }
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch(`{% url 'reporting:delete_manager_memo_api' 999 %}`.replace('999', memoId), {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // 페이지 새로고침
        } else {
            alert('댓글 삭제 실패: ' + (data.error || '알 수 없는 오류'));
        }
    })
    .catch(error => {
        alert('댓글 삭제 중 오류가 발생했습니다: ' + error.message);
    });
}

function deleteMemo() {
    if (!confirm('정말로 이 메모를 삭제하시겠습니까?')) {
        return;
    }
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch(`{% url 'reporting:history_delete' history.pk %}`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (response.ok) {
            alert('메모가 삭제되었습니다.');
            {% if history.followup %}
            window.location.href = '{% url "reporting:followup_detail" history.followup.pk %}';
            {% else %}
            window.location.href = '{% url "reporting:history_list" %}';
            {% endif %}
        } else {
            alert('메모 삭제에 실패했습니다.');
        }
    })
    .catch(error => {
        alert('메모 삭제 중 오류가 발생했습니다: ' + error.message);
    });
}
</script>

<!-- 답글 메모 섹션 -->
{% if history.reply_memos.exists or user.userprofile.role == 'manager' or history.user == user %}
<div class="card shadow-sm mt-4">
  <div class="card-header bg-light">
    <h5 class="card-title mb-0">
      <i class="fas fa-comments text-primary me-2"></i>댓글
      {% if history.reply_memos.exists %}
      <span class="badge bg-secondary">{{ history.reply_memos.count }}</span>
      {% endif %}
    </h5>
  </div>
  <div class="card-body">
    <!-- 기존 답글 메모들 -->
    <div id="reply-memos-list">
      {% for memo in history.reply_memos.all %}
      <div class="reply-memo-item border rounded p-3 mb-3">
        <div class="d-flex justify-content-between align-items-start">
          <div class="flex-grow-1">
            <div class="d-flex align-items-center mb-2">
              <strong class="{% if memo.is_manager_memo %}text-primary{% else %}text-success{% endif %}">
                <i class="fas {% if memo.is_manager_memo %}fa-user-tie{% else %}fa-user{% endif %} me-1"></i>
                {{ memo.get_memo_author.username }}
                {% if memo.is_manager_memo %}
                <span class="badge badge-sm bg-primary ms-1">매니저</span>
                {% endif %}
              </strong>
              <small class="text-muted ms-3">
                <i class="fas fa-clock me-1"></i>
                {{ memo.created_at|date:"Y년 m월 d일 H:i" }}
              </small>
            </div>
            <div class="memo-content">
              {{ memo.content|linebreaksbr }}
            </div>
          </div>
          {% comment %}본인이 작성한 댓글만 삭제 버튼 표시{% endcomment %}
          {% if memo.is_manager_memo and memo.created_by == user or not memo.is_manager_memo and memo.user == user %}
          <button 
            class="btn btn-sm btn-outline-danger ms-3"
            onclick="deleteReplyMemo({{ memo.id }})"
            title="메모 삭제">
            <i class="fas fa-trash"></i>
          </button>
          {% endif %}
        </div>
      </div>
      {% empty %}
      {% if user.userprofile.role == 'manager' or history.user == user %}
      <div class="text-muted text-center py-3">
        아직 댓글이 없습니다. 첫 번째 댓글을 추가해보세요.
      </div>
      {% endif %}
      {% endfor %}
    </div>
    
    <!-- 답글 메모 추가 폼 (매니저 및 해당 실무자) -->
    {% if user.userprofile.role == 'manager' or history.user == user %}
    <div class="add-reply-memo-section">
      {% if history.reply_memos.exists %}
      <hr class="my-4">
      {% endif %}
      <form id="add-reply-memo-form" class="reply-memo-form">
        <div class="mb-3">
          <label for="reply-memo-input" class="form-label fw-bold">
            <i class="fas fa-plus-circle me-1"></i>
            {% if user.userprofile.role == 'manager' %}새 매니저 메모 추가{% else %}새 댓글 추가{% endif %}
          </label>
          <textarea 
            id="reply-memo-input"
            class="form-control" 
            rows="3" 
            placeholder="{% if user.userprofile.role == 'manager' %}매니저 메모를 입력하세요...{% else %}댓글을 입력하세요...{% endif %}" 
            name="memo"></textarea>
        </div>
        <div class="text-end">
          <button type="submit" class="btn {% if user.userprofile.role == 'manager' %}btn-primary{% else %}btn-success{% endif %}">
            <i class="fas fa-save me-1"></i>
            {% if user.userprofile.role == 'manager' %}메모 저장{% else %}댓글 저장{% endif %}
          </button>
        </div>
      </form>
    </div>
    {% endif %}
  </div>
</div>
{% endif %}

<!-- CSRF 토큰 (AJAX 요청용) -->
{% csrf_token %}

{% endblock %}
