{% extends "reporting/base.html" %} {% block title %}íˆìŠ¤í† ë¦¬ ìƒì„¸ - ì˜ì—… ë³´ê³ 
ì‹œìŠ¤í…œ{% endblock %} 

{% block extra_css %}
<style>
/* ğŸŒ™ ë‹¤í¬ ëª¨ë“œ ìŠ¤íƒ€ì¼ */

/* í˜ì´ì§€ íƒ€ì´í‹€ */
.page-title {
  color: var(--text-primary) !important;
}

/* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
.card {
  background: var(--surface) !important;
  border-color: var(--border) !important;
}

.card-header {
  background: var(--surface-hover) !important;
  border-color: var(--border) !important;
}

.card-header.bg-white {
  background: var(--surface-hover) !important;
}

.card-header .card-title {
  color: var(--text-primary) !important;
}

.card-body {
  background: var(--surface) !important;
  color: var(--text-primary) !important;
}

/* ì •ë³´ ë°•ìŠ¤ */
.bg-light {
  background: var(--surface-hover) !important;
  color: var(--text-primary) !important;
}

.bg-light.rounded,
.p-3.bg-light.rounded {
  background: var(--surface-hover) !important;
  border-color: var(--border) !important;
}

.p-3.border.rounded.bg-light {
  background: var(--surface-hover) !important;
  border-color: var(--border) !important;
}

/* í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
h6.text-muted {
  color: var(--text-muted) !important;
}

p.text-muted,
.text-muted {
  color: var(--text-muted) !important;
}

p.mb-0,
p.mb-2,
p.mb-3 {
  color: var(--text-primary) !important;
}

strong {
  color: var(--text-primary) !important;
}

/* í¼ ì»¨íŠ¸ë¡¤ */
.form-control {
  background: var(--surface) !important;
  border-color: var(--border) !important;
  color: var(--text-primary) !important;
}

.form-control:focus {
  background: var(--surface) !important;
  border-color: var(--primary) !important;
  color: var(--text-primary) !important;
}

/* í…Œì´ë¸” */
.table {
  color: var(--text-primary) !important;
}

.table thead th {
  background: var(--surface-hover) !important;
  border-color: var(--border) !important;
  color: var(--text-primary) !important;
}

.table tbody td {
  background: var(--surface) !important;
  border-color: var(--border) !important;
  color: var(--text-primary) !important;
}

/* í…Œë‘ë¦¬ */
.border {
  border-color: var(--border) !important;
}

.border.rounded {
  border-color: var(--border) !important;
}

/* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
.btn-outline-primary {
  color: var(--primary) !important;
  border-color: var(--primary) !important;
}

.btn-outline-secondary {
  color: var(--text-secondary) !important;
  border-color: var(--border) !important;
}

.btn-outline-secondary:hover {
  background: var(--surface-hover) !important;
  color: var(--text-primary) !important;
}

/* ë°°ì§€ ìŠ¤íƒ€ì¼ - bg-light text-dark ìˆ˜ì • */
.badge.bg-light.text-dark {
  background: var(--surface-hover) !important;
  color: var(--text-primary) !important;
}

/* whitespace ìŠ¤íƒ€ì¼ */
.whitespace-pre-line {
  white-space: pre-line;
}

/* ì²¨ë¶€íŒŒì¼ ì˜ì—­ */
#attached-files {
  background: var(--surface-hover) !important;
  border-color: var(--border) !important;
  color: var(--text-primary) !important;
}

/* font-monospace */
.font-monospace {
  color: var(--text-primary) !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container">
  <div class="row">
    <div class="col-12">
      <!-- í—¤ë” ì„¹ì…˜ -->
      <div
        class="page-header d-flex justify-content-between align-items-center mb-4"
      >
        <h1 class="page-title mb-0">
          <i class="fas fa-history me-2"></i>í™œë™ ê¸°ë¡ ìƒì„¸
          {% if not is_owner %}
          <span class="badge bg-warning text-dark ms-2" style="font-size: 0.5em; vertical-align: middle;">
            <i class="fas fa-eye me-1"></i>{{ history.user.username }} ë°ì´í„° (ì¡°íšŒ ì „ìš©)
          </span>
          {% endif %}
        </h1>
        <div>
          {% if history.followup %}
          <a
            href="{% url 'reporting:followup_detail' history.followup.pk %}"
            class="btn btn-info me-2"
          >
            <i class="fas fa-user-tie me-1"></i>ê³ ê° ìƒì„¸
          </a>
          {% endif %}
          <a
            href="{% url 'reporting:history_list' %}{% if user_filter %}?user={{ user_filter }}{% endif %}"
            class="btn btn-secondary me-2"
          >
            <i class="fas fa-arrow-left me-1"></i>ëª©ë¡ìœ¼ë¡œ
          </a>
          {% if can_modify %}
            {% if history.action_type == 'memo' %}
              <!-- ë©”ëª¨ì¸ ê²½ìš° í¸ì§‘/ì‚­ì œ ë²„íŠ¼ -->
              <button
                id="edit-memo-btn"
                class="btn btn-outline-primary me-2"
                onclick="toggleEditMode()"
              >
                <i class="fas fa-edit me-1"></i>ìˆ˜ì •
              </button>
              <button
                id="save-memo-btn"
                class="btn btn-success me-2"
                style="display: none;"
                onclick="saveMemo()"
              >
                <i class="fas fa-save me-1"></i>ì €ì¥
              </button>
              <button
                id="cancel-memo-btn"
                class="btn btn-outline-secondary me-2"
                style="display: none;"
                onclick="cancelEdit()"
              >
                <i class="fas fa-times me-1"></i>ì·¨ì†Œ
              </button>
              <button
                class="btn btn-danger"
                onclick="deleteMemo()"
              >
                <i class="fas fa-trash me-1"></i>ì‚­ì œ
              </button>
            {% endif %}
          {% endif %}
        </div>
      </div>

      <!-- íˆìŠ¤í† ë¦¬ ìƒì„¸ ì •ë³´ -->
      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
              <span
                class="badge {% if history.action_type == 'customer_meeting' %}bg-primary {% elif history.action_type == 'delivery_schedule' %}bg-success {% else %}bg-light text-dark {% endif %} me-2"
              >
                <i
                  class="fas {% if history.action_type == 'customer_meeting' %}fa-handshake {% elif history.action_type == 'delivery_schedule' %}fa-truck {% else %}fa-circle {% endif %} me-1"
                ></i>
                {{ history.get_action_type_display }}
              </span>
              {% if history.action_type == 'delivery_schedule' and history.delivery_amount is not None %}
              <span class="badge bg-success ms-2">
                {% load currency_filters %}
                <i class="fas fa-won-sign me-1"></i
                >{{history.delivery_amount|currency_format }}ì›
              </span>
              {% endif %}
              {% if history.action_type == 'service' and history.service_status %}
              <span class="badge 
                {% if history.service_status == 'completed' %}bg-success
                {% elif history.service_status == 'in_progress' %}bg-primary
                {% elif history.service_status == 'cancelled' %}bg-danger
                {% else %}bg-secondary{% endif %} ms-2">
                {{ history.get_service_status_display }}
              </span>
              {% endif %}
            </h5>
            <small class="text-muted">
              <i class="fas fa-clock me-1"></i>
              {{ history.created_at|date:"Yë…„ mì›” dì¼ H:i" }}
            </small>
          </div>
        </div>

        <div class="card-body">
          <!-- ê¸°ë³¸ ì •ë³´ -->
          <div class="row mb-4">
            <div class="col-md-4">
              <h6 class="text-muted mb-2">
                <i class="fas fa-user me-1"></i>ì‘ì„±ì
              </h6>
              <p class="mb-3">{{ history.user.username }}</p>
            </div>
            <div class="col-md-4">
              <h6 class="text-muted mb-2">
                <i class="fas fa-calendar me-1"></i>ì‘ì„±ì¼ì‹œ
              </h6>
              <p class="mb-3">
                {{ history.created_at|date:"Yë…„ mì›” dì¼ H:i:s" }}
              </p>
            </div>
            {% if history.action_type == 'delivery_schedule' and history.delivery_amount is not None %}
            <div class="col-md-4">
              <h6 class="text-muted mb-2">
                <i class="fas fa-won-sign me-1"></i>ë‚©í’ˆ ê¸ˆì•¡
              </h6>
              <p class="mb-3">
                {% load currency_filters %}
                <span class="badge bg-success fs-6"
                  >{{ history.delivery_amount|currency_format }}ì›</span
                >
              </p>
            </div>
            {% endif %} {% if history.action_type == 'delivery_schedule' and history.delivery_items %}
            <div class="col-md-4">
              <h6 class="text-muted mb-2">
                <i class="fas fa-boxes me-1"></i>ë‚©í’ˆ í’ˆëª©
              </h6>
              <p class="mb-3">{{ history.delivery_items }}</p>
            </div>
            {% endif %} {% if history.action_type == 'delivery_schedule' and history.delivery_date %}
            <div class="col-md-4">
              <h6 class="text-muted mb-2">
                <i class="fas fa-calendar-alt me-1"></i>ë‚©í’ˆ ë‚ ì§œ
              </h6>
              <p class="mb-3">
                <span class="badge bg-info fs-6"
                  >{{ history.delivery_date|date:"Yë…„ mì›” dì¼" }}</span
                >
              </p>
            </div>
            {% endif %} {% if history.action_type == 'customer_meeting' and history.meeting_date %}
            <div class="col-md-4">
              <h6 class="text-muted mb-2">
                <i class="fas fa-calendar-check me-1"></i>ë¯¸íŒ… ë‚ ì§œ
              </h6>
              <p class="mb-3">
                <span class="badge bg-warning fs-6"
                  >{{ history.meeting_date|date:"Yë…„ mì›” dì¼" }}</span
                >
              </p>
            </div>
            {% endif %} {% if history.action_type == 'service' and history.service_status %}
            <div class="col-md-4">
              <h6 class="text-muted mb-2">
                <i class="fas fa-tasks me-1"></i>ì„œë¹„ìŠ¤ ìƒíƒœ
              </h6>
              <p class="mb-3">
                <span class="badge 
                  {% if history.service_status == 'completed' %}bg-success
                  {% elif history.service_status == 'in_progress' %}bg-primary
                  {% elif history.service_status == 'cancelled' %}bg-danger
                  {% else %}bg-secondary{% endif %} fs-6">
                  {{ history.get_service_status_display }}
                </span>
              </p>
            </div>
            {% endif %}
          </div>

          <!-- ê´€ë ¨ ì—°ê²° ì •ë³´ -->
          {% if history.followup or history.schedule %}
          <div class="row mb-4">
            {% if history.followup %}
            <div class="col-md-6">
              <h6 class="text-muted mb-2">
                <i class="fas fa-user-tie me-1"></i>ê´€ë ¨ ê³ ê° ì •ë³´
              </h6>
              <div class="p-3 bg-light rounded">
                <p class="mb-2">
                  <strong
                    >{{ history.followup.customer_name|default:"ê³ ê°ëª… ë¯¸ì •"}}</strong
                  >
                </p>
                <p class="mb-2 text-muted small">
                  {{ history.followup.company|default:"ì—…ì²´ëª… ë¯¸ì •" }}{% if history.followup.department %} - {{ history.followup.department }}{% endif %}
                </p>
                <a
                  href="{% url 'reporting:followup_detail' history.followup.pk %}"
                  class="btn btn-sm btn-outline-primary"
                >
                  <i class="fas fa-eye me-1"></i>ê³ ê° ì •ë³´ ë³´ê¸°
                </a>
              </div>
            </div>
            {% endif %} {% if history.schedule %}
            <div class="col-md-6">
              <h6 class="text-muted mb-2">
                <i class="fas fa-calendar me-1"></i>ê´€ë ¨ ì¼ì •
              </h6>
              <div class="p-3 bg-light rounded">
                <p class="mb-2">
                  <strong
                    >{{ history.schedule.followup.customer_name|default:"ê³ ê°ëª… ë¯¸ì •" }} ë°©ë¬¸</strong
                  >
                </p>
                <p class="mb-1 text-muted small">
                  <i class="fas fa-calendar me-1"></i>
                  {{ history.schedule.visit_date|date:"Yë…„ mì›” dì¼" }}
                </p>
                <p class="mb-1 text-muted small">
                  <i class="fas fa-clock me-1"></i>
                  {{ history.schedule.visit_time|date:"H:i" }}
                </p>
                {% if history.schedule.location %}
                <p class="mb-2 text-muted small">
                  <i class="fas fa-map-marker-alt me-1"></i>
                  {{ history.schedule.location }}
                </p>
                {% endif %}
                <a
                  href="{% url 'reporting:schedule_detail' history.schedule.pk %}"
                  class="btn btn-sm btn-outline-success"
                >
                  <i class="fas fa-eye me-1"></i>ì¼ì • ë³´ê¸°
                </a>
              </div>
            </div>
            {% endif %}
          </div>
          {% endif %}

          <!-- ì„¤ëª…/ë‚´ìš© -->
          {% if history.content %}
          <div class="mb-4">
            <h6 class="text-muted mb-2">
              <i class="fas fa-file-text me-1"></i>ìƒì„¸ ë‚´ìš©
            </h6>
            <div class="p-3 bg-light rounded">
              {% if not history.followup and history.action_type == 'memo' and user.is_authenticated and user == history.user and user.userprofile.role != 'manager' %}
                <!-- íŒ”ë¡œìš°ì—…ì´ ì—†ëŠ” ë©”ëª¨ì˜ ê²½ìš° ì¸ë¼ì¸ í¸ì§‘ ê°€ëŠ¥ -->
                <div id="memo-display">
                  <p class="mb-0 whitespace-pre-line">{{ history.content }}</p>
                </div>
                <div id="memo-edit" style="display: none;">
                  <textarea id="memo-content" class="form-control" rows="6">{{ history.content }}</textarea>
                </div>
              {% else %}
                <!-- ì¼ë°˜ íˆìŠ¤í† ë¦¬ì˜ ê²½ìš° ì½ê¸° ì „ìš© -->
                <p class="mb-0 whitespace-pre-line">{{ history.content }}</p>
              {% endif %}
            </div>
          </div>
          {% endif %}

          <!-- ì²¨ë¶€íŒŒì¼ -->
          <div class="mb-4">
            <h6 class="text-muted mb-2">
              <i class="fas fa-paperclip me-1"></i>ì²¨ë¶€íŒŒì¼
            </h6>
            <div id="attached-files" class="p-3 border rounded bg-light">
              <div class="text-center text-muted">
                <i class="fas fa-spinner fa-spin me-2"></i>íŒŒì¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
              </div>
            </div>
          </div>

          <!-- ì´ì „/ë‹¤ìŒ ë³€ê²½ ì‚¬í•­ -->
          {% if history.old_value or history.new_value %}
          <div class="mb-4">
            <h6 class="text-muted mb-3">
              <i class="fas fa-exchange-alt me-1"></i>ë³€ê²½ ì‚¬í•­
            </h6>
            <div class="row">
              {% if history.old_value %}
              <div class="col-md-6">
                <div class="p-3 border rounded bg-light">
                  <h6 class="text-danger mb-2">
                    <i class="fas fa-minus-circle me-1"></i>ì´ì „ ê°’
                  </h6>
                  <p class="mb-0 font-monospace">{{ history.old_value }}</p>
                </div>
              </div>
              {% endif %} {% if history.new_value %}
              <div class="col-md-6">
                <div class="p-3 border rounded bg-light">
                  <h6 class="text-success mb-2">
                    <i class="fas fa-plus-circle me-1"></i>ìƒˆë¡œìš´ ê°’
                  </h6>
                  <p class="mb-0 font-monospace">{{ history.new_value }}</p>
                </div>
              </div>
              {% endif %}
            </div>
          </div>
          {% endif %}
        </div>

        <div class="card-footer bg-white">
          <!-- ê´€ë ¨ íˆìŠ¤í† ë¦¬ ëª©ë¡ (íŒ”ë¡œìš°ì—…ì´ ìˆëŠ” ê²½ìš°ë§Œ í‘œì‹œ) -->
          {% if related_histories and history.followup %}
          <div class="related-histories mb-3">
            <h6 class="text-muted mb-2">
              <i class="fas fa-history me-1"></i>ê´€ë ¨ í™œë™ ê¸°ë¡
            </h6>
            <div class="list-group list-group-flush" style="max-height: 300px; overflow-y: auto;">
              {% for related in related_histories %}
              <div class="list-group-item border-0 px-0 py-2 {% if related.id == history.id %}bg-light{% endif %}">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="flex-grow-1">
                    <h6 class="mb-1 {% if related.id == history.id %}text-primary{% endif %}">
                      {{ related.get_action_type_display }}
                      {% if related.created_by and related.created_by != related.user %}
                      <span class="badge bg-info ms-1">{{ related.created_by.username }}</span>
                      {% endif %}
                    </h6>
                    <p class="mb-1 text-muted small">{{ related.content|truncatechars:100 }}</p>
                    <small class="text-muted">{{ related.created_at|date:"m-d H:i" }}</small>
                  </div>
                  {% if related.id != history.id %}
                  <a href="{% url 'reporting:history_detail' related.id %}" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-eye"></i>
                  </a>
                  {% endif %}
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          <hr>
          {% endif %}

          <div class="text-center">
            <small class="text-muted">
              <i class="fas fa-info-circle me-1"></i>
              ì´ í™œë™ ê¸°ë¡ì€ {{ history.created_at|timesince }} ì „ì—
              ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .whitespace-pre-line {
    white-space: pre-line;
  }
  
  #memo-content {
    resize: vertical;
    min-height: 120px;
  }
</style>

<script>
let originalContent = '';

function toggleEditMode() {
    const displayDiv = document.getElementById('memo-display');
    const editDiv = document.getElementById('memo-edit');
    const editBtn = document.getElementById('edit-memo-btn');
    const saveBtn = document.getElementById('save-memo-btn');
    const cancelBtn = document.getElementById('cancel-memo-btn');
    const textarea = document.getElementById('memo-content');
    
    // í˜„ì¬ í™”ë©´ì— í‘œì‹œëœ ë‚´ìš©ì„ ì›ë³¸ìœ¼ë¡œ ì €ì¥ (ìˆ˜ì •ëœ ë‚´ìš© ë°˜ì˜)
    const currentDisplayContent = document.querySelector('#memo-display p').textContent;
    textarea.value = currentDisplayContent;
    originalContent = currentDisplayContent;
    
    // UI í† ê¸€
    displayDiv.style.display = 'none';
    editDiv.style.display = 'block';
    editBtn.style.display = 'none';
    saveBtn.style.display = 'inline-block';
    cancelBtn.style.display = 'inline-block';
    
    // í…ìŠ¤íŠ¸ì˜ì—­ì— í¬ì»¤ìŠ¤
    textarea.focus();
}

function cancelEdit() {
    const displayDiv = document.getElementById('memo-display');
    const editDiv = document.getElementById('memo-edit');
    const editBtn = document.getElementById('edit-memo-btn');
    const saveBtn = document.getElementById('save-memo-btn');
    const cancelBtn = document.getElementById('cancel-memo-btn');
    const textarea = document.getElementById('memo-content');
    
    // ì›ë³¸ ë‚´ìš©ìœ¼ë¡œ ë³µì›
    textarea.value = originalContent;
    
    // UI í† ê¸€
    displayDiv.style.display = 'block';
    editDiv.style.display = 'none';
    editBtn.style.display = 'inline-block';
    saveBtn.style.display = 'none';
    cancelBtn.style.display = 'none';
}

function saveMemo() {
    const textarea = document.getElementById('memo-content');
    const newContent = textarea.value.trim();
    
    if (!newContent) {
        alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    // ì €ì¥ ë²„íŠ¼ ë¹„í™œì„±í™”
    const saveBtn = document.getElementById('save-memo-btn');
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ì €ì¥ ì¤‘...';
    
    // AJAX ìš”ì²­ìœ¼ë¡œ ì„œë²„ì— ì—…ë°ì´íŠ¸
    fetch(`{% url 'reporting:history_update_memo' history.pk %}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            content: newContent
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ì„±ê³µ ì‹œ í™”ë©´ ì—…ë°ì´íŠ¸
            const displayP = document.querySelector('#memo-display p');
            displayP.textContent = newContent;
            
            // í¸ì§‘ ëª¨ë“œ ì¢…ë£Œ
            cancelEdit();
            
            // ì„±ê³µ ë©”ì‹œì§€
            showSuccessMessage('ë©”ëª¨ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
            throw new Error(data.error || 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    })
    .catch(error => {
        alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    })
    .finally(() => {
        // ë²„íŠ¼ ë³µì›
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>ì €ì¥';
    });
}

function showSuccessMessage(message) {
    // ê°„ë‹¨í•œ ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // í˜ì´ì§€ ìƒë‹¨ì— ë©”ì‹œì§€ ì‚½ì…
    const container = document.querySelector('.container');
    container.insertBefore(alertDiv, container.firstChild);
    
    // 3ì´ˆ í›„ ìë™ ì œê±°
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 3000);
}

// ì²¨ë¶€íŒŒì¼ ëª©ë¡ ë¡œë“œ
function loadAttachedFiles() {
    fetch('{% url "reporting:history_files_api" history.pk %}')
        .then(response => response.json())
        .then(data => {
            const filesList = document.getElementById('attached-files');
            if (data.success && data.files.length > 0) {
                let html = '';
                data.files.forEach(file => {
                    html += `
                        <div class="file-item d-flex justify-content-between align-items-center p-2 border rounded mb-2 bg-white">
                            <div class="file-info">
                                <a href="/reporting/files/${file.id}/download/" 
                                   class="text-decoration-none fw-bold">
                                    <i class="fas fa-file me-2"></i>${file.filename}
                                </a>
                                <small class="text-muted d-block">${file.size}</small>
                            </div>
                            {% if user.is_authenticated and user == history.user and user.userprofile.role != 'manager' %}
                            <button class="btn btn-sm btn-outline-danger" 
                                    onclick="deleteFile(${file.id})" 
                                    title="íŒŒì¼ ì‚­ì œ">
                                <i class="fas fa-trash"></i>
                            </button>
                            {% endif %}
                        </div>
                    `;
                });
                filesList.innerHTML = html;
            } else {
                filesList.innerHTML = '<div class="text-center text-muted p-3">ì²¨ë¶€ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        })
        .catch(error => {
            document.getElementById('attached-files').innerHTML = 
                '<div class="text-center text-danger p-3">íŒŒì¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
        });
}

// íŒŒì¼ ì‚­ì œ
function deleteFile(fileId) {
    if (!confirm('ì´ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }
    
    fetch(`/reporting/files/${fileId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadAttachedFiles(); // íŒŒì¼ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            showSuccessMessage('íŒŒì¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
            alert('íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨: ' + data.error);
        }
    })
    .catch(error => {
        alert('íŒŒì¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    });
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì²¨ë¶€íŒŒì¼ ëª©ë¡ ë¡œë“œ
document.addEventListener('DOMContentLoaded', function() {
    loadAttachedFiles();
    loadReplyMemos();
});

// ë‹µê¸€ ë©”ëª¨ ê´€ë ¨ í•¨ìˆ˜ë“¤
function loadReplyMemos() {
    const memosList = document.getElementById('reply-memos-list');
    if (!memosList) return;
    
    // ì„œë²„ì—ì„œ ì´ë¯¸ ë Œë”ë§ëœ ë©”ëª¨ë“¤ì´ ìˆìœ¼ë¯€ë¡œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë§Œ ë“±ë¡
    setupReplyMemoEvents();
}

function setupReplyMemoEvents() {
    // ë‹µê¸€ ë©”ëª¨ ì¶”ê°€ í¼ ì´ë²¤íŠ¸
    const memoForm = document.getElementById('add-reply-memo-form');
    if (memoForm) {
        memoForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const memoInput = document.getElementById('reply-memo-input');
            const memo = memoInput.value.trim();
            
            if (!memo) {
                alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            addReplyMemo(memo, memoInput);
        });
    }
}

function addReplyMemo(memo, inputElement) {
    const historyId = {{ history.id }};
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    const formData = new FormData();
    formData.append('memo', memo);
    
    fetch(`{% url 'reporting:add_manager_memo_to_history_api' 999 %}`.replace('999', historyId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            inputElement.value = '';
            location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
        } else {
            alert('ëŒ“ê¸€ ì¶”ê°€ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
    })
    .catch(error => {
        alert('ëŒ“ê¸€ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    });
}

function deleteReplyMemo(memoId) {
    if (!confirm('ì •ë§ë¡œ ì´ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch(`{% url 'reporting:delete_manager_memo_api' 999 %}`.replace('999', memoId), {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
        } else {
            alert('ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
    })
    .catch(error => {
        alert('ëŒ“ê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    });
}

function deleteMemo() {
    if (!confirm('ì •ë§ë¡œ ì´ ë©”ëª¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch(`{% url 'reporting:history_delete' history.pk %}`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (response.ok) {
            alert('ë©”ëª¨ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            {% if history.followup %}
            window.location.href = '{% url "reporting:followup_detail" history.followup.pk %}';
            {% else %}
            window.location.href = '{% url "reporting:history_list" %}';
            {% endif %}
        } else {
            alert('ë©”ëª¨ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    })
    .catch(error => {
        alert('ë©”ëª¨ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    });
}
</script>

<!-- ë‹µê¸€ ë©”ëª¨ ì„¹ì…˜ -->
{% if history.reply_memos.exists or user.userprofile.role == 'manager' or history.user == user %}
<div class="card shadow-sm mt-4">
  <div class="card-header bg-light">
    <h5 class="card-title mb-0">
      <i class="fas fa-comments text-primary me-2"></i>ëŒ“ê¸€
      {% if history.reply_memos.exists %}
      <span class="badge bg-secondary">{{ history.reply_memos.count }}</span>
      {% endif %}
    </h5>
  </div>
  <div class="card-body">
    <!-- ê¸°ì¡´ ë‹µê¸€ ë©”ëª¨ë“¤ -->
    <div id="reply-memos-list">
      {% for memo in history.reply_memos.all %}
      <div class="reply-memo-item border rounded p-3 mb-3">
        <div class="d-flex justify-content-between align-items-start">
          <div class="flex-grow-1">
            <div class="d-flex align-items-center mb-2">
              <strong class="{% if memo.is_manager_memo %}text-primary{% else %}text-success{% endif %}">
                <i class="fas {% if memo.is_manager_memo %}fa-user-tie{% else %}fa-user{% endif %} me-1"></i>
                {{ memo.get_memo_author.username }}
                {% if memo.is_manager_memo %}
                <span class="badge badge-sm bg-primary ms-1">ë§¤ë‹ˆì €</span>
                {% endif %}
              </strong>
              <small class="text-muted ms-3">
                <i class="fas fa-clock me-1"></i>
                {{ memo.created_at|date:"Yë…„ mì›” dì¼ H:i" }}
              </small>
            </div>
            <div class="memo-content">
              {{ memo.content|linebreaksbr }}
            </div>
          </div>
          {% comment %}ë³¸ì¸ì´ ì‘ì„±í•œ ëŒ“ê¸€ë§Œ ì‚­ì œ ë²„íŠ¼ í‘œì‹œ{% endcomment %}
          {% if memo.is_manager_memo and memo.created_by == user or not memo.is_manager_memo and memo.user == user %}
          <button 
            class="btn btn-sm btn-outline-danger ms-3"
            onclick="deleteReplyMemo({{ memo.id }})"
            title="ë©”ëª¨ ì‚­ì œ">
            <i class="fas fa-trash"></i>
          </button>
          {% endif %}
        </div>
      </div>
      {% empty %}
      {% if user.userprofile.role == 'manager' or history.user == user %}
      <div class="text-muted text-center py-3">
        ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ ëŒ“ê¸€ì„ ì¶”ê°€í•´ë³´ì„¸ìš”.
      </div>
      {% endif %}
      {% endfor %}
    </div>
    
    <!-- ë‹µê¸€ ë©”ëª¨ ì¶”ê°€ í¼ (ë§¤ë‹ˆì € ë° í•´ë‹¹ ì‹¤ë¬´ì) -->
    {% if user.userprofile.role == 'manager' or history.user == user %}
    <div class="add-reply-memo-section">
      {% if history.reply_memos.exists %}
      <hr class="my-4">
      {% endif %}
      <form id="add-reply-memo-form" class="reply-memo-form">
        <div class="mb-3">
          <label for="reply-memo-input" class="form-label fw-bold">
            <i class="fas fa-plus-circle me-1"></i>
            {% if user.userprofile.role == 'manager' %}ìƒˆ ë§¤ë‹ˆì € ë©”ëª¨ ì¶”ê°€{% else %}ìƒˆ ëŒ“ê¸€ ì¶”ê°€{% endif %}
          </label>
          <textarea 
            id="reply-memo-input"
            class="form-control" 
            rows="3" 
            placeholder="{% if user.userprofile.role == 'manager' %}ë§¤ë‹ˆì € ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”...{% else %}ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”...{% endif %}" 
            name="memo"></textarea>
        </div>
        <div class="text-end">
          <button type="submit" class="btn {% if user.userprofile.role == 'manager' %}btn-primary{% else %}btn-success{% endif %}">
            <i class="fas fa-save me-1"></i>
            {% if user.userprofile.role == 'manager' %}ë©”ëª¨ ì €ì¥{% else %}ëŒ“ê¸€ ì €ì¥{% endif %}
          </button>
        </div>
      </form>
    </div>
    {% endif %}
  </div>
</div>
{% endif %}

<!-- CSRF í† í° (AJAX ìš”ì²­ìš©) -->
{% csrf_token %}

{% endblock %}
