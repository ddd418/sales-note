{% extends 'reporting/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}{% if product %}ì œí’ˆ ìˆ˜ì •{% else %}ì œí’ˆ ë“±ë¡{% endif %}{% endblock %}

{% block extra_css %}
<style>
    /* ì—‘ì…€ ë¶™ì—¬ë„£ê¸° ì˜ì—­ ìŠ¤íƒ€ì¼ */
    #excelPasteArea {
        min-height: 200px;
        font-family: 'Courier New', monospace;
        resize: vertical;
    }
    
    .paste-section {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .preview-table {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .preview-table table {
        font-size: 0.9rem;
    }
    
    /* ëª¨ë°”ì¼ ë° íƒœë¸”ë¦¿ ë°˜ì‘í˜• (1200px ì´í•˜) */
    @media (max-width: 1200px) {
        .container {
            padding-top: 1.5rem;
        }
        
        .col-md-8 {
            max-width: 100%;
            flex: 0 0 100%;
        }
        
        .card-header h4 {
            font-size: 1.25rem;
        }
        
        .card-body {
            padding: 1rem;
        }
        
        h5 {
            font-size: 1.1rem;
        }
        
        .form-label {
            font-size: 0.9rem;
        }
        
        .form-control,
        .form-select {
            font-size: 0.9rem;
        }
        
        .row.mb-3 .col-md-4 {
            margin-bottom: 0.75rem;
        }
        
        .d-flex.justify-content-between {
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .d-flex.justify-content-between .btn {
            width: 100%;
        }
        
        .text-center .col-md-6 {
            margin-bottom: 1rem;
        }
    }
    
    /* ì†Œí˜• ëª¨ë°”ì¼ (480px ì´í•˜) */
    @media (max-width: 480px) {
        .container {
            padding: 1rem 0.5rem;
        }
        
        .card-header h4 {
            font-size: 1.1rem;
        }
        
        .card-body {
            padding: 0.75rem;
        }
        
        h5 {
            font-size: 1rem;
        }
        
        .form-label {
            font-size: 0.85rem;
        }
        
        .btn {
            font-size: 0.875rem;
            padding: 0.5rem 0.75rem;
        }
        
        small,
        .text-muted {
            font-size: 0.75rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-box"></i>
                        {% if product %}ì œí’ˆ ìˆ˜ì •{% else %}ì‹ ê·œ ì œí’ˆ ë“±ë¡{% endif %}
                    </h4>
                </div>
                <div class="card-body">
                    <!-- ì—‘ì…€ ë¶™ì—¬ë„£ê¸° ì„¹ì…˜ (ì‹ ê·œ ë“±ë¡ ì‹œì—ë§Œ í‘œì‹œ) -->
                    {% if not product %}
                    <div class="paste-section">
                        <h5 class="mb-3">
                            <i class="fas fa-file-excel text-success"></i>
                            ì—‘ì…€ì—ì„œ ì¼ê´„ ë“±ë¡
                        </h5>
                        <p class="text-muted mb-3">
                            ì—‘ì…€ì—ì„œ <strong>í’ˆëª©ì½”ë“œ / í’ˆëª©ëª… / ê·œê²© / ë‹¨ìœ„ / ì¶œê³ ë‹¨ê°€</strong> í˜•ì‹ìœ¼ë¡œ ë³µì‚¬í•˜ì—¬ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”. (íƒ­ ë˜ëŠ” ê³µë°±ìœ¼ë¡œ êµ¬ë¶„)
                        </p>
                        <div class="mb-3">
                            <label class="form-label">ì—‘ì…€ ë°ì´í„° ë¶™ì—¬ë„£ê¸°</label>
                            <textarea id="excelPasteArea" class="form-control" rows="8" 
                                      placeholder="ì˜ˆ:
PROD-001    ì œí’ˆëª…1    ê·œê²©1    EA    10000
PROD-002    ì œí’ˆëª…2    ê·œê²©2    SET   20000
PROD-003    ì œí’ˆëª…3    ê·œê²©3    BOX   30000"></textarea>
                            <small class="text-muted">
                                ê° í–‰ì€ ì—”í„°ë¡œ êµ¬ë¶„í•˜ê³ , í’ˆëª©ì½”ë“œ/í’ˆëª©ëª…/ê·œê²©/ë‹¨ìœ„/ì¶œê³ ë‹¨ê°€ëŠ” íƒ­ìœ¼ë¡œ êµ¬ë¶„í•©ë‹ˆë‹¤.
                            </small>
                        </div>
                        <button type="button" class="btn btn-success" onclick="parseExcelData()">
                            <i class="fas fa-magic"></i> ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°
                        </button>
                        <button type="button" class="btn btn-outline-secondary ms-2" onclick="clearExcelData()">
                            <i class="fas fa-eraser"></i> ì´ˆê¸°í™”
                        </button>
                        
                        <!-- ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ -->
                        <div id="previewSection" class="mt-4" style="display: none;">
                            <h6>ë¯¸ë¦¬ë³´ê¸° <span id="previewCount" class="badge bg-info"></span></h6>
                            <div class="preview-table">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th width="20%">í’ˆëª©ì½”ë“œ</th>
                                            <th width="25%">í’ˆëª©ëª…</th>
                                            <th width="20%">ê·œê²©</th>
                                            <th width="10%">ë‹¨ìœ„</th>
                                            <th width="25%">ì¶œê³ ë‹¨ê°€</th>
                                        </tr>
                                    </thead>
                                    <tbody id="previewTableBody">
                                    </tbody>
                                </table>
                            </div>
                            <button type="button" class="btn btn-primary" onclick="submitBulkProducts()">
                                <i class="fas fa-check-circle"></i> ì¼ê´„ ë“±ë¡í•˜ê¸°
                            </button>
                        </div>
                    </div>
                    
                    <div class="text-center mb-4">
                        <hr>
                        <p class="text-muted">ë˜ëŠ” ê°œë³„ ì œí’ˆ ë“±ë¡</p>
                    </div>
                    {% endif %}
                    
                    <form method="post" id="singleProductForm">
                        {% csrf_token %}
                        
                        <!-- ê¸°ë³¸ ì •ë³´ -->
                        <div class="mb-3">
                            <label class="form-label">í’ˆëª©ì½”ë“œ <span class="text-danger">*</span></label>
                            <input type="text" name="product_code" class="form-control" 
                                   value="{{ product.product_code }}" required
                                   placeholder="ì˜ˆ: PROD-001">
                            <small class="text-muted">ê³ ìœ í•œ ì œí’ˆ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">í’ˆëª©ëª…</label>
                            <input type="text" name="product_name" class="form-control" 
                                   value="{{ product.product_name|default:'' }}"
                                   placeholder="ì œí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">ê·œê²©</label>
                                <input type="text" name="specification" class="form-control" 
                                       value="{{ product.specification|default:'' }}"
                                       placeholder="ì˜ˆ: 100x200mm">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">ë‹¨ìœ„ <span class="text-danger">*</span></label>
                                <input type="text" name="unit" class="form-control" 
                                       value="{{ product.unit|default:'EA' }}" required
                                       placeholder="ì˜ˆ: EA, SET, BOX">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ì œí’ˆ ì„¤ëª…</label>
                            <textarea name="description" class="form-control" rows="3" 
                                      placeholder="ì œí’ˆì— ëŒ€í•œ ìƒì„¸ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­)">{{ product.description }}</textarea>
                        </div>

                        <!-- ê°€ê²© ì •ë³´ -->
                        <h5 class="mt-4 mb-3">ê°€ê²© ì •ë³´</h5>
                        <div class="mb-3">
                            <label class="form-label">ì¶œê³ ë‹¨ê°€ (ì›) <span class="text-danger">*</span></label>
                            <input type="number" name="standard_price" class="form-control" 
                                   value="{{ product.standard_price|default:'' }}" required
                                   min="0" step="1" placeholder="0">
                        </div>

                        <!-- í”„ë¡œëª¨ì…˜ ì •ë³´ -->
                        <h5 class="mt-4 mb-3">í”„ë¡œëª¨ì…˜ ì„¤ì •</h5>
                        <div class="mb-3">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="is_promo" name="is_promo"
                                       {% if product.is_promo %}checked{% endif %}
                                       onchange="togglePromoFields()">
                                <label class="form-check-label" for="is_promo">
                                    í”„ë¡œëª¨ì…˜ ì ìš©
                                </label>
                            </div>
                        </div>

                        <div id="promoFields" style="display: {% if product.is_promo %}block{% else %}none{% endif %};">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">í”„ë¡œëª¨ì…˜ ê°€ê²© (ì›)</label>
                                    <input type="number" name="promo_price" class="form-control" 
                                           value="{{ product.promo_price|default:'' }}"
                                           min="0" step="1" placeholder="í• ì¸ê°€">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">ì‹œì‘ì¼</label>
                                    <input type="date" name="promo_start" class="form-control" 
                                           value="{{ product.promo_start|date:'Y-m-d' }}">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">ì¢…ë£Œì¼</label>
                                    <input type="date" name="promo_end" class="form-control" 
                                           value="{{ product.promo_end|date:'Y-m-d' }}">
                                </div>
                            </div>
                        </div>

                        <!-- ìƒíƒœ -->
                        <h5 class="mt-4 mb-3">íŒë§¤ ìƒíƒœ</h5>
                        <div class="mb-3">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="is_active" name="is_active"
                                       {% if not product or product.is_active %}checked{% endif %}>
                                <label class="form-check-label" for="is_active">
                                    íŒë§¤ ê°€ëŠ¥ ìƒíƒœë¡œ ì„¤ì •
                                </label>
                                <small class="form-text text-muted d-block">
                                    ë¹„í™œì„±í™”í•˜ë©´ ê²¬ì /ë‚©í’ˆ ì‘ì„± ì‹œ ì œí’ˆ ì„ íƒ ëª©ë¡ì— í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤
                                </small>
                            </div>
                        </div>

                        <!-- ë²„íŠ¼ -->
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'reporting:product_list' %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> ì·¨ì†Œ
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i>
                                {% if product %}ìˆ˜ì • ì™„ë£Œ{% else %}ë“±ë¡{% endif %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            {% if product %}
            <div class="card mt-3">
                <div class="card-body">
                    <h6>í†µê³„ ì •ë³´</h6>
                    <div class="row text-center">
                        <div class="col-md-6">
                            <div class="p-3">
                                <h4 class="text-primary">{{ product.total_quoted }}</h4>
                                <small class="text-muted">ì´ ê²¬ì  íšŸìˆ˜</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="p-3">
                                <h4 class="text-success">{{ product.total_sold }}</h4>
                                <small class="text-muted">ì´ íŒë§¤ íšŸìˆ˜</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
let parsedProducts = [];

function parseExcelData() {
    const textarea = document.getElementById('excelPasteArea');
    const data = textarea.value.trim();
    
    if (!data) {
        alert('ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    const lines = data.split('\n');
    parsedProducts = [];
    
    lines.forEach((line, index) => {
        line = line.trim();
        if (!line) return;
        
        let parts;
        
        // íƒ­ êµ¬ë¶„ ìš°ì„  ì²´í¬ (ì—‘ì…€ ë³µì‚¬-ë¶™ì—¬ë„£ê¸°)
        if (line.includes('\t')) {
            parts = line.split('\t').map(p => p.trim());
        } else {
            // ì—°ì†ëœ ê³µë°±ìœ¼ë¡œ êµ¬ë¶„
            parts = line.split(/\s{2,}/).map(p => p.trim());
        }
        
        // í’ˆëª©ì½”ë“œ, í’ˆëª©ëª…, ê·œê²©, ë‹¨ìœ„, ì¶œê³ ë‹¨ê°€ (5ê°œ)
        if (parts.length >= 5) {
            const productCode = parts[0];
            const productName = parts[1];
            const specification = parts[2];
            const unit = parts[3];
            const price = parts[4].replace(/[,ì›]/g, ''); // ì‰¼í‘œì™€ 'ì›' ì œê±°
            
            if (productCode && price && !isNaN(price)) {
                parsedProducts.push({
                    product_code: productCode,
                    product_name: productName || '',
                    specification: specification || '',
                    unit: unit || 'EA',
                    standard_price: parseInt(price)
                });
            }
        }
    });
    
    if (parsedProducts.length === 0) {
        alert('ì˜¬ë°”ë¥¸ í˜•ì‹ì˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\n\ní˜•ì‹: í’ˆëª©ì½”ë“œ[íƒ­]í’ˆëª©ëª…[íƒ­]ê·œê²©[íƒ­]ë‹¨ìœ„[íƒ­]ì¶œê³ ë‹¨ê°€');
        return;
    }
    
    displayPreview();
}

function displayPreview() {
    const previewSection = document.getElementById('previewSection');
    const previewCount = document.getElementById('previewCount');
    const tbody = document.getElementById('previewTableBody');
    
    tbody.innerHTML = '';
    
    parsedProducts.forEach(product => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${product.product_code}</td>
            <td>${product.product_name || ''}</td>
            <td>${product.specification || ''}</td>
            <td>${product.unit || 'EA'}</td>
            <td class="text-end">${product.standard_price.toLocaleString()}ì›</td>
        `;
        tbody.appendChild(row);
    });
    
    previewCount.textContent = `${parsedProducts.length}ê°œ ì œí’ˆ`;
    previewSection.style.display = 'block';
}

function clearExcelData() {
    document.getElementById('excelPasteArea').value = '';
    document.getElementById('previewSection').style.display = 'none';
    parsedProducts = [];
}

async function submitBulkProducts() {
    if (parsedProducts.length === 0) {
        alert('ë“±ë¡í•  ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    const confirmMsg = `${parsedProducts.length}ê°œì˜ ì œí’ˆì„ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
    if (!confirm(confirmMsg)) {
        return;
    }
    
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ë“±ë¡ ì¤‘...';
    
    try {
        const response = await fetch('{% url "reporting:product_bulk_create" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                products: parsedProducts
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            let msg = `âœ… ì‹ ê·œ ë“±ë¡: ${result.created_count}ê°œ`;
            if (result.updated_count > 0) {
                msg += `\nğŸ”„ ì—…ë°ì´íŠ¸: ${result.updated_count}ê°œ`;
            }
            if (result.skipped_count > 0) {
                msg += `\nâ­ï¸ ê±´ë„ˆëœ€: ${result.skipped_count}ê°œ`;
            }
            alert(msg);
            
            if (result.errors && result.errors.length > 0) {
                console.log('ìƒì„¸ ì •ë³´:', result.errors);
            }
            
            window.location.href = '{% url "reporting:product_list" %}';
        } else {
            alert('ë“±ë¡ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    } catch (error) {
        console.error('Error:', error);
        alert('ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

function togglePromoFields() {
    const isChecked = document.getElementById('is_promo').checked;
    document.getElementById('promoFields').style.display = isChecked ? 'block' : 'none';
}
</script>
{% endblock %}
