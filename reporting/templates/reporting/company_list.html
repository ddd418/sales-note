{% extends "reporting/base.html" %}
{% block title %}{{ page_title }} - 영업 보고 시스템{% endblock %}

{% block content %}
<div class="container">
  <div class="row">
    <div class="col-12">
      <!-- 헤더 섹션 -->
      <div class="page-header d-flex justify-content-between align-items-center mb-4">
        <h1 class="page-title mb-0">
          <i class="fas fa-building me-2"></i>{{ page_title }}
        </h1>
        {% if not is_readonly and user.userprofile.role in 'admin,salesman' %}
        <a href="{% url 'reporting:company_create' %}" class="btn btn-primary">
          <i class="fas fa-plus me-1"></i>새 업체/학교 추가
        </a>
        {% endif %}
      </div>

      <!-- 검색 섹션 -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-body">
              <h6 class="card-title mb-3">
                <i class="fas fa-search me-2"></i>업체/학교 검색
              </h6>
              <form method="GET" action="{% if is_readonly %}{% url 'reporting:manager_company_list' %}{% else %}{% url 'reporting:company_list' %}{% endif %}">
                <div class="row g-3">
                  <div class="col-md-6">
                    <input type="text" class="form-control" name="search" 
                           value="{{ search_query|default:'' }}" 
                           placeholder="업체/학교명을 입력하세요..." autocomplete="off">
                  </div>
                  <div class="col-md-6">
                    <div class="btn-group">
                      <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search me-1"></i>검색
                      </button>
                      <a href="{% if is_readonly %}{% url 'reporting:manager_company_list' %}{% else %}{% url 'reporting:company_list' %}{% endif %}" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-1"></i>초기화
                      </a>
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- 업체 목록 -->
      {% if companies %}
      <div class="card">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>업체/학교명</th>
                  <th>부서/연구실 수</th>
                  <th>고객 정보 수</th>
                  {% if user.userprofile.role == 'admin' %}
                  <th>생성자 회사</th>
                  <th>생성자 계정</th>
                  {% endif %}
                  {% if is_readonly %}
                  <th>담당자</th>
                  {% endif %}
                  <th>관리</th>
                </tr>
              </thead>
              <tbody>
                {% for company in companies %}
                <tr>
                  <td>
                    <a href="{% if is_readonly %}{% url 'reporting:manager_company_detail' company.pk %}{% else %}{% url 'reporting:company_detail' company.pk %}{% endif %}" 
                       class="text-decoration-none fw-bold">
                      {{ company.name }}
                    </a>
                  </td>
                  <td>
                    <span class="badge bg-info department-count-badge" 
                          style="cursor: pointer;" 
                          data-company-id="{{ company.id }}"
                          data-company-name="{{ company.name }}"
                          onclick="loadDepartmentList({{ company.id }}, '{{ company.name }}')">
                      {{ company.department_count }}개
                    </span>
                  </td>
                  <td>
                    <span class=" customer-count-badge" 
                          style="cursor: pointer;" 
                          data-company-id="{{ company.id }}"
                          data-company-name="{{ company.name }}"
                          onclick="loadCustomerList({{ company.id }}, '{{ company.name }}')">
                      {{ company.followup_count }}개
                    </span>
                  </td>
                  {% if user.userprofile.role == 'admin' %}
                  <td>
                    <div class="creator-info-section">
                      <span class="creator-company-display" data-company-id="{{ company.id }}">
                        {% if company.created_by and company.created_by.userprofile.company %}
                          {{ company.created_by.userprofile.company.name }}
                        {% else %}
                          <span class="text-muted">정보 없음</span>
                        {% endif %}
                      </span>
                      <button class="btn btn-sm btn-outline-primary edit-creator-btn ms-2" 
                              data-company-id="{{ company.id }}" 
                              data-current-user-id="{% if company.created_by %}{{ company.created_by.id }}{% endif %}"
                              title="생성자 변경">
                        <i class="fas fa-edit"></i>
                      </button>
                    </div>
                  </td>
                  <td>
                    <div class="creator-info-section">
                      <span class="creator-user-display" data-company-id="{{ company.id }}">
                        {% if company.created_by %}
                          {{ company.created_by.username }}
                        {% else %}
                          <span class="text-muted">정보 없음</span>
                        {% endif %}
                      </span>
                    </div>
                  </td>
                  {% endif %}
                  {% if is_readonly %}
                  <td>
                    {% if company.salesmen %}
                      {% for salesman in company.salesmen %}
                        <span class="badge bg-primary me-1">{{ salesman.username }}</span>
                        {% if not forloop.last and forloop.counter|divisibleby:2 %}<br>{% endif %}
                      {% endfor %}
                    {% else %}
                      <span class="text-muted">담당자 없음</span>
                    {% endif %}
                  </td>
                  {% endif %}
                  <td>
                    <div class="btn-group">
                      <a href="{% if is_readonly %}{% url 'reporting:manager_company_detail' company.pk %}{% else %}{% url 'reporting:company_detail' company.pk %}{% endif %}" 
                         class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-eye me-1"></i>상세
                      </a>
                      {% if not is_readonly and user.userprofile.role == 'admin' or company.created_by == user %}
                      <a href="{% url 'reporting:company_edit' company.pk %}" 
                         class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-edit me-1"></i>수정
                      </a>
                      <a href="{% url 'reporting:company_delete' company.pk %}" 
                         class="btn btn-sm btn-outline-danger">
                        <i class="fas fa-trash me-1"></i>삭제
                      </a>
                      {% endif %}
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- 페이지네이션 -->
      {% if companies.has_other_pages %}
      <div class="row mt-4">
        <div class="col-12">
          <nav aria-label="업체 목록 페이지네이션">
            <ul class="pagination justify-content-center">
              {% if companies.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?{% if search_query %}search={{ search_query }}&{% endif %}page=1" aria-label="첫 페이지">
                  <span aria-hidden="true">&laquo;&laquo;</span>
                </a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?{% if search_query %}search={{ search_query }}&{% endif %}page={{ companies.previous_page_number }}" aria-label="이전 페이지">
                  <span aria-hidden="true">&laquo;</span>
                </a>
              </li>
              {% else %}
              <li class="page-item disabled">
                <span class="page-link">&laquo;&laquo;</span>
              </li>
              <li class="page-item disabled">
                <span class="page-link">&laquo;</span>
              </li>
              {% endif %}
              
              {% for num in companies.paginator.page_range %}
                {% if companies.number|add:'-5' <= num <= companies.number|add:'5' %}
                  {% if num == companies.number %}
                  <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                  </li>
                  {% else %}
                  <li class="page-item">
                    <a class="page-link" href="?{% if search_query %}search={{ search_query }}&{% endif %}page={{ num }}">{{ num }}</a>
                  </li>
                  {% endif %}
                {% endif %}
              {% endfor %}
              
              {% if companies.has_next %}
              <li class="page-item">
                <a class="page-link" href="?{% if search_query %}search={{ search_query }}&{% endif %}page={{ companies.next_page_number }}" aria-label="다음 페이지">
                  <span aria-hidden="true">&raquo;</span>
                </a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?{% if search_query %}search={{ search_query }}&{% endif %}page={{ companies.paginator.num_pages }}" aria-label="마지막 페이지">
                  <span aria-hidden="true">&raquo;&raquo;</span>
                </a>
              </li>
              {% else %}
              <li class="page-item disabled">
                <span class="page-link">&raquo;</span>
              </li>
              <li class="page-item disabled">
                <span class="page-link">&raquo;&raquo;</span>
              </li>
              {% endif %}
            </ul>
          </nav>
        </div>
      </div>
      {% endif %}

      {% else %}
      <div class="card">
        <div class="card-body text-center py-5">
          <i class="fas fa-building fa-3x text-muted mb-3"></i>
          {% if search_query %}
          <h5 class="card-title">검색 결과가 없습니다</h5>
          <p class="card-text text-muted">
            "{{ search_query }}"와 일치하는 업체/학교가 없습니다.
          </p>
          <a href="{% url 'reporting:company_list' %}" class="btn btn-outline-primary">
            <i class="fas fa-times me-1"></i>검색 초기화
          </a>
          {% else %}
          <h5 class="card-title">등록된 업체/학교가 없습니다</h5>
          <p class="card-text text-muted">
            첫 번째 업체/학교를 추가해보세요.
          </p>
          {% if user.userprofile.role == 'admin' %}
          <a href="{% url 'reporting:company_create' %}" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i>새 업체/학교 추가
          </a>
          {% endif %}
          {% endif %}
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Admin 전용: 업체 생성자 변경 모달 -->
{% if user.userprofile.role == 'admin' %}
<div class="modal fade" id="changeCreatorModal" tabindex="-1" aria-labelledby="changeCreatorModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="changeCreatorModalLabel">업체 생성자 변경</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="changeCreatorForm">
          {% csrf_token %}
          <input type="hidden" id="companyIdInput" name="company_id">
          
          <div class="mb-3">
            <label for="newCreatorSelect" class="form-label">새로운 생성자 선택</label>
            <select class="form-control" id="newCreatorSelect" name="new_creator_id" required>
              <option value="">생성자를 선택하세요...</option>
              <!-- 동적으로 사용자 목록이 로드됩니다 -->
            </select>
            <div class="form-text">선택한 사용자의 회사로 업체 소유권이 이전됩니다.</div>
          </div>
          
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>주의:</strong> 업체 소유권을 변경하면 기존 생성자 회사의 사용자들은 이 업체에 더 이상 접근할 수 없습니다.
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
        <button type="button" class="btn btn-primary" id="confirmChangeCreator">변경 확인</button>
      </div>
    </div>
  </div>
</div>

<style>
/* Admin 전용 생성자 정보 스타일 */
{% if user.userprofile.role == 'admin' %}
.creator-info-section {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.creator-company-display,
.creator-user-display {
  font-weight: 500;
  color: #495057;
}

.edit-creator-btn {
  opacity: 0.7;
  transition: opacity 0.2s;
}

.edit-creator-btn:hover {
  opacity: 1;
}

.creator-info-section:hover .edit-creator-btn {
  opacity: 1;
}

/* 테이블 행 호버 효과 강화 */
.table tbody tr:hover {
  background-color: #f8f9fa;
}

/* Admin 컬럼들을 위한 최소 너비 설정 */
.table th:nth-child(4),  /* 생성자 회사 */
.table th:nth-child(5),  /* 생성자 계정 */ 
.table td:nth-child(4),
.table td:nth-child(5) {
  min-width: 150px;
}
{% endif %}
</style>
{% endif %}

<script>
{% if user.userprofile.role == 'admin' %}
document.addEventListener('DOMContentLoaded', function() {
    // 생성자 변경 버튼 클릭 이벤트
    document.querySelectorAll('.edit-creator-btn').forEach(button => {
        button.addEventListener('click', function() {
            const companyId = this.dataset.companyId;
            const currentUserId = this.dataset.currentUserId;
            
            // 모달에 업체 ID 설정
            document.getElementById('companyIdInput').value = companyId;
            
            // 사용자 목록 로드
            loadUserList(currentUserId);
            
            // 모달 표시
            const modal = new bootstrap.Modal(document.getElementById('changeCreatorModal'));
            modal.show();
        });
    });
    
    // 사용자 목록 로드 함수
    async function loadUserList(currentUserId) {
        try {
            const response = await fetch('/reporting/api/users/');
            if (!response.ok) {
                throw new Error('사용자 목록을 불러올 수 없습니다.');
            }
            
            const data = await response.json();
            const select = document.getElementById('newCreatorSelect');
            
            // 기존 옵션들 제거 (첫 번째 옵션 제외)
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            // 사용자 목록 추가
            data.users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.username} (${user.company || '회사 정보 없음'})`;
                if (user.id.toString() === currentUserId) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
            
        } catch (error) {
            console.error('사용자 목록 로드 실패:', error);
            alert('사용자 목록을 불러오는 중 오류가 발생했습니다.');
        }
    }
    
    // 생성자 변경 확인 버튼 클릭 이벤트
    document.getElementById('confirmChangeCreator').addEventListener('click', async function() {
        const companyId = document.getElementById('companyIdInput').value;
        const newCreatorId = document.getElementById('newCreatorSelect').value;
        
        if (!newCreatorId) {
            alert('새로운 생성자를 선택해주세요.');
            return;
        }
        
        try {
            const formData = new FormData();
            formData.append('company_id', companyId);
            formData.append('new_creator_id', newCreatorId);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            const response = await fetch('/reporting/api/companies/change-creator/', {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                throw new Error('업체 생성자 변경에 실패했습니다.');
            }
            
            const result = await response.json();
            
            if (result.success) {
                // UI 업데이트
                updateCreatorInfo(companyId, result.new_creator);
                
                // 모달 닫기
                const modal = bootstrap.Modal.getInstance(document.getElementById('changeCreatorModal'));
                modal.hide();
                
                alert('업체 생성자가 성공적으로 변경되었습니다.');
            } else {
                alert(result.message || '업체 생성자 변경에 실패했습니다.');
            }
            
        } catch (error) {
            console.error('업체 생성자 변경 실패:', error);
            alert('업체 생성자 변경 중 오류가 발생했습니다.');
        }
    });
    
    // UI 업데이트 함수
    function updateCreatorInfo(companyId, newCreator) {
        // 회사명 업데이트
        const companyDisplay = document.querySelector(`.creator-company-display[data-company-id="${companyId}"]`);
        if (companyDisplay) {
            companyDisplay.textContent = newCreator.company || '정보 없음';
        }
        
        // 사용자명 업데이트
        const userDisplay = document.querySelector(`.creator-user-display[data-company-id="${companyId}"]`);
        if (userDisplay) {
            userDisplay.textContent = newCreator.username || '정보 없음';
        }
        
        // 편집 버튼 데이터 업데이트
        const editBtn = document.querySelector(`.edit-creator-btn[data-company-id="${companyId}"]`);
        if (editBtn) {
            editBtn.dataset.currentUserId = newCreator.id;
        }
    }
});
{% endif %}

// 부서 목록과 고객 목록 관련 JavaScript
let currentCompanyId = null;
let currentCompanyName = null;

function loadDepartmentList(companyId, companyName) {
    currentCompanyId = companyId;
    currentCompanyName = companyName;
    
    // 모달 표시
    const modal = new bootstrap.Modal(document.getElementById('departmentListModal'));
    modal.show();
    
    // 로딩 상태 표시
    showDepartmentLoadingState();
    
    // API 호출
    fetch(`/reporting/api/companies/${companyId}/departments/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showDepartmentList(data);
            } else {
                showDepartmentErrorState(data.message || '부서 목록을 불러오는데 실패했습니다.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showDepartmentErrorState('서버와의 통신에 실패했습니다.');
        });
}

function loadCustomerList(companyId, companyName) {
    currentCompanyId = companyId;
    currentCompanyName = companyName;
    
    // 모달 표시
    const modal = new bootstrap.Modal(document.getElementById('customerListModal'));
    modal.show();
    
    // 로딩 상태 표시
    showCustomerLoadingState();
    
    // API 호출
    fetch(`/reporting/api/companies/${companyId}/customers/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showCustomerList(data);
            } else {
                showCustomerErrorState(data.message || '고객 목록을 불러오는데 실패했습니다.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showCustomerErrorState('서버와의 통신에 실패했습니다.');
        });
}

// 부서 목록 관련 함수들
function showDepartmentLoadingState() {
    document.getElementById('departmentListLoading').style.display = 'block';
    document.getElementById('departmentListContent').style.display = 'none';
    document.getElementById('departmentListEmpty').style.display = 'none';
    document.getElementById('departmentListError').style.display = 'none';
}

function showDepartmentList(data) {
    document.getElementById('departmentListLoading').style.display = 'none';
    
    // 업체 정보 표시
    document.getElementById('departmentCompanyInfo').textContent = 
        `${data.company_name} (총 ${data.total_count}개 부서/연구실)`;
    
    if (data.departments && data.departments.length > 0) {
        // 부서 목록 표시
        const tbody = document.getElementById('departmentListTableBody');
        tbody.innerHTML = '';
        
        data.departments.forEach(dept => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><strong>${dept.name}</strong></td>
                <td><span class="badge bg-info">${dept.followup_count}개</span></td>
                <td>${dept.created_date}</td>
                <td>${dept.created_by}</td>
            `;
            tbody.appendChild(row);
        });
        
        document.getElementById('departmentListContent').style.display = 'block';
    } else {
        // 부서가 없는 경우
        document.getElementById('departmentListEmpty').style.display = 'block';
    }
}

function showDepartmentErrorState(message) {
    document.getElementById('departmentListLoading').style.display = 'none';
    document.getElementById('departmentListContent').style.display = 'none';
    document.getElementById('departmentListEmpty').style.display = 'none';
    document.getElementById('departmentListError').style.display = 'block';
    document.getElementById('departmentErrorMessage').textContent = message;
}

function retryLoadDepartmentList() {
    if (currentCompanyId && currentCompanyName) {
        loadDepartmentList(currentCompanyId, currentCompanyName);
    }
}

// 고객 목록 관련 함수들
function showCustomerLoadingState() {
    document.getElementById('customerListLoading').style.display = 'block';
    document.getElementById('customerListContent').style.display = 'none';
    document.getElementById('customerListEmpty').style.display = 'none';
    document.getElementById('customerListError').style.display = 'none';
}

function showCustomerList(data) {
    document.getElementById('customerListLoading').style.display = 'none';
    
    // 업체 정보 표시
    document.getElementById('customerCompanyInfo').textContent = 
        `${data.company_name} (총 ${data.total_count}명 고객)`;
    
    if (data.customers && data.customers.length > 0) {
        // 고객 목록 표시
        const tbody = document.getElementById('customerListTableBody');
        tbody.innerHTML = '';
        
        data.customers.forEach(customer => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <strong>${customer.customer_name}</strong>
                    ${customer.position ? `<br><small class="text-muted">${customer.position}</small>` : ''}
                </td>
                <td>${customer.phone || '-'}</td>
                <td>${customer.email || '-'}</td>
                <td>${customer.department_name}</td>
                <td>${customer.created_date}</td>
                <td>${customer.last_contact}</td>
            `;
            tbody.appendChild(row);
        });
        
        document.getElementById('customerListContent').style.display = 'block';
    } else {
        // 고객이 없는 경우
        document.getElementById('customerListEmpty').style.display = 'block';
    }
}

function showCustomerErrorState(message) {
    document.getElementById('customerListLoading').style.display = 'none';
    document.getElementById('customerListContent').style.display = 'none';
    document.getElementById('customerListEmpty').style.display = 'none';
    document.getElementById('customerListError').style.display = 'block';
    document.getElementById('customerErrorMessage').textContent = message;
}

function retryLoadCustomerList() {
    if (currentCompanyId && currentCompanyName) {
        loadCustomerList(currentCompanyId, currentCompanyName);
    }
}

// 모달이 닫힐 때 상태 초기화
document.getElementById('departmentListModal').addEventListener('hidden.bs.modal', function() {
    currentCompanyId = null;
    currentCompanyName = null;
    
    // 모든 상태 숨기기
    document.getElementById('departmentListLoading').style.display = 'none';
    document.getElementById('departmentListContent').style.display = 'none';
    document.getElementById('departmentListEmpty').style.display = 'none';
    document.getElementById('departmentListError').style.display = 'none';
});

document.getElementById('customerListModal').addEventListener('hidden.bs.modal', function() {
    currentCompanyId = null;
    currentCompanyName = null;
    
    // 모든 상태 숨기기
    document.getElementById('customerListLoading').style.display = 'none';
    document.getElementById('customerListContent').style.display = 'none';
    document.getElementById('customerListEmpty').style.display = 'none';
    document.getElementById('customerListError').style.display = 'none';
});
</script>

<!-- 부서 목록 모달 -->
<div class="modal fade" id="departmentListModal" tabindex="-1" aria-labelledby="departmentListModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="departmentListModalLabel">
          <i class="fas fa-sitemap me-2"></i>부서/연구실 목록
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="departmentListLoading" class="text-center py-4" style="display: none;">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">로딩중...</span>
          </div>
          <p class="mt-2 text-muted">부서/연구실 정보를 불러오는 중...</p>
        </div>
        
        <div id="departmentListContent" style="display: none;">
          <div class="alert alert-info">
            <strong id="departmentCompanyInfo"></strong>
          </div>
          
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>부서/연구실명</th>
                  <th>고객 수</th>
                  <th>등록일</th>
                  <th>등록자</th>
                </tr>
              </thead>
              <tbody id="departmentListTableBody">
                <!-- 부서 목록이 여기에 동적으로 추가됩니다 -->
              </tbody>
            </table>
          </div>
        </div>
        
        <div id="departmentListEmpty" class="text-center py-4" style="display: none;">
          <i class="fas fa-sitemap fa-3x text-muted mb-3"></i>
          <h5>등록된 부서/연구실이 없습니다</h5>
          <p class="text-muted">이 업체에 첫 번째 부서/연구실을 추가해보세요.</p>
        </div>
        
        <div id="departmentListError" class="text-center py-4" style="display: none;">
          <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
          <h5>오류가 발생했습니다</h5>
          <p class="text-muted" id="departmentErrorMessage"></p>
          <button type="button" class="btn btn-outline-primary" onclick="retryLoadDepartmentList()">
            <i class="fas fa-redo me-1"></i>다시 시도
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>

<!-- 고객 목록 모달 -->
<div class="modal fade" id="customerListModal" tabindex="-1" aria-labelledby="customerListModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="customerListModalLabel">
          <i class="fas fa-users me-2"></i>고객 목록
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="customerListLoading" class="text-center py-4" style="display: none;">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">로딩중...</span>
          </div>
          <p class="mt-2 text-muted">고객 정보를 불러오는 중...</p>
        </div>
        
        <div id="customerListContent" style="display: none;">
          <div class="alert alert-info">
            <strong id="customerCompanyInfo"></strong>
          </div>
          
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>고객명</th>
                  <th>연락처</th>
                  <th>이메일</th>
                  <th>부서/연구실</th>
                  <th>등록일</th>
                  <th>최근 연락일</th>
                </tr>
              </thead>
              <tbody id="customerListTableBody">
                <!-- 고객 목록이 여기에 동적으로 추가됩니다 -->
              </tbody>
            </table>
          </div>
        </div>
        
        <div id="customerListEmpty" class="text-center py-4" style="display: none;">
          <i class="fas fa-user-slash fa-3x text-muted mb-3"></i>
          <h5>등록된 고객이 없습니다</h5>
          <p class="text-muted">이 업체에 첫 번째 고객을 등록해보세요.</p>
        </div>
        
        <div id="customerListError" class="text-center py-4" style="display: none;">
          <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
          <h5>오류가 발생했습니다</h5>
          <p class="text-muted" id="customerErrorMessage"></p>
          <button type="button" class="btn btn-outline-primary" onclick="retryLoadCustomerList()">
            <i class="fas fa-redo me-1"></i>다시 시도
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}
