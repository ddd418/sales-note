{% extends "reporting/base.html" %}
{% load humanize %}

{% block extra_css %}
<style>
/* ========================================
    ğŸ¨ LOVABLE DASHBOARD STYLES
   ======================================== */

/* ëª¨ë°”ì¼ ê¸°ë³¸ ì„¤ì • - overflow ë°©ì§€ */
* {
  box-sizing: border-box;
}

html, body {
  overflow-x: hidden;
  width: 100%;
  max-width: 100%;
}

/* í˜ì´ì§€ íƒ€ì´í‹€ - Lovable Style */
.page-title {
  font-size: 1.875rem;
  font-weight: 800;
  background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  word-break: break-word;
}

.page-title i {
  background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

/* ì»¨í…Œì´ë„ˆ ìµœëŒ€ ë„ˆë¹„ ì œí•œ */
.container-fluid {
  max-width: 100%;
  overflow-x: hidden;
}

/* ëª¨ë“  ì¹´ë“œì™€ ìš”ì†Œì— overflow ë°©ì§€ */
.card,
.stat-card,
.performance-card,
.chart-container {
  overflow: hidden;
  max-width: 100%;
}

/* í†µê³„ ì¹´ë“œ ê·¸ë¦¬ë“œ */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2rem;
}

/* ì°¨íŠ¸ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ */
.dashboard-chart-row {
  display: grid;
  gap: 1.5rem;
  margin-bottom: 1.5rem;
  max-width: 100%;
  overflow: hidden;
}

/* ì°¨íŠ¸ ì¹´ë“œ ë‚´ë¶€ */
.dashboard-chart-row > div {
  min-width: 0;
  max-width: 100%;
  overflow: hidden;
}

/* ë°ìŠ¤í¬íƒ‘(ê¸°ë³¸) ë ˆì´ì•„ì›ƒ */
.dashboard-chart-row-2-1 {
  grid-template-columns: 2fr 1fr;
}

.dashboard-chart-row-1-1 {
  grid-template-columns: 1fr 1fr;
}

/* íƒœë¸”ë¦¿ (769px ~ 1024px) */
@media (min-width: 769px) and (max-width: 1024px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 1.25rem;
  }
  
  .dashboard-chart-row-2-1,
  .dashboard-chart-row-1-1 {
    grid-template-columns: 1fr;
  }
  
  .stat-card {
    padding: 1.5rem;
  }
  
  .stat-icon {
    width: 56px;
    height: 56px;
    font-size: 1.5rem;
  }
  
  .stat-value {
    font-size: 2.25rem;
  }
  
  .page-title {
    font-size: 1.5rem;
  }
}

/* ëª¨ë°”ì¼ ë° íƒœë¸”ë¦¿ (1200px ì´í•˜) */
@media (max-width: 1200px) {
  .stats-grid {
    grid-template-columns: 1fr;
    gap: 1rem;
  }
  
  .dashboard-chart-row-2-1,
  .dashboard-chart-row-1-1 {
    grid-template-columns: 1fr;
  }
  
  .stat-card {
    padding: 1.25rem;
  }
  
  .stat-value {
    font-size: 2rem;
  }
  
  .quick-stat-value {
    font-size: 1.5rem;
  }
}

/* ì†Œí˜• ëª¨ë°”ì¼ ì¶”ê°€ ëŒ€ì‘ */
@media (max-width: 768px) {
  .quick-stat-value {
    font-size: 1.25rem;
  }
}

@media (max-width: 480px) {
  .quick-stat-value {
    font-size: 1.1rem;
  }
}

.stat-card {
  background: var(--surface);
  border-radius: var(--radius-lg);
  padding: 2rem;
  box-shadow: var(--shadow-md);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  border: 1px solid var(--border);
  display: block;
  text-decoration: none;
  color: inherit;
  min-width: 0;
  width: 100%;
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--primary) 0%, #8b5cf6 100%);
  opacity: 0;
  transition: opacity 0.3s;
}

.stat-card:hover {
  transform: translateY(-6px);
  box-shadow: var(--shadow-lg), var(--shadow-glow);
  text-decoration: none;
  color: inherit;
  border-color: var(--primary);
}

.stat-card:hover::before {
  opacity: 1;
}

.stat-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 0;
}

.stat-icon {
  width: 64px;
  height: 64px;
  border-radius: var(--radius);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.75rem;
  color: white;
}

.stat-icon.primary { background: linear-gradient(135deg, var(--primary-light), var(--primary)); }
.stat-icon.success { background: linear-gradient(135deg, #34d399, var(--success)); }
.stat-icon.info { background: linear-gradient(135deg, #22d3ee, var(--info)); }
.stat-icon.warning { background: linear-gradient(135deg, #fbbf24, var(--warning)); }
.stat-icon.purple { background: linear-gradient(135deg, #a78bfa, #9333ea); }

.stat-info {
  flex: 1;
  text-align: right;
}

.stat-label {
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 0.5rem;
}

.stat-value {
  font-size: 2.75rem;
  font-weight: 900;
  background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  line-height: 1;
  margin-bottom: 0.5rem;
  word-break: break-word;
}

.stat-subtitle {
  font-size: 0.875rem;
  color: var(--text-muted);
  margin-top: 0.25rem;
  font-weight: 500;
}

.stat-trend {
  display: inline-flex;
  align-items: center;
  gap: 0.25rem;
  font-size: 0.875rem;
  font-weight: 600;
  margin-top: 0.75rem;
  padding: 0.375rem 0.875rem;
  border-radius: var(--radius-sm);
}

.stat-trend.up {
  background: #dcfce7;
  color: #16a34a;
}

.stat-trend.down {
  background: #fee2e2;
  color: #dc2626;
}

.stat-trend.neutral {
  background: #f1f5f9;
  color: #64748b;
}

/* ========================================
   ğŸ¯ NEW INFOGRAPHIC DASHBOARD STYLES
   ======================================== */

/* Infographic Container */
.infographic-dashboard {
  width: 100%;
  max-width: 100%;
  margin: 0 auto 3rem;
  overflow-x: hidden;
  padding: 0 1.5rem;
}

/* ì°¨íŠ¸ ì„¹ì…˜ ê°„ê²© */
.infographic-dashboard > * {
  margin-bottom: 1.5rem;
}

/* Hero Metrics Section */
.hero-metrics {
  width: 100%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 2rem;
  padding: 3rem;
  margin-bottom: 2rem;
  box-shadow: 0 20px 60px -15px rgba(102, 126, 234, 0.4);
  position: relative;
  overflow: hidden;
}

.hero-metrics::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -10%;
  width: 400px;
  height: 400px;
  background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
  border-radius: 50%;
}

.hero-primary {
  display: flex;
  align-items: center;
  gap: 2rem;
  margin-bottom: 2rem;
  position: relative;
  z-index: 1;
}

.hero-icon {
  width: 100px;
  height: 100px;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 2rem;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 3rem;
  color: white;
  backdrop-filter: blur(10px);
  flex-shrink: 0;
}

.hero-content {
  flex: 1;
  color: white;
  min-width: 0;
}

.hero-label {
  font-size: 1.125rem;
  opacity: 0.9;
  margin-bottom: 0.5rem;
  font-weight: 600;
}

.hero-value {
  font-size: 4rem;
  font-weight: 900;
  line-height: 1;
  margin-bottom: 1rem;
  text-shadow: 0 2px 20px rgba(0,0,0,0.1);
  word-break: break-word;
}

.hero-meta {
  display: flex;
  gap: 2rem;
  font-size: 1rem;
  flex-wrap: wrap;
}

.meta-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  background: rgba(255, 255, 255, 0.15);
  border-radius: 0.75rem;
  backdrop-filter: blur(10px);
}

.text-success { color: #a7f3d0 !important; }
.text-warning { color: #fde68a !important; }
.text-danger { color: #fca5a5 !important; }

/* Quick Stats Grid */
.quick-stats {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 1.5rem;
  position: relative;
  z-index: 1;
}

.quick-stat {
  background: rgba(255, 255, 255, 0.15);
  border-radius: 1.25rem;
  padding: 1.5rem;
  display: flex;
  align-items: center;
  gap: 1rem;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: all 0.3s;
  text-decoration: none;
  color: inherit;
  cursor: pointer;
}

.quick-stat:hover {
  background: rgba(255, 255, 255, 0.25);
  transform: translateY(-4px);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
}

.quick-stat-icon {
  width: 60px;
  height: 60px;
  border-radius: 1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.75rem;
  color: white;
  flex-shrink: 0;
}

.bg-gradient-blue { background: linear-gradient(135deg, #667eea 0%, #4c63d2 100%); }
.bg-gradient-green { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
.bg-gradient-purple { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
.bg-gradient-orange { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }

.quick-stat-body {
  flex: 1;
  color: white;
  min-width: 0;
}

.quick-stat-value {
  font-size: 1.75rem;
  font-weight: 800;
  line-height: 1;
  margin-bottom: 0.25rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.quick-stat-label {
  font-size: 0.875rem;
  opacity: 0.9;
  word-break: break-word;
}

/* Activity Timeline - Dark Theme */
.activity-timeline {
  width: 100%;
  background: var(--surface);
  border-radius: 1.5rem;
  padding: 2.5rem;
  margin-bottom: 2rem;
  box-shadow: var(--shadow-md);
  border: 1px solid var(--border);
}

.timeline-title {
  font-size: 1.5rem;
  font-weight: 700;
  margin-bottom: 2rem;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.timeline-stats {
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: relative;
}

.timeline-stat {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1rem;
  position: relative;
  z-index: 1;
}

.timeline-stat-circle {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  font-weight: 800;
  color: white;
  box-shadow: 0 8px 30px rgba(0,0,0,0.12);
  position: relative;
}

.timeline-stat-circle::before {
  content: '';
  position: absolute;
  inset: -4px;
  border-radius: 50%;
  padding: 4px;
  background: linear-gradient(135deg, rgba(255,255,255,0.5), transparent);
  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
  mask-composite: exclude;
}

.bg-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
.bg-info { background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); }
.bg-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
.bg-purple { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }

.timeline-stat-label {
  font-size: 0.875rem;
  font-weight: 600;
  color: #64748b;
  text-align: center;
}

.timeline-connector {
  flex: 0.5;
  height: 4px;
  background: linear-gradient(90deg, var(--border) 0%, var(--border-light) 50%, var(--border) 100%);
  border-radius: 2px;
  position: relative;
  top: -35px;
}

/* Quick Navigation - Dark Theme */
.quick-navigation {
  background: var(--surface);
  border-radius: 1.5rem;
  padding: 2.5rem;
  margin-bottom: 2rem;
  box-shadow: var(--shadow-md);
  border: 1px solid var(--border);
}

.nav-title {
  font-size: 1.5rem;
  font-weight: 700;
  margin-bottom: 2rem;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.nav-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1.25rem;
}

/* Quick Navigation ì¹´ë“œ ìŠ¤íƒ€ì¼ (ì‚¬ì´ë“œë°” nav-itemê³¼ ì¶©ëŒ ë°©ì§€) */
.quick-navigation .nav-item {
  display: flex;
  align-items: center;
  gap: 1.25rem;
  padding: 1.5rem;
  background: #f8fafc;
  border-radius: 1.25rem;
  border: 2px solid #e2e8f0;
  transition: all 0.3s;
  text-decoration: none;
  color: inherit;
  position: relative;
  overflow: hidden;
}

.quick-navigation .nav-item::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, transparent 0%, rgba(99, 102, 241, 0.05) 100%);
  opacity: 0;
  transition: opacity 0.3s;
}

.quick-navigation .nav-item:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 40px rgba(0,0,0,0.1);
  border-color: #6366f1;
  text-decoration: none;
}

.quick-navigation .nav-item:hover::before {
  opacity: 1;
}

.quick-navigation .nav-icon {
  width: 60px;
  height: 60px;
  border-radius: 1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.75rem;
  color: white;
  flex-shrink: 0;
  position: relative;
  z-index: 1;
}

.quick-navigation .nav-customers .nav-icon { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); }
.quick-navigation .nav-calendar .nav-icon { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
.quick-navigation .nav-history .nav-icon { background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); }
.quick-navigation .nav-funnel .nav-icon { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
.quick-navigation .nav-prepayment .nav-icon { background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); }
.quick-navigation .nav-delivery .nav-icon { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }

.quick-navigation .nav-content {
  flex: 1;
  position: relative;
  z-index: 1;
}

.quick-navigation .nav-label {
  font-size: 1.125rem;
  font-weight: 700;
  color: #1e293b;
  margin-bottom: 0.25rem;
}

.quick-navigation .nav-count {
  font-size: 0.875rem;
  color: #64748b;
  font-weight: 500;
}

.quick-navigation .nav-arrow {
  font-size: 1.25rem;
  color: #cbd5e1;
  transition: all 0.3s;
  position: relative;
  z-index: 1;
}

.quick-navigation .nav-item:hover .nav-arrow {
  color: #6366f1;
  transform: translateX(4px);
}

/* Responsive */
@media (min-width: 1025px) and (max-width: 1200px) {
  .quick-stats {
    grid-template-columns: repeat(2, 1fr);
  }
  .nav-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (min-width: 769px) and (max-width: 1024px) {
  .hero-metrics {
    padding: 2rem;
  }
  
  .hero-primary {
    flex-direction: column;
    text-align: center;
    gap: 1.5rem;
  }
  
  .hero-value {
    font-size: 3.5rem;
  }
  
  .quick-stats {
    grid-template-columns: repeat(2, 1fr);
    gap: 1.25rem;
  }
  
  .nav-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 768px) {
  .hero-metrics {
    padding: 1.5rem;
    border-radius: 1.5rem;
  }
  
  .hero-primary {
    flex-direction: column;
    text-align: center;
  }
  
  .hero-value {
    font-size: 2.5rem;
  }
  
  .quick-stats {
    grid-template-columns: 1fr;
  }
  
  .timeline-stats {
    flex-direction: column;
    gap: 2rem;
  }
  
  .timeline-connector {
    display: none;
  }
  
  .nav-grid {
    grid-template-columns: 1fr;
  }
}

/* ë¹ ë¥¸ ì•¡ì…˜ - Dark Theme */
.quick-actions {
  width: 100%;
  background: var(--surface);
  border-radius: 1.25rem;
  padding: 2rem;
  margin-bottom: 2rem;
  box-shadow: var(--shadow-md);
  border: 1px solid var(--border);
}

.section-title {
  font-size: 1.5rem;
  font-weight: 700;
  margin-bottom: 1.5rem;
  display: flex;
  align-items: center;
  gap: 0.75rem;
  color: var(--text-primary);
}

.actions-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 1rem;
}

@media (min-width: 769px) and (max-width: 1024px) {
  .actions-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
  }
  
  .action-btn {
    padding: 1.5rem 1rem;
  }
  
  .action-icon {
    font-size: 2rem;
  }
}

@media (max-width: 768px) {
  .actions-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
  }
  
  .action-btn {
    padding: 1.25rem 1rem;
  }
}

@media (max-width: 480px) {
  .actions-grid {
    grid-template-columns: 1fr;
  }
}

.action-btn {
  padding: 2rem 1.5rem;
  background: var(--surface);
  border: 2px solid var(--border);
  border-radius: 1rem;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1rem;
  text-decoration: none;
  color: var(--text-primary);
  font-weight: 600;
  transition: all 0.3s;
}

.action-btn:hover {
  background: linear-gradient(135deg, #818cf8, #6366f1);
  color: white;
  border-color: #6366f1;
  transform: translateY(-6px);
}

.action-icon {
  font-size: 2.5rem;
}

/* ì„±ê³¼ ì§€í‘œ */
.performance-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2rem;
}

@media (min-width: 769px) and (max-width: 1024px) {
  .performance-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 1.25rem;
  }
  
  .performance-card {
    padding: 2rem;
  }
  
  .performance-value {
    font-size: 2.25rem;
  }
}

@media (max-width: 768px) {
  .performance-grid {
    grid-template-columns: 1fr;
    gap: 1rem;
  }
  
  .performance-card {
    padding: 1.5rem;
  }
  
  .performance-value {
    font-size: 2rem;
  }
}

.performance-card {
  border-radius: 1.25rem;
  padding: 2.5rem;
  color: white;
  text-align: center;
  position: relative;
  overflow: hidden;
}

.performance-icon {
  font-size: 3.5rem;
  margin-bottom: 1.25rem;
  opacity: 0.9;
}

.performance-value {
  font-size: 2.75rem;
  font-weight: 900;
  line-height: 1;
}

.performance-label {
  font-size: 1.125rem;
  opacity: 0.9;
  font-weight: 600;
  margin-top: 0.5rem;
}

.bg-success { background: linear-gradient(135deg, #10b981, #059669); }
.bg-info { background: linear-gradient(135deg, #06b6d4, #0891b2); }
.bg-warning { background: linear-gradient(135deg, #f59e0b, #d97706); }
.bg-primary { background: linear-gradient(135deg, #6366f1, #4f46e5); }

/* ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ ë°˜ì‘í˜• */
@media (min-width: 769px) and (max-width: 1024px) {
  .chart-container {
    padding: 1.5rem;
  }
  
  canvas {
    max-height: 350px !important;
  }
}

@media (max-width: 768px) {
  .stats-grid,
  .performance-grid {
    grid-template-columns: 1fr;
  }
  
  .chart-container {
    padding: 1rem;
  }
  
  canvas {
    max-height: 300px !important;
  }
}
  
  .actions-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  /* ì°¨íŠ¸ ê·¸ë¦¬ë“œ ëª¨ë°”ì¼ */
  div[style*="grid-template-columns: repeat(auto-fit, minmax(400px, 1fr))"] {
    grid-template-columns: 1fr !important;
  }
  
  /* ì¼ì • ì™„ë£Œìœ¨ & í™œë™ í†µê³„ ëª¨ë°”ì¼ */
  div[style*="grid-template-columns: 1fr 2fr"] {
    grid-template-columns: 1fr !important;
  }
}

/* ì œí’ˆ ì¹´ë“œ í˜¸ë²„ íš¨ê³¼ */
.hover-card {
  transition: all 0.2s ease;
  cursor: pointer;
}

.hover-card:hover {
  background-color: #e5f3ff !important;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.hover-card:hover .badge {
  background-color: #007bff !important;
}

/* ========================================
   ğŸ“± ëª¨ë°”ì¼ ë°˜ì‘í˜• (ìµœìš°ì„  ìˆœìœ„)
   ======================================== */
@media (max-width: 768px) {
  /* ğŸ”¥ Bootstrap container ì˜¤ë²„ë¼ì´ë“œ */
  .container-fluid {
    padding-left: 1rem !important;
    padding-right: 1rem !important;
    max-width: 100% !important;
    width: 100% !important;
  }

  /* ğŸ”¥ ë©”ì¸ ì»¨í…ì¸  ì „ì²´ */
  .main-content {
    width: 100% !important;
    max-width: 100% !important;
    margin-left: 0 !important;
    padding: 1rem !important;
  }

  /* ğŸ”¥ ëª¨ë“  ì°¨íŠ¸ í–‰ì€ ë¬´ì¡°ê±´ 1ì—´ */
  .dashboard-chart-row,
  .dashboard-chart-row-2-1,
  .dashboard-chart-row-1-1 {
    display: grid !important;
    grid-template-columns: 1fr !important;
    gap: 1rem !important;
  }
  
  /* ğŸ”¥ Bootstrap row/col ì˜¤ë²„ë¼ì´ë“œ */
  .row {
    margin-left: 0 !important;
    margin-right: 0 !important;
  }
  
  .row.mt-4 .col-lg-6,
  .col-lg-6,
  [class*="col-"] {
    flex: 0 0 100% !important;
    max-width: 100% !important;
    width: 100% !important;
    padding-left: 0.5rem !important;
    padding-right: 0.5rem !important;
  }
  
  /* ğŸ”¥ ì¹´ë“œë¥˜ ê³µí†µ í­ */
  .card,
  .stat-card,
  .analytics-card,
  .hero-metrics,
  .activity-timeline,
  .quick-actions,
  .quick-navigation {
    width: 100% !important;
    max-width: 100% !important;
    min-width: 0 !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
  }
  
  /* ğŸ”¥ ì´ë¯¸ì§€ ì¶•ì†Œ */
  img {
    max-width: 100% !important;
    height: auto !important;
  }
  
  /* ğŸ”¥ í˜ì´ì§€ íƒ€ì´í‹€ */
  .page-title {
    font-size: 1.5rem !important;
  }
  
  /* ğŸ”¥ ë””ë²„ê¹…: ëª¨ë“  ìš”ì†Œì˜ box-sizing ê°•ì œ */
  * {
    box-sizing: border-box !important;
  }
}

/* ê³ ê° ê¸°ë¡ ì¡°íšŒ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
.customer-records-section .autocomplete-suggestions {
  border: 1px solid var(--border);
  max-height: 300px;
  overflow-y: auto;
  background: var(--surface) !important;
}

.customer-records-section .autocomplete-suggestions .customer-search-item {
  padding: 0.75rem 1rem;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  color: var(--text-primary);
}

.customer-records-section .customer-search-item:hover {
  background-color: var(--surface-hover) !important;
}

.customer-records-section .card {
  transition: all 0.3s ease;
}

.customer-records-section .card:hover {
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
}

/* ë‹¤í¬ ëª¨ë“œ: ê³ ê° ê¸°ë¡ ì¡°íšŒ ì„ íƒëœ ê³ ê° ì •ë³´ */
#selectedCustomerInfo {
  background: var(--surface-hover) !important;
  border: 1px solid var(--border);
}

#selectedCustomerInfo strong {
  color: var(--text-primary);
}

/* ë‹¤í¬ ëª¨ë“œ: ë¦¬ë“œ íƒ€ì„ ë°•ìŠ¤ */
.p-3.bg-light.rounded,
.p-2.bg-light.rounded {
  background: var(--surface-hover) !important;
  border: 1px solid var(--border);
}

.p-3.bg-light.rounded h3,
.p-2.bg-light.rounded strong {
  color: var(--text-primary);
}

.p-3.bg-light.rounded small,
.p-2.bg-light.rounded small {
  color: var(--text-muted) !important;
}

/* ë‹¤í¬ ëª¨ë“œ: ë¦¬ë“œ íƒ€ì„ ìƒìœ„ 5ê±´ ì•„ì´í…œ */
.d-flex.justify-content-between.align-items-center.mb-2.p-2.bg-light.rounded {
  background: var(--surface-hover) !important;
  border: 1px solid var(--border);
}

.d-flex.justify-content-between.align-items-center.mb-2.p-2.bg-light.rounded strong {
  color: var(--text-primary);
}

.d-flex.justify-content-between.align-items-center.mb-2.p-2.bg-light.rounded .text-muted {
  color: var(--text-muted) !important;
}

/* ë‹¤í¬ ëª¨ë“œ: ì¹´ë“œ í‘¸í„° */
.card-footer.bg-light {
  background: var(--surface-hover) !important;
  border-top-color: var(--border) !important;
  color: var(--text-primary);
}

/* ë‹¤í¬ ëª¨ë“œ: ê¸°ë¡ ì•„ì´í…œ */
#deliveryRecords .border-bottom,
#quoteRecords .border-bottom {
  border-color: var(--border) !important;
}

#deliveryRecords strong,
#quoteRecords strong {
  color: var(--text-primary);
}

#deliveryRecords .text-muted,
#quoteRecords .text-muted {
  color: var(--text-muted) !important;
}
</style>
{% endblock %}

{% block content %}
<!-- ğŸ¯ NEW: ì¸í¬ê·¸ë˜í”½ ëŒ€ì‹œë³´ë“œ -->
<div class="infographic-dashboard">
  <!-- Hero Section: ì˜¤ëŠ˜ì˜ í•µì‹¬ ì§€í‘œ -->
  <div class="hero-metrics">
    <div class="hero-primary">
      <div class="hero-icon">
        <i class="fas fa-trophy"></i>
      </div>
      <div class="hero-content">
        <div class="hero-label">{{ current_year }}ë…„ ì´ ë‚©í’ˆ ì‹¤ì </div>
        <div class="hero-value">
          {% load currency_filters %}
          {{ total_delivery_amount|currency_format|default:"0" }}
        </div>
        <div class="hero-meta">
          <span class="meta-item">
            <i class="fas fa-box"></i> {{ delivery_count }}ê±´ ì™„ë£Œ
          </span>
          <span class="meta-item {% if meeting_to_delivery_rate >= 15 %}text-success{% elif meeting_to_delivery_rate >= 10 %}text-warning{% else %}text-danger{% endif %}" title="ê³ ê° ë¯¸íŒ… ëŒ€ë¹„ ë‚©í’ˆ ì „í™˜ìœ¨">
            <i class="fas fa-handshake"></i> ë¯¸íŒ…â†’ë‚©í’ˆ {{ meeting_to_delivery_rate|floatformat:1 }}%
          </span>
          <span class="meta-item {% if quote_to_delivery_rate >= 50 %}text-success{% elif quote_to_delivery_rate >= 30 %}text-warning{% else %}text-danger{% endif %}" title="ê²¬ì  ì œì¶œ ëŒ€ë¹„ ë‚©í’ˆ ì „í™˜ìœ¨">
            <i class="fas fa-file-invoice"></i> ê²¬ì â†’ë‚©í’ˆ {{ quote_to_delivery_rate|floatformat:1 }}%
          </span>
        </div>
      </div>
    </div>

    <!-- Quick Stats Grid -->
    <div class="quick-stats">
      <a href="{% url 'reporting:schedule_list' %}?activity_type=quote&status=scheduled{% if view_all %}&view_all=true{% elif selected_user %}&user={{ selected_user.id }}{% endif %}" class="quick-stat" style="text-decoration: none; color: inherit;">
        <div class="quick-stat-icon bg-gradient-blue">
          <i class="fas fa-file-invoice"></i>
        </div>
        <div class="quick-stat-body">
          <div class="quick-stat-value">{{ quote_count|default:"0" }}</div>
          <div class="quick-stat-label">ì²˜ë¦¬í•´ì•¼í•  ê²¬ì </div>
        </div>
      </a>

      <a href="{% url 'reporting:schedule_list' %}?status=scheduled{% if view_all %}&view_all=true{% elif selected_user %}&user={{ selected_user.id }}{% endif %}" class="quick-stat" style="text-decoration: none; color: inherit;">
        <div class="quick-stat-icon bg-gradient-green">
          <i class="fas fa-calendar-check"></i>
        </div>
        <div class="quick-stat-body">
          <div class="quick-stat-value">{{ schedule_count }}</div>
          <div class="quick-stat-label">ì˜ˆì • ì¼ì •</div>
        </div>
      </a>

      <a href="{% url 'reporting:schedule_list' %}?activity_type=delivery&start_date={{ month_start|date:'Y-m-d' }}&end_date={{ month_end|date:'Y-m-d' }}{% if selected_user %}&user={{ selected_user.id }}{% endif %}" class="quick-stat">
        <div class="quick-stat-icon bg-gradient-purple">
          <i class="fas fa-calendar-day"></i>
        </div>
        <div class="quick-stat-body">
          <div class="quick-stat-value">{{ monthly_revenue|currency_format|default:"0" }}</div>
          <div class="quick-stat-label">ì´ë²ˆ ë‹¬ ë§¤ì¶œ</div>
        </div>
      </a>

      <a href="{% url 'reporting:schedule_list' %}?date_from={{ current_year }}-01-01&date_to={{ current_year }}-12-31&status=completed&activity_type=delivery" class="quick-stat">
        <div class="quick-stat-icon bg-gradient-orange">
          <i class="fas fa-calendar-alt"></i>
        </div>
        <div class="quick-stat-body">
          <div class="quick-stat-value">{{ total_delivery_amount|currency_format|default:"0" }}</div>
          <div class="quick-stat-label">ì˜¬í•´ ë§¤ì¶œ</div>
        </div>
      </a>
    </div>
  </div>

  <!-- Activity Timeline: ì´ë²ˆ ë‹¬ í™œë™ -->
  <div class="activity-timeline">
    <h3 class="timeline-title">
      <i class="fas fa-calendar-alt"></i> ì´ë²ˆ ë‹¬ í™œë™ í˜„í™©
    </h3>
    <div class="timeline-stats">
      <div class="timeline-stat">
        <div class="timeline-stat-circle bg-info">
          <span>{{ monthly_meetings|default:"0" }}íšŒ</span>
        </div>
        <div class="timeline-stat-label">ë¯¸íŒ… ì§„í–‰</div>
      </div>
      <div class="timeline-connector"></div>
      <div class="timeline-stat">
        <div class="timeline-stat-circle bg-primary">
          <span>{{ monthly_quote_count|default:"0" }}ê±´</span>
        </div>
        <div class="timeline-stat-label">ê²¬ì  íšŸìˆ˜</div>
      </div>
      <div class="timeline-connector"></div>
      <div class="timeline-stat">
        <div class="timeline-stat-circle bg-success">
          <span>{{ monthly_delivery_count|default:"0" }}ê±´</span>
        </div>
        <div class="timeline-stat-label">ë‚©í’ˆ íšŸìˆ˜</div>
      </div>
      <div class="timeline-connector"></div>
      <div class="timeline-stat">
        <div class="timeline-stat-circle bg-warning">
          <span>{{ prepayment_stats.monthly_count|default:"0" }}ê±´</span>
        </div>
        <div class="timeline-stat-label">ì„ ê²°ì œ ê±´ìˆ˜</div>
      </div>
    </div>
  </div>

  <!-- ğŸ” ê³ ê° ê¸°ë¡ ì¡°íšŒ ì„¹ì…˜ -->
  <div class="customer-records-section card shadow-sm border-0 mb-4 mt-4" style="border-radius: 1rem;">
    <div class="card-body p-4">
      <h5 class="card-title mb-4 d-flex align-items-center">
        <i class="fas fa-user-tag text-primary me-2"></i> ë¶€ì„œë³„ ë‚©í’ˆ/ê²¬ì  ê¸°ë¡ ì¡°íšŒ
      </h5>
      
      <!-- ê³ ê° ê²€ìƒ‰ -->
      <div class="row mb-4">
        <div class="col-md-6">
          <div class="position-relative">
            <input type="text" 
                   id="customerSearchInput" 
                   class="form-control form-control-lg" 
                   placeholder="ê³ ê°ëª…, ì—…ì²´ëª…, ë¶€ì„œëª…ìœ¼ë¡œ ê²€ìƒ‰..." 
                   autocomplete="off">
            <div id="customerSearchResults" 
                 class="autocomplete-suggestions position-absolute w-100 shadow-lg rounded-3 mt-1" 
                 style="display: none; z-index: 1050; max-height: 300px; overflow-y: auto;">
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div id="selectedCustomerInfo" class="p-3 bg-light rounded-3" style="display: none;">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <strong id="selectedCustomerName"></strong>
                <small class="text-muted d-block" id="selectedCustomerCompany"></small>
              </div>
              <button type="button" class="btn btn-sm btn-outline-danger" id="clearCustomerBtn">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- ê¸°ë¡ í‘œì‹œ ì˜ì—­ -->
      <div id="customerRecordsContainer" style="display: none;">
        <div class="row">
          <!-- ë‚©í’ˆ ê¸°ë¡ -->
          <div class="col-lg-6 mb-4">
            <div class="card border-success h-100">
              <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <span><i class="fas fa-truck me-2"></i>ë‚©í’ˆ ê¸°ë¡</span>
                <span class="badge bg-white text-success" id="deliveryCount">0ê±´</span>
              </div>
              <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                <div id="deliveryRecords">
                  <p class="text-muted text-center py-4">ê³ ê°ì„ ì„ íƒí•˜ì„¸ìš”</p>
                </div>
              </div>
              <div class="card-footer bg-light">
                <strong>ì´ ë‚©í’ˆì•¡: <span id="totalDeliveryAmount" class="text-success">0ì›</span></strong>
              </div>
            </div>
          </div>
          
          <!-- ê²¬ì  ê¸°ë¡ -->
          <div class="col-lg-6 mb-4">
            <div class="card border-primary h-100">
              <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <span><i class="fas fa-file-invoice me-2"></i>ê²¬ì  ê¸°ë¡</span>
                <span class="badge bg-white text-primary" id="quoteCount">0ê±´</span>
              </div>
              <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                <div id="quoteRecords">
                  <p class="text-muted text-center py-4">ê³ ê°ì„ ì„ íƒí•˜ì„¸ìš”</p>
                </div>
              </div>
              <div class="card-footer bg-light">
                <strong>ì´ ê²¬ì ì•¡: <span id="totalQuoteAmount" class="text-primary">0ì›</span></strong>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- ì´ˆê¸° ì•ˆë‚´ ë©”ì‹œì§€ -->
      <div id="customerRecordsPlaceholder" class="text-center py-5">
        <i class="fas fa-search fa-3x text-muted mb-3"></i>
        <p class="text-muted">ìœ„ ê²€ìƒ‰ì°½ì—ì„œ ê³ ê°ì„ ê²€ìƒ‰í•˜ê³  ì„ íƒí•˜ë©´<br>í•´ë‹¹ ê³ ê°ì˜ ì „ì²´ ë‚©í’ˆ/ê²¬ì  ê¸°ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>
      </div>
    </div>
  </div>
  
  <!-- í‰ê·  ë¦¬ë“œ íƒ€ì„ & ì œí’ˆë³„ ë§¤ì¶œ ë¹„ì¤‘ -->
  <div class="row mt-4 d-flex align-items-stretch">
    <!-- í‰ê·  ë¦¬ë“œ íƒ€ì„ -->
    <div class="col-lg-6 d-flex">
      <div class="card shadow-sm border-0 flex-grow-1" style="border-radius: 1rem;">
        <div class="card-body p-4 d-flex flex-column">
          <h5 class="card-title mb-4 d-flex align-items-center">
            <i class="fas fa-clock text-info me-2"></i> í‰ê·  ë¦¬ë“œ íƒ€ì„ (ê²¬ì â†’ë‚©í’ˆ)
          </h5>
          
          {% if lead_time_analysis.total_cases > 0 %}
          <div class="row text-center mb-4">
            <div class="col-4">
              <div class="p-3 bg-light rounded">
                <h3 class="text-primary mb-1">{{ lead_time_analysis.average_days }}</h3>
                <small class="text-muted">í‰ê·  (ì¼)</small>
              </div>
            </div>
            <div class="col-4">
              <div class="p-3 bg-light rounded">
                <h3 class="text-success mb-1">{{ lead_time_analysis.min_days }}</h3>
                <small class="text-muted">ìµœì†Œ (ì¼)</small>
              </div>
            </div>
            <div class="col-4">
              <div class="p-3 bg-light rounded">
                <h3 class="text-danger mb-1">{{ lead_time_analysis.max_days }}</h3>
                <small class="text-muted">ìµœëŒ€ (ì¼)</small>
              </div>
            </div>
          </div>
          
          <hr>
          
          <h6 class="mb-3">ë¦¬ë“œ íƒ€ì„ ìƒìœ„ 5ê±´</h6>
          <div class="flex-grow-1" style="max-height: 350px; overflow-y: auto;">
            {% for detail in lead_time_analysis.details|slice:":5" %}
            <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
              <div>
                <strong>{{ detail.customer_name }}</strong>
                <small class="text-muted d-block">{{ detail.company_name }}</small>
              </div>
              <div class="text-end">
                <span class="badge bg-primary">{{ detail.lead_time_days }}ì¼</span>
                <small class="text-muted d-block">{{ detail.quote_date }} â†’ {{ detail.delivery_date }}</small>
              </div>
            </div>
            {% endfor %}
          </div>
          
          <div class="mt-3 text-center">
            <small class="text-muted">ì´ {{ lead_time_analysis.total_cases }}ê±´ì˜ ê²¬ì â†’ë‚©í’ˆ ë°ì´í„° ë¶„ì„</small>
          </div>
          {% else %}
          <div class="text-center py-5">
            <i class="fas fa-clock fa-3x text-muted mb-3"></i>
            <p class="text-muted">ê²¬ì ì—ì„œ ë‚©í’ˆê¹Œì§€ ì™„ë£Œëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- ì œí’ˆêµ°ë³„ ë§¤ì¶œ ë¹„ì¤‘ -->
    <div class="col-lg-6 d-flex">
      <div class="card shadow-sm border-0 flex-grow-1" style="border-radius: 1rem;">
        <div class="card-body p-4 d-flex flex-column">
          <h5 class="card-title mb-4 d-flex align-items-center">
            <i class="fas fa-box-open text-success me-2"></i> ì œí’ˆêµ°ë³„ ë§¤ì¶œ ë¹„ì¤‘
          </h5>
          
          {% if product_sales_distribution.product_count > 0 %}
          <div style="height: 200px; margin-bottom: 1rem;">
            <canvas id="productSalesChart"></canvas>
          </div>
          
          <hr>
          
          <h6 class="mb-3">ì œí’ˆë³„ ìƒì„¸ (ì „ì²´ {{ product_sales_distribution.product_count }}ê°œ)</h6>
          <div class="flex-grow-1" style="max-height: 300px; overflow-y: auto;">
            {% for product in product_sales_distribution.products %}
            <a href="{% url 'reporting:schedule_list' %}?product={{ product.product_name|urlencode }}" 
               class="text-decoration-none text-dark">
              <div class="mb-2 p-2 bg-light rounded hover-card">
                <div class="d-flex justify-content-between align-items-start mb-1">
                  <div>
                    <strong style="font-size: 0.9rem;">{{ product.product_name }}</strong>
                    {% if product.product_description %}
                    <small class="text-muted d-block" style="font-size: 0.75rem;">{{ product.product_description|truncatechars:30 }}</small>
                    {% endif %}
                  </div>
                  <span class="badge bg-success">{{ product.percentage }}%</span>
                </div>
                <div class="row small text-muted" style="font-size: 0.75rem;">
                  <div class="col-4">
                    ë§¤ì¶œ: {{ product.total_revenue|floatformat:0|intcomma }}ì›
                  </div>
                  <div class="col-4">
                    ìˆ˜ëŸ‰: {{ product.quantity }}ê°œ
                  </div>
                  <div class="col-4">
                    ì£¼ë¬¸: {{ product.order_count }}ê±´
                  </div>
                </div>
                <div class="progress mt-1" style="height: 4px;">
                  <div class="progress-bar bg-success" style="width: {{ product.percentage }}%"></div>
                </div>
              </div>
            </a>
            {% endfor %}
          </div>
          
          <div class="mt-3 text-center">
            <small class="text-muted">
              ì´ {{ product_sales_distribution.product_count }}ê°œ ì œí’ˆ | 
              ì „ì²´ ë§¤ì¶œ: {{ product_sales_distribution.total_revenue|floatformat:0|intcomma }}ì›
            </small>
          </div>
          {% else %}
          <div class="text-center py-5">
            <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
            <p class="text-muted">ì œí’ˆë³„ ë§¤ì¶œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ğŸ“Š ë¶„ì„ ì°¨íŠ¸ ì„¹ì…˜ -->
<div class="analysis-dashboard-section" style="padding: 0 1.5rem;">
<h2 class="section-title" style="margin-top: 3rem; margin-bottom: 1.5rem;"><i class="fas fa-chart-bar" style="color: #6366f1;"></i> ì˜ì—… ë¶„ì„ ëŒ€ì‹œë³´ë“œ</h2>

<!-- 1í–‰: ë§¤ì¶œ ì¶”ì´ & ì˜ì—… í¼ë„ -->
<div class="dashboard-chart-row dashboard-chart-row-2-1">
  <!-- 1. ë§¤ì¶œ ë° ë‚©í’ˆ ì¶”ì´ (Combo Chart) -->
  <div style="background: var(--surface); border-radius: 1.25rem; padding: 2rem; box-shadow: var(--shadow-md); border: 1px solid var(--border);">
    <h3 class="section-title" style="font-size: 1.125rem; margin-bottom: 1.5rem;">
      <i class="fas fa-chart-area" style="color: #10b981;"></i> ë§¤ì¶œ ë° ë‚©í’ˆ ì¶”ì´ ({{ current_year }}ë…„)
    </h3>
    <div style="position: relative; height: 300px;">
      <canvas id="revenueDeliveryChart"></canvas>
    </div>
  </div>

  <!-- 2. ì˜ì—…í™œë™ í¼ë„ -->
  <div style="background: var(--surface); border-radius: 1.25rem; padding: 2rem; box-shadow: var(--shadow-md); border: 1px solid var(--border);">
    <h3 class="section-title" style="font-size: 1.125rem; margin-bottom: 1.5rem;">
      <i class="fas fa-filter" style="color: #6366f1;"></i> ì˜ì—… ì „í™˜ í¼ë„
    </h3>
    <div style="position: relative; height: 300px;">
      <canvas id="salesFunnelChart"></canvas>
    </div>
  </div>
</div>

<!-- 2í–‰: ê³ ê°ì‚¬ë³„ ë§¤ì¶œ & ì¢…í•© ìš°ì„ ìˆœìœ„ ë¶„í¬ & ê³ ê° ìœ í˜•ë³„ í†µê³„ -->
<div class="dashboard-chart-row dashboard-chart-row-1-1">
  <!-- 3. ê³ ê°ì‚¬ë³„ ë§¤ì¶œ ë¹„ì¤‘ (Doughnut) -->
  <div style="background: var(--surface); border-radius: 1.25rem; padding: 2rem; box-shadow: var(--shadow-md); border: 1px solid var(--border);">
    <h3 class="section-title" style="font-size: 1.125rem; margin-bottom: 1.5rem;">
      <i class="fas fa-chart-pie" style="color: #f59e0b;"></i> ê³ ê°ì‚¬ë³„ ë§¤ì¶œ ë¹„ì¤‘ (Top 5)
    </h3>
    <div style="position: relative; height: 300px;">
      <canvas id="customerShareChart"></canvas>
    </div>
  </div>

  {% if request.user.userprofile.can_use_ai %}
  <!-- AI ì‚¬ìš©ì: ì¢…í•© ìš°ì„ ìˆœìœ„ ë¶„í¬ (Bar Chart) -->
  <div style="background: var(--surface); border-radius: 1.25rem; padding: 2rem; box-shadow: var(--shadow-md); border: 1px solid var(--border);">
    <h3 class="section-title" style="font-size: 1.125rem; margin-bottom: 1.5rem;">
      <i class="fas fa-chart-bar" style="color: #8b5cf6;"></i> ì¢…í•© ìš°ì„ ìˆœìœ„ ë¶„í¬
      <small style="font-size: 0.75rem; color: var(--text-muted); font-weight: normal;"> (AI ë“±ê¸‰ 70% + ìš°ì„ ìˆœìœ„ 30%)</small>
    </h3>
    <div style="position: relative; height: 300px;">
      <canvas id="priorityLevelChart"></canvas>
    </div>
  </div>
  {% else %}
  <!-- ì¼ë°˜ ì‚¬ìš©ì: ê³ ê° ìœ í˜•ë³„ í†µê³„ -->
  <div style="background: var(--surface); border-radius: 1.25rem; padding: 2rem; box-shadow: var(--shadow-md); border: 1px solid var(--border);">
    <h3 class="section-title" style="font-size: 1.125rem; margin-bottom: 1.5rem;">
      <i class="fas fa-users" style="color: #ef4444;"></i> ê³ ê° ìœ í˜•ë³„ í†µê³„
    </h3>
    <div style="position: relative; height: 300px;">
      <canvas id="customerTypeChart"></canvas>
    </div>
  </div>
  {% endif %}
</div>

{% if request.user.userprofile.can_use_ai %}
<!-- AI ì‚¬ìš©ì: ê³ ê° ìœ í˜•ë³„ í†µê³„ (ë³„ë„ í–‰) -->
<div class="dashboard-chart-row">
  <div style="background: var(--surface); border-radius: 1.25rem; padding: 2rem; box-shadow: var(--shadow-md); border: 1px solid var(--border);">
    <h3 class="section-title" style="font-size: 1.125rem; margin-bottom: 1.5rem;">
      <i class="fas fa-users" style="color: #ef4444;"></i> ê³ ê° ìœ í˜•ë³„ í†µê³„
    </h3>
    <div style="position: relative; height: 300px;">
      <canvas id="customerTypeChartAI"></canvas>
    </div>
  </div>
</div>
{% endif %}

<!-- 4í–‰: í™œë™ íˆíŠ¸ë§µ -->
<div style="background: var(--surface); border-radius: 1.25rem; padding: 2rem; box-shadow: var(--shadow-md); border: 1px solid var(--border); margin-bottom: 2rem;">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <h3 class="section-title" style="font-size: 1.125rem; margin: 0;">
      <i class="fas fa-calendar-check" style="color: #10b981;"></i> ì¼ì • ë° ë¯¸íŒ… í™œë™ íˆíŠ¸ë§µ
    </h3>
    <div style="font-size: 1rem; font-weight: 600; color: var(--primary);">
      {{ current_year }}ë…„ {% now "n" %}ì›”
    </div>
  </div>
  <!-- ìš”ì¼ í—¤ë” -->
  <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem; margin-bottom: 0.5rem; font-size: 0.75rem; font-weight: 600; color: var(--text-muted); text-align: center;">
    <div>ì¼</div>
    <div>ì›”</div>
    <div>í™”</div>
    <div>ìˆ˜</div>
    <div>ëª©</div>
    <div>ê¸ˆ</div>
    <div>í† </div>
  </div>
  <div id="activityHeatmap" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem;">
    <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
  </div>
</div>
</div><!-- /.analysis-dashboard-section -->

<script>
document.addEventListener('DOMContentLoaded', function() {
  
  // ============================================
  // ğŸŒ™ Chart.js Dark Theme Global Configuration
  // ============================================
  Chart.defaults.color = 'hsl(215, 20%, 65%)';
  Chart.defaults.borderColor = 'hsl(217, 33%, 22%)';
  // backgroundColorëŠ” ê°œë³„ ì°¨íŠ¸ì—ì„œ ì§€ì • (ê¸€ë¡œë²Œ ì„¤ì • ì œê±°)
  
  // Grid lines - ë‹¤í¬ëª¨ë“œì— ë§ê²Œ ìˆ˜ì •
  if (Chart.defaults.scales && Chart.defaults.scales.linear) {
    Chart.defaults.scales.linear.grid = {
      color: 'hsl(217, 33%, 25%)',
    };
  }
  
  // Tooltip dark theme
  Chart.defaults.plugins.tooltip.backgroundColor = 'hsl(222, 47%, 14%)';
  Chart.defaults.plugins.tooltip.titleColor = 'hsl(210, 40%, 98%)';
  Chart.defaults.plugins.tooltip.bodyColor = 'hsl(215, 20%, 75%)';
  Chart.defaults.plugins.tooltip.borderColor = 'hsl(217, 33%, 22%)';
  Chart.defaults.plugins.tooltip.borderWidth = 1;
  
  // Legend dark theme
  Chart.defaults.plugins.legend.labels.color = 'hsl(215, 20%, 65%)';
  
  // ğŸ”¥ FORCE FIX: ì‚¬ì´ë“œë°” ê²¹ì¹¨ ë¬¸ì œ ê°•ì œ í•´ê²°
  const sidebar = document.querySelector('aside.sidebar#sidebar');
  const mainContent = document.querySelector('.main-content');
  const infographicDashboard = document.querySelector('.infographic-dashboard');
  
  if (sidebar) {
    sidebar.style.display = 'block';
    sidebar.style.position = 'fixed';
    sidebar.style.left = '0';
    sidebar.style.top = '0';
    sidebar.style.width = '260px';
    sidebar.style.zIndex = '9999';  // ìµœìƒìœ„
    sidebar.style.pointerEvents = 'auto';  // í´ë¦­ ê°€ëŠ¥
  }
  
  if (mainContent) {
    mainContent.style.marginLeft = '260px';
    mainContent.style.position = 'relative';
    mainContent.style.zIndex = '1';
    mainContent.style.width = 'calc(100% - 260px)';  // ì‚¬ì´ë“œë°” ì œì™¸í•œ ë„ˆë¹„
    
  }
  
  if (infographicDashboard) {
    infographicDashboard.style.position = 'relative';
    infographicDashboard.style.zIndex = '1';
    infographicDashboard.style.marginLeft = '0';
    infographicDashboard.style.maxWidth = '100%';
    infographicDashboard.style.overflow = 'visible';
  }
  
  // ğŸ¯ ëª¨ë“  ì¹´ë“œë“¤ì´ ì‚¬ì´ë“œë°” ì˜ì—­ ì¹¨ë²” ëª»í•˜ë„ë¡
  const allCards = document.querySelectorAll('.hero-metrics, .activity-timeline, .quick-navigation, .infographic-dashboard > *');
  allCards.forEach(card => {
    card.style.position = 'relative';
    card.style.zIndex = '1';
    card.style.marginLeft = '0';
    card.style.maxWidth = '100%';
  });
  
  
  
  // ============================================
  // 1ï¸âƒ£ ë§¤ì¶œ ë° ë‚©í’ˆ ì¶”ì´ (Combo Chart: Bar + Line)
  // ============================================
  const revenueDeliveryCtx = document.getElementById('revenueDeliveryChart');
  if (revenueDeliveryCtx) {
    {% if monthly_delivery_stats %}
    const deliveryStats = {{ monthly_delivery_stats|safe }};
    const months = deliveryStats.labels;
    const deliveryAmounts = deliveryStats.amounts;
    const deliveryCounts = deliveryStats.counts;

    new Chart(revenueDeliveryCtx, {
      type: 'bar',
      data: {
        labels: months,
        datasets: [
          {
            type: 'bar',
            label: 'ë‚©í’ˆ ê¸ˆì•¡ (ë°±ë§Œì›)',
            data: deliveryAmounts.map(v => v / 1000000),
            backgroundColor: 'rgba(129, 140, 248, 0.9)',
            borderColor: 'rgba(129, 140, 248, 1)',
            borderWidth: 2,
            borderRadius: 6,
            yAxisID: 'y-amount'
          },
          {
            type: 'line',
            label: 'ë‚©í’ˆ ê±´ìˆ˜',
            data: deliveryCounts,
            borderColor: 'rgba(52, 211, 153, 1)',
            backgroundColor: 'rgba(52, 211, 153, 0.1)',
            borderWidth: 3,
            tension: 0.4,
            fill: false,
            yAxisID: 'y-count',
            pointRadius: 5,
            pointBackgroundColor: '#34d399'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { display: true, position: 'top' },
          tooltip: {
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) label += ': ';
                if (context.datasetIndex === 0) {
                  label += context.parsed.y.toFixed(0) + 'ë°±ë§Œì›';
                } else {
                  label += context.parsed.y + 'ê±´';
                }
                return label;
              }
            }
          }
        },
        scales: {
          'y-amount': {
            type: 'linear',
            position: 'left',
            beginAtZero: true,
            title: { display: true, text: 'ë‚©í’ˆ ê¸ˆì•¡ (ë°±ë§Œì›)', color: '#6366f1' },
            ticks: { color: '#6366f1' }
          },
          'y-count': {
            type: 'linear',
            position: 'right',
            beginAtZero: true,
            title: { display: true, text: 'ë‚©í’ˆ ê±´ìˆ˜ (ê±´)', color: '#10b981' },
            ticks: { color: '#10b981' },
            grid: { drawOnChartArea: false }
          }
        }
      }
    });
    {% endif %}
  }

  // ============================================
  // 2ï¸âƒ£ ì˜ì—…í™œë™ í¼ë„ (Funnel Chart)
  // ============================================
  const salesFunnelCtx = document.getElementById('salesFunnelChart');
  if (salesFunnelCtx) {
    {% if sales_funnel %}
    const funnelData = {{ sales_funnel|safe }};
    const funnelStages = funnelData.stages;
    const funnelValues = funnelData.values;
    const funnelColors = ['rgba(129, 140, 248, 0.9)', 'rgba(167, 139, 250, 0.9)', 'rgba(52, 211, 153, 0.9)', 'rgba(251, 191, 36, 0.9)'];

    new Chart(salesFunnelCtx, {
      type: 'bar',
      data: {
        labels: funnelStages,
        datasets: [{
          label: 'ê±´ìˆ˜',
          data: funnelValues,
          backgroundColor: funnelColors,
          borderColor: ['#818cf8', '#a78bfa', '#34d399', '#fbbf24'],
          borderWidth: 2,
          borderRadius: 8
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(context) {
                const index = context.dataIndex;
                
                if (index === 0) {
                  // ì²« ë²ˆì§¸ ë‹¨ê³„(ë¯¸íŒ…)ëŠ” í¼ì„¼íŠ¸ ì—†ì´ ê±´ìˆ˜ë§Œ í‘œì‹œ
                  return context.parsed.x + 'ê±´';
                } else if (index === 3) {
                  // ë‚©í’ˆ ì™„ë£ŒëŠ” ê²¬ì  ì œì¶œ ëŒ€ë¹„ ì „í™˜ìœ¨
                  const quoteValue = funnelValues[1];
                  const percentage = quoteValue > 0 ? ((context.parsed.x / quoteValue) * 100).toFixed(1) : '0.0';
                  return context.parsed.x + 'ê±´ (' + percentage + '%)';
                } else {
                  // ë‚˜ë¨¸ì§€ëŠ” ì´ì „ ë‹¨ê³„ ëŒ€ë¹„ ì „í™˜ìœ¨ ê³„ì‚°
                  const prevValue = funnelValues[index - 1];
                  const percentage = prevValue > 0 ? ((context.parsed.x / prevValue) * 100).toFixed(1) : '0.0';
                  return context.parsed.x + 'ê±´ (' + percentage + '%)';
                }
              }
            }
          }
        },
        scales: {
          x: { beginAtZero: true, title: { display: true, text: 'ê±´ìˆ˜' } }
        }
      }
    });
    {% endif %}
  }

  // ============================================
  // 3ï¸âƒ£ ê³ ê°ì‚¬ë³„ ë§¤ì¶œ ë¹„ì¤‘ (Doughnut Chart)
  // ============================================
  const customerShareCtx = document.getElementById('customerShareChart');
  if (customerShareCtx) {
    {% if customer_distribution %}
    const customerDist = {{ customer_distribution|safe }};
    const topCustomers = customerDist.labels;
    const customerRevenues = customerDist.data;

    new Chart(customerShareCtx, {
      type: 'doughnut',
      data: {
        labels: topCustomers,
        datasets: [{
          data: customerRevenues,
          backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#06b6d4', '#8b5cf6', '#94a3b8'],
          borderWidth: 2,
          borderColor: '#fff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'right' },
          tooltip: {
            callbacks: {
              label: function(context) {
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const value = context.parsed;
                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                return context.label + ': ' + (value / 1000000).toFixed(0) + 'ë°±ë§Œì› (' + percentage + '%)';
              }
            }
          }
        }
      }
    });
    {% else %}
    // ë°ì´í„° ì—†ìŒ ë©”ì‹œì§€
    customerShareCtx.parentElement.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #9ca3af; font-size: 0.875rem;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
    {% endif %}
  }

  // ============================================
  // 6ï¸âƒ£ ì¢…í•© ìš°ì„ ìˆœìœ„ ë¶„í¬ (Bar Chart) - AI ê¶Œí•œìë§Œ
  // ============================================
  {% if request.user.userprofile.can_use_ai %}
  const priorityLevelCtx = document.getElementById('priorityLevelChart');
  if (priorityLevelCtx) {
    {% if priority_level_chart %}
    const priorityData = {{ priority_level_chart|safe }};
    
    // ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
    const hasData = priorityData.data.some(v => v > 0);
    
    if (hasData) {
      new Chart(priorityLevelCtx, {
        type: 'bar',
        data: {
          labels: priorityData.labels,
          datasets: [{
            label: 'ê³ ê° ìˆ˜',
            data: priorityData.data,
            backgroundColor: priorityData.colors,
            borderColor: priorityData.colors,
            borderWidth: 2,
            borderRadius: 8,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const total = priorityData.data.reduce((a, b) => a + b, 0);
                  const percentage = ((context.parsed.y / total) * 100).toFixed(1);
                  return context.parsed.y + 'ëª… (' + percentage + '%)';
                }
              }
            }
          },
          scales: {
            y: { 
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });
    } else {
      priorityLevelCtx.parentElement.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #9ca3af; font-size: 0.875rem;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
    }
    {% else %}
    priorityLevelCtx.parentElement.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #9ca3af; font-size: 0.875rem;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
    {% endif %}
  }
  {% endif %}

  // ============================================
  // 7ï¸âƒ£ ê³ ê° ìœ í˜•ë³„ í†µê³„ (Grouped Bar Chart)
  // ============================================
  // ì¼ë°˜ ì‚¬ìš©ììš© ë˜ëŠ” AI ì‚¬ìš©ììš© ì°¨íŠ¸ ëª¨ë‘ ì²˜ë¦¬
  const customerTypeCtx = document.getElementById('customerTypeChart') || document.getElementById('customerTypeChartAI');
  if (customerTypeCtx) {
    {% if customer_type_stats %}
    const typeStats = {{ customer_type_stats|safe }};
    const customerTypes = typeStats.labels;
    const revenues = typeStats.revenue;
    const counts = typeStats.count;

    // ë°ì´í„°ê°€ ëª¨ë‘ 0ì¸ì§€ í™•ì¸
    const hasData = revenues.some(v => v > 0) || counts.some(c => c > 0);
    
    if (hasData) {
      new Chart(customerTypeCtx, {
        type: 'bar',
        data: {
          labels: customerTypes,
          datasets: [
            {
              label: 'ë§¤ì¶œ (ë°±ë§Œì›)',
              data: revenues,
              backgroundColor: 'rgba(129, 140, 248, 0.9)',
              borderColor: 'rgba(129, 140, 248, 1)',
              borderWidth: 2,
              borderRadius: 6
            },
            {
              label: 'ê±°ë˜ ê±´ìˆ˜',
              data: counts,
              backgroundColor: 'rgba(52, 211, 153, 0.9)',
              borderColor: 'rgba(52, 211, 153, 1)',
              borderWidth: 2,
              borderRadius: 6
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { 
              display: true, 
              position: 'top',
              labels: {
                color: 'hsl(210, 40%, 98%)'
              }
            }
          },
          scales: {
            y: { 
              beginAtZero: true,
              grid: {
                color: 'hsl(217, 33%, 25%)'
              },
              ticks: {
                color: 'hsl(210, 40%, 98%)'
              }
            },
            x: {
              grid: {
                color: 'hsl(217, 33%, 25%)'
              },
              ticks: {
                color: 'hsl(210, 40%, 98%)'
              }
            }
          }
        }
      });
    } else {
      customerTypeCtx.parentElement.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #9ca3af; font-size: 0.875rem;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
    }
    {% else %}
    customerTypeCtx.parentElement.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #9ca3af; font-size: 0.875rem;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
    {% endif %}
  }

  // ============================================
  // 8ï¸âƒ£ ì¼ì • ë° ë¯¸íŒ… í™œë™ íˆíŠ¸ë§µ (Calendar Heatmap)
  // ============================================
  const heatmapContainer = document.getElementById('activityHeatmap');
  if (heatmapContainer) {
    {% if daily_activity_heatmap %}
    const heatmapData = {{ daily_activity_heatmap|safe }};
    
    // ì²« ë‚ ì˜ ìš”ì¼ í™•ì¸í•˜ì—¬ ë¹ˆ ì¹¸ ì¶”ê°€
    if (heatmapData.length > 0) {
      const firstDate = new Date(heatmapData[0].date);
      const firstDayOfWeek = firstDate.getDay(); // 0=ì¼ìš”ì¼, 6=í† ìš”ì¼
      
      // ì¼ìš”ì¼ì´ ì•„ë‹ˆë©´ ë¹ˆ ì¹¸ ì¶”ê°€
      for (let i = 0; i < firstDayOfWeek; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.style.cssText = `
          aspect-ratio: 1;
          border-radius: 0.375rem;
          background-color: transparent;
        `;
        heatmapContainer.appendChild(emptyCell);
      }
    }
    
    // íˆíŠ¸ë§µ ì…€ ìƒì„±
    heatmapData.forEach(data => {
      const cell = document.createElement('div');
      cell.style.cssText = `
        aspect-ratio: 1;
        border-radius: 0.375rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        font-weight: 600;
        transition: transform 0.2s, box-shadow 0.2s;
      `;
      
      // ê°•ë„ì— ë”°ë¥¸ ìƒ‰ìƒ (0=íšŒìƒ‰, 9+=ì§„í•œ íŒŒë‘)
      const colors = [
        '#f1f5f9', '#dbeafe', '#bfdbfe', '#93c5fd', '#60a5fa',
        '#3b82f6', '#2563eb', '#1d4ed8', '#1e40af', '#1e3a8a'
      ];
      const intensity = Math.min(data.intensity, 9);
      cell.style.backgroundColor = colors[intensity];
      cell.style.color = intensity > 4 ? '#fff' : '#334155';
      
      const date = new Date(data.date);
      
      cell.innerHTML = `<div>${date.getDate()}</div>`;
      
      cell.title = `${data.date}: ${data.intensity}ê±´ì˜ í™œë™`;
      
      // ì¼ì •ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ í´ë¦­ ê°€ëŠ¥í•˜ê²Œ ì„¤ì •
      if (data.intensity > 0) {
        cell.style.cursor = 'pointer';
        cell.addEventListener('click', function() {
          window.location.href = `{% url 'reporting:schedule_list' %}?date_from=${data.date}&date_to=${data.date}`;
        });
      } else {
        cell.style.cursor = 'default';
      }
      
      cell.addEventListener('mouseenter', function() {
        if (data.intensity > 0) {
          this.style.transform = 'scale(1.1)';
          this.style.boxShadow = '0 4px 6px -1px rgb(0 0 0 / 0.2)';
        }
      });
      
      cell.addEventListener('mouseleave', function() {
        this.style.transform = 'scale(1)';
        this.style.boxShadow = 'none';
      });
      
      heatmapContainer.appendChild(cell);
    });

    // ë²”ë¡€ ì¶”ê°€
    const legend = document.createElement('div');
    legend.style.cssText = `
      margin-top: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      color: #64748b;
    `;
    legend.innerHTML = `
      <span>í™œë™ ê°•ë„:</span>
      <div style="display: flex; gap: 0.25rem;">
        <div style="width: 1rem; height: 1rem; background: #f1f5f9; border-radius: 0.25rem;"></div>
        <div style="width: 1rem; height: 1rem; background: #93c5fd; border-radius: 0.25rem;"></div>
        <div style="width: 1rem; height: 1rem; background: #3b82f6; border-radius: 0.25rem;"></div>
        <div style="width: 1rem; height: 1rem; background: #1e40af; border-radius: 0.25rem;"></div>
      </div>
      <span style="margin-left: 0.25rem;">ë‚®ìŒ â†’ ë†’ìŒ</span>
    `;
    heatmapContainer.parentElement.appendChild(legend);
    {% else %}
    heatmapContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 200px; color: #9ca3af; font-size: 0.875rem;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
    {% endif %}
  }
});

// ì œí’ˆë³„ ë§¤ì¶œ ì°¨íŠ¸
{% if product_chart_data %}
const productData = {{ product_chart_data|safe }};
if (productData.labels && productData.labels.length > 0) {
  const productCtx = document.getElementById('productSalesChart');
  if (productCtx) {
    new Chart(productCtx.getContext('2d'), {
      type: 'doughnut',
      data: {
        labels: productData.labels,
        datasets: [{
          data: productData.data,
          backgroundColor: [
            'rgba(16, 185, 129, 0.8)',   // green
            'rgba(59, 130, 246, 0.8)',   // blue
            'rgba(245, 158, 11, 0.8)',   // amber
            'rgba(239, 68, 68, 0.8)',    // red
            'rgba(139, 92, 246, 0.8)',   // purple
            'rgba(236, 72, 153, 0.8)',   // pink
            'rgba(14, 165, 233, 0.8)',   // sky
            'rgba(34, 197, 94, 0.8)',    // emerald
            'rgba(251, 146, 60, 0.8)',   // orange
            'rgba(168, 85, 247, 0.8)'    // violet
          ],
          borderColor: [
            'rgb(16, 185, 129)',
            'rgb(59, 130, 246)',
            'rgb(245, 158, 11)',
            'rgb(239, 68, 68)',
            'rgb(139, 92, 246)',
            'rgb(236, 72, 153)',
            'rgb(14, 165, 233)',
            'rgb(34, 197, 94)',
            'rgb(251, 146, 60)',
            'rgb(168, 85, 247)'
          ],
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            position: 'bottom',
            labels: {
              padding: 10,
              font: {
                size: 11
              }
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.parsed || 0;
                const percentage = productData.percentages[context.dataIndex];
                return label + ': ' + value.toLocaleString() + 'ì› (' + percentage + '%)';
              }
            }
          }
        }
      }
    });
  }
}
{% endif %}

// ========================================
// ê³ ê° ê¸°ë¡ ì¡°íšŒ ê¸°ëŠ¥
// ========================================
document.addEventListener('DOMContentLoaded', function() {
  const customerSearchInput = document.getElementById('customerSearchInput');
  const customerSearchResults = document.getElementById('customerSearchResults');
  const selectedCustomerInfo = document.getElementById('selectedCustomerInfo');
  const selectedCustomerName = document.getElementById('selectedCustomerName');
  const selectedCustomerCompany = document.getElementById('selectedCustomerCompany');
  const clearCustomerBtn = document.getElementById('clearCustomerBtn');
  const customerRecordsContainer = document.getElementById('customerRecordsContainer');
  const customerRecordsPlaceholder = document.getElementById('customerRecordsPlaceholder');
  
  let searchTimeout = null;
  let selectedFollowupId = null;
  
  // ê³ ê° ê²€ìƒ‰
  if (customerSearchInput) {
    customerSearchInput.addEventListener('input', function() {
      const query = this.value.trim();
      
      if (searchTimeout) {
        clearTimeout(searchTimeout);
      }
      
      if (query.length < 2) {
        customerSearchResults.style.display = 'none';
        return;
      }
      
      searchTimeout = setTimeout(function() {
        fetch(`/reporting/api/followups/autocomplete/?q=${encodeURIComponent(query)}`)
          .then(response => response.json())
          .then(data => {
            if (data.results && data.results.length > 0) {
              let html = '';
              data.results.forEach(item => {
                html += `
                  <div class="p-3 border-bottom cursor-pointer customer-search-item" 
                       data-id="${item.id}"
                       data-name="${item.customer_name || '-'}"
                       data-company="${item.company_name || ''} ${item.department_name || ''}"
                       style="cursor: pointer;">
                    <strong>${item.customer_name || '-'}</strong>
                    <small class="text-muted d-block">${item.company_name || ''} / ${item.department_name || ''}</small>
                  </div>
                `;
              });
              customerSearchResults.innerHTML = html;
              customerSearchResults.style.display = 'block';
              
              // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
              document.querySelectorAll('.customer-search-item').forEach(item => {
                item.addEventListener('click', function() {
                  selectCustomer(
                    this.dataset.id,
                    this.dataset.name,
                    this.dataset.company
                  );
                });
                item.addEventListener('mouseenter', function() {
                  this.style.backgroundColor = '#f0f9ff';
                });
                item.addEventListener('mouseleave', function() {
                  this.style.backgroundColor = '';
                });
              });
            } else {
              customerSearchResults.innerHTML = '<div class="p-3 text-muted">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
              customerSearchResults.style.display = 'block';
            }
          })
          .catch(err => {
            console.error('Search error:', err);
          });
      }, 300);
    });
  }
  
  // ê³ ê° ì„ íƒ
  function selectCustomer(id, name, company) {
    selectedFollowupId = id;
    customerSearchInput.value = '';
    customerSearchResults.style.display = 'none';
    
    selectedCustomerName.textContent = name;
    selectedCustomerCompany.textContent = company;
    selectedCustomerInfo.style.display = 'block';
    
    loadCustomerRecords(id);
  }
  
  // ê³ ê° ì„ íƒ í•´ì œ
  if (clearCustomerBtn) {
    clearCustomerBtn.addEventListener('click', function() {
      selectedFollowupId = null;
      selectedCustomerInfo.style.display = 'none';
      customerRecordsContainer.style.display = 'none';
      customerRecordsPlaceholder.style.display = 'block';
    });
  }
  
  // ê³ ê° ê¸°ë¡ ë¡œë“œ
  function loadCustomerRecords(followupId) {
    fetch(`/reporting/api/followups/${followupId}/records/`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          displayCustomerRecords(data);
        } else {
          alert(data.error || 'ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      })
      .catch(err => {
        console.error('Load records error:', err);
        alert('ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      });
  }
  
  // ê¸°ë¡ í‘œì‹œ
  function displayCustomerRecords(data) {
    customerRecordsPlaceholder.style.display = 'none';
    customerRecordsContainer.style.display = 'block';
    
    // ë™ë£Œ ê³ ê°ì´ê³  ê¸°ë¡ì´ ì—†ëŠ” ê²½ìš° ë©”ì‹œì§€ í‘œì‹œ
    if (!data.is_own_customer && data.delivery_count === 0 && data.quote_count === 0 && data.message) {
      document.getElementById('deliveryCount').textContent = '0ê±´';
      document.getElementById('totalDeliveryAmount').textContent = '0ì›';
      document.getElementById('quoteCount').textContent = '0ê±´';
      document.getElementById('totalQuoteAmount').textContent = '0ì›';
      
      const noRecordsMsg = `
        <div class="alert alert-info text-center py-4">
          <i class="fas fa-info-circle fa-2x mb-2"></i>
          <p class="mb-0">${data.message}</p>
        </div>
      `;
      document.getElementById('deliveryRecords').innerHTML = noRecordsMsg;
      document.getElementById('quoteRecords').innerHTML = noRecordsMsg;
      return;
    }
    
    // ë‚©í’ˆ ê¸°ë¡
    document.getElementById('deliveryCount').textContent = data.delivery_count + 'ê±´';
    document.getElementById('totalDeliveryAmount').textContent = formatCurrency(data.total_delivery_amount);
    
    const deliveryRecords = document.getElementById('deliveryRecords');
    if (data.deliveries.length > 0) {
      let html = '';
      data.deliveries.forEach(delivery => {
        const statusBadge = getStatusBadge(delivery.status_code);
        html += `
          <div class="mb-3 p-3 bg-light rounded">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div>
                <strong>${delivery.visit_date}</strong>
                <span class="ms-2 text-muted small"><i class="fas fa-user me-1"></i>${delivery.customer_name}</span>
                ${statusBadge}
              </div>
              <span class="text-success fw-bold">${formatCurrency(delivery.total_amount)}</span>
            </div>
            <div class="small">
              ${delivery.items.map(item => `
                <div class="d-flex justify-content-between py-1 border-bottom">
                  <span>${item.item_name} x ${item.quantity}</span>
                  <span>${formatCurrency(item.total_price)}</span>
                </div>
              `).join('')}
            </div>
            ${delivery.notes ? `<small class="text-muted mt-2 d-block"><i class="fas fa-sticky-note me-1"></i>${delivery.notes}</small>` : ''}
            <a href="/reporting/schedules/${delivery.id}/" class="btn btn-sm btn-outline-success mt-2">
              <i class="fas fa-external-link-alt me-1"></i>ìƒì„¸ë³´ê¸°
            </a>
          </div>
        `;
      });
      deliveryRecords.innerHTML = html;
    } else {
      deliveryRecords.innerHTML = '<p class="text-muted text-center py-4">ë‚©í’ˆ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>';
    }
    
    // ê²¬ì  ê¸°ë¡
    document.getElementById('quoteCount').textContent = data.quote_count + 'ê±´';
    document.getElementById('totalQuoteAmount').textContent = formatCurrency(data.total_quote_amount);
    
    const quoteRecords = document.getElementById('quoteRecords');
    if (data.quotes.length > 0) {
      let html = '';
      data.quotes.forEach(quote => {
        const statusBadge = getStatusBadge(quote.status_code);
        html += `
          <div class="mb-3 p-3 bg-light rounded">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div>
                <strong>${quote.visit_date}</strong>
                <span class="ms-2 text-muted small"><i class="fas fa-user me-1"></i>${quote.customer_name}</span>
                ${statusBadge}
              </div>
              <span class="text-primary fw-bold">${formatCurrency(quote.total_amount)}</span>
            </div>
            <div class="small">
              ${quote.items.map(item => `
                <div class="d-flex justify-content-between py-1 border-bottom">
                  <span>${item.item_name} x ${item.quantity}</span>
                  <span>${formatCurrency(item.total_price)}</span>
                </div>
              `).join('')}
            </div>
            ${quote.notes ? `<small class="text-muted mt-2 d-block"><i class="fas fa-sticky-note me-1"></i>${quote.notes}</small>` : ''}
            <a href="/reporting/schedules/${quote.id}/" class="btn btn-sm btn-outline-primary mt-2">
              <i class="fas fa-external-link-alt me-1"></i>ìƒì„¸ë³´ê¸°
            </a>
          </div>
        `;
      });
      quoteRecords.innerHTML = html;
    } else {
      quoteRecords.innerHTML = '<p class="text-muted text-center py-4">ê²¬ì  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>';
    }
  }
  
  // ê¸ˆì•¡ í¬ë§·
  function formatCurrency(amount) {
    return Math.round(amount).toLocaleString('ko-KR') + 'ì›';
  }
  
  // ìƒíƒœ ë±ƒì§€
  function getStatusBadge(status) {
    const badges = {
      'scheduled': '<span class="badge bg-warning">ì˜ˆì •</span>',
      'completed': '<span class="badge bg-success">ì™„ë£Œ</span>',
      'cancelled': '<span class="badge bg-danger">ì·¨ì†Œ</span>'
    };
    return badges[status] || `<span class="badge bg-secondary">${status}</span>`;
  }
  
  // ê²€ìƒ‰ê²°ê³¼ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
  document.addEventListener('click', function(e) {
    if (customerSearchResults && 
        !customerSearchResults.contains(e.target) && 
        !customerSearchInput.contains(e.target)) {
      customerSearchResults.style.display = 'none';
    }
  });
});
</script>
{% endblock %}
