{% extends "reporting/base.html" %}

{% block extra_css %}
<style>
/* í”„ë¦¬ë¯¸ì—„ ëŒ€ì‹œë³´ë“œ ë””ìì¸ */

/* í†µê³„ ì¹´ë“œ ê·¸ë¦¬ë“œ */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.stat-card {
  background: white;
  border-radius: 1.25rem;
  padding: 1.75rem;
  box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  cursor: pointer;
  border: 1px solid #e5e7eb;
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #6366f1, #8b5cf6);
  opacity: 0;
  transition: opacity 0.3s;
}

.stat-card:hover {
  transform: translateY(-8px);
  box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
}

.stat-card:hover::before {
  opacity: 1;
}

.stat-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 1.25rem;
}

.stat-icon {
  width: 64px;
  height: 64px;
  border-radius: 1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.75rem;
  color: white;
}

.stat-icon.primary { background: linear-gradient(135deg, #818cf8, #6366f1); }
.stat-icon.success { background: linear-gradient(135deg, #34d399, #10b981); }
.stat-icon.info { background: linear-gradient(135deg, #22d3ee, #06b6d4); }
.stat-icon.warning { background: linear-gradient(135deg, #fbbf24, #f59e0b); }
.stat-icon.purple { background: linear-gradient(135deg, #a78bfa, #9333ea); }

.stat-info {
  flex: 1;
  text-align: right;
}

.stat-label {
  font-size: 0.875rem;
  font-weight: 600;
  color: #6b7280;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 0.5rem;
}

.stat-value {
  font-size: 2.25rem;
  font-weight: 900;
  background: linear-gradient(135deg, #6366f1, #8b5cf6);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  line-height: 1;
}

.stat-subtitle {
  font-size: 0.75rem;
  color: #6b7280;
  margin-top: 0.25rem;
}

.stat-actions {
  display: flex;
  gap: 0.5rem;
  margin-top: 1.25rem;
}

.stat-btn {
  flex: 1;
  padding: 0.625rem;
  border-radius: 0.75rem;
  font-size: 0.75rem;
  font-weight: 600;
  border: 2px solid;
  text-align: center;
  text-decoration: none;
  transition: all 0.3s;
}

.stat-btn-primary {
  background: #6366f1;
  color: white;
  border-color: #6366f1;
}

.stat-btn-outline {
  background: transparent;
  color: #6366f1;
  border-color: #6366f1;
}

.stat-btn:hover {
  transform: scale(1.05);
}

/* ë¹ ë¥¸ ì•¡ì…˜ */
.quick-actions {
  background: white;
  border-radius: 1.25rem;
  padding: 2rem;
  margin-bottom: 2rem;
  box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
}

.section-title {
  font-size: 1.5rem;
  font-weight: 700;
  margin-bottom: 1.5rem;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.actions-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 1rem;
}

.action-btn {
  padding: 2rem 1.5rem;
  background: white;
  border: 2px solid #e5e7eb;
  border-radius: 1rem;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1rem;
  text-decoration: none;
  color: #374151;
  font-weight: 600;
  transition: all 0.3s;
}

.action-btn:hover {
  background: linear-gradient(135deg, #818cf8, #6366f1);
  color: white;
  border-color: #6366f1;
  transform: translateY(-6px);
}

.action-icon {
  font-size: 2.5rem;
}

/* ì„±ê³¼ ì§€í‘œ */
.performance-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.performance-card {
  border-radius: 1.25rem;
  padding: 2.5rem;
  color: white;
  text-align: center;
  position: relative;
  overflow: hidden;
}

.performance-icon {
  font-size: 3.5rem;
  margin-bottom: 1.25rem;
  opacity: 0.9;
}

.performance-value {
  font-size: 2.75rem;
  font-weight: 900;
  line-height: 1;
}

.performance-label {
  font-size: 1.125rem;
  opacity: 0.9;
  font-weight: 600;
  margin-top: 0.5rem;
}

.bg-success { background: linear-gradient(135deg, #10b981, #059669); }
.bg-info { background: linear-gradient(135deg, #06b6d4, #0891b2); }
.bg-warning { background: linear-gradient(135deg, #f59e0b, #d97706); }
.bg-primary { background: linear-gradient(135deg, #6366f1, #4f46e5); }

@media (max-width: 768px) {
  .stats-grid,
  .performance-grid {
    grid-template-columns: 1fr;
  }
  
  .actions-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  /* ì°¨íŠ¸ ê·¸ë¦¬ë“œ ëª¨ë°”ì¼ */
  div[style*="grid-template-columns: repeat(auto-fit, minmax(400px, 1fr))"] {
    grid-template-columns: 1fr !important;
  }
  
  /* ì¼ì • ì™„ë£Œìœ¨ & í™œë™ í†µê³„ ëª¨ë°”ì¼ */
  div[style*="grid-template-columns: 1fr 2fr"] {
    grid-template-columns: 1fr !important;
  }
}
</style>
{% endblock %}

{% block content %}
<!-- í†µê³„ ì¹´ë“œ -->
<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-header">
      <div class="stat-icon primary"><i class="fas fa-handshake"></i></div>
      <div class="stat-info">
        <div class="stat-label">ê³ ê° ì •ë³´</div>
        <div class="stat-value">{{ followup_count }}</div>
        <div class="stat-subtitle">ê±´</div>
      </div>
    </div>
    <div class="stat-actions">
      <a href="{% url 'reporting:followup_list' %}" class="stat-btn stat-btn-outline"><i class="fas fa-list"></i> ëª©ë¡</a>
      <a href="{% url 'reporting:followup_create' %}" class="stat-btn stat-btn-primary"><i class="fas fa-plus"></i> ì¶”ê°€</a>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-header">
      <div class="stat-icon success"><i class="fas fa-calendar-alt"></i></div>
      <div class="stat-info">
        <div class="stat-label">ì§„í–‰ ì¼ì •</div>
        <div class="stat-value">{{ schedule_count }}</div>
        <div class="stat-subtitle">ê±´</div>
      </div>
    </div>
    <div class="stat-actions">
      <a href="{% url 'reporting:schedule_list' %}" class="stat-btn stat-btn-outline"><i class="fas fa-list"></i> ëª©ë¡</a>
      <a href="{% url 'reporting:schedule_create' %}" class="stat-btn stat-btn-primary"><i class="fas fa-plus"></i> ì¶”ê°€</a>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-header">
      <div class="stat-icon info"><i class="fas fa-history"></i></div>
      <div class="stat-info">
        <div class="stat-label">ì˜ì—… ê¸°ë¡</div>
        <div class="stat-value">{{ sales_record_count }}</div>
        <div class="stat-subtitle">{{ current_year }}ë…„</div>
      </div>
    </div>
    <div class="stat-actions">
      <a href="{% url 'reporting:history_list' %}" class="stat-btn stat-btn-outline"><i class="fas fa-list"></i> ê¸°ë¡</a>
      <a href="{% url 'reporting:history_create' %}" class="stat-btn stat-btn-primary"><i class="fas fa-plus"></i> ì¶”ê°€</a>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-header">
      <div class="stat-icon warning"><i class="fas fa-won-sign"></i></div>
      <div class="stat-info">
        <div class="stat-label">ì´ ë‚©í’ˆ ê¸ˆì•¡</div>
        <div class="stat-value">
          {% load currency_filters %}
          {% if total_delivery_amount > 0 %}{{ total_delivery_amount|currency_format }}{% else %}0{% endif %}
        </div>
        <div class="stat-subtitle">{{ delivery_count }}ê±´ / {{ current_year }}ë…„</div>
      </div>
    </div>
    <div class="stat-actions">
      <a href="{% url 'reporting:history_list' %}?action_type=delivery_schedule" class="stat-btn stat-btn-primary" style="flex: 1 1 100%;"><i class="fas fa-truck"></i> ë‚©í’ˆ ê¸°ë¡</a>
    </div>
  </div>

  {% if request.is_hanagwahak %}
  <div class="stat-card">
    <div class="stat-header">
      <div class="stat-icon purple"><i class="fas fa-concierge-bell"></i></div>
      <div class="stat-info">
        <div class="stat-label">ì„œë¹„ìŠ¤</div>
        <div class="stat-value">{{ service_count }}</div>
        <div class="stat-subtitle">{{ current_year }}ë…„ / ì´ë²ˆ ë‹¬ {{ this_month_service_count }}ê±´</div>
      </div>
    </div>
    <div class="stat-actions">
      <a href="{% url 'reporting:history_list' %}?action_type=service" class="stat-btn stat-btn-outline"><i class="fas fa-list"></i> ëª©ë¡</a>
      <a href="{% url 'reporting:history_create' %}" class="stat-btn stat-btn-primary"><i class="fas fa-plus"></i> ì¶”ê°€</a>
    </div>
  </div>
  {% endif %}
</div>

<!-- ë¹ ë¥¸ ì•¡ì…˜ -->
<div class="quick-actions">
  <h2 class="section-title"><i class="fas fa-bolt"></i> ë¹ ë¥¸ ì•¡ì…˜</h2>
  <div class="actions-grid">
    <a href="{% url 'reporting:followup_create' %}" class="action-btn"><i class="fas fa-user-plus action-icon"></i><span>ìƒˆ ê³ ê° ì¶”ê°€</span></a>
    <a href="{% url 'reporting:schedule_create' %}" class="action-btn"><i class="fas fa-calendar-plus action-icon"></i><span>ì¼ì • ì¶”ê°€</span></a>
    <a href="{% url 'reporting:schedule_calendar' %}" class="action-btn"><i class="fas fa-calendar action-icon"></i><span>ìº˜ë¦°ë” ë³´ê¸°</span></a>
    <a href="{% url 'reporting:history_create' %}" class="action-btn"><i class="fas fa-plus-circle action-icon"></i><span>ì˜ì—… ê¸°ë¡</span></a>
    {% if request.is_hanagwahak %}
    <a href="{% url 'reporting:history_create' %}" class="action-btn"><i class="fas fa-concierge-bell action-icon"></i><span>ì„œë¹„ìŠ¤ ê¸°ë¡</span></a>
    {% endif %}
    <a href="{% url 'reporting:schedule_list' %}?status=scheduled" class="action-btn"><i class="fas fa-clock action-icon"></i><span>ì˜¤ëŠ˜ ì¼ì •</span></a>
  </div>
</div>

<!-- ì„±ê³¼ ì§€í‘œ -->
<h2 class="section-title"><i class="fas fa-trophy" style="color: #fbbf24;"></i> ì„±ê³¼ ì§€í‘œ ëŒ€ì‹œë³´ë“œ</h2>
<div class="performance-grid">
  <div class="performance-card bg-success">
    <i class="fas fa-trophy performance-icon"></i>
    <div class="performance-value">
      {% load currency_filters %}
      {{ monthly_revenue|currency_format|default:"0" }}ì›
    </div>
    <div class="performance-label">ì´ë²ˆ ë‹¬ ë‚©í’ˆì•¡</div>
  </div>

  <div class="performance-card bg-info">
    <i class="fas fa-handshake performance-icon"></i>
    <div class="performance-value">{{ monthly_meetings|default:"0" }}íšŒ</div>
    <div class="performance-label">ì´ë²ˆ ë‹¬ ë¯¸íŒ…</div>
  </div>

  <div class="performance-card bg-warning">
    <i class="fas fa-percentage performance-icon"></i>
    <div class="performance-value">{{ conversion_rate|floatformat:1|default:"0" }}%</div>
    <div class="performance-label">ë‚©í’ˆ ì „í™˜ìœ¨</div>
  </div>

  <div class="performance-card bg-primary">
    <i class="fas fa-chart-line performance-icon"></i>
    <div class="performance-value">{{ avg_deal_size|currency_format|default:"0" }}ì›</div>
    <div class="performance-label">í‰ê·  ê±°ë˜ ê·œëª¨</div>
  </div>
</div>

<!-- ğŸ“Š ìƒˆë¡œìš´ ë¶„ì„ ì°¨íŠ¸ ê·¸ë¦¬ë“œ -->
<h2 class="section-title" style="margin-top: 3rem;"><i class="fas fa-chart-bar" style="color: #6366f1;"></i> ì˜ì—… ë¶„ì„ ëŒ€ì‹œë³´ë“œ</h2>

<!-- 1í–‰: ë§¤ì¶œ ì¶”ì´ & ì˜ì—… í¼ë„ -->
<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
  <!-- 1. ë§¤ì¶œ ë° ë‚©í’ˆ ì¶”ì´ (Combo Chart) -->
  <div style="background: white; border-radius: 1.25rem; padding: 2rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);">
    <h3 class="section-title" style="font-size: 1.125rem; margin-bottom: 1.5rem;">
      <i class="fas fa-chart-area" style="color: #10b981;"></i> ë§¤ì¶œ ë° ë‚©í’ˆ ì¶”ì´ ({{ current_year }}ë…„)
    </h3>
    <div style="position: relative; height: 300px;">
      <canvas id="revenueDeliveryChart"></canvas>
    </div>
  </div>

  <!-- 2. ì˜ì—…í™œë™ í¼ë„ -->
  <div style="background: white; border-radius: 1.25rem; padding: 2rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);">
    <h3 class="section-title" style="font-size: 1.125rem; margin-bottom: 1.5rem;">
      <i class="fas fa-filter" style="color: #6366f1;"></i> ì˜ì—… ì „í™˜ í¼ë„
    </h3>
    <div style="position: relative; height: 300px;">
      <canvas id="salesFunnelChart"></canvas>
    </div>
  </div>
</div>

<!-- 2í–‰: ê³ ê°ì‚¬ë³„ ë§¤ì¶œ & ì„œë¹„ìŠ¤/ì˜ì—… íŠ¸ë Œë“œ -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
  <!-- 3. ê³ ê°ì‚¬ë³„ ë§¤ì¶œ ë¹„ì¤‘ (Doughnut) -->
  <div style="background: white; border-radius: 1.25rem; padding: 2rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);">
    <h3 class="section-title" style="font-size: 1.125rem; margin-bottom: 1.5rem;">
      <i class="fas fa-chart-pie" style="color: #f59e0b;"></i> ê³ ê°ì‚¬ë³„ ë§¤ì¶œ ë¹„ì¤‘ (Top 5)
    </h3>
    <div style="position: relative; height: 300px;">
      <canvas id="customerShareChart"></canvas>
    </div>
  </div>

  <!-- 4. ì˜ì—… í™œë™ ì¶”ì´ (Line Chart) -->
  <div style="background: white; border-radius: 1.25rem; padding: 2rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);">
    <h3 class="section-title" style="font-size: 1.125rem; margin-bottom: 1.5rem;">
      <i class="fas fa-chart-line" style="color: #8b5cf6;"></i> ì˜ì—… í™œë™ ì¶”ì´
    </h3>
    <div style="position: relative; height: 300px;">
      <canvas id="serviceVsSalesChart"></canvas>
    </div>
  </div>
</div>

<!-- 3í–‰: ê°œì¸ ì„±ê³¼ & ê³ ê° ìœ í˜•ë³„ -->
<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
  <!-- 5. ê°œì¸ ì„±ê³¼ ì§€í‘œ ì¶”ì„¸ (Multi Line) -->
  <div style="background: white; border-radius: 1.25rem; padding: 2rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);">
    <h3 class="section-title" style="font-size: 1.125rem; margin-bottom: 1.5rem;">
      <i class="fas fa-user-chart" style="color: #06b6d4;"></i> ê°œì¸ ì„±ê³¼ ì§€í‘œ ì¶”ì„¸
    </h3>
    <div style="position: relative; height: 250px;">
      <canvas id="personalPerformanceChart"></canvas>
    </div>
  </div>

  <!-- 6. ê³ ê° ìœ í˜•ë³„ í†µê³„ (Grouped Bar) -->
  <div style="background: white; border-radius: 1.25rem; padding: 2rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);">
    <h3 class="section-title" style="font-size: 1.125rem; margin-bottom: 1.5rem;">
      <i class="fas fa-users" style="color: #ef4444;"></i> ê³ ê° ìœ í˜•ë³„ í†µê³„
    </h3>
    <div style="position: relative; height: 250px;">
      <canvas id="customerTypeChart"></canvas>
    </div>
  </div>
</div>

<!-- 4í–‰: í™œë™ íˆíŠ¸ë§µ -->
<div style="background: white; border-radius: 1.25rem; padding: 2rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); margin-bottom: 2rem;">
  <h3 class="section-title" style="font-size: 1.125rem; margin-bottom: 1.5rem;">
    <i class="fas fa-calendar-check" style="color: #10b981;"></i> ì¼ì • ë° ë¯¸íŒ… í™œë™ íˆíŠ¸ë§µ (ìµœê·¼ 30ì¼)
  </h3>
  <div id="activityHeatmap" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem;">
    <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  
  // ============================================
  // 1ï¸âƒ£ ë§¤ì¶œ ë° ë‚©í’ˆ ì¶”ì´ (Combo Chart: Bar + Line)
  // ============================================
  const revenueDeliveryCtx = document.getElementById('revenueDeliveryChart');
  if (revenueDeliveryCtx) {
    {% if monthly_delivery_stats %}
    const months = {{ monthly_delivery_stats.labels|safe }};
    const deliveryAmounts = {{ monthly_delivery_stats.amounts|safe }};
    const deliveryCounts = {{ monthly_delivery_stats.counts|safe }};

    new Chart(revenueDeliveryCtx, {
      type: 'bar',
      data: {
        labels: months,
        datasets: [
          {
            type: 'bar',
            label: 'ë‚©í’ˆ ê¸ˆì•¡ (ë°±ë§Œì›)',
            data: deliveryAmounts.map(v => v / 1000000),
            backgroundColor: 'rgba(99, 102, 241, 0.7)',
            borderColor: 'rgba(99, 102, 241, 1)',
            borderWidth: 1,
            borderRadius: 6,
            yAxisID: 'y-amount'
          },
          {
            type: 'line',
            label: 'ë‚©í’ˆ ê±´ìˆ˜',
            data: deliveryCounts,
            borderColor: 'rgba(16, 185, 129, 1)',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            borderWidth: 3,
            tension: 0.4,
            fill: false,
            yAxisID: 'y-count',
            pointRadius: 5,
            pointBackgroundColor: '#10b981'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { display: true, position: 'top' },
          tooltip: {
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) label += ': ';
                if (context.datasetIndex === 0) {
                  label += context.parsed.y.toFixed(0) + 'ë°±ë§Œì›';
                } else {
                  label += context.parsed.y + 'ê±´';
                }
                return label;
              }
            }
          }
        },
        scales: {
          'y-amount': {
            type: 'linear',
            position: 'left',
            beginAtZero: true,
            title: { display: true, text: 'ë‚©í’ˆ ê¸ˆì•¡ (ë°±ë§Œì›)', color: '#6366f1' },
            ticks: { color: '#6366f1' }
          },
          'y-count': {
            type: 'linear',
            position: 'right',
            beginAtZero: true,
            title: { display: true, text: 'ë‚©í’ˆ ê±´ìˆ˜ (ê±´)', color: '#10b981' },
            ticks: { color: '#10b981' },
            grid: { drawOnChartArea: false }
          }
        }
      }
    });
    {% endif %}
  }

  // ============================================
  // 2ï¸âƒ£ ì˜ì—…í™œë™ í¼ë„ (Funnel Chart)
  // ============================================
  const salesFunnelCtx = document.getElementById('salesFunnelChart');
  if (salesFunnelCtx) {
    {% if sales_funnel %}
    const funnelStages = {{ sales_funnel.stages|safe }};
    const funnelValues = {{ sales_funnel.values|safe }};
    const funnelColors = ['#6366f1', '#8b5cf6', '#10b981', '#f59e0b'];

    new Chart(salesFunnelCtx, {
      type: 'bar',
      data: {
        labels: funnelStages,
        datasets: [{
          label: 'ê±´ìˆ˜',
          data: funnelValues,
          backgroundColor: funnelColors,
          borderRadius: 8
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(context) {
                const percentage = funnelValues[0] > 0 ? ((context.parsed.x / funnelValues[0]) * 100).toFixed(1) : 0;
                return context.parsed.x + 'ê±´ (' + percentage + '%)';
              }
            }
          }
        },
        scales: {
          x: { beginAtZero: true, title: { display: true, text: 'ê±´ìˆ˜' } }
        }
      }
    });
    {% endif %}
  }

  // ============================================
  // 3ï¸âƒ£ ê³ ê°ì‚¬ë³„ ë§¤ì¶œ ë¹„ì¤‘ (Doughnut Chart)
  // ============================================
  const customerShareCtx = document.getElementById('customerShareChart');
  if (customerShareCtx) {
    {% if customer_distribution.labels|length > 0 %}
    const topCustomers = {{ customer_distribution.labels|safe }};
    const customerRevenues = {{ customer_distribution.data|safe }};

    new Chart(customerShareCtx, {
      type: 'doughnut',
      data: {
        labels: topCustomers,
        datasets: [{
          data: customerRevenues,
          backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#06b6d4', '#8b5cf6', '#94a3b8'],
          borderWidth: 2,
          borderColor: '#fff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'right' },
          tooltip: {
            callbacks: {
              label: function(context) {
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const value = context.parsed;
                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                return context.label + ': ' + (value / 1000000).toFixed(0) + 'ë°±ë§Œì› (' + percentage + '%)';
              }
            }
          }
        }
      }
    });
    {% else %}
    // ë°ì´í„° ì—†ìŒ ë©”ì‹œì§€
    customerShareCtx.parentElement.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #9ca3af; font-size: 0.875rem;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
    {% endif %}
  }

  // ============================================
  // 4ï¸âƒ£ ì˜ì—… í™œë™ ì¶”ì´ (Line Chart)
  // ============================================
  const serviceVsSalesCtx = document.getElementById('serviceVsSalesChart');
  if (serviceVsSalesCtx) {
    {% if monthly_activity_breakdown.labels|length > 0 %}
    const months = {{ monthly_activity_breakdown.labels|safe }};
    const salesActivities = {{ monthly_activity_breakdown.sales|safe }};

    new Chart(serviceVsSalesCtx, {
      type: 'line',
      data: {
        labels: months,
        datasets: [
          {
            label: 'ì˜ì—… í™œë™',
            data: salesActivities,
            backgroundColor: 'rgba(99, 102, 241, 0.1)',
            borderColor: 'rgba(99, 102, 241, 1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointRadius: 5,
            pointBackgroundColor: '#6366f1',
            pointBorderColor: '#fff',
            pointBorderWidth: 2
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(context) {
                return 'ì˜ì—… í™œë™: ' + context.parsed.y + 'ê±´';
              }
            }
          }
        },
        scales: {
          y: { 
            beginAtZero: true,
            title: { display: true, text: 'í™œë™ ê±´ìˆ˜' }
          }
        }
      }
    });
    {% else %}
    serviceVsSalesCtx.parentElement.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #9ca3af; font-size: 0.875rem;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
    {% endif %}
  }

  // ============================================
  // 5ï¸âƒ£ ê°œì¸ ì„±ê³¼ ì§€í‘œ ì¶”ì„¸ (Multi-Line Chart)
  // ============================================
  const personalPerformanceCtx = document.getElementById('personalPerformanceChart');
  if (personalPerformanceCtx) {
    {% if performance_trends.labels|length > 0 %}
    const months = {{ performance_trends.labels|safe }};
    const deliveryAmounts = {{ performance_trends.delivery_amount|safe }};
    const conversionRates = {{ performance_trends.conversion_rate|safe }};
    const avgDealSizes = {{ performance_trends.avg_deal_size|safe }};

    new Chart(personalPerformanceCtx, {
      type: 'line',
      data: {
        labels: months,
        datasets: [
          {
            label: 'ë‚©í’ˆì•¡ (ë°±ë§Œì›)',
            data: deliveryAmounts,
            borderColor: '#6366f1',
            backgroundColor: 'rgba(99, 102, 241, 0.1)',
            borderWidth: 3,
            tension: 0.4,
            fill: true,
            yAxisID: 'y-amount'
          },
          {
            label: 'ì „í™˜ìœ¨ (%)',
            data: conversionRates,
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            borderWidth: 3,
            tension: 0.4,
            fill: false,
            yAxisID: 'y-rate'
          },
          {
            label: 'í‰ê·  ê±°ë˜ ê·œëª¨ (ë°±ë§Œì›)',
            data: avgDealSizes,
            borderColor: '#f59e0b',
            backgroundColor: 'rgba(245, 158, 11, 0.1)',
            borderWidth: 3,
            tension: 0.4,
            fill: false,
            yAxisID: 'y-size'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { display: true, position: 'top' }
        },
        scales: {
          'y-amount': {
            type: 'linear',
            position: 'left',
            beginAtZero: true,
            title: { display: true, text: 'ë‚©í’ˆì•¡ (ë°±ë§Œì›)', color: '#6366f1' }
          },
          'y-rate': {
            type: 'linear',
            position: 'right',
            beginAtZero: true,
            max: 100,
            title: { display: true, text: 'ì „í™˜ìœ¨ (%)', color: '#10b981' },
            grid: { drawOnChartArea: false }
          },
          'y-size': {
            type: 'linear',
            position: 'right',
            beginAtZero: true,
            display: false
          }
        }
      }
    });
    {% else %}
    personalPerformanceCtx.parentElement.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #9ca3af; font-size: 0.875rem;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
    {% endif %}
  }

  // ============================================
  // 6ï¸âƒ£ ê³ ê° ìœ í˜•ë³„ í†µê³„ (Grouped Bar Chart)
  // ============================================
  const customerTypeCtx = document.getElementById('customerTypeChart');
  if (customerTypeCtx) {
    {% if customer_type_stats.labels|length > 0 %}
    const customerTypes = {{ customer_type_stats.labels|safe }};
    const revenues = {{ customer_type_stats.revenue|safe }};
    const counts = {{ customer_type_stats.count|safe }};

    // ë°ì´í„°ê°€ ëª¨ë‘ 0ì¸ì§€ í™•ì¸
    const hasData = revenues.some(v => v > 0) || counts.some(c => c > 0);
    
    if (hasData) {
      new Chart(customerTypeCtx, {
        type: 'bar',
        data: {
          labels: customerTypes,
          datasets: [
            {
              label: 'ë§¤ì¶œ (ë°±ë§Œì›)',
              data: revenues,
              backgroundColor: 'rgba(99, 102, 241, 0.7)',
              borderColor: 'rgba(99, 102, 241, 1)',
              borderWidth: 1,
              borderRadius: 6
            },
            {
              label: 'ê±°ë˜ ê±´ìˆ˜',
              data: counts,
              backgroundColor: 'rgba(16, 185, 129, 0.7)',
              borderColor: 'rgba(16, 185, 129, 1)',
              borderWidth: 1,
              borderRadius: 6
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true, position: 'top' }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    } else {
      customerTypeCtx.parentElement.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #9ca3af; font-size: 0.875rem;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
    }
    {% else %}
    customerTypeCtx.parentElement.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #9ca3af; font-size: 0.875rem;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
    {% endif %}
  }

  // ============================================
  // 7ï¸âƒ£ ì¼ì • ë° ë¯¸íŒ… í™œë™ íˆíŠ¸ë§µ (Calendar Heatmap)
  // ============================================
  const heatmapContainer = document.getElementById('activityHeatmap');
  if (heatmapContainer) {
    {% if daily_activity_heatmap|length > 0 %}
    const heatmapData = {{ daily_activity_heatmap|safe }};
    
    // íˆíŠ¸ë§µ ì…€ ìƒì„±
    heatmapData.forEach(data => {
      const cell = document.createElement('div');
      cell.style.cssText = `
        aspect-ratio: 1;
        border-radius: 0.375rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
      `;
      
      // ê°•ë„ì— ë”°ë¥¸ ìƒ‰ìƒ (0=íšŒìƒ‰, 9+=ì§„í•œ íŒŒë‘)
      const colors = [
        '#f1f5f9', '#dbeafe', '#bfdbfe', '#93c5fd', '#60a5fa',
        '#3b82f6', '#2563eb', '#1d4ed8', '#1e40af', '#1e3a8a'
      ];
      const intensity = Math.min(data.intensity, 9);
      cell.style.backgroundColor = colors[intensity];
      cell.style.color = intensity > 4 ? '#fff' : '#334155';
      
      const date = new Date(data.date);
      const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
      
      cell.innerHTML = `
        <div style="font-size: 0.625rem; opacity: 0.8;">${dayNames[data.day_of_week]}</div>
        <div>${date.getDate()}</div>
      `;
      
      cell.title = `${data.date}: ${data.intensity}ê±´ì˜ í™œë™`;
      
      cell.addEventListener('mouseenter', function() {
        this.style.transform = 'scale(1.1)';
        this.style.boxShadow = '0 4px 6px -1px rgb(0 0 0 / 0.2)';
      });
      
      cell.addEventListener('mouseleave', function() {
        this.style.transform = 'scale(1)';
        this.style.boxShadow = 'none';
      });
      
      heatmapContainer.appendChild(cell);
    });

    // ë²”ë¡€ ì¶”ê°€
    const legend = document.createElement('div');
    legend.style.cssText = `
      margin-top: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      color: #64748b;
    `;
    legend.innerHTML = `
      <span>í™œë™ ê°•ë„:</span>
      <div style="display: flex; gap: 0.25rem;">
        <div style="width: 1rem; height: 1rem; background: #f1f5f9; border-radius: 0.25rem;"></div>
        <div style="width: 1rem; height: 1rem; background: #93c5fd; border-radius: 0.25rem;"></div>
        <div style="width: 1rem; height: 1rem; background: #3b82f6; border-radius: 0.25rem;"></div>
        <div style="width: 1rem; height: 1rem; background: #1e40af; border-radius: 0.25rem;"></div>
      </div>
      <span style="margin-left: 0.25rem;">ë‚®ìŒ â†’ ë†’ìŒ</span>
    `;
    heatmapContainer.parentElement.appendChild(legend);
    {% else %}
    heatmapContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 200px; color: #9ca3af; font-size: 0.875rem;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
    {% endif %}
  }
});
</script>
{% endblock %}
