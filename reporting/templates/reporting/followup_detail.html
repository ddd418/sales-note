{% extends "reporting/base.html" %}
{% load humanize %}
{% block title %}{{ page_title }} - ì˜ì—… ë³´ê³ 
ì‹œìŠ¤í…œ{% endblock %}{% block content %}
<style>
/* Followup Detail Dark Mode Styles */
.alert-light {
  background: var(--surface-hover) !important;
  color: var(--text-primary) !important;
  border-color: var(--border) !important;
}

.alert-light h5 {
  color: var(--text-primary) !important;
}

.alert-light .text-muted {
  color: var(--text-muted) !important;
}

/* Info Display Boxes */
.bg-light.rounded.border,
.p-2.bg-light.rounded.border,
.p-3.bg-light.rounded.border {
  background: var(--surface-hover) !important;
  border-color: var(--border) !important;
  color: var(--text-primary) !important;
}

/* Card Body Text */
.card-body {
  color: var(--text-primary);
}

.card-body h3 {
  color: var(--primary) !important;
}

.card-body .form-label {
  color: var(--text-muted) !important;
}

.card-body a {
  color: var(--primary);
}

.card-body a:hover {
  color: var(--primary-hover);
}

/* Nested cards inside card-body */
.card-body .card {
  background: var(--surface-hover) !important;
}

.card-body .card-body {
  background: transparent !important;
}

/* Card header bg-white override */
.card-header.bg-white {
  background: var(--surface) !important;
}
</style>
<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-10">
      <!-- ë¶€ì„œ ì •ë³´ ë°°ë„ˆ (ë¶€ì„œê°€ ìˆëŠ” ê²½ìš°) -->
      {% if department %}
      <div class="alert alert-light border mb-3" style="border-radius: 12px;">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h5 class="mb-1">
              <i class="fas fa-building me-2 text-primary"></i>
              {{ company.name|default:"ì—…ì²´ëª… ë¯¸ì •" }} - {{ department.name }}
            </h5>
            <small class="text-muted">
              <i class="fas fa-users me-1"></i>ì†Œì† ê³ ê°:
              {% for f in department_followups %}
                <span class="badge {% if f.id == followup.id %}bg-primary{% else %}bg-secondary{% endif %} me-1">
                  {% if f.id != followup.id %}
                  <a href="{% url 'reporting:followup_detail' f.id %}" class="text-white text-decoration-none">{{ f.customer_name }}</a>
                  {% else %}
                  {{ f.customer_name }}
                  {% endif %}
                </span>
              {% endfor %}
            </small>
          </div>
          <span class="badge bg-info">ë¶€ì„œ í†µí•© ë³´ê¸°</span>
        </div>
      </div>
      {% endif %}
      
      <!-- í—¤ë” ì„¹ì…˜ -->
      <div
        class="page-header d-flex justify-content-between align-items-center mb-4"
      >
        <h1 class="page-title mb-0">
          {{ followup.customer_name|default:"ê³ ê°ëª… ë¯¸ì •" }} ê³ ê° ì •ë³´
          {% if not is_owner %}
          <span class="badge bg-info ms-2" style="font-size: 0.6rem;">
            <i class="fas fa-users me-1"></i>{{ owner_info.username }} ë‹´ë‹¹
          </span>
          {% endif %}
        </h1>
        <div>
          {% if followup.email and user.is_authenticated and user.userprofile.gmail_email %}
          <a
            href="{% url 'reporting:send_email_from_mailbox_with_followup' followup.pk %}"
            class="btn btn-success me-2"
          >
            <i class="fas fa-envelope me-1"></i>ë©”ì¼ ë³´ë‚´ê¸°
          </a>
          {% endif %}
          {% if can_modify %}
          <a
            href="{% url 'reporting:followup_edit' followup.pk %}"
            class="btn btn-primary me-2"
          >
            <i class="fas fa-edit me-1"></i>ìˆ˜ì •
          </a>
          <a
            href="{% url 'reporting:followup_delete' followup.pk %}"
            class="btn btn-danger"
          >
            <i class="fas fa-trash-alt me-1"></i>ì‚­ì œ
          </a>
          {% endif %}
        </div>
      </div>
      <!-- ìƒì„¸ ì •ë³´ ì¹´ë“œ -->
      <div class="card">
        <div class="card-body">
          <div class="row">
            <!-- ê¸°ë³¸ ì •ë³´ ì„¹ì…˜ -->
            <div class="col-md-6">
              <h3 class="mb-3 text-primary">
                <i class="fas fa-user me-2"></i>ê¸°ë³¸ ì •ë³´
              </h3>
              <div class="mb-3">
                <label class="form-label text-muted">ê³ ê°ëª…</label>
                <div class="p-2 bg-light rounded border">
                  {{ followup.customer_name|default:"ê³ ê°ëª… ë¯¸ì •" }}
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label text-muted">ì—…ì²´/í•™êµëª…</label>
                <div class="p-2 bg-light rounded border">
                  {{ followup.company|default:"ì—…ì²´ëª… ë¯¸ì •" }}
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label text-muted">ë¶€ì„œ/ì—°êµ¬ì‹¤ëª…</label>
                <div class="p-2 bg-light rounded border">
                  {{ followup.department|default:"ë¶€ì„œëª… ë¯¸ì •" }}
                </div>
              </div>
              {% if followup.phone_number %}
              <div class="mb-3">
                <label class="form-label text-muted">í•¸ë“œí° ë²ˆí˜¸</label>
                <div class="p-2 bg-light rounded border">
                  <i class="fas fa-phone me-1"></i>
                  {{ followup.phone_number }}
                </div>
              </div>
              {% endif %} {% if followup.email %}
              <div class="mb-3">
                <label class="form-label text-muted">ë©”ì¼ ì£¼ì†Œ</label>
                <div class="p-2 bg-light rounded border">
                  <i class="fas fa-envelope me-1"></i>
                  <a
                    href="mailto:{{ followup.email }}"
                    class="text-decoration-none"
                    >{{ followup.email }}</a
                  >
                </div>
                {% if user.userprofile.gmail_email %}
                <a href="{% url 'reporting:send_email_from_mailbox_with_followup' followup.pk %}" 
                   class="btn btn-sm btn-success mt-2" style="color: white !important;">
                  <i class="fas fa-paper-plane me-1"></i>ë©”ì¼ ë³´ë‚´ê¸°
                </a>
                {% endif %}
              </div>
              </div>
              {% endif %} {% if followup.manager %}
              <div class="mb-3">
                <label class="form-label text-muted">ì±…ì„ì</label>
                <div class="p-2 bg-light rounded border">
                  <i class="fas fa-user-tie me-1"></i>
                  {{ followup.manager }}
                </div>
              </div>
              {% endif %}

              <div class="mb-3">
                <label class="form-label text-muted">ë‹´ë‹¹ì</label>
                <div class="p-2 {% if is_owner %}bg-light{% else %}bg-info bg-opacity-10{% endif %} rounded border">
                  <i class="fas fa-user me-1"></i>
                  {{followup.user.username}}
                  {% if not is_owner %}
                  <span class="badge bg-info ms-2">ë™ë£Œ ê³ ê°</span>
                  {% endif %}
                </div>
              </div>
              
              <!-- ìš°ì„ ìˆœìœ„ í‘œì‹œ -->
              <div class="mb-3">
                <label class="form-label text-muted">
                  <i class="fas fa-flag me-1"></i>ìš°ì„ ìˆœìœ„
                </label>
                <div class="p-2 bg-light rounded border">
                  <span
                    class="badge {% if followup.priority == 'urgent' %}bg-danger {% elif followup.priority == 'followup' %}bg-warning {% elif followup.priority == 'scheduled' %}bg-info {% else %}bg-secondary {% endif %}"
                  >
                    {% if followup.priority == 'urgent' %}
                      ğŸš¨ ê¸´ê¸‰
                    {% elif followup.priority == 'followup' %}
                      â° íŒ”ë¡œì—…
                    {% elif followup.priority == 'scheduled' %}
                      ğŸ“… ì˜ˆì •
                    {% else %}
                      {{ followup.get_priority_display }}
                    {% endif %}
                  </span>
                </div>
              </div>
              
              <div class="mb-3">
                <label class="form-label text-muted">ìƒì„±ì¼</label>
                <div class="p-2 bg-light rounded border">
                  <i class="fas fa-calendar-plus me-1"></i>
                  {{followup.created_at|date:"Yë…„ mì›” dì¼ H:i" }}
                </div>
              </div>
            </div>
          </div>
          <!-- ì¶”ê°€ ì •ë³´ ì„¹ì…˜ -->
          {% if followup.address %}
          <div class="row mt-4">
            <div class="col-12">
              <h3 class="mb-3 text-info">
                <i class="fas fa-map-marker-alt me-2"></i>ì¶”ê°€ ì •ë³´
              </h3>
              <div class="mb-3">
                <label class="form-label text-muted">ìƒì„¸ì£¼ì†Œ</label>
                <div class="p-3 bg-light rounded border">
                  <i class="fas fa-map-marker-alt me-1"></i>
                  {{followup.address}}
                </div>
              </div>
            </div>
          </div>
          {% endif %}

          <!-- ìƒì„¸ ë‚´ìš© -->
          {% if followup.notes %}
          <div class="row mt-4">
            <div class="col-12">
              <h3 class="mb-3 text-info">
                <i class="fas fa-file-text me-2"></i>ìƒì„¸ ë‚´ìš©
              </h3>
              <div class="p-3 bg-light rounded border">
                <i class="fas fa-quote-left me-1"></i>
                {{ followup.notes|linebreaks }}
              </div>
            </div>
          </div>
          {% endif %}

          <!-- ë©”íƒ€ ì •ë³´ -->
          <div class="row mt-4">
            <div class="col-12">
              <div class="border-top pt-3">
                <small class="text-muted">
                  <i class="fas fa-info-circle me-1"></i>
                  ê³ ê° ì •ë³´ ID: {{followup.pk }} | ìƒì„±:
                  {{followup.created_at|date:"Y-m-d H:i"}} | ìˆ˜ì •:
                  {{followup.updated_at|date:"Y-m-d H:i" }}
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ë°ì´í„° í•„í„° ì„¹ì…˜ -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card border-primary">
        <div class="card-header bg-primary bg-opacity-10">
          <h5 class="card-title mb-0">
            <i class="fas fa-filter me-2"></i>ë°ì´í„° í•„í„°
          </h5>
        </div>
        <div class="card-body">
          <form method="get" class="row g-3 align-items-end">
            <div class="col-md-4">
              <label class="form-label fw-bold">ë°ì´í„° ë²”ìœ„</label>
              <div class="btn-group w-100" role="group">
                <input type="radio" class="btn-check" name="data_filter" id="filter_me" value="me" 
                       {% if data_filter == 'me' or not data_filter %}checked{% endif %} onchange="this.form.submit()">
                <label class="btn btn-outline-primary" for="filter_me">
                  <i class="fas fa-user me-1"></i>ë‚˜
                </label>
                
                <input type="radio" class="btn-check" name="data_filter" id="filter_all" value="all"
                       {% if data_filter == 'all' %}checked{% endif %} onchange="this.form.submit()">
                <label class="btn btn-outline-primary" for="filter_all">
                  <i class="fas fa-users me-1"></i>ì „ì²´
                </label>
              </div>
            </div>
            
            {% if company_users %}
            <div class="col-md-4">
              <label class="form-label fw-bold">íŠ¹ì • ì§ì› ì„ íƒ</label>
              <select name="filter_user" class="form-select" onchange="document.querySelector('#filter_user_radio').checked = true; this.form.submit();">
                <option value="">-- ì§ì› ì„ íƒ --</option>
                {% for user in company_users %}
                <option value="{{ user.id }}" {% if filter_user_id == user.id|stringformat:"s" %}selected{% endif %}>
                  {{ user.get_full_name|default:user.username }}
                </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
              <div class="form-check">
                <input type="radio" class="btn-check" name="data_filter" id="filter_user_radio" value="user"
                       {% if data_filter == 'user' %}checked{% endif %}>
                <label class="btn btn-outline-secondary btn-sm" for="filter_user_radio">
                  <i class="fas fa-user-check me-1"></i>ì„ íƒ ì ìš©
                </label>
              </div>
            </div>
            {% endif %}
            
            <div class="col-md-2">
              <a href="{% url 'reporting:followup_detail' followup.pk %}" class="btn btn-outline-secondary w-100">
                <i class="fas fa-undo me-1"></i>ì´ˆê¸°í™”
              </a>
            </div>
          </form>
          
          <!-- í˜„ì¬ í•„í„° ìƒíƒœ í‘œì‹œ -->
          <div class="mt-3">
            <span class="badge bg-info fs-6">
              <i class="fas fa-eye me-1"></i>
              í˜„ì¬ ë³´ê¸°: 
              {% if data_filter == 'all' %}
                ì „ì²´ ì§ì› ë°ì´í„°
              {% elif data_filter == 'user' and selected_filter_user %}
                {{ selected_filter_user.get_full_name|default:selected_filter_user.username }} ë°ì´í„°
              {% else %}
                ë‚˜ì˜ ë°ì´í„°
              {% endif %}
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ë‚©í’ˆ ìƒí’ˆ ëª©ë¡ ì„¹ì…˜ -->
  {% if delivered_items %}
  <div class="row mt-4">
    <div class="col-12">
      <div class="card" style="background-color: hsl(222, 47%, 14%); border-color: hsl(217, 33%, 22%);">
        <div class="card-header" style="background-color: hsl(222, 47%, 11%); border-bottom: 1px solid hsl(217, 33%, 22%);">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0" style="color: hsl(0, 0%, 95%);">
              <i class="fas fa-box-open me-2"></i>ë‚©í’ˆ ìƒí’ˆ ëª©ë¡
              {% if data_filter == 'all' %}<small style="color: hsl(215, 20%, 65%)">(ì „ì²´)</small>
              {% elif data_filter == 'user' and selected_filter_user %}<small style="color: hsl(215, 20%, 65%)">({{ selected_filter_user.username }})</small>
              {% else %}<small style="color: hsl(215, 20%, 65%)">(ë‚˜)</small>{% endif %}
            </h5>
            <div>
              <span class="badge bg-primary me-2">ì´ {{ delivery_stats.total_items }}ê±´</span>
              <span class="badge bg-success me-2">ìˆ˜ëŸ‰ {{ delivery_stats.total_quantity|floatformat:0 }}</span>
              <span class="badge bg-info">ì´ì•¡ {{ delivery_stats.total_revenue|floatformat:0|intcomma }}ì›</span>
            </div>
          </div>
        </div>
        <div class="card-body">
          {% if delivered_items %}
          <div class="table-responsive">
            <table class="table table-hover table-sm" style="color: hsl(0, 0%, 90%);">
              <thead style="background-color: hsl(222, 47%, 18%); border-bottom: 2px solid hsl(217, 33%, 22%);">
                <tr>
                  <th style="width: 12%; color: hsl(0, 0%, 95%); border-color: hsl(217, 33%, 22%);">ë‚©í’ˆì¼</th>
                  {% if department %}
                  <th style="width: 12%; color: hsl(0, 0%, 95%); border-color: hsl(217, 33%, 22%);">ê³ ê°</th>
                  {% endif %}
                  <th style="width: {% if department %}25{% else %}30{% endif %}%; color: hsl(0, 0%, 95%); border-color: hsl(217, 33%, 22%);">í’ˆëª©ëª…</th>
                  <th style="width: 8%; color: hsl(0, 0%, 95%); border-color: hsl(217, 33%, 22%);" class="text-end">ìˆ˜ëŸ‰</th>
                  <th style="width: 10%; color: hsl(0, 0%, 95%); border-color: hsl(217, 33%, 22%);" class="text-end">ë‹¨ê°€</th>
                  <th style="width: 13%; color: hsl(0, 0%, 95%); border-color: hsl(217, 33%, 22%);" class="text-end">ì´ì•¡</th>
                  <th style="width: 10%; color: hsl(0, 0%, 95%); border-color: hsl(217, 33%, 22%);" class="text-center">ì„¸ê¸ˆê³„ì‚°ì„œ</th>
                  <th style="width: 10%; color: hsl(0, 0%, 95%); border-color: hsl(217, 33%, 22%);" class="text-center">ì¼ì •</th>
                </tr>
              </thead>
              <tbody>
                {% for item in delivered_items %}
                <tr style="border-color: hsl(217, 33%, 22%);">
                  <td style="border-color: hsl(217, 33%, 22%);">
                    {% if item.schedule.visit_date %}
                      {{ item.schedule.visit_date|date:"Y-m-d" }}
                    {% else %}
                      <span style="color: hsl(215, 20%, 65%);">ë‚ ì§œ ë¯¸ì •</span>
                    {% endif %}
                  </td>
                  {% if department %}
                  <td style="border-color: hsl(217, 33%, 22%);">
                    <span class="badge {% if item.schedule.followup.id == followup.id %}bg-primary{% else %}bg-secondary{% endif %}">
                      {{ item.schedule.followup.customer_name|default:"-" }}
                    </span>
                  </td>
                  {% endif %}
                  <td style="border-color: hsl(217, 33%, 22%);">
                    <strong>{{ item.item_name }}</strong>
                    {% if item.product %}
                      <br>
                      <small style="color: hsl(215, 20%, 65%);">{{ item.product.specification|default:"" }}</small>
                    {% endif %}
                    {% if item.notes %}
                      <br>
                      <small style="color: hsl(199, 89%, 48%);"><i class="fas fa-info-circle"></i> {{ item.notes|truncatechars:50 }}</small>
                    {% endif %}
                  </td>
                  <td class="text-end" style="border-color: hsl(217, 33%, 22%);">
                    {{ item.quantity|floatformat:0 }} {{ item.unit }}
                  </td>
                  <td class="text-end" style="border-color: hsl(217, 33%, 22%);">
                    {% if item.unit_price %}
                      {{ item.unit_price|floatformat:0|intcomma }}ì›
                    {% else %}
                      <span style="color: hsl(215, 20%, 65%);">-</span>
                    {% endif %}
                  </td>
                  <td class="text-end" style="border-color: hsl(217, 33%, 22%);">
                    {% if item.total_price %}
                      <strong style="color: hsl(134, 61%, 41%);">{{ item.total_price|floatformat:0|intcomma }}ì›</strong>
                    {% else %}
                      <span style="color: hsl(215, 20%, 65%);">-</span>
                    {% endif %}
                  </td>
                  <td class="text-center" style="border-color: hsl(217, 33%, 22%);">
                    {% if item.tax_invoice_issued %}
                      <span class="badge bg-success"><i class="fas fa-check"></i> ë°œí–‰</span>
                    {% else %}
                      <span class="badge bg-secondary">ë¯¸ë°œí–‰</span>
                    {% endif %}
                  </td>
                  <td class="text-center" style="border-color: hsl(217, 33%, 22%);">
                    {% if is_owner %}
                    <a href="{% url 'reporting:schedule_detail' item.schedule.pk %}" 
                       class="btn btn-sm btn-outline-primary" 
                       style="border-color: hsl(217, 91%, 60%); color: hsl(217, 91%, 60%);"
                       title="ì¼ì • ìƒì„¸ë³´ê¸°">
                      <i class="fas fa-calendar-alt"></i>
                    </a>
                    {% else %}
                    <span style="color: hsl(215, 20%, 65%);">-</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
              <tfoot style="background-color: hsl(222, 47%, 18%); border-top: 2px solid hsl(217, 33%, 22%);">
                <tr>
                  <td colspan="{% if department %}3{% else %}2{% endif %}" class="text-end" style="color: hsl(0, 0%, 95%); border-color: hsl(217, 33%, 22%);"><strong>í•©ê³„</strong></td>
                  <td class="text-end" style="color: hsl(0, 0%, 95%); border-color: hsl(217, 33%, 22%);"><strong>{{ delivery_stats.total_quantity|floatformat:0 }}</strong></td>
                  <td style="border-color: hsl(217, 33%, 22%);"></td>
                  <td class="text-end" style="border-color: hsl(217, 33%, 22%);">
                    <strong class="fs-5" style="color: hsl(134, 61%, 41%);">
                      {{ delivery_stats.total_revenue|floatformat:0|intcomma }}ì›
                    </strong>
                  </td>
                  <td colspan="2" style="border-color: hsl(217, 33%, 22%);"></td>
                </tr>
              </tfoot>
            </table>
          </div>
          
          <!-- ê°„ë‹¨ í†µê³„ -->
          <div class="mt-3 p-3 rounded" style="background-color: hsl(222, 47%, 18%); border: 1px solid hsl(217, 33%, 22%);">
            <div class="row text-center">
              <div class="col-md-4">
                <div class="mb-0">
                  <i class="fas fa-boxes fa-2x mb-2" style="color: hsl(217, 91%, 60%);"></i>
                  <h4 class="mb-0" style="color: hsl(0, 0%, 95%);">{{ delivery_stats.total_items }}</h4>
                  <small style="color: hsl(215, 20%, 65%);">ì´ ë‚©í’ˆ ê±´ìˆ˜</small>
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-0">
                  <i class="fas fa-cubes fa-2x mb-2" style="color: hsl(134, 61%, 41%);"></i>
                  <h4 class="mb-0" style="color: hsl(0, 0%, 95%);">{{ delivery_stats.total_quantity|floatformat:0 }}</h4>
                  <small style="color: hsl(215, 20%, 65%);">ì´ ìˆ˜ëŸ‰</small>
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-0">
                  <i class="fas fa-won-sign fa-2x mb-2" style="color: hsl(199, 89%, 48%);"></i>
                  <h4 class="mb-0" style="color: hsl(0, 0%, 95%);">{{ delivery_stats.total_revenue|floatformat:0|intcomma }}ì›</h4>
                  <small style="color: hsl(215, 20%, 65%);">ì´ ë‚©í’ˆ ê¸ˆì•¡</small>
                </div>
              </div>
            </div>
          </div>
          {% else %}
          <div class="text-center py-5" style="color: hsl(215, 20%, 65%);">
            <i class="fas fa-box-open fa-3x mb-3"></i>
            <p>ì•„ì§ ë‚©í’ˆëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
            <p class="small">ë‚©í’ˆ ì¼ì •ì„ ìƒì„±í•˜ê³  í’ˆëª©ì„ ì¶”ê°€í•´ë³´ì„¸ìš”.</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- ê´€ë ¨ íˆìŠ¤í† ë¦¬ ì„¹ì…˜ -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card" style="background-color: hsl(222, 47%, 14%); border-color: hsl(217, 33%, 22%);">
        <div class="card-header" style="background-color: hsl(222, 47%, 11%); border-bottom: 1px solid hsl(217, 33%, 22%);">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0" style="color: hsl(0, 0%, 95%);">
              <i class="fas fa-history me-2"></i>ê°™ì€ ë¶€ì„œ í™œë™ íˆìŠ¤í† ë¦¬
              <small style="color: hsl(215, 20%, 65%);">({{ followup.company }} - {{ followup.department }})</small>
              {% if data_filter == 'all' %}<span class="badge bg-info ms-2">ì „ì²´</span>
              {% elif data_filter == 'user' and selected_filter_user %}<span class="badge bg-info ms-2">{{ selected_filter_user.username }}</span>
              {% else %}<span class="badge bg-primary ms-2">ë‚˜</span>{% endif %}
            </h5>
            <div>
              {% if is_owner %}
              <a
                href="{% url 'reporting:memo_create' %}?followup={{ followup.pk }}"
                class="btn btn-outline-secondary btn-sm"
              >
                <i class="fas fa-sticky-note me-1"></i>ë©”ëª¨ ì¶”ê°€
              </a>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="card-body">
          {% if related_histories %}
          <div class="timeline">
            {% for history in related_histories %}
            <div class="timeline-item">
              <div
                class="timeline-marker {% if history.action_type == 'created_followup' %}bg-primary {% elif history.action_type == 'updated_followup' %}bg-warning {% elif history.action_type == 'status_changed_followup' %}bg-info {% elif history.action_type == 'created_schedule' %}bg-success {% elif history.action_type == 'updated_schedule' %}bg-secondary {% elif history.action_type == 'status_changed_schedule' %}bg-info {% elif history.action_type == 'memo' %}bg-info {% elif history.action_type == 'note' %}bg-info {% elif history.action_type == 'customer_meeting' %}bg-primary {% elif history.action_type == 'delivery_schedule' %}bg-success {% elif history.action_type == 'service' %}bg-warning {% else %}bg-light {% endif %}"
              >
                <i
                  class="fas {% if history.action_type == 'created_followup' %}fa-user-plus {% elif history.action_type == 'updated_followup' %}fa-edit {% elif history.action_type == 'status_changed_followup' %}fa-refresh {% elif history.action_type == 'created_schedule' %}fa-calendar-plus {% elif history.action_type == 'updated_schedule' %}fa-calendar-edit {% elif history.action_type == 'status_changed_schedule' %}fa-calendar-check {% elif history.action_type == 'memo' %}fa-sticky-note {% elif history.action_type == 'note' %}fa-sticky-note {% elif history.action_type == 'customer_meeting' %}fa-handshake {% elif history.action_type == 'delivery_schedule' %}fa-truck {% elif history.action_type == 'service' %}fa-cogs {% else %}fa-circle {% endif %} text-white"
                ></i>
              </div>
              <div class="timeline-content" style="background-color: hsl(222, 47%, 18%); border-color: hsl(217, 33%, 22%);">
                <div
                  class="d-flex justify-content-between align-items-start mb-2"
                >
                  <div>
                    <h6 class="mb-0" style="color: hsl(0, 0%, 95%);">
                      {{ history.get_action_type_display }}
                      <small style="color: hsl(215, 20%, 65%);">- {{ history.followup.customer_name }}</small>
                      {% if history.user != request.user %}
                      <span class="badge bg-secondary ms-1">{{ history.user.username }}</span>
                      {% endif %}
                    </h6>
                  </div>
                  <small style="color: hsl(215, 20%, 65%);"
                    >{{ history.created_at|date:"m-d H:i" }}</small
                  >
                </div>
                {% if history.content %}
                <p class="mb-2 small" style="color: hsl(215, 20%, 65%);">
                  {{ history.content|truncatewords:15 }}
                </p>
                {% endif %}{% if history.old_value or history.new_value %}
                <div class="small" style="color: hsl(215, 20%, 65%);">
                  {% if history.old_value %}
                  <span style="color: hsl(0, 84%, 60%);"
                    >{{ history.old_value|truncatechars:30 }}</span
                  >
                  {% endif %} {% if history.old_value and history.new_value %} â†’
                  {% endif %} {% if history.new_value %}
                  <span style="color: hsl(134, 61%, 41%);"
                    >{{ history.new_value|truncatechars:30 }}</span
                  >
                  {% endif %}
                </div>
                {% endif %}
                <div class="mt-2">
                  <a
                    href="{% url 'reporting:history_detail' history.pk %}"
                    class="btn btn-outline-primary btn-sm"
                    style="border-color: hsl(217, 91%, 60%); color: hsl(217, 91%, 60%);"
                  >
                    <i class="fas fa-eye me-1"></i>ìƒì„¸ë³´ê¸°
                  </a>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="text-center py-4" style="color: hsl(215, 20%, 65%);">
            <i class="fas fa-history fa-2x mb-3"></i>
            <p>ì•„ì§ ê¸°ë¡ëœ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            <p class="small">ìœ„ì˜ ë²„íŠ¼ì„ ì‚¬ìš©í•˜ì—¬ ì²« ë²ˆì§¸ ê¸°ë¡ì´ë‚˜ ë©”ëª¨ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* ============================================
     ëª¨ë‹¬ Z-INDEX ë° ì˜¤ë²„ë ˆì´ ìˆ˜ì • (CRITICAL FIX)
     ============================================ */

  /* backdropì„ ì™„ì „íˆ íˆ¬ëª…í•˜ê²Œ (ë°°ê²½ ì—†ìŒ) */
  .modal-backdrop {
    display: none !important; /* backdrop ìì²´ë¥¼ ìˆ¨ê¹€ */
  }

  /* ëª¨ë‹¬ ìì²´ëŠ” backdropë³´ë‹¤ ë†’ê²Œ */
  .modal {
    z-index: 1055 !important;
    pointer-events: none !important; /* ëª¨ë‹¬ ì»¨í…Œì´ë„ˆë„ íˆ¬ëª…í•˜ê²Œ */
  }

  /* ëª¨ë‹¬ ë‹¤ì´ì–¼ë¡œê·¸ë§Œ í´ë¦­ ê°€ëŠ¥í•˜ê²Œ */
  .modal-dialog {
    z-index: 1056 !important;
    pointer-events: auto !important; /* ë‹¤ì´ì–¼ë¡œê·¸ëŠ” í´ë¦­ ê°€ëŠ¥ */
  }

  /* ëª¨ë‹¬ ì»¨í…ì¸ ë¥¼ í™•ì‹¤íˆ í´ë¦­ ê°€ëŠ¥í•˜ê²Œ */
  .modal-content {
    position: relative;
    z-index: 1057 !important;
    pointer-events: auto !important; /* ì»¨í…ì¸  í´ë¦­ ê°€ëŠ¥ */
    background-color: hsl(222, 47%, 14%) !important;
    border: 1px solid hsl(217, 33%, 22%) !important;
    border-radius: 0.3rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.5) !important;
  }

  /* ëª¨ë‹¬ ë‚´ë¶€ì˜ ëª¨ë“  ìš”ì†Œê°€ í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡ */
  .modal-header,
  .modal-body,
  .modal-footer,
  .modal-header *,
  .modal-body *,
  .modal-footer * {
    pointer-events: auto !important;
  }

  /* ğŸŒ™ AI ë¶„ì„ ëª¨ë‹¬ ë‹¤í¬ëª¨ë“œ */
  #aiSummaryModal .modal-header {
    background: hsl(217, 91%, 50%) !important;
  }
  
  #aiSummaryModal .modal-body {
    background: hsl(222, 47%, 14%) !important;
    color: hsl(210, 40%, 98%) !important;
  }
  
  #aiSummaryModal .modal-footer {
    background: hsl(222, 47%, 14%) !important;
    border-top: 1px solid hsl(217, 33%, 22%) !important;
  }
  
  /* AI ë¶„ì„ ì½˜í…ì¸  ìŠ¤íƒ€ì¼ */
  .ai-summary-content h3,
  .ai-summary-content h4,
  .ai-summary-content h5 {
    color: #60a5fa !important; /* ë°ì€ íŒŒë€ìƒ‰ í—¤ë” */
  }
  
  .ai-summary-content p,
  .ai-summary-content li {
    color: hsl(210, 40%, 98%) !important;
  }
  
  .ai-summary-content strong {
    color: #fbbf24 !important; /* í™©ê¸ˆìƒ‰ ê°•ì¡° ë¼ë²¨ */
  }
  
  .ai-summary-content ul {
    color: hsl(210, 40%, 98%) !important;
  }

  .page-title {
    color: #37352f;
    font-weight: 600;
  }
  .form-label {
    font-weight: 600;
    color: #6c757d;
    margin-bottom: 0.5rem;
  }
  .card {
    border: none;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    border-radius: 8px;
  }
  h3 {
    font-size: 1.1rem;
    font-weight: 600;
  }
  .badge {
    font-size: 0.9rem;
    padding: 0.5rem 0.75rem;
  }
  .bg-light {
    background-color: #f8f9fa !important;
  }

  /* íƒ€ì„ë¼ì¸ ìŠ¤íƒ€ì¼ */
  .timeline {
    position: relative;
    padding-left: 0;
  }

  .timeline-item {
    position: relative;
    display: flex;
    margin-bottom: 1.5rem;
    padding-left: 3rem;
  }

  .timeline-item:not(:last-child)::before {
    content: "";
    position: absolute;
    left: 1rem;
    top: 2.5rem;
    bottom: -1.5rem;
    width: 2px;
    background-color: #e0e0e0;
  }

  .timeline-marker {
    position: absolute;
    left: 0.5rem;
    top: 0.5rem;
    width: 2rem;
    height: 2rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
  }

  .timeline-content {
    flex: 1;
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    margin-left: 0.5rem;
  }
  
</style>

{% endblock %}
