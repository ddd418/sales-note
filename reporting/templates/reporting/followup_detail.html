{% extends "reporting/base.html" %}
{% load humanize %}
{% block title %}{{ page_title }} - ì˜ì—… ë³´ê³ 
ì‹œìŠ¤í…œ{% endblock %}{% block content %}
<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-10">
      <!-- í—¤ë” ì„¹ì…˜ -->
      <div
        class="page-header d-flex justify-content-between align-items-center mb-4"
      >
        <h1 class="page-title mb-0">
          {{ followup.customer_name|default:"ê³ ê°ëª… ë¯¸ì •" }} ê³ ê° ì •ë³´
          {% if not is_owner %}
          <span class="badge bg-info ms-2" style="font-size: 0.6rem;">
            <i class="fas fa-users me-1"></i>{{ owner_info.username }} ë‹´ë‹¹
          </span>
          {% endif %}
        </h1>
        <div>
          {% if followup.email and user.is_authenticated and user.userprofile.gmail_email %}
          <a
            href="{% url 'reporting:send_email_from_mailbox_with_followup' followup.pk %}"
            class="btn btn-success me-2"
          >
            <i class="fas fa-envelope me-1"></i>ë©”ì¼ ë³´ë‚´ê¸°
          </a>
          {% endif %}
          {% if can_modify %}
          <a
            href="{% url 'reporting:followup_edit' followup.pk %}"
            class="btn btn-primary me-2"
          >
            <i class="fas fa-edit me-1"></i>ìˆ˜ì •
          </a>
          <a
            href="{% url 'reporting:followup_delete' followup.pk %}"
            class="btn btn-danger"
          >
            <i class="fas fa-trash-alt me-1"></i>ì‚­ì œ
          </a>
          {% endif %}
        </div>
      </div>
      <!-- ìƒì„¸ ì •ë³´ ì¹´ë“œ -->
      <div class="card">
        <div class="card-body">
          <div class="row">
            <!-- ê¸°ë³¸ ì •ë³´ ì„¹ì…˜ -->
            <div class="col-md-6">
              <h3 class="mb-3 text-primary">
                <i class="fas fa-user me-2"></i>ê¸°ë³¸ ì •ë³´
              </h3>
              <div class="mb-3">
                <label class="form-label text-muted">ê³ ê°ëª…</label>
                <div class="p-2 bg-light rounded border">
                  {{ followup.customer_name|default:"ê³ ê°ëª… ë¯¸ì •" }}
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label text-muted">ì—…ì²´/í•™êµëª…</label>
                <div class="p-2 bg-light rounded border">
                  {{ followup.company|default:"ì—…ì²´ëª… ë¯¸ì •" }}
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label text-muted">ë¶€ì„œ/ì—°êµ¬ì‹¤ëª…</label>
                <div class="p-2 bg-light rounded border">
                  {{ followup.department|default:"ë¶€ì„œëª… ë¯¸ì •" }}
                </div>
              </div>
              {% if followup.phone_number %}
              <div class="mb-3">
                <label class="form-label text-muted">í•¸ë“œí° ë²ˆí˜¸</label>
                <div class="p-2 bg-light rounded border">
                  <i class="fas fa-phone me-1"></i>
                  {{ followup.phone_number }}
                </div>
              </div>
              {% endif %} {% if followup.email %}
              <div class="mb-3">
                <label class="form-label text-muted">ë©”ì¼ ì£¼ì†Œ</label>
                <div class="p-2 bg-light rounded border d-flex justify-content-between align-items-center">
                  <div>
                    <i class="fas fa-envelope me-1"></i>
                    <a
                      href="mailto:{{ followup.email }}"
                      class="text-decoration-none"
                      >{{ followup.email }}</a
                    >
                  </div>
                  {% if user.userprofile.gmail_email %}
                  <a href="{% url 'reporting:send_email_from_mailbox_with_followup' followup.pk %}" 
                     class="btn btn-sm btn-success">
                    <i class="fas fa-paper-plane me-1"></i>ë©”ì¼ ë³´ë‚´ê¸°
                  </a>
                  {% endif %}
                </div>
              </div>
              {% endif %} {% if followup.manager %}
              <div class="mb-3">
                <label class="form-label text-muted">ì±…ì„ì</label>
                <div class="p-2 bg-light rounded border">
                  <i class="fas fa-user-tie me-1"></i>
                  {{ followup.manager }}
                </div>
              </div>
              {% endif %}

              <div class="mb-3">
                <label class="form-label text-muted">ë‹´ë‹¹ì</label>
                <div class="p-2 {% if is_owner %}bg-light{% else %}bg-info bg-opacity-10{% endif %} rounded border">
                  <i class="fas fa-user me-1"></i>
                  {{followup.user.username}}
                  {% if not is_owner %}
                  <span class="badge bg-info ms-2">ë™ë£Œ ê³ ê°</span>
                  {% endif %}
                </div>
              </div>
              
              {% if not request.user.userprofile.can_use_ai %}
              <!-- ì¼ë°˜ ì‚¬ìš©ì: ìš°ì„ ìˆœìœ„ë§Œ í‘œì‹œ -->
              <div class="mb-3">
                <label class="form-label text-muted">
                  <i class="fas fa-flag me-1"></i>ìš°ì„ ìˆœìœ„
                </label>
                <div class="p-2 bg-light rounded border">
                  <span
                    class="badge {% if followup.priority == 'urgent' %}bg-danger {% elif followup.priority == 'followup' %}bg-warning {% elif followup.priority == 'scheduled' %}bg-info {% else %}bg-secondary {% endif %}"
                  >
                    {% if followup.priority == 'urgent' %}
                      ğŸš¨ ê¸´ê¸‰
                    {% elif followup.priority == 'followup' %}
                      â° íŒ”ë¡œì—…
                    {% elif followup.priority == 'scheduled' %}
                      ğŸ“… ì˜ˆì •
                    {% else %}
                      {{ followup.get_priority_display }}
                    {% endif %}
                  </span>
                </div>
              </div>
              {% endif %}
              
              {% if request.user.userprofile.can_use_ai %}
              <!-- AI ì‚¬ìš©ì: ê³ ê° ë“±ê¸‰ + ì¢…í•© ìš°ì„ ìˆœìœ„ í‘œì‹œ -->
              <div class="mb-3">
                <label class="form-label text-muted">
                  <i class="fas fa-medal me-1"></i>AI ê³ ê° ë“±ê¸‰
                  {% if followup.last_grade_updated %}
                  <small class="text-muted">({{ followup.last_grade_updated|date:"Y-m-d" }} ê°±ì‹ )</small>
                  {% endif %}
                </label>
                <div class="p-2 bg-light rounded border">
                  <span class="badge" style="
                    {% if followup.customer_grade == 'VIP' %}background: linear-gradient(135deg, #ffd700, #ffed4e);{% endif %}
                    {% if followup.customer_grade == 'A' %}background: linear-gradient(135deg, #667eea, #764ba2);{% endif %}
                    {% if followup.customer_grade == 'B' %}background: linear-gradient(135deg, #10b981, #059669);{% endif %}
                    {% if followup.customer_grade == 'C' %}background: linear-gradient(135deg, #64748b, #475569);{% endif %}
                    {% if followup.customer_grade == 'D' %}background: linear-gradient(135deg, #94a3b8, #64748b);{% endif %}
                    color: white; font-size: 1rem; padding: 0.5rem 1rem;">
                    {{ followup.customer_grade }}ë“±ê¸‰
                  </span>
                  <span class="ms-2 badge bg-secondary">
                    AI ì ìˆ˜: {{ followup.ai_score }}ì 
                  </span>
                  {% if followup.grade_metrics %}
                  <button type="button" class="btn btn-sm btn-outline-info ms-2" 
                          data-bs-toggle="collapse" data-bs-target="#gradeMetrics">
                    <i class="fas fa-info-circle"></i> ìƒì„¸ ì •ë³´
                  </button>
                  <div class="collapse mt-2" id="gradeMetrics">
                    <div class="card card-body">
                      <small>
                        {% if followup.grade_metrics.win_rate %}
                        <strong>ìˆ˜ì£¼ìœ¨:</strong> {{ followup.grade_metrics.win_rate }}%<br>
                        {% endif %}
                        {% if followup.grade_metrics.total_revenue %}
                        <strong>ì´ ë§¤ì¶œ:</strong> {{ followup.grade_metrics.total_revenue|floatformat:0 }}ì›<br>
                        {% endif %}
                        {% if followup.grade_metrics.total_meetings %}
                        <strong>ì´ ë¯¸íŒ…:</strong> {{ followup.grade_metrics.total_meetings }}íšŒ<br>
                        {% endif %}
                        {% if followup.grade_metrics.total_quotes %}
                        <strong>ì´ ê²¬ì :</strong> {{ followup.grade_metrics.total_quotes }}ê±´<br>
                        {% endif %}
                        {% if followup.grade_metrics.avg_response_hours %}
                        <strong>í‰ê·  ì‘ë‹µ:</strong> {{ followup.grade_metrics.avg_response_hours }}ì‹œê°„<br>
                        {% endif %}
                      </small>
                    </div>
                  </div>
                  {% endif %}
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label text-muted">
                  <i class="fas fa-chart-line me-1"></i>ì¢…í•© ìš°ì„ ìˆœìœ„
                </label>
                <div class="p-2 rounded border" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));">
                  <div class="d-flex align-items-center gap-3">
                    <span class="badge" style="background-color: {{ followup.get_priority_level.color }}; color: white; font-size: 1.1rem; padding: 0.6rem 1.2rem;">
                      {{ followup.get_priority_level.icon }} {{ followup.get_priority_level.label }}
                    </span>
                    <div>
                      <strong style="font-size: 1.5rem; color: #667eea;">{{ followup.get_combined_score }}ì </strong>
                      <small class="text-muted d-block">AI(70%) + ìš°ì„ ìˆœìœ„(30%)</small>
                    </div>
                    <div class="ms-auto">
                      <span class="badge bg-info">
                        <i class="fas fa-bell"></i> {{ followup.get_priority_level.action }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
              {% endif %}
              
              <div class="mb-3">
                <label class="form-label text-muted">ìƒì„±ì¼</label>
                <div class="p-2 bg-light rounded border">
                  <i class="fas fa-calendar-plus me-1"></i>
                  {{followup.created_at|date:"Yë…„ mì›” dì¼ H:i" }}
                </div>
              </div>
            </div>
          </div>
          <!-- ì¶”ê°€ ì •ë³´ ì„¹ì…˜ -->
          {% if followup.address %}
          <div class="row mt-4">
            <div class="col-12">
              <h3 class="mb-3 text-info">
                <i class="fas fa-map-marker-alt me-2"></i>ì¶”ê°€ ì •ë³´
              </h3>
              <div class="mb-3">
                <label class="form-label text-muted">ìƒì„¸ì£¼ì†Œ</label>
                <div class="p-3 bg-light rounded border">
                  <i class="fas fa-map-marker-alt me-1"></i>
                  {{followup.address}}
                </div>
              </div>
            </div>
          </div>
          {% endif %}

          <!-- ìƒì„¸ ë‚´ìš© -->
          {% if followup.notes %}
          <div class="row mt-4">
            <div class="col-12">
              <h3 class="mb-3 text-info">
                <i class="fas fa-file-text me-2"></i>ìƒì„¸ ë‚´ìš©
              </h3>
              <div class="p-3 bg-light rounded border">
                <i class="fas fa-quote-left me-1"></i>
                {{ followup.notes|linebreaks }}
              </div>
            </div>
          </div>
          {% endif %}

          <!-- AI ë¶„ì„ ì„¹ì…˜ (AI ì‚¬ìš©ìë§Œ í‘œì‹œ) -->
          {% if request.user.userprofile.can_use_ai and ai_analysis %}
          <div class="row mt-4">
            <div class="col-12">
              <h3 class="mb-3 text-primary">
                <i class="fas fa-robot me-2"></i>AI ë¶„ì„
              </h3>
              <div class="card border-primary">
                <div class="card-body">
                  <div class="row">
                    <!-- ê³ ê° ìš”ì•½ -->
                    <div class="col-md-6 mb-3">
                      <h5 class="text-primary mb-3">
                        <i class="fas fa-chart-line me-2"></i>ê³ ê° ì¸ì‚¬ì´íŠ¸
                      </h5>
                      <div id="ai-summary-container">
                        <div class="text-center text-muted py-4">
                          <button class="btn btn-primary" id="generate-summary-btn">
                            <i class="fas fa-magic me-2"></i>AI ìš”ì•½ ìƒì„±
                          </button>
                          <p class="small mt-2 mb-0">ê³ ê° í™œë™ì„ ë¶„ì„í•˜ì—¬ ì¸ì‚¬ì´íŠ¸ë¥¼ ì œê³µí•©ë‹ˆë‹¤</p>
                        </div>
                      </div>
                    </div>

                    <!-- ë“±ê¸‰ ë¶„ì„ -->
                    <div class="col-md-6 mb-3">
                      <h5 class="text-success mb-3">
                        <i class="fas fa-star me-2"></i>AI ë“±ê¸‰ í‰ê°€
                      </h5>
                      <div id="ai-grade-container">
                        <div class="text-center text-muted py-4">
                          <button class="btn btn-success" id="generate-grade-btn">
                            <i class="fas fa-calculator me-2"></i>ë“±ê¸‰ ë¶„ì„
                          </button>
                          <p class="small mt-2 mb-0">êµ¬ë§¤ ê°€ëŠ¥ì„±ê³¼ ìš°ì„ ìˆœìœ„ë¥¼ í‰ê°€í•©ë‹ˆë‹¤</p>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- ì œí’ˆ ì¶”ì²œ -->
                  {% if request.user.userprofile.can_use_ai %}
                  <div class="row mt-3">
                    <div class="col-12">
                      <h5 class="text-info mb-3">
                        <i class="fas fa-shopping-cart me-2"></i>AI ìƒí’ˆ ì¶”ì²œ
                      </h5>
                      <div id="ai-product-recommendations">
                        <div class="text-center text-muted py-4">
                          <button class="btn btn-info" id="recommend-products-btn">
                            <i class="fas fa-lightbulb me-2"></i>ì¶”ì²œ ìƒí’ˆ ë³´ê¸°
                          </button>
                          <p class="small mt-2 mb-0">êµ¬ë§¤ ì´ë ¥ê³¼ ê´€ì‹¬ì‚¬ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìƒí’ˆì„ ì¶”ì²œí•©ë‹ˆë‹¤</p>
                        </div>
                      </div>
                    </div>
                  </div>
                  {% endif %}

                  <!-- í™œë™ í†µê³„ -->
                  <div class="row mt-3">
                    <div class="col-12">
                      <div class="alert alert-light">
                        <h6 class="mb-3"><i class="fas fa-info-circle me-2"></i>ë¶„ì„ ë°ì´í„° (ìµœê·¼ 6ê°œì›”)</h6>
                        <div class="row">
                          <div class="col-md-3 col-6 mb-2">
                            <div class="d-flex align-items-center">
                              <i class="fas fa-handshake text-primary me-2"></i>
                              <div>
                                <small class="text-muted d-block">ë¯¸íŒ…</small>
                                <strong>{{ ai_analysis.customer_data.meeting_count }}íšŒ</strong>
                              </div>
                            </div>
                          </div>
                          <div class="col-md-3 col-6 mb-2">
                            <div class="d-flex align-items-center">
                              <i class="fas fa-file-invoice text-info me-2"></i>
                              <div>
                                <small class="text-muted d-block">ê²¬ì </small>
                                <strong>{{ ai_analysis.customer_data.quote_count }}ê±´</strong>
                              </div>
                            </div>
                          </div>
                          <div class="col-md-3 col-6 mb-2">
                            <div class="d-flex align-items-center">
                              <i class="fas fa-shopping-cart text-success me-2"></i>
                              <div>
                                <small class="text-muted d-block">êµ¬ë§¤</small>
                                <strong>{{ ai_analysis.customer_data.purchase_count }}íšŒ</strong>
                              </div>
                            </div>
                          </div>
                          <div class="col-md-3 col-6 mb-2">
                            <div class="d-flex align-items-center">
                              <i class="fas fa-envelope text-warning me-2"></i>
                              <div>
                                <small class="text-muted d-block">ì´ë©”ì¼</small>
                                <strong>{{ ai_analysis.customer_data.email_count }}ê±´</strong>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endif %}

          <!-- ë©”íƒ€ ì •ë³´ -->
          <div class="row mt-4">
            <div class="col-12">
              <div class="border-top pt-3">
                <small class="text-muted">
                  <i class="fas fa-info-circle me-1"></i>
                  ê³ ê° ì •ë³´ ID: {{followup.pk }} | ìƒì„±:
                  {{followup.created_at|date:"Y-m-d H:i"}} | ìˆ˜ì •:
                  {{followup.updated_at|date:"Y-m-d H:i" }}
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ë°ì´í„° í•„í„° ì„¹ì…˜ -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card border-primary">
        <div class="card-header bg-primary bg-opacity-10">
          <h5 class="card-title mb-0">
            <i class="fas fa-filter me-2"></i>ë°ì´í„° í•„í„°
          </h5>
        </div>
        <div class="card-body">
          <form method="get" class="row g-3 align-items-end">
            <div class="col-md-4">
              <label class="form-label fw-bold">ë°ì´í„° ë²”ìœ„</label>
              <div class="btn-group w-100" role="group">
                <input type="radio" class="btn-check" name="data_filter" id="filter_me" value="me" 
                       {% if data_filter == 'me' or not data_filter %}checked{% endif %} onchange="this.form.submit()">
                <label class="btn btn-outline-primary" for="filter_me">
                  <i class="fas fa-user me-1"></i>ë‚˜
                </label>
                
                <input type="radio" class="btn-check" name="data_filter" id="filter_all" value="all"
                       {% if data_filter == 'all' %}checked{% endif %} onchange="this.form.submit()">
                <label class="btn btn-outline-primary" for="filter_all">
                  <i class="fas fa-users me-1"></i>ì „ì²´
                </label>
              </div>
            </div>
            
            {% if company_users %}
            <div class="col-md-4">
              <label class="form-label fw-bold">íŠ¹ì • ì§ì› ì„ íƒ</label>
              <select name="filter_user" class="form-select" onchange="document.querySelector('#filter_user_radio').checked = true; this.form.submit();">
                <option value="">-- ì§ì› ì„ íƒ --</option>
                {% for user in company_users %}
                <option value="{{ user.id }}" {% if filter_user_id == user.id|stringformat:"s" %}selected{% endif %}>
                  {{ user.get_full_name|default:user.username }}
                </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
              <div class="form-check">
                <input type="radio" class="btn-check" name="data_filter" id="filter_user_radio" value="user"
                       {% if data_filter == 'user' %}checked{% endif %}>
                <label class="btn btn-outline-secondary btn-sm" for="filter_user_radio">
                  <i class="fas fa-user-check me-1"></i>ì„ íƒ ì ìš©
                </label>
              </div>
            </div>
            {% endif %}
            
            <div class="col-md-2">
              <a href="{% url 'reporting:followup_detail' followup.pk %}" class="btn btn-outline-secondary w-100">
                <i class="fas fa-undo me-1"></i>ì´ˆê¸°í™”
              </a>
            </div>
          </form>
          
          <!-- í˜„ì¬ í•„í„° ìƒíƒœ í‘œì‹œ -->
          <div class="mt-3">
            <span class="badge bg-info fs-6">
              <i class="fas fa-eye me-1"></i>
              í˜„ì¬ ë³´ê¸°: 
              {% if data_filter == 'all' %}
                ì „ì²´ ì§ì› ë°ì´í„°
              {% elif data_filter == 'user' and selected_filter_user %}
                {{ selected_filter_user.get_full_name|default:selected_filter_user.username }} ë°ì´í„°
              {% else %}
                ë‚˜ì˜ ë°ì´í„°
              {% endif %}
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ë‚©í’ˆ ìƒí’ˆ ëª©ë¡ ì„¹ì…˜ -->
  {% if delivered_items %}
  <div class="row mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-white">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
              <i class="fas fa-box-open me-2"></i>ë‚©í’ˆ ìƒí’ˆ ëª©ë¡
              {% if data_filter == 'all' %}<small class="text-muted">(ì „ì²´)</small>
              {% elif data_filter == 'user' and selected_filter_user %}<small class="text-muted">({{ selected_filter_user.username }})</small>
              {% else %}<small class="text-muted">(ë‚˜)</small>{% endif %}
            </h5>
            <div>
              <span class="badge bg-primary me-2">ì´ {{ delivery_stats.total_items }}ê±´</span>
              <span class="badge bg-success me-2">ìˆ˜ëŸ‰ {{ delivery_stats.total_quantity|floatformat:0 }}</span>
              <span class="badge bg-info">ì´ì•¡ {{ delivery_stats.total_revenue|floatformat:0|intcomma }}ì›</span>
            </div>
          </div>
        </div>
        <div class="card-body">
          {% if delivered_items %}
          <div class="table-responsive">
            <table class="table table-hover table-sm">
              <thead class="table-light">
                <tr>
                  <th style="width: 15%;">ë‚©í’ˆì¼</th>
                  <th style="width: 30%;">í’ˆëª©ëª…</th>
                  <th style="width: 10%;" class="text-end">ìˆ˜ëŸ‰</th>
                  <th style="width: 10%;" class="text-end">ë‹¨ê°€</th>
                  <th style="width: 15%;" class="text-end">ì´ì•¡</th>
                  <th style="width: 10%;" class="text-center">ì„¸ê¸ˆê³„ì‚°ì„œ</th>
                  <th style="width: 10%;" class="text-center">ì¼ì •</th>
                </tr>
              </thead>
              <tbody>
                {% for item in delivered_items %}
                <tr>
                  <td>
                    {% if item.schedule.visit_date %}
                      {{ item.schedule.visit_date|date:"Y-m-d" }}
                    {% else %}
                      <span class="text-muted">ë‚ ì§œ ë¯¸ì •</span>
                    {% endif %}
                  </td>
                  <td>
                    <strong>{{ item.item_name }}</strong>
                    {% if item.product %}
                      <br>
                      <small class="text-muted">{{ item.product.specification|default:"" }}</small>
                    {% endif %}
                    {% if item.notes %}
                      <br>
                      <small class="text-info"><i class="fas fa-info-circle"></i> {{ item.notes|truncatechars:50 }}</small>
                    {% endif %}
                  </td>
                  <td class="text-end">
                    {{ item.quantity|floatformat:0 }} {{ item.unit }}
                  </td>
                  <td class="text-end">
                    {% if item.unit_price %}
                      {{ item.unit_price|floatformat:0|intcomma }}ì›
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                  <td class="text-end">
                    {% if item.total_price %}
                      <strong class="text-success">{{ item.total_price|floatformat:0|intcomma }}ì›</strong>
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                  <td class="text-center">
                    {% if item.tax_invoice_issued %}
                      <span class="badge bg-success"><i class="fas fa-check"></i> ë°œí–‰</span>
                    {% else %}
                      <span class="badge bg-secondary">ë¯¸ë°œí–‰</span>
                    {% endif %}
                  </td>
                  <td class="text-center">
                    {% if is_owner %}
                    <a href="{% url 'reporting:schedule_detail' item.schedule.pk %}" 
                       class="btn btn-sm btn-outline-primary" 
                       title="ì¼ì • ìƒì„¸ë³´ê¸°">
                      <i class="fas fa-calendar-alt"></i>
                    </a>
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
              <tfoot class="table-light">
                <tr>
                  <td colspan="2" class="text-end"><strong>í•©ê³„</strong></td>
                  <td class="text-end"><strong>{{ delivery_stats.total_quantity|floatformat:0 }}</strong></td>
                  <td></td>
                  <td class="text-end">
                    <strong class="text-success fs-5">
                      {{ delivery_stats.total_revenue|floatformat:0|intcomma }}ì›
                    </strong>
                  </td>
                  <td colspan="2"></td>
                </tr>
              </tfoot>
            </table>
          </div>
          
          <!-- ê°„ë‹¨ í†µê³„ -->
          <div class="mt-3 p-3 bg-light rounded">
            <div class="row text-center">
              <div class="col-md-4">
                <div class="mb-0">
                  <i class="fas fa-boxes fa-2x text-primary mb-2"></i>
                  <h4 class="mb-0">{{ delivery_stats.total_items }}</h4>
                  <small class="text-muted">ì´ ë‚©í’ˆ ê±´ìˆ˜</small>
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-0">
                  <i class="fas fa-cubes fa-2x text-success mb-2"></i>
                  <h4 class="mb-0">{{ delivery_stats.total_quantity|floatformat:0 }}</h4>
                  <small class="text-muted">ì´ ìˆ˜ëŸ‰</small>
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-0">
                  <i class="fas fa-won-sign fa-2x text-info mb-2"></i>
                  <h4 class="mb-0">{{ delivery_stats.total_revenue|floatformat:0|intcomma }}ì›</h4>
                  <small class="text-muted">ì´ ë‚©í’ˆ ê¸ˆì•¡</small>
                </div>
              </div>
            </div>
          </div>
          {% else %}
          <div class="text-center py-5 text-muted">
            <i class="fas fa-box-open fa-3x mb-3"></i>
            <p>ì•„ì§ ë‚©í’ˆëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
            <p class="small">ë‚©í’ˆ ì¼ì •ì„ ìƒì„±í•˜ê³  í’ˆëª©ì„ ì¶”ê°€í•´ë³´ì„¸ìš”.</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- ê´€ë ¨ íˆìŠ¤í† ë¦¬ ì„¹ì…˜ -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-white">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
              <i class="fas fa-history me-2"></i>ê°™ì€ ë¶€ì„œ í™œë™ íˆìŠ¤í† ë¦¬
              <small class="text-muted">({{ followup.company }} - {{ followup.department }})</small>
              {% if data_filter == 'all' %}<span class="badge bg-info ms-2">ì „ì²´</span>
              {% elif data_filter == 'user' and selected_filter_user %}<span class="badge bg-info ms-2">{{ selected_filter_user.username }}</span>
              {% else %}<span class="badge bg-primary ms-2">ë‚˜</span>{% endif %}
            </h5>
            <div>
              {% if is_owner %}
              <a
                href="{% url 'reporting:memo_create' %}?followup={{ followup.pk }}"
                class="btn btn-outline-secondary btn-sm"
              >
                <i class="fas fa-sticky-note me-1"></i>ë©”ëª¨ ì¶”ê°€
              </a>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="card-body">
          {% if related_histories %}
          <div class="timeline">
            {% for history in related_histories %}
            <div class="timeline-item">
              <div
                class="timeline-marker {% if history.action_type == 'created_followup' %}bg-primary {% elif history.action_type == 'updated_followup' %}bg-warning {% elif history.action_type == 'status_changed_followup' %}bg-info {% elif history.action_type == 'created_schedule' %}bg-success {% elif history.action_type == 'updated_schedule' %}bg-secondary {% elif history.action_type == 'status_changed_schedule' %}bg-info {% elif history.action_type == 'memo' %}bg-info {% elif history.action_type == 'note' %}bg-info {% elif history.action_type == 'customer_meeting' %}bg-primary {% elif history.action_type == 'delivery_schedule' %}bg-success {% elif history.action_type == 'service' %}bg-warning {% else %}bg-light {% endif %}"
              >
                <i
                  class="fas {% if history.action_type == 'created_followup' %}fa-user-plus {% elif history.action_type == 'updated_followup' %}fa-edit {% elif history.action_type == 'status_changed_followup' %}fa-refresh {% elif history.action_type == 'created_schedule' %}fa-calendar-plus {% elif history.action_type == 'updated_schedule' %}fa-calendar-edit {% elif history.action_type == 'status_changed_schedule' %}fa-calendar-check {% elif history.action_type == 'memo' %}fa-sticky-note {% elif history.action_type == 'note' %}fa-sticky-note {% elif history.action_type == 'customer_meeting' %}fa-handshake {% elif history.action_type == 'delivery_schedule' %}fa-truck {% elif history.action_type == 'service' %}fa-cogs {% else %}fa-circle {% endif %} text-white"
                ></i>
              </div>
              <div class="timeline-content">
                <div
                  class="d-flex justify-content-between align-items-start mb-2"
                >
                  <div>
                    <h6 class="mb-0">
                      {{ history.get_action_type_display }}
                      <small class="text-muted">- {{ history.followup.customer_name }}</small>
                      {% if history.user != request.user %}
                      <span class="badge bg-secondary ms-1">{{ history.user.username }}</span>
                      {% endif %}
                    </h6>
                  </div>
                  <small class="text-muted"
                    >{{ history.created_at|date:"m-d H:i" }}</small
                  >
                </div>
                {% if history.content %}
                <p class="mb-2 text-muted small">
                  {{ history.content|truncatewords:15 }}
                </p>
                {% endif %}{% if history.old_value or history.new_value %}
                <div class="small text-muted">
                  {% if history.old_value %}
                  <span class="text-danger"
                    >{{ history.old_value|truncatechars:30 }}</span
                  >
                  {% endif %} {% if history.old_value and history.new_value %} â†’
                  {% endif %} {% if history.new_value %}
                  <span class="text-success"
                    >{{ history.new_value|truncatechars:30 }}</span
                  >
                  {% endif %}
                </div>
                {% endif %}
                <div class="mt-2">
                  <a
                    href="{% url 'reporting:history_detail' history.pk %}"
                    class="btn btn-outline-primary btn-sm"
                  >
                    <i class="fas fa-eye me-1"></i>ìƒì„¸ë³´ê¸°
                  </a>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="text-center py-4 text-muted">
            <i class="fas fa-history fa-2x mb-3"></i>
            <p>ì•„ì§ ê¸°ë¡ëœ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            <p class="small">ìœ„ì˜ ë²„íŠ¼ì„ ì‚¬ìš©í•˜ì—¬ ì²« ë²ˆì§¸ ê¸°ë¡ì´ë‚˜ ë©”ëª¨ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- AI ë¶„ì„ ê²°ê³¼ ëª¨ë‹¬ -->
<div class="modal fade" id="aiSummaryModal" tabindex="-1" aria-labelledby="aiSummaryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="aiSummaryModalLabel">
          <i class="fas fa-robot me-2"></i>AI ê³ ê° ë¶„ì„ ê²°ê³¼
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="aiSummaryContent">
        <!-- AI ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i>ì·¨ì†Œ
        </button>
        <button type="button" class="btn btn-success" id="saveSummaryBtn">
          <i class="fas fa-save me-1"></i>ë©”ëª¨ë¡œ ì €ì¥
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  /* ============================================
     ëª¨ë‹¬ Z-INDEX ë° ì˜¤ë²„ë ˆì´ ìˆ˜ì • (CRITICAL FIX)
     ============================================ */

  /* backdropì„ ì™„ì „íˆ íˆ¬ëª…í•˜ê²Œ (ë°°ê²½ ì—†ìŒ) */
  .modal-backdrop {
    display: none !important; /* backdrop ìì²´ë¥¼ ìˆ¨ê¹€ */
  }

  /* ëª¨ë‹¬ ìì²´ëŠ” backdropë³´ë‹¤ ë†’ê²Œ */
  .modal {
    z-index: 1055 !important;
    pointer-events: none !important; /* ëª¨ë‹¬ ì»¨í…Œì´ë„ˆë„ íˆ¬ëª…í•˜ê²Œ */
  }

  /* ëª¨ë‹¬ ë‹¤ì´ì–¼ë¡œê·¸ë§Œ í´ë¦­ ê°€ëŠ¥í•˜ê²Œ */
  .modal-dialog {
    z-index: 1056 !important;
    pointer-events: auto !important; /* ë‹¤ì´ì–¼ë¡œê·¸ëŠ” í´ë¦­ ê°€ëŠ¥ */
  }

  /* ëª¨ë‹¬ ì»¨í…ì¸ ë¥¼ í™•ì‹¤íˆ í´ë¦­ ê°€ëŠ¥í•˜ê²Œ */
  .modal-content {
    position: relative;
    z-index: 1057 !important;
    pointer-events: auto !important; /* ì»¨í…ì¸  í´ë¦­ ê°€ëŠ¥ */
    background-color: #fff;
    border: 1px solid rgba(0, 0, 0, 0.2);
    border-radius: 0.3rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15); /* ëª¨ë‹¬ì— ê·¸ë¦¼ì ì¶”ê°€ */
  }

  /* ëª¨ë‹¬ ë‚´ë¶€ì˜ ëª¨ë“  ìš”ì†Œê°€ í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡ */
  .modal-header,
  .modal-body,
  .modal-footer,
  .modal-header *,
  .modal-body *,
  .modal-footer * {
    pointer-events: auto !important;
  }

  .page-title {
    color: #37352f;
    font-weight: 600;
  }
  .form-label {
    font-weight: 600;
    color: #6c757d;
    margin-bottom: 0.5rem;
  }
  .card {
    border: none;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    border-radius: 8px;
  }
  h3 {
    font-size: 1.1rem;
    font-weight: 600;
  }
  .badge {
    font-size: 0.9rem;
    padding: 0.5rem 0.75rem;
  }
  .bg-light {
    background-color: #f8f9fa !important;
  }

  /* íƒ€ì„ë¼ì¸ ìŠ¤íƒ€ì¼ */
  .timeline {
    position: relative;
    padding-left: 0;
  }

  .timeline-item {
    position: relative;
    display: flex;
    margin-bottom: 1.5rem;
    padding-left: 3rem;
  }

  .timeline-item:not(:last-child)::before {
    content: "";
    position: absolute;
    left: 1rem;
    top: 2.5rem;
    bottom: -1.5rem;
    width: 2px;
    background-color: #e0e0e0;
  }

  .timeline-marker {
    position: absolute;
    left: 0.5rem;
    top: 0.5rem;
    width: 2rem;
    height: 2rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
  }

  .timeline-content {
    flex: 1;
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    margin-left: 0.5rem;
  }
  
  /* AI ìš”ì•½ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
  .ai-summary-content {
    font-size: 0.95rem;
    line-height: 1.7;
  }
  
  .ai-summary-content h3 {
    color: #0d6efd;
    border-bottom: 2px solid #0d6efd;
    padding-bottom: 0.5rem;
    margin-top: 1.5rem;
    margin-bottom: 1rem;
  }
  
  .ai-summary-content h4 {
    color: #0d6efd;
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
  }
  
  .ai-summary-content h5 {
    color: #495057;
    margin-top: 1rem;
    margin-bottom: 0.5rem;
  }
  
  .ai-summary-content ul {
    margin-bottom: 1rem;
  }
  
  .ai-summary-content li {
    margin-bottom: 0.5rem;
  }
  
  .ai-summary-content strong {
    color: #212529;
    font-weight: 600;
  }
</style>

{% if request.user.userprofile.can_use_ai and ai_analysis %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const followupId = {{ followup.pk }};
    const csrfToken = '{{ csrf_token }}';
    let currentSummary = ''; // ì €ì¥í•  ìš”ì•½ ë°ì´í„°

    // Markdownì„ HTMLë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
    function markdownToHtml(markdown) {
        // ë¨¼ì € ì¤„ë°”ê¿ˆ ì •ë¦¬
        let lines = markdown.split('\n');
        let html = '';
        let inList = false;
        let currentList = [];
        
        for (let i = 0; i < lines.length; i++) {
            let line = lines[i].trim();
            
            // ë¹ˆ ì¤„
            if (!line) {
                if (inList) {
                    html += '<ul class="ps-3 mb-3">' + currentList.join('') + '</ul>';
                    currentList = [];
                    inList = false;
                }
                continue;
            }
            
            // í—¤ë” ì²˜ë¦¬
            if (line.startsWith('### ')) {
                if (inList) {
                    html += '<ul class="ps-3 mb-3">' + currentList.join('') + '</ul>';
                    currentList = [];
                    inList = false;
                }
                html += '<h5 class="mt-3 mb-2 text-primary fw-bold">' + line.substring(4) + '</h5>';
            }
            else if (line.startsWith('## ')) {
                if (inList) {
                    html += '<ul class="ps-3 mb-3">' + currentList.join('') + '</ul>';
                    currentList = [];
                    inList = false;
                }
                html += '<h4 class="mt-4 mb-3 text-primary fw-bold">' + line.substring(3) + '</h4>';
            }
            else if (line.startsWith('# ')) {
                if (inList) {
                    html += '<ul class="ps-3 mb-3">' + currentList.join('') + '</ul>';
                    currentList = [];
                    inList = false;
                }
                html += '<h3 class="mt-4 mb-3 text-primary fw-bold">' + line.substring(2) + '</h3>';
            }
            // ìˆ«ì ë¦¬ìŠ¤íŠ¸
            else if (/^\d+\.\s/.test(line)) {
                if (inList) {
                    html += '<ul class="ps-3 mb-3">' + currentList.join('') + '</ul>';
                    currentList = [];
                    inList = false;
                }
                let text = line.replace(/^\d+\.\s/, '').replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
                html += '<div class="mb-2"><strong>' + text + '</strong></div>';
            }
            // ë¦¬ìŠ¤íŠ¸ í•­ëª©
            else if (line.startsWith('- ') || line.startsWith('* ')) {
                let text = line.substring(2).replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
                currentList.push('<li class="mb-2">' + text + '</li>');
                inList = true;
            }
            // ì¼ë°˜ í…ìŠ¤íŠ¸
            else {
                if (inList) {
                    html += '<ul class="ps-3 mb-3">' + currentList.join('') + '</ul>';
                    currentList = [];
                    inList = false;
                }
                let text = line.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
                html += '<p class="mb-2">' + text + '</p>';
            }
        }
        
        // ë§ˆì§€ë§‰ ë¦¬ìŠ¤íŠ¸ ì²˜ë¦¬
        if (inList) {
            html += '<ul class="ps-3 mb-3">' + currentList.join('') + '</ul>';
        }
        
        return '<div class="ai-summary-content">' + html + '</div>';
    }

    // AI ìš”ì•½ ìƒì„±
    document.getElementById('generate-summary-btn')?.addEventListener('click', async function() {
        const container = document.getElementById('ai-summary-container');
        
        await runAITaskWithDetails(
            'ê³ ê° ì¸ì‚¬ì´íŠ¸',
            `/reporting/ai/customer-summary/${followupId}/`,
            {},
            // ìƒì„¸ ë¡œê·¸ ì½œë°±
            async function() {
                addAILog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
                addAILog('ğŸ‘¤ ê³ ê°: {{ followup.customer_name }}', 'info');
                {% if followup.company %}
                addAILog('ğŸ¢ íšŒì‚¬: {{ followup.company }}', 'info');
                {% endif %}
                {% if followup.department %}
                addAILog('ğŸ›ï¸  ë¶€ì„œ: {{ followup.department }}', 'info');
                {% endif %}
                {% if followup.position %}
                addAILog('ğŸ’¼ ì§ì±…: {{ followup.position }}', 'info');
                {% endif %}
                addAILog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
                await sleep(500);
                addAILog('ğŸ” ê³ ê° í™œë™ ì´ë ¥ ìˆ˜ì§‘ ì¤‘...', 'info');
                await sleep(300);
                addAILog('ğŸ“Š êµ¬ë§¤ íŒ¨í„´ ë¶„ì„ ì¤‘...', 'info');
                await sleep(300);
                addAILog('ğŸ“ ë¯¸íŒ… ë©”ëª¨ ë¶„ì„ ì¤‘...', 'info');
            },
            // ì„±ê³µ ì½œë°±
            function(data) {
                currentSummary = data.summary; // ì›ë³¸ ì €ì¥
                
                // ëª¨ë‹¬ì— í‘œì‹œ
                const modalContent = document.getElementById('aiSummaryContent');
                modalContent.innerHTML = markdownToHtml(data.summary);
                
                // ëª¨ë‹¬ ì—´ê¸°
                const modal = new bootstrap.Modal(document.getElementById('aiSummaryModal'));
                modal.show();
                
                // ì»¨í…Œì´ë„ˆì— ì„±ê³µ ë©”ì‹œì§€
                container.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>AI ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. 
                        <button class="btn btn-sm btn-primary ms-2" onclick="document.getElementById('generate-summary-btn').click()">
                            ë‹¤ì‹œ ë³´ê¸°
                        </button>
                    </div>
                `;
                
                // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
                document.getElementById('generate-summary-btn').innerHTML = '<i class="fas fa-redo me-2"></i>ì¬ë¶„ì„';
            },
            // ì—ëŸ¬ ì½œë°±
            function(error) {
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>${error.message}
                    </div>
                `;
            }
        );
    });

    // AI ìš”ì•½ì„ ë©”ëª¨ë¡œ ì €ì¥
    document.getElementById('saveSummaryBtn')?.addEventListener('click', function() {
        const btn = this;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ì €ì¥ ì¤‘...';
        
        // ë©”ëª¨ ìƒì„± API í˜¸ì¶œ
        fetch('/reporting/memo/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken
            },
            body: new URLSearchParams({
                'followup': followupId,
                'content': `[AI ê³ ê° ë¶„ì„]\n\n${currentSummary}`
            })
        })
        .then(response => {
            if (response.ok) {
                // ì„±ê³µ ì‹œ ëª¨ë‹¬ ë‹«ê³  í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                bootstrap.Modal.getInstance(document.getElementById('aiSummaryModal')).hide();
                
                // ì„±ê³µ ì•Œë¦¼ í‘œì‹œ
                const container = document.getElementById('ai-summary-container');
                container.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>AI ë¶„ì„ì´ ë©”ëª¨ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!
                        <a href="#" onclick="location.reload()" class="btn btn-sm btn-outline-success ms-2">
                            íˆìŠ¤í† ë¦¬ í™•ì¸
                        </a>
                    </div>
                `;
                
                // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ (íˆìŠ¤í† ë¦¬ ëª©ë¡ ê°±ì‹ )
                setTimeout(() => location.reload(), 1500);
            } else {
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save me-1"></i>ë©”ëª¨ë¡œ ì €ì¥';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-save me-1"></i>ë©”ëª¨ë¡œ ì €ì¥';
        });
    });

    // AI ë“±ê¸‰ í‰ê°€
    document.getElementById('generate-grade-btn')?.addEventListener('click', async function() {
        const container = document.getElementById('ai-grade-container');
        
        await runAITaskWithDetails(
            'ë“±ê¸‰ í‰ê°€',
            `/reporting/ai/update-grade/${followupId}/`,
            {},
            // ìƒì„¸ ë¡œê·¸ ì½œë°±
            async function() {
                addAILog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
                addAILog('â­ í‰ê°€ ëŒ€ìƒ: {{ followup.customer_name }}', 'info');
                {% if followup.customer_grade %}
                addAILog('ğŸ“‹ í˜„ì¬ ë“±ê¸‰: {{ followup.customer_grade }}ë“±ê¸‰', 'info');
                {% endif %}
                addAILog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
                await sleep(500);
                addAILog('ğŸ’° êµ¬ë§¤ ê¸ˆì•¡ ì§‘ê³„ ì¤‘...', 'info');
                await sleep(300);
                addAILog('ğŸ“ˆ êµ¬ë§¤ ë¹ˆë„ ë¶„ì„ ì¤‘...', 'info');
                await sleep(300);
                addAILog('ğŸ¯ ì ì¬ë ¥ í‰ê°€ ì¤‘...', 'info');
            },
            function(data) {
                const gradeColors = {
                    'A+': 'danger',
                    'A': 'warning',
                    'B': 'info',
                    'C': 'secondary',
                    'D': 'dark'
                };
                const gradeColor = gradeColors[data.grade] || 'secondary';
                
                let recommendations = '';
                if (data.recommendations && data.recommendations.length > 0) {
                    recommendations = '<ul class="mb-0">' + 
                        data.recommendations.map(r => `<li class="mb-1">${r}</li>`).join('') +
                        '</ul>';
                }
                
                container.innerHTML = `
                    <div class="p-3 bg-light rounded border">
                        <div class="text-center mb-3">
                            <div class="display-4 mb-2">
                                <span class="badge bg-${gradeColor}">${data.grade}</span>
                            </div>
                            <div class="progress mb-2" style="height: 25px;">
                                <div class="progress-bar bg-${gradeColor}" role="progressbar" 
                                     style="width: ${data.score}%;" aria-valuenow="${data.score}" 
                                     aria-valuemin="0" aria-valuemax="100">
                                    ${data.score}ì 
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <h6 class="text-muted mb-2"><i class="fas fa-comment-dots me-2"></i>í‰ê°€ ê·¼ê±°</h6>
                            <p class="small mb-0">${data.reasoning}</p>
                        </div>
                        
                        ${data.factors ? `
                        <div class="row mb-3">
                            <div class="col-6 mb-2">
                                <small class="text-muted d-block">ì°¸ì—¬ë„</small>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar" style="width: ${data.factors.engagement}%">${data.factors.engagement}</div>
                                </div>
                            </div>
                            <div class="col-6 mb-2">
                                <small class="text-muted d-block">êµ¬ë§¤ê°€ëŠ¥ì„±</small>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar bg-success" style="width: ${data.factors.purchase_potential}%">${data.factors.purchase_potential}</div>
                                </div>
                            </div>
                            <div class="col-6 mb-2">
                                <small class="text-muted d-block">ê´€ê³„</small>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar bg-info" style="width: ${data.factors.relationship}%">${data.factors.relationship}</div>
                                </div>
                            </div>
                            <div class="col-6 mb-2">
                                <small class="text-muted d-block">ë°˜ì‘ì„±</small>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar bg-warning" style="width: ${data.factors.responsiveness}%">${data.factors.responsiveness}</div>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${recommendations ? `
                        <div>
                            <h6 class="text-muted mb-2"><i class="fas fa-lightbulb me-2"></i>ì¶”ì²œ ì•¡ì…˜</h6>
                            ${recommendations}
                        </div>
                        ` : ''}
                    </div>
                `;
            },
            function(error) {
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>${error || 'ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}
                    </div>
                `;
            }
        );
    });

    // ì œí’ˆ ì¶”ì²œ
    const recommendBtn = document.getElementById('recommend-products-btn');
    if (recommendBtn) {
        recommendBtn.addEventListener('click', async function() {
            const container = document.getElementById('ai-product-recommendations');
            
            await runAITaskWithDetails(
                'ìƒí’ˆ ì¶”ì²œ',
                `/reporting/ai/recommend-products/{{ followup.id }}/`,
                {},
                // ìƒì„¸ ë¡œê·¸ ì½œë°±
                async function() {
                    addAILog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
                    addAILog('ğŸ›’ ëŒ€ìƒ ê³ ê°: {{ followup.customer_name }}', 'info');
                    addAILog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
                    await sleep(500);
                    addAILog('ğŸ“¦ ê³¼ê±° êµ¬ë§¤ ìƒí’ˆ ì¡°íšŒ ì¤‘...', 'info');
                    await sleep(300);
                    addAILog('ğŸ“‹ ê²¬ì  ìš”ì²­ ìƒí’ˆ ë¶„ì„ ì¤‘...', 'info');
                    await sleep(300);
                    addAILog('ğŸ” ìƒí’ˆ ì¹´íƒˆë¡œê·¸ ë§¤ì¹­ ì¤‘...', 'info');
                },
                function(data) {
                    const recommendations = data.recommendations || [];
                    const dataSources = data.data_sources || {};
                    
                    if (recommendations.length === 0) {
                        let message = 'í˜„ì¬ ì¶”ì²œ ê°€ëŠ¥í•œ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.';
                        if (!dataSources.has_purchases && !dataSources.has_quotes && !dataSources.has_meetings) {
                            message = 'êµ¬ë§¤ ì´ë ¥, ê²¬ì  ì´ë ¥, ë¯¸íŒ… ê¸°ë¡ì´ ì—†ì–´ ìƒí’ˆì„ ì¶”ì²œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê³ ê°ê³¼ì˜ í™œë™ì„ ê¸°ë¡í•´ì£¼ì„¸ìš”.';
                        }
                        container.innerHTML = `
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>${message}
                            </div>
                        `;
                        return;
                    }
                    
                    const priorityColors = {
                        'high': 'danger',
                        'medium': 'warning',
                        'low': 'info'
                    };
                    
                    const priorityLabels = {
                        'high': 'ë†’ìŒ',
                        'medium': 'ë³´í†µ',
                        'low': 'ë‚®ìŒ'
                    };
                    
                    // ë¶„ì„ ìš”ì•½ í‘œì‹œ
                    let html = '';
                    if (data.analysis_summary) {
                        html += `
                            <div class="alert alert-info mb-3">
                                <h6 class="mb-2"><i class="fas fa-brain me-2"></i>AI ë¶„ì„ ìš”ì•½</h6>
                                <p class="mb-0 small">${data.analysis_summary}</p>
                            </div>
                        `;
                    }
                    
                    html += '<div class="row">';
                    recommendations.forEach((rec, idx) => {
                        const color = priorityColors[rec.priority] || 'secondary';
                        const label = priorityLabels[rec.priority] || rec.priority;
                        const sourceLabel = rec.source === 'company_catalog' ? 'íšŒì‚¬ ì œí’ˆ' : 'ì¶”ê°€ í•„ìš” ì œí’ˆ';
                        const sourceIcon = rec.source === 'company_catalog' ? 'fa-check-circle text-success' : 'fa-plus-circle text-info';
                        
                        html += `
                            <div class="col-md-6 mb-3">
                                <div class="card h-100 shadow-sm border-${color} product-recommendation-card" 
                                     style="border-width: 2px; cursor: pointer;"
                                     data-product='${JSON.stringify(rec)}'>
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="card-title mb-0">
                                                <i class="fas fa-box me-2 text-info"></i>${rec.product_name || 'ìƒí’ˆëª…'}
                                            </h6>
                                            <div>
                                                <span class="badge bg-${color} me-1">${label}</span>
                                                <span class="badge bg-light text-dark border">
                                                    <i class="fas ${sourceIcon} me-1"></i>${sourceLabel}
                                                </span>
                                            </div>
                                        </div>
                                        ${rec.category ? `<p class="small text-muted mb-2"><i class="fas fa-tag me-1"></i>${rec.category}</p>` : ''}
                                        ${rec.expected_timing ? `<p class="small mb-2"><i class="far fa-clock me-1 text-success"></i><strong>ì œì•ˆ ì‹œê¸°:</strong> ${rec.expected_timing}</p>` : ''}
                                        <p class="card-text small">${rec.reason || ''}</p>
                                        ${rec.cross_sell_items && rec.cross_sell_items.length > 0 ? `
                                            <div class="mt-2 pt-2 border-top">
                                                <small class="text-muted d-block mb-1"><i class="fas fa-plus-circle me-1"></i>í•¨ê»˜ ì¶”ì²œ ${rec.cross_sell_items.length}ê°œ</small>
                                            </div>
                                        ` : ''}
                                        <div class="text-end mt-2">
                                            <small class="text-primary"><i class="fas fa-info-circle me-1"></i>í´ë¦­í•˜ì—¬ ìƒì„¸ë³´ê¸°</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    
                    // ì œí’ˆ ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                    setTimeout(() => {
                        document.querySelectorAll('.product-recommendation-card').forEach(card => {
                            card.addEventListener('click', function() {
                                const productData = JSON.parse(this.dataset.product);
                                showProductDetailModal(productData);
                            });
                        });
                    }, 100);
                    
                    container.innerHTML = html;
                },
                function(error) {
                    container.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>${error || 'ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}
                        </div>
                    `;
                }
            );
        });
    }
    
    // ì œí’ˆ ìƒì„¸ ëª¨ë‹¬ í‘œì‹œ í•¨ìˆ˜
    function showProductDetailModal(product) {
        const priorityColors = {
            'high': 'danger',
            'medium': 'warning',
            'low': 'info'
        };
        const priorityLabels = {
            'high': 'ë†’ìŒ',
            'medium': 'ë³´í†µ',
            'low': 'ë‚®ìŒ'
        };
        
        const color = priorityColors[product.priority] || 'secondary';
        const label = priorityLabels[product.priority] || product.priority;
        const sourceLabel = product.source === 'company_catalog' ? 'íšŒì‚¬ ì œí’ˆ' : 'ì¶”ê°€ í•„ìš” ì œí’ˆ';
        const sourceIcon = product.source === 'company_catalog' ? 'fa-check-circle text-success' : 'fa-plus-circle text-info';
        const sourceBadgeColor = product.source === 'company_catalog' ? 'success' : 'info';
        
        // íšŒì‚¬ ì¹´íƒˆë¡œê·¸ ì œí’ˆì´ë©´ ì‹¤ì œ ì œí’ˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        if (product.source === 'company_catalog') {
            fetch(`/reporting/ai/product-detail/${encodeURIComponent(product.product_name)}/`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.is_catalog_product) {
                    // ì‹¤ì œ ì œí’ˆ ì •ë³´ë¡œ ëª¨ë‹¬ í‘œì‹œ
                    displayProductModal(product, data.product, color, label, sourceLabel, sourceIcon, sourceBadgeColor);
                } else {
                    // ì œí’ˆ ì •ë³´ ì—†ìœ¼ë©´ ê¸°ë³¸ ì •ë³´ë¡œ í‘œì‹œ
                    displayProductModal(product, null, color, label, sourceLabel, sourceIcon, sourceBadgeColor);
                }
            })
            .catch(error => {
                console.error('Error fetching product detail:', error);
                // ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ ì •ë³´ë¡œ í‘œì‹œ
                displayProductModal(product, null, color, label, sourceLabel, sourceIcon, sourceBadgeColor);
            });
        } else {
            // ì¶”ê°€ í•„ìš” ì œí’ˆì€ ë°”ë¡œ í‘œì‹œ
            displayProductModal(product, null, color, label, sourceLabel, sourceIcon, sourceBadgeColor);
        }
    }
    
    // ì‹¤ì œ ëª¨ë‹¬ í‘œì‹œ í•¨ìˆ˜
    function displayProductModal(product, productDetail, color, label, sourceLabel, sourceIcon, sourceBadgeColor) {
        // í•¨ê»˜ ì¶”ì²œ ì œí’ˆ ì •ë³´ë„ ê°€ì ¸ì˜¤ê¸°
        if (product.cross_sell_items && product.cross_sell_items.length > 0) {
            // ëª¨ë“  í•¨ê»˜ ì¶”ì²œ ì œí’ˆì˜ ì •ë³´ë¥¼ ë³‘ë ¬ë¡œ ê°€ì ¸ì˜¤ê¸°
            const crossSellPromises = product.cross_sell_items.map(itemName => 
                fetch(`/reporting/ai/product-detail/${encodeURIComponent(itemName)}/`, {
                    method: 'GET',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                })
                .then(response => response.json())
                .then(data => ({
                    name: itemName,
                    detail: data.success && data.is_catalog_product ? data.product : null
                }))
                .catch(error => ({
                    name: itemName,
                    detail: null
                }))
            );
            
            Promise.all(crossSellPromises).then(crossSellDetails => {
                renderProductModal(product, productDetail, crossSellDetails, color, label, sourceLabel, sourceIcon, sourceBadgeColor);
            });
        } else {
            renderProductModal(product, productDetail, [], color, label, sourceLabel, sourceIcon, sourceBadgeColor);
        }
    }
    
    // ëª¨ë‹¬ ë Œë”ë§ í•¨ìˆ˜
    function renderProductModal(product, productDetail, crossSellDetails, color, label, sourceLabel, sourceIcon, sourceBadgeColor) {
        const modalHtml = `
            <div class="modal fade" id="productDetailModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-light">
                            <h5 class="modal-title">
                                <i class="fas fa-box-open me-2 text-primary"></i>ì œí’ˆ ì¶”ì²œ ìƒì„¸ì •ë³´
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <!-- ì£¼ ì¶”ì²œ ì œí’ˆ -->
                            <div class="card border-${color} mb-4" style="border-width: 2px;">
                                <div class="card-header bg-${color} bg-opacity-10">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">
                                            <i class="fas fa-star text-warning me-2"></i>${product.product_name}
                                        </h5>
                                        <div>
                                            <span class="badge bg-${color} me-2">${label}</span>
                                            <span class="badge bg-${sourceBadgeColor}">
                                                <i class="fas ${sourceIcon} me-1"></i>${sourceLabel}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    ${product.category ? `
                                        <div class="mb-3">
                                            <strong><i class="fas fa-tag me-2 text-muted"></i>ì¹´í…Œê³ ë¦¬:</strong>
                                            <span class="badge bg-light text-dark border ms-2">${product.category}</span>
                                        </div>
                                    ` : ''}
                                    
                                    ${productDetail ? `
                                        <div class="mb-3 p-3 bg-light rounded">
                                            <h6 class="mb-2"><i class="fas fa-info-circle me-2 text-primary"></i>ì œí’ˆ ì •ë³´</h6>
                                            ${productDetail.specification ? `
                                                <div class="mb-2">
                                                    <strong>ê·œê²©:</strong> <span class="ms-2">${productDetail.specification}</span>
                                                </div>
                                            ` : ''}
                                            ${productDetail.description ? `
                                                <div class="mb-2">
                                                    <strong>ì„¤ëª…:</strong>
                                                    <p class="ms-2 mb-0 mt-1">${productDetail.description}</p>
                                                </div>
                                            ` : ''}
                                            <div class="mb-2">
                                                <strong>ë‹¨ìœ„:</strong> <span class="ms-2">${productDetail.unit}</span>
                                            </div>
                                            <div class="mb-2">
                                                <strong>ê°€ê²©:</strong> 
                                                <span class="ms-2 text-success fw-bold">${productDetail.current_price.toLocaleString()}ì›</span>
                                                ${productDetail.is_promo ? 
                                                    ` <span class="badge bg-danger">í”„ë¡œëª¨ì…˜</span>` : ''}
                                            </div>
                                            ${productDetail.total_sold > 0 || productDetail.total_quoted > 0 ? `
                                                <div class="mt-2 pt-2 border-top">
                                                    <small class="text-muted">
                                                        <i class="fas fa-chart-line me-1"></i>
                                                        íŒë§¤ ${productDetail.total_sold}íšŒ | ê²¬ì  ${productDetail.total_quoted}íšŒ
                                                    </small>
                                                </div>
                                            ` : ''}
                                        </div>
                                    ` : ''}
                                    
                                    ${product.expected_timing ? `
                                        <div class="mb-3">
                                            <strong><i class="far fa-clock me-2 text-success"></i>ì œì•ˆ ì‹œê¸°:</strong>
                                            <span class="text-success ms-2">${product.expected_timing}</span>
                                        </div>
                                    ` : ''}
                                    
                                    <div class="alert alert-light mb-0">
                                        <h6 class="mb-2"><i class="fas fa-lightbulb me-2 text-warning"></i>ì¶”ì²œ ì´ìœ </h6>
                                        <p class="mb-0">${product.reason || 'ì¶”ì²œ ì´ìœ  ì—†ìŒ'}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- í•¨ê»˜ ì¶”ì²œ ì œí’ˆ ëª©ë¡ -->
                            ${product.cross_sell_items && product.cross_sell_items.length > 0 ? `
                                <div class="card border-primary">
                                    <div class="card-header bg-primary bg-opacity-10">
                                        <h6 class="mb-0">
                                            <i class="fas fa-plus-circle me-2 text-primary"></i>
                                            í•¨ê»˜ ì¶”ì²œí•˜ëŠ” ì œí’ˆ (${product.cross_sell_items.length}ê°œ)
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="list-group list-group-flush">
                                            ${crossSellDetails.map((item, idx) => `
                                                <div class="list-group-item">
                                                    <div class="d-flex align-items-start">
                                                        <span class="badge bg-primary rounded-circle me-3 mt-1" style="width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                                                            ${idx + 1}
                                                        </span>
                                                        <div class="flex-grow-1">
                                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                                <h6 class="mb-0">
                                                                    <i class="fas fa-box me-2 text-info"></i>
                                                                    ${item.name}
                                                                </h6>
                                                                ${item.detail ? `
                                                                    <span class="badge bg-success">
                                                                        <i class="fas fa-check-circle me-1"></i>ì¹´íƒˆë¡œê·¸ ì œí’ˆ
                                                                    </span>
                                                                ` : ''}
                                                            </div>
                                                            ${item.detail ? `
                                                                <div class="mt-2 p-2 bg-light rounded small">
                                                                    ${item.detail.specification ? `
                                                                        <div class="mb-1">
                                                                            <strong>ê·œê²©:</strong> ${item.detail.specification}
                                                                        </div>
                                                                    ` : ''}
                                                                    ${item.detail.description ? `
                                                                        <div class="mb-1">
                                                                            <strong>ì„¤ëª…:</strong> ${item.detail.description}
                                                                        </div>
                                                                    ` : ''}
                                                                    <div class="d-flex justify-content-between align-items-center mt-2 pt-2 border-top">
                                                                        <span>
                                                                            <strong>ë‹¨ìœ„:</strong> ${item.detail.unit}
                                                                        </span>
                                                                        <span class="text-success fw-bold">
                                                                            ${item.detail.current_price.toLocaleString()}ì›
                                                                            ${item.detail.is_promo ? '<span class="badge bg-danger ms-1">í”„ë¡œëª¨ì…˜</span>' : ''}
                                                                        </span>
                                                                    </div>
                                                                    ${item.detail.total_sold > 0 || item.detail.total_quoted > 0 ? `
                                                                        <div class="mt-1 text-muted">
                                                                            <small>
                                                                                <i class="fas fa-chart-line me-1"></i>
                                                                                íŒë§¤ ${item.detail.total_sold}íšŒ | ê²¬ì  ${item.detail.total_quoted}íšŒ
                                                                            </small>
                                                                        </div>
                                                                    ` : ''}
                                                                </div>
                                                            ` : ''}
                                                        </div>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                        <div class="alert alert-info mt-3 mb-0">
                                            <small>
                                                <i class="fas fa-info-circle me-2"></i>
                                                <strong>ì°¸ê³ :</strong> ìœ„ ì œí’ˆë“¤ì€ ì£¼ ì¶”ì²œ ì œí’ˆê³¼ í•¨ê»˜ ì œì•ˆí•˜ë©´ íš¨ê³¼ì ì…ë‹ˆë‹¤.
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            ` : `
                                <div class="alert alert-light">
                                    <i class="fas fa-info-circle me-2"></i>
                                    í•¨ê»˜ ì¶”ì²œí•  ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤.
                                </div>
                            `}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-2"></i>ë‹«ê¸°
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
        const existingModal = document.getElementById('productDetailModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // ìƒˆ ëª¨ë‹¬ ì¶”ê°€
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // ëª¨ë‹¬ í‘œì‹œ
        const modal = new bootstrap.Modal(document.getElementById('productDetailModal'));
        modal.show();
        
        // ëª¨ë‹¬ì´ ë‹«íˆë©´ DOMì—ì„œ ì œê±°
        document.getElementById('productDetailModal').addEventListener('hidden.bs.modal', function () {
            this.remove();
        });
    }
});
</script>
{% endif %}

{% endblock %}
