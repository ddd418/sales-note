{% extends "reporting/base.html" %} {% block title %} {% if form.instance.pk%}히스토리 수정{% else %}새 활동 기록{% endif %} - 영업 보고
시스템 {% endblock %} {% block content %}

<div class="container">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <!-- 헤더 섹션 -->
      <div
        class="page-header d-flex justify-content-between align-items-center mb-4"
      >
        <h1 class="page-title mb-0">
          <i
            class="fas fa-{% if form.instance.pk %}edit{% else %}plus{% endif %} me-2"
          ></i>
          {% if form.instance.pk %}활동 기록 수정{% else %}새 활동 기록{%endif%}
        </h1>
        <a
          href="{% if form.instance.pk %}{% url 'reporting:history_detail' form.instance.pk %}{% elif schedule %}{% url 'reporting:schedule_detail' schedule.pk %}{% else %}{% url 'reporting:history_list' %}{% endif %}"
          class="btn btn-secondary"
        >
          <i class="fas fa-arrow-left me-1"></i>
          {% if form.instance.pk %}상세로{% elif schedule %}일정으로{% else %}목록으로{% endif %}
        </a>
      </div>

      <!-- 일정 연관 정보 표시 (일정에서 생성하는 경우) -->
      {% if schedule %}
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-info text-white">
          <h6 class="card-title mb-0">
            <i class="fas fa-calendar me-2"></i>연관 일정 정보
          </h6>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <strong>고객:</strong> {{schedule.followup.customer_name|default:"고객명 미정" }}<br />
              <strong>업체:</strong> {{schedule.followup.company|default:"업체명 미정" }}<br />
              <strong>담당자:</strong> {{ schedule.user.username }}
            </div>
            <div class="col-md-6">
              <strong>방문 일자:</strong> {{ schedule.visit_date|date:"Y년 m월 d일" }}<br />
              <strong>방문 시간:</strong> {{ schedule.visit_time|date:"H:i"}}<br />
              {% if schedule.location %}
              <strong>장소:</strong> {{ schedule.location }} {% endif %}
            </div>
          </div>
          {% if schedule.notes %}
          <div class="mt-3">
            <strong>일정 메모:</strong>
            <div class="text-muted">{{ schedule.notes }}</div>
          </div>
          {% endif %}
        </div>
      </div>
      {% endif %}

      <!-- 폼 카드 -->
      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <h5 class="card-title mb-0">
            <i class="fas fa-history me-2"></i>활동 기록 정보
          </h5>
        </div>
        <div class="card-body">
          <form method="post" enctype="multipart/form-data" novalidate>
            {% csrf_token %} {% if schedule %}
            <!-- 일정에서 생성되는 경우 숨겨진 필드 추가 -->
            <input
              type="hidden"
              name="followup"
              value="{{ schedule.followup.id }}"
            />
            <input type="hidden" name="schedule" value="{{ schedule.id }}" />
            {% endif %}

            <!-- 활동 유형 -->
            <div class="mb-4">
              <label
                for="{{ form.action_type.id_for_label }}"
                class="form-label"
              >
                <i class="fas fa-tag me-1"></i>활동 유형
                <span class="text-danger">*</span>
              </label>
              {{ form.action_type }} {% if form.action_type.errors %}
              <div class="invalid-feedback d-block">
                {% for error in form.action_type.errors %}{{ error }}{% endfor %}
              </div>
              {% endif %}
              <div class="form-text">활동의 성격을 선택해주세요.</div>
            </div>

            <!-- 서비스 상태 (서비스인 경우만 표시) -->
            <div class="mb-4" id="service-status-field" style="display: none">
              <label
                for="{{ form.service_status.id_for_label }}"
                class="form-label"
              >
                <i class="fas fa-tasks me-1"></i>서비스 상태
                <span class="text-danger">*</span>
              </label>
              {{ form.service_status }} {% if form.service_status.errors %}
              <div class="invalid-feedback d-block">
                {% for error in form.service_status.errors %}{{ error }}{% endfor %}
              </div>
              {% endif %}
              <div class="form-text">
                서비스의 진행 상태를 선택해주세요.
              </div>
            </div>
            <!-- 관련 고객 정보 -->
            <div class="mb-4">
              <label for="{{ form.followup.id_for_label }}" class="form-label">
                <i class="fas fa-user-tie me-1"></i>관련 고객 정보
                <span class="text-danger">*</span>
                {% if schedule %}
                <span class="badge bg-info ms-2">일정에서 자동 설정</span>
                {% endif %}
              </label>
              {% if schedule %}
              <!-- 일정에서 생성되는 경우 읽기 전용으로 표시 -->
              <div class="form-control bg-light" style="pointer-events: none">
                {{ schedule.followup.customer_name|default:"고객명 미정" }} - {{schedule.followup.company|default:"업체명 미정" }}
              </div>
              <div class="form-text text-info">
                <i class="fas fa-info-circle me-1"></i>이 값은 선택된 일정에서
                자동으로 설정됩니다.
              </div>
              {% else %} {{ form.followup }}
              <div class="form-text">
                이 활동과 관련된 고객 정보를 선택해주세요.
              </div>
              {% endif %} {% if form.followup.errors %}
              <div class="invalid-feedback d-block">
                {% for error in form.followup.errors %}{{ error }}{% endfor %}
              </div>
              {% endif %}
            </div>

            <!-- 관련 일정 -->
            <div class="mb-4">
              <label for="{{ form.schedule.id_for_label }}" class="form-label">
                <i class="fas fa-calendar me-1"></i>관련 일정 {% if schedule %}
                <span class="badge bg-info ms-2">현재 일정으로 고정</span>
                {% endif %}
              </label>
              {% if schedule %}
              <!-- 일정에서 생성되는 경우 읽기 전용으로 표시 -->
              <div class="form-control bg-light" style="pointer-events: none">
                {{ schedule.visit_date|date:"Y년 m월 d일" }} {{schedule.visit_time|date:"H:i" }} {% if schedule.location %} -
                {{ schedule.location }}{% endif %}
              </div>
              <div class="form-text text-info">
                <i class="fas fa-info-circle me-1"></i>이 활동은 현재 일정과
                연결됩니다.
              </div>
              {% else %} {{ form.schedule }}
              <div class="form-text">
                이 활동과 관련된 일정을 선택해주세요 (선택사항).
              </div>
              {% endif %} {% if form.schedule.errors %}
              <div class="invalid-feedback d-block">
                {% for error in form.schedule.errors %}{{ error }}{% endfor %}
              </div>
              {% endif %}
            </div>
            <!-- 납품 금액 (납품 일정인 경우만 표시) -->
            <div class="mb-4" id="delivery-amount-field" style="display: none">
              <label
                for="{{ form.delivery_amount.id_for_label }}"
                class="form-label"
              >
                <i class="fas fa-won-sign me-1"></i>납품 금액 (원)
              </label>
              {{ form.delivery_amount }} {% if form.delivery_amount.errors %}
              <div class="invalid-feedback d-block">
                {% for error in form.delivery_amount.errors %}{{ error }}{% endfor %}
              </div>
              {% endif %}
              <div class="form-text">
                납품 금액을 입력하세요. 0원도 입력 가능합니다.
              </div>
            </div>
            <!-- 납품 품목 (납품 일정인 경우만 표시) -->
            <div class="mb-4" id="delivery-items-field" style="display: none">
              <!-- 기존 텍스트 입력 방식 숨김 -->
              <div style="display: none;">
                <label for="{{ form.delivery_items.id_for_label }}" class="form-label">
                  <i class="fas fa-boxes me-1"></i>납품 품목
                </label>
                {{ form.delivery_items }}
              </div>
              
              <!-- 납품 품목 요약 및 관리 버튼 -->
              <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center bg-warning text-dark">
                  <div>
                    <h5 class="mb-0">
                      <i class="fas fa-boxes me-2"></i>납품 품목
                    </h5>
                    <small class="delivery-items-summary text-muted">납품 품목을 추가해주세요.</small>
                  </div>
                  <button type="button" class="btn btn-dark btn-sm" onclick="openHistoryDeliveryModal()">
                    <i class="fas fa-edit me-1"></i>품목 관리
                  </button>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-8">
                      <label class="form-label fw-bold">납품 품목 내역</label>
                      <textarea id="delivery-items-display" class="form-control" rows="3" readonly placeholder="품목 관리 버튼을 클릭하여 납품 품목을 추가해주세요."></textarea>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label fw-bold">총 납품 금액 (부가세 포함)</label>
                      <div class="input-group">
                        <input type="number" id="delivery-total-amount" class="form-control" readonly value="0">
                        <span class="input-group-text">원</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              {% if form.delivery_items.errors %}
              <div class="invalid-feedback d-block">
                {% for error in form.delivery_items.errors %}{{ error }}{% endfor %}
              </div>
              {% endif %}
            </div>
            <!-- 납품 날짜 (납품 일정인 경우만 표시) -->
            <div class="mb-4" id="delivery-date-field" style="display: none">
              <label
                for="{{ form.delivery_date.id_for_label }}"
                class="form-label"
              >
                <i class="fas fa-calendar-alt me-1"></i>납품 날짜
                <span class="text-danger">*</span>
              </label>
              {{ form.delivery_date }} {% if form.delivery_date.errors %}
              <div class="invalid-feedback d-block">
                {% for error in form.delivery_date.errors %}{{ error }}{% endfor %}
              </div>
              {% endif %}
              <div class="form-text">
                실제 납품이 이루어진 날짜를 선택하세요. (월별 집계에 사용됩니다)
              </div>
            </div>

            <!-- 미팅 날짜 (고객 미팅인 경우만 표시) -->
            <div class="mb-4" id="meeting-date-field" style="display: none">
              <label
                for="{{ form.meeting_date.id_for_label }}"
                class="form-label"
              >
                <i class="fas fa-calendar-check me-1"></i>미팅 날짜
                <span class="text-danger">*</span>
              </label>              {{ form.meeting_date }} {% if form.meeting_date.errors %}
              <div class="invalid-feedback d-block">
                {% for error in form.meeting_date.errors %}{{ error }}{% endfor %}
              </div>
              {% endif %}
              <div class="form-text">
                실제 미팅이 이루어진 날짜를 선택하세요. (월별 집계에 사용됩니다)
              </div>
            </div>

            <!-- 상세 설명 -->
            <div class="mb-4">
              <label for="{{ form.content.id_for_label }}" class="form-label">
                <i class="fas fa-file-text me-1"></i>상세 내용
              </label>
              {{ form.content }} {% if form.content.errors %}
              <div class="invalid-feedback d-block">
                {% for error in form.content.errors %}{{ error }}{% endfor %}
              </div>
              {% endif %}
              <div class="form-text">
                활동에 대한 자세한 설명을 입력해주세요.
              </div>
            </div>

            <!-- 첨부파일 -->
            <div class="mb-4">
              <label for="id_files" class="form-label">
                <i class="fas fa-paperclip me-1"></i>첨부파일
              </label>
              <input 
                type="file" 
                name="files" 
                id="id_files" 
                class="form-control" 
                multiple 
                accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.jpg,.jpeg,.png,.gif,.zip,.rar"
              />
              {% if form.files.errors %}
              <div class="invalid-feedback d-block">
                {% for error in form.files.errors %}{{ error }}{% endfor %}
              </div>
              {% endif %}
              <div class="form-text">
                최대 10MB, 최대 5개 파일까지 업로드 가능합니다.<br>
                지원 형식: PDF, DOC, DOCX, XLS, XLSX, PPT, PPTX, TXT, JPG, JPEG, PNG, GIF, ZIP, RAR
              </div>
            </div>

            <!-- 기존 첨부파일 (수정 모드에서만 표시) -->
            {% if form.instance.pk %}
            <div class="mb-4" id="existing-files">
              <label class="form-label">
                <i class="fas fa-folder me-1"></i>기존 첨부파일
              </label>
              <div id="files-list" class="border rounded p-3">
                <div class="text-center text-muted">
                  <i class="fas fa-spinner fa-spin me-2"></i>파일 목록을 불러오는 중...
                </div>
              </div>
            </div>
            {% endif %}

            <!-- 버튼 그룹 -->
            <div class="d-flex justify-content-between align-items-center pt-3">
              <div>
                <a
                  href="{% if form.instance.pk %}{% url 'reporting:history_detail' form.instance.pk %}{% else %}{% url 'reporting:history_list' %}{% endif %}"
                  class="btn btn-secondary"
                >
                  <i class="fas fa-times me-1"></i>취소
                </a>
              </div>
              <div>
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save me-1"></i>
                  {% if form.instance.pk %}수정 완료{% else %}등록하기{% endif%}
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- 도움말 카드 -->
      <div class="card mt-4 border-info">
        <div class="card-header bg-info bg-opacity-10">
          <h6 class="card-title mb-0 text-info">
            <i class="fas fa-lightbulb me-1"></i>활동 기록 작성 도움말
          </h6>
        </div>
        <div class="card-body">
          <ul class="mb-0 small">
            <li>
              <strong>활동 유형:</strong> 수동으로는 "고객 정보 생성"만 기록할
              수 있습니다. 고객 정보 수정, 일정 생성/수정은 자동으로 기록됩니다.
            </li>
            <li>
              <strong>관련 고객 정보:</strong> 필수 항목입니다. 이 활동과 관련된
              고객 정보를 선택해주세요.
            </li>
            <li>
              <strong>관련 일정:</strong> 선택사항입니다. 선택한 고객 정보와
              연결된 일정만 표시됩니다.
            </li>
            <li>
              <strong>상세 내용:</strong> 활동에 대한 구체적인 설명을 작성하면
              나중에 참고하기 좋습니다.
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
#delivery-items-display {
  white-space: pre-line !important;
  word-break: break-word !important;
}
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {      // DOM 요소 선택 - 안전한 방식으로
      const actionTypeField = document.getElementById('{{ form.action_type.id_for_label }}');
      const serviceStatusField = document.getElementById('service-status-field');
      const deliveryAmountField = document.getElementById('delivery-amount-field');
      const deliveryItemsField = document.getElementById('delivery-items-field');
      const deliveryDateField = document.getElementById('delivery-date-field');
      const meetingDateField = document.getElementById('meeting-date-field');
      const followupField = document.getElementById('{{ form.followup.id_for_label }}');
      const scheduleField = document.getElementById('{{ form.schedule.id_for_label }}');
      const deliveryDateInput = document.getElementById('{{ form.delivery_date.id_for_label }}');
      const meetingDateInput = document.getElementById('{{ form.meeting_date.id_for_label }}');

      // 기존 파일 목록 로드 (수정 모드에서만)
      {% if form.instance.pk %}
      loadExistingFiles();
      loadExistingDeliveryItems(); // 기존 납품 품목 표시
      {% endif %}

      // 필수 요소가 없으면 함수 실행 중단
      if (!actionTypeField) {
          console.error('ActionType field not found');
          return;
      }

      // 활동 유형에 따른 관련 필드 표시/숨김
      function toggleActivityFields() {
          console.log('활동 유형:', actionTypeField.value); // 디버깅용

          // 모든 필드 초기화
          if (serviceStatusField) serviceStatusField.style.display = 'none';
          if (deliveryAmountField) deliveryAmountField.style.display = 'none';
          if (deliveryItemsField) deliveryItemsField.style.display = 'none';
          if (deliveryDateField) deliveryDateField.style.display = 'none';
          if (meetingDateField) meetingDateField.style.display = 'none';

          // 각 활동 유형에 따른 필드 표시
          if (actionTypeField.value === 'service') {
              if (serviceStatusField) serviceStatusField.style.display = 'block';
              console.log('서비스 필드 표시'); // 디버깅용
          } else if (actionTypeField.value === 'delivery_schedule') {
              if (deliveryAmountField) deliveryAmountField.style.display = 'block';
              if (deliveryItemsField) deliveryItemsField.style.display = 'block';
              if (deliveryDateField) deliveryDateField.style.display = 'block';
              console.log('납품 필드 표시'); // 디버깅용
          } else if (actionTypeField.value === 'customer_meeting') {
              if (meetingDateField) meetingDateField.style.display = 'block';
              console.log('미팅 필드 표시'); // 디버깅용
          } else {
              console.log('모든 필드 숨김'); // 디버깅용
          }
      }

      // 활동 유형 변경 시 관련 필드 토글
      if (actionTypeField) {
          actionTypeField.addEventListener('change', toggleActivityFields);
          actionTypeField.addEventListener('input', toggleActivityFields);
      }

      // 초기 로드 시 실행
      toggleActivityFields();

      // 약간의 지연 후 다시 실행 (DOM 완전 로드 보장)
      setTimeout(function() {
          toggleActivityFields();
      }, 100);    // 고객 정보 선택에 따른 일정 필터링
      function updateScheduleOptions() {
          const followupId = followupField.value;

          // 일정 필드를 비우고 로딩 상태로 설정
          scheduleField.innerHTML = '<option value="">일정 로딩 중...</option>';
          scheduleField.disabled = true;

          if (followupId) {
              // AJAX로 선택된 팔로우업의 일정들을 가져옴
              fetch(`/reporting/api/followup/${followupId}/schedules/`)
                  .then(response => response.json())
                  .then(data => {
                      scheduleField.innerHTML = '<option value="">관련 일정 없음</option>';
                      if (data.schedules && data.schedules.length > 0) {
                          data.schedules.forEach(schedule => {
                              const option = document.createElement('option');
                              option.value = schedule.id;
                              option.textContent = schedule.text;
                              option.dataset.visitDate = schedule.visit_date; // 일정 날짜 저장
                              scheduleField.appendChild(option);
                          });
                      }
                      scheduleField.disabled = false;
                  })
                  .catch(error => {
                      console.error('Error loading schedules:', error);
                      scheduleField.innerHTML = '<option value="">일정 로드 실패</option>';
                      scheduleField.disabled = false;
                  });
          } else {
              scheduleField.innerHTML = '<option value="">먼저 고객 정보를 선택해주세요</option>';
              scheduleField.disabled = true;
          }
      }    // 고객 정보 선택 변경 시 일정 업데이트
      if (followupField) {
          followupField.addEventListener('change', updateScheduleOptions);
      }

      // 일정 선택 시 납품/미팅 날짜 자동 설정 및 활동 유형 자동 설정
      if (scheduleField) {
          scheduleField.addEventListener('change', function() {
              const selectedOption = scheduleField.options[scheduleField.selectedIndex];
              const scheduleId = scheduleField.value;
              
              // 일정 선택 시 활동 유형 자동 설정
              if (scheduleId && scheduleId !== '') {
                  fetch(`{% url 'reporting:schedule_activity_type' %}?schedule_id=${scheduleId}`)
                      .then(response => response.json())
                      .then(data => {
                          if (data.success && data.mapped_action_type) {
                              // 활동 유형 자동 설정
                              if (actionTypeField) {
                                  actionTypeField.value = data.mapped_action_type;
                                  // 필드 변화 감지를 위해 이벤트 발생
                                  actionTypeField.dispatchEvent(new Event('change'));
                              }
                          }
                      })
                      .catch(error => {
                          console.error('활동 유형 자동 설정 중 오류:', error);
                      });
              }
              
              // 기존 날짜 자동 설정 로직 유지
              if (selectedOption && selectedOption.dataset.visitDate) {
                  if (actionTypeField.value === 'delivery_schedule' && deliveryDateInput) {
                      deliveryDateInput.value = selectedOption.dataset.visitDate;
                  } else if (actionTypeField.value === 'customer_meeting' && meetingDateInput) {
                      meetingDateInput.value = selectedOption.dataset.visitDate;
                  }
              }
          });
      }

      // 초기 로드 시 실행
      toggleActivityFields();

      // 약간의 지연 후 다시 실행 (DOM 완전 로드 보장)
      setTimeout(function() {
          toggleActivityFields();
      }, 100);

      // 초기 로드 시 일정 업데이트 (수정 모드에서는 기존 값 유지)
      {% if not form.instance.pk %}
      if (followupField) {
          updateScheduleOptions();
      }
      {% endif %}
  });

  // 기존 파일 목록 로드 함수
  function loadExistingFiles() {
      {% if form.instance.pk %}
      fetch('{% url "reporting:history_files_api" form.instance.pk %}')
          .then(response => response.json())
          .then(data => {
              const filesList = document.getElementById('files-list');
              if (data.success && data.files.length > 0) {
                  let html = '';
                  data.files.forEach(file => {
                      html += `
                          <div class="file-item d-flex justify-content-between align-items-center p-2 border-bottom" data-file-id="${file.id}">
                              <div class="file-info">
                                  <a href="${file.download_url}" class="text-decoration-none">
                                      <i class="fas fa-download me-2"></i>${file.filename}
                                  </a>
                                  <small class="text-muted d-block">
                                      ${file.size} | ${file.uploaded_at} | ${file.uploaded_by}
                                  </small>
                              </div>
                              ${file.can_delete ? `
                                  <button type="button" class="btn btn-sm btn-outline-danger delete-file-btn" 
                                          onclick="deleteFile(${file.id}, '${file.filename}')" title="파일 삭제">
                                      <i class="fas fa-trash"></i>
                                  </button>
                              ` : ''}
                          </div>
                      `;
                  });
                  filesList.innerHTML = html;
              } else {
                  filesList.innerHTML = '<div class="text-center text-muted p-3">첨부된 파일이 없습니다.</div>';
              }
          })
          .catch(error => {
              console.error('파일 목록 로드 실패:', error);
              document.getElementById('files-list').innerHTML = 
                  '<div class="text-center text-danger p-3">파일 목록을 불러올 수 없습니다.</div>';
          });
      {% endif %}
  }

  // 기존 납품 품목 로드 및 표시 함수
  function loadExistingDeliveryItems() {
    const deliveryItemsField = document.getElementById('{{ form.delivery_items.id_for_label }}');
    const deliveryItemsDisplay = document.getElementById('delivery-items-display');
    const deliveryTotalAmount = document.getElementById('delivery-total-amount');
    
    // 1순위: 스케줄에서 전달된 delivery_text 사용
    {% if delivery_text %}
      const scheduleDeliveryText = `{{ delivery_text|linebreaksbr|escapejs }}`.replace(/<br\s*\/?>/gi, '\n');
      const scheduleDeliveryAmount = {{ delivery_amount|default:0 }};
      
      console.log('스케줄 납품 품목 데이터 사용:', scheduleDeliveryText);
      
      if (deliveryItemsDisplay) {
        deliveryItemsDisplay.value = scheduleDeliveryText;
      }
      
      if (deliveryTotalAmount) {
        deliveryTotalAmount.value = scheduleDeliveryAmount;
      }
      
      // 히든 필드에도 설정 (폼 제출용)
      if (deliveryItemsField) {
        deliveryItemsField.value = scheduleDeliveryText;
      }
      
      console.log('스케줄 납품 품목 표시 완료:', scheduleDeliveryText, '총액:', scheduleDeliveryAmount);
      return;
    {% endif %}
    
    // 2순위: 기존 폼 필드 데이터 사용
    if (deliveryItemsField && deliveryItemsField.value.trim()) {
      let deliveryItemsText = deliveryItemsField.value.trim();
      
      // \n 문자가 \\n으로 이스케이프되어 있을 수 있으므로 실제 줄바꿈으로 변환
      deliveryItemsText = deliveryItemsText.replace(/\\n/g, '\n');
      
      deliveryItemsDisplay.value = deliveryItemsText;
      
      // 총액 계산
      let totalAmount = 0;
      const lines = deliveryItemsText.split('\n');
      
      lines.forEach(line => {
        if (line.trim()) {
          // "품목명: 수량개 (금액원)" 형태에서 금액 추출
          const match = line.match(/\((.+?)원\)/);
          if (match) {
            const priceStr = match[1].replace(/,/g, '');
            const price = parseInt(priceStr);
            if (!isNaN(price)) {
              totalAmount += price;
            }
          }
        }
      });
      
      if (deliveryTotalAmount) {
        deliveryTotalAmount.value = totalAmount;
      }
      
      console.log('기존 폼 납품 품목 표시 완료:', deliveryItemsText);
    } else {
      // 데이터가 없는 경우 기본 메시지 유지
      if (deliveryItemsDisplay) {
        deliveryItemsDisplay.placeholder = "품목 관리 버튼을 클릭하여 납품 품목을 추가해주세요.";
      }
      if (deliveryTotalAmount) {
        deliveryTotalAmount.value = 0;
      }
    }
  }

  // 파일 삭제 함수
  function deleteFile(fileId, filename) {
      if (!confirm(`"${filename}" 파일을 삭제하시겠습니까?`)) {
          return;
      }

      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      
      fetch(`{% url "reporting:file_delete" 0 %}`.replace('0', fileId), {
          method: 'POST',
          headers: {
              'X-CSRFToken': csrfToken,
              'Content-Type': 'application/json',
          },
      })
      .then(response => response.json())
      .then(data => {
          if (data.success) {
              // 파일 항목 제거
              const fileItem = document.querySelector(`[data-file-id="${fileId}"]`);
              if (fileItem) {
                  fileItem.remove();
              }
              
              // 파일이 더 이상 없으면 메시지 표시
              const filesList = document.getElementById('files-list');
              if (!filesList.querySelector('.file-item')) {
                  filesList.innerHTML = '<div class="text-center text-muted p-3">첨부된 파일이 없습니다.</div>';
              }
              
              alert(data.message);
          } else {
              alert('파일 삭제 중 오류가 발생했습니다: ' + data.error);
          }
      })
      .catch(error => {
          console.error('파일 삭제 실패:', error);
          alert('파일 삭제 중 네트워크 오류가 발생했습니다.');
      });
  }

  // 납품 품목 관련 함수들 (모달 방식)
  let historyDeliveryItemIndex = 0;
  let historyDeliveryItemsData = [];
  
  // 하위 호환용 변수 (기존 인라인 함수들이 사용)
  let deliveryItemIndex = 0;

  function openHistoryDeliveryModal() {
    historyDeliveryItemsData = []; // 초기화
    
    // 모달 HTML 생성
    const modalHtml = `
      <div class="modal fade" id="historyDeliveryItemsModal" tabindex="-1" aria-labelledby="historyDeliveryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
          <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
              <h5 class="modal-title" id="historyDeliveryModalLabel">
                <i class="fas fa-boxes me-2"></i>납품 품목 관리
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="alert alert-info mb-0 flex-grow-1 me-3">
                  <i class="fas fa-info-circle me-2"></i>
                  품목명과 수량은 필수 입력 사항입니다. 단가를 입력하면 부가세 10%가 자동으로 포함된 총액이 계산됩니다.
                </div>
                <button type="button" class="btn btn-success" onclick="addHistoryDeliveryItem()">
                  <i class="fas fa-plus me-1"></i>품목 추가
                </button>
              </div>
              
              <div id="history-delivery-items-container">
                <!-- 동적으로 생성되는 품목들 -->
              </div>
              
              <!-- 총액 표시 -->
              <div class="row mt-4">
                <div class="col-12">
                  <div class="card bg-light">
                    <div class="card-body">
                      <div class="row">
                        <div class="col-md-4">
                          <div class="d-flex justify-content-between">
                            <span>소계:</span>
                            <span id="history-subtotal-amount" class="fw-bold">0원</span>
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="d-flex justify-content-between">
                            <span>부가세 (10%):</span>
                            <span id="history-tax-amount" class="fw-bold">0원</span>
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="d-flex justify-content-between">
                            <span class="fs-5">총액:</span>
                            <span id="history-total-amount" class="fw-bold text-primary fs-5">0원</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                <i class="fas fa-times me-1"></i>취소
              </button>
              <button type="button" class="btn btn-primary" onclick="saveHistoryDeliveryItems()">
                <i class="fas fa-save me-1"></i>적용
              </button>
            </div>
          </div>
        </div>
      </div>
    `;

    // 기존 모달 제거
    const existingModal = document.getElementById('historyDeliveryItemsModal');
    if (existingModal) {
      existingModal.remove();
    }

    // 새 모달 추가
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // 모달 표시
    const modal = new bootstrap.Modal(document.getElementById('historyDeliveryItemsModal'));
    modal.show();

    // DOM 업데이트가 완료된 후 데이터 로드
    setTimeout(() => {
      loadExistingHistoryDeliveryItems();
    }, 100);
  }

  function loadExistingHistoryDeliveryItems() {
    // 1순위: 관련 스케줄의 DeliveryItem들을 API로 가져오기
    {% if history.schedule %}
      console.log('관련 스케줄 ID:', {{ history.schedule.pk }});
      
      // 스케줄 납품 품목 API 호출 (올바른 URL 사용)
      fetch(`/reporting/schedules/{{ history.schedule.pk }}/delivery-items-api/`)
        .then(response => response.json())
        .then(data => {
          console.log('스케줄 납품 품목 API 응답:', data);
          
          if (data.success && data.items && data.items.length > 0) {
            // API에서 가져온 품목들을 모달에 추가
            data.items.forEach(item => {
              addHistoryDeliveryItem({
                item_name: item.item_name,
                quantity: item.quantity,
                unit_price: item.unit_price || 0
              });
            });
            console.log('스케줄 납품 품목 로드 완료');
          } else {
            // API에 데이터가 없으면 기본 품목 추가
            addHistoryDeliveryItem();
          }
        })
        .catch(error => {
          console.error('스케줄 납품 품목 로드 실패:', error);
          // 오류가 발생하면 기본 품목 추가
          addHistoryDeliveryItem();
        });
      
      return; // API 호출 중이므로 여기서 종료
    {% endif %}
    
    // 2순위: 스케줄에서 전달된 delivery_text 사용 (하위 호환성)
    {% if delivery_text %}
      const scheduleDeliveryText = `{{ delivery_text|escapejs }}`;
      console.log('스케줄 납품 품목 데이터 사용:', scheduleDeliveryText);
      
      const lines = scheduleDeliveryText.split('\n');
      let hasData = false;
      
      lines.forEach(line => {
        if (line.trim()) {
          // "품목명: 수량개 (금액원)" 형태 파싱
          const match = line.match(/^(.+?):\s*(\d+)개\s*\((.+?)원\)/);
          if (match) {
            const itemName = match[1].trim();
            const quantity = parseInt(match[2]);
            const totalPriceStr = match[3].replace(/,/g, '');
            const totalPrice = parseInt(totalPriceStr);
            
            // 부가세 포함 금액에서 단가 역산 (총액 / 1.1 / 수량)
            const unitPrice = Math.round(totalPrice / 1.1 / quantity);
            
            console.log(`스케줄 품목 로드: ${itemName}, 수량: ${quantity}, 단가: ${unitPrice}, 총액: ${totalPrice}`);
            
            addHistoryDeliveryItem({
              item_name: itemName,
              quantity: quantity,
              unit_price: unitPrice
            });
            hasData = true;
          }
        }
      });
      
      if (hasData) {
        console.log('스케줄 납품 품목 모달 로드 완료');
        return;
      } else {
        // delivery_text가 있지만 파싱 실패한 경우 기본 품목 추가
        addHistoryDeliveryItem();
        return;
      }
    {% endif %}
    
    // 3순위: 편집 모드인 경우 기존 납품 품목 데이터 가져오기
    const deliveryItemsField = document.getElementById('{{ form.delivery_items.id_for_label }}');
    
    if (deliveryItemsField && deliveryItemsField.value.trim()) {
      // 기존 데이터가 있는 경우 파싱해서 로드
      let deliveryItemsText = deliveryItemsField.value.trim();
      
      // \n 문자가 \\n으로 이스케이프되어 있을 수 있으므로 실제 줄바꿈으로 변환
      deliveryItemsText = deliveryItemsText.replace(/\\n/g, '\n');
      
      console.log('기존 납품 품목 데이터:', deliveryItemsText);
      console.log('줄바꿈으로 분리된 라인들:', deliveryItemsText.split('\n'));
      
      const lines = deliveryItemsText.split('\n');
      let hasData = false;
      
      lines.forEach(line => {
        if (line.trim()) {
          // "품목명: 수량개 (금액원)" 형태 파싱
          const match = line.match(/^(.+?):\s*(\d+)개\s*\((.+?)원\)/);
          if (match) {
            const itemName = match[1].trim();
            const quantity = parseInt(match[2]);
            const totalPriceStr = match[3].replace(/,/g, '');
            const totalPrice = parseInt(totalPriceStr);
            
            // 부가세 포함 금액에서 단가 역산 (총액 / 1.1 / 수량)
            const unitPrice = Math.round(totalPrice / 1.1 / quantity);
            
            console.log(`품목 로드: ${itemName}, 수량: ${quantity}, 단가: ${unitPrice}, 총액: ${totalPrice}`);
            
            addHistoryDeliveryItem({
              item_name: itemName,
              quantity: quantity,
              unit_price: unitPrice
            });
            hasData = true;
          }
        }
      });
      
      if (hasData) {
        console.log('기존 납품 품목 로드 완료');
        return;
      }
    }
    
    // 데이터가 없는 경우 기본 품목 하나 추가
    console.log('기존 납품 품목 데이터 없음 - 기본 품목 추가');
    addHistoryDeliveryItem();
  }

  function addHistoryDeliveryItem(itemData = {}) {
    const container = document.getElementById('history-delivery-items-container');
    const newItem = document.createElement('div');
    newItem.className = 'delivery-item row mb-3 p-3 border rounded bg-light';
    newItem.innerHTML = `
      <div class="col-md-4">
        <label class="form-label fw-bold">품목명 <span class="text-danger">*</span></label>
        <input type="text" class="form-control item-name" value="${itemData.item_name || ''}" placeholder="품목명을 입력하세요" required>
      </div>
      <div class="col-md-2">
        <label class="form-label fw-bold">수량 <span class="text-danger">*</span></label>
        <input type="number" class="form-control quantity-input" min="1" value="${itemData.quantity || ''}" placeholder="수량" required>
      </div>
      <div class="col-md-2">
        <label class="form-label fw-bold">단가 (부가세 별도)</label>
        <input type="number" class="form-control unit-price-input" step="0.01" min="0" value="${itemData.unit_price || ''}" placeholder="0">
      </div>
      <div class="col-md-3">
        <label class="form-label fw-bold">금액 (부가세 포함)</label>
        <div class="form-control-plaintext">
          <span class="item-total fw-bold text-primary">0원</span>
        </div>
      </div>
      <div class="col-md-1 d-flex align-items-end">
        <button type="button" class="btn btn-danger btn-sm w-100" onclick="removeHistoryDeliveryItem(this)" title="삭제">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    `;
    
    container.appendChild(newItem);
    historyDeliveryItemIndex++;
    deliveryItemIndex++; // 동기화
    
    // 이벤트 리스너 추가
    const quantityInput = newItem.querySelector('.quantity-input');
    const unitPriceInput = newItem.querySelector('.unit-price-input');
    
    quantityInput.addEventListener('input', calculateHistoryItemTotal);
    unitPriceInput.addEventListener('input', calculateHistoryItemTotal);
    
    // 초기 계산
    if (itemData.quantity && itemData.unit_price) {
      calculateHistoryItemTotal({ target: quantityInput });
    }
    
    // 애니메이션 효과
    newItem.style.opacity = '0';
    newItem.style.transform = 'translateY(-10px)';
    setTimeout(() => {
      newItem.style.transition = 'all 0.3s ease';
      newItem.style.opacity = '1';
      newItem.style.transform = 'translateY(0)';
    }, 10);
  }

  function removeHistoryDeliveryItem(button) {
    if (document.querySelectorAll('#history-delivery-items-container .delivery-item').length <= 1) {
      alert('최소 하나의 품목은 있어야 합니다.');
      return;
    }
    
    const item = button.closest('.delivery-item');
    item.style.transition = 'all 0.3s ease';
    item.style.opacity = '0';
    item.style.transform = 'translateY(-10px)';
    
    setTimeout(() => {
      item.remove();
      calculateHistoryTotal();
    }, 300);
  }

  function calculateHistoryItemTotal(event) {
    const item = event.target.closest('.delivery-item');
    const quantity = parseFloat(item.querySelector('.quantity-input').value) || 0;
    const unitPrice = parseFloat(item.querySelector('.unit-price-input').value) || 0;
    
    // 부가세 포함 계산: (단가 * 수량) * 1.1
    const subtotal = quantity * unitPrice;
    const total = subtotal * 1.1;
    
    item.querySelector('.item-total').textContent = Math.round(total).toLocaleString() + '원';
    calculateHistoryTotal();
  }

  function calculateHistoryTotal() {
    const items = document.querySelectorAll('#history-delivery-items-container .delivery-item');
    let subtotal = 0;
    
    items.forEach(item => {
      const quantity = parseFloat(item.querySelector('.quantity-input').value) || 0;
      const unitPrice = parseFloat(item.querySelector('.unit-price-input').value) || 0;
      subtotal += quantity * unitPrice;
    });
    
    const tax = subtotal * 0.1;
    const total = subtotal + tax;
    
    // 화면 업데이트
    document.getElementById('history-subtotal-amount').textContent = Math.round(subtotal).toLocaleString() + '원';
    document.getElementById('history-tax-amount').textContent = Math.round(tax).toLocaleString() + '원';
    document.getElementById('history-total-amount').textContent = Math.round(total).toLocaleString() + '원';
  }

  function saveHistoryDeliveryItems() {
    const items = document.querySelectorAll('#history-delivery-items-container .delivery-item');
    historyDeliveryItemsData = [];
    let itemsText = [];
    let totalAmount = 0;
    
    // 기존 숨겨진 입력 필드들 제거
    const existingHiddenFields = document.querySelectorAll('input[name^="delivery_items["]');
    existingHiddenFields.forEach(field => field.remove());
    
    items.forEach((item, index) => {
      const itemName = item.querySelector('.item-name').value.trim();
      const quantity = parseFloat(item.querySelector('.quantity-input').value) || 0;
      const unitPrice = parseFloat(item.querySelector('.unit-price-input').value) || 0;
      
      if (itemName && quantity > 0) {
        const subtotal = quantity * unitPrice;
        const total = subtotal * 1.1;
        
        historyDeliveryItemsData.push({
          item_name: itemName,
          quantity: quantity,
          unit_price: unitPrice,
          total_price: total
        });
        
        totalAmount += total;
        itemsText.push(`${itemName}: ${quantity}개 (${Math.round(total).toLocaleString()}원)`);
        
        // 서버로 전송될 숨겨진 필드들 생성 (기존 뷰와 호환)
        const form = document.querySelector('form');
        
        // 품목명
        const nameInput = document.createElement('input');
        nameInput.type = 'hidden';
        nameInput.name = `delivery_items[${index}][name]`;
        nameInput.value = itemName;
        form.appendChild(nameInput);
        
        // 수량
        const quantityInput = document.createElement('input');
        quantityInput.type = 'hidden';
        quantityInput.name = `delivery_items[${index}][quantity]`;
        quantityInput.value = quantity;
        form.appendChild(quantityInput);
        
        // 단가
        const unitPriceInput = document.createElement('input');
        unitPriceInput.type = 'hidden';
        unitPriceInput.name = `delivery_items[${index}][unit_price]`;
        unitPriceInput.value = unitPrice;
        form.appendChild(unitPriceInput);
      }
    });
    
    // 폼에 데이터 적용
    const deliveryItemsField = document.getElementById('{{ form.delivery_items.id_for_label }}');
    const deliveryAmountField = document.getElementById('{{ form.delivery_amount.id_for_label }}');
    const deliveryDisplayField = document.getElementById('delivery-items-display');
    const deliveryTotalField = document.getElementById('delivery-total-amount');
    const deliverySummary = document.querySelector('.delivery-items-summary');
    
    if (deliveryItemsField) {
      deliveryItemsField.value = itemsText.join('\\n');
    }
    
    if (deliveryAmountField) {
      deliveryAmountField.value = Math.round(totalAmount);
    }
    
    if (deliveryDisplayField) {
      deliveryDisplayField.value = itemsText.join('\\n');
    }
    
    if (deliveryTotalField) {
      deliveryTotalField.value = Math.round(totalAmount);
    }
    
    if (deliverySummary) {
      deliverySummary.textContent = `총 ${historyDeliveryItemsData.length}개 품목, ${Math.round(totalAmount).toLocaleString()}원`;
    }
    
    // 모달 닫기
    const modal = bootstrap.Modal.getInstance(document.getElementById('historyDeliveryItemsModal'));
    modal.hide();
    
    // 성공 메시지 (있는 경우만)
    if (typeof showMessage === 'function') {
      showMessage('납품 품목이 적용되었습니다.', 'success');
    }
  }

  // 기존 인라인 함수들 (하위 호환용으로 유지)
  function addDeliveryItem() {
      // 히스토리 폼에서는 history-delivery-items-container 사용
      const container = document.getElementById('history-delivery-items-container') || 
                        document.getElementById('delivery-items-container');
      
      if (!container) {
          console.error('Delivery items container not found. Available elements:', 
                       document.querySelectorAll('[id*="delivery"]'));
          return;
      }
      
      const newItem = document.createElement('div');
      newItem.className = 'delivery-item row mb-3 p-3 border rounded bg-light';
      newItem.innerHTML = `
          <div class="col-md-4">
              <label class="form-label fw-bold">품목명 <span class="text-danger">*</span></label>
              <input type="text" name="delivery_items[${deliveryItemIndex}][name]" class="form-control" placeholder="품목명을 입력하세요" required>
          </div>
          <div class="col-md-2">
              <label class="form-label fw-bold">수량 <span class="text-danger">*</span></label>
              <input type="number" name="delivery_items[${deliveryItemIndex}][quantity]" class="form-control quantity-input" min="1" placeholder="수량" required>
          </div>
          <div class="col-md-2">
              <label class="form-label fw-bold">단가 (부가세 별도)</label>
              <input type="number" name="delivery_items[${deliveryItemIndex}][unit_price]" class="form-control unit-price-input" step="0.01" min="0" placeholder="0" required>
          </div>
          <div class="col-md-3">
              <label class="form-label fw-bold">금액 (부가세 포함)</label>
              <div class="form-control-plaintext">
                  <span class="item-total fw-bold text-primary">0원</span>
              </div>
          </div>
          <div class="col-md-1 d-flex align-items-end">
              <button type="button" class="btn btn-danger btn-sm w-100" onclick="removeDeliveryItem(this)" title="삭제">
                  <i class="fas fa-trash"></i>
              </button>
          </div>
      `;
      
      container.appendChild(newItem);
      deliveryItemIndex++;
      historyDeliveryItemIndex++; // 동기화
      
      // 이벤트 리스너 추가
      const quantityInput = newItem.querySelector('.quantity-input');
      const unitPriceInput = newItem.querySelector('.unit-price-input');
      
      // 히스토리 폼에서는 calculateHistoryItemTotal 사용
      if (typeof calculateHistoryItemTotal === 'function') {
          quantityInput.addEventListener('input', calculateHistoryItemTotal);
          unitPriceInput.addEventListener('input', calculateHistoryItemTotal);
      } else {
          quantityInput.addEventListener('input', calculateItemTotal);
          unitPriceInput.addEventListener('input', calculateItemTotal);
      }
      
      // 애니메이션 효과
      newItem.style.opacity = '0';
      newItem.style.transform = 'translateY(-10px)';
      setTimeout(() => {
          newItem.style.transition = 'all 0.3s ease';
          newItem.style.opacity = '1';
          newItem.style.transform = 'translateY(0)';
      }, 10);
  }

  function removeDeliveryItem(button) {
      // 최소 1개 품목 유지 체크 (히스토리 컨테이너 기준)
      const historyContainer = document.getElementById('history-delivery-items-container');
      if (historyContainer && historyContainer.querySelectorAll('.delivery-item').length <= 1) {
          alert('최소 하나의 품목은 있어야 합니다.');
          return;
      }
      
      const item = button.closest('.delivery-item');
      item.style.transition = 'all 0.3s ease';
      item.style.opacity = '0';
      item.style.transform = 'translateY(-10px)';
      
      setTimeout(() => {
          item.remove();
          // 히스토리 폼에서는 calculateHistoryTotal 사용
          if (typeof calculateHistoryTotal === 'function') {
              calculateHistoryTotal();
          } else if (typeof calculateTotal === 'function') {
              calculateTotal();
          }
      }, 300);
  }

  function calculateItemTotal(event) {
      const item = event.target.closest('.delivery-item');
      const quantity = parseFloat(item.querySelector('.quantity-input').value) || 0;
      const unitPrice = parseFloat(item.querySelector('.unit-price-input').value) || 0;
      
      // 부가세 포함 계산: (단가 * 수량) * 1.1
      const subtotal = quantity * unitPrice;
      const total = subtotal * 1.1;
      
      item.querySelector('.item-total').textContent = Math.round(total).toLocaleString() + '원';
      
      // 히스토리 폼에서는 calculateHistoryTotal 사용
      if (typeof calculateHistoryTotal === 'function') {
          calculateHistoryTotal();
      } else if (typeof calculateTotal === 'function') {
          calculateTotal();
      }
  }

  function calculateTotal() {
      const items = document.querySelectorAll('.delivery-item');
      let subtotal = 0;
      
      items.forEach(item => {
          const quantity = parseFloat(item.querySelector('.quantity-input').value) || 0;
          const unitPrice = parseFloat(item.querySelector('.unit-price-input').value) || 0;
          subtotal += quantity * unitPrice;
      });
      
      // 부가세 포함 총액 계산
      const total = subtotal * 1.1;
      
      const totalElement = document.getElementById('total-amount');
      if (totalElement) {
          totalElement.textContent = Math.round(total).toLocaleString();
      }
  }

  // 페이지 로드 시 첫 번째 품목 추가
  document.addEventListener('DOMContentLoaded', function() {
      // 품목 추가 버튼 이벤트 리스너
      const addButton = document.getElementById('add-delivery-item');
      if (addButton) {
          addButton.addEventListener('click', addDeliveryItem);
      }
      
      // 기존 납품 품목이 있는지 확인
      {% if existing_delivery_items %}
          // 기존 품목들을 폼에 추가
          {% for item in existing_delivery_items %}
              addDeliveryItem();
              const lastItem{{ forloop.counter }} = document.querySelector('.delivery-item:last-child');
              if (lastItem{{ forloop.counter }}) {
                  const nameInput = lastItem{{ forloop.counter }}.querySelector('input[name*="[name]"]');
                  const quantityInput = lastItem{{ forloop.counter }}.querySelector('input[name*="[quantity]"]');
                  const unitPriceInput = lastItem{{ forloop.counter }}.querySelector('input[name*="[unit_price]"]');
                  const totalElement = lastItem{{ forloop.counter }}.querySelector('.item-total');
                  
                  if (nameInput) nameInput.value = '{{ item.item_name|escapejs }}';
                  if (quantityInput) quantityInput.value = '{{ item.quantity }}';
                  if (unitPriceInput) unitPriceInput.value = '{{ item.unit_price|default_if_none:"" }}';
                  
                  // 소계 계산
                  const quantity{{ forloop.counter }} = {{ item.quantity }};
                  const unitPrice{{ forloop.counter }} = {{ item.unit_price|default_if_none:"0" }};
                  const total{{ forloop.counter }} = quantity{{ forloop.counter }} * unitPrice{{ forloop.counter }};
                  if (totalElement) totalElement.textContent = total{{ forloop.counter }}.toLocaleString() + '원';
              }
          {% endfor %}
          calculateTotal();
      {% else %}
          // 기존 납품 품목이 없으면 첫 번째 품목 추가
          if (document.querySelectorAll('.delivery-item').length === 0) {
              addDeliveryItem();
          }
      {% endif %}
  });
</script>
{% endblock %}
