{% extends "reporting/base.html" %} {% block title %}Manager ëŒ€ì‹œë³´ë“œ - ì˜ì—…
ë³´ê³  ì‹œìŠ¤í…œ{% endblock %} 

{% block content %}
<style>
/* ğŸ¨ LOVABLE MANAGER DASHBOARD STYLES */

/* ë§¤ë‹ˆì € ëŒ€ì‹œë³´ë“œ ëª¨ë°”ì¼ ìµœì í™” */
@media (max-width: 768px) {
  /* ì‚¬ì´ë“œë°” ëª¨ë°”ì¼ ìµœì í™” */
  .col-lg-3.col-md-4 {
    position: sticky;
    top: 70px;
    z-index: 100;
    margin-bottom: 20px;
  }

  .card.sticky-top {
    position: static;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border);
    border-radius: var(--radius);
  }

  /* Salesman ëª©ë¡ ê°€ë¡œ ìŠ¤í¬ë¡¤ */
  .list-group {
    display: flex;
    flex-direction: row;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 10px;
    margin-bottom: 0;
  }

  .list-group-item {
    flex: 0 0 250px;
    margin-right: 10px;
    border-radius: var(--radius-sm) !important;
    border: 1px solid var(--border);
    transition: all 0.2s ease;
  }

  .list-group-item:hover {
    border-color: var(--primary);
    box-shadow: var(--shadow-md);
  }

  .list-group-item:last-child {
    margin-right: 0;
  }

  /* ì„±ê³¼ ì¹´ë“œ ëª¨ë°”ì¼ ìµœì í™” */
  .row.mb-4 .col-lg-3,
  .row.mb-4 .col-md-6 {
    margin-bottom: 15px;
  }

  .card-hover {
    transition: all 0.2s ease;
    -webkit-tap-highlight-color: transparent;
    border-radius: var(--radius);
    border: 1px solid var(--border);
  }

  .card-hover:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg), var(--shadow-glow);
    border-color: var(--primary);
  }

  .card-hover:active {
    transform: scale(0.98);
  }

  /* ë“œë¡­ë‹¤ìš´ ëª¨ë°”ì¼ ìµœì í™” */
  .btn-group .btn {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 200px;
  }

  .dropdown-menu {
    right: 0;
    left: auto;
    transform: translateX(0);
    border-radius: var(--radius);
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--border);
  }

  /* ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ ëª¨ë°”ì¼ ìµœì í™” */
  .col-lg-8 {
    margin-bottom: 20px;
  }

  .card-body canvas {
    max-height: 200px;
  }

  /* í…Œì´ë¸” ëª¨ë°”ì¼ ìµœì í™” */
  .table-responsive {
    border-radius: var(--radius);
    margin-bottom: 15px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border);
  }

  .table th,
  .table td {
    font-size: 12px;
    padding: 8px 6px;
  }

  /* í˜ì´ì§€ í—¤ë” ëª¨ë°”ì¼ ìµœì í™” */
  .page-header {
    position: sticky;
    top: 60px;
    background: var(--background);
    z-index: 99;
    padding: 15px 0;
    margin-bottom: 15px;
    border-bottom: 1px solid var(--border);
  }

  .page-title {
    font-size: 20px;
    margin-bottom: 5px;
  }

  /* ë²„íŠ¼ ê·¸ë£¹ ëª¨ë°”ì¼ ìµœì í™” */
  .d-flex.gap-2 {
    flex-direction: column;
    gap: 10px !important;
    align-items: stretch;
  }

  .btn-group {
    width: 100%;
  }

  .btn-group .btn {
    max-width: none;
  }

  /* ë©”ì¸ ì½˜í…ì¸  ë ˆì´ì•„ì›ƒ ì¡°ì • */
  .col-lg-9.col-md-8 {
    padding-left: 15px;
    padding-right: 15px;
  }

  /* ì•„ë°”íƒ€ í¬ê¸° ì¡°ì • */
  .avatar-sm {
    width: 36px;
    height: 36px;
  }

  .avatar-title {
    font-size: 14px;
  }

  /* í†µê³„ ìˆ˜ì¹˜ í°íŠ¸ í¬ê¸° ì¡°ì • */
  .card-body h3 {
    font-size: 1.5rem;
  }

  .card-body h6 {
    font-size: 0.8rem;
  }
}

/* ì•„ì£¼ ì‘ì€ í™”ë©´ (320px ì´í•˜) */
@media (max-width: 320px) {
  .list-group-item {
    flex: 0 0 200px;
  }

  .card-body h3 {
    font-size: 1.25rem;
  }

  .btn {
    padding: 10px 12px;
    font-size: 14px;
  }

  .page-title {
    font-size: 18px;
  }
}
</style>

<div class="container-fluid">
  <div class="row">
    {% if not no_salesmen %}
    <!-- ì‚¬ì´ë“œë°” - Salesman ëª©ë¡ -->
    <div class="col-lg-3 col-md-4">
      <div class="card sticky-top" style="top: 90px">
        <div class="card-header">
          <h6 class="card-title mb-0">
            <i class="fas fa-users me-2"></i>SalesMan ëª©ë¡
          </h6>
        </div>        <div class="card-body p-0">
          <div class="list-group list-group-flush">
            <!-- ì „ì²´ë³´ê¸° ì˜µì…˜ -->
            <a
              href="?view_all=true"
              class="list-group-item list-group-item-action {% if view_all %}active{% endif %}"
            >
              <div class="d-flex align-items-center">
                <div class="avatar-sm me-3">
                  <div
                    class="avatar-title bg-{% if view_all %}white text-primary{% else %}secondary{% endif %} rounded-circle"
                  >
                    <i class="fas fa-globe"></i>
                  </div>
                </div>
                <div>
                  <h6 class="mb-0">ì „ì²´ë³´ê¸°</h6>
                </div>
              </div>
            </a>
            
            {% for salesman in salesman_users %}
            <a
              href="?user_id={{ salesman.id }}"
              class="list-group-item list-group-item-action {% if salesman.id == selected_user.id and not view_all %}active{% endif %}"
            >
              <div class="d-flex align-items-center">
                <div class="avatar-sm me-3">
                  <div
                    class="avatar-title bg-{% if salesman.id == selected_user.id and not view_all %}white text-primary{% else %}light{% endif %} rounded-circle"
                  >
                    {{ salesman.username|first }}
                  </div>
                </div>
                <div>
                  <h6 class="mb-0">{{ salesman.username }}</h6>
                  {% if salesman.first_name or salesman.last_name %}
                  <small class="text-muted"
                    >{{ salesman.first_name }}{{ salesman.last_name }}</small
                  >
                  {% endif %}
                </div>
              </div>
            </a>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <div class="col-lg-9 col-md-8">
      {% endif %}

      <!-- í˜ì´ì§€ í—¤ë” -->
      <div
        class="page-header d-flex justify-content-between align-items-center mb-4"
      >        <div>
          <h1 class="page-title mb-0">
            <i class="fas fa-chart-line me-2"></i>Manager ëŒ€ì‹œë³´ë“œ
          </h1>
          {% if not no_salesmen %}
          <p class="text-muted mb-0">
            {% if view_all %}
            ì „ì²´ ì‹¤ë¬´ìì˜ ì˜ì—… í˜„í™© ({{ current_year }}ë…„)
            {% else %}
            {{ selected_user.username }}ë‹˜ì˜ ì˜ì—… í˜„í™© ({{ current_year }}ë…„)
            {% endif %}
          </p>
          {% endif %}
        </div>
        {% if not no_salesmen %}        
        <div class="d-flex gap-2">
          <div class="btn-group">
            <button
              type="button"
              class="btn btn-outline-primary dropdown-toggle"
              data-bs-toggle="dropdown"
            >
              <i class="fas fa-eye me-1"></i>{% if view_all %}ì „ì²´{% else %}{{ selected_user.username }}{% endif %} ë°ì´í„°
              ë³´ê¸°
            </button>
            <ul class="dropdown-menu">
              {% if not view_all %}
              <li>
                <a
                  class="dropdown-item"
                  href="{% url 'reporting:salesman_detail' selected_user.id %}"
                >
                  <i class="fas fa-user me-2"></i>ê³ ê° ê´€ë¦¬
                </a>
              </li>
              <li>
                <a
                  class="dropdown-item"
                  href="{% url 'reporting:schedule_list' %}?user={{ selected_user.id }}"
                >
                  <i class="fas fa-calendar me-2"></i>ì¼ì • ê´€ë¦¬
                </a>
              </li>
              <li>
                <a
                  class="dropdown-item"
                  href="{% url 'reporting:history_list' %}?user={{ selected_user.id }}"
                >
                  <i class="fas fa-history me-2"></i>í™œë™ ê¸°ë¡
                </a>
              </li>
              {% else %}
              <li>
                <a
                  class="dropdown-item"
                  href="{% url 'reporting:followup_list' %}"
                >
                  <i class="fas fa-user me-2"></i>ê³ ê° ê´€ë¦¬
                </a>
              </li>
              <li>
                <a
                  class="dropdown-item"
                  href="{% url 'reporting:schedule_list' %}"
                >
                  <i class="fas fa-calendar me-2"></i>ì¼ì • ê´€ë¦¬
                </a>
              </li>
              <li>
                <a
                  class="dropdown-item"
                  href="{% url 'reporting:history_list' %}"
                >
                  <i class="fas fa-history me-2"></i>í™œë™ ê¸°ë¡
                </a>
              </li>              
              {% endif %}
            </ul>
          </div>
        </div>
        {% endif %}
      </div>

      {% if no_salesmen %}
      <!-- SalesManì´ ì—†ëŠ” ê²½ìš° -->
      <div class="row">
        <div class="col-12">
          <div class="card text-center">
            <div class="card-body py-5">
              <div class="mb-4">
                <i class="fas fa-users fa-4x text-muted"></i>
              </div>
              <h4 class="text-muted">ê´€ë¦¬í•  SalesManì´ ì—†ìŠµë‹ˆë‹¤</h4>
              <p class="text-muted mb-4">
                Adminì—ê²Œ SalesMan ê³„ì • ìƒì„±ì„ ìš”ì²­í•˜ì„¸ìš”.
              </p>
              <a href="{% url 'reporting:dashboard' %}" class="btn btn-primary">
                <i class="fas fa-home me-1"></i>ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°
              </a>
            </div>
          </div>
        </div>
      </div>
      {% else %}      <!-- ì„±ê³¼ ìš”ì•½ ì¹´ë“œ -->
      <div class="row mb-4 d-none d-md-flex">
        <!-- ì²« ë²ˆì§¸ í–‰: 4ê°œ ì¹´ë“œ -->
        <div class="col-lg-3 col-md-6 mb-3">
          {% if view_all %}
          <a href="{% url 'reporting:followup_list' %}" class="text-decoration-none">
          {% else %}
          <a href="{% url 'reporting:salesman_detail' selected_user.id %}" class="text-decoration-none">
          {% endif %}
            <div class="card bg-primary text-white card-hover">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="flex-grow-1">
                    <small class="text-white-50 mb-1 d-block">ì´ ê³ ê°ìˆ˜</small>
                    <h3 class="mb-0">{{ total_followups }}</h3>
                  </div>
                  <div class="avatar-sm">
                    <div class="avatar-title bg-white-10 rounded">
                      <i class="fas fa-users fa-lg"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </a>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
          {% if view_all %}
          <a href="{% url 'reporting:schedule_list' %}" class="text-decoration-none">
          {% else %}
          <a href="{% url 'reporting:schedule_list' %}?user={{ selected_user.id }}" class="text-decoration-none">
          {% endif %}
            <div class="card bg-info text-white card-hover">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="flex-grow-1">
                    <small class="text-white-50 mb-1 d-block">ì˜ˆì • ì¼ì •</small>
                    <h3 class="mb-0">{{ pending_schedules }}</h3>
                  </div>
                  <div class="avatar-sm">
                    <div class="avatar-title bg-white-10 rounded">
                      <i class="fas fa-calendar-alt fa-lg"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </a>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
          {% if view_all %}
          <a href="{% url 'reporting:history_list' %}" class="text-decoration-none">
          {% else %}
          <a href="{% url 'reporting:history_list' %}?user={{ selected_user.id }}" class="text-decoration-none">
          {% endif %}
            <div class="card bg-success text-white card-hover">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="flex-grow-1">
                    <small class="text-white-50 mb-1 d-block">í™œë™ í˜„í™©</small>
                    <h3 class="mb-0">{{ total_histories }}</h3>
                  </div>
                  <div class="avatar-sm">
                    <div class="avatar-title bg-white-10 rounded">
                      <i class="fas fa-chart-line fa-lg"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </a>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
          {% if view_all %}
          <a href="{% url 'reporting:history_list' %}?action_type=delivery_schedule" class="text-decoration-none">
          {% else %}
          <a href="{% url 'reporting:history_list' %}?user={{ selected_user.id }}&action_type=delivery_schedule" class="text-decoration-none">
          {% endif %}
            <div class="card bg-warning text-white card-hover">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="flex-grow-1">
                    <small class="text-white-50 mb-1 d-block">ì´ ë‚©í’ˆê¸ˆì•¡</small>
                    <h3 class="mb-0">
                      {% load currency_filters %}{{ total_delivery_amount|floatformat:0|currency_format }}ì›
                    </h3>
                  </div>
                  <div class="avatar-sm">
                    <div class="avatar-title bg-white-10 rounded">
                      <i class="fas fa-won-sign fa-lg"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </a>
        </div>
      </div>

      <!-- ì¶”ê°€ ì„±ê³¼ ì¹´ë“œ -->
      <div class="row mb-4 d-none d-md-flex">
        <!-- í€ë„¬ ë¶„ì„ ì¹´ë“œ -->
        <div class="col-lg-3 col-md-6 mb-3">
          <a href="{% url 'reporting:funnel_dashboard' %}{% if view_all %}?view_all=true{% else %}?user={{ selected_user.id }}{% endif %}" class="text-decoration-none">
            <div class="card text-white card-hover" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="flex-grow-1">
                    <small class="text-white-50 mb-1 d-block">í€ë„¬ ë¶„ì„</small>
                    <h3 class="mb-0"><i class="fas fa-chart-line"></i></h3>
                    <small class="text-white-50">ì˜ì—… ì „í™˜ìœ¨ ë¶„ì„</small>
                  </div>
                  <div class="avatar-sm">
                    <div class="avatar-title bg-white-10 rounded">
                      <i class="fas fa-filter fa-lg"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </a>
        </div>

        <!-- ìº˜ë¦°ë” ì¹´ë“œ -->
        <div class="col-lg-3 col-md-6 mb-3">
          <a href="{% url 'reporting:schedule_calendar' %}{% if not view_all %}?user={{ selected_user.id }}{% endif %}" class="text-decoration-none">
            <div class="card text-white card-hover" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="flex-grow-1">
                    <small class="text-white-50 mb-1 d-block">ì¼ì • ìº˜ë¦°ë”</small>
                    <h3 class="mb-0"><i class="fas fa-calendar-alt"></i></h3>
                    <small class="text-white-50">ì¼ì • í•œëˆˆì— ë³´ê¸°</small>
                  </div>
                  <div class="avatar-sm">
                    <div class="avatar-title bg-white-10 rounded">
                      <i class="fas fa-calendar-check fa-lg"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </a>
        </div>

        {% if request.is_hanagwahak %}
        <div class="col-lg-3 col-md-6 mb-3">
          {% if view_all %}
          <a href="{% url 'reporting:history_list' %}?action_type=service" class="text-decoration-none">
          {% else %}
          <a href="{% url 'reporting:history_list' %}?user={{ selected_user.id }}&action_type=service" class="text-decoration-none">
          {% endif %}
            <div class="card bg-purple text-white card-hover" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="flex-grow-1">
                    <small class="text-white-50 mb-1 d-block">ì„œë¹„ìŠ¤ í˜„í™©</small>
                    <h3 class="mb-0">{{ total_services }}</h3>
                  </div>
                  <div class="avatar-sm">
                    <div class="avatar-title bg-white-10 rounded">
                      <i class="fas fa-tools fa-lg"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </a>
        </div>
        {% endif %}
      </div>

      <!-- ëª¨ë°”ì¼ ì„±ê³¼ ì¹´ë“œ ìŠ¬ë¼ì´ë” -->
      <div class="d-md-none mb-4">
        <div class="mobile-slider">
          {% if view_all %}
          <a href="{% url 'reporting:followup_list' %}" class="text-decoration-none">
          {% else %}
          <a href="{% url 'reporting:salesman_detail' selected_user.id %}" class="text-decoration-none">
          {% endif %}
            <div class="card bg-primary text-white">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="flex-grow-1">
                    <small class="text-white-50 mb-1 d-block">ì´ ê³ ê°ìˆ˜</small>
                    <h3 class="mb-0">{{ total_followups }}</h3>
                  </div>
                  <div class="avatar-sm">
                    <div class="avatar-title bg-white-10 rounded">
                      <i class="fas fa-users fa-lg"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </a>

          {% if view_all %}
          <a href="{% url 'reporting:schedule_list' %}" class="text-decoration-none">
          {% else %}
          <a href="{% url 'reporting:schedule_list' %}?user={{ selected_user.id }}" class="text-decoration-none">
          {% endif %}
            <div class="card bg-info text-white">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="flex-grow-1">
                    <small class="text-white-50 mb-1 d-block">ì˜ˆì • ì¼ì •</small>
                    <h3 class="mb-0">{{ pending_schedules }}</h3>
                  </div>
                  <div class="avatar-sm">
                    <div class="avatar-title bg-white-10 rounded">
                      <i class="fas fa-calendar-alt fa-lg"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </a>

          {% if view_all %}
          <a href="{% url 'reporting:history_list' %}" class="text-decoration-none">
          {% else %}
          <a href="{% url 'reporting:history_list' %}?user={{ selected_user.id }}" class="text-decoration-none">
          {% endif %}
            <div class="card bg-success text-white">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="flex-grow-1">
                    <small class="text-white-50 mb-1 d-block">í™œë™ í˜„í™©</small>
                    <h3 class="mb-0">{{ total_histories }}</h3>
                  </div>
                  <div class="avatar-sm">
                    <div class="avatar-title bg-white-10 rounded">
                      <i class="fas fa-chart-line fa-lg"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </a>

          {% if view_all %}
          <a href="{% url 'reporting:history_list' %}?action_type=delivery_schedule" class="text-decoration-none">
          {% else %}
          <a href="{% url 'reporting:history_list' %}?user={{ selected_user.id }}&action_type=delivery_schedule" class="text-decoration-none">
          {% endif %}
            <div class="card bg-warning text-white">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="flex-grow-1">
                    <small class="text-white-50 mb-1 d-block">ì´ ë‚©í’ˆê¸ˆì•¡</small>
                    <h3 class="mb-0">
                      {% load currency_filters %}{{ total_delivery_amount|floatformat:0|currency_format }}ì›
                    </h3>
                  </div>
                  <div class="avatar-sm">
                    <div class="avatar-title bg-white-10 rounded">
                      <i class="fas fa-won-sign fa-lg"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </a>
        </div>
      </div>      <!-- ì°¨íŠ¸ ì„¹ì…˜ - ë°ìŠ¤í¬íƒ‘ -->
      <div class="row mb-4 d-none d-md-flex">
        <!-- ì›”ë³„ í™œë™ ì¶”ì´ -->
        <div class="col-lg-8 mb-4">
          <div class="card">
            <div class="card-header">
              <h6 class="card-title mb-0">
                <i class="fas fa-chart-line me-2"></i>ì›”ë³„ í™œë™ ì¶”ì´ ({{current_year }}ë…„)
              </h6>
            </div>
            <div class="card-body">
              <canvas id="monthlyChart" height="100"></canvas>
            </div>
          </div>
        </div>

        <!-- ê³ ê°ë³„ ë‚©í’ˆ í˜„í™© -->
        <div class="col-lg-4 mb-4">
          <div class="card">
            <div class="card-header">
              <h6 class="card-title mb-0">
                <i class="fas fa-chart-pie me-2"></i>ê³ ê°ë³„ ë‚©í’ˆ í˜„í™©
              </h6>
            </div>
            <div class="card-body">
              {% if top_customers %}
              <div style="position: relative; height: 280px;">
                <canvas id="customerChart"></canvas>
              </div>
              {% else %}
              <div class="text-center py-4">
                <i class="fas fa-chart-pie fa-2x text-muted mb-2"></i>
                <p class="text-muted">ë‚©í’ˆ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- ì°¨íŠ¸ ì„¹ì…˜ - ëª¨ë°”ì¼ ìŠ¬ë¼ì´ë” -->
      <div class="d-md-none mb-4">
        <div class="mobile-chart-slider">
          <!-- ì›”ë³„ í™œë™ ì¶”ì´ -->
          <div class="chart-container">
            <div class="card">
              <div class="card-header">
                <h6 class="card-title mb-0">
                  <i class="fas fa-chart-line me-2"></i>ì›”ë³„ í™œë™ ì¶”ì´ ({{current_year }}ë…„)
                </h6>
              </div>
              <div class="card-body">
                <canvas id="monthlyChartMobile" height="150"></canvas>
              </div>
            </div>
          </div>

          <!-- ê³ ê°ë³„ ë‚©í’ˆ í˜„í™© -->
          <div class="chart-container">
            <div class="card">
              <div class="card-header">
                <h6 class="card-title mb-0">
                  <i class="fas fa-chart-pie me-2"></i>ê³ ê°ë³„ ë‚©í’ˆ í˜„í™©
                </h6>
              </div>
              <div class="card-body">
                {% if top_customers %}
                <div style="position: relative; height: 280px;">
                  <canvas id="customerChartMobile"></canvas>
                </div>
                {% else %}
                <div class="text-center py-4">
                  <i class="fas fa-chart-pie fa-2x text-muted mb-2"></i>
                  <p class="text-muted">ë‚©í’ˆ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ì›”ë³„ ìƒì„¸ ë°ì´í„° -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h6 class="card-title mb-0">
                <i class="fas fa-table me-2"></i>ì›”ë³„ ìƒì„¸ í˜„í™© ({{ current_year}}ë…„)
              </h6>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead class="table-light">
                    <tr>
                      <th>ì›”</th>
                      <th>ê³ ê° ë¯¸íŒ…</th>
                      <th>ë‚©í’ˆ ê±´ìˆ˜</th>
                      {% if request.is_hanagwahak %}
                      <th>ì„œë¹„ìŠ¤</th>
                      {% endif %}
                      <th>ë‚©í’ˆ ê¸ˆì•¡</th>
                      <th>ë¹„ê³ </th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for data in monthly_data %}
                    <tr>
                      <td><strong>{{ data.month }}</strong></td>
                      <td>
                        {% if view_all %}
                        <a href="{% url 'reporting:history_list' %}?action_type=customer_meeting" class="text-decoration-none">
                        {% else %}
                        <a href="{% url 'reporting:history_list' %}?user={{ selected_user.id }}&action_type=customer_meeting" class="text-decoration-none">
                        {% endif %}
                          <span class="badge bg-primary"
                            >{{ data.meetings }}ê±´</span
                          >
                        </a>
                      </td>
                      <td>
                        {% if view_all %}
                        <a href="{% url 'reporting:history_list' %}?action_type=delivery_schedule" class="text-decoration-none">
                        {% else %}
                        <a href="{% url 'reporting:history_list' %}?user={{ selected_user.id }}&action_type=delivery_schedule" class="text-decoration-none">
                        {% endif %}
                          <span class="badge bg-success"
                            >{{ data.deliveries }}ê±´</span
                          >
                        </a>
                      </td>
                      {% if request.is_hanagwahak %}
                      <td>
                        {% if view_all %}
                        <a href="{% url 'reporting:history_list' %}?action_type=service" class="text-decoration-none">
                        {% else %}
                        <a href="{% url 'reporting:history_list' %}?user={{ selected_user.id }}&action_type=service" class="text-decoration-none">
                        {% endif %}
                          <span class="badge bg-info"
                            >{{ data.services }}ê±´</span
                          >
                        </a>
                      </td>
                      {% endif %}
                      <td>
                        <strong>{% load currency_filters %}{{ data.amount|floatformat:0|currency_format }}ì›</strong>
                      </td>
                      <td>
                        {% if request.is_hanagwahak %}
                        {% if data.meetings == 0 and data.deliveries == 0 and data.services == 0 %}
                        <span class="text-muted">í™œë™ ì—†ìŒ</span>
                        {% elif data.deliveries == 0 and data.services == 0 %}
                        <span class="text-warning">ë¯¸íŒ…ë§Œ ì§„í–‰</span>
                        {% else %}
                        <span class="text-success">ì •ìƒ</span>
                        {% endif %}
                        {% else %}
                        {% if data.meetings == 0 and data.deliveries == 0 %}
                        <span class="text-muted">í™œë™ ì—†ìŒ</span>
                        {% elif data.deliveries == 0 %}
                        <span class="text-warning">ë¯¸íŒ…ë§Œ ì§„í–‰</span>
                        {% else %}
                        <span class="text-success">ì •ìƒ í™œë™</span>
                        {% endif %}
                        {% endif %}
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endif %} {% if not no_salesmen %}
    </div>
    {% endif %}
  </div>
</div>

<!-- Chart.js ìŠ¤í¬ë¦½íŠ¸ -->
{% if not no_salesmen %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>  document.addEventListener('DOMContentLoaded', function() {
      // ì°¨íŠ¸ ë°ì´í„° ì¤€ë¹„
      const monthlyLabels = [{% for data in monthly_data %}'{{ data.month }}'{% if not forloop.last %},{% endif %}{% endfor %}];
      const meetingsData = [{% for data in monthly_data %}{{ data.meetings }}{% if not forloop.last %},{% endif %}{% endfor %}];
      const deliveriesData = [{% for data in monthly_data %}{{ data.deliveries }}{% if not forloop.last %},{% endif %}{% endfor %}];
      
      // ì°¨íŠ¸ ê³µí†µ ì˜µì…˜
      const chartOptions = {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
              y: {
                  beginAtZero: true
              }
          }
      };

      // ë°ìŠ¤í¬íƒ‘ ì›”ë³„ í™œë™ ì¶”ì´ ì°¨íŠ¸
      const monthlyCtx = document.getElementById('monthlyChart');
      if (monthlyCtx) {
          new Chart(monthlyCtx.getContext('2d'), {
              type: 'line',
              data: {
                  labels: monthlyLabels,
                  datasets: [{
                      label: 'ê³ ê° ë¯¸íŒ…',
                      data: meetingsData,
                      borderColor: 'rgb(54, 162, 235)',
                      backgroundColor: 'rgba(54, 162, 235, 0.1)',
                      tension: 0.3
                  }, {
                      label: 'ë‚©í’ˆ ê±´ìˆ˜',
                      data: deliveriesData,
                      borderColor: 'rgb(75, 192, 192)',
                      backgroundColor: 'rgba(75, 192, 192, 0.1)',
                      tension: 0.3
                  }]
              },
              options: chartOptions
          });
      }

      // ëª¨ë°”ì¼ ì›”ë³„ í™œë™ ì¶”ì´ ì°¨íŠ¸
      const monthlyMobileCtx = document.getElementById('monthlyChartMobile');
      if (monthlyMobileCtx) {
          new Chart(monthlyMobileCtx.getContext('2d'), {
              type: 'line',
              data: {
                  labels: monthlyLabels,
                  datasets: [{
                      label: 'ê³ ê° ë¯¸íŒ…',
                      data: meetingsData,
                      borderColor: 'rgb(54, 162, 235)',
                      backgroundColor: 'rgba(54, 162, 235, 0.1)',
                      tension: 0.3
                  }, {
                      label: 'ë‚©í’ˆ ê±´ìˆ˜',
                      data: deliveriesData,
                      borderColor: 'rgb(75, 192, 192)',
                      backgroundColor: 'rgba(75, 192, 192, 0.1)',
                      tension: 0.3
                  }]
              },
              options: chartOptions
          });      }

      // ê³ ê°ë³„ ë‚©í’ˆ í˜„í™© ì°¨íŠ¸ (ë°ìŠ¤í¬íƒ‘ & ëª¨ë°”ì¼)
      {% if top_customers %}
      const customerLabels = [{% for customer, amount in top_customers %}'{{ customer|truncatechars:15 }}'{% if not forloop.last %},{% endif %}{% endfor %}];
      const customerData = [{% for customer, amount in top_customers %}{{ amount }}{% if not forloop.last %},{% endif %}{% endfor %}];
      const customerColors = [
          '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
          '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
      ];

      const customerChartOptions = {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
              legend: {
                  position: 'right',
                  labels: {
                      padding: 8,
                      usePointStyle: true,
                      font: {
                          size: 11
                      },
                      boxWidth: 12
                  }
              },
              tooltip: {
                  callbacks: {
                      label: function(context) {
                          const fullLabel = [{% for customer, amount in top_customers %}'{{ customer }}'{% if not forloop.last %},{% endif %}{% endfor %}][context.dataIndex];
                          const value = context.parsed.toLocaleString();
                          return fullLabel + ': ' + value + 'ì›';
                      }
                  }
              }
          },
          layout: {
              padding: {
                  left: 10,
                  right: 10,
                  top: 10,
                  bottom: 10
              }
          }
      };

      // ë°ìŠ¤í¬íƒ‘ ê³ ê° ì°¨íŠ¸
      const customerCtx = document.getElementById('customerChart');
      if (customerCtx) {
          new Chart(customerCtx.getContext('2d'), {
              type: 'doughnut',
              data: {
                  labels: customerLabels,
                  datasets: [{
                      data: customerData,
                      backgroundColor: customerColors
                  }]
              },
              options: customerChartOptions
          });
      }

      // ëª¨ë°”ì¼ ê³ ê° ì°¨íŠ¸
      const customerMobileCtx = document.getElementById('customerChartMobile');
      if (customerMobileCtx) {
          new Chart(customerMobileCtx.getContext('2d'), {
              type: 'doughnut',
              data: {
                  labels: customerLabels,
                  datasets: [{
                      data: customerData,
                      backgroundColor: customerColors
                  }]
              },
              options: customerChartOptions
          });
      }
      {% endif %}
  });
</script>

<style>
.card-hover {
  transition: all 0.3s ease;
  cursor: pointer;
}

.card-hover:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.bg-white-10 {
  background-color: rgba(255, 255, 255, 0.1) !important;
}
</style>

{% endif %} {% endblock %}
