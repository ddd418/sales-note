{% extends "reporting/base.html" %} 
{% block title %}{{ page_title }} - ì˜ì—… ë³´ê³  ì‹œìŠ¤í…œ{% endblock %} 

{% block extra_css %}
<style>
/* ============================================
   Select2 ë‹¤í¬ëª¨ë“œ ìŠ¤íƒ€ì¼ - ìµœëŒ€ ìš°ì„ ìˆœìœ„
   ============================================ */
.select2-container--default .select2-selection--single {
  background-color: hsl(222, 47%, 14%) !important;
  border-color: hsl(217, 33%, 22%) !important;
}

.select2-container--default .select2-selection--single .select2-selection__rendered {
  color: hsl(210, 40%, 98%) !important;
}

.select2-container--default .select2-selection--single .select2-selection__arrow b {
  border-color: hsl(215, 20%, 65%) transparent transparent transparent !important;
}

.select2-dropdown {
  background-color: hsl(222, 47%, 14%) !important;
  border-color: hsl(217, 33%, 22%) !important;
}

.select2-container--default .select2-search--dropdown .select2-search__field {
  background-color: hsl(222, 47%, 14%) !important;
  border-color: hsl(217, 33%, 22%) !important;
  color: hsl(210, 40%, 98%) !important;
}

.select2-results {
  background-color: hsl(222, 47%, 14%) !important;
}

.select2-results__options {
  background-color: hsl(222, 47%, 14%) !important;
}

.select2-container--default .select2-results__option {
  background-color: hsl(222, 47%, 14%) !important;
  color: hsl(210, 40%, 98%) !important;
}

.select2-container--default .select2-results__option--highlighted,
.select2-container--default .select2-results__option--highlighted[aria-selected],
.select2-container--default .select2-results__option:hover,
.select2-results__option--highlighted {
  background-color: hsl(217, 91%, 60%) !important;
  color: #000000 !important;
}

.select2-container--default .select2-results__option[aria-selected=true] {
  background-color: hsl(217, 91%, 60%) !important;
  color: white !important;
}

.select2-container--default .select2-results__option--highlighted[aria-selected=true] {
  background-color: hsl(217, 91%, 50%) !important;
  color: white !important;
}

/* Select2 ë©”ì‹œì§€ */
.select2-results__message {
  background-color: hsl(222, 47%, 14%) !important;
  color: hsl(215, 20%, 65%) !important;
}

/* ============================================
   ëª¨ë‹¬ Z-INDEX ë° ì˜¤ë²„ë ˆì´ ìˆ˜ì • (CRITICAL FIX)
   ============================================ */

/* backdropì„ ì™„ì „íˆ ìˆ¨ê¹€ */
.modal-backdrop {
  display: none !important;
}

/* ëª¨ë‹¬ ìì²´ - ì¸ë¼ì¸ z-index ì¡´ì¤‘ */
.modal {
  pointer-events: none !important; /* ëª¨ë‹¬ ì»¨í…Œì´ë„ˆëŠ” íˆ¬ëª…í•˜ê²Œ */
}

/* ëª¨ë‹¬ ë‹¤ì´ì–¼ë¡œê·¸ë§Œ í´ë¦­ ê°€ëŠ¥í•˜ê²Œ */
.modal-dialog {
  pointer-events: auto !important;
  position: relative;
  z-index: 1;
}

/* ëª¨ë‹¬ ì»¨í…ì¸ ë¥¼ í™•ì‹¤íˆ í´ë¦­ ê°€ëŠ¥í•˜ê²Œ */
.modal-content {
  position: relative;
  pointer-events: auto !important;
  background-color: #fff;
  border: 1px solid rgba(0, 0, 0, 0.2);
  border-radius: 0.3rem;
  box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

/* ëª¨ë‹¬ ë‚´ë¶€ì˜ ëª¨ë“  ìš”ì†Œê°€ í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡ */
.modal-header,
.modal-body,
.modal-footer,
.modal-header *,
.modal-body *,
.modal-footer * {
  pointer-events: auto !important;
}

/* ============================================
   ê¸°ì¡´ ìŠ¤íƒ€ì¼
   ============================================ */

/* ë‚ ì§œ/ì‹œê°„ inputì˜ ê¸°ë³¸ ìº˜ë¦°ë”/ì‹œê³„ ì•„ì´ì½˜ ìˆ¨ê¸°ê¸° */
input[type="date"]::-webkit-calendar-picker-indicator,
input[type="time"]::-webkit-calendar-picker-indicator {
  display: none;
  -webkit-appearance: none;
}

input[type="date"]::-webkit-inner-spin-button,
input[type="time"]::-webkit-inner-spin-button {
  display: none;
  -webkit-appearance: none;
}

/* Firefox */
input[type="date"],
input[type="time"] {
  -moz-appearance: textfield;
}

/* í€ë„¬ ë“±ë¡ ì„¹ì…˜ ë ˆì´ë¸” ë°˜ì‘í˜• - í•­ìƒ í•œ ì¤„ í‘œì‹œ */
#funnel-register-section label,
#funnel-register-section label.form-label,
#funnel-register-section .form-label {
  white-space: nowrap !important;
  word-break: keep-all !important;
  overflow-wrap: normal !important;
}

/* ëª¨ë°”ì¼ ì „ìš©: ì‘ì€ í™”ë©´ì—ì„œë„ í•œ ì¤„ ìœ ì§€ */
@media (max-width: 768px) {
  #funnel-register-section label,
  #funnel-register-section label.form-label,
  #funnel-register-section .form-label {
    font-size: 0.85rem;
    white-space: nowrap !important;
    word-break: keep-all !important;
    overflow-wrap: normal !important;
    display: inline-block;
  }
}

/* ì´ˆì†Œí˜• í™”ë©´ (360px ì´í•˜) */
@media (max-width: 360px) {
  #funnel-register-section label,
  #funnel-register-section label.form-label,
  #funnel-register-section .form-label {
    font-size: 0.8rem;
  }
}

/* ê²¬ì /ë‚©í’ˆ í’ˆëª© ê´€ë¦¬ ëª¨ë‹¬ ë°˜ì‘í˜• */
/* ëª¨ë‹¬ ë‚´ ë ˆì´ë¸” í•œ ì¤„ í‘œì‹œ */
#scheduleDeliveryItemsModal .form-label,
#scheduleDeliveryItemsModal label {
  white-space: nowrap !important;
  word-break: keep-all !important;
  overflow-wrap: normal !important;
}

/* íƒœë¸”ë¦¿ (768px ~ 1024px) */
@media (min-width: 768px) and (max-width: 1024px) {
  #scheduleDeliveryItemsModal .modal-dialog {
    max-width: 90%;
    margin: 1rem auto;
  }
  
  #scheduleDeliveryItemsModal .modal-body {
    padding: 1.5rem;
    max-height: 70vh;
    overflow-y: auto;
  }
  
  #scheduleDeliveryItemsModal .form-label {
    font-size: 0.85rem;
  }
  
  #scheduleDeliveryItemsModal .form-control,
  #scheduleDeliveryItemsModal .form-select {
    font-size: 0.95rem;
  }
}

/* ëª¨ë°”ì¼ (768px ì´í•˜) */
@media (max-width: 768px) {
  #scheduleDeliveryItemsModal .modal-dialog {
    max-width: 95%;
    margin: 0.5rem auto;
  }
  
  #scheduleDeliveryItemsModal .modal-body {
    padding: 1rem;
    max-height: 75vh;
    overflow-y: auto;
  }
  
  /* ì´ì•¡ í‘œì‹œ ì¹´ë“œ ë°˜ì‘í˜• */
  #scheduleDeliveryItemsModal .card-body .row > div {
    margin-bottom: 0.5rem;
  }
  
  #scheduleDeliveryItemsModal .card-body .row > div:last-child {
    margin-bottom: 0;
  }
  
  /* í’ˆëª© ì¶”ê°€ ë²„íŠ¼ */
  #scheduleDeliveryItemsModal .d-flex.justify-content-between {
    flex-direction: column;
    gap: 0.5rem;
  }
  
  #scheduleDeliveryItemsModal .d-flex.justify-content-between .alert {
    margin-right: 0 !important;
  }
  
  /* í’ˆëª© í–‰ ë°˜ì‘í˜• */
  #scheduleDeliveryItemsModal .delivery-item,
  #scheduleDeliveryItemsModal .item-row {
    padding: 0.75rem !important;
  }
  
  #scheduleDeliveryItemsModal .delivery-item .col-md-4,
  #scheduleDeliveryItemsModal .delivery-item .col-md-2,
  #scheduleDeliveryItemsModal .delivery-item .col-md-3,
  #scheduleDeliveryItemsModal .item-row .col-md-4,
  #scheduleDeliveryItemsModal .item-row .col-md-2,
  #scheduleDeliveryItemsModal .item-row .col-md-3 {
    margin-bottom: 0.75rem;
  }
  
  /* ë ˆì´ë¸” í¬ê¸° ì¡°ì • */
  #scheduleDeliveryItemsModal .form-label {
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
  }
  
  /* ì…ë ¥ í•„ë“œ í¬ê¸° ì¡°ì • */
  #scheduleDeliveryItemsModal .form-control,
  #scheduleDeliveryItemsModal .form-select {
    font-size: 0.9rem;
    padding: 0.5rem;
  }
  
  /* ë²„íŠ¼ í¬ê¸° ì¡°ì • */
  #scheduleDeliveryItemsModal .btn {
    font-size: 0.85rem;
    padding: 0.5rem 0.75rem;
  }
  
  /* ì´ì•¡ ì¹´ë“œ í…ìŠ¤íŠ¸ */
  #scheduleDeliveryItemsModal .fs-5 {
    font-size: 1rem !important;
  }
}

/* ê²¬ì /ë‚©í’ˆ í’ˆëª©ì˜ col-md í´ë˜ìŠ¤ ëª¨ë°”ì¼ ë°˜ì‘í˜• */
@media (max-width: 768px) {
  .item-row .col-md-4,
  .item-row .col-md-2,
  .item-row .col-md-3,
  .delivery-item .col-md-4,
  .delivery-item .col-md-2,
  .delivery-item .col-md-3 {
    flex: 0 0 100%;
    max-width: 100%;
  }
}

/* íŒ”ë¡œìš°ì—… ëª¨ë‹¬ z-index ì¡°ì • */
#followupModal {
  z-index: 100050 !important;
}
#followupModal .modal-dialog {
  z-index: 100051 !important;
  position: relative;
}
#followupModal .modal-content {
  z-index: 100052 !important;
  position: relative;
  pointer-events: auto !important;
}

/* ë‚©í’ˆ í’ˆëª© ëª¨ë‹¬ z-index ì¡°ì • */
#scheduleDeliveryItemsModal {
  z-index: 100000 !important;
}
#scheduleDeliveryItemsModal .modal-dialog {
  z-index: 100001 !important;
  position: relative;
}
#scheduleDeliveryItemsModal .modal-content {
  z-index: 100002 !important;
  position: relative;
  pointer-events: auto !important;
}

/* ê²¬ì  ì„ íƒ ëª¨ë‹¬ z-index ì¡°ì • */
#quoteSelectionModal {
  z-index: 100100 !important;
}
#quoteSelectionModal .modal-dialog {
  z-index: 100101 !important;
  position: relative;
}
#quoteSelectionModal .modal-content {
  z-index: 100102 !important;
  position: relative;
  pointer-events: auto !important;
}

/* ëª¨ë‹¬ backdrop ì„¤ì • */
.modal-backdrop.show {
  opacity: 0.5;
}
div.modal-backdrop {
  z-index: 99999 !important;
}

/* ì œí’ˆ ê²€ìƒ‰ ê²°ê³¼ ë“œë¡­ë‹¤ìš´ ìŠ¤íƒ€ì¼ */
.product-search-results,
.quote-search-results {
  max-height: 400px;
  overflow-y: auto;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  border-radius: 4px;
  scrollbar-width: thin;
  scrollbar-color: #cbd5e0 #f7fafc;
}

.product-search-results::-webkit-scrollbar,
.quote-search-results::-webkit-scrollbar {
  width: 8px;
}

.product-search-results::-webkit-scrollbar-track,
.quote-search-results::-webkit-scrollbar-track {
  background: #f7fafc;
  border-radius: 4px;
}

.product-search-results::-webkit-scrollbar-thumb,
.quote-search-results::-webkit-scrollbar-thumb {
  background: #cbd5e0;
  border-radius: 4px;
}

.product-search-results::-webkit-scrollbar-thumb:hover,
.quote-search-results::-webkit-scrollbar-thumb:hover {
  background: #a0aec0;
}

/* ============================================
   ğŸŒ™ ë‹¤í¬ ëª¨ë“œ ìŠ¤íƒ€ì¼
   ============================================ */

/* í˜ì´ì§€ íƒ€ì´í‹€ */
.page-title {
  color: var(--text-primary) !important;
}

/* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
.card {
  background: var(--surface) !important;
  border-color: var(--border) !important;
}

.card-header {
  background: var(--surface-hover) !important;
  border-color: var(--border) !important;
  color: var(--text-primary) !important;
}

.card-body {
  background: var(--surface) !important;
  color: var(--text-primary) !important;
}

.card-title {
  color: var(--text-primary) !important;
}

.card-footer {
  background: var(--surface) !important;
  border-color: var(--border) !important;
}

/* í¼ ì»¨íŠ¸ë¡¤ */
.form-control,
.form-select {
  background: var(--surface) !important;
  border-color: var(--border) !important;
  color: var(--text-primary) !important;
}

.form-control::placeholder {
  color: var(--text-muted) !important;
}

.form-control:focus,
.form-select:focus {
  background: var(--surface) !important;
  border-color: var(--primary) !important;
  color: var(--text-primary) !important;
  box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2) !important;
}

/* ë‚ ì§œ/ì‹œê°„ ì…ë ¥ í•„ë“œ */
input[type="date"],
input[type="time"] {
  background: var(--surface) !important;
  border-color: var(--border) !important;
  color: var(--text-primary) !important;
}

input[type="date"]::-webkit-calendar-picker-indicator,
input[type="time"]::-webkit-calendar-picker-indicator {
  filter: invert(0.8);
}

/* í¼ ë¼ë²¨ */
.form-label,
label {
  color: var(--text-primary) !important;
}

/* í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
.text-muted {
  color: var(--text-muted) !important;
}

.text-secondary {
  color: var(--text-secondary) !important;
}

/* ëª¨ë‹¬ ë‹¤í¬ ëª¨ë“œ */
.modal-content {
  background-color: var(--surface) !important;
  border-color: var(--border) !important;
  color: var(--text-primary) !important;
}

.modal-header {
  background: var(--surface-hover) !important;
  border-color: var(--border) !important;
  color: var(--text-primary) !important;
}

.modal-header .modal-title {
  color: var(--text-primary) !important;
}

.modal-header .btn-close {
  filter: invert(1) grayscale(100%) brightness(200%);
}

.modal-body {
  background: var(--surface) !important;
  color: var(--text-primary) !important;
}

.modal-footer {
  background: var(--surface) !important;
  border-color: var(--border) !important;
}

/* ë¦¬ìŠ¤íŠ¸ ê·¸ë£¹ */
.list-group-item {
  background: var(--surface) !important;
  border-color: var(--border) !important;
  color: var(--text-primary) !important;
}

.list-group-item:hover {
  background: var(--surface-hover) !important;
}

/* alert ìŠ¤íƒ€ì¼ */
.alert-info {
  background: rgba(59, 130, 246, 0.1) !important;
  border-color: rgba(59, 130, 246, 0.3) !important;
  color: var(--text-primary) !important;
}

.alert-warning {
  background: rgba(245, 158, 11, 0.1) !important;
  border-color: rgba(245, 158, 11, 0.3) !important;
  color: var(--text-primary) !important;
}

.alert-success {
  background: rgba(16, 185, 129, 0.1) !important;
  border-color: rgba(16, 185, 129, 0.3) !important;
  color: var(--text-primary) !important;
}

/* í…Œì´ë¸” */
.table {
  color: var(--text-primary) !important;
}

.table thead th {
  background: var(--surface-hover) !important;
  border-color: var(--border) !important;
  color: var(--text-primary) !important;
}

.table tbody td {
  background: var(--surface) !important;
  border-color: var(--border) !important;
  color: var(--text-primary) !important;
}

.table-hover tbody tr:hover td {
  background: var(--surface-hover) !important;
}

/* ë²„íŠ¼ outline ìŠ¤íƒ€ì¼ */
.btn-outline-secondary {
  color: var(--text-secondary) !important;
  border-color: var(--border) !important;
}

.btn-outline-secondary:hover {
  background: var(--surface-hover) !important;
  color: var(--text-primary) !important;
}

/* ì œí’ˆ ê²€ìƒ‰ ê²°ê³¼ ë‹¤í¬ ëª¨ë“œ */
.product-search-results,
.quote-search-results {
  background: var(--surface) !important;
  border: 1px solid var(--border) !important;
}

.product-search-results .list-group-item,
.quote-search-results .list-group-item {
  background: var(--surface) !important;
  border-color: var(--border) !important;
  color: var(--text-primary) !important;
}

.product-search-results .list-group-item:hover,
.quote-search-results .list-group-item:hover {
  background: var(--surface-hover) !important;
}

/* ë°°ê²½ìƒ‰ ì˜¤ë²„ë¼ì´ë“œ */
.bg-light {
  background: var(--surface-hover) !important;
}

.bg-white {
  background: var(--surface) !important;
}

/* êµ¬ë¶„ì„  */
hr {
  border-color: var(--border) !important;
  opacity: 1;
}

/* í’ˆëª© í–‰ ìŠ¤íƒ€ì¼ */
.delivery-item,
.item-row {
  background: var(--surface) !important;
  border-color: var(--border) !important;
}

/* ìŠ¤í¬ë¡¤ë°” ë‹¤í¬ ëª¨ë“œ */
.product-search-results::-webkit-scrollbar-track,
.quote-search-results::-webkit-scrollbar-track {
  background: var(--surface);
}

.product-search-results::-webkit-scrollbar-thumb,
.quote-search-results::-webkit-scrollbar-thumb {
  background: var(--border);
}

/* ì¶”ê°€ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
strong {
  color: var(--text-primary);
}

small.text-muted {
  color: var(--text-muted) !important;
}

/* ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ ê°œì„  */
.form-check-input {
  width: 1.25em !important;
  height: 1.25em !important;
  background-color: var(--surface) !important;
  border: 2px solid var(--primary) !important;
  cursor: pointer;
}

.form-check-input:checked {
  background-color: var(--primary) !important;
  border-color: var(--primary) !important;
}

.form-check-input:focus {
  border-color: var(--primary) !important;
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.25) !important;
}

.form-check-label {
  color: var(--text-primary) !important;
  cursor: pointer;
  padding-left: 0.25rem;
}

/* í€ë„¬ ë“±ë¡ ì²´í¬ë°•ìŠ¤ ê°•ì¡° */
#funnel-register-section .form-check {
  padding: 1rem;
  background: rgba(99, 102, 241, 0.1);
  border-radius: var(--radius);
  border: 1px solid rgba(99, 102, 241, 0.3);
}

#funnel-register-section .form-check-input {
  width: 1.5em !important;
  height: 1.5em !important;
  border: 2px solid var(--primary) !important;
  margin-top: 0.15em;
}

#funnel-register-section .form-check-label strong {
  color: var(--primary) !important;
  font-size: 1.1rem;
}

#funnel-register-section .form-text {
  color: var(--text-muted) !important;
  margin-top: 0.5rem;
  margin-left: 2rem;
}

/* ì„ ê²°ì œ ì²´í¬ë°•ìŠ¤ ê°•ì¡° */
#prepayment-section .form-check-input {
  width: 1.5em !important;
  height: 1.5em !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-10">
      <!-- í—¤ë” ì„¹ì…˜ -->
      <div
        class="page-header d-flex justify-content-between align-items-center mb-4"
      >
        <h1 class="page-title mb-0">
          <i class="fas fa-calendar-plus me-2"></i>{{ page_title }}
        </h1>
        <div>
          {% if schedule %}
          <a
            href="{% url 'reporting:schedule_detail' schedule.pk %}"
            class="btn btn-secondary"
            >ì·¨ì†Œ</a
          >
          {% else %}
          <a
            href="{% url 'reporting:schedule_calendar' %}"
            class="btn btn-secondary"
            >ì·¨ì†Œ</a
          >
          {% endif %}
        </div>
      </div>

      <!-- í¼ ì¹´ë“œ -->
      <div class="card">
        <div class="card-body">
          <form method="post" onsubmit="saveAllItems(); 
            // DEBUG: í¼ ì œì¶œ ì „ status í•„ë“œ í™•ì¸
            const statusField = document.querySelector('[name=status]');
            if (!statusField || !statusField.value) {
              console.error('[FORM_SUBMIT] ERROR: status field is missing or empty!');
              alert('ì˜¤ë¥˜: status í•„ë“œê°€ ì—†ê±°ë‚˜ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.');
            }
            return true;">
            {% csrf_token %}

            <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
            {% if form.errors %}
            <div class="alert alert-danger" role="alert">
              <strong>ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:</strong>
              <ul class="mb-0 mt-2">
                {% for field, errors in form.errors.items %}
                  {% for error in errors %}
                    <li><strong>{{ field }}:</strong> {{ error }}</li>
                  {% endfor %}
                {% endfor %}
              </ul>
            </div>
            {% endif %}

            <div class="row">
              <!-- ê¸°ë³¸ ì •ë³´ ì„¹ì…˜ -->
              <div class="col-md-6">
                <h3 class="mb-3 text-primary">
                  <i class="fas fa-info-circle me-2"></i>ê¸°ë³¸ ì •ë³´
                </h3>

                <div class="mb-3">
                  {{ form.followup.label_tag }} 
                  <div class="input-group">
                    <div style="flex: 1; position: relative;">
                      <input type="text" 
                             id="followup_search"
                             class="form-control"
                             placeholder="íŒ”ë¡œìš°ì—…ì„ ê²€ìƒ‰í•˜ì„¸ìš”..."
                             autocomplete="off"
                             onkeyup="window.searchFollowup(this.value)">
                      <select name="{{ form.followup.name }}" 
                              id="id_{{ form.followup.name }}"
                              style="display: none;">
                        <option value="">---------</option>
                        {% for choice_value, choice_label in form.followup.field.choices %}
                          <option value="{{ choice_value }}" 
                                  {% if form.instance.followup_id == choice_value or form.followup.value|stringformat:"s" == choice_value|stringformat:"s" %}selected{% endif %}>
                            {{ choice_label }}
                          </option>
                        {% endfor %}
                      </select>
                      <div id="followup_results" 
                           style="position: absolute; top: 100%; left: 0; right: 0; background: hsl(222, 47%, 14%); border: 1px solid hsl(217, 33%, 22%); border-top: none; max-height: 300px; overflow-y: auto; z-index: 1000; display: none; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);"
                           onclick="window.selectFollowupItem(event)"></div>
                    </div>
                    <button type="button" class="btn btn-outline-primary" id="addFollowupBtn" data-bs-toggle="modal" data-bs-target="#followupModal">
                      <i class="fas fa-plus"></i> ì‹ ê·œ ì¶”ê°€
                    </button>
                  </div>
                  <small class="form-text text-muted"
                    >ë°©ë¬¸í•  íŒ”ë¡œìš°ì—…ì„ ê²€ìƒ‰í•˜ì„¸ìš”</small
                  >
                </div>
                
                <script>
                // íŒ”ë¡œìš°ì—… ìë™ì™„ì„± - ì¸ë¼ì¸ ì‹¤í–‰
                (function() {
                    const searchInput = document.getElementById('followup_search');
                    const hiddenSelect = document.getElementById('id_followup');
                    const resultsDiv = document.getElementById('followup_results');
                    
                    // ê¸°ì¡´ ì„ íƒê°’ì´ ìˆìœ¼ë©´ ê²€ìƒ‰ì°½ì— í‘œì‹œ
                    if (hiddenSelect && searchInput) {
                        const selectedOption = hiddenSelect.querySelector('option:checked');
                        
                        if (selectedOption && selectedOption.value) {
                            searchInput.value = selectedOption.textContent.trim();
                        } else if (hiddenSelect.value) {
                            // valueëŠ” ìˆëŠ”ë° option:checkedê°€ ì—†ëŠ” ê²½ìš°
                            const opt = hiddenSelect.querySelector(`option[value="${hiddenSelect.value}"]`);
                            if (opt) {
                                searchInput.value = opt.textContent.trim();
                            }
                        }
                    }
                    
                    // ëª¨ë“  ì˜µì…˜ ì €ì¥ (í•¨ìˆ˜ë¡œ ë³€ê²½í•˜ì—¬ ë™ì ìœ¼ë¡œ ë¡œë“œ)
                    function loadAllOptions() {
                        const options = [];
                        if (hiddenSelect) {
                            for (let i = 0; i < hiddenSelect.options.length; i++) {
                                const opt = hiddenSelect.options[i];
                                if (opt.value) {
                                    options.push({
                                        id: opt.value,
                                        text: opt.textContent.trim()
                                    });
                                }
                            }
                        }
                        return options;
                    }
                    
                    // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡
                    window.searchFollowup = function(query) {
                        const allOptions = loadAllOptions(); // ë§¤ë²ˆ ìµœì‹  ì˜µì…˜ ë¡œë“œ
                        query = query.trim().toLowerCase();
                        
                        if (!query) {
                            resultsDiv.style.display = 'none';
                            return;
                        }
                        
                        const filtered = allOptions.filter(opt => 
                            opt.text.toLowerCase().includes(query)
                        ).slice(0, 30);
                        
                        if (filtered.length === 0) {
                            resultsDiv.innerHTML = '<div style="padding:10px;color:var(--text-muted);">ê²°ê³¼ ì—†ìŒ</div>';
                        } else {
                            resultsDiv.innerHTML = filtered.map(item => 
                                '<div class="followup-result-item" style="padding:10px;cursor:pointer;border-bottom:1px solid var(--border);background:var(--surface);color:var(--text-primary);" onmouseover="this.style.backgroundColor=\'hsl(217, 91%, 60%)\';this.style.color=\'#000\'" onmouseout="this.style.backgroundColor=\'hsl(222, 47%, 14%)\';this.style.color=\'hsl(210, 40%, 98%)\'" data-id="' + item.id + '">' + 
                                item.text + 
                                '</div>'
                            ).join('');
                        }
                        resultsDiv.style.display = 'block';
                    };
                    
                    window.selectFollowupItem = function(event) {
                        const item = event.target.closest('[data-id]');
                        if (!item) return;
                        
                        const id = item.getAttribute('data-id');
                        const text = item.textContent.trim();
                        
                        document.getElementById('followup_search').value = text;
                        hiddenSelect.value = id;
                        resultsDiv.style.display = 'none';
                        
                        hiddenSelect.dispatchEvent(new Event('change', {bubbles: true}));
                    };
                })();
                </script>

                <!-- opportunity í•„ë“œë¥¼ ìˆ¨ê¹€ í•„ë“œë¡œ ì¶”ê°€ (ê²¬ì  ì„ íƒ ì‹œ ìë™ ì„¤ì •) -->
                {{ form.opportunity }}

                <div class="mb-3">
                  {{ form.visit_date.label_tag }}
                  <div class="input-group">
                    {{ form.visit_date }}
                    <button type="button"
                            class="btn btn-outline-secondary"
                            id="visit-date-picker-btn">
                      <i class="fas fa-calendar-alt"></i>
                    </button>
                  </div>
                </div>

                <div class="mb-3">
                  {{ form.visit_time.label_tag }}
                  <div class="input-group">
                    {{ form.visit_time }}
                    <button type="button"
                            class="btn btn-outline-secondary"
                            id="visit-time-picker-btn">
                      <i class="fas fa-clock"></i>
                    </button>
                  </div>
                </div>

                <div class="mb-3">
                  {{ form.activity_type.label_tag }} {{ form.activity_type }}
                  <small class="form-text text-muted">í™œë™ ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”</small>
                </div>

                <!-- status í•„ë“œ -->
                <div class="mb-3">
                  {{ form.status.label_tag }} {{ form.status }}
                  <small class="form-text text-muted">ì¼ì •ì˜ ì§„í–‰ ìƒíƒœë¥¼ ì„ íƒí•˜ì„¸ìš”</small>
                </div>
              </div>

              <!-- ì¶”ê°€ ì •ë³´ ì„¹ì…˜ -->
              <div class="col-md-6">
                <h3 class="mb-3 text-success">
                  <i class="fas fa-map-marker-alt me-2"></i>ì¶”ê°€ ì •ë³´
                </h3>

                <div class="mb-3">
                  {{ form.location.label_tag }} {{ form.location }}
                  <small class="form-text text-muted">ì„ íƒì‚¬í•­ì…ë‹ˆë‹¤</small>
                </div>

                <div class="mb-3">
                  {{ form.notes.label_tag }} {{ form.notes }}
                  <small class="form-text text-muted">ì„ íƒì‚¬í•­ì…ë‹ˆë‹¤</small>
                </div>
              </div>
            </div>

            <!-- í€ë„¬ ë“±ë¡ ì„¹ì…˜ (ë¯¸íŒ… ì¼ì •ë§Œ í‘œì‹œ) -->
            <div class="row mt-4" id="funnel-register-section" style="display: none;">
              <div class="col-12">
                <div class="card border-primary">
                  <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                      <i class="fas fa-funnel-dollar me-2"></i>í€ë„¬ ë“±ë¡
                    </h5>
                  </div>
                  <div class="card-body">
                    <div class="form-check">
                      {{ form.register_funnel }}
                      <label class="form-check-label" for="id_register_funnel">
                        <strong>ìƒìœ„ ì˜ì—…ê¸°íšŒì— ë“±ë¡</strong>
                      </label>
                      <div class="form-text">
                        <i class="fas fa-info-circle me-1"></i>
                        ì²´í¬í•˜ë©´ ì´ ê³ ê°ì´ í€ë„¬ ëŒ€ì‹œë³´ë“œì˜ ìƒìœ„ ì˜ì—…ê¸°íšŒì— í‘œì‹œë©ë‹ˆë‹¤.
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ìˆ¨ê²¨ì§„ í•„ë“œë“¤ (expected_revenue, probability ë“± - ê²¬ì  í’ˆëª©ì—ì„œ ìë™ ê³„ì‚°) -->
            {{ form.expected_revenue }}
            {{ form.probability }}
            {{ form.expected_close_date }}
            {{ form.purchase_confirmed }}

            <!-- ì„ ê²°ì œ ì‚¬ìš© ì„¹ì…˜ (ë‚©í’ˆë§Œ í‘œì‹œ) -->
            <div class="row mt-4" id="prepayment-section" style="display: none;">
              <div class="col-12">
                <div class="card border-info">
                  <div class="card-header bg-info bg-opacity-10">
                    <h6 class="mb-0">
                      <i class="fas fa-wallet me-2 text-info"></i>ì„ ê²°ì œ ì‚¬ìš©
                    </h6>
                  </div>
                  <div class="card-body">
                    <!-- ì„ ê²°ì œ ì‚¬ìš© ì²´í¬ë°•ìŠ¤ -->
                    <div class="form-check mb-3">
                      {{ form.use_prepayment }}
                      <label class="form-check-label" for="{{ form.use_prepayment.id_for_label }}">
                        <strong>{{ form.use_prepayment.label }}</strong>
                      </label>
                      <div class="form-text">
                        <i class="fas fa-info-circle me-1"></i>
                        ê³ ê°ì˜ ì„ ê²°ì œ ì”ì•¡ì—ì„œ ê¸ˆì•¡ì„ ì°¨ê°í•˜ë ¤ë©´ ì²´í¬í•˜ì„¸ìš”. (ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥)
                      </div>
                    </div>
                    
                    <!-- ì„ ê²°ì œ ì„ íƒ ì˜ì—­ (ì„ ê²°ì œ ì‚¬ìš© ì²´í¬ ì‹œ í‘œì‹œ) -->
                    <div id="prepayment-details" style="display: none;">
                      <!-- ë‚©í’ˆ ê¸ˆì•¡ í‘œì‹œ -->
                      <div class="alert alert-info mb-3">
                        <div class="row">
                          <div class="col-md-4">
                            <strong>ë‚©í’ˆ ì´ì•¡:</strong> <span id="delivery-total-display">0ì›</span>
                          </div>
                          <div class="col-md-4">
                            <strong>ì„ ê²°ì œ ì°¨ê°:</strong> <span id="prepayment-total-display">0ì›</span>
                          </div>
                          <div class="col-md-4">
                            <strong>ì‹¤ì œ ê²°ì œ:</strong> 
                            <span id="actual-payment-display" class="fw-bold text-danger">0ì›</span>
                          </div>
                        </div>
                      </div>

                      <!-- ì„ ê²°ì œ ëª©ë¡ (ì²´í¬ë°•ìŠ¤ë¡œ ë³µìˆ˜ ì„ íƒ) -->
                      <div id="prepayment-list-container" class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                          <label class="form-label fw-bold mb-0">ì‚¬ìš©í•  ì„ ê²°ì œ ì„ íƒ</label>
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="use-full-amount-all">
                            <label class="form-check-label text-primary fw-bold" for="use-full-amount-all">
                              <i class="fas fa-coins me-1"></i>ë‚©í’ˆê¸ˆì•¡ë§Œí¼ ìë™ ì°¨ê°
                            </label>
                          </div>
                        </div>
                        <div id="prepayment-checkboxes" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                          <p class="text-muted text-center">ê³ ê°ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.</p>
                        </div>
                      </div>
                      
                      <!-- ìˆ¨ê²¨ì§„ í•„ë“œë“¤ (ì„œë²„ ì „ì†¡ìš©) -->
                      <input type="hidden" name="selected_prepayments" id="selected-prepayments-input">
                      <input type="hidden" name="prepayment_amounts" id="prepayment-amounts-input">
                      
                      <!-- ì„ ê²°ì œ ì•ˆë‚´ -->
                      <div class="alert alert-warning mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>ì£¼ì˜:</strong> ì„ ê²°ì œ ê¸ˆì•¡ì€ ì €ì¥ í›„ ìë™ìœ¼ë¡œ ì°¨ê°ë˜ë©°, ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                        ì„ ê²°ì œ ì”ì•¡ì´ ë¶€ì¡±í•œ ê²½ìš° ì°¨ì•¡ì€ ì§ì ‘ ê²°ì œí•˜ì…”ì•¼ í•©ë‹ˆë‹¤.
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

              <div class="row" id="delivery-section" style="display: none;">
                <!-- ë‚©í’ˆ ê¸ˆì•¡ -->
                <div class="col-md-6">
                  <div class="mb-3">
                    {{ form.delivery_amount.label_tag }}
                    {{ form.delivery_amount }}
                    {% if form.delivery_amount.errors %}
                    <div class="invalid-feedback d-block">
                      {% for error in form.delivery_amount.errors %}{{ error }}{% endfor %}
                    </div>
                    {% endif %}
                  </div>
                </div>
                
                <!-- ë‚©í’ˆ ë‚ ì§œ -->
                <div class="col-md-6">
                  <div class="mb-3">
                    {{ form.delivery_date.label_tag }}
                    {{ form.delivery_date }}
                    {% if form.delivery_date.errors %}
                    <div class="invalid-feedback d-block">
                      {% for error in form.delivery_date.errors %}{{ error }}{% endfor %}
                    </div>
                    {% endif %}
                  </div>
                </div>
              </div>

              <!-- ê²¬ì /ë‚©í’ˆ í’ˆëª© ì„¹ì…˜ -->
              <div class="mb-4" id="quote-delivery-items-section" style="display: none;">
                <!-- ê¸°ì¡´ í…ìŠ¤íŠ¸ ì…ë ¥ ë°©ì‹ ìˆ¨ê¹€ -->
                <div style="display: none;">
                  {{ form.delivery_items }}
                </div>
                
                {% if schedule %}
                <!-- ìˆ˜ì • ëª¨ë“œ: ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™ -->
                <div class="card">
                  <div class="card-header d-flex justify-content-between align-items-center bg-warning text-dark">
                    <div>
                      <h5 class="mb-0" id="items-section-title">
                        <i class="fas fa-boxes me-2"></i>í’ˆëª© ê´€ë¦¬
                      </h5>
                      <small class="text-muted">ìˆ˜ì • ëª¨ë“œì—ì„œëŠ” í’ˆëª©ì„ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìƒì„¸ í˜ì´ì§€ì—ì„œ í’ˆëª©ì„ ê´€ë¦¬í•˜ì„¸ìš”.</small>
                    </div>
                    <a href="{% url 'reporting:schedule_detail' schedule.pk %}" class="btn btn-primary btn-sm">
                      <i class="fas fa-boxes me-1"></i>í’ˆëª© ê´€ë¦¬í•˜ê¸°
                    </a>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-md-8">
                        <label class="form-label fw-bold">í’ˆëª© ë‚´ì—­</label>
                        <textarea id="schedule-delivery-items-display" class="form-control" rows="3" readonly 
                                  placeholder="ìƒì„¸ í˜ì´ì§€ì—ì„œ í’ˆëª©ì„ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."></textarea>
                      </div>
                      <div class="col-md-4">
                        <label class="form-label fw-bold">ì´ ê¸ˆì•¡ (ë¶€ê°€ì„¸ í¬í•¨)</label>
                        <div class="input-group">
                          <input id="schedule-delivery-total-amount" type="number" class="form-control" readonly value="0">
                          <span class="input-group-text">ì›</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                {% else %}
                <!-- ìƒì„± ëª¨ë“œ: í’ˆëª© ì…ë ¥ UI -->
                <!-- ê²¬ì  í’ˆëª© UI -->
                <div class="card" id="quote-items-card">
                  <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <div>
                      <h5 class="mb-0">
                        <i class="fas fa-file-invoice me-2"></i>ê²¬ì  í’ˆëª©
                      </h5>
                      <small class="text-muted">í’ˆëª©ì„ ì¶”ê°€í•˜ê³  ê²¬ì  ê¸ˆì•¡ì´ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.</small>
                    </div>
                    <div>
                      <button type="button" class="btn btn-light btn-sm me-2" onclick="loadFromMeeting()" id="load-meeting-btn" style="display: none;">
                        <i class="fas fa-user-tie me-1"></i>ë¯¸íŒ…ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
                      </button>
                      <button type="button" class="btn btn-light btn-sm me-2" onclick="loadFromQuote()" id="load-quote-btn" style="display: none;">
                        <i class="fas fa-file-import me-1"></i>ê²¬ì ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
                      </button>
                      <button type="button" class="btn btn-primary btn-sm" onclick="openScheduleDeliveryModal('quote')">
                        <i class="fas fa-edit me-1"></i>í’ˆëª© ê´€ë¦¬
                      </button>
                    </div>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-md-8">
                        <label class="form-label fw-bold">í’ˆëª© ë‚´ì—­</label>
                        <textarea id="quote-items-display" class="form-control" rows="3" readonly 
                                  placeholder="'í’ˆëª© ê´€ë¦¬' ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ê²¬ì  í’ˆëª©ì„ ì¶”ê°€í•˜ì„¸ìš”."></textarea>
                      </div>
                      <div class="col-md-4">
                        <label class="form-label fw-bold">ì´ ê¸ˆì•¡ (ë¶€ê°€ì„¸ í¬í•¨)</label>
                        <div class="input-group">
                          <input type="number" id="quote-total-amount" class="form-control" readonly value="0">
                          <span class="input-group-text">ì›</span>
                        </div>
                        <small class="text-muted quote-items-summary"></small>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- ë‚©í’ˆ í’ˆëª© UI -->
                <div class="card" id="delivery-items-card" style="display: none;">
                  <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                    <div>
                      <h5 class="mb-0">
                        <i class="fas fa-boxes me-2"></i>ë‚©í’ˆ í’ˆëª©
                      </h5>
                      <small class="text-muted">í’ˆëª©ì„ ì¶”ê°€í•˜ê³  ì„ ê²°ì œ ì°¨ê° ê¸ˆì•¡ì´ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.</small>
                    </div>
                    <div>
                      <button type="button" class="btn btn-light btn-sm me-2" onclick="loadFromQuote()" id="delivery-load-quote-btn" style="display: none;">
                        <i class="fas fa-file-import me-1"></i>ê²¬ì ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
                      </button>
                      <button type="button" class="btn btn-primary btn-sm" onclick="openScheduleDeliveryModal('delivery')">
                        <i class="fas fa-edit me-1"></i>í’ˆëª© ê´€ë¦¬
                      </button>
                    </div>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-md-8">
                        <label class="form-label fw-bold">í’ˆëª© ë‚´ì—­</label>
                        <textarea id="schedule-delivery-items-display" class="form-control" rows="3" readonly 
                                  placeholder="'í’ˆëª© ê´€ë¦¬' ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë‚©í’ˆ í’ˆëª©ì„ ì¶”ê°€í•˜ì„¸ìš”."></textarea>
                      </div>
                      <div class="col-md-4">
                        <label class="form-label fw-bold">ì´ ê¸ˆì•¡ (ë¶€ê°€ì„¸ í¬í•¨)</label>
                        <div class="input-group">
                          <input type="number" id="schedule-delivery-total-amount" class="form-control" readonly value="0">
                          <span class="input-group-text">ì›</span>
                        </div>
                        <small class="text-muted schedule-delivery-items-summary"></small>
                      </div>
                    </div>
                  </div>
                </div>
                {% endif %}
              </div>

            <!-- ë²„íŠ¼ ì„¹ì…˜ -->
            <div class="d-flex justify-content-end mt-3 mb-0" style="position: relative; z-index: 10;">
              <a
                href="{% if schedule %}{% url 'reporting:schedule_detail' schedule.pk %}{% else %}{% url 'reporting:schedule_calendar' %}{% endif %}"
                class="btn btn-secondary me-2"
                >ì·¨ì†Œ</a
              >

              <button type="submit" class="btn btn-primary" style="position: relative; z-index: 10;">
                <i class="fas fa-save me-1"></i>
                {% if schedule %}ìˆ˜ì •í•˜ê¸°{% else %}ìƒì„±í•˜ê¸°{% endif %}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- íŒ”ë¡œìš°ì—… ì‹ ê·œ ì¶”ê°€ ëª¨ë‹¬ (ë©”ì¸ form ë°–ìœ¼ë¡œ ì´ë™) -->
<div class="modal fade" id="followupModal" tabindex="-1" aria-labelledby="followupModalLabel" aria-hidden="true" style="z-index: 100050;" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="followupModalLabel">
          <i class="fas fa-user-plus me-2"></i>íŒ”ë¡œìš°ì—… ì‹ ê·œ ì¶”ê°€
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- ëª¨ë‹¬ ë‚´ë¶€ ì•Œë¦¼ ì˜ì—­ -->
        <div id="modalAlertContainer" style="margin-bottom: 15px; z-index: 2100; position: relative;"></div>
        
        <form id="followupForm">
          {% csrf_token %}
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="modal_customer_name" class="form-label">ê³ ê°ëª…</label>
                <input type="text" class="form-control" id="modal_customer_name" name="customer_name" autocomplete="off">
              </div>
              <div class="mb-3">
                <label for="modal_company" class="form-label">ì—…ì²´/í•™êµëª… *</label>
                <div style="position: relative;">
                  <input type="text" id="modal_company_search" class="form-control" placeholder="ì—…ì²´/í•™êµëª…ì„ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off">
                  <input type="hidden" id="modal_company" name="company" value="">
                  <div id="modal_company_suggestions" class="autocomplete-suggestions" style="display: none;"></div>
                  <button type="button" id="modal_add_new_company" class="btn btn-sm btn-outline-primary" style="position: absolute; right: 5px; top: 5px; padding: 2px 8px; font-size: 11px;">+ ìƒˆë¡œ ì¶”ê°€</button>
                </div>
              </div>
              <div class="mb-3">
                <label for="modal_department" class="form-label">ë¶€ì„œ/ì—°êµ¬ì‹¤ëª… *</label>
                <div style="position: relative;">
                  <input type="text" id="modal_department_search" class="form-control" placeholder="ë¨¼ì € ì—…ì²´/í•™êµë¥¼ ì„ íƒí•˜ì„¸ìš”..." autocomplete="off" disabled>
                  <input type="hidden" id="modal_department" name="department" value="">
                  <div id="modal_department_suggestions" class="autocomplete-suggestions" style="display: none;"></div>
                  <button type="button" id="modal_add_new_department" class="btn btn-sm btn-outline-primary" style="position: absolute; right: 5px; top: 5px; padding: 2px 8px; font-size: 11px; display: none;">+ ìƒˆë¡œ ì¶”ê°€</button>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="modal_manager" class="form-label">ì±…ì„ì</label>
                <input type="text" class="form-control" id="modal_manager" name="manager" autocomplete="off">
              </div>
              <div class="mb-3">
                <label for="modal_phone_number" class="form-label">í•¸ë“œí° ë²ˆí˜¸</label>
                <input type="tel" class="form-control" id="modal_phone_number" name="phone_number" autocomplete="off">
              </div>
              <div class="mb-3">
                <label for="modal_email" class="form-label">ì´ë©”ì¼</label>
                <input type="email" class="form-control" id="modal_email" name="email" autocomplete="off">
              </div>
              <div class="mb-3">
                <label for="modal_priority" class="form-label">ìš°ì„ ìˆœìœ„ *</label>
                <select class="form-control" id="modal_priority" name="priority">
                  <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                  <option value="urgent">ê¸´ê¸‰</option>
                  <option value="followup">íŒ”ë¡œì—…</option>
                  <option value="scheduled" selected>ì˜ˆì •</option>
                  <option value="long_term">ì¥ê¸°</option>
                </select>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label for="modal_address" class="form-label">ìƒì„¸ì£¼ì†Œ</label>
            <textarea class="form-control" id="modal_address" name="address" rows="2" autocomplete="off" placeholder="ì„ íƒì‚¬í•­ì…ë‹ˆë‹¤"></textarea>
          </div>
          <div class="mb-3">
            <label for="modal_notes" class="form-label">ìƒì„¸ ë‚´ìš©</label>
            <textarea class="form-control" id="modal_notes" name="notes" rows="3" autocomplete="off"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
        <button type="button" class="btn btn-primary" id="saveFollowupBtn">
          <i class="fas fa-save me-1"></i>ì €ì¥
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// ===== ì „ì—­ í•¨ìˆ˜ ì •ì˜ (ëª¨ë“  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë³´ë‹¤ ë¨¼ì € ì •ì˜) =====

// ì„ ê²°ì œ ëª©ë¡ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
window.updatePrepaymentList = function(followupId) {
    const checkboxContainer = document.getElementById('prepayment-checkboxes');
    
    if (followupId && checkboxContainer) {
        // AJAXë¡œ í•´ë‹¹ ê³ ê°ì˜ ì„ ê²°ì œ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        fetch(`/reporting/api/prepayments/?customer_id=${followupId}`)
            .then(response => {
                return response.json();
            })
            .then(data => {
                
                // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”
                checkboxContainer.innerHTML = '';
                
                if (data.prepayments.length === 0) {
                    checkboxContainer.innerHTML = '<p class="text-muted text-center mb-0">ì‚¬ìš© ê°€ëŠ¥í•œ ì„ ê²°ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    // ì„ ê²°ì œë³„ë¡œ ì²´í¬ë°•ìŠ¤ ìƒì„±
                    data.prepayments.forEach(prepayment => {
                        const div = document.createElement('div');
                        div.className = 'prepayment-item border-bottom pb-2 mb-2';
                        div.innerHTML = `
                            <div class="form-check">
                                <input class="form-check-input prepayment-checkbox" 
                                       type="checkbox" 
                                       value="${prepayment.id}" 
                                       id="prepayment-${prepayment.id}"
                                       data-balance="${prepayment.balance}"
                                       onchange="updatePrepaymentCalculation()">
                                <label class="form-check-label w-100" for="prepayment-${prepayment.id}">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>${prepayment.payment_date}</strong>
                                            <span class="text-muted">- ${prepayment.payer_name || 'ë¯¸ì§€ì •'}</span>
                                        </div>
                                        <div>
                                            <span class="badge bg-success">ì”ì•¡: ${prepayment.balance.toLocaleString()}ì›</span>
                                        </div>
                                    </div>
                                    <div class="mt-1">
                                        <small class="text-muted">
                                            ì°¨ê° ê¸ˆì•¡: 
                                            <input type="number" 
                                                   class="form-control form-control-sm d-inline-block prepayment-amount-input" 
                                                   id="amount-${prepayment.id}"
                                                   placeholder="0"
                                                   min="0"
                                                   max="${prepayment.balance}"
                                                   style="width: 150px;"
                                                   onchange="updatePrepaymentCalculation()"
                                                   disabled>
                                            ì›
                                        </small>
                                    </div>
                                </label>
                            </div>
                        `;
                        checkboxContainer.appendChild(div);
                    });
                    
                }
            })
            .catch(error => {
                console.error('ì„ ê²°ì œ ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error);
                checkboxContainer.innerHTML = '<p class="text-danger text-center mb-0">ì„ ê²°ì œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            });
    } else {
        if (checkboxContainer) {
            checkboxContainer.innerHTML = '<p class="text-muted text-center mb-0">ê³ ê°ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.</p>';
        }
    }
};

// ì„ ê²°ì œ ê³„ì‚° ì—…ë°ì´íŠ¸ í•¨ìˆ˜
window.updatePrepaymentCalculation = function() {
    const checkboxes = document.querySelectorAll('.prepayment-checkbox');
    let totalPrepayment = 0;
    const selectedPrepayments = [];
    const prepaymentAmounts = {};
    
    checkboxes.forEach(checkbox => {
        const amountInput = document.getElementById(`amount-${checkbox.value}`);
        
        if (checkbox.checked) {
            // ì²´í¬ëœ ê²½ìš° ê¸ˆì•¡ ì…ë ¥ë€ í™œì„±í™”
            amountInput.disabled = false;
            
            const amount = parseInt(amountInput.value) || 0;
            const balance = parseInt(checkbox.dataset.balance);
            
            // ìµœëŒ€ ì”ì•¡ê¹Œì§€ë§Œ ì…ë ¥ ê°€ëŠ¥
            if (amount > balance) {
                amountInput.value = balance;
            }
            
            const finalAmount = parseInt(amountInput.value) || 0;
            totalPrepayment += finalAmount;
            
            selectedPrepayments.push(checkbox.value);
            prepaymentAmounts[checkbox.value] = finalAmount;
        } else {
            // ì²´í¬ í•´ì œ ì‹œ ê¸ˆì•¡ ì…ë ¥ë€ ë¹„í™œì„±í™” ë° ì´ˆê¸°í™”
            amountInput.disabled = true;
            amountInput.value = '';
        }
    });
    
    // ë‚©í’ˆ ì´ì•¡ ê°€ì ¸ì˜¤ê¸°
    let deliveryTotal = 0;
    const deliveryTotalElement = document.getElementById('schedule-total-amount');
    const deliveryTotalField = document.getElementById('schedule-delivery-total-amount');
    
    if (deliveryTotalField && deliveryTotalField.value) {
        deliveryTotal = parseInt(deliveryTotalField.value) || 0;
    } else if (deliveryTotalElement) {
        deliveryTotal = parseInt(deliveryTotalElement.textContent.replace(/[^0-9]/g, '')) || 0;
    }
    
    // ì‹¤ì œ ê²°ì œ ê¸ˆì•¡ ê³„ì‚°
    const actualPayment = Math.max(0, deliveryTotal - totalPrepayment);
    
    // í™”ë©´ ì—…ë°ì´íŠ¸
    const deliveryTotalDisplay = document.getElementById('delivery-total-display');
    const prepaymentTotalDisplay = document.getElementById('prepayment-total-display');
    const actualPaymentDisplay = document.getElementById('actual-payment-display');
    
    if (deliveryTotalDisplay) {
        deliveryTotalDisplay.textContent = deliveryTotal.toLocaleString() + 'ì›';
    }
    if (prepaymentTotalDisplay) {
        prepaymentTotalDisplay.textContent = totalPrepayment.toLocaleString() + 'ì›';
    }
    if (actualPaymentDisplay) {
        actualPaymentDisplay.textContent = actualPayment.toLocaleString() + 'ì›';
    }
    
    // ìˆ¨ê²¨ì§„ í•„ë“œì— ê°’ ì €ì¥
    const selectedPrepaymentsInput = document.getElementById('selected-prepayments-input');
    const prepaymentAmountsInput = document.getElementById('prepayment-amounts-input');
    
    if (selectedPrepaymentsInput) {
        selectedPrepaymentsInput.value = JSON.stringify(selectedPrepayments);
    }
    if (prepaymentAmountsInput) {
        prepaymentAmountsInput.value = JSON.stringify(prepaymentAmounts);
    }
};

// ===== ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ =====

// íŒ”ë¡œìš°ì—… ëª¨ë‹¬ ê´€ë ¨ ìŠ¤í¬ë¦½íŠ¸
document.addEventListener('DOMContentLoaded', function() {
    const followupModal = document.getElementById('followupModal');
    const saveFollowupBtn = document.getElementById('saveFollowupBtn');
    const originalFollowupSelect = document.querySelector('select[name="followup"]') || document.querySelector('#id_followup') || document.querySelector('select.followup-autocomplete');
    
    // ìë™ì™„ì„± ê´€ë ¨ ìš”ì†Œë“¤
    const modalCompanySearch = document.getElementById('modal_company_search');
    const modalCompanyHidden = document.getElementById('modal_company');
    const modalCompanySuggestions = document.getElementById('modal_company_suggestions');
    const modalAddNewCompanyBtn = document.getElementById('modal_add_new_company');
    
    const modalDepartmentSearch = document.getElementById('modal_department_search');
    const modalDepartmentHidden = document.getElementById('modal_department');
    
    const modalDepartmentSuggestions = document.getElementById('modal_department_suggestions');
    const modalAddNewDepartmentBtn = document.getElementById('modal_add_new_department');
    
    // ì„ íƒëœ ì—…ì²´/ë¶€ì„œ ID ì €ì¥ìš© ë³€ìˆ˜
    let selectedCompanyId = null;
    let selectedDepartmentId = null;
    
    let companySearchTimeout;
    let departmentSearchTimeout;
    
    // ëª¨ë‹¬ ì—´ë¦´ ë•Œ ì´ˆê¸°í™”
    followupModal.addEventListener('show.bs.modal', function(e) {
        
        // ëª¨ë‹¬ì„ bodyì˜ ì§ì ‘ ìì‹ìœ¼ë¡œ ì´ë™ (ë‹¤ë¥¸ ìš”ì†Œë“¤ì˜ z-index ì˜í–¥ ì œê±°)
        if (followupModal.parentElement !== document.body) {
            document.body.appendChild(followupModal);
        }
        
        resetModal();
        // ëª¨ë‹¬ê³¼ backdropì˜ z-index ê°•ì œ ì„¤ì •
        followupModal.style.zIndex = '100050';
        followupModal.style.display = 'block';
    });
    
    // ëª¨ë‹¬ ì—´ë¦° í›„ backdrop z-index ì¡°ì • ë° ìƒí˜¸ì‘ìš© í™œì„±í™”
    followupModal.addEventListener('shown.bs.modal', function() {
        
        // ë‹¤ë¥¸ ëª¨ë“  ëª¨ë‹¬ ë‹«ê¸°
        const otherModals = document.querySelectorAll('.modal:not(#followupModal)');
        otherModals.forEach(modal => {
            const modalInstance = bootstrap.Modal.getInstance(modal);
            if (modalInstance) {
                modalInstance.hide();
            }
        });
        
        // í˜ì´ì§€ ìš”ì†Œë“¤ ë’¤ë¡œ ë³´ë‚´ê¸° (ëª¨ë‹¬ ë‚´ë¶€ ìš”ì†ŒëŠ” ì œì™¸)
        const pageElements = document.querySelectorAll('.container, .card, form:not(#followupForm)');
        pageElements.forEach(el => {
            // ëª¨ë‹¬ ë‚´ë¶€ ìš”ì†Œì¸ì§€ í™•ì¸
            if (!el.closest('#followupModal')) {
                el.style.position = 'relative';
                el.style.zIndex = '1';
            }
        });
        
        // backdrop z-index ì¡°ì •
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach((backdrop, index) => {
            backdrop.style.zIndex = '100049';
        });
        
        // ëª¨ë‹¬ dialogì™€ contentì˜ ìƒí˜¸ì‘ìš© ë³´ì¥
        const modalDialog = followupModal.querySelector('.modal-dialog');
        const modalContent = followupModal.querySelector('.modal-content');
        

        
        if (modalDialog) {
            modalDialog.style.position = 'relative';
            modalDialog.style.zIndex = '100051';
            modalDialog.style.pointerEvents = 'auto';
        }
        if (modalContent) {
            modalContent.style.position = 'relative';
            modalContent.style.zIndex = '100052';
            modalContent.style.pointerEvents = 'auto';
            
            // ëª¨ë‹¬ ë‚´ë¶€ì˜ ëª¨ë“  ì¸í„°ë™í‹°ë¸Œ ìš”ì†Œë“¤ì— pointer-events ì„¤ì •
            const interactiveElements = modalContent.querySelectorAll('input, select, textarea, button, a, .btn, .form-control');
            interactiveElements.forEach(el => {
                el.style.pointerEvents = 'auto';
            });
        }
        
        // bodyì˜ overflow í™•ì¸
        document.body.style.overflow = 'hidden';
        document.body.style.paddingRight = '';
        
        // ëª¨ë‹¬ ìì²´ê°€ í´ë¦­ ê°€ëŠ¥í•œì§€ í…ŒìŠ¤íŠ¸
        followupModal.style.pointerEvents = 'auto';
        
        // ë””ë²„ê¹…: ëª¨ë‹¬ ìœ„ì— ìˆëŠ” ìš”ì†Œ í™•ì¸
        setTimeout(() => {
            const modalRect = followupModal.getBoundingClientRect();
            const centerX = modalRect.left + modalRect.width / 2;
            const centerY = modalRect.top + modalRect.height / 2;
            const elementAtPoint = document.elementFromPoint(centerX, centerY);
          
            
            // ëª¨ë“  ë†’ì€ z-index ìš”ì†Œ ì°¾ê¸°
            const allElements = document.querySelectorAll('*');
            const highZIndexElements = [];
            allElements.forEach(el => {
                const zIndex = window.getComputedStyle(el).zIndex;
                if (zIndex !== 'auto' && parseInt(zIndex) > 1000) {
                    highZIndexElements.push({
                        element: el,
                        zIndex: zIndex,
                        id: el.id,
                        className: el.className
                    });
                }
            });
        }, 100);
        
    });
    
    // ëª¨ë‹¬ ë‹«í ë•Œ ì›ë˜ëŒ€ë¡œ ë³µì›
    followupModal.addEventListener('hidden.bs.modal', function() {
        
        // í˜ì´ì§€ ìš”ì†Œë“¤ z-index ë³µì›
        const pageElements = document.querySelectorAll('.container, .card, form:not(#followupForm)');
        pageElements.forEach(el => {
            el.style.zIndex = '';
        });
    });
    
    // ëª¨ë‹¬ ì´ˆê¸°í™”
    function resetModal() {
        document.getElementById('followupForm').reset();
        modalCompanyHidden.value = '';
        modalDepartmentHidden.value = '';
        modalCompanySearch.value = '';
        modalDepartmentSearch.value = '';
        modalDepartmentSearch.disabled = true;
        modalDepartmentSearch.placeholder = 'ë¨¼ì € ì—…ì²´/í•™êµë¥¼ ì„ íƒí•˜ì„¸ìš”...';
        modalAddNewDepartmentBtn.style.display = 'none';
        hideSuggestions(modalCompanySuggestions);
        hideSuggestions(modalDepartmentSuggestions);
    }
    
    // ì—…ì²´ ê²€ìƒ‰ ìë™ì™„ì„±
    modalCompanySearch.addEventListener('input', function() {
        const query = this.value.trim();
        
        clearTimeout(companySearchTimeout);
        
        if (query.length < 1) {
            hideSuggestions(modalCompanySuggestions);
            clearCompanySelection();
            return;
        }
        
        companySearchTimeout = setTimeout(() => {
            searchCompanies(query);
        }, 300);
    });
    
    // ë¶€ì„œ ê²€ìƒ‰ ìë™ì™„ì„±
    modalDepartmentSearch.addEventListener('input', function() {
        const query = this.value.trim();
        const companyId = modalCompanyHidden.value;
        
        clearTimeout(departmentSearchTimeout);
        
        if (!companyId) {
            hideSuggestions(modalDepartmentSuggestions);
            return;
        }
        
        if (query.length < 1) {
            hideSuggestions(modalDepartmentSuggestions);
            modalDepartmentHidden.value = '';
            return;
        }
        
        departmentSearchTimeout = setTimeout(() => {
            searchDepartments(query, companyId);
        }, 300);
    });
    
    // ì—…ì²´ ê²€ìƒ‰ í•¨ìˆ˜
    function searchCompanies(query) {
        fetch(`{% url "reporting:company_autocomplete" %}?q=${encodeURIComponent(query)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                showCompanySuggestions(data);
            })
            .catch(error => {
                console.error('ì—…ì²´ ê²€ìƒ‰ ì‹¤íŒ¨:', error);
                modalCompanySuggestions.innerHTML = '<div class="autocomplete-suggestion" style="color: #666;">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>';
                modalCompanySuggestions.style.display = 'block';
            });
    }
    
    // ë¶€ì„œ ê²€ìƒ‰ í•¨ìˆ˜
    function searchDepartments(query, companyId) {
        fetch(`{% url "reporting:department_autocomplete" %}?q=${encodeURIComponent(query)}&company=${companyId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                showDepartmentSuggestions(data);
            })
            .catch(error => {
                console.error('ë¶€ì„œ ê²€ìƒ‰ ì‹¤íŒ¨:', error);
                modalDepartmentSuggestions.innerHTML = '<div class="autocomplete-suggestion" style="color: #666;">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>';
                modalDepartmentSuggestions.style.display = 'block';
            });
    }
    
    // ì—…ì²´ ìë™ì™„ì„± ê²°ê³¼ í‘œì‹œ
    function showCompanySuggestions(data) {
        modalCompanySuggestions.innerHTML = '';
        
        const companies = data.results || [];
        if (companies.length === 0) {
            const noResult = document.createElement('div');
            noResult.className = 'autocomplete-suggestion';
            noResult.style.color = '#666';
            noResult.textContent = 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤';
            modalCompanySuggestions.appendChild(noResult);
        } else {
            companies.forEach(company => {
                const suggestion = document.createElement('div');
                suggestion.className = 'autocomplete-suggestion';
                suggestion.textContent = company.text;
                suggestion.addEventListener('click', () => {
                    selectCompany(company.id, company.text);
                });
                modalCompanySuggestions.appendChild(suggestion);
            });
        }
        
        modalCompanySuggestions.style.display = 'block';
    }
    
    // ë¶€ì„œ ìë™ì™„ì„± ê²°ê³¼ í‘œì‹œ
    function showDepartmentSuggestions(data) {
        modalDepartmentSuggestions.innerHTML = '';
        
        const departments = data.results || [];
        if (departments.length === 0) {
            const noResult = document.createElement('div');
            noResult.className = 'autocomplete-suggestion';
            noResult.style.color = '#666';
            noResult.textContent = 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤';
            modalDepartmentSuggestions.appendChild(noResult);
        } else {
            departments.forEach(department => {
                const suggestion = document.createElement('div');
                suggestion.className = 'autocomplete-suggestion';
                suggestion.innerHTML = `<strong>${department.company_name}</strong> - ${department.department_name}`;
                suggestion.addEventListener('click', () => {
                    // ì—…ì²´ì™€ ë¶€ì„œ ëª¨ë‘ ì„¤ì •
                    selectCompany(department.company_id, department.company_name);
                    selectDepartment(department.id, department.department_name);
                });
                modalDepartmentSuggestions.appendChild(suggestion);
            });
        }
        
        modalDepartmentSuggestions.style.display = 'block';
    }
    
    // ë¶€ì„œ ì„ íƒ
    function selectDepartment(departmentId, departmentText) {
        modalDepartmentHidden.value = departmentId;
        modalDepartmentSearch.value = departmentText;
        hideSuggestions(modalDepartmentSuggestions);
    }
    
    // ì—…ì²´ ì„ íƒ ì´ˆê¸°í™”
    function clearCompanySelection() {
        modalCompanyHidden.value = '';
        modalDepartmentSearch.disabled = true;
        modalDepartmentSearch.placeholder = 'ë¨¼ì € ì—…ì²´/í•™êµë¥¼ ì„ íƒí•˜ì„¸ìš”...';
        modalDepartmentSearch.value = '';
        modalDepartmentHidden.value = '';
        modalAddNewDepartmentBtn.style.display = 'none';
        hideSuggestions(modalDepartmentSuggestions);
    }
    
    // ì—…ì²´ ì„ íƒ í•¨ìˆ˜
    function selectCompany(companyId, companyName) {
        modalCompanySearch.value = companyName;
        modalCompanyHidden.value = companyId;
        selectedCompanyId = companyId;
        hideSuggestions(modalCompanySuggestions);
        
        // ë¶€ì„œ í•„ë“œ í™œì„±í™”
        modalDepartmentSearch.disabled = false;
        modalDepartmentSearch.placeholder = 'ë¶€ì„œ/ì—°êµ¬ì‹¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”...';
        modalAddNewDepartmentBtn.style.display = 'block';
        
        // ë¶€ì„œ í•„ë“œ ì´ˆê¸°í™”
        modalDepartmentSearch.value = '';
        modalDepartmentHidden.value = '';
        selectedDepartmentId = null;
    }
    
    // ë¶€ì„œ ì„ íƒ í•¨ìˆ˜
    function selectDepartment(departmentId, departmentName) {
        modalDepartmentSearch.value = departmentName;
        modalDepartmentHidden.value = departmentId;
        selectedDepartmentId = departmentId;
        hideSuggestions(modalDepartmentSuggestions);
    }
    
    // ìë™ì™„ì„± ê²°ê³¼ ìˆ¨ê¸°ê¸°
    function hideSuggestions(suggestionElement) {
        suggestionElement.style.display = 'none';
    }
    
    // ìë™ì™„ì„± ì™¸ë¶€ í´ë¦­ ì‹œ ìˆ¨ê¸°ê¸°
    document.addEventListener('click', function(e) {
        if (!modalCompanySearch.contains(e.target) && !modalCompanySuggestions.contains(e.target)) {
            hideSuggestions(modalCompanySuggestions);
        }
        if (!modalDepartmentSearch.contains(e.target) && !modalDepartmentSuggestions.contains(e.target)) {
            hideSuggestions(modalDepartmentSuggestions);
        }
    });
    
    // ìƒˆ ì—…ì²´ ì¶”ê°€ ë²„íŠ¼
    modalAddNewCompanyBtn.addEventListener('click', function() {
        const companyName = modalCompanySearch.value.trim();
        if (!companyName) {
            alert('ì—…ì²´/í•™êµëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        formData.append('name', companyName);
        
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        this.disabled = true;
        
        fetch('{% url "reporting:company_create_api" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                selectCompany(data.company.id, data.company.name);
                showAlert('success', 'ì—…ì²´/í•™êµê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else {
                showAlert('danger', data.error || 'ì—…ì²´/í•™êµ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('danger', 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        })
        .finally(() => {
            this.innerHTML = '+ ìƒˆë¡œ ì¶”ê°€';
            this.disabled = false;
        });
    });
    
    // ìƒˆ ë¶€ì„œ ì¶”ê°€ ë²„íŠ¼
    modalAddNewDepartmentBtn.addEventListener('click', function() {
        const departmentName = modalDepartmentSearch.value.trim();
        const companyId = modalCompanyHidden.value;
        
        if (!departmentName) {
            alert('ë¶€ì„œ/ì—°êµ¬ì‹¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        if (!companyId) {
            alert('ë¨¼ì € ì—…ì²´/í•™êµë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }
        
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        formData.append('name', departmentName);
        formData.append('company_id', companyId);
        
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        this.disabled = true;
        
        fetch('{% url "reporting:department_create_api" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                selectDepartment(data.department.id, data.department.name);
                showAlert('success', 'ë¶€ì„œ/ì—°êµ¬ì‹¤ì´ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else {
                showAlert('danger', data.error || 'ë¶€ì„œ/ì—°êµ¬ì‹¤ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('danger', 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        })
        .finally(() => {
            this.innerHTML = '+ ìƒˆë¡œ ì¶”ê°€';
            this.disabled = false;
        });
    });
    
    // íŒ”ë¡œìš°ì—… ì €ì¥
    saveFollowupBtn.addEventListener('click', function() {
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        formData.append('customer_name', document.getElementById('modal_customer_name').value);
        formData.append('company', modalCompanyHidden.value);
        formData.append('department', modalDepartmentHidden.value);
        formData.append('manager', document.getElementById('modal_manager').value);
        formData.append('phone_number', document.getElementById('modal_phone_number').value);
        formData.append('email', document.getElementById('modal_email').value);
        formData.append('priority', document.getElementById('modal_priority').value);
        formData.append('address', document.getElementById('modal_address').value);
        formData.append('notes', document.getElementById('modal_notes').value);
        
        // ìœ íš¨ì„± ê²€ì‚¬
        if (!document.getElementById('modal_customer_name').value.trim()) {
            showModalAlert('danger', 'ê³ ê°ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        if (!modalCompanyHidden.value) {
            showModalAlert('danger', 'ì—…ì²´/í•™êµë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }
        
        if (!modalDepartmentHidden.value) {
            showModalAlert('danger', 'ë¶€ì„œ/ì—°êµ¬ì‹¤ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }
        
        if (!document.getElementById('modal_priority').value) {
            showModalAlert('danger', 'ìš°ì„ ìˆœìœ„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }
        
        // ë²„íŠ¼ ë¡œë”© ìƒíƒœ
        saveFollowupBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ì €ì¥ ì¤‘...';
        saveFollowupBtn.disabled = true;
        
        fetch('{% url "reporting:followup_create_ajax" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (!originalFollowupSelect) {
                    console.error('íŒ”ë¡œìš°ì—… ì„ íƒ ë°•ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    showModalAlert('warning', 'íŒ”ë¡œìš°ì—…ì´ ìƒì„±ë˜ì—ˆì§€ë§Œ ìë™ ì„ íƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                // ì„±ê³µ ì‹œ ì›ë˜ selectì— ìƒˆ ì˜µì…˜ ì¶”ê°€ ë° ì„ íƒ
                const newOption = new Option(data.followup_text, data.followup_id, true, true);
                originalFollowupSelect.add(newOption);
                
                // í™•ì‹¤í•˜ê²Œ ì„ íƒí•˜ê¸° ìœ„í•œ ì¶”ê°€ ì½”ë“œ
                originalFollowupSelect.value = data.followup_id;
                
                // ìë™ì™„ì„± input í•„ë“œì—ë„ ê°’ ì„¤ì •
                const followupInput = document.querySelector('input[name="followup_search"]');
                if (followupInput) {
                    followupInput.value = data.followup_text;
                }
                
                // íŒ”ë¡œìš°ì—… í¼ ì´ˆê¸°í™” (ë‹¤ìŒ ì¶”ê°€ë¥¼ ìœ„í•´)
                resetModal();
                
                // ëª¨ë‹¬ ë‹«ê¸°
                bootstrap.Modal.getInstance(followupModal).hide();
                
                // ì„±ê³µ ì•Œë¦¼
                showAlert('success', 'íŒ”ë¡œìš°ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì–´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. ê²€ìƒ‰ì—ì„œë„ ì¦‰ì‹œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
            } else {
                showModalAlert('danger', data.error || 'íŒ”ë¡œìš°ì—… ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showModalAlert('danger', 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        })
        .finally(() => {
            // ë²„íŠ¼ ìƒíƒœ ë³µì›
            saveFollowupBtn.innerHTML = '<i class="fas fa-save me-1"></i>ì €ì¥';
            saveFollowupBtn.disabled = false;
        });
    });
    
    // ì—…ì²´ ìƒˆë¡œ ì¶”ê°€ ë²„íŠ¼ ì´ë²¤íŠ¸
    modalAddNewCompanyBtn.addEventListener('click', function() {
        // ì¤‘ë³µ ìš”ì²­ ë°©ì§€
        if (this.disabled) return;
        
        const companyName = modalCompanySearch.value.trim();
        if (!companyName) {
            showModalAlert('danger', 'ì—…ì²´/í•™êµëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        // ë²„íŠ¼ ë¹„í™œì„±í™”
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì¶”ê°€ ì¤‘...';
        
        const formData = new FormData();
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        formData.append('csrfmiddlewaretoken', csrfToken);
        formData.append('name', companyName);
        
        fetch('{% url "reporting:company_create_api" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // selectCompany í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ì„œ ì œëŒ€ë¡œ ì„ íƒ ì²˜ë¦¬
                selectCompany(data.company.id, data.company.name);
                
                showModalAlert('success', `"${data.company.name}" ì—…ì²´/í•™êµê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                showToastAlert('success', `"${data.company.name}" ì—…ì²´/í•™êµê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                hideSuggestions(modalCompanySuggestions);
            } else {
                showModalAlert('danger', data.error || 'ì—…ì²´ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        })
        .catch(error => {
            console.error('ì—…ì²´ ìƒì„± ì˜¤ë¥˜:', error);
            showModalAlert('danger', 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        })
        .finally(() => {
            // ë²„íŠ¼ ìƒíƒœ ë³µì›
            this.disabled = false;
            this.innerHTML = '+ ìƒˆë¡œ ì¶”ê°€';
        });
    });
    
    // ë¶€ì„œ ìƒˆë¡œ ì¶”ê°€ ë²„íŠ¼ ì´ë²¤íŠ¸
    modalAddNewDepartmentBtn.addEventListener('click', function() {
        // ì¤‘ë³µ ìš”ì²­ ë°©ì§€
        if (this.disabled) return;
        
        if (!selectedCompanyId) {
            showModalAlert('danger', 'ë¨¼ì € ì—…ì²´/í•™êµë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }
        
        const departmentName = modalDepartmentSearch.value.trim();
        if (!departmentName) {
            showModalAlert('danger', 'ë¶€ì„œ/ì—°êµ¬ì‹¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        // ë²„íŠ¼ ë¹„í™œì„±í™”
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì¶”ê°€ ì¤‘...';
        
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        formData.append('name', departmentName);
        formData.append('company_id', selectedCompanyId); // company_idë¡œ ìˆ˜ì •
        
        fetch('{% url "reporting:department_create_api" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // selectDepartment í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ì„œ ì œëŒ€ë¡œ ì„ íƒ ì²˜ë¦¬
                selectDepartment(data.department.id, data.department.name);
                
                showModalAlert('success', `"${data.department.company_name} - ${data.department.name}" ë¶€ì„œ/ì—°êµ¬ì‹¤ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                showToastAlert('success', `"${data.department.company_name} - ${data.department.name}" ë¶€ì„œ/ì—°êµ¬ì‹¤ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                hideSuggestions(modalDepartmentSuggestions);
            } else {
                showModalAlert('danger', data.error || 'ë¶€ì„œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        })
        .catch(error => {
            console.error('ë¶€ì„œ ìƒì„± ì˜¤ë¥˜:', error);
            showModalAlert('danger', 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        })
        .finally(() => {
            // ë²„íŠ¼ ìƒíƒœ ë³µì›
            this.disabled = false;
            this.innerHTML = '+ ìƒˆë¡œ ì¶”ê°€';
        });
    });
    
    // ëª¨ë‹¬ ì „ìš© ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜
    function showModalAlert(type, message) {
        const alertContainer = document.getElementById('modalAlertContainer');
        
        // ê¸°ì¡´ ì•Œë¦¼ ì œê±°
        alertContainer.innerHTML = '';
        
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        alertContainer.appendChild(alertDiv);
        
        // 5ì´ˆ í›„ ìë™ ì œê±°
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
    
    // ë¸Œë¼ìš°ì € ìƒë‹¨ í† ìŠ¤íŠ¸ ì•Œë¦¼ í•¨ìˆ˜
    function showToastAlert(type, message) {
        // í† ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆê°€ ì—†ìœ¼ë©´ ìƒì„±
        let toastContainer = document.getElementById('toastContainer');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toastContainer';
            toastContainer.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 3000;
                max-width: 400px;
            `;
            document.body.appendChild(toastContainer);
        }
        
        // í† ìŠ¤íŠ¸ ìƒì„±
        const toast = document.createElement('div');
        toast.className = `alert alert-${type} alert-dismissible fade show`;
        toast.style.cssText = `
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: none;
        `;
        toast.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        toastContainer.appendChild(toast);
        
        // 5ì´ˆ í›„ ìë™ ì œê±°
        setTimeout(() => {
            if (toast.parentNode) {
                toast.remove();
            }
        }, 5000);
    }
    
    // í˜ì´ì§€ ì „ì²´ ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜ (ì‚¬ìš© ì•ˆ í•¨)
    function showAlert(type, message) {
        // ëª¨ë‹¬ì´ ì—´ë ¤ìˆì„ ë•ŒëŠ” í† ìŠ¤íŠ¸ë¡œë§Œ í‘œì‹œ
        const modal = document.getElementById('followupModal');
        if (modal && modal.style.display !== 'none' && modal.classList.contains('show')) {
            showToastAlert(type, message);
            return;
        }
        
        // ê¸°ì¡´ í˜ì´ì§€ ì•Œë¦¼ ë¡œì§
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const container = document.querySelector('.container');
        container.insertBefore(alertDiv, container.firstChild);
        
        // 5ì´ˆ í›„ ìë™ ì œê±°
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
    
    // ===== ì„ ê²°ì œ ê´€ë ¨ ê¸°ëŠ¥ =====
    
    // ê²¬ì /ë‚©í’ˆ ì„ íƒ ì‹œ ì„ ê²°ì œ ì„¹ì…˜ í‘œì‹œ
    const activityTypeField = document.getElementById('id_activity_type');
    const prepaymentSection = document.getElementById('prepayment-section');
    const usePrepaymentCheckbox = document.getElementById('id_use_prepayment');
    const prepaymentDetails = document.getElementById('prepayment-details');
    
    // í™œë™ ìœ í˜• ë³€ê²½ ì‹œ
    if (activityTypeField) {
        activityTypeField.addEventListener('change', function() {
            const selectedType = this.value;
            // ë‚©í’ˆ ì¼ì •ë§Œ ì„ ê²°ì œ ì„¹ì…˜ í‘œì‹œ
            if (selectedType === 'delivery') {
                prepaymentSection.style.display = 'block';
            } else {
                prepaymentSection.style.display = 'none';
                if (usePrepaymentCheckbox) {
                    usePrepaymentCheckbox.checked = false;
                }
                if (prepaymentDetails) {
                    prepaymentDetails.style.display = 'none';
                }
            }
        });
        
        // ì´ˆê¸° ë¡œë“œ ì‹œ ì²´í¬
        const initialType = activityTypeField.value;
        if (initialType === 'delivery') {
            prepaymentSection.style.display = 'block';
        }
    }
    
    // ì„ ê²°ì œ ì‚¬ìš© ì²´í¬ë°•ìŠ¤
    if (usePrepaymentCheckbox) {
        usePrepaymentCheckbox.addEventListener('change', function() {
            if (this.checked) {
                prepaymentDetails.style.display = 'block';
                
                // ì²´í¬ ì‹œ í˜„ì¬ ê³ ê°ì˜ ì„ ê²°ì œ ëª©ë¡ ë¡œë“œ
                const followupField = document.getElementById('id_followup');
                let followupId = null;
                
                // Select2 ë˜ëŠ” ì¼ë°˜ selectì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
                if (followupField) {
                    if (typeof jQuery !== 'undefined' && jQuery(followupField).data('select2')) {
                        // Select2ì¸ ê²½ìš°
                        followupId = jQuery(followupField).val();
                    } else {
                        // ì¼ë°˜ selectì¸ ê²½ìš°
                        followupId = followupField.value;
                    }
                }
                
                if (followupId) {
                    console.log('[ì„ ê²°ì œ] ì²´í¬ë°•ìŠ¤ í´ë¦­ - followupId:', followupId);
                    updatePrepaymentList(followupId);
                } else {
                    console.warn('[ì„ ê²°ì œ] followupIdê°€ ì—†ìŠµë‹ˆë‹¤.');
                }
            } else {
                prepaymentDetails.style.display = 'none';
                
                // ì²´í¬ë°•ìŠ¤ ì´ˆê¸°í™”
                const checkboxes = document.querySelectorAll('.prepayment-checkbox');
                checkboxes.forEach(cb => {
                    cb.checked = false;
                    const amountInput = document.getElementById(`amount-${cb.value}`);
                    if (amountInput) {
                        amountInput.value = '';
                        amountInput.disabled = true;
                    }
                });
                
                // ê³„ì‚° ì´ˆê¸°í™”
                if (typeof updatePrepaymentCalculation === 'function') {
                    updatePrepaymentCalculation();
                }
            }
        });
        
        // ì´ˆê¸° ë¡œë“œ ì‹œ ì²´í¬ - ìˆ˜ì • ëª¨ë“œì—ì„œ ì´ë¯¸ ì²´í¬ë˜ì–´ ìˆìœ¼ë©´ ëª©ë¡ ë¡œë“œ
        if (usePrepaymentCheckbox.checked) {
            prepaymentDetails.style.display = 'block';
            
            // ì„ ê²°ì œ ëª©ë¡ ë¡œë“œ
            const followupField = document.getElementById('id_followup');
            let followupId = null;
            if (followupField) {
                if (typeof jQuery !== 'undefined' && jQuery(followupField).data('select2')) {
                    followupId = jQuery(followupField).val();
                } else {
                    followupId = followupField.value;
                }
            }
            if (followupId) {
                console.log('[ì„ ê²°ì œ] ì´ˆê¸° ë¡œë“œ - followupId:', followupId);
                updatePrepaymentList(followupId);
            }
        }
    }
    
    // ê³ ê° ë³€ê²½ ì‹œ ì„ ê²°ì œ ëª©ë¡ ê°±ì‹  (AJAX)
    const followupField = document.getElementById('id_followup');
    if (followupField) {
        // ì¼ë°˜ change ì´ë²¤íŠ¸
        followupField.addEventListener('change', function() {
            const followupId = this.value;
            updatePrepaymentList(followupId);
        });
        
        // Select2 change ì´ë²¤íŠ¸ (jQueryê°€ ìˆì„ ê²½ìš°)
        if (typeof jQuery !== 'undefined') {
            jQuery(followupField).on('change', function() {
                const followupId = this.value;
                updatePrepaymentList(followupId);
            });
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ë¯¸ ê³ ê°ì´ ì„ íƒë˜ì–´ ìˆìœ¼ë©´ ì„ ê²°ì œ ëª©ë¡ ë¡œë“œ
        if (followupField.value) {
            updatePrepaymentList(followupField.value);
        }
    }
    
    // ì „ì•¡ì‚¬ìš© ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    const useFullAmountCheckbox = document.getElementById('use-full-amount-all');
    if (useFullAmountCheckbox) {
        useFullAmountCheckbox.addEventListener('change', function() {
            if (this.checked) {
                // ë‚©í’ˆ ì´ì•¡ ê°€ì ¸ì˜¤ê¸° (ë©”ì¸ í¼ ë˜ëŠ” ëª¨ë‹¬ì—ì„œ)
                let remainingAmount = 0;
                const deliveryTotalField = document.getElementById('schedule-delivery-total-amount');
                const deliveryTotalElement = document.getElementById('schedule-total-amount');
                
                // ë©”ì¸ í¼ì˜ ì´ì•¡ í•„ë“œ ìš°ì„  í™•ì¸ (ë‚©í’ˆ ëª¨ë“œ)
                if (deliveryTotalField && deliveryTotalField.value) {
                    remainingAmount = parseInt(deliveryTotalField.value) || 0;
                } else if (deliveryTotalElement) {
                    // ëª¨ë‹¬ ë‚´ë¶€ ì´ì•¡ í™•ì¸ (ê²¬ì  ëª¨ë“œ)
                    remainingAmount = parseInt(deliveryTotalElement.textContent.replace(/[^0-9]/g, '')) || 0;
                }
                
                
                if (remainingAmount <= 0) {
                    alert('ë‚©í’ˆ í’ˆëª©ì„ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.');
                    this.checked = false;
                    return;
                }
                
                
                const checkboxes = document.querySelectorAll('.prepayment-checkbox');
                
                // ì„ ê²°ì œë¥¼ ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬
                checkboxes.forEach(checkbox => {
                    const amountInput = document.getElementById(`amount-${checkbox.value}`);
                    const balance = parseInt(checkbox.dataset.balance);
                    
                    if (remainingAmount > 0) {
                        // ë‚¨ì€ ê¸ˆì•¡ì´ ìˆìœ¼ë©´ ì„ ê²°ì œ ì‚¬ìš©
                        checkbox.checked = true;
                        amountInput.disabled = false;
                        
                        // ì„ ê²°ì œ ì”ì•¡ê³¼ ë‚¨ì€ ê¸ˆì•¡ ì¤‘ ì‘ì€ ê°’ ì‚¬ìš©
                        const useAmount = Math.min(balance, remainingAmount);
                        amountInput.value = useAmount;
                        remainingAmount -= useAmount;
                        
                    } else {
                        // ë‚¨ì€ ê¸ˆì•¡ì´ ì—†ìœ¼ë©´ ì„ íƒ í•´ì œ
                        checkbox.checked = false;
                        amountInput.disabled = true;
                        amountInput.value = '';
                    }
                });
                
                // ê³„ì‚° ì—…ë°ì´íŠ¸
                updatePrepaymentCalculation();
                
                if (remainingAmount > 0) {
                    alert(`ì„ ê²°ì œë¡œ ${deliveryTotalElement.textContent.replace(/[^0-9]/g, '') - remainingAmount}ì› ì°¨ê°ë©ë‹ˆë‹¤.\në‚¨ì€ ${remainingAmount.toLocaleString()}ì›ì€ ë³„ë„ ê²°ì œê°€ í•„ìš”í•©ë‹ˆë‹¤.`);
                }
            } else {
                // ì „ì•¡ì‚¬ìš© í•´ì œ ì‹œ: ëª¨ë‘ ì´ˆê¸°í™”
                const checkboxes = document.querySelectorAll('.prepayment-checkbox');
                checkboxes.forEach(checkbox => {
                    const amountInput = document.getElementById(`amount-${checkbox.value}`);
                    checkbox.checked = false;
                    amountInput.disabled = true;
                    amountInput.value = '';
                });
                
                updatePrepaymentCalculation();
            }
        });
    }
});

// ìˆ˜ì • ëª¨ë“œì—ì„œ í˜ì´ì§€ ë¡œë“œ ì‹œ ì„ ê²°ì œ ëª©ë¡ ìë™ ë¡œë“œ
{% if schedule %}
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        const hiddenFollowupField = document.getElementById('id_followup');
        const checkboxContainer = document.getElementById('prepayment-checkboxes');
        
        if (hiddenFollowupField && hiddenFollowupField.value) {
            console.log('[ì„ ê²°ì œ] ìˆ˜ì • ëª¨ë“œ ìë™ ë¡œë“œ - followupId:', hiddenFollowupField.value);
            updatePrepaymentList(hiddenFollowupField.value);
        } else {
            console.warn('[ì„ ê²°ì œ] ìˆ˜ì • ëª¨ë“œì—ì„œ ê³ ê° IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ', {
                hasElement: !!hiddenFollowupField,
                hasValue: hiddenFollowupField ? !!hiddenFollowupField.value : false
            });
        }
    }, 500);  // Select2 ì´ˆê¸°í™” í›„ ì‹¤í–‰
});
{% endif %}
</script>

<style>
  .page-title {
    color: #37352f;
    font-weight: 600;
  }

  .form-control {
    border-radius: 6px;
    border: 1px solid #e3e2e0;
    transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
  }

  .form-control:focus {
    border-color: #2563eb;
    box-shadow: 0 0 0 0.2rem rgba(37, 99, 235, 0.25);
  }

  .form-label {
    font-weight: 600;
    color: #37352f;
    margin-bottom: 0.5rem;
  }

  .card {
    border: none;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    border-radius: 8px;
  }

  /* ìë™ì™„ì„± ìŠ¤íƒ€ì¼ */
  .autocomplete-container {
    position: relative;
  }

  .autocomplete-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--surface);
    border: 1px solid var(--border);
    border-top: none;
    border-radius: 0 0 6px 6px;
    max-height: 300px;
    overflow-y: auto;
    z-index: 100;
    display: none;
  }
  
  /* ëª¨ë‹¬ ë‚´ë¶€ì˜ autocompleteëŠ” ë” ë†’ì€ z-index */
  #followupModal .autocomplete-results {
    z-index: 100060;
  }

  .autocomplete-item {
    padding: 12px 16px;
    cursor: pointer;
    border-bottom: 1px solid var(--border);
    transition: background-color 0.2s;
    color: var(--text-primary);
  }

  .autocomplete-item:hover,
  .autocomplete-item.active {
    background-color: var(--surface-hover);
    color: var(--text-primary);
  }

  .autocomplete-item:last-child {
    border-bottom: none;
  }

  .autocomplete-no-results {
    padding: 12px 16px;
    color: var(--text-muted);
    font-style: italic;
  }

  .followup-autocomplete.loading {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 12a9 9 0 11-6.219-8.56'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 16px;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
  
  /* ë‚ ì§œ/ì‹œê°„ ì…ë ¥ í•„ë“œ ê°œì„  ìŠ¤íƒ€ì¼ */
  input[type="date"], 
  input[type="time"] {
    cursor: pointer !important;
    transition: all 0.3s ease;
    position: relative;
  }
  
  input[type="date"]:hover, 
  input[type="time"]:hover {
    border-color: #0d6efd !important;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25) !important;
    transform: translateY(-1px);
  }
  
  input[type="date"]:focus, 
  input[type="time"]:focus {
    border-color: #0d6efd !important;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25) !important;
    outline: none;
  }
  
  /* ë‚ ì§œ/ì‹œê°„ í•„ë“œì— í´ë¦­ ê°€ëŠ¥í•¨ì„ ë‚˜íƒ€ë‚´ëŠ” ì‹œê°ì  íŒíŠ¸ */
  input[type="date"]::before, 
  input[type="time"]::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    pointer-events: none;
    border-radius: inherit;
    transition: all 0.2s ease;
  }
  
  /* ëª¨ë°”ì¼ì—ì„œë„ í´ë¦­í•˜ê¸° ì‰½ê²Œ ìµœì†Œ ë†’ì´ ì„¤ì • */
  @media (max-width: 768px) {
    input[type="date"], 
    input[type="time"] {
      min-height: 48px;
      font-size: 16px; /* iOS ì¤Œ ë°©ì§€ */
    }
  }
</style>

<script>
// ë‚ ì§œ/ì‹œê°„ ì…ë ¥ í•„ë“œ ì‚¬ìš©ì ê²½í—˜ ê°œì„ 
document.addEventListener('DOMContentLoaded', function() {
    // showPicker() ë©”ì„œë“œ ì§€ì› ì—¬ë¶€ í™•ì¸ í•¨ìˆ˜
    function supportsShowPicker() {
        const input = document.createElement('input');
        input.type = 'date';
        return typeof input.showPicker === 'function';
    }
    
    // ì•ˆì „í•œ showPicker í˜¸ì¶œ í•¨ìˆ˜
    function safeShowPicker(element) {
        try {
            if (supportsShowPicker() && element.showPicker) {
                element.showPicker();
            } else {
                // showPickerë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì˜ ê²½ìš° í¬ì»¤ìŠ¤ë¡œ ëŒ€ì²´
                element.focus();
                // ì¶”ê°€ì ìœ¼ë¡œ í´ë¦­ ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°
                const clickEvent = new MouseEvent('click', {
                    view: window,
                    bubbles: true,
                    cancelable: true
                });
                element.dispatchEvent(clickEvent);
            }
        } catch (error) {
            console.warn('ë‚ ì§œ/ì‹œê°„ ì„ íƒê¸°ë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', error);
            // ì‹¤íŒ¨ ì‹œ í¬ì»¤ìŠ¤ë¡œ ëŒ€ì²´
            element.focus();
        }
    }
    
    // ë°©ë¬¸ ë‚ ì§œ/ì‹œê°„ í•„ë“œë§Œ íƒ€ê¹ƒ - ì•„ì´ì½˜ ë²„íŠ¼ í´ë¦­ ì‹œì—ë§Œ picker ì—´ê¸°
    const visitDateField = document.querySelector('input[name="visit_date"]');
    const visitTimeField = document.querySelector('input[name="visit_time"]');

    const visitDateBtn = document.getElementById('visit-date-picker-btn');
    const visitTimeBtn = document.getElementById('visit-time-picker-btn');

    // ì‹ ê·œ ìƒì„± ì‹œ ë°©ë¬¸ì‹œê°„ì„ í˜„ì¬ í•œêµ­ì‹œê°„ìœ¼ë¡œ ê¸°ë³¸ê°’ ì„¤ì •
    if (visitTimeField && !visitTimeField.value) {
        const now = new Date();
        // í•œêµ­ ì‹œê°„ìœ¼ë¡œ ë³€í™˜ (UTC+9)
        const koreaTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Seoul' }));
        const hours = String(koreaTime.getHours()).padStart(2, '0');
        const minutes = String(koreaTime.getMinutes()).padStart(2, '0');
        visitTimeField.value = `${hours}:${minutes}`;
    }

    // 1) inputì€ í‚¤ë³´ë“œ ì…ë ¥ ê°€ëŠ¥í•˜ê²Œ (readonly ì œê±°)
    if (visitDateField) {
        visitDateField.removeAttribute('readonly');
        visitDateField.style.cursor = 'text';
    }
    if (visitTimeField) {
        visitTimeField.removeAttribute('readonly');
        visitTimeField.style.cursor = 'text';
    }

    // 2) ì˜¤ë¥¸ìª½ ì•„ì´ì½˜ í´ë¦­í–ˆì„ ë•Œë§Œ picker ì—´ê¸°
    if (visitDateField && visitDateBtn) {
        visitDateBtn.addEventListener('click', function (e) {
            e.preventDefault();
            e.stopPropagation();
            if (typeof safeShowPicker === 'function') {
                safeShowPicker(visitDateField);
            } else if (visitDateField.showPicker) {
                try {
                    visitDateField.showPicker();
                } catch (err) {
                    console.warn('showPicker failed:', err);
                }
            }
        });
    }

    if (visitTimeField && visitTimeBtn) {
        visitTimeBtn.addEventListener('click', function (e) {
            e.preventDefault();
            e.stopPropagation();
            if (typeof safeShowPicker === 'function') {
                safeShowPicker(visitTimeField);
            } else if (visitTimeField.showPicker) {
                try {
                    visitTimeField.showPicker();
                } catch (err) {
                    console.warn('showPicker failed:', err);
                }
            }
        });
    }
});

// ==========================================
// í™œë™ ìœ í˜• ë³€ê²½ ì‹œ ë‚©í’ˆ ì„¹ì…˜ ë° í€ë„¬ ì„¹ì…˜ í‘œì‹œ/ìˆ¨ê¹€
// DOMContentLoaded ë°–ì—ì„œ ì „ì—­ í•¨ìˆ˜ë¡œ ì •ì˜
// ==========================================
window.toggleSections = function() {
    const activityTypeField = document.querySelector('[name="activity_type"]');
    if (!activityTypeField) {
        return;
    }
    
    const selectedValue = activityTypeField.value;
    
    // í’ˆëª© ì„¹ì…˜: ê²¬ì  ë˜ëŠ” ë‚©í’ˆì¼ ë•Œë§Œ í‘œì‹œ
    const deliverySection = document.getElementById('delivery-section');
    if (deliverySection) {
        const shouldShowDelivery = (selectedValue === 'delivery' || selectedValue === 'quote');
        deliverySection.style.display = shouldShowDelivery ? 'block' : 'none';
        
        // ì„¹ì…˜ ì œëª© ë³€ê²½
        const sectionTitle = deliverySection.closest('.card')?.querySelector('.card-header h5');
        if (sectionTitle) {
            if (selectedValue === 'quote') {
                sectionTitle.innerHTML = '<i class="fas fa-file-invoice me-2"></i>ê²¬ì  í’ˆëª©';
            } else if (selectedValue === 'delivery') {
                sectionTitle.innerHTML = '<i class="fas fa-boxes me-2"></i>ë‚©í’ˆ í’ˆëª©';
            }
        }
    }
    
    // í’ˆëª© ì…ë ¥ ì•ˆë‚´ ì„¹ì…˜ (ìƒì„± ëª¨ë“œ)
    const itemsSection = document.getElementById('quote-delivery-items-section');
    if (itemsSection) {
        const shouldShow = (selectedValue === 'delivery' || selectedValue === 'quote');
        
        if (shouldShow) {
            itemsSection.style.display = 'block';
        } else {
            itemsSection.style.display = 'none';
        }
        
        
        // ê²¬ì /ë‚©í’ˆ ì¹´ë“œ ì „í™˜ (ìƒì„± ëª¨ë“œì—ë§Œ ì¡´ì¬)
        const quoteItemsCard = document.getElementById('quote-items-card');
        const deliveryItemsCard = document.getElementById('delivery-items-card');
        
        if (quoteItemsCard && deliveryItemsCard) {
            if (selectedValue === 'quote') {
                quoteItemsCard.style.display = 'block';
                deliveryItemsCard.style.display = 'none';
            } else if (selectedValue === 'delivery') {
                quoteItemsCard.style.display = 'none';
                deliveryItemsCard.style.display = 'block';
            }
        }
        
        // ë¯¸íŒ… ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€ (ê²¬ì ì¼ ë•Œë§Œ í‘œì‹œ)
        const loadMeetingBtn = document.getElementById('load-meeting-btn');
        if (loadMeetingBtn) {
            loadMeetingBtn.style.display = (selectedValue === 'quote') ? 'inline-block' : 'none';
        }
        
        // ê²¬ì  ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€ (ë‚©í’ˆì¼ ë•Œë§Œ í‘œì‹œ)
        const loadQuoteBtn = document.getElementById('load-quote-btn');
        const deliveryLoadQuoteBtn = document.getElementById('delivery-load-quote-btn');
        if (loadQuoteBtn) {
            loadQuoteBtn.style.display = (selectedValue === 'delivery') ? 'inline-block' : 'none';
        }
        if (deliveryLoadQuoteBtn) {
            deliveryLoadQuoteBtn.style.display = (selectedValue === 'delivery') ? 'inline-block' : 'none';
        }
        
        // ê²¬ì  ì¼ì •ì˜ ìƒíƒœ í•„ë“œ ì œì–´
        const statusField = document.querySelector('[name="status"]');
        const isEditMode = {{ schedule.pk|default:"0" }} > 0;  // ìˆ˜ì • ëª¨ë“œ ì—¬ë¶€
        
        if (statusField) {
            if (selectedValue === 'quote') {
                if (isEditMode) {
                    // ìˆ˜ì • ëª¨ë“œ: ê²¬ì ì€ ì˜ˆì •/ì·¨ì†Œë§Œ ì„ íƒ ê°€ëŠ¥ (ì™„ë£Œ ë¶ˆê°€)
                    statusField.disabled = false;
                    
                    // ì˜µì…˜ì„ ì˜ˆì •/ì·¨ì†Œë§Œ ë‚¨ê¸°ê¸°
                    const currentValue = statusField.value;
                    statusField.innerHTML = `
                        <option value="scheduled" ${currentValue === 'scheduled' ? 'selected' : ''}>ì˜ˆì •ë¨</option>
                        <option value="cancelled" ${currentValue === 'cancelled' ? 'selected' : ''}>ì·¨ì†Œë¨</option>
                    `;
                    
                    // ë„ì›€ë§ ì¶”ê°€
                    const statusWrapper = statusField.closest('.mb-3');
                    if (statusWrapper) {
                        let helpText = statusWrapper.querySelector('.quote-status-help');
                        if (!helpText) {
                            helpText = document.createElement('small');
                            helpText.className = 'form-text text-warning quote-status-help';
                            helpText.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>ê²¬ì  ì·¨ì†Œ ì‹œ í•´ë‹¹ ì˜ì—…ê¸°íšŒê°€ ì‹¤ì£¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.';
                            statusWrapper.appendChild(helpText);
                        } else {
                            helpText.className = 'form-text text-warning quote-status-help';
                            helpText.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>ê²¬ì  ì·¨ì†Œ ì‹œ í•´ë‹¹ ì˜ì—…ê¸°íšŒê°€ ì‹¤ì£¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.';
                        }
                    }
                } else {
                    // ìƒì„± ëª¨ë“œ: ê²¬ì ì€ í•­ìƒ ì˜ˆì •(scheduled) ìƒíƒœë¡œ ê³ ì •
                    statusField.value = 'scheduled';
                    statusField.disabled = true;
                    
                    // ë„ì›€ë§ ì¶”ê°€
                    const statusWrapper = statusField.closest('.mb-3');
                    if (statusWrapper) {
                        let helpText = statusWrapper.querySelector('.quote-status-help');
                        if (!helpText) {
                            helpText = document.createElement('small');
                            helpText.className = 'form-text text-muted quote-status-help';
                            helpText.innerHTML = '<i class="fas fa-info-circle me-1"></i>ê²¬ì ì€ ë‚©í’ˆ ìƒì„± ì‹œ ìë™ìœ¼ë¡œ ì™„ë£Œ ì²˜ë¦¬ë©ë‹ˆë‹¤.';
                            statusWrapper.appendChild(helpText);
                        }
                    }
                }
            } else {
                // ë‹¤ë¥¸ í™œë™ ìœ í˜•ì€ ìƒíƒœ ë³€ê²½ ê°€ëŠ¥ (ì „ì²´ ì˜µì…˜ ë³µì›)
                statusField.disabled = false;
                
                // ì „ì²´ ì˜µì…˜ ë³µì›
                const currentValue = statusField.value;
                if (statusField.options.length <= 2) {
                    statusField.innerHTML = `
                        <option value="scheduled" ${currentValue === 'scheduled' ? 'selected' : ''}>ì˜ˆì •ë¨</option>
                        <option value="completed" ${currentValue === 'completed' ? 'selected' : ''}>ì™„ë£Œë¨</option>
                        <option value="cancelled" ${currentValue === 'cancelled' ? 'selected' : ''}>ì·¨ì†Œë¨</option>
                    `;
                }
                
                // ë„ì›€ë§ ì œê±°
                const statusWrapper = statusField.closest('.mb-3');
                if (statusWrapper) {
                    const helpText = statusWrapper.querySelector('.quote-status-help');
                    if (helpText) {
                        helpText.remove();
                    }
                }
            }
        }
        
        // í’ˆëª© ì»¨í…Œì´ë„ˆ í™•ì¸ (ê²¬ì  ëª¨ë“œ)
        const itemsContainer = document.getElementById('items-container');
        if (itemsContainer) {
            const existingItems = itemsContainer.querySelectorAll('.item-row');
            
            // ê²¬ì  ëª¨ë“œì¼ ë•Œë§Œ required ì¶”ê°€, ê·¸ ì™¸ì—ëŠ” ì œê±°
            if (selectedValue === 'quote') {
                // í’ˆëª©ì´ ì—†ìœ¼ë©´ í•˜ë‚˜ ì¶”ê°€
                if (existingItems.length === 0) {
                    // addItem í•¨ìˆ˜ê°€ ì •ì˜ë˜ì–´ ìˆìœ¼ë©´ í˜¸ì¶œ
                    if (typeof window.addItem === 'function') {
                        window.addItem();
                    } else {
                        console.error('window.addItem í•¨ìˆ˜ê°€ ì •ì˜ë˜ì§€ ì•ŠìŒ!');
                    }
                } else {
                    // ê¸°ì¡´ í’ˆëª©ë“¤ì— ì œí’ˆ ëª©ë¡ ë¡œë“œ
                    existingItems.forEach(item => {
                        const productSelect = item.querySelector('.quote-product-select');
                        if (productSelect && typeof loadQuoteProductList === 'function') {
                            loadQuoteProductList(productSelect);
                        }
                    });
                }
                // í’ˆëª© í•„ë“œì— required ì¶”ê°€
                existingItems.forEach(item => {
                    const nameInput = item.querySelector('input[name$="[name]"]');
                    const quantityInput = item.querySelector('input[name$="[quantity]"]');
                    if (nameInput) nameInput.setAttribute('required', 'required');
                    if (quantityInput) quantityInput.setAttribute('required', 'required');
                });
            } else {
                // ê²¬ì  ëª¨ë“œê°€ ì•„ë‹ˆë©´ required ì œê±° (ë‚©í’ˆ ëª¨ë“œ ë“±)
                existingItems.forEach(item => {
                    const nameInput = item.querySelector('input[name$="[name]"]');
                    const quantityInput = item.querySelector('input[name$="[quantity]"]');
                    if (nameInput) nameInput.removeAttribute('required');
                    if (quantityInput) quantityInput.removeAttribute('required');
                });
            }
        }
    }
        
        // í’ˆëª© ì„¹ì…˜ ì œëª© ë³€ê²½ (ìˆ˜ì • ëª¨ë“œ)
        const itemsSectionTitle = document.getElementById('items-section-title');
        if (itemsSectionTitle) {
            if (selectedValue === 'quote') {
                itemsSectionTitle.innerHTML = '<i class="fas fa-file-invoice me-2"></i>ê²¬ì  í’ˆëª©';
            } else if (selectedValue === 'delivery') {
                itemsSectionTitle.innerHTML = '<i class="fas fa-boxes me-2"></i>ë‚©í’ˆ í’ˆëª©';
            }
        }
        
        // í€ë„¬ ë“±ë¡ ì„¹ì…˜: ë¯¸íŒ…ì¼ ë•Œë§Œ í‘œì‹œ
        const funnelRegisterSection = document.getElementById('funnel-register-section');
        if (funnelRegisterSection) {
            if (selectedValue === 'customer_meeting') {
                funnelRegisterSection.style.display = 'block';
            } else {
                funnelRegisterSection.style.display = 'none';
            }
        }
        
        // ì„ ê²°ì œ ì„¹ì…˜: ë‚©í’ˆì¼ ë•Œë§Œ í‘œì‹œ
        const prepaymentSection = document.getElementById('prepayment-section');
        if (prepaymentSection) {
            if (selectedValue === 'delivery') {
                prepaymentSection.style.display = 'block';
                
                // ê³ ê°ì´ ì„ íƒë˜ì–´ ìˆìœ¼ë©´ ì„ ê²°ì œ ëª©ë¡ ë¡œë“œ
                const followupField = document.getElementById('id_followup');
                if (followupField && followupField.value && typeof updatePrepaymentList === 'function') {
                    updatePrepaymentList(followupField.value);
                }
            } else {
                prepaymentSection.style.display = 'none';
                // ì„ ê²°ì œ ì‚¬ìš© ì²´í¬ í•´ì œ
                const usePrepaymentCheckbox = document.getElementById('id_use_prepayment');
                if (usePrepaymentCheckbox) {
                    usePrepaymentCheckbox.checked = false;
                }
                const prepaymentDetails = document.getElementById('prepayment-details');
                if (prepaymentDetails) {
                    prepaymentDetails.style.display = 'none';
                }
            }
        }
};

// ë ˆê±°ì‹œ í•¨ìˆ˜ ìœ ì§€ (í•˜ìœ„ í˜¸í™˜ì„±)
window.toggleDeliverySection = function() {
    window.toggleSections();
};

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    const activityTypeField = document.querySelector('[name="activity_type"]');
    if (activityTypeField) {
        window.toggleSections();
        
        // ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        activityTypeField.addEventListener('change', window.toggleSections);
    }
});

// í’ˆëª© ê´€ë¦¬ ê´€ë ¨ í•¨ìˆ˜ë“¤ (ì „ì—­ í•¨ìˆ˜ë¡œ ì •ì˜)
let itemIndex = 0;

// addItem í•¨ìˆ˜ë¥¼ window ê°ì²´ì— ë“±ë¡í•˜ì—¬ ì „ì—­ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•˜ë„ë¡
window.addItem = function(itemData = {}) {
    const container = document.getElementById('items-container');
    if (!container) {
        console.error('items-containerë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
        return;
    }
    
    const newItem = document.createElement('div');
    newItem.className = 'item-row row mb-3 p-3 border rounded bg-light';
    
    // í˜„ì¬ í™œë™ ìœ í˜• í™•ì¸
    const activityTypeField = document.querySelector('[name="activity_type"]');
    const isItemsVisible = activityTypeField && (activityTypeField.value === 'quote' || activityTypeField.value === 'delivery');
    const requiredAttr = isItemsVisible ? 'required' : '';
    
    const itemName = itemData.name || '';
    const quantity = itemData.quantity || '';
    const unitPrice = itemData.unit_price || '';
    const productId = itemData.product_id || '';
    
    newItem.innerHTML = `
        <div class="col-12 mb-3" style="position: relative;">
            <label class="form-label fw-bold">ì œí’ˆ ê²€ìƒ‰ ë° ì„ íƒ <span class="text-danger">*</span></label>
            <div class="input-group">
                <input type="text" class="form-control quote-product-search" placeholder="í’ˆë²ˆìœ¼ë¡œ ê²€ìƒ‰... (Enterë¡œ ê²€ìƒ‰)" 
                       onkeydown="if(event.key === 'Enter') { event.preventDefault(); searchQuoteProducts(this); }">
                <button class="btn btn-outline-secondary" type="button" onclick="clearQuoteProductSearch(this)">
                    <i class="fas fa-times"></i>
                </button>
                <button class="btn btn-success" type="button" onclick="openQuoteProductModal(this)" title="ìƒˆ ì œí’ˆ ì¶”ê°€">
                    <i class="fas fa-plus"></i> ì œí’ˆ ì¶”ê°€
                </button>
            </div>
            <!-- ê²€ìƒ‰ ê²°ê³¼ ë“œë¡­ë‹¤ìš´ -->
            <div class="quote-search-results" style="display: none; position: absolute; z-index: 100010; background: var(--surface); border: 1px solid var(--border); max-height: 200px; overflow-y: auto; width: 100%; left: 0; top: 100%; box-shadow: var(--shadow-lg); border-radius: 4px; margin-top: 2px;"></div>
            <input type="hidden" name="items[${itemIndex}][product_id]" class="quote-product-id" value="${productId}">
        </div>
        <div class="col-md-4">
            <label class="form-label fw-bold">í’ˆëª©ëª…</label>
            <input type="text" name="items[${itemIndex}][name]" class="form-control quote-item-name" 
                   value="${itemName}" readonly>
        </div>
        <div class="col-md-2">
            <label class="form-label fw-bold">ìˆ˜ëŸ‰ <span class="text-danger">*</span></label>
            <input type="number" name="items[${itemIndex}][quantity]" 
                   class="form-control quantity-input" min="1" value="${quantity}" 
                   placeholder="ìˆ˜ëŸ‰" ${requiredAttr} oninput="calculateItemTotal(event)">
        </div>
        <div class="col-md-2">
            <label class="form-label fw-bold">ë‹¨ê°€ (ë¶€ê°€ì„¸ ë³„ë„)</label>
            <input type="text" class="form-control quote-unit-price-display" 
                   value="${unitPrice ? parseInt(unitPrice).toLocaleString() : ''}" 
                   oninput="updateQuoteUnitPrice(this)" placeholder="ë‹¨ê°€ ì…ë ¥">
            <input type="hidden" name="items[${itemIndex}][unit_price]" 
                   class="unit-price-input" value="${unitPrice}">
        </div>
        <div class="col-md-3">
            <label class="form-label fw-bold">ê¸ˆì•¡ (ë¶€ê°€ì„¸ í¬í•¨)</label>
            <div class="form-control-plaintext">
                <span class="item-total fw-bold text-primary">0ì›</span>
            </div>
        </div>
        <div class="col-md-1 d-flex align-items-end">
            <button type="button" class="btn btn-danger btn-sm w-100" onclick="removeItem(this)" title="ì‚­ì œ">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    
    container.appendChild(newItem);
    itemIndex++;
    
    // ì œí’ˆ ëª©ë¡ ë¡œë“œ (newItem ìì²´ë¥¼ ì „ë‹¬)
    loadQuoteProductList(newItem);
    
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    const quantityInput = newItem.querySelector('.quantity-input');
    const unitPriceInput = newItem.querySelector('.unit-price-input');
    
    quantityInput.addEventListener('input', calculateItemTotal);
    unitPriceInput.addEventListener('input', calculateItemTotal);
    
    // ì´ˆê¸° ê³„ì‚°
    if (itemData.quantity && itemData.unit_price) {
        calculateItemTotal({ target: quantityInput });
    }
    
    // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
    newItem.style.opacity = '0';
    newItem.style.transform = 'translateY(-10px)';
    setTimeout(() => {
        newItem.style.transition = 'all 0.3s ease';
        newItem.style.opacity = '1';
        newItem.style.transform = 'translateY(0)';
    }, 10);
}

function removeItem(button) {
    if (document.querySelectorAll('.item-row').length <= 1) {
        alert('ìµœì†Œ í•˜ë‚˜ì˜ í’ˆëª©ì€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.');
        return;
    }
    
    const item = button.closest('.item-row');
    item.style.transition = 'all 0.3s ease';
    item.style.opacity = '0';
    item.style.transform = 'translateY(-10px)';
    
    setTimeout(() => {
        item.remove();
        calculateTotal();
    }, 300);
}

function calculateItemTotal(event) {
    const item = event.target.closest('.item-row');
    const quantity = parseFloat(item.querySelector('.quantity-input').value) || 0;
    const unitPrice = parseFloat(item.querySelector('.unit-price-input').value) || 0;
    
    // ë¶€ê°€ì„¸ í¬í•¨ ê³„ì‚°: (ë‹¨ê°€ * ìˆ˜ëŸ‰) * 1.1
    const subtotal = quantity * unitPrice;
    const total = subtotal * 1.1;
    
    item.querySelector('.item-total').textContent = Math.round(total).toLocaleString() + 'ì›';
    calculateTotal();
}

function calculateTotal() {
    const items = document.querySelectorAll('.item-row');
    let subtotal = 0;
    
    items.forEach(item => {
        const quantity = parseFloat(item.querySelector('.quantity-input').value) || 0;
        const unitPrice = parseFloat(item.querySelector('.unit-price-input').value) || 0;
        subtotal += quantity * unitPrice;
    });
    
    const tax = subtotal * 0.1;
    const total = subtotal + tax;
    
    // í™”ë©´ ì—…ë°ì´íŠ¸
    document.getElementById('subtotal-amount').textContent = Math.round(subtotal).toLocaleString() + 'ì›';
    document.getElementById('tax-amount').textContent = Math.round(tax).toLocaleString() + 'ì›';
    document.getElementById('total-amount').textContent = Math.round(total).toLocaleString() + 'ì›';
    
    // ì˜ˆìƒ ë§¤ì¶œì•¡ í•„ë“œì— ìë™ ë°˜ì˜
    const expectedRevenueField = document.querySelector('[name="expected_revenue"]');
    if (expectedRevenueField) {
        expectedRevenueField.value = Math.round(total);
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° í’ˆëª© ì¶”ê°€ (ê²¬ì /ë‚©í’ˆ ì„ íƒ ì‹œì—ë§Œ)
document.addEventListener('DOMContentLoaded', function() {
    const itemsContainer = document.getElementById('items-container');
    const activityTypeField = document.querySelector('[name="activity_type"]');
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ í™œë™ ìœ í˜•ì´ ê²¬ì  ë˜ëŠ” ë‚©í’ˆì´ë©´ í’ˆëª© 1ê°œ ì¶”ê°€
    if (itemsContainer && activityTypeField) {
        const activityType = activityTypeField.value;
        if (activityType === 'quote' || activityType === 'delivery') {
            addItem(); // ê¸°ë³¸ 1ê°œ í’ˆëª© ì¶”ê°€
        }
    }
});

// ê²¬ì ì—ì„œ í’ˆëª© ë¶ˆëŸ¬ì˜¤ê¸° (ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë‹¬ í‘œì‹œ)
// ë¯¸íŒ…ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸° (ê²¬ì  ì‘ì„± ì‹œ)
function loadFromMeeting() {
    const followupField = document.querySelector('[name="followup"]');
    if (!followupField || !followupField.value) {
        alert('ë¨¼ì € íŒ”ë¡œìš°ì—…ì„ ì„ íƒí•˜ì„¸ìš”.');
        return;
    }
    
    const followupId = followupField.value;
    
    // í•´ë‹¹ íŒ”ë¡œìš°ì—…ì˜ ë¯¸íŒ… ì¼ì • ì¡°íšŒ
    fetch(`/reporting/api/followups/${followupId}/meetings/`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }
            
            if (!data.meetings || data.meetings.length === 0) {
                alert('ì´ ê³ ê°ì˜ ë¯¸íŒ… ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ë¯¸íŒ… ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
            showMeetingSelectionModal(data.meetings);
        })
        .catch(error => {
            console.error('ë¯¸íŒ… ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
            alert('ë¯¸íŒ…ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
}

// ë¯¸íŒ… ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
function showMeetingSelectionModal(meetings) {
    const modalHtml = `
        <div class="modal fade" id="meetingSelectionModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title"><i class="fas fa-user-tie me-2"></i>ë¯¸íŒ… ì„ íƒ</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p class="mb-3"><i class="fas fa-info-circle text-info me-2"></i>ì—°ê²°í•  ë¯¸íŒ…ì„ ì„ íƒí•˜ì„¸ìš”:</p>
                        <div class="list-group" id="meetingListGroup">
                            ${meetings.map((meeting, index) => `
                                <button type="button" class="list-group-item list-group-item-action meeting-item" data-meeting-index="${index}">
                                    <div class="d-flex w-100 justify-content-between align-items-start">
                                        <div>
                                            <h6 class="mb-1">
                                                <i class="fas fa-calendar-check text-success me-2"></i>
                                                ${meeting.opportunity_title || 'ë¯¸íŒ… ' + (index + 1)}
                                            </h6>
                                            ${meeting.expected_revenue ? `
                                                <p class="mb-1">
                                                    <span class="badge bg-success me-2">ì˜ˆìƒ ë§¤ì¶œ: ${meeting.expected_revenue.toLocaleString()}ì›</span>
                                                    ${meeting.probability ? `<span class="badge bg-info">í™•ë¥ : ${meeting.probability}%</span>` : ''}
                                                </p>
                                            ` : ''}
                                            ${meeting.notes ? `
                                                <small class="text-muted">
                                                    <i class="fas fa-sticky-note me-1"></i>${meeting.notes.substring(0, 100)}${meeting.notes.length > 100 ? '...' : ''}
                                                </small>
                                            ` : ''}
                                        </div>
                                        <small class="text-muted">
                                            <i class="fas fa-calendar-alt me-1"></i>${meeting.visit_date}
                                        </small>
                                    </div>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>ì·¨ì†Œ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
    const existingModal = document.getElementById('meetingSelectionModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // ìƒˆ ëª¨ë‹¬ ì¶”ê°€
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // ì „ì—­ ë³€ìˆ˜ì— meetings ì €ì¥
    window.currentMeetings = meetings;
    
    // ëª¨ë‹¬ í‘œì‹œ
    const modalElement = document.getElementById('meetingSelectionModal');
    const modal = new bootstrap.Modal(modalElement);
    window.currentMeetingModal = modal;
    
    // ëª¨ë‹¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    modalElement.addEventListener('show.bs.modal', function(e) {
        
        if (modalElement.parentElement !== document.body) {
            document.body.appendChild(modalElement);
        }
        
        modalElement.style.zIndex = '100100';
        modalElement.style.display = 'block';
    });
    
    modalElement.addEventListener('shown.bs.modal', function() {
        
        // backdrop z-index ì¡°ì •
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => {
            backdrop.style.zIndex = '100099';
        });
        
        modalElement.style.pointerEvents = 'auto';
        
        const modalContent = modalElement.querySelector('.modal-content');
        if (modalContent) {
            modalContent.style.pointerEvents = 'auto';
        }
    });
    
    // ëª¨ë‹¬ ë‹«í ë•Œ ì •ë¦¬
    modalElement.addEventListener('hidden.bs.modal', function() {
    });
    
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    document.querySelectorAll('.meeting-item').forEach(button => {
        button.addEventListener('click', function() {
            const index = parseInt(this.dataset.meetingIndex);
            selectMeeting(index);
        });
    });
    
    modal.show();
}

// ë¯¸íŒ… ì„ íƒ ì²˜ë¦¬
function selectMeeting(index) {
    
    if (!window.currentMeetings || !window.currentMeetings[index]) {
        console.error('ë¯¸íŒ… ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. index:', index);
        alert('ë¯¸íŒ… ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        return;
    }
    
    const selectedMeeting = window.currentMeetings[index];
    
    loadMeetingData(selectedMeeting);
    
    if (window.currentMeetingModal) {
        window.currentMeetingModal.hide();
    }
}

// ì„ íƒëœ ë¯¸íŒ… ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
function loadMeetingData(meeting) {
    
    if (!meeting) {
        console.error('[LOAD_MEETING] ì˜ëª»ëœ ë¯¸íŒ… ë°ì´í„°:', meeting);
        alert('ë¯¸íŒ… ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
    }
    
    // ì„ íƒí•œ ë¯¸íŒ…ì˜ opportunityë¥¼ í¼ì˜ opportunity í•„ë“œì— ì„¤ì •
    const opportunityField = document.querySelector('[name="opportunity"]');
    if (opportunityField && meeting.opportunity_id) {
        opportunityField.value = meeting.opportunity_id;
        
        // í€ë„¬ ì •ë³´ë„ ìë™ìœ¼ë¡œ ë¡œë“œ
        if (typeof loadOpportunityData === 'function') {
            loadOpportunityData(meeting.opportunity_id);
        }
    } else {
        console.warn('[LOAD_MEETING] Opportunity field not found or opportunity_id is missing');
    }
    
    // ì˜ˆìƒ ë§¤ì¶œì•¡ ì„¤ì •
    const expectedRevenueField = document.querySelector('[name="expected_revenue"]');
    
    if (expectedRevenueField && meeting.expected_revenue) {
        expectedRevenueField.value = meeting.expected_revenue;
        
        // ì…ë ¥ ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°í•˜ì—¬ í™”ë©´ ì—…ë°ì´íŠ¸
        expectedRevenueField.dispatchEvent(new Event('input', { bubbles: true }));
        expectedRevenueField.dispatchEvent(new Event('change', { bubbles: true }));
    } else {
        console.warn('[LOAD_MEETING] expectedRevenueField ë˜ëŠ” meeting.expected_revenue ì—†ìŒ');
    }
    
    // í™•ë¥  ì„¤ì •
    const probabilityField = document.querySelector('[name="probability"]');
    
    if (probabilityField && meeting.probability) {
        probabilityField.value = meeting.probability;
        
        // ì…ë ¥ ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°í•˜ì—¬ í™”ë©´ ì—…ë°ì´íŠ¸
        probabilityField.dispatchEvent(new Event('input', { bubbles: true }));
        probabilityField.dispatchEvent(new Event('change', { bubbles: true }));
    } else {
        console.warn('[LOAD_MEETING] probabilityField ë˜ëŠ” meeting.probability ì—†ìŒ');
    }
    
    // ì˜ˆìƒ ê³„ì•½ì¼ ì„¤ì •
    const expectedCloseDateField = document.querySelector('[name="expected_close_date"]');
    
    if (expectedCloseDateField && meeting.expected_close_date) {
        expectedCloseDateField.value = meeting.expected_close_date;
        
        // ì…ë ¥ ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°í•˜ì—¬ í™”ë©´ ì—…ë°ì´íŠ¸
        expectedCloseDateField.dispatchEvent(new Event('input', { bubbles: true }));
        expectedCloseDateField.dispatchEvent(new Event('change', { bubbles: true }));
    } else {
        console.warn('[LOAD_MEETING] expectedCloseDateField ë˜ëŠ” meeting.expected_close_date ì—†ìŒ');
    }
    
    // í•„ë“œì— ì‹œê°ì  íš¨ê³¼ ì¶”ê°€
    setTimeout(() => {
        [expectedRevenueField, probabilityField, expectedCloseDateField].forEach(field => {
            if (field && field.value) {
                field.style.backgroundColor = '#d4edda';
                field.style.transition = 'background-color 0.5s';
                setTimeout(() => {
                    field.style.backgroundColor = '';
                }, 2000);
            }
        });
    }, 100);
    
    // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ (ëª¨ë‹¬ ë‹«íŒ í›„)
    setTimeout(() => {
        const message = `ë¯¸íŒ…ê³¼ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nâœ“ ë¯¸íŒ…ì¼: ${meeting.visit_date}\nâœ“ ì˜ˆìƒ ë§¤ì¶œì•¡: ${meeting.expected_revenue ? meeting.expected_revenue.toLocaleString() + 'ì›' : 'ì—†ìŒ'}`;
        alert(message);
    }, 300);
}

function loadFromQuote() {
    const followupField = document.querySelector('[name="followup"]');
    if (!followupField || !followupField.value) {
        alert('ë¨¼ì € íŒ”ë¡œìš°ì—…ì„ ì„ íƒí•˜ì„¸ìš”.');
        return;
    }
    
    const followupId = followupField.value;
    
    // í•´ë‹¹ íŒ”ë¡œìš°ì—…ì˜ ê²¬ì  ì¼ì • ì¡°íšŒ
    fetch(`/reporting/api/followups/${followupId}/quote-items/`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }
            
            if (!data.quotes || data.quotes.length === 0) {
                alert('ì´ ê³ ê°ì˜ ê²¬ì  í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // í•­ìƒ ê²¬ì  ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
            showQuoteSelectionModal(data.quotes);
        })
        .catch(error => {
            console.error('ê²¬ì  ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
            alert('ê²¬ì ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
}

// ê²¬ì  ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
function showQuoteSelectionModal(quotes) {
    const modalHtml = `
        <div class="modal fade" id="quoteSelectionModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title"><i class="fas fa-file-invoice me-2"></i>ê²¬ì  ì„ íƒ</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p class="mb-3"><i class="fas fa-info-circle text-info me-2"></i>ë¶ˆëŸ¬ì˜¬ ê²¬ì ì„ ì„ íƒí•˜ì„¸ìš”:</p>
                        <div class="list-group" id="quoteListGroup">
                            ${quotes.map((quote, index) => `
                                <button type="button" class="list-group-item list-group-item-action quote-item" data-quote-index="${index}">
                                    <div class="d-flex w-100 justify-content-between align-items-start">
                                        <div>
                                            <h6 class="mb-1">
                                                <i class="fas fa-file-alt text-primary me-2"></i>
                                                ${quote.opportunity_title || 'ê²¬ì  ' + (index + 1)}
                                            </h6>
                                            <p class="mb-1">
                                                <span class="badge bg-success me-2">ì˜ˆìƒ ë§¤ì¶œ: ${quote.expected_revenue.toLocaleString()}ì›</span>
                                                <span class="badge bg-info">í’ˆëª© ${quote.items.length}ê°œ</span>
                                            </p>
                                            <small class="text-muted">
                                                ${quote.items.map(item => item.item_name).join(', ')}
                                            </small>
                                        </div>
                                        <small class="text-muted">
                                            <i class="fas fa-calendar-alt me-1"></i>${quote.quote_date}
                                        </small>
                                    </div>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>ì·¨ì†Œ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
    const existingModal = document.getElementById('quoteSelectionModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // ìƒˆ ëª¨ë‹¬ ì¶”ê°€
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // ì „ì—­ ë³€ìˆ˜ì— quotes ì €ì¥
    window.currentQuotes = quotes;
    
    // ëª¨ë‹¬ í‘œì‹œ
    const modalElement = document.getElementById('quoteSelectionModal');
    const modal = new bootstrap.Modal(modalElement);
    window.currentQuoteModal = modal;
    
    // ëª¨ë‹¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    modalElement.addEventListener('show.bs.modal', function(e) {
        
        if (modalElement.parentElement !== document.body) {
            document.body.appendChild(modalElement);
        }
        
        modalElement.style.zIndex = '100100';
        modalElement.style.display = 'block';
    });
    
    modalElement.addEventListener('shown.bs.modal', function() {
        
        // ë‹¤ë¥¸ ëª¨ë“  ëª¨ë‹¬ ë‹«ê¸°
        const otherModals = document.querySelectorAll('.modal:not(#quoteSelectionModal)');
        otherModals.forEach(modal => {
            const modalInstance = bootstrap.Modal.getInstance(modal);
            if (modalInstance) {
                modalInstance.hide();
            }
        });
        
        // í˜ì´ì§€ ìš”ì†Œë“¤ ë’¤ë¡œ ë³´ë‚´ê¸° (ëª¨ë‹¬ ë‚´ë¶€ ìš”ì†ŒëŠ” ì œì™¸)
        const pageElements = document.querySelectorAll('.container, .card, form');
        pageElements.forEach(el => {
            // ëª¨ë‹¬ ë‚´ë¶€ ìš”ì†Œì¸ì§€ í™•ì¸
            if (!el.closest('#quoteSelectionModal')) {
                el.style.position = 'relative';
                el.style.zIndex = '1';
            }
        });
        
        // backdrop z-index ì¡°ì •
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => {
            backdrop.style.zIndex = '100099';
        });
        
        // ëª¨ë‹¬ dialogì™€ contentì˜ ìƒí˜¸ì‘ìš© ë³´ì¥
        const modalDialog = modalElement.querySelector('.modal-dialog');
        const modalContent = modalElement.querySelector('.modal-content');
        
        if (modalDialog) {
            modalDialog.style.position = 'relative';
            modalDialog.style.zIndex = '100101';
            modalDialog.style.pointerEvents = 'auto';
        }
        if (modalContent) {
            modalContent.style.position = 'relative';
            modalContent.style.zIndex = '100102';
            modalContent.style.pointerEvents = 'auto';
            
            // ëª¨ë‹¬ ë‚´ë¶€ì˜ ëª¨ë“  ì¸í„°ë™í‹°ë¸Œ ìš”ì†Œë“¤ì— pointer-events ì„¤ì •
            const interactiveElements = modalContent.querySelectorAll('input, select, textarea, button, a, .btn, .form-control, .list-group-item');
            interactiveElements.forEach(el => {
                el.style.pointerEvents = 'auto';
            });
        }
        
        modalElement.style.pointerEvents = 'auto';
        
    });
    
    // ëª¨ë‹¬ ë‹«í ë•Œ ì›ë˜ëŒ€ë¡œ ë³µì›
    modalElement.addEventListener('hidden.bs.modal', function() {
        
        const pageElements = document.querySelectorAll('.container, .card, form');
        pageElements.forEach(el => {
            el.style.zIndex = '';
        });
    });
    
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    document.querySelectorAll('.quote-item').forEach(button => {
        button.addEventListener('click', function() {
            const index = parseInt(this.dataset.quoteIndex);
            selectQuote(index);
        });
    });
    
    modal.show();
}

// ê²¬ì  ì„ íƒ ì²˜ë¦¬
function selectQuote(index) {
    
    if (!window.currentQuotes || !window.currentQuotes[index]) {
        console.error('ê²¬ì  ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. index:', index);
        alert('ê²¬ì  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        return;
    }
    
    const selectedQuote = window.currentQuotes[index];
    
    loadQuoteItems(selectedQuote);
    
    if (window.currentQuoteModal) {
        window.currentQuoteModal.hide();
    }
}

// ì„ íƒëœ ê²¬ì  í’ˆëª© ë¶ˆëŸ¬ì˜¤ê¸°
function loadQuoteItems(quote) {
    
    if (!quote || !quote.items) {
        console.error('ì˜ëª»ëœ ê²¬ì  ë°ì´í„°:', quote);
        alert('ê²¬ì  ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
    }
    
    
    // ì„ íƒí•œ ê²¬ì ì˜ opportunityë¥¼ í¼ì˜ opportunity í•„ë“œì— ì„¤ì •
    const opportunityField = document.querySelector('[name="opportunity"]');
    if (opportunityField && quote.opportunity_id) {
        opportunityField.value = quote.opportunity_id;
    } else {
        console.warn('Opportunity field not found or opportunity_id is missing');
    }
    
    // í˜„ì¬ í™œë™ ìœ í˜• í™•ì¸
    const activityTypeField = document.querySelector('[name="activity_type"]');
    const currentActivityType = activityTypeField ? activityTypeField.value : '';
    
    if (currentActivityType === 'delivery') {
        // ë‚©í’ˆ ëª¨ë“œ: ë‚©í’ˆ í’ˆëª© ë°ì´í„° ë°°ì—´ì— ì¶”ê°€
        scheduleDeliveryItemsData = quote.items.map(item => ({
            name: item.item_name,
            quantity: item.quantity,
            unit_price: item.unit_price
        }));
        
        // ë‚©í’ˆ í’ˆëª© ê°œìˆ˜ ì—…ë°ì´íŠ¸
        updateScheduleDeliveryItemCount();
        
        // ì˜ˆìƒ ë§¤ì¶œì•¡ í•„ë“œì— ìë™ ì„¤ì •
        const expectedRevenueField = document.querySelector('[name="expected_revenue"]');
        if (expectedRevenueField && quote.expected_revenue) {
            expectedRevenueField.value = quote.expected_revenue;
        }
        
    } else {
        // ê²¬ì  ëª¨ë“œ: ê¸°ì¡´ ë°©ì‹ëŒ€ë¡œ items-containerì— ì¶”ê°€
        const container = document.getElementById('items-container');
        container.innerHTML = '';
        itemIndex = 0;
        
        // ê²¬ì  í’ˆëª© ì¶”ê°€
        quote.items.forEach((item, index) => {
            addItem({
                name: item.item_name,
                quantity: item.quantity,
                unit_price: item.unit_price
            });
        });
        
        // í•©ê³„ ê³„ì‚° (ì˜ˆìƒ ë§¤ì¶œì•¡ ìë™ ë°˜ì˜)
        calculateTotal();
    }
    
    // ë‚©í’ˆì´ë¯€ë¡œ í™•ë¥  100%ë¡œ ì„¤ì •
    const probabilityField = document.querySelector('[name="probability"]');
    if (probabilityField) {
        probabilityField.value = 100;
    }
    
    // ì˜ˆìƒ ê³„ì•½ì¼ì„ ë°©ë¬¸ ë‚ ì§œë¡œ ì„¤ì •
    const visitDateField = document.querySelector('[name="visit_date"]');
    const expectedCloseDateField = document.querySelector('[name="expected_close_date"]');
    if (visitDateField && expectedCloseDateField && visitDateField.value) {
        expectedCloseDateField.value = visitDateField.value;
    }
    
    alert(`ê²¬ì  í’ˆëª© ${quote.items.length}ê°œë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.\nê²¬ì ì¼: ${quote.quote_date}`);
}

// ê²¬ì /ë‚©í’ˆ í’ˆëª© ê´€ë¦¬ ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤ (ì „ì—­ í•¨ìˆ˜ë¡œ ì •ì˜)
let scheduleDeliveryItemIndex = 0;
let scheduleDeliveryItemsData = [];
let currentItemsContext = null;  // 'delivery' ë˜ëŠ” 'quote' - í˜„ì¬ ëª¨ë‹¬ì´ ì–´ë–¤ ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì—´ë ¸ëŠ”ì§€

function openScheduleDeliveryModal(context) {
  // context ì¸ìê°€ ì—†ìœ¼ë©´ í˜„ì¬ activity_type ë³´ê³  fallback
  if (!context) {
    const activityTypeField = document.querySelector('[name="activity_type"]');
    context = activityTypeField ? activityTypeField.value : 'delivery';
  }
  currentItemsContext = context;  // 'delivery' ë˜ëŠ” 'quote'
  
  // ìˆ˜ì • ëª¨ë“œì¸ì§€ í™•ì¸
  {% if schedule %}
  alert('ìˆ˜ì • ëª¨ë“œì—ì„œëŠ” í’ˆëª©ì„ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\ní’ˆëª©ì„ ìˆ˜ì •í•˜ë ¤ë©´:\nâ€¢ ìº˜ë¦°ë”ì—ì„œ ì¼ì • ìƒì„¸ ëª¨ë‹¬ì„ ì´ìš©í•˜ê±°ë‚˜\nâ€¢ í™œë™ ê¸°ë¡(íˆìŠ¤í† ë¦¬) í˜ì´ì§€ì—ì„œ ìˆ˜ì •í•˜ì„¸ìš”.');
  return;
  {% endif %}
  
  // ê¸°ì¡´ ë°ì´í„°ê°€ ì—†ì„ ë•Œë§Œ ì´ˆê¸°í™”
  if (!scheduleDeliveryItemsData || scheduleDeliveryItemsData.length === 0) {
    scheduleDeliveryItemsData = [];
  }
  
  // ì»¨í…ìŠ¤íŠ¸ì— ë”°ë¼ í—¤ë” ìƒ‰ìƒ ë° í…ìŠ¤íŠ¸ ë³€ê²½
  const isQuote = (context === 'quote');
  const headerClass = isQuote ? 'bg-info text-white' : 'bg-warning text-dark';
  const headerIcon = isQuote ? 'fa-file-invoice' : 'fa-boxes';
  const headerText = isQuote ? 'ê²¬ì  í’ˆëª© ê´€ë¦¬' : 'ë‚©í’ˆ í’ˆëª© ê´€ë¦¬';
  const buttonCloseClass = isQuote ? 'btn-close-white' : '';
  
  // ëª¨ë‹¬ HTML ìƒì„±
  const modalHtml = `
    <div class="modal fade" id="scheduleDeliveryItemsModal" tabindex="-1" aria-labelledby="scheduleDeliveryModalLabel" aria-hidden="true" style="z-index: 100000;" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header ${headerClass}">
            <h5 class="modal-title" id="scheduleDeliveryModalLabel">
              <i class="fas ${headerIcon} me-2"></i>${headerText}
            </h5>
            <button type="button" class="btn-close ${buttonCloseClass}" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div class="alert alert-info mb-0 flex-grow-1 me-3">
                <i class="fas fa-info-circle me-2"></i>
                í’ˆëª©ëª…ê³¼ ìˆ˜ëŸ‰ì€ í•„ìˆ˜ ì…ë ¥ ì‚¬í•­ì…ë‹ˆë‹¤. ë‹¨ê°€ë¥¼ ì…ë ¥í•˜ë©´ ë¶€ê°€ì„¸ 10%ê°€ ìë™ìœ¼ë¡œ í¬í•¨ëœ ì´ì•¡ì´ ê³„ì‚°ë©ë‹ˆë‹¤.
              </div>
              <button type="button" class="btn btn-success" onclick="addScheduleDeliveryItem()">
                <i class="fas fa-plus me-1"></i>í’ˆëª© ì¶”ê°€
              </button>
            </div>
            
            <div id="schedule-delivery-items-container">
              <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë˜ëŠ” í’ˆëª©ë“¤ -->
            </div>
            
            <!-- ì´ì•¡ í‘œì‹œ -->
            <div class="row mt-4">
              <div class="col-12">
                <div class="card bg-light" style="position: relative; z-index: 1;">
                  <div class="card-body">
                    <div class="row">
                      <div class="col-md-4">
                        <div class="d-flex justify-content-between">
                          <span>ì†Œê³„:</span>
                          <span id="schedule-subtotal-amount" class="fw-bold">0ì›</span>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="d-flex justify-content-between">
                          <span>ë¶€ê°€ì„¸ (10%):</span>
                          <span id="schedule-tax-amount" class="fw-bold">0ì›</span>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="d-flex justify-content-between">
                          <span class="fs-5">ì´ì•¡:</span>
                          <span id="schedule-total-amount" class="fw-bold text-primary fs-5">0ì›</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="fas fa-times me-1"></i>ì·¨ì†Œ
            </button>
            <button type="button" class="btn btn-primary" onclick="saveScheduleDeliveryItems()">
              <i class="fas fa-save me-1"></i>ì ìš©
            </button>
          </div>
        </div>
      </div>
    </div>
  `;

  // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
  const existingModal = document.getElementById('scheduleDeliveryItemsModal');
  if (existingModal) {
    existingModal.remove();
  }

  // ìƒˆ ëª¨ë‹¬ ì¶”ê°€
  document.body.insertAdjacentHTML('beforeend', modalHtml);

  // ëª¨ë‹¬ í‘œì‹œ
  const modal = new bootstrap.Modal(document.getElementById('scheduleDeliveryItemsModal'));
  modal.show();
  
  // ëª¨ë‹¬ backdrop z-index ì„¤ì • ë° ìƒí˜¸ì‘ìš© í™œì„±í™”
  const modalElement = document.getElementById('scheduleDeliveryItemsModal');
  
  // ëª¨ë‹¬ì„ bodyì˜ ì§ì ‘ ìì‹ìœ¼ë¡œ ì´ë™
  modalElement.addEventListener('show.bs.modal', function(e) {
    
    if (modalElement.parentElement !== document.body) {
      document.body.appendChild(modalElement);
    }
    
    modalElement.style.zIndex = '100000';
    modalElement.style.display = 'block';
  });
  
  modalElement.addEventListener('shown.bs.modal', function () {
    
    // ë‹¤ë¥¸ ëª¨ë“  ëª¨ë‹¬ ë‹«ê¸°
    const otherModals = document.querySelectorAll('.modal:not(#scheduleDeliveryItemsModal)');
    otherModals.forEach(modal => {
      const modalInstance = bootstrap.Modal.getInstance(modal);
      if (modalInstance) {
        modalInstance.hide();
      }
    });
    
    // í˜ì´ì§€ ìš”ì†Œë“¤ ë’¤ë¡œ ë³´ë‚´ê¸° (ëª¨ë‹¬ ë‚´ë¶€ ìš”ì†ŒëŠ” ì œì™¸)
    const pageElements = document.querySelectorAll('.container, .card, form:not(#schedule-delivery-form)');
    pageElements.forEach(el => {
      // ëª¨ë‹¬ ë‚´ë¶€ ìš”ì†Œì¸ì§€ í™•ì¸
      if (!el.closest('#scheduleDeliveryItemsModal')) {
        el.style.position = 'relative';
        el.style.zIndex = '1';
      }
    });
    
    // ëª¨ë‹¬ ë‚´ë¶€ì˜ ëª¨ë“  delivery-itemì— position: relative ì„¤ì • (z-indexê°€ ì‘ë™í•˜ë„ë¡)
    const deliveryItems = modalElement.querySelectorAll('.delivery-item');
    deliveryItems.forEach(item => {
      item.style.position = 'relative';
    });
    
    // backdrop z-index ì¡°ì •
    const backdrops = document.querySelectorAll('.modal-backdrop');
    backdrops.forEach(backdrop => {
      backdrop.style.zIndex = '99999';
    });
    
    // ëª¨ë‹¬ dialogì™€ contentì˜ ìƒí˜¸ì‘ìš© ë³´ì¥
    const modalDialog = modalElement.querySelector('.modal-dialog');
    const modalContent = modalElement.querySelector('.modal-content');
    
    if (modalDialog) {
      modalDialog.style.position = 'relative';
      modalDialog.style.zIndex = '100001';
      modalDialog.style.pointerEvents = 'auto';
    }
    if (modalContent) {
      modalContent.style.position = 'relative';
      modalContent.style.zIndex = '100002';
      modalContent.style.pointerEvents = 'auto';
      
      // ëª¨ë‹¬ ë‚´ë¶€ì˜ ëª¨ë“  ì¸í„°ë™í‹°ë¸Œ ìš”ì†Œë“¤ì— pointer-events ì„¤ì •
      const interactiveElements = modalContent.querySelectorAll('input, select, textarea, button, a, .btn, .form-control');
      interactiveElements.forEach(el => {
        el.style.pointerEvents = 'auto';
      });
    }
    
    modalElement.style.pointerEvents = 'auto';
  });
  
  // ëª¨ë‹¬ ë‹«í ë•Œ ì›ë˜ëŒ€ë¡œ ë³µì›
  modalElement.addEventListener('hidden.bs.modal', function() {
    
    const pageElements = document.querySelectorAll('.container, .card, form:not(#schedule-delivery-form)');
    pageElements.forEach(el => {
      el.style.zIndex = '';
    });
  });

  // ê¸°ì¡´ ë°ì´í„°ê°€ ìˆë‹¤ë©´ ë¡œë“œ, ì—†ë‹¤ë©´ ê¸°ë³¸ í’ˆëª© í•˜ë‚˜ ì¶”ê°€
  loadExistingScheduleDeliveryItems() || addScheduleDeliveryItem();
}

function loadExistingScheduleDeliveryItems() {
  // 1ìˆœìœ„: scheduleDeliveryItemsData ë°°ì—´ (ê²¬ì ì—ì„œ ë¶ˆëŸ¬ì˜¨ ë°ì´í„°)
  if (scheduleDeliveryItemsData && scheduleDeliveryItemsData.length > 0) {
    scheduleDeliveryItemsData.forEach((item, index) => {
      addScheduleDeliveryItem({
        item_name: item.name || item.item_name,
        quantity: item.quantity,
        unit_price: item.unit_price
      });
    });
    return true;
  }
  
  // 2ìˆœìœ„: í…œí”Œë¦¿ ë³€ìˆ˜ì—ì„œ ë°ì´í„° í™•ì¸
  {% if delivery_text %}
    const deliveryText = `{{ delivery_text|escapejs }}`;
    
    const lines = deliveryText.split('\n');
    let hasData = false;
    
    lines.forEach(line => {
      if (line.trim()) {
        // "í’ˆëª©ëª…: ìˆ˜ëŸ‰ê°œ (ê¸ˆì•¡ì›)" í˜•íƒœ íŒŒì‹±
        const match = line.match(/^(.+?):\s*(\d+)ê°œ\s*\((.+?)ì›\)/);
        if (match) {
          const itemName = match[1].trim();
          const quantity = parseInt(match[2]);
          const totalPriceStr = match[3].replace(/,/g, '');
          const totalPrice = parseInt(totalPriceStr);
          
          // ë¶€ê°€ì„¸ í¬í•¨ ê¸ˆì•¡ì—ì„œ ë‹¨ê°€ ì—­ì‚° (ì´ì•¡ / 1.1 / ìˆ˜ëŸ‰)
          const unitPrice = Math.round(totalPrice / 1.1 / quantity);
          
          
          addScheduleDeliveryItem({
            item_name: itemName,
            quantity: quantity,
            unit_price: unitPrice
          });
          hasData = true;
        }
      }
    });
    
    if (hasData) {
      return true;
    }
  {% endif %}
  
  // 3ìˆœìœ„: í¼ í•„ë“œì—ì„œ ì‹œë„
  const deliveryItemsField = document.querySelector('[name="delivery_items"]');
  const deliveryAmountField = document.querySelector('[name="delivery_amount"]');
  
  if (deliveryItemsField && deliveryItemsField.value.trim()) {
    // ê¸°ì¡´ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš° íŒŒì‹±í•´ì„œ ë¡œë“œ
    const deliveryItemsText = deliveryItemsField.value.trim();
    
    const lines = deliveryItemsText.split('\n');
    let hasData = false;
    
    lines.forEach(line => {
      if (line.trim()) {
        // "í’ˆëª©ëª…: ìˆ˜ëŸ‰ê°œ (ê¸ˆì•¡ì›)" í˜•íƒœ íŒŒì‹±
        const match = line.match(/^(.+?):\s*(\d+)ê°œ\s*\((.+?)ì›\)/);
        if (match) {
          const itemName = match[1].trim();
          const quantity = parseInt(match[2]);
          const totalPriceStr = match[3].replace(/,/g, '');
          const totalPrice = parseInt(totalPriceStr);
          
          // ë¶€ê°€ì„¸ í¬í•¨ ê¸ˆì•¡ì—ì„œ ë‹¨ê°€ ì—­ì‚° (ì´ì•¡ / 1.1 / ìˆ˜ëŸ‰)
          const unitPrice = Math.round(totalPrice / 1.1 / quantity);
          
          
          addScheduleDeliveryItem({
            item_name: itemName,
            quantity: quantity,
            unit_price: unitPrice
          });
          hasData = true;
        }
      }
    });
    
    if (hasData) {
    }
    return hasData;
  }
  return false;
}

function addScheduleDeliveryItem(itemData = {}) {
  const container = document.getElementById('schedule-delivery-items-container');
  const newItem = document.createElement('div');
  newItem.className = 'delivery-item row mb-3 p-3 border rounded bg-light';
  newItem.style.position = 'relative'; // z-indexê°€ ì‘ë™í•˜ë„ë¡ position ì„¤ì •
  
  const itemName = itemData.item_name || '';
  const quantity = itemData.quantity || '';
  const unitPrice = itemData.unit_price || '';
  const productId = itemData.product_id || '';
  
  newItem.innerHTML = `
    <div class="col-md-4">
      <label class="form-label fw-bold">í’ˆëª©ëª… <span class="text-danger">*</span></label>
      <div class="input-group">
        <input type="text" class="form-control item-name" value="${itemName}" placeholder="ì œí’ˆì„ ì„ íƒí•˜ì„¸ìš”" readonly>
        <button class="btn btn-primary" type="button" onclick="openProductSearchModal(this)" title="í’ˆë²ˆìœ¼ë¡œ ê²€ìƒ‰">
          <i class="fas fa-search"></i>
        </button>
        <button class="btn btn-success" type="button" onclick="openDeliveryProductModal(this)" title="ìƒˆ ì œí’ˆ ì¶”ê°€">
          <i class="fas fa-plus"></i>
        </button>
      </div>
      <input type="hidden" class="product-id quote-product-id" value="${productId}">
    </div>
    <div class="col-md-2">
      <label class="form-label fw-bold">ìˆ˜ëŸ‰ <span class="text-danger">*</span></label>
      <input type="number" class="form-control quantity-input" min="1" value="${quantity}" placeholder="ìˆ˜ëŸ‰" required>
    </div>
    <div class="col-md-2">
      <label class="form-label fw-bold">ë‹¨ê°€ (ë¶€ê°€ì„¸ ë³„ë„)</label>
      <input type="text" class="form-control unit-price-display" 
             value="${unitPrice ? parseInt(unitPrice).toLocaleString() : ''}" 
             oninput="updateDeliveryUnitPrice(this)" placeholder="ë‹¨ê°€ ì…ë ¥">
      <input type="hidden" class="unit-price-input" value="${unitPrice}">
    </div>
    <div class="col-md-3">
      <label class="form-label fw-bold">ê¸ˆì•¡ (ë¶€ê°€ì„¸ í¬í•¨)</label>
      <div class="form-control-plaintext">
        <span class="item-total fw-bold text-primary">0ì›</span>
      </div>
    </div>
    <div class="col-md-1 d-flex align-items-end">
      <button type="button" class="btn btn-danger btn-sm w-100" onclick="removeScheduleDeliveryItem(this)" title="ì‚­ì œ">
        <i class="fas fa-trash"></i>
      </button>
    </div>
  `;
  
  container.appendChild(newItem);
  scheduleDeliveryItemIndex++;
  
  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
  const quantityInput = newItem.querySelector('.quantity-input');
  const unitPriceInput = newItem.querySelector('.unit-price-input');
  
  quantityInput.addEventListener('input', calculateScheduleItemTotal);
  unitPriceInput.addEventListener('input', calculateScheduleItemTotal);
  
  // ì´ˆê¸° ê³„ì‚°
  if (itemData.quantity && itemData.unit_price) {
    calculateScheduleItemTotal({ target: quantityInput });
  }
  
  // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
  newItem.style.opacity = '0';
  newItem.style.transform = 'translateY(-10px)';
  setTimeout(() => {
    newItem.style.transition = 'all 0.3s ease';
    newItem.style.opacity = '1';
    newItem.style.transform = 'translateY(0)';
  }, 10);
}

function removeScheduleDeliveryItem(button) {
  if (document.querySelectorAll('#schedule-delivery-items-container .delivery-item').length <= 1) {
    alert('ìµœì†Œ í•˜ë‚˜ì˜ í’ˆëª©ì€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.');
    return;
  }
  
  const item = button.closest('.delivery-item');
  item.style.transition = 'all 0.3s ease';
  item.style.opacity = '0';
  item.style.transform = 'translateY(-10px)';
  
  setTimeout(() => {
    item.remove();
    calculateScheduleTotal();
  }, 300);
}

function calculateScheduleItemTotal(event) {
  const item = event.target.closest('.delivery-item');
  const quantity = parseFloat(item.querySelector('.quantity-input').value) || 0;
  const unitPrice = parseFloat(item.querySelector('.unit-price-input').value) || 0;
  
  // ë¶€ê°€ì„¸ í¬í•¨ ê³„ì‚°: (ë‹¨ê°€ * ìˆ˜ëŸ‰) * 1.1
  const subtotal = quantity * unitPrice;
  const total = subtotal * 1.1;
  
  item.querySelector('.item-total').textContent = Math.round(total).toLocaleString() + 'ì›';
  calculateScheduleTotal();
}

function calculateScheduleTotal() {
  const items = document.querySelectorAll('#schedule-delivery-items-container .delivery-item');
  let subtotal = 0;
  
  items.forEach(item => {
    const quantity = parseFloat(item.querySelector('.quantity-input').value) || 0;
    const unitPrice = parseFloat(item.querySelector('.unit-price-input').value) || 0;
    subtotal += quantity * unitPrice;
  });
  
  const tax = subtotal * 0.1;
  const total = subtotal + tax;
  
  // í™”ë©´ ì—…ë°ì´íŠ¸
  document.getElementById('schedule-subtotal-amount').textContent = Math.round(subtotal).toLocaleString() + 'ì›';
  document.getElementById('schedule-tax-amount').textContent = Math.round(tax).toLocaleString() + 'ì›';
  document.getElementById('schedule-total-amount').textContent = Math.round(total).toLocaleString() + 'ì›';
  
  // ì„ ê²°ì œ ê³„ì‚° ìë™ ì—…ë°ì´íŠ¸
  if (typeof updatePrepaymentCalculation === 'function') {
    updatePrepaymentCalculation();
  }
}

function saveScheduleDeliveryItems() {
  const container = document.getElementById('schedule-delivery-items-container');
  
  // ì»¨í…Œì´ë„ˆê°€ ì—†ìœ¼ë©´ (ëª¨ë‹¬ì„ ì—´ì§€ ì•Šì€ ê²½ìš°) ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ
  if (!container) {
    return;
  }
  
  const items = document.querySelectorAll('#schedule-delivery-items-container .delivery-item');
  scheduleDeliveryItemsData = [];
  let itemsText = [];
  let totalAmount = 0;
  

  items.forEach((item, index) => {
    
    const itemNameElem = item.querySelector('.item-name');
    const quantityElem = item.querySelector('.quantity-input');
    const unitPriceElem = item.querySelector('.unit-price-input');
    const productIdElem = item.querySelector('.product-id');
    
    const itemName = itemNameElem ? itemNameElem.value.trim() : '';
    const quantity = quantityElem ? parseFloat(quantityElem.value) || 0 : 0;
    const unitPrice = unitPriceElem ? parseFloat(unitPriceElem.value) || 0 : 0;
    const productId = productIdElem ? productIdElem.value.trim() : '';
    
    
    if (itemName && quantity > 0) {
      const subtotal = quantity * unitPrice;
      const total = subtotal * 1.1;
      
      scheduleDeliveryItemsData.push({
        name: itemName,
        item_name: itemName,
        quantity: quantity,
        unit_price: unitPrice,
        total_price: total,
        product_id: productId
      });
      
      totalAmount += total;
      itemsText.push(`${itemName}: ${quantity}ê°œ (${Math.round(total).toLocaleString()}ì›)`);
    }
  });
  
  // ì»¨í…ìŠ¤íŠ¸ì— ë”°ë¼ ì ìš©í•  í•„ë“œ ì„ íƒ
  const context = currentItemsContext || 'delivery';
  
  if (context === 'delivery') {
    // ë‚©í’ˆ ëª¨ë“œ: ê¸°ì¡´ ë™ì‘ ìœ ì§€
    const deliveryItemsField = document.querySelector('[name="delivery_items"]');
    const deliveryAmountField = document.querySelector('[name="delivery_amount"]');
    const deliveryDisplayField = document.getElementById('schedule-delivery-items-display');
    const deliveryTotalField = document.getElementById('schedule-delivery-total-amount');
    
    if (deliveryItemsField) deliveryItemsField.value = itemsText.join('\n');
    if (deliveryAmountField) deliveryAmountField.value = Math.round(totalAmount);
    if (deliveryDisplayField) deliveryDisplayField.value = itemsText.join('\n');
    if (deliveryTotalField) deliveryTotalField.value = Math.round(totalAmount);
    
  } else if (context === 'quote') {
    // ê²¬ì  ëª¨ë“œ: ê²¬ì ìš© í•„ë“œì— ì €ì¥
    const quoteDisplayField = document.getElementById('quote-items-display');
    const quoteTotalField = document.getElementById('quote-total-amount');
    const quoteSummary = document.querySelector('.quote-items-summary');
    
    if (quoteDisplayField) quoteDisplayField.value = itemsText.join('\n');
    if (quoteTotalField) quoteTotalField.value = Math.round(totalAmount);
    if (quoteSummary) quoteSummary.textContent = `${scheduleDeliveryItemsData.length}ê°œ í’ˆëª©`;
      }
  
  // ëª¨ë‹¬ ë‹«ê¸°
  const modal = bootstrap.Modal.getInstance(document.getElementById('scheduleDeliveryItemsModal'));
  if (modal) {
    modal.hide();
  }
  
  // ì„±ê³µ ë©”ì‹œì§€
  if (scheduleDeliveryItemsData.length > 0) {
    const itemType = context === 'quote' ? 'ê²¬ì ' : 'ë‚©í’ˆ';
  }
}

// ë‚©í’ˆ í’ˆëª© ê°œìˆ˜ ì—…ë°ì´íŠ¸ (ê²¬ì ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸° í›„ í‘œì‹œ ê°±ì‹ )
function updateScheduleDeliveryItemCount() {
  if (!scheduleDeliveryItemsData || scheduleDeliveryItemsData.length === 0) {
    return;
  }
  
  // í’ˆëª© í…ìŠ¤íŠ¸ ìƒì„±
  let itemsText = [];
  let totalAmount = 0;
  
  scheduleDeliveryItemsData.forEach((item, index) => {
    const itemName = item.name || item.item_name || 'í’ˆëª©ëª… ì—†ìŒ';
    const subtotal = (item.quantity || 0) * (item.unit_price || 0);
    const total = subtotal * 1.1;
    totalAmount += total;
    itemsText.push(`${itemName}: ${item.quantity}ê°œ (${Math.round(total).toLocaleString()}ì›)`);
  });
  
  // í™”ë©´ í•„ë“œ ì—…ë°ì´íŠ¸
  const deliveryDisplayField = document.getElementById('schedule-delivery-items-display');
  const deliveryTotalField = document.getElementById('schedule-delivery-total-amount');
  
  if (deliveryDisplayField) {
    deliveryDisplayField.value = itemsText.join('\n');
  }
  
  if (deliveryTotalField) {
    deliveryTotalField.value = Math.round(totalAmount);
  }
  
  // ì„ ê²°ì œ ê³„ì‚° ì—…ë°ì´íŠ¸
  if (typeof updatePrepaymentCalculation === 'function') {
    updatePrepaymentCalculation();
  }
  
}

// ëª¨ë“  í’ˆëª© ì €ì¥ (ê²¬ì  + ë‚©í’ˆ)
function saveAllItems() {
  
  // ê¸°ì¡´ ìˆ¨ê²¨ì§„ í•„ë“œ ì œê±°
  const existingHiddenFields = document.querySelectorAll('input[name^="delivery_items["]');
  existingHiddenFields.forEach(field => field.remove());
  
  // ìŠ¤ì¼€ì¤„ form ì„ íƒ (ë¡œê·¸ì•„ì›ƒ formì´ ì•„ë‹Œ!)
  const form = Array.from(document.querySelectorAll('form[method="post"]')).find(f => f.action.includes('schedule'));
  if (!form) {
    console.error('ìŠ¤ì¼€ì¤„ formì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
    return;
  }
  
  let savedCount = 0;
  
  // 1. ë¨¼ì € scheduleDeliveryItemsData ë°°ì—´ì—ì„œ ì €ì¥ (ëª¨ë‹¬ì—ì„œ ì ìš©í•œ ë°ì´í„°)
  if (scheduleDeliveryItemsData && scheduleDeliveryItemsData.length > 0) {
    
    scheduleDeliveryItemsData.forEach((itemData, index) => {
      // í’ˆëª©ëª…
      const nameInput = document.createElement('input');
      nameInput.type = 'hidden';
      nameInput.name = `delivery_items[${index}][name]`;
      nameInput.value = itemData.name || itemData.item_name;  // name ìš°ì„ , item_name í´ë°±
      form.appendChild(nameInput);
      
      // ìˆ˜ëŸ‰
      const quantityInput = document.createElement('input');
      quantityInput.type = 'hidden';
      quantityInput.name = `delivery_items[${index}][quantity]`;
      quantityInput.value = itemData.quantity;
      form.appendChild(quantityInput);
      
      // ë‹¨ê°€
      const unitPriceInput = document.createElement('input');
      unitPriceInput.type = 'hidden';
      unitPriceInput.name = `delivery_items[${index}][unit_price]`;
      unitPriceInput.value = itemData.unit_price;
      form.appendChild(unitPriceInput);
      
      // ì œí’ˆ ID
      if (itemData.product_id) {
        const productIdInput = document.createElement('input');
        productIdInput.type = 'hidden';
        productIdInput.name = `delivery_items[${index}][product_id]`;
        productIdInput.value = itemData.product_id;
        form.appendChild(productIdInput);
      }
      
      savedCount++;
    });
  }
  // 2. scheduleDeliveryItemsDataê°€ ì—†ìœ¼ë©´ DOMì—ì„œ ì§ì ‘ ì½ê¸° (í´ë°±)
  else {
    const deliveryContainer = document.getElementById('schedule-delivery-items-container');
    if (deliveryContainer) {
      const deliveryItems = document.querySelectorAll('#schedule-delivery-items-container .delivery-item');
      deliveryItems.forEach((item, index) => {
        const itemName = item.querySelector('.item-name')?.value.trim();
        const quantity = parseFloat(item.querySelector('.quantity-input')?.value) || 0;
        const unitPrice = parseFloat(item.querySelector('.unit-price-input')?.value) || 0;
        const productId = item.querySelector('.product-id')?.value.trim();
        
        if (itemName && quantity > 0) {
          // í’ˆëª©ëª…
          const nameInput = document.createElement('input');
          nameInput.type = 'hidden';
          nameInput.name = `delivery_items[${index}][name]`;
          nameInput.value = itemName;
          form.appendChild(nameInput);
          
          // ìˆ˜ëŸ‰
          const quantityInput = document.createElement('input');
          quantityInput.type = 'hidden';
          quantityInput.name = `delivery_items[${index}][quantity]`;
          quantityInput.value = quantity;
          form.appendChild(quantityInput);
          
          // ë‹¨ê°€
          const unitPriceInput = document.createElement('input');
          unitPriceInput.type = 'hidden';
          unitPriceInput.name = `delivery_items[${index}][unit_price]`;
          unitPriceInput.value = unitPrice;
          form.appendChild(unitPriceInput);
          
          // ì œí’ˆ ID
          if (productId) {
            const productIdInput = document.createElement('input');
            productIdInput.type = 'hidden';
            productIdInput.name = `delivery_items[${index}][product_id]`;
            productIdInput.value = productId;
            form.appendChild(productIdInput);
          }
          
          savedCount++;
        }
      });
    }
  }
  
  // 3. í’ˆëª© ì €ì¥ (scheduleDeliveryItemsData ë°°ì—´ ì‚¬ìš© - ê²¬ì /ë‚©í’ˆ ê³µìš©)
  // ì´ë¯¸ ë‚©í’ˆ í’ˆëª©ì´ ìˆìœ¼ë©´ ê²¬ì  í’ˆëª©ì€ ì €ì¥í•˜ì§€ ì•ŠìŒ (savedCount > 0)
  if (scheduleDeliveryItemsData && scheduleDeliveryItemsData.length > 0 && savedCount === 0) {
    
    scheduleDeliveryItemsData.forEach((itemData, index) => {
      // í’ˆëª©ëª…
      const nameInput = document.createElement('input');
      nameInput.type = 'hidden';
      nameInput.name = `delivery_items[${index}][name]`;
      nameInput.value = itemData.name || itemData.item_name;
      form.appendChild(nameInput);
      
      // ìˆ˜ëŸ‰
      const quantityInput = document.createElement('input');
      quantityInput.type = 'hidden';
      quantityInput.name = `delivery_items[${index}][quantity]`;
      quantityInput.value = itemData.quantity;
      form.appendChild(quantityInput);
      
      // ë‹¨ê°€
      const unitPriceInput = document.createElement('input');
      unitPriceInput.type = 'hidden';
      unitPriceInput.name = `delivery_items[${index}][unit_price]`;
      unitPriceInput.value = itemData.unit_price;
      form.appendChild(unitPriceInput);
      
      // ì œí’ˆ ID
      if (itemData.product_id) {
        const productIdInput = document.createElement('input');
        productIdInput.type = 'hidden';
        productIdInput.name = `delivery_items[${index}][product_id]`;
        productIdInput.value = itemData.product_id;
        form.appendChild(productIdInput);
      }
      
      savedCount++;
    });
  }
  
  // 4. ê¸°ì¡´ ê²¬ì  í’ˆëª© ì €ì¥ ì‹œë„ (items-containerì—ì„œ ì…ë ¥í•œ ê²½ìš°, í´ë°± - í•˜ìœ„ í˜¸í™˜ì„±)
  const quoteContainer = document.getElementById('items-container');
  if (quoteContainer && savedCount === 0) {
    const quoteItems = document.querySelectorAll('#items-container .item-row');
    quoteItems.forEach((item, index) => {
      const itemNameInput = item.querySelector('.quote-item-name');
      const quantityInput = item.querySelector('input[name^="items"][name$="[quantity]"]');
      const unitPriceInput = item.querySelector('.unit-price-input');
      const productIdInput = item.querySelector('.quote-product-id');
      
      const itemName = itemNameInput?.value.trim();
      const quantity = parseFloat(quantityInput?.value) || 0;
      const unitPrice = parseFloat(unitPriceInput?.value) || 0;
      const productId = productIdInput?.value.trim();
      
      if (itemName && quantity > 0) {
        // í’ˆëª©ëª…
        const nameInput = document.createElement('input');
        nameInput.type = 'hidden';
        nameInput.name = `delivery_items[${index}][name]`;
        nameInput.value = itemName;
        form.appendChild(nameInput);
        
        // ìˆ˜ëŸ‰
        const quantityHidden = document.createElement('input');
        quantityHidden.type = 'hidden';
        quantityHidden.name = `delivery_items[${index}][quantity]`;
        quantityHidden.value = quantity;
        form.appendChild(quantityHidden);
        
        // ë‹¨ê°€
        const unitPriceHidden = document.createElement('input');
        unitPriceHidden.type = 'hidden';
        unitPriceHidden.name = `delivery_items[${index}][unit_price]`;
        unitPriceHidden.value = unitPrice;
        form.appendChild(unitPriceHidden);
        
        // ì œí’ˆ ID
        if (productId) {
          const productIdHidden = document.createElement('input');
          productIdHidden.type = 'hidden';
          productIdHidden.name = `delivery_items[${index}][product_id]`;
          productIdHidden.value = productId;
          form.appendChild(productIdHidden);
        }
        
        savedCount++;
      }
    });
  }
  
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ì¡´ ë‚©í’ˆ í’ˆëª© ë°ì´í„° í‘œì‹œ
document.addEventListener('DOMContentLoaded', function() {
    {% if schedule %}
    // ìˆ˜ì • ëª¨ë“œì—ì„œë§Œ ë‚©í’ˆ í’ˆëª© ë°ì´í„° ë¡œë“œ
    const deliveryItemsField = document.querySelector('[name="delivery_items"]');
    const deliveryAmountField = document.querySelector('[name="delivery_amount"]');
    const deliveryDisplayField = document.getElementById('schedule-delivery-items-display');
    const deliveryTotalField = document.getElementById('schedule-delivery-total-amount');
    const deliverySummary = document.querySelector('.schedule-delivery-items-summary');
    
    // ê¸°ì¡´ ë°ì´í„°ê°€ ìˆë‹¤ë©´ í‘œì‹œ (í…œí”Œë¦¿ ë³€ìˆ˜ ìš°ì„ )
    {% if delivery_text %}
        const deliveryText = `{{ delivery_text|escapejs }}`;
        const deliveryAmount = {{ delivery_amount|default:"0" }};
        
        
        if (deliveryDisplayField) {
            deliveryDisplayField.value = deliveryText;
        }
        
        if (deliveryTotalField) {
            deliveryTotalField.value = deliveryAmount;
        }
        
        // ìˆ¨ê²¨ì§„ í•„ë“œì—ë„ ê°’ ì„¤ì •
        if (deliveryItemsField) {
            deliveryItemsField.value = deliveryText;
        }
        if (deliveryAmountField) {
            deliveryAmountField.value = deliveryAmount;
        }
        
        if (deliverySummary && deliveryText) {
            const itemCount = deliveryText.split('\n').filter(line => line.trim()).length;
            deliverySummary.textContent = `ì´ ${itemCount}ê°œ í’ˆëª©, ${parseInt(deliveryAmount).toLocaleString()}ì› (ì½ê¸° ì „ìš©)`;
        }
    {% else %}
        // í…œí”Œë¦¿ ë³€ìˆ˜ê°€ ì—†ìœ¼ë©´ í¼ í•„ë“œì—ì„œ ì‹œë„
        if (deliveryItemsField && deliveryItemsField.value.trim()) {
            const itemsText = deliveryItemsField.value;
            const totalAmount = deliveryAmountField ? (deliveryAmountField.value || 0) : 0;
            
            if (deliveryDisplayField) {
                deliveryDisplayField.value = itemsText;
            }
            
            if (deliveryTotalField) {
                deliveryTotalField.value = totalAmount;
            }
            
            if (deliverySummary && itemsText) {
                const itemCount = itemsText.split('\\n').filter(line => line.trim()).length;
                deliverySummary.textContent = `ì´ ${itemCount}ê°œ í’ˆëª©, ${parseInt(totalAmount).toLocaleString()}ì› (ì½ê¸° ì „ìš©)`;
            }
        }
    {% endif %}
    {% endif %}
});

// ============================================
// ì œí’ˆ ì„ íƒ ê´€ë ¨ í•¨ìˆ˜ë“¤
// ============================================

// ì œí’ˆ ëª©ë¡ ë¡œë“œ (ë“œë¡­ë‹¤ìš´ ë°©ì‹)
function loadProductList(deliveryItem) {
  if (!deliveryItem) {
    console.error('deliveryItemì´ nullì…ë‹ˆë‹¤');
    return Promise.reject('deliveryItemì´ nullì…ë‹ˆë‹¤');
  }
  
  
  return fetch('/reporting/api/products/')
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      const products = data.products || [];
      
      // ì „ì²´ ì œí’ˆ ë°ì´í„°ë¥¼ deliveryItemì— ì €ì¥
      deliveryItem.dataset.allProducts = JSON.stringify(products);
      
      // ì œí’ˆ ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŒì„ ì•Œë¦¬ëŠ” ì´ë²¤íŠ¸ ë°œìƒ
      deliveryItem.dispatchEvent(new CustomEvent('productsLoaded', { 
        detail: { products: products } 
      }));
      
      return products;
    })
    .catch(error => {
      console.error('ì œí’ˆ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
      throw error;
    });
}

// ì œí’ˆ ê²€ìƒ‰ í•¨ìˆ˜
function searchProducts(searchInput) {
  console.log('ğŸ” searchProducts í•¨ìˆ˜ í˜¸ì¶œë¨');
  const deliveryItem = searchInput.closest('.delivery-item');
  const resultsDiv = deliveryItem.querySelector('.product-search-results');
  const searchQuery = searchInput.value.toLowerCase().trim();
  console.log('ë°°ì†¡ ê²€ìƒ‰ì–´:', searchQuery);
  const productIdInput = deliveryItem.querySelector('.product-id');
  const itemNameInput = deliveryItem.querySelector('.item-name');
  
  // ì „ì²´ ì œí’ˆ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
  const allProductsStr = deliveryItem.dataset.allProducts || '[]';
  
  try {
    const allProducts = JSON.parse(allProductsStr);
    
    // ì œí’ˆ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° - ì²˜ìŒ ê²€ìƒ‰í•  ë•Œë§Œ ë¡œë“œ
    if (allProducts.length === 0) {
      // ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ
      resultsDiv.innerHTML = '<div style="padding: 8px; color: #666;"><i class="fas fa-spinner fa-spin"></i> ì œí’ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
      resultsDiv.style.display = 'block';
      
      // ì œí’ˆ ë°ì´í„° ë¡œë“œ
      loadProductList(deliveryItem).then((products) => {
        // ë¡œë“œ ì™„ë£Œ í›„ ë‹¤ì‹œ ê²€ìƒ‰
        searchProducts(searchInput);
      }).catch(error => {
        resultsDiv.innerHTML = `<div style="padding: 8px; color: #dc2626; background: #fef2f2; border-radius: 4px;">
          <i class="fas fa-exclamation-triangle"></i> ì œí’ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message || error}
        </div>`;
        resultsDiv.style.display = 'block';
      });
      return;
    }
    
    console.log('ê²€ìƒ‰ ì‹œì‘, ì „ì²´ ì œí’ˆ:', allProducts.length, 'ê²€ìƒ‰ì–´:', searchQuery);
    
    const filteredProducts = allProducts.filter(product => {
      const codeMatch = product.product_code.toLowerCase().includes(searchQuery);
      const nameMatch = product.name && product.name.toLowerCase().includes(searchQuery);
      console.log('ì œí’ˆ:', product.product_code, 'code match:', codeMatch, 'name match:', nameMatch);
      return codeMatch || nameMatch;
    });
    
    console.log('í•„í„°ë§ ê²°ê³¼:', filteredProducts.length, 'ê°œ');
    
    // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
    resultsDiv.innerHTML = '';
    
    if (filteredProducts.length === 0) {
      console.log('ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ');
      resultsDiv.innerHTML = '<div style="padding: 8px; color: #999;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
      resultsDiv.style.display = 'block';
    } else {
      console.log('ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ:', filteredProducts.length, 'ê°œ');
      
      // ìµœëŒ€ 50ê°œê¹Œì§€ í‘œì‹œ (ìŠ¤í¬ë¡¤ ê°€ëŠ¥)
      const maxDisplay = 50;
      const displayProducts = filteredProducts.slice(0, maxDisplay);
      const hasMore = filteredProducts.length > maxDisplay;
      
      displayProducts.forEach((product, index) => {
        const resultItem = document.createElement('div');
        resultItem.style.cssText = 'padding: 8px; cursor: pointer; border-bottom: 1px solid #eee;';
        resultItem.textContent = `${product.product_code} - ${parseInt(product.current_price).toLocaleString()}ì›`;
        resultItem.dataset.productId = product.id;
        resultItem.dataset.productCode = product.product_code;
        resultItem.dataset.productPrice = product.current_price;
        
        // í˜¸ë²„ íš¨ê³¼
        resultItem.onmouseover = function() { this.style.background = '#f0f0f0'; };
        resultItem.onmouseout = function() { this.style.background = 'white'; };
        
        // í´ë¦­ ì´ë²¤íŠ¸
        resultItem.onclick = function() {
          productIdInput.value = this.dataset.productId;
          itemNameInput.value = this.dataset.productCode;
          searchInput.value = this.dataset.productCode;
          
          // ë‹¨ê°€ ì—…ë°ì´íŠ¸
          const unitPriceDisplay = deliveryItem.querySelector('.unit-price-display');
          const unitPriceInput = deliveryItem.querySelector('.unit-price-input');
          if (unitPriceDisplay && unitPriceInput) {
            unitPriceDisplay.value = parseInt(this.dataset.productPrice).toLocaleString();
            unitPriceInput.value = this.dataset.productPrice;
          }
          
          // ê²°ê³¼ ìˆ¨ê¹€
          resultsDiv.style.display = 'none';
          resultsDiv.innerHTML = '';
          
          // ê¸ˆì•¡ ê³„ì‚°
          const quantityInput = deliveryItem.querySelector('.quantity-input');
          if (quantityInput) {
            calculateScheduleDeliveryTotal({ target: quantityInput });
          }
        };
        
        resultsDiv.appendChild(resultItem);
      });
      
      // ë” ë§ì€ ì œí’ˆì´ ìˆìœ¼ë©´ ì•Œë¦¼ ì¶”ê°€
      if (hasMore) {
        const moreInfo = document.createElement('div');
        moreInfo.style.cssText = 'padding: 8px; color: #666; background: #f8f9fa; border-top: 2px solid #ddd; font-size: 12px; text-align: center; font-weight: 500;';
        moreInfo.innerHTML = `<i class="fas fa-info-circle me-1"></i> ${filteredProducts.length - maxDisplay}ê°œ ë” ìˆìŒ (ì´ ${filteredProducts.length}ê°œ) - ê²€ìƒ‰ì–´ë¥¼ ë” êµ¬ì²´ì ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”`;
        resultsDiv.appendChild(moreInfo);
      }
      
      // position: fixedë¡œ ë³€ê²½í–ˆìœ¼ë¯€ë¡œ ì •í™•í•œ ìœ„ì¹˜ ê³„ì‚° í•„ìš”
      const inputGroup = searchInput.closest('.input-group');
      const inputRect = inputGroup.getBoundingClientRect();
      resultsDiv.style.top = `${inputRect.bottom + 2}px`;
      resultsDiv.style.left = `${inputRect.left}px`;
      resultsDiv.style.width = `${inputRect.width}px`;
      
      resultsDiv.style.display = 'block';
      
      // ë¶€ëª¨ ìš”ì†Œë“¤ì˜ z-index í™•ì¸
      let parent = resultsDiv.parentElement;
      let level = 1;
      while (parent && level <= 5) {
        const computedStyle = window.getComputedStyle(parent);
        parent = parent.parentElement;
        level++;
      }
      
      // ì†Œê³„ ë°•ìŠ¤ì˜ z-index í™•ì¸
      const totalBox = document.querySelector('#schedule-total-amount');
      if (totalBox) {
        const totalCard = totalBox.closest('.card');
        if (totalCard) {
          const totalCardStyle = window.getComputedStyle(totalCard);
          
          // ì‹¤ì œ ë Œë”ë§ ìœ„ì¹˜ ë¹„êµ
          const dropdownRect = resultsDiv.getBoundingClientRect();
          const totalCardRect = totalCard.getBoundingClientRect();
        
          // stacking context í™•ì¸
          let dropdownContext = resultsDiv;
          let totalCardContext = totalCard;
          
          // ë“œë¡­ë‹¤ìš´ì˜ stacking context ì°¾ê¸°
          while (dropdownContext && dropdownContext !== document.body) {
            const style = window.getComputedStyle(dropdownContext);
            if (style.zIndex !== 'auto' && style.position !== 'static') {
              break;
            }
            dropdownContext = dropdownContext.parentElement;
          }
          
          // ì†Œê³„ ë°•ìŠ¤ì˜ stacking context ì°¾ê¸°
          while (totalCardContext && totalCardContext !== document.body) {
            const style = window.getComputedStyle(totalCardContext);
            if (style.zIndex !== 'auto' && style.position !== 'static') {
              break;
            }
            totalCardContext = totalCardContext.parentElement;
          }
        }
      }
    }
    
    
  } catch (error) {
    console.error('ëª¨ë‹¬ ì œí’ˆ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
    resultsDiv.innerHTML = `<div style="padding: 8px; color: #dc2626; background: #fef2f2; border-radius: 4px;">
      <i class="fas fa-exclamation-triangle"></i> ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}
    </div>`;
    resultsDiv.style.display = 'block';
  }
}

// í’ˆë²ˆ ê²€ìƒ‰ ëª¨ë‹¬ ì—´ê¸°
function openProductSearchModal(button) {
  const deliveryItem = button.closest('.delivery-item');
  
  // ì œí’ˆ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
  const allProductsStr = deliveryItem.dataset.allProducts || '[]';
  let allProducts = [];
  try {
    allProducts = JSON.parse(allProductsStr);
  } catch (e) {
    console.error('ì œí’ˆ ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨:', e);
  }
  
  // ì œí’ˆ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¨¼ì € ë¡œë“œ
  if (allProducts.length === 0) {
    // ë¡œë”© ëª¨ë‹¬ í‘œì‹œ
    const loadingModal = `
      <div class="modal fade" id="productSearchModal" tabindex="-1" style="z-index: 100200;">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">
                <i class="fas fa-search me-2"></i>í’ˆë²ˆìœ¼ë¡œ ì œí’ˆ ê²€ìƒ‰
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center p-5">
              <i class="fas fa-spinner fa-spin fa-3x mb-3"></i>
              <p>ì œí’ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
          </div>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', loadingModal);
    const loadingModalElement = document.getElementById('productSearchModal');
    const loadingModalInstance = new bootstrap.Modal(loadingModalElement);
    loadingModalInstance.show();
    
    // API í˜¸ì¶œí•˜ì—¬ ì œí’ˆ ë°ì´í„° ë¡œë“œ
    loadProductList(deliveryItem)
      .then((products) => {
        // ë¡œë”© ëª¨ë‹¬ ë‹«ê¸°
        loadingModalInstance.hide();
        loadingModalElement.remove();
        
        // ì œí’ˆì´ ì—†ëŠ” ê²½ìš°
        if (!products || products.length === 0) {
          alert('ë“±ë¡ëœ ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤.\nì œí’ˆ ê´€ë¦¬ ë©”ë‰´ì—ì„œ ë¨¼ì € ì œí’ˆì„ ë“±ë¡í•´ì£¼ì„¸ìš”.');
          return;
        }
        
        // ì œí’ˆ ê²€ìƒ‰ ëª¨ë‹¬ ë‹¤ì‹œ ì—´ê¸°
        setTimeout(() => openProductSearchModal(button), 300);
      })
      .catch(error => {
        console.error('ì œí’ˆ ë¡œë“œ ì‹¤íŒ¨:', error);
        loadingModalInstance.hide();
        loadingModalElement.remove();
        alert('ì œí’ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
      });
    return;
  }
  
  // ëª¨ë‹¬ HTML ìƒì„±
  const modalHtml = `
    <div class="modal fade" id="productSearchModal" tabindex="-1" style="z-index: 100200;">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-search me-2"></i>í’ˆë²ˆìœ¼ë¡œ ì œí’ˆ ê²€ìƒ‰
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <input type="text" class="form-control form-control-lg" id="productSearchInput" placeholder="í’ˆë²ˆì„ ì…ë ¥í•˜ê³  Enterë¥¼ ëˆ„ë¥´ì„¸ìš”..." autofocus>
              <small class="text-muted">í’ˆë²ˆì„ ì…ë ¥ í›„ Enterë¥¼ ëˆ„ë¥´ë©´ ê²€ìƒ‰ë©ë‹ˆë‹¤.</small>
            </div>
            <div id="productSearchResultsList" style="max-height: 400px; overflow-y: auto;">
              <!-- ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
  const existingModal = document.getElementById('productSearchModal');
  if (existingModal) {
    existingModal.remove();
  }
  
  // ìƒˆ ëª¨ë‹¬ ì¶”ê°€
  document.body.insertAdjacentHTML('beforeend', modalHtml);
  
  const modalElement = document.getElementById('productSearchModal');
  const searchInput = document.getElementById('productSearchInput');
  const resultsList = document.getElementById('productSearchResultsList');
  
  // ê²€ìƒ‰ í•¨ìˆ˜
  function performSearch() {
    const searchQuery = searchInput.value.toLowerCase().trim();
    
    // ê²€ìƒ‰ì–´ê°€ ì—†ìœ¼ë©´ ì•ˆë‚´ ë©”ì‹œì§€ë§Œ í‘œì‹œ
    if (!searchQuery) {
      resultsList.innerHTML = '<div class="text-center text-muted p-4">í’ˆë²ˆì„ ì…ë ¥í•˜ê³  Enterë¥¼ ëˆ„ë¥´ì„¸ìš”</div>';
      return;
    }
    
    // ë¡œë”© í‘œì‹œ
    resultsList.innerHTML = '<div class="text-center p-4"><i class="fas fa-spinner fa-spin"></i> ê²€ìƒ‰ ì¤‘...</div>';
    
    let filteredProducts = allProducts;
    if (searchQuery) {
      filteredProducts = allProducts.filter(p => {
        const codeMatch = p.product_code.toLowerCase().includes(searchQuery);
        const nameMatch = p.name && p.name.toLowerCase().includes(searchQuery);
        const descMatch = p.description && p.description.toLowerCase().includes(searchQuery);
        return codeMatch || nameMatch || descMatch;
      });
    }
        
    // ê²°ê³¼ í‘œì‹œ
    if (filteredProducts.length === 0) {
      console.log('ëª¨ë‹¬ ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ');
      resultsList.innerHTML = '<div class="text-center text-muted p-4">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
    } else {
      resultsList.innerHTML = filteredProducts.map(product => `
        <div class="border-bottom p-3 product-search-item" style="cursor: pointer;" 
             data-product-id="${product.id}"
             data-product-code="${product.product_code}"
             data-product-price="${product.current_price}"
             onmouseover="this.style.background='#f0f0f0'" 
             onmouseout="this.style.background='white'">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="fw-bold">${product.product_code}</div>
              <small class="text-muted">${product.description || ''}</small>
            </div>
            <div class="text-end">
              <div class="fw-bold text-primary">${parseInt(product.current_price).toLocaleString()}ì›</div>
              ${product.is_promo ? '<small class="badge bg-danger">í”„ë¡œëª¨ì…˜</small>' : ''}
            </div>
          </div>
        </div>
      `).join('');
      
      // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
      resultsList.querySelectorAll('.product-search-item').forEach(item => {
        item.onclick = function() {
          const productId = this.dataset.productId;
          const productCode = this.dataset.productCode;
          const productPrice = this.dataset.productPrice;
          
          // delivery-itemì— ì œí’ˆ ì •ë³´ ì…ë ¥
          deliveryItem.querySelector('.product-id').value = productId;
          deliveryItem.querySelector('.item-name').value = productCode;
          deliveryItem.querySelector('.unit-price-input').value = productPrice;
          deliveryItem.querySelector('.unit-price-display').value = parseInt(productPrice).toLocaleString();
          
          // ìˆ˜ëŸ‰ì´ ë¹„ì–´ìˆìœ¼ë©´ 1ë¡œ ì„¤ì •
          const quantityInput = deliveryItem.querySelector('.quantity-input');
          if (!quantityInput.value) {
            quantityInput.value = 1;
          }
          
          // ê¸ˆì•¡ ê³„ì‚° (ê°œë³„ í•­ëª© + ì „ì²´ í•©ê³„)
          calculateScheduleItemTotal({ target: quantityInput });
          
          // ëª¨ë‹¬ ë‹«ê¸°
          const modalInstance = bootstrap.Modal.getInstance(modalElement);
          if (modalInstance) {
            modalInstance.hide();
          }
        };
      });
    }
  }
  
  // Enter í‚¤ë¡œë§Œ ê²€ìƒ‰
  searchInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      performSearch();
    }
  });
  
  // ëª¨ë‹¬ í‘œì‹œ
  const modal = new bootstrap.Modal(modalElement);
  modal.show();
  
  // ëª¨ë‹¬ì´ ì™„ì „íˆ ì—´ë¦° í›„ í¬ì»¤ìŠ¤ë§Œ ì„¤ì •
  modalElement.addEventListener('shown.bs.modal', function() {
    searchInput.focus();
  }, { once: true });
  
  // ëª¨ë‹¬ ë‹«í ë•Œ ì œê±°
  modalElement.addEventListener('hidden.bs.modal', function() {
    modalElement.remove();
  }, { once: true });
}

// ê²€ìƒ‰ì–´ ì´ˆê¸°í™”
function clearProductSearch(button) {
  const deliveryItem = button.closest('.delivery-item');
  const searchInput = deliveryItem.querySelector('.product-search');
  searchInput.value = '';
  searchProducts(searchInput);
}

// ì œí’ˆ ì„ íƒ ì‹œ í˜¸ì¶œ
function onProductSelected(selectElement) {
  const selectedOption = selectElement.options[selectElement.selectedIndex];
  
  if (!selectedOption.value) {
    return;
  }
  
  const deliveryItem = selectElement.closest('.delivery-item');
  const productId = selectedOption.value;
  const productCode = selectedOption.dataset.code;
  const productPrice = selectedOption.dataset.price;
  
  // ì œí’ˆ ì •ë³´ ìë™ ì…ë ¥ (í’ˆë²ˆ ì‚¬ìš©)
  deliveryItem.querySelector('.product-id').value = productId;
  deliveryItem.querySelector('.item-name').value = productCode;
  deliveryItem.querySelector('.unit-price-input').value = productPrice;
  deliveryItem.querySelector('.unit-price-display').value = parseInt(productPrice).toLocaleString();
  
  // ìˆ˜ëŸ‰ì´ ë¹„ì–´ìˆìœ¼ë©´ 1ë¡œ ì„¤ì •
  const quantityInput = deliveryItem.querySelector('.quantity-input');
  if (!quantityInput.value) {
    quantityInput.value = 1;
  }
  
  // ê¸ˆì•¡ ì¬ê³„ì‚°
  calculateScheduleItemTotal({ target: quantityInput });
}

// ë‚©í’ˆ í’ˆëª©ì˜ ë‹¨ê°€ ì—…ë°ì´íŠ¸ (ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥)
function updateDeliveryUnitPrice(displayInput) {
  const deliveryItem = displayInput.closest('.delivery-item');
  
  // ì½¤ë§ˆ ì œê±°í•˜ê³  ìˆ«ìë§Œ ì¶”ì¶œ
  const rawValue = displayInput.value.replace(/[^\d]/g, '');
  const numericValue = rawValue ? parseInt(rawValue) : 0;
  
  // hidden inputì— ì‹¤ì œ ê°’ ì €ì¥
  deliveryItem.querySelector('.unit-price-input').value = numericValue;
  
  // í‘œì‹œìš© inputì— ì²œë‹¨ìœ„ ì½¤ë§ˆ ì ìš© (0ì›ë„ í‘œì‹œ)
  displayInput.value = numericValue.toLocaleString();
  
  // ê¸ˆì•¡ ì¬ê³„ì‚°
  const quantityInput = deliveryItem.querySelector('.quantity-input');
  calculateScheduleItemTotal({ target: quantityInput });
}

// ìƒˆ ì œí’ˆ ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸° (ë‚©í’ˆ í’ˆëª©ì—ì„œ)
let currentDeliveryItemRow = null;

function openDeliveryProductModal(button) {
  currentDeliveryItemRow = button.closest('.delivery-item');
  
  // ì œí’ˆ ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸°
  const productModal = new bootstrap.Modal(document.getElementById('productAddModal'));
  productModal.show();
}

// ============================================
// ê²¬ì  í’ˆëª©ìš© ì œí’ˆ ê²€ìƒ‰ ë° ì„ íƒ í•¨ìˆ˜
// ============================================

function loadQuoteProductList(itemRow) {
  return fetch('/reporting/api/products/')
    .then(response => {
      if (!response.ok) {
        if (response.status === 403 || response.status === 401) {
          throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
        }
        throw new Error(`API ìš”ì²­ ì‹¤íŒ¨: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      const products = data.products || [];
      
      if (products.length === 0) {
        console.warn('ë“±ë¡ëœ ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤.');
        // ê²€ìƒ‰ ì…ë ¥ í•„ë“œì— ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
        const searchInput = itemRow.querySelector('.quote-product-search');
        if (searchInput) {
          searchInput.placeholder = 'ë“±ë¡ëœ ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì œí’ˆì„ ë“±ë¡í•˜ì„¸ìš”.';
          searchInput.disabled = true;
        }
        throw new Error('ë“±ë¡ëœ ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤');
      }
      
      // ì „ì²´ ì œí’ˆ ë°ì´í„°ë¥¼ itemRowì— ì €ì¥
      itemRow.dataset.allProducts = JSON.stringify(products);
      
      // ê²€ìƒ‰ ì…ë ¥ í•„ë“œ í™œì„±í™”
      const searchInput = itemRow.querySelector('.quote-product-search');
      if (searchInput) {
        searchInput.disabled = false;
        searchInput.placeholder = 'í’ˆë²ˆìœ¼ë¡œ ê²€ìƒ‰...';
      }
      
      return products;
    })
    .catch(error => {
      console.error('ì œí’ˆ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
      // ì‚¬ìš©ìì—ê²Œ ì—ëŸ¬ ì•Œë¦¼
      const searchInput = itemRow.querySelector('.quote-product-search');
      if (searchInput) {
        searchInput.placeholder = 'ì œí’ˆ ë¡œë“œ ì‹¤íŒ¨: ' + error.message;
        searchInput.disabled = true;
      }
      
      // ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ê²€ìƒ‰ ê²°ê³¼ ì˜ì—­ì— í‘œì‹œ
      const resultsDiv = itemRow.querySelector('.quote-search-results');
      if (resultsDiv) {
        resultsDiv.innerHTML = `<div style="padding: 8px; color: #dc2626; background: #fef2f2; border-radius: 4px;">
          <i class="fas fa-exclamation-triangle"></i> ${error.message}
        </div>`;
        resultsDiv.style.display = 'block';
      }
      
      throw error;
    });
}

// ì œí’ˆ ê²€ìƒ‰ í•¨ìˆ˜ (ê²¬ì ìš©)
function searchQuoteProducts(searchInput) {
  console.log('ğŸ” searchQuoteProducts í•¨ìˆ˜ í˜¸ì¶œë¨');
  const itemRow = searchInput.closest('.item-row');
  const resultsDiv = itemRow.querySelector('.quote-search-results');
  const searchQuery = searchInput.value.toLowerCase().trim();
  console.log('ê²¬ì  ê²€ìƒ‰ì–´:', searchQuery);
  const productIdInput = itemRow.querySelector('.quote-product-id');
  const itemNameInput = itemRow.querySelector('.quote-item-name');
  
  // ì „ì²´ ì œí’ˆ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
  const allProductsStr = itemRow.dataset.allProducts || '[]';
  
  try {
    const allProducts = JSON.parse(allProductsStr);
    
    // ì œí’ˆ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° - ì²˜ìŒ ê²€ìƒ‰í•  ë•Œë§Œ ë¡œë“œ
    if (allProducts.length === 0) {
      // ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ
      resultsDiv.innerHTML = '<div style="padding: 8px; color: #666;"><i class="fas fa-spinner fa-spin"></i> ì œí’ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
      resultsDiv.style.display = 'block';
      
      // ì œí’ˆ ë°ì´í„° ë¡œë“œ
      loadQuoteProductList(itemRow).then((products) => {
        // ë¡œë“œ ì™„ë£Œ í›„ ë‹¤ì‹œ ê²€ìƒ‰
        searchQuoteProducts(searchInput);
      }).catch(error => {
        resultsDiv.innerHTML = `<div style="padding: 8px; color: #dc2626; background: #fef2f2; border-radius: 4px;">
          <i class="fas fa-exclamation-triangle"></i> ì œí’ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message || error}
        </div>`;
        resultsDiv.style.display = 'block';
      });
      return;
    }
    
    console.log('ê²¬ì  ê²€ìƒ‰ ì‹œì‘, ì „ì²´ ì œí’ˆ:', allProducts.length, 'ê²€ìƒ‰ì–´:', searchQuery);
    
    const filteredProducts = allProducts.filter(product => {
      const codeMatch = product.product_code.toLowerCase().includes(searchQuery);
      const nameMatch = product.name && product.name.toLowerCase().includes(searchQuery);
      console.log('ê²¬ì  ì œí’ˆ:', product.product_code, 'code match:', codeMatch, 'name match:', nameMatch);
      return codeMatch || nameMatch;
    });
    
    console.log('ê²¬ì  í•„í„°ë§ ê²°ê³¼:', filteredProducts.length, 'ê°œ');
    
    // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
    resultsDiv.innerHTML = '';

    
    if (filteredProducts.length === 0) {
      console.log('ê²¬ì  ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ');
      resultsDiv.innerHTML = '<div style="padding: 8px; color: #999;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
      resultsDiv.style.display = 'block';
    } else {
      console.log('ê²¬ì  ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ:', filteredProducts.length, 'ê°œ');
      
      // ìµœëŒ€ 50ê°œê¹Œì§€ í‘œì‹œ (ìŠ¤í¬ë¡¤ ê°€ëŠ¥)
      const maxDisplay = 50;
      const displayProducts = filteredProducts.slice(0, maxDisplay);
      const hasMore = filteredProducts.length > maxDisplay;
      
      displayProducts.forEach((product, index) => {
        const resultItem = document.createElement('div');
        resultItem.style.cssText = 'padding: 8px; cursor: pointer; border-bottom: 1px solid #eee;';
        resultItem.textContent = `${product.product_code} - ${parseInt(product.current_price).toLocaleString()}ì›`;
        resultItem.dataset.productId = product.id;
      resultItem.dataset.productCode = product.product_code;
      resultItem.dataset.productPrice = product.current_price;
      
      // í˜¸ë²„ íš¨ê³¼
      resultItem.onmouseover = function() { this.style.background = '#f0f0f0'; };
      resultItem.onmouseout = function() { this.style.background = 'white'; };
      
      // í´ë¦­ ì´ë²¤íŠ¸
      resultItem.onclick = function() {
        productIdInput.value = this.dataset.productId;
        itemNameInput.value = this.dataset.productCode;
        searchInput.value = this.dataset.productCode;
        
        // ë‹¨ê°€ ì—…ë°ì´íŠ¸
        const unitPriceDisplay = itemRow.querySelector('.quote-unit-price-display');
        const unitPriceInput = itemRow.querySelector('.unit-price-input');
        if (unitPriceDisplay && unitPriceInput) {
          unitPriceDisplay.value = parseInt(this.dataset.productPrice).toLocaleString();
          unitPriceInput.value = this.dataset.productPrice;
        }
        
        // ê²°ê³¼ ìˆ¨ê¹€
        resultsDiv.style.display = 'none';
        resultsDiv.innerHTML = '';
        
        // ê¸ˆì•¡ ê³„ì‚°
        const quantityInput = itemRow.querySelector('.quantity-input');
        if (quantityInput) {
          calculateItemTotal({ target: quantityInput });
        }
      };
      
      resultsDiv.appendChild(resultItem);
    });
    
    // ë” ë§ì€ ì œí’ˆì´ ìˆìœ¼ë©´ ì•Œë¦¼ ì¶”ê°€
    if (hasMore) {
      const moreInfo = document.createElement('div');
      moreInfo.style.cssText = 'padding: 8px; color: #666; background: #f8f9fa; border-top: 2px solid #ddd; font-size: 12px; text-align: center; font-weight: 500;';
      moreInfo.innerHTML = `<i class="fas fa-info-circle me-1"></i> ${filteredProducts.length - maxDisplay}ê°œ ë” ìˆìŒ (ì´ ${filteredProducts.length}ê°œ) - ê²€ìƒ‰ì–´ë¥¼ ë” êµ¬ì²´ì ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”`;
      resultsDiv.appendChild(moreInfo);
    }
    
    resultsDiv.style.display = 'block';
  }
  
  
  } catch (error) {
    console.error('ì œí’ˆ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
    resultsDiv.innerHTML = `<div style="padding: 8px; color: #dc2626; background: #fef2f2; border-radius: 4px;">
      <i class="fas fa-exclamation-triangle"></i> ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}
    </div>`;
    resultsDiv.style.display = 'block';
  }
}

// ê²€ìƒ‰ì–´ ì´ˆê¸°í™” (ê²¬ì ìš©)
function clearQuoteProductSearch(button) {
  const itemRow = button.closest('.item-row');
  const searchInput = itemRow.querySelector('.quote-product-search');
  const resultsDiv = itemRow.querySelector('.quote-search-results');
  searchInput.value = '';
  resultsDiv.style.display = 'none';
  resultsDiv.innerHTML = '';
}

// ì œí’ˆ ì„ íƒ ì‹œ í˜¸ì¶œ (ê²¬ì ìš©)
function onQuoteProductSelected(selectElement) {
  const selectedOption = selectElement.options[selectElement.selectedIndex];
  
  if (!selectedOption.value) {
    return;
  }
  
  const itemRow = selectElement.closest('.item-row');
  const productId = selectedOption.value;
  const productCode = selectedOption.dataset.code;
  const productPrice = selectedOption.dataset.price;
  
  // ì œí’ˆ ì •ë³´ ìë™ ì…ë ¥ (í’ˆë²ˆ ì‚¬ìš©)
  itemRow.querySelector('.quote-product-id').value = productId;
  itemRow.querySelector('.quote-item-name').value = productCode;
  itemRow.querySelector('.unit-price-input').value = productPrice;
  itemRow.querySelector('.quote-unit-price-display').value = parseInt(productPrice).toLocaleString();
  
  // ìˆ˜ëŸ‰ì´ ë¹„ì–´ìˆìœ¼ë©´ 1ë¡œ ì„¤ì •
  const quantityInput = itemRow.querySelector('.quantity-input');
  if (!quantityInput.value) {
    quantityInput.value = 1;
  }
  
  // ê¸ˆì•¡ ì¬ê³„ì‚°
  calculateItemTotal({ target: quantityInput });
}

// ê²¬ì  í’ˆëª©ì˜ ë‹¨ê°€ ì—…ë°ì´íŠ¸ (ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥)
function updateQuoteUnitPrice(displayInput) {
  const itemRow = displayInput.closest('.item-row');
  
  // ì½¤ë§ˆ ì œê±°í•˜ê³  ìˆ«ìë§Œ ì¶”ì¶œ
  const rawValue = displayInput.value.replace(/[^\d]/g, '');
  const numericValue = rawValue ? parseInt(rawValue) : 0;
  
  // hidden inputì— ì‹¤ì œ ê°’ ì €ì¥
  itemRow.querySelector('.unit-price-input').value = numericValue;
  
  // í‘œì‹œìš© inputì— ì²œë‹¨ìœ„ ì½¤ë§ˆ ì ìš© (0ì›ë„ í‘œì‹œ)
  displayInput.value = numericValue.toLocaleString();
  
  // ê¸ˆì•¡ ì¬ê³„ì‚°
  const quantityInput = itemRow.querySelector('.quantity-input');
  calculateItemTotal({ target: quantityInput });
}

// ìƒˆ ì œí’ˆ ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸° (ê²¬ì  í’ˆëª©ì—ì„œ)
let currentQuoteItemRow = null;

function openQuoteProductModal(button) {
  currentQuoteItemRow = button.closest('.item-row');
  
  // ì œí’ˆ ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸°
  const productModal = new bootstrap.Modal(document.getElementById('productAddModal'));
  productModal.show();
}

</script>

<script>
// ì œí’ˆ ì¶”ê°€ ëª¨ë‹¬ ì²˜ë¦¬
document.addEventListener('DOMContentLoaded', function() {
  const productAddModal = document.getElementById('productAddModal');
  const productAddForm = document.getElementById('productAddForm');
  
  if (productAddModal && productAddForm) {
    // ëª¨ë‹¬ ì—´ë¦´ ë•Œ
    productAddModal.addEventListener('show.bs.modal', function(e) {
      
      if (productAddModal.parentElement !== document.body) {
        document.body.appendChild(productAddModal);
      }
      
      productAddModal.style.zIndex = '100200';
      productAddModal.style.display = 'block';
      
      // í¼ ì´ˆê¸°í™”
      productAddForm.reset();
    });
    
    // ëª¨ë‹¬ ì™„ì „íˆ ì—´ë¦° í›„
    productAddModal.addEventListener('shown.bs.modal', function() {
      // í˜ì´ì§€ ìš”ì†Œë“¤ ë’¤ë¡œ ë³´ë‚´ê¸°
      const pageElements = document.querySelectorAll('.container, .card, form:not(#productAddForm)');
      pageElements.forEach(el => {
        el.style.position = 'relative';
        el.style.zIndex = '1';
      });
      
      // backdrop z-index ì¡°ì •
      const backdrops = document.querySelectorAll('.modal-backdrop');
      backdrops.forEach(backdrop => {
        backdrop.style.zIndex = '100199';
      });
      
      // ëª¨ë‹¬ ìš”ì†Œë“¤ ìƒí˜¸ì‘ìš© ë³´ì¥
      const modalDialog = productAddModal.querySelector('.modal-dialog');
      const modalContent = productAddModal.querySelector('.modal-content');
      
      if (modalDialog) {
        modalDialog.style.position = 'relative';
        modalDialog.style.zIndex = '100201';
        modalDialog.style.pointerEvents = 'auto';
      }
      if (modalContent) {
        modalContent.style.position = 'relative';
        modalContent.style.zIndex = '100202';
        modalContent.style.pointerEvents = 'auto';
        
        const interactiveElements = modalContent.querySelectorAll('input, select, textarea, button');
        interactiveElements.forEach(el => {
          el.style.pointerEvents = 'auto';
        });
      }
      
      productAddModal.style.pointerEvents = 'auto';
    });
    
    // ëª¨ë‹¬ ë‹«í ë•Œ
    productAddModal.addEventListener('hidden.bs.modal', function() {
      const pageElements = document.querySelectorAll('.container, .card, form:not(#productAddForm)');
      pageElements.forEach(el => {
        el.style.zIndex = '';
      });
    });
    
    // í¼ ì œì¶œ
    productAddForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = new FormData(productAddForm);
      
      fetch('/reporting/products/create/', {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // ì„±ê³µ ë©”ì‹œì§€
          alert('ì œí’ˆì´ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
          
          // ì œí’ˆ í¼ ì´ˆê¸°í™” (ë‹¤ìŒ ì¶”ê°€ë¥¼ ìœ„í•´)
          productAddForm.reset();
          
          // ëª¨ë‹¬ ë‹«ê¸°
          const modal = bootstrap.Modal.getInstance(productAddModal);
          modal.hide();
          
          // ìƒˆë¡œ ì¶”ê°€ëœ ì œí’ˆ ì •ë³´
          const newProduct = data.product;
          
          // ì œí’ˆ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ ë° ìë™ ì„ íƒ
          if (currentDeliveryItemRow) {
            // ë‚©í’ˆ í’ˆëª©ì— ìƒˆ ì œí’ˆ ìë™ ì…ë ¥
            const productIdInput = currentDeliveryItemRow.querySelector('.product-id');
            const productNameInput = currentDeliveryItemRow.querySelector('.item-name');
            const unitPriceDisplay = currentDeliveryItemRow.querySelector('.unit-price-display');
            const unitPriceInput = currentDeliveryItemRow.querySelector('.unit-price-input');
            
            if (productIdInput) productIdInput.value = newProduct.id;
            if (productNameInput) productNameInput.value = newProduct.name;
            if (unitPriceDisplay) unitPriceDisplay.value = newProduct.unit_price ? Number(newProduct.unit_price).toLocaleString() : '';
            if (unitPriceInput) unitPriceInput.value = newProduct.unit_price || '';
            
            // ì œí’ˆ ê²€ìƒ‰ì°½ ì´ˆê¸°í™”
            const searchInput = currentDeliveryItemRow.querySelector('.delivery-product-search');
            if (searchInput) searchInput.value = '';
            
            currentDeliveryItemRow = null;
          }
          if (currentQuoteItemRow) {
            // ê²¬ì  í’ˆëª©ì— ìƒˆ ì œí’ˆ ìë™ ì…ë ¥
            const productIdInput = currentQuoteItemRow.querySelector('.quote-product-id');
            const productNameInput = currentQuoteItemRow.querySelector('.quote-item-name');
            const unitPriceDisplay = currentQuoteItemRow.querySelector('.quote-unit-price-display');
            const unitPriceInput = currentQuoteItemRow.querySelector('.quote-unit-price');
            
            if (productIdInput) productIdInput.value = newProduct.id;
            if (productNameInput) productNameInput.value = newProduct.name;
            if (unitPriceDisplay) unitPriceDisplay.value = newProduct.unit_price ? Number(newProduct.unit_price).toLocaleString() : '';
            if (unitPriceInput) unitPriceInput.value = newProduct.unit_price || '';
            
            // ì œí’ˆ ê²€ìƒ‰ì°½ ì´ˆê¸°í™”
            const searchInput = currentQuoteItemRow.querySelector('.quote-product-search');
            if (searchInput) searchInput.value = '';
            
            // ëª¨ë“  ê²¬ì  í’ˆëª© í–‰ì˜ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (ë‹¤ë¥¸ í–‰ë“¤ì„ ìœ„í•´)
            document.querySelectorAll('.item-row').forEach(row => {
              if (row !== currentQuoteItemRow) {
                loadQuoteProductList(row);
              }
            });
            currentQuoteItemRow = null;
          }
        } else {
          // ì˜¤ë¥˜ ë©”ì‹œì§€
          alert('ì œí’ˆ ì¶”ê°€ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('ì œí’ˆ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      });
    });
  }
});
</script>

<!-- ìë™ì™„ì„±ì„ ìœ„í•œ CSS ìŠ¤íƒ€ì¼ -->
<style>
.autocomplete-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background-color: var(--surface);
    border: 1px solid var(--border);
    border-top: none;
    max-height: 200px;
    overflow-y: auto;
    z-index: 100060;
    box-shadow: var(--shadow-lg);
}

#followupModal .autocomplete-suggestions {
    z-index: 100060;
}

.autocomplete-suggestion {
    padding: 10px;
    cursor: pointer;
    border-bottom: 1px solid var(--border);
    font-size: 14px;
    color: var(--text-primary);
    background: var(--surface);
}

.autocomplete-suggestion:hover {
    background-color: var(--surface-hover);
    color: var(--text-primary);
}

.autocomplete-suggestion:last-child {
    border-bottom: none;
}

.modal .form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

/* ëª¨ë‹¬ì´ ì—´ë ¤ìˆì„ ë•Œ í˜ì´ì§€ ì•Œë¦¼ ìˆ¨ê¸°ê¸° */
body.modal-open .alert:not(#modalAlertContainer .alert):not(#toastContainer .alert) {
    opacity: 0.3;
    pointer-events: none;
}
</style>

<!-- ì œí’ˆ ì¶”ê°€ ëª¨ë‹¬ -->
<div class="modal fade" id="productAddModal" tabindex="-1" aria-labelledby="productAddModalLabel" aria-hidden="true" style="z-index: 100200;" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="productAddModalLabel">
          <i class="fas fa-plus-circle me-2"></i>ì œí’ˆ ì¶”ê°€
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="productAddForm">
        {% csrf_token %}
        <div class="modal-body">
          <div class="mb-3">
            <label for="product_code" class="form-label fw-bold">í’ˆë²ˆ <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="product_code" name="product_code" required>
          </div>
          <div class="mb-3">
            <label for="standard_price" class="form-label fw-bold">í‘œì¤€ë‹¨ê°€ <span class="text-danger">*</span></label>
            <input type="number" class="form-control" id="standard_price" name="standard_price" step="0.01" required>
          </div>
          <div class="mb-3">
            <label for="description" class="form-label fw-bold">ì œí’ˆì„¤ëª…</label>
            <textarea class="form-control" id="description" name="description" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-success">
            <i class="fas fa-save me-1"></i>ì €ì¥
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// ë‚ ì§œ ë° ì‹œê°„ ì…ë ¥ í•„ë“œ íƒ€ì… ì„¤ì •
document.addEventListener('DOMContentLoaded', function() {
    // ë°©ë¬¸ ë‚ ì§œ í•„ë“œì— date íƒ€ì… ì ìš©
    const visitDateField = document.querySelector('[name="visit_date"]');
    if (visitDateField) {
        visitDateField.setAttribute('type', 'date');
    }

    // ë°©ë¬¸ ì‹œê°„ í•„ë“œì— time íƒ€ì… ì ìš©
    const visitTimeField = document.querySelector('[name="visit_time"]');
    if (visitTimeField) {
        visitTimeField.setAttribute('type', 'time');
        
        // ìƒˆ ì¼ì • ìƒì„± ì‹œ í˜„ì¬ í•œêµ­ ì‹œê°„ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
        // ê¸°ì¡´ ê°’ì´ ë¹„ì–´ìˆì„ ë•Œë§Œ ì„¤ì • (ìˆ˜ì • ì‹œì—ëŠ” ê¸°ì¡´ ê°’ ìœ ì§€)
        if (!visitTimeField.value) {
            const now = new Date();
            // í•œêµ­ ì‹œê°„(KST, UTC+9)ìœ¼ë¡œ ë³€í™˜
            const koreaTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Seoul' }));
            const hours = String(koreaTime.getHours()).padStart(2, '0');
            const minutes = String(koreaTime.getMinutes()).padStart(2, '0');
            visitTimeField.value = `${hours}:${minutes}`;
        }
    }
});

// ë“œë¡­ë‹¤ìš´ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
document.addEventListener('click', function(e) {
  // ì œí’ˆ ê²€ìƒ‰ ê²°ê³¼ ë“œë¡­ë‹¤ìš´ë“¤ì„ ëª¨ë‘ ì°¾ì•„ì„œ ë‹«ê¸°
  const allDropdowns = document.querySelectorAll('.product-search-results, .quote-search-results');
  
  allDropdowns.forEach(dropdown => {
    // í´ë¦­ëœ ìš”ì†Œê°€ ë“œë¡­ë‹¤ìš´ ë‚´ë¶€ë‚˜ ê²€ìƒ‰ ì…ë ¥ì°½ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ë‹«ê¸°
    const searchInput = dropdown.parentElement.querySelector('input[type="text"]');
    const isClickInsideDropdown = dropdown.contains(e.target);
    const isClickOnSearchInput = searchInput && searchInput.contains(e.target);
    
    if (!isClickInsideDropdown && !isClickOnSearchInput) {
      dropdown.style.display = 'none';
      dropdown.innerHTML = '';
    }
  });
});

// ê²€ìƒ‰ì°½ì—ì„œ Escape í‚¤ ëˆ„ë¥¼ ë•Œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    const allDropdowns = document.querySelectorAll('.product-search-results, .quote-search-results');
    allDropdowns.forEach(dropdown => {
      dropdown.style.display = 'none';
      dropdown.innerHTML = '';
    });
  }
});
</script>

{% endblock %}
