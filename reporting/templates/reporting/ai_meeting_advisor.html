{% extends 'reporting/base.html' %}
{% load static %}

{% block title %}AI ë¯¸íŒ… ì¤€ë¹„{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row mb-4">
    <div class="col-12">
      <h2 class="mb-3">
        <i class="fas fa-brain text-primary me-2"></i>AI ë¯¸íŒ… ì „ëµ ì¶”ì²œ
      </h2>
      <p class="text-muted">ë‹¤ê°€ì˜¤ëŠ” ì¼ì •ì„ ì„ íƒí•˜ë©´ AIê°€ ê³ ê° ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ ì „ëµì„ ì¶”ì²œí•©ë‹ˆë‹¤.</p>
    </div>
  </div>

  <div class="row">
    <!-- ì™¼ìª½: ë‹¤ê°€ì˜¤ëŠ” ì¼ì • ëª©ë¡ -->
    <div class="col-md-4 mb-4">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="fas fa-calendar-alt me-2"></i>ë‹¤ê°€ì˜¤ëŠ” ì¼ì •
          </h5>
        </div>
        <div class="card-body p-0">
          <div class="list-group list-group-flush" id="upcoming-schedules">
            <div class="text-center py-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">ë¡œë”© ì¤‘...</span>
              </div>
              <p class="mt-3 text-muted">ì¼ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ì˜¤ë¥¸ìª½: AI ì¡°ì–¸ ì˜ì—­ -->
    <div class="col-md-8">
      <!-- ì„ íƒëœ ì¼ì • ì •ë³´ -->
      <div id="schedule-info" class="card shadow-sm mb-4" style="display: none;">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">
            <i class="fas fa-info-circle me-2"></i>ì„ íƒëœ ì¼ì • ì •ë³´
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <p class="mb-2"><strong>ê³ ê°ëª…:</strong> <span id="customer-name"></span></p>
              <p class="mb-2"><strong>íšŒì‚¬:</strong> <span id="company-name"></span></p>
              <p class="mb-0"><strong>ì¼ì • ìœ í˜•:</strong> <span id="schedule-type"></span></p>
            </div>
            <div class="col-md-6">
              <p class="mb-2"><strong>ë‚ ì§œ:</strong> <span id="schedule-date"></span></p>
              <p class="mb-2"><strong>ì‹œê°„:</strong> <span id="schedule-time"></span></p>
              <p class="mb-0"><strong>ì¥ì†Œ:</strong> <span id="schedule-location"></span></p>
            </div>
          </div>
          <div class="mt-3">
            <strong>ë©”ëª¨:</strong>
            <p class="mb-0 text-muted" id="schedule-notes"></p>
          </div>
        </div>
      </div>

      <!-- ë¯¸íŒ… ì „ëµ ì¶”ì²œ ë²„íŠ¼ -->
      <div id="strategy-button-area" class="card shadow-sm mb-4" style="display: none;">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">
            <i class="fas fa-lightbulb me-2"></i>AI ì „ëµ ì¶”ì²œ
          </h5>
        </div>
        <div class="card-body text-center">
          <p class="mb-3">ê³ ê°ì˜ êµ¬ë§¤ ì´ë ¥, ê²¬ì  ì „í™˜ìœ¨, íˆìŠ¤í† ë¦¬ë¥¼ ë¶„ì„í•˜ì—¬ ì‹¤ì „ ì „ëµì„ ì œì‹œí•©ë‹ˆë‹¤.</p>
          <button type="button" class="btn btn-success btn-lg" id="get-strategy-btn">
            <i class="fas fa-brain me-2"></i>ë¯¸íŒ… ì „ëµ ì¶”ì²œ ë°›ê¸°
          </button>
        </div>
      </div>

      <!-- AI ì‘ë‹µ -->
      <div id="ai-response-area" class="card shadow-sm" style="display: none;">
        <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
          <h5 class="mb-0">
            <i class="fas fa-robot me-2"></i>AI ë¯¸íŒ… ì „ëµ
          </h5>
        </div>
        <div class="card-body">
          <div id="ai-response-content"></div>
        </div>
      </div>

      <!-- ì´ˆê¸° ì•ˆë‚´ ë©”ì‹œì§€ -->
      <div id="initial-message" class="card shadow-sm border-0">
        <div class="card-body text-center py-5">
          <i class="fas fa-arrow-left fa-3x text-muted mb-3"></i>
          <h5 class="text-muted">ì™¼ìª½ì—ì„œ ì¼ì •ì„ ì„ íƒí•´ì£¼ì„¸ìš”</h5>
          <p class="text-muted mb-0">AIê°€ ì„ íƒí•œ ë¯¸íŒ…ì— ëŒ€í•œ ì „ë¬¸ì ì¸ ì¡°ì–¸ì„ ì œê³µí•©ë‹ˆë‹¤.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.schedule-item {
  cursor: pointer;
  transition: all 0.3s ease;
  border-left: 4px solid transparent !important;
}

.schedule-item:hover {
  background-color: #f8f9fa !important;
  border-left-color: #0d6efd !important;
}

.schedule-item.active {
  background-color: #e7f1ff !important;
  border-left-color: #0d6efd !important;
}

/* ì¼ì • ëª©ë¡ í…ìŠ¤íŠ¸ ìƒ‰ìƒ ëª…ì‹œ */
.schedule-item h6,
.schedule-item small,
.schedule-item .text-muted {
  color: #212529 !important;
}

.schedule-item.active h6,
.schedule-item.active small {
  color: #212529 !important;
}

.schedule-item .badge {
  font-size: 0.75rem;
}

#ai-response-content {
  line-height: 1.8;
  font-size: 1.05rem;
}

#ai-response-content h4 {
  color: #667eea;
  margin-top: 1.5rem;
  margin-bottom: 1rem;
  font-weight: 600;
}

#ai-response-content ul {
  padding-left: 1.5rem;
}

#ai-response-content li {
  margin-bottom: 0.75rem;
}

#ai-response-content strong {
  color: #764ba2;
}

.spinner-border-sm {
  width: 1rem;
  height: 1rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  let selectedScheduleId = null;
  let upcomingSchedules = []; // ì „ì—­ ë³€ìˆ˜ë¡œ ì¼ì • ëª©ë¡ ì €ì¥

  // ë‹¤ê°€ì˜¤ëŠ” ì¼ì • ë¶ˆëŸ¬ì˜¤ê¸°
  loadUpcomingSchedules();

  function loadUpcomingSchedules() {
    fetch('/reporting/ai/upcoming-schedules/', {
      method: 'GET',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success && data.schedules) {
        upcomingSchedules = data.schedules; // ì¼ì • ëª©ë¡ ì €ì¥
        displaySchedules(data.schedules);
      } else {
        document.getElementById('upcoming-schedules').innerHTML = `
          <div class="text-center py-5">
            <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
            <p class="text-muted">ë‹¤ê°€ì˜¤ëŠ” ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>
          </div>
        `;
      }
    })
    .catch(error => {
      console.error('Error:', error);
      document.getElementById('upcoming-schedules').innerHTML = `
        <div class="text-center py-5 text-danger">
          <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
          <p>ì¼ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
        </div>
      `;
    });
  }

  function displaySchedules(schedules) {
    const container = document.getElementById('upcoming-schedules');
    
    if (schedules.length === 0) {
      container.innerHTML = `
        <div class="text-center py-5">
          <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
          <p class="text-muted">ë‹¤ê°€ì˜¤ëŠ” ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
      `;
      return;
    }

    let html = '';
    schedules.forEach(schedule => {
      const typeColors = {
        'customer_meeting': 'primary',
        'quote': 'success',
        'delivery': 'danger'
      };
      const typeNames = {
        'customer_meeting': 'ê³ ê° ë¯¸íŒ…',
        'quote': 'ê²¬ì ',
        'delivery': 'ë‚©í’ˆ'
      };
      
      html += `
        <a href="#" class="list-group-item list-group-item-action schedule-item" data-schedule-id="${schedule.id}">
          <div class="d-flex w-100 justify-content-between align-items-start">
            <div>
              <h6 class="mb-1">${schedule.customer_name}</h6>
              <small class="text-muted">${schedule.company}</small>
            </div>
            <span class="badge bg-${typeColors[schedule.activity_type]}">${typeNames[schedule.activity_type]}</span>
          </div>
          <div class="mt-2">
            <small><i class="fas fa-calendar me-1"></i>${schedule.visit_date}</small>
            ${schedule.visit_time ? `<small class="ms-2"><i class="fas fa-clock me-1"></i>${schedule.visit_time}</small>` : ''}
          </div>
        </a>
      `;
    });

    container.innerHTML = html;

    // ì¼ì • í´ë¦­ ì´ë²¤íŠ¸
    document.querySelectorAll('.schedule-item').forEach(item => {
      item.addEventListener('click', function(e) {
        e.preventDefault();
        const scheduleId = this.dataset.scheduleId;
        selectSchedule(scheduleId);
      });
    });
  }

  function selectSchedule(scheduleId) {
    // ì„ íƒ í‘œì‹œ
    document.querySelectorAll('.schedule-item').forEach(item => {
      item.classList.remove('active');
    });
    document.querySelector(`[data-schedule-id="${scheduleId}"]`).classList.add('active');

    selectedScheduleId = scheduleId;

    // ì¼ì • ìƒì„¸ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
    fetch(`/reporting/ai/schedule-detail/${scheduleId}/`, {
      method: 'GET',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success && data.schedule) {
        displayScheduleInfo(data.schedule);
        
        // ì˜ì—­ í‘œì‹œ
        document.getElementById('initial-message').style.display = 'none';
        document.getElementById('schedule-info').style.display = 'block';
        document.getElementById('strategy-button-area').style.display = 'block';
        document.getElementById('ai-response-area').style.display = 'none';
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('ì¼ì • ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
  }

  function displayScheduleInfo(schedule) {
    const typeNames = {
      'customer_meeting': 'ê³ ê° ë¯¸íŒ…',
      'quote': 'ê²¬ì  ì œê³µ',
      'delivery': 'ë‚©í’ˆ'
    };

    document.getElementById('customer-name').textContent = schedule.customer_name;
    document.getElementById('company-name').textContent = schedule.company;
    document.getElementById('schedule-type').textContent = typeNames[schedule.activity_type] || schedule.activity_type;
    document.getElementById('schedule-date').textContent = schedule.visit_date;
    document.getElementById('schedule-time').textContent = schedule.visit_time || 'ë¯¸ì •';
    document.getElementById('schedule-location').textContent = schedule.location || 'ë¯¸ì •';
    document.getElementById('schedule-notes').textContent = schedule.notes || 'ë©”ëª¨ ì—†ìŒ';
  }

  // AI ë¯¸íŒ… ì „ëµ ì¶”ì²œ ìš”ì²­
  document.getElementById('get-strategy-btn').addEventListener('click', async function() {
    if (!selectedScheduleId) {
      alert('ì¼ì •ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }

    // ì„ íƒëœ ì¼ì • ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const selectedSchedule = upcomingSchedules.find(s => s.id === selectedScheduleId);
    
    await runAITaskWithDetails(
      'ë¯¸íŒ… ì „ëµ ì¶”ì²œ',
      '/reporting/ai/meeting-strategy/',
      { schedule_id: selectedScheduleId },
      // ìƒì„¸ ë¡œê·¸ ì½œë°±
      async function() {
        addAILog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
        if (selectedSchedule) {
          addAILog(`ğŸ¢ ê³ ê°: ${selectedSchedule.customer_name}`, 'info');
          addAILog(`ğŸ“… í™œë™: ${selectedSchedule.activity_type}`, 'info');
          addAILog(`ğŸ“† ë‚ ì§œ: ${selectedSchedule.visit_date}`, 'info');
          if (selectedSchedule.department) {
            addAILog(`ğŸ›ï¸  ë¶€ì„œ: ${selectedSchedule.department}`, 'info');
          }
        }
        addAILog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
        await sleep(500);
        addAILog('ğŸ” ê³ ê° êµ¬ë§¤ ì´ë ¥ ì¡°íšŒ ì¤‘...', 'info');
        await sleep(300);
        addAILog('ğŸ“Š ê²¬ì -êµ¬ë§¤ ì „í™˜ìœ¨ ë¶„ì„ ì¤‘...', 'info');
        await sleep(300);
        addAILog('ğŸ“ ê³¼ê±° ë¯¸íŒ… ë©”ëª¨ ìˆ˜ì§‘ ì¤‘...', 'info');
        await sleep(300);
        addAILog('ğŸ’¡ ì§ê¸‰ë³„ ë§ì¶¤ ì „ëµ ìˆ˜ë¦½ ì¤‘...', 'info');
      },
      // ì„±ê³µ ì½œë°±
      function(data) {
        if (data.success && data.strategy) {
          // AI ì‘ë‹µ ì˜ì—­ í‘œì‹œ
          document.getElementById('ai-response-area').style.display = 'block';
          displayAIStrategy(data.strategy);
        } else {
          alert(data.error || 'AI ì „ëµì„ ë°›ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      },
      // ì—ëŸ¬ ì½œë°±
      function(error) {
        alert(`AI ë¯¸íŒ… ì „ëµ ìƒì„± ì‹¤íŒ¨: ${error.message}`);
      }
    );
  });

  function displayAIStrategy(strategy) {
    // Markdown í˜•ì‹ì˜ ì‘ë‹µì„ HTMLë¡œ ë³€í™˜
    let html = strategy
      .replace(/\n/g, '<br>')
      .replace(/^## (.+)$/gm, '<h4 class="mt-4 mb-3 text-primary border-bottom pb-2">$1</h4>')
      .replace(/^### (.+)$/gm, '<h5 class="mt-3 mb-2 text-secondary">$1</h5>')
      .replace(/\*\*(.+?)\*\*/g, '<strong class="text-info">$1</strong>')
      .replace(/- \[ \] (.+)/g, '<div class="form-check"><input class="form-check-input" type="checkbox" disabled><label class="form-check-label">$1</label></div>')
      .replace(/^- (.+)$/gm, '<li>$1</li>')
      .replace(/(<li>.*<\/li>)/s, '<ul class="mb-3">$1</ul>');

    document.getElementById('ai-response-content').innerHTML = html;
  }
  
  // ìœ í‹¸ë¦¬í‹°: sleep í•¨ìˆ˜
  function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
});
</script>
{% endblock %}
