{% extends 'reporting/base.html' %}
{% load static %}

{% block title %}AI 미팅 준비{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row mb-4">
    <div class="col-12">
      <h2 class="mb-3">
        <i class="fas fa-brain text-primary me-2"></i>AI 미팅 전략 추천
      </h2>
      <p class="text-muted">다가오는 일정을 선택하면 AI가 고객 데이터를 분석하여 전략을 추천합니다.</p>
    </div>
  </div>

  <div class="row">
    <!-- 왼쪽: 다가오는 일정 목록 -->
    <div class="col-md-4 mb-4">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="fas fa-calendar-alt me-2"></i>다가오는 일정
          </h5>
        </div>
        <div class="card-body p-0">
          <div class="list-group list-group-flush" id="upcoming-schedules">
            <div class="text-center py-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">로딩 중...</span>
              </div>
              <p class="mt-3 text-muted">일정을 불러오는 중...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 오른쪽: AI 조언 영역 -->
    <div class="col-md-8">
      <!-- 선택된 일정 정보 -->
      <div id="schedule-info" class="card shadow-sm mb-4" style="display: none;">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">
            <i class="fas fa-info-circle me-2"></i>선택된 일정 정보
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <p class="mb-2"><strong>고객명:</strong> <span id="customer-name"></span></p>
              <p class="mb-2"><strong>회사:</strong> <span id="company-name"></span></p>
              <p class="mb-0"><strong>일정 유형:</strong> <span id="schedule-type"></span></p>
            </div>
            <div class="col-md-6">
              <p class="mb-2"><strong>날짜:</strong> <span id="schedule-date"></span></p>
              <p class="mb-2"><strong>시간:</strong> <span id="schedule-time"></span></p>
              <p class="mb-0"><strong>장소:</strong> <span id="schedule-location"></span></p>
            </div>
          </div>
          <div class="mt-3">
            <strong>메모:</strong>
            <p class="mb-0 text-muted" id="schedule-notes"></p>
          </div>
        </div>
      </div>

      <!-- 미팅 전략 추천 버튼 -->
      <div id="strategy-button-area" class="card shadow-sm mb-4" style="display: none;">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">
            <i class="fas fa-lightbulb me-2"></i>AI 전략 추천
          </h5>
        </div>
        <div class="card-body text-center">
          <p class="mb-3">고객의 구매 이력, 견적 전환율, 히스토리를 분석하여 실전 전략을 제시합니다.</p>
          <button type="button" class="btn btn-success btn-lg" id="get-strategy-btn">
            <i class="fas fa-brain me-2"></i>미팅 전략 추천 받기
          </button>
        </div>
      </div>

      <!-- AI 응답 -->
      <div id="ai-response-area" class="card shadow-sm" style="display: none;">
        <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
          <h5 class="mb-0">
            <i class="fas fa-robot me-2"></i>AI 미팅 전략
          </h5>
        </div>
        <div class="card-body">
          <div id="ai-response-content"></div>
        </div>
      </div>

      <!-- 초기 안내 메시지 -->
      <div id="initial-message" class="card shadow-sm border-0">
        <div class="card-body text-center py-5">
          <i class="fas fa-arrow-left fa-3x text-muted mb-3"></i>
          <h5 class="text-muted">왼쪽에서 일정을 선택해주세요</h5>
          <p class="text-muted mb-0">AI가 선택한 미팅에 대한 전문적인 조언을 제공합니다.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.schedule-item {
  cursor: pointer;
  transition: all 0.3s ease;
  border-left: 4px solid transparent !important;
}

.schedule-item:hover {
  background-color: #f8f9fa !important;
  border-left-color: #0d6efd !important;
}

.schedule-item.active {
  background-color: #e7f1ff !important;
  border-left-color: #0d6efd !important;
}

.schedule-item .badge {
  font-size: 0.75rem;
}

#ai-response-content {
  line-height: 1.8;
  font-size: 1.05rem;
}

#ai-response-content h4 {
  color: #667eea;
  margin-top: 1.5rem;
  margin-bottom: 1rem;
  font-weight: 600;
}

#ai-response-content ul {
  padding-left: 1.5rem;
}

#ai-response-content li {
  margin-bottom: 0.75rem;
}

#ai-response-content strong {
  color: #764ba2;
}

.spinner-border-sm {
  width: 1rem;
  height: 1rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  let selectedScheduleId = null;

  // 다가오는 일정 불러오기
  loadUpcomingSchedules();

  function loadUpcomingSchedules() {
    fetch('/reporting/ai/upcoming-schedules/', {
      method: 'GET',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success && data.schedules) {
        displaySchedules(data.schedules);
      } else {
        document.getElementById('upcoming-schedules').innerHTML = `
          <div class="text-center py-5">
            <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
            <p class="text-muted">다가오는 일정이 없습니다.</p>
          </div>
        `;
      }
    })
    .catch(error => {
      console.error('Error:', error);
      document.getElementById('upcoming-schedules').innerHTML = `
        <div class="text-center py-5 text-danger">
          <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
          <p>일정을 불러오는 중 오류가 발생했습니다.</p>
        </div>
      `;
    });
  }

  function displaySchedules(schedules) {
    const container = document.getElementById('upcoming-schedules');
    
    if (schedules.length === 0) {
      container.innerHTML = `
        <div class="text-center py-5">
          <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
          <p class="text-muted">다가오는 일정이 없습니다.</p>
        </div>
      `;
      return;
    }

    let html = '';
    schedules.forEach(schedule => {
      const typeColors = {
        'customer_meeting': 'primary',
        'quote': 'success',
        'delivery': 'danger'
      };
      const typeNames = {
        'customer_meeting': '고객 미팅',
        'quote': '견적',
        'delivery': '납품'
      };
      
      html += `
        <a href="#" class="list-group-item list-group-item-action schedule-item" data-schedule-id="${schedule.id}">
          <div class="d-flex w-100 justify-content-between align-items-start">
            <div>
              <h6 class="mb-1">${schedule.customer_name}</h6>
              <small class="text-muted">${schedule.company}</small>
            </div>
            <span class="badge bg-${typeColors[schedule.activity_type]}">${typeNames[schedule.activity_type]}</span>
          </div>
          <div class="mt-2">
            <small><i class="fas fa-calendar me-1"></i>${schedule.visit_date}</small>
            ${schedule.visit_time ? `<small class="ms-2"><i class="fas fa-clock me-1"></i>${schedule.visit_time}</small>` : ''}
          </div>
        </a>
      `;
    });

    container.innerHTML = html;

    // 일정 클릭 이벤트
    document.querySelectorAll('.schedule-item').forEach(item => {
      item.addEventListener('click', function(e) {
        e.preventDefault();
        const scheduleId = this.dataset.scheduleId;
        selectSchedule(scheduleId);
      });
    });
  }

  function selectSchedule(scheduleId) {
    // 선택 표시
    document.querySelectorAll('.schedule-item').forEach(item => {
      item.classList.remove('active');
    });
    document.querySelector(`[data-schedule-id="${scheduleId}"]`).classList.add('active');

    selectedScheduleId = scheduleId;

    // 일정 상세 정보 불러오기
    fetch(`/reporting/ai/schedule-detail/${scheduleId}/`, {
      method: 'GET',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success && data.schedule) {
        displayScheduleInfo(data.schedule);
        
        // 영역 표시
        document.getElementById('initial-message').style.display = 'none';
        document.getElementById('schedule-info').style.display = 'block';
        document.getElementById('strategy-button-area').style.display = 'block';
        document.getElementById('ai-response-area').style.display = 'none';
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('일정 정보를 불러오는 중 오류가 발생했습니다.');
    });
  }

  function displayScheduleInfo(schedule) {
    const typeNames = {
      'customer_meeting': '고객 미팅',
      'quote': '견적 제공',
      'delivery': '납품'
    };

    document.getElementById('customer-name').textContent = schedule.customer_name;
    document.getElementById('company-name').textContent = schedule.company;
    document.getElementById('schedule-type').textContent = typeNames[schedule.activity_type] || schedule.activity_type;
    document.getElementById('schedule-date').textContent = schedule.visit_date;
    document.getElementById('schedule-time').textContent = schedule.visit_time || '미정';
    document.getElementById('schedule-location').textContent = schedule.location || '미정';
    document.getElementById('schedule-notes').textContent = schedule.notes || '메모 없음';
  }

  // AI 미팅 전략 추천 요청
  document.getElementById('get-strategy-btn').addEventListener('click', function() {
    if (!selectedScheduleId) {
      alert('일정을 먼저 선택해주세요.');
      return;
    }

    // 버튼 비활성화
    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>AI가 전략을 수립하고 있습니다...';

    // AI 응답 영역 표시
    document.getElementById('ai-response-area').style.display = 'block';
    document.getElementById('ai-response-content').innerHTML = `
      <div class="text-center py-5">
        <div class="spinner-border text-primary mb-3" role="status">
          <span class="visually-hidden">분석 중...</span>
        </div>
        <p class="text-muted">AI가 고객의 구매 이력, 견적 전환율, 히스토리 메모를 분석하여 전략을 수립하고 있습니다...</p>
        <small class="text-muted">최대 30초 소요될 수 있습니다</small>
      </div>
    `;

    // AI 전략 요청
    fetch('/reporting/ai/meeting-strategy/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({
        schedule_id: selectedScheduleId
      })
    })
    .then(response => response.json())
    .then(data => {
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-brain me-2"></i>미팅 전략 추천 받기';

      if (data.success && data.strategy) {
        displayAIStrategy(data.strategy);
      } else {
        document.getElementById('ai-response-content').innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            ${data.error || 'AI 전략을 받는 중 오류가 발생했습니다.'}
          </div>
        `;
      }
    })
    .catch(error => {
      console.error('Error:', error);
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-brain me-2"></i>미팅 전략 추천 받기';
      
      document.getElementById('ai-response-content').innerHTML = `
        <div class="alert alert-danger">
          <i class="fas fa-exclamation-triangle me-2"></i>
          AI 전략을 받는 중 오류가 발생했습니다.
        </div>
      `;
    });
  });

  function displayAIStrategy(strategy) {
    // Markdown 형식의 응답을 HTML로 변환
    let html = strategy
      .replace(/\n/g, '<br>')
      .replace(/^## (.+)$/gm, '<h4 class="mt-4 mb-3 text-primary border-bottom pb-2">$1</h4>')
      .replace(/^### (.+)$/gm, '<h5 class="mt-3 mb-2 text-secondary">$1</h5>')
      .replace(/\*\*(.+?)\*\*/g, '<strong class="text-info">$1</strong>')
      .replace(/- \[ \] (.+)/g, '<div class="form-check"><input class="form-check-input" type="checkbox" disabled><label class="form-check-label">$1</label></div>')
      .replace(/^- (.+)$/gm, '<li>$1</li>')
      .replace(/(<li>.*<\/li>)/s, '<ul class="mb-3">$1</ul>');

    document.getElementById('ai-response-content').innerHTML = html;
  }
});
</script>
{% endblock %}
