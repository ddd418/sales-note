{% extends "reporting/base.html" %} {% block title %}{{ page_title }} - ì˜ì—…
ë³´ê³  ì‹œìŠ¤í…œ{% endblock %} {% block content %}
{% csrf_token %}
<style>
/* ğŸ¨ LOVABLE SCHEDULE LIST STYLES */

/* í˜ì´ì§€ ìƒë‹¨ ì—¬ë°± */
.container {
  padding-top: 1.5rem;
}

.page-header {
  margin-top: 0;
}

/* ì¼ì • ëª©ë¡ ëª¨ë°”ì¼ ë° íƒœë¸”ë¦¿ ìµœì í™” */
@media (max-width: 1200px) {
  /* í—¤ë” ëª¨ë°”ì¼ ìµœì í™” */
  .page-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 15px;
    position: sticky;
    top: 60px;
    background: var(--background);
    z-index: 98;
    padding: 15px 0;
    margin-bottom: 15px;
    border-bottom: 1px solid var(--border);
  }

  .page-header .btn-group {
    width: 100%;
  }

  .page-header .btn {
    flex: 1;
    min-width: 120px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: 13px;
    padding: 8px 12px;
  }

  /* í•„í„° ì¹´ë“œ ë‚´ btn-group íƒœë¸”ë¦¿ ìµœì í™” */
  .card .card-body .btn-group {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    width: 100%;
  }

  .card .card-body .btn-group .btn {
    flex: 0 1 auto;
    min-width: auto;
    padding: 6px 10px;
    font-size: 11px;
    min-height: 32px;
    text-align: center;
    white-space: nowrap;
    border-radius: var(--radius-sm) !important;
  }

  /* ìƒíƒœë³„ í•„í„° ëª¨ë°”ì¼ ìµœì í™” */
  .filter-box .btn-group {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .filter-box .btn {
    flex: 1;
    min-width: auto;
    padding: 8px 12px;
    font-size: 12px;
    min-height: 36px;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* ì¼ì • ì¹´ë“œ ëª¨ë°”ì¼ ìµœì í™” - Lovable Style */
  .schedule-card {
    margin-bottom: 10px;
    border-radius: var(--radius);
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border);
    transition: all 0.3s ease;
  }

  .schedule-card:hover {
    box-shadow: var(--shadow-lg), var(--shadow-glow);
    border-color: var(--primary);
  }

  .schedule-card .card-header {
    padding: 10px 15px;
    font-size: 13px;
  }

  .schedule-card .card-body {
    padding: 12px 15px;
    font-size: 12px;
  }

  /* ì•¡ì…˜ ë²„íŠ¼ ëª¨ë°”ì¼ ìµœì í™” */
  .action-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    margin-top: 10px;
  }

  .action-buttons .btn {
    flex: 1;
    min-width: auto;
    padding: 6px 10px;
    font-size: 11px;
    min-height: 32px;
  }

  /* í…Œì´ë¸” ëª¨ë°”ì¼ ìµœì í™” */
  .table-responsive {
    border-radius: var(--radius);
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border);
  }

  .table th,
  .table td {
    font-size: 12px;
    padding: 8px 6px;
    white-space: nowrap;
  }
}

/* íƒœë¸”ë¦¿ ì„¸ë¡œ ëª¨ë“œ (768px~1024px) ì¶”ê°€ ìµœì í™” */
@media (min-width: 768px) and (max-width: 1024px) {
  .row.mb-4 > .col-md-6 {
    flex: 0 0 100%;
    max-width: 100%;
    margin-bottom: 12px;
  }

  .card .card-body .btn-group .btn {
    padding: 5px 8px;
    font-size: 10px;
  }
}

/* ğŸŒ™ ë‹¤í¬ ëª¨ë“œ ìŠ¤íƒ€ì¼ */
/* í˜ì´ì§€ íƒ€ì´í‹€ */
.page-title {
  color: var(--text-primary) !important;
}

/* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
.card {
  background: var(--surface) !important;
  border-color: var(--border) !important;
}

.card-header {
  background: var(--surface-hover) !important;
  border-color: var(--border) !important;
  color: var(--text-primary) !important;
}

.card-header h6,
.card-header a {
  color: var(--text-primary) !important;
}

.card-body {
  background: var(--surface) !important;
  color: var(--text-primary) !important;
}

.card-body .card-text {
  color: var(--text-secondary) !important;
}

.card-body .card-text strong {
  color: var(--text-primary) !important;
}

.card-title {
  color: var(--text-primary) !important;
}

.card-footer {
  background: var(--surface) !important;
  border-color: var(--border) !important;
}

/* í¼ ì»¨íŠ¸ë¡¤ */
.form-control,
.form-select {
  background: var(--surface) !important;
  border-color: var(--border) !important;
  color: var(--text-primary) !important;
}

.form-control::placeholder {
  color: var(--text-muted) !important;
}

.form-control:focus,
.form-select:focus {
  background: var(--surface) !important;
  border-color: var(--primary) !important;
  color: var(--text-primary) !important;
  box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2) !important;
}

/* ë‚ ì§œ ì…ë ¥ í•„ë“œ */
input[type="date"] {
  background: var(--surface) !important;
  border-color: var(--border) !important;
  color: var(--text-primary) !important;
}

input[type="date"]::-webkit-calendar-picker-indicator {
  filter: invert(0.8);
}

/* í¼ ë¼ë²¨ */
.form-label {
  color: var(--text-primary) !important;
}

/* í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
.text-muted {
  color: var(--text-muted) !important;
}

/* ë¹ˆ ìƒíƒœ ë©”ì‹œì§€ */
.card-body.text-center h5.text-muted,
.card-body.text-center p.text-muted {
  color: var(--text-muted) !important;
}

/* ë²„íŠ¼ outline ìŠ¤íƒ€ì¼ */
.btn-outline-secondary {
  color: var(--text-secondary) !important;
  border-color: var(--border) !important;
}

.btn-outline-secondary:hover {
  background: var(--surface-hover) !important;
  color: var(--text-primary) !important;
}
</style>
<div class="container">
  <div class="row">
    <div class="col-12">
      <!-- í—¤ë” ì„¹ì…˜ -->
      <div
        class="page-header d-flex justify-content-between align-items-center mb-4"
      >        <h1 class="page-title mb-0">
          <i class="fas fa-calendar-alt me-2"></i>{{ page_title }}
          {% if is_viewing_others %}
          <span class="badge bg-info ms-2" style="font-size: 0.5em;">
            {% if data_filter == 'all' %}ì „ì²´ ì§ì›{% elif selected_filter_user %}{{ selected_filter_user.username }}{% endif %}
          </span>
          {% endif %}
        </h1>
      </div>
      
      <!-- ë°ì´í„° í•„í„° ì„¹ì…˜ -->
      <div class="row mb-3" style="position: relative; z-index: 1050;">
        <div class="col-12">
          <div class="card border-primary" style="overflow: visible;">
            <div class="card-body py-2" style="overflow: visible;">
              <form method="get" class="row g-2 align-items-center">
                <!-- ê¸°ì¡´ í•„í„° ê°’ ìœ ì§€ -->
                {% if status_filter %}<input type="hidden" name="status" value="{{ status_filter }}">{% endif %}
                {% if activity_type_filter %}<input type="hidden" name="activity_type" value="{{ activity_type_filter }}">{% endif %}
                {% if search_query %}<input type="hidden" name="search" value="{{ search_query }}">{% endif %}
                {% if date_from %}<input type="hidden" name="date_from" value="{{ date_from }}">{% endif %}
                {% if date_to %}<input type="hidden" name="date_to" value="{{ date_to }}">{% endif %}
                
                <div class="col-auto">
                  <label class="form-label mb-0 fw-bold"><i class="fas fa-users me-1"></i>ë°ì´í„° ë²”ìœ„:</label>
                </div>
                <div class="col-auto">
                  <div class="btn-group btn-group-sm" role="group">
                    <input type="radio" class="btn-check" name="data_filter" id="filter_me" value="me" 
                           {% if data_filter == 'me' or not data_filter %}checked{% endif %} onchange="this.form.submit()">
                    <label class="btn btn-outline-primary" for="filter_me">
                      <i class="fas fa-user me-1"></i>ë‚˜
                    </label>
                    
                    <input type="radio" class="btn-check" name="data_filter" id="filter_all" value="all"
                           {% if data_filter == 'all' %}checked{% endif %} onchange="this.form.submit()">
                    <label class="btn btn-outline-primary" for="filter_all">
                      <i class="fas fa-users me-1"></i>ì „ì²´
                    </label>
                  </div>
                </div>
                
                {% if company_users %}
                <div class="col-auto">
                  <select name="filter_user" class="form-select form-select-sm" style="width: auto;" 
                          onchange="document.querySelector('#filter_user_radio').checked = true; this.form.submit();">
                    <option value="">-- ì§ì› ì„ íƒ --</option>
                    {% for user in company_users %}
                    <option value="{{ user.id }}" {% if filter_user_id == user.id|stringformat:"s" %}selected{% endif %}>
                      {{ user.get_full_name|default:user.username }}
                    </option>
                    {% endfor %}
                  </select>
                  <input type="radio" class="btn-check" name="data_filter" id="filter_user_radio" value="user"
                         {% if data_filter == 'user' %}checked{% endif %} style="display: none;">
                </div>
                {% endif %}
                
                {% if is_viewing_others %}
                <div class="col-auto">
                  <span class="badge bg-warning text-dark">
                    <i class="fas fa-eye me-1"></i>ì¡°íšŒ ì „ìš© (ìˆ˜ì •/ì‚­ì œ ë¶ˆê°€)
                  </span>
                </div>
                {% endif %}
              </form>
            </div>
          </div>
        </div>
      </div>
      
      <!-- ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ -->
      <div class="row mb-4">
        <!-- ìƒíƒœë³„ í•„í„° -->
        <div class="col-md-6 mb-3 mb-md-0">
          <div class="card h-100">
            <div class="card-body">
              <h6 class="card-title mb-3">
                <i class="fas fa-filter me-2"></i>ì¼ì • ìƒíƒœë³„ í•„í„°
              </h6>
              <div class="btn-group" role="group" aria-label="ì¼ì • ìƒíƒœ í•„í„°">
                <a
                  href="?{% if activity_type_filter %}activity_type={{ activity_type_filter }}&{% endif %}{% if email_filter %}email_sent={{ email_filter }}&{% endif %}{% if search_query %}search={{ search_query }}&{% endif %}{% if product_search %}product_search={{ product_search }}&{% endif %}{% if user_filter %}user={{ user_filter }}&{% endif %}{% if date_from %}date_from={{ date_from }}&{% endif %}{% if date_to %}date_to={{ date_to }}{% endif %}"
                  class="btn {% if not status_filter %}btn-primary{% else %}btn-outline-primary{% endif %}"
                  style="font-size: 0.75rem;"
                >
                  <i class="fas fa-list me-1"></i>ì „ì²´ ({{ total_count }})
                </a>
                <a
                  href="?status=scheduled{% if activity_type_filter %}&activity_type={{ activity_type_filter }}{% endif %}{% if email_filter %}&email_sent={{ email_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}{% if product_search %}&product_search={{ product_search }}{% endif %}{% if user_filter %}&user={{ user_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}"
                  class="btn {% if status_filter == 'scheduled' %}btn-info{% else %}btn-outline-info{% endif %}"
                  style="font-size: 0.75rem;"
                >
                  <i class="fas fa-clock me-1"></i>ì˜ˆì •ë¨ ({{ scheduled_count}})
                </a>
                <a
                  href="?status=completed{% if activity_type_filter %}&activity_type={{ activity_type_filter }}{% endif %}{% if email_filter %}&email_sent={{ email_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}{% if product_search %}&product_search={{ product_search }}{% endif %}{% if user_filter %}&user={{ user_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}"
                  class="btn {% if status_filter == 'completed' %}btn-success{% else %}btn-outline-success{% endif %}"
                  style="font-size: 0.75rem;"
                >
                  <i class="fas fa-check me-1"></i>ì™„ë£Œë¨ ({{ completed_count}})
                </a>
                <a
                  href="?status=cancelled{% if activity_type_filter %}&activity_type={{ activity_type_filter }}{% endif %}{% if email_filter %}&email_sent={{ email_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}{% if product_search %}&product_search={{ product_search }}{% endif %}{% if user_filter %}&user={{ user_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}"
                  class="btn {% if status_filter == 'cancelled' %}btn-danger{% else %}btn-outline-danger{% endif %}"
                  style="font-size: 0.75rem;"
                >
                  <i class="fas fa-times me-1"></i>ì·¨ì†Œë¨ ({{ cancelled_count}})
                </a>
              </div>
            </div>
          </div>
        </div>

        <!-- í™œë™ ìœ í˜•ë³„ í•„í„° -->
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-body">
              <h6 class="card-title mb-3">
                í™œë™ ìœ í˜•ë³„ í•„í„°
              </h6>
              <div class="btn-group" role="group" aria-label="í™œë™ ìœ í˜• í•„í„°">
                <a
                  href="?{% if status_filter %}status={{ status_filter }}&{% endif %}{% if email_filter %}email_sent={{ email_filter }}&{% endif %}{% if search_query %}search={{ search_query }}&{% endif %}{% if product_search %}product_search={{ product_search }}&{% endif %}{% if user_filter %}user={{ user_filter }}&{% endif %}{% if date_from %}date_from={{ date_from }}&{% endif %}{% if date_to %}date_to={{ date_to }}{% endif %}"
                  class="btn {% if not activity_type_filter %}btn-primary{% else %}btn-outline-primary{% endif %}"
                  style="font-size: 0.75rem;"
                >
                  <i class="fas fa-list me-1"></i>ì „ì²´ ({{ activity_total_count }})
                </a>
                <a
                  href="?activity_type=customer_meeting{% if status_filter %}&status={{ status_filter }}{% endif %}{% if email_filter %}&email_sent={{ email_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}{% if product_search %}&product_search={{ product_search }}{% endif %}{% if user_filter %}&user={{ user_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}"
                  class="btn {% if activity_type_filter == 'customer_meeting' %}btn-info{% else %}btn-outline-info{% endif %}"
                  style="font-size: 0.75rem;"
                >
                  <i class="fas fa-handshake me-1"></i>ë¯¸íŒ… ({{ meeting_count }})
                </a>
                <a
                  href="?activity_type=quote{% if status_filter %}&status={{ status_filter }}{% endif %}{% if email_filter %}&email_sent={{ email_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}{% if product_search %}&product_search={{ product_search }}{% endif %}{% if user_filter %}&user={{ user_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}"
                  class="btn {% if activity_type_filter == 'quote' %}btn-primary{% else %}btn-outline-primary{% endif %}"
                  style="font-size: 0.75rem;"
                >
                  <i class="fas fa-file-invoice-dollar me-1"></i>ê²¬ì  ({{ quote_count }})
                </a>
                <a
                  href="?activity_type=delivery{% if status_filter %}&status={{ status_filter }}{% endif %}{% if email_filter %}&email_sent={{ email_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}{% if product_search %}&product_search={{ product_search }}{% endif %}{% if user_filter %}&user={{ user_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}"
                  class="btn {% if activity_type_filter == 'delivery' %}btn-warning{% else %}btn-outline-warning{% endif %}"
                  style="font-size: 0.75rem;"
                >
                  <i class="fas fa-truck me-1"></i>ë‚©í’ˆ ({{ delivery_count }})
                </a>
                <a
                  href="?activity_type=service{% if status_filter %}&status={{ status_filter }}{% endif %}{% if email_filter %}&email_sent={{ email_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}{% if product_search %}&product_search={{ product_search }}{% endif %}{% if user_filter %}&user={{ user_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}"
                  class="btn {% if activity_type_filter == 'service' %}btn-success{% else %}btn-outline-success{% endif %}"
                  style="font-size: 0.75rem;"
                >
                  <i class="fas fa-tools me-1"></i>ì„œë¹„ìŠ¤ ({{ service_count }})
                </a>
              </div>
            </div>
          </div>
        </div>
        
        </div> <!-- row ë‹«ê¸° -->

      <!-- ê³ ê¸‰ ê²€ìƒ‰ ì„¹ì…˜ -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-body">
              <h6 class="card-title mb-3">
                <i class="fas fa-search me-2"></i>ê³ ê¸‰ ê²€ìƒ‰ ë° í•„í„°
              </h6>
              <form method="GET" action="{% url 'reporting:schedule_list' %}">
                <div class="row g-3">
                  <!-- ê²€ìƒ‰ì–´ -->
                  <div class="col-md-3">
                    <label for="search" class="form-label">ì¼ë°˜ ê²€ìƒ‰</label>
                    <input 
                      type="text" 
                      class="form-control" 
                      id="search"
                      name="search" 
                      value="{{ search_query|default:'' }}"
                      placeholder="ê³ ê°ëª…, ì—…ì²´ëª…, ì¥ì†Œ, ë©”ëª¨..."
                    >
                  </div>
                  
                  <!-- ì œí’ˆ ê²€ìƒ‰ -->
                  <div class="col-md-3">
                    <label for="product_search" class="form-label">ì œí’ˆ ê²€ìƒ‰</label>
                    <input 
                      type="text" 
                      class="form-control" 
                      id="product_search"
                      name="product_search" 
                      value="{{ product_search|default:'' }}"
                      placeholder="ì œí’ˆ í’ˆë²ˆ, ì œí’ˆëª…..."
                    >
                    <small class="text-muted">ë‚©í’ˆ ì¼ì •ì— í¬í•¨ëœ ì œí’ˆìœ¼ë¡œ ê²€ìƒ‰</small>
                  </div>
                  
                  <!-- ë‹´ë‹¹ì í•„í„° -->
                  <div class="col-md-2">
                    <label for="user" class="form-label">ë‹´ë‹¹ì</label>
                    <select class="form-control" id="user" name="user">
                      <option value="">ì „ì²´</option>
                      {% for user_option in users %}
                      <option value="{{ user_option.id }}" {% if user_filter == user_option.id|stringformat:"s" %}selected{% endif %}>
                        {{ user_option.username }}
                      </option>
                      {% endfor %}
                    </select>
                  </div>
                  
                  <!-- ë©”ì¼ ë°œì†¡ í•„í„° -->
                  <div class="col-md-2">
                    <label for="email_sent" class="form-label">
                      <i class="fas fa-envelope me-1"></i>ë©”ì¼ ë°œì†¡
                    </label>
                    <select class="form-control" id="email_sent" name="email_sent">
                      <option value="">ì „ì²´</option>
                      <option value="true" {% if email_filter == 'true' %}selected{% endif %}>ë°œì†¡í•¨</option>
                      <option value="false" {% if email_filter == 'false' %}selected{% endif %}>ë¯¸ë°œì†¡</option>
                    </select>
                  </div>
                  
                  <!-- ì‹œì‘ ë‚ ì§œ -->
                  <div class="col-md-2">
                    <label for="date_from" class="form-label">ì‹œì‘ ë‚ ì§œ</label>
                    <input 
                      type="date" 
                      class="form-control" 
                      id="date_from"
                      name="date_from" 
                      value="{{ date_from|default:'' }}"
                    >
                  </div>
                  
                  <!-- ì¢…ë£Œ ë‚ ì§œ -->
                  <div class="col-md-2">
                    <label for="date_to" class="form-label">ì¢…ë£Œ ë‚ ì§œ</label>
                    <input 
                      type="date" 
                      class="form-control" 
                      id="date_to"
                      name="date_to" 
                      value="{{ date_to|default:'' }}"
                    >
                  </div>
                  
                  <!-- ë²„íŠ¼ë“¤ -->
                  <div class="col-md-2 d-flex align-items-end">
                    <div class="btn-group w-100">
                      <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i>
                      </button>
                      <a href="{% url 'reporting:schedule_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-times"></i>
                      </a>
                    </div>
                  </div>
                </div>
                
                <!-- í˜„ì¬ í•„í„° ìœ ì§€ -->
                {% if status_filter %}
                <input type="hidden" name="status" value="{{ status_filter }}">
                {% endif %}
                {% if activity_type_filter %}
                <input type="hidden" name="activity_type" value="{{ activity_type_filter }}">
                {% endif %}                <!-- ê²€ìƒ‰ ê²°ê³¼ ì •ë³´ -->
                {% if search_query or product_search or user_filter or date_from or date_to %}
                <div class="mt-3">
                  <small class="text-muted">
                    ê²€ìƒ‰ ê²°ê³¼: {{ total_count }}ê±´
                    {% if search_query %} | ì¼ë°˜ê²€ìƒ‰: "<strong>{{ search_query }}</strong>"{% endif %}
                    {% if product_search %} | ì œí’ˆê²€ìƒ‰: "<strong>{{ product_search }}</strong>"{% endif %}
                    {% if selected_user %} | ë‹´ë‹¹ì: <strong>{{ selected_user.username }}</strong>{% endif %}
                    {% if date_from %} | ì‹œì‘: <strong>{{ date_from }}</strong>{% endif %}
                    {% if date_to %} | ì¢…ë£Œ: <strong>{{ date_to }}</strong>{% endif %}
                  </small>
                </div>
                {% endif %}
              </form>
            </div>
          </div>
        </div>
      </div>

      {% if schedules %}
      <!-- ì¼ì • ê°œìˆ˜ í‘œì‹œ -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="text-center text-muted small">
            <span id="filtered-count">ì „ì²´ {{ page_obj.paginator.count }}ê°œ</span>
          </div>
        </div>
      </div>
      
      <div class="row">
        {% for schedule in schedules %}
        <div class="col-md-6 col-lg-4 mb-4" data-visit-month="{{ schedule.visit_date.month }}">
          <div class="card h-100 schedule-card">
            <div
              class="card-header d-flex justify-content-between align-items-center"
            >
              <h6 class="mb-0">
                <a
                  href="{% url 'reporting:schedule_detail' schedule.pk %}"
                  class="text-decoration-none"
                >
                  {{ schedule.followup.customer_name|default:"ê³ ê°ëª… ë¯¸ì •" }}
                </a>
              </h6>
              <div class="d-flex gap-2">
                <span
                  class="badge {% if schedule.activity_type == 'customer_meeting' %}bg-info{% elif schedule.activity_type == 'quote' %}bg-primary{% elif schedule.activity_type == 'delivery' %}bg-warning text-dark{% elif schedule.activity_type == 'service' %}bg-success{% else %}bg-secondary{% endif %}"
                >
                  {% if schedule.activity_type == 'customer_meeting' %}
                    <i class="fas fa-handshake me-1"></i>ë¯¸íŒ…
                  {% elif schedule.activity_type == 'quote' %}
                    <i class="fas fa-file-invoice-dollar me-1"></i>ê²¬ì 
                  {% elif schedule.activity_type == 'delivery' %}
                    <i class="fas fa-truck me-1"></i>ë‚©í’ˆ
                  {% elif schedule.activity_type == 'service' %}
                    <i class="fas fa-tools me-1"></i>ì„œë¹„ìŠ¤
                  {% else %}
                    {{ schedule.get_activity_type_display }}
                  {% endif %}
                </span>
                <span
                  class="badge {% if schedule.status == 'scheduled' %}bg-primary {% elif schedule.status == 'completed' %}bg-success {% elif schedule.status == 'cancelled' %}bg-danger {% else %}bg-secondary {% endif %}"
                >
                  {{ schedule.get_status_display }}
                </span>
              </div>
            </div>

            <div class="card-body">
              <p class="card-text">
                <strong>ê³ ê°ëª…:</strong>
                {{ schedule.followup.customer_name|default:"ê³ ê°ëª… ë¯¸ì •" }}<br />
                <strong>ì—…ì²´:</strong>
                {{schedule.followup.company|default:"ì—…ì²´ëª… ë¯¸ì •" }}<br />
                <strong>ë¶€ì„œ:</strong>
                {{schedule.followup.department|default:"ë¶€ì„œëª… ë¯¸ì •" }}<br />
                {% if schedule.followup.manager %}
                <strong>ì±…ì„ì:</strong>
                {{ schedule.followup.manager }}<br />
                {% endif %}
                <strong>ë‹´ë‹¹ì:</strong>
                {{ schedule.user.username }}<br />
                <strong>ë‚ ì§œ:</strong>
                <i class="fas fa-calendar me-1"></i>
                {{schedule.visit_date|date:"Yë…„ mì›” dì¼" }}<br />
                <strong>ì‹œê°„:</strong>
                <i class="fas fa-clock me-1"></i>
                {{schedule.visit_time|date:"H:i" }}<br />
                {% if schedule.location %}
                <strong>ì¥ì†Œ:</strong>
                <i class="fas fa-map-marker-alt me-1"></i>
                {{schedule.location|truncatechars:30 }}<br />
                {% endif %}
              </p>

              {% if schedule.notes %}
              <p class="card-text">
                <small class="text-muted">
                  <i class="fas fa-sticky-note me-1"></i>
                  {{ schedule.notes|truncatechars:50 }}
                </small>
              </p>
              {% endif %}
            </div>            <div class="card-footer bg-transparent">
              <div class="btn-group w-100 action-buttons" role="group">
                <a
                  href="{% url 'reporting:schedule_detail' schedule.pk %}"
                  class="btn btn-sm btn-outline-primary"
                >
                  <i class="fas fa-eye me-1"></i>ìƒì„¸</a
                >
                {% if schedule.user == user and user.userprofile.role != 'manager' %}
                <a
                  href="{% url 'reporting:schedule_edit' schedule.pk %}"
                  class="btn btn-sm btn-outline-secondary"
                >
                  <i class="fas fa-edit me-1"></i>ìˆ˜ì •</a
                >
                {% endif %}
                {% if schedule.user == user and user.userprofile.role != 'manager' %}
                <a
                  href="{% url 'reporting:history_create_from_schedule' schedule.pk %}"
                  class="btn btn-sm btn-outline-success"
                  onclick="handleHistoryClick({{ schedule.pk }}, this); return false;"
                >
                  <i class="fas fa-plus me-1"></i>í™œë™ ê¸°ë¡</a
                >
                <a
                  href="{% url 'reporting:schedule_delete' schedule.pk %}"
                  class="btn btn-sm btn-outline-danger"
                  onclick="return confirm('ì •ë§ë¡œ ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\n\\nê³ ê°: {% if schedule.followup.customer_name %}{{ schedule.followup.customer_name }}{% else %}ê³ ê°ëª… ë¯¸ì •{% endif %}\\në‚ ì§œ: {{ schedule.visit_date|date:'Yë…„ mì›” dì¼' }}\\n\\nâš ï¸ ì£¼ì˜: ê´€ë ¨ëœ ëª¨ë“  í™œë™ ê¸°ë¡(íˆìŠ¤í† ë¦¬)ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.\\nì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')"
                >
                  <i class="fas fa-trash-alt me-1"></i>ì‚­ì œ</a
                >
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      
      <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
      {% include 'reporting/components/pagination.html' %}
      
      {% else %}
      <div class="card">
        <div class="card-body text-center py-5">
          <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
          <h5 class="text-muted">ì•„ì§ ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</h5>
          {% if user.is_authenticated %}
          <p class="text-muted mb-3">ìº˜ë¦°ë”ì—ì„œ ì¼ì •ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>
          {% endif %}
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>
</div>

<style>
  .page-title {
    color: var(--text-primary);
    font-weight: 600;
  }

  .card {
    border: 1px solid var(--border);
    box-shadow: var(--shadow-md);
    border-radius: 8px;
    transition: transform 0.2s ease-in-out;
  }

  .card:hover {
    transform: translateY(-2px);
  }

  .badge {
    font-size: 0.75rem;
  }

  /* íƒœë¸”ë¦¿ ìµœì í™” (768px ~ 1024px) - ê°¤ëŸ­ì‹œ íƒ­ ë“± */
  @media (min-width: 768px) and (max-width: 1024px) {
    /* í…Œì´ë¸” ì…€ ì¤„ë°”ê¿ˆ ë°©ì§€ */
    .table th,
    .table td {
      white-space: nowrap;
      font-size: 0.85rem;
      padding: 0.5rem;
    }
    
    /* ê¸ˆì•¡/ë‚ ì§œ í‘œì‹œ ì¤„ë°”ê¿ˆ ë°©ì§€ */
    .text-success,
    .text-primary,
    .text-muted {
      white-space: nowrap;
    }
    
    /* ì¼ì • ì¹´ë“œ ë‚´ í…ìŠ¤íŠ¸ */
    .schedule-card .card-body {
      font-size: 0.9rem;
    }
    
    .schedule-card h6 {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* ë°°ì§€ ì¤„ë°”ê¿ˆ ë°©ì§€ */
    .badge {
      white-space: nowrap;
    }
    
    /* ë²„íŠ¼ ê·¸ë£¹ */
    .btn-group .btn {
      white-space: nowrap;
      font-size: 0.85rem;
    }
  }

  /* ì¼ì • ëª©ë¡ ëª¨ë°”ì¼ ìµœì í™” */
@media (max-width: 768px) {
  /* í—¤ë” ëª¨ë°”ì¼ ìµœì í™” */
  .page-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 15px;
    position: sticky;
    top: 60px;
    background: var(--background);
    z-index: 98;
    padding: 15px 0;
    margin-bottom: 15px;
    border-bottom: 1px solid var(--border);
  }

  .page-header .btn-group {
    width: 100%;
  }

  .page-header .btn {
    flex: 1;
    min-width: 120px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: 13px;
    padding: 8px 12px;
  }

  /* ìƒíƒœë³„ í•„í„° ëª¨ë°”ì¼ ìµœì í™” */
  .filter-box .btn-group {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .filter-box .btn {
    flex: 1;
    min-width: auto;
    padding: 8px 12px;
    font-size: 12px;
    min-height: 36px;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* ì¼ì • ì¹´ë“œ ëª¨ë°”ì¼ ìµœì í™” */
  .schedule-card {
    margin-bottom: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .schedule-card .card-header {
    padding: 10px 15px;
    font-size: 13px;
  }

  .schedule-card .card-body {
    padding: 12px 15px;
    font-size: 12px;
  }

  /* ì•¡ì…˜ ë²„íŠ¼ ëª¨ë°”ì¼ ìµœì í™” */
  .action-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    margin-top: 10px;
  }

  .action-buttons .btn {
    flex: 1;
    min-width: auto;
    padding: 6px 10px;
    font-size: 11px;
    min-height: 32px;
  }

  /* í…Œì´ë¸” ëª¨ë°”ì¼ ìµœì í™” */
  .table-responsive {
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .table th,
  .table td {
    font-size: 12px;
    padding: 8px 6px;
    white-space: nowrap;
  }
}

/* ì‘ì€ í™”ë©´ì—ì„œ ì¹´ë“œ í•œ ì¤„ì— í•˜ë‚˜ì”© */
@media (max-width: 576px) {
  .col-md-6.col-lg-4 {
    width: 100%;
    max-width: none;
    padding: 0 5px;
  }

  .page-title {
    font-size: 20px;
  }

  .btn {
    padding: 10px 14px;
    font-size: 14px;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // í™œë™ê¸°ë¡ í´ë¦­ ì²˜ë¦¬ í•¨ìˆ˜
    window.handleHistoryClick = function(scheduleId, element) {
        // ê¸°ì¡´ ë§í¬ ë™ì‘ ë°©ì§€
        event.preventDefault();
        
        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        const originalText = element.innerHTML;
        element.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>í™•ì¸ ì¤‘...';
        element.disabled = true;
        
        // AJAXë¡œ ê¸°ì¡´ íˆìŠ¤í† ë¦¬ í™•ì¸
        fetch(`/reporting/histories/create-from-schedule/${scheduleId}/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.has_existing) {
                    // ê¸°ì¡´ íˆìŠ¤í† ë¦¬ê°€ ìˆëŠ” ê²½ìš°
                    const confirmed = confirm(
                        `"${data.customer_name}" (${data.visit_date}) ì¼ì •ì— ëŒ€í•œ í™œë™ ê¸°ë¡ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.\n\n` +
                        `ê¸°ì¡´ ê¸°ë¡ì„ í™•ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n` +
                        `â€¢ í™•ì¸: ê¸°ì¡´ í™œë™ ê¸°ë¡ìœ¼ë¡œ ì´ë™\n` +
                        `â€¢ ì·¨ì†Œ: ì´ ì°½ì„ ë‹«ìŠµë‹ˆë‹¤`
                    );
                    
                    if (confirmed) {
                        window.location.href = data.history_url;
                    }
                } else {
                    // ìƒˆë¡œìš´ íˆìŠ¤í† ë¦¬ ìƒì„±
                    window.location.href = data.create_url;
                }
            } else {
                alert('ì˜¤ë¥˜: ' + data.error);
            }
        })
        .catch(error => {
            alert('í™œë™ ê¸°ë¡ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        })
        .finally(() => {
            // ë²„íŠ¼ ìƒíƒœ ë³µì›
            element.innerHTML = originalText;
            element.disabled = false;
        });
    };
    
});
</script>
{% endblock %}
