{% extends "reporting/base.html" %} {% block title %}{{ page_title }} - ì˜ì—…
ë³´ê³  ì‹œìŠ¤í…œ{% endblock %} 

{% block extra_css %}
<style>
/* ğŸŒ™ ë‹¤í¬ ëª¨ë“œ ìŠ¤íƒ€ì¼ */

/* í˜ì´ì§€ íƒ€ì´í‹€ */
.page-title {
  color: var(--text-primary) !important;
}

/* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
.card {
  background: var(--surface) !important;
  border-color: var(--border) !important;
}

.card-header {
  background: var(--surface-hover) !important;
  border-color: var(--border) !important;
}

.card-body {
  background: var(--surface) !important;
  color: var(--text-primary) !important;
}

.card-title {
  color: var(--text-primary) !important;
}

.card-title.text-primary {
  color: var(--primary) !important;
}

/* í…ìŠ¤íŠ¸ */
p, strong {
  color: var(--text-primary);
}

.text-muted {
  color: var(--text-muted) !important;
}

h5, h6 {
  color: var(--text-primary);
}

h6.text-muted {
  color: var(--text-muted) !important;
}

/* ë“œë¡­ë‹¤ìš´ */
.dropdown-menu {
  background: var(--surface) !important;
  border-color: var(--border) !important;
}

.dropdown-item {
  color: var(--text-primary) !important;
}

.dropdown-item:hover {
  background: var(--surface-hover) !important;
}

.dropdown-item.active {
  background: var(--primary) !important;
  color: white !important;
}

/* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
.btn-outline-secondary {
  color: var(--text-secondary) !important;
  border-color: var(--border) !important;
}

.btn-outline-secondary:hover {
  background: var(--surface-hover) !important;
  color: var(--text-primary) !important;
}

/* í…Œì´ë¸” */
.table {
  color: var(--text-primary) !important;
}

.table thead th {
  background: var(--surface-hover) !important;
  border-color: var(--border) !important;
  color: var(--text-primary) !important;
}

.table tbody td {
  background: var(--surface) !important;
  border-color: var(--border) !important;
  color: var(--text-primary) !important;
}

.table-hover tbody tr:hover td {
  background: var(--surface-hover) !important;
}

/* íƒ­ ìŠ¤íƒ€ì¼ */
.nav-tabs {
  border-color: var(--border) !important;
}

.nav-tabs .nav-link {
  color: var(--text-secondary) !important;
  border-color: transparent !important;
}

.nav-tabs .nav-link:hover {
  border-color: var(--border) !important;
  color: var(--text-primary) !important;
}

.nav-tabs .nav-link.active {
  background: var(--surface) !important;
  border-color: var(--border) var(--border) var(--surface) !important;
  color: var(--primary) !important;
}

.tab-content {
  background: var(--surface) !important;
}

/* íƒ€ì„ë¼ì¸ */
.timeline-item {
  color: var(--text-primary) !important;
}

.timeline-content {
  background: var(--surface) !important;
  color: var(--text-primary) !important;
}

/* ë¦¬ìŠ¤íŠ¸ ê·¸ë£¹ */
.list-group-item {
  background: var(--surface) !important;
  border-color: var(--border) !important;
  color: var(--text-primary) !important;
}

/* í¼ ì»¨íŠ¸ë¡¤ */
.form-control,
.form-select {
  background: var(--surface) !important;
  border-color: var(--border) !important;
  color: var(--text-primary) !important;
}

/* ëª¨ë‹¬ */
.modal-content {
  background: var(--surface) !important;
  border-color: var(--border) !important;
}

.modal-header {
  background: var(--surface-hover) !important;
  border-color: var(--border) !important;
  color: var(--text-primary) !important;
}

.modal-body {
  background: var(--surface) !important;
  color: var(--text-primary) !important;
}

.modal-footer {
  background: var(--surface) !important;
  border-color: var(--border) !important;
}

.modal-header .btn-close {
  filter: invert(1) grayscale(100%) brightness(200%);
}

/* bg-light ì˜¤ë²„ë¼ì´ë“œ */
.bg-light {
  background: var(--surface-hover) !important;
}

/* ë§í¬ */
a.text-decoration-none {
  color: var(--primary) !important;
}

/* ëª¨ë‹¬ í…Œì´ë¸” ë‹¤í¬ ëª¨ë“œ */
.modal-body .table {
  color: var(--text-primary) !important;
}

.modal-body .table thead th {
  background: var(--surface-hover) !important;
  border-color: var(--border) !important;
  color: var(--text-primary) !important;
}

.modal-body .table thead.table-primary th {
  background: rgba(99, 102, 241, 0.2) !important;
  color: var(--text-primary) !important;
  border-color: var(--border) !important;
}

.modal-body .table tbody td {
  background: var(--surface) !important;
  border-color: var(--border) !important;
  color: var(--text-primary) !important;
}

.modal-body .table tfoot td {
  background: var(--surface-hover) !important;
  border-color: var(--border) !important;
  color: var(--text-primary) !important;
}

/* ëª¨ë‹¬ alert */
.modal-body .alert-light {
  background: var(--surface-hover) !important;
  border-color: var(--border) !important;
  color: var(--text-primary) !important;
}

.modal-body .alert-warning {
  background: rgba(245, 158, 11, 0.15) !important;
  border-color: rgba(245, 158, 11, 0.3) !important;
  color: var(--text-primary) !important;
}

.modal-body .alert-info {
  background: rgba(59, 130, 246, 0.15) !important;
  border-color: rgba(59, 130, 246, 0.3) !important;
  color: var(--text-primary) !important;
}
</style>
{% endblock %}

{% block content %}

<div class="container">
  <div class="row">
    <div class="col-12">
      <!-- í—¤ë” ì„¹ì…˜ -->
      <div
        class="page-header d-flex justify-content-between align-items-center mb-4"
      >
        <h1 class="page-title mb-0">
          <i class="fas fa-building me-2"></i>{{ page_title }}
        </h1>
        <div class="header-actions d-flex align-items-center gap-2">
          <!-- ë°ì´í„° ë²”ìœ„ í•„í„° -->
          <div class="btn-group">
            <a href="?data_filter=me" class="btn btn-sm {% if data_filter == 'me' or not data_filter %}btn-primary{% else %}btn-outline-primary{% endif %}">
              <i class="fas fa-user me-1"></i>ë‚˜
            </a>
            <a href="?data_filter=all" class="btn btn-sm {% if data_filter == 'all' %}btn-primary{% else %}btn-outline-primary{% endif %}">
              <i class="fas fa-users me-1"></i>ì „ì²´
            </a>
          </div>
          {% if company_users %}
          <div class="dropdown">
            <button class="btn btn-sm {% if data_filter == 'user' %}btn-primary{% else %}btn-outline-primary{% endif %} dropdown-toggle" type="button" data-bs-toggle="dropdown">
              {% if selected_filter_user %}
                {{ selected_filter_user.first_name }}{{ selected_filter_user.last_name }}{% if not selected_filter_user.last_name and not selected_filter_user.first_name %}{{ selected_filter_user.username }}{% endif %}
              {% else %}
                ì§ì› ì„ íƒ
              {% endif %}
            </button>
            <ul class="dropdown-menu">
              {% for user_item in company_users %}
              <li>
                <a class="dropdown-item {% if selected_filter_user.id == user_item.id %}active{% endif %}" 
                   href="?data_filter=user&filter_user={{ user_item.id }}">
                  {{ user_item.first_name }}{{ user_item.last_name }}{% if not user_item.last_name and not user_item.first_name %}{{ user_item.username }}{% endif %}
                </a>
              </li>
              {% endfor %}
            </ul>
          </div>
          {% endif %}
          <a
            href="{% url 'reporting:customer_report' %}?data_filter={{ data_filter }}{% if filter_user_id %}&filter_user={{ filter_user_id }}{% endif %}"
            class="btn btn-outline-secondary"
          >
            <i class="fas fa-arrow-left me-2"></i>ëª©ë¡ìœ¼ë¡œ
          </a>
        </div>
      </div>

      <!-- í˜„ì¬ í•„í„° ìƒíƒœ í‘œì‹œ -->
      <div class="mb-3">
        {% if data_filter == 'all' %}
          <span class="badge bg-info"><i class="fas fa-building me-1"></i>íšŒì‚¬ ì „ì²´ ë°ì´í„°</span>
        {% elif selected_filter_user %}
          <span class="badge bg-info"><i class="fas fa-user me-1"></i>{{ selected_filter_user.first_name }}{{ selected_filter_user.last_name }}{% if not selected_filter_user.last_name and not selected_filter_user.first_name %}{{ selected_filter_user.username }}{% endif %} ë°ì´í„°</span>
        {% else %}
          <span class="badge bg-secondary"><i class="fas fa-user me-1"></i>ë‚´ ë°ì´í„°</span>
        {% endif %}
      </div>

      <!-- JSON ë°ì´í„° ì „ë‹¬ì„ ìœ„í•œ ìŠ¤í¬ë¦½íŠ¸ ì—˜ë¦¬ë¨¼íŠ¸ -->
      {{ integrated_deliveries|json_script:"integrated-deliveries-data" }}

      <!-- ë¶€ì„œ ê¸°ë³¸ ì •ë³´ -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <h5 class="card-title text-primary">
                    <i class="fas fa-building me-2"></i>{{ company.name }}
                  </h5>
                  <p class="mb-2">
                    <strong>ë¶€ì„œ/ì—°êµ¬ì‹¤:</strong> {{ department.name }}
                  </p>
                  <p class="mb-0">
                    <strong>ë“±ë¡ ê³ ê° ìˆ˜:</strong> 
                    <span class="badge bg-info">{{ department_followups.count }}ëª…</span>
                  </p>
                </div>
                <div class="col-md-6">
                  <h6 class="text-muted mb-2">
                    <i class="fas fa-users me-2"></i>ì†Œì† ê³ ê° ëª©ë¡
                  </h6>
                  <div class="d-flex flex-wrap gap-2">
                    {% for customer in department_followups %}
                    <a href="{% url 'reporting:followup_detail' customer.id %}" 
                       class="badge {% if customer.id == followup.id %}bg-primary{% else %}bg-secondary{% endif %} text-decoration-none"
                       title="{{ customer.user.username }} ë‹´ë‹¹">
                      {{ customer.customer_name|default:"ë¯¸ì •" }}
                    </a>
                    {% empty %}
                    <span class="text-muted">ë“±ë¡ëœ ê³ ê°ì´ ì—†ìŠµë‹ˆë‹¤.</span>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- í†µê³„ ìš”ì•½ ì¹´ë“œ -->
      <div class="row mb-4">
        <div class="col-md-2-4">
          <div class="card text-center bg-primary text-white">
            <div class="card-body">
              <h5 class="card-title">
                <i class="fas fa-handshake"></i> ì´ ë¯¸íŒ…
              </h5>
              <h3>{{ total_meetings }}íšŒ</h3>
            </div>
          </div>
        </div>
        <div class="col-md-2-4">
          <div class="card text-center bg-success text-white">
            <div class="card-body">
              <h5 class="card-title"><i class="fas fa-truck"></i> ì´ ë‚©í’ˆ</h5>
              <h3 id="totalDeliveriesDisplay">{{ total_deliveries }}ê±´</h3>
            </div>
          </div>
        </div>
        <div class="col-md-2-4">
          <div class="card text-center bg-warning text-white">
            <div class="card-body">
              <h5 class="card-title">
                <i class="fas fa-won-sign"></i> ì´ ê¸ˆì•¡
              </h5>
              <h3>
                {% load currency_filters %} {{ total_amount|currency_format }}ì›
              </h3>
            </div>
          </div>
        </div>
        <div class="col-md-2-4">
          <div class="card text-center text-white" style="background-color: #17a2b8;">
            <div class="card-body">
              <h5 class="card-title">
                <i class="fas fa-money-bill-wave"></i> ì„ ê²°ì œ
              </h5>
              {% if prepayment_count > 0 %}
              <h6>{{ prepayment_count }}ê±´</h6>
              <h6>ì”ì•¡: {% load currency_filters %}{{ prepayment_balance|currency_format }}ì›</h6>
              {% else %}
              <h6>-</h6>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="col-md-2-4">
          <div class="card text-center bg-info text-white">
            <div class="card-body">
              <h5 class="card-title">
                <i class="fas fa-file-invoice"></i> ì„¸ê¸ˆê³„ì‚°ì„œ
              </h5>
              <h6>ë°œí–‰ {{ tax_invoices_issued }}ê±´</h6>
              <h6>ë¯¸ë°œí–‰ {{ tax_invoices_pending }}ê±´</h6>
            </div>
          </div>
        </div>
      </div>

      <!-- ì›”ë³„ í™œë™ íŠ¸ë Œë“œ ì°¨íŠ¸ -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-body">
              <h6 class="card-title mb-3">
                <i class="fas fa-chart-area me-2"></i>ì›”ë³„ í™œë™ íŠ¸ë Œë“œ (ìµœê·¼
                12ê°œì›”)
              </h6>
              <canvas id="activityChart" height="100"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- íƒ­ ë©”ë‰´ -->
      <div class="row">
        <div class="col-12">
          <ul class="nav nav-tabs" id="reportTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button
                class="nav-link active"
                id="delivery-tab"
                data-bs-toggle="tab"
                data-bs-target="#delivery"
                type="button"
                role="tab"
              >
                <i class="fas fa-truck me-2"></i>ë‚©í’ˆ ë‚´ì—­
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                id="all-delivery-tab"
                data-bs-toggle="tab"
                data-bs-target="#all-delivery"
                type="button"
                role="tab"
              >
                <i class="fas fa-boxes me-2"></i>ì „ì²´ ë‚©í’ˆë‚´ì—­
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                id="meeting-tab"
                data-bs-toggle="tab"
                data-bs-target="#meeting"
                type="button"
                role="tab"
              >
                <i class="fas fa-handshake me-2"></i>ë¯¸íŒ… ê¸°ë¡
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                id="timeline-tab"
                data-bs-toggle="tab"
                data-bs-target="#timeline"
                type="button"
                role="tab"
              >
                <i class="fas fa-history me-2"></i>ì „ì²´ íƒ€ì„ë¼ì¸
              </button>
            </li>
          </ul>

          <div class="tab-content mt-3" id="reportTabsContent">
            <!-- ë‚©í’ˆ ë‚´ì—­ íƒ­ -->
            <div
              class="tab-pane fade show active"
              id="delivery"
              role="tabpanel"
            >
              <div class="card">
                <div class="card-body">
                  {% if integrated_deliveries %}
                  <div class="table-responsive">
                    <table class="table table-hover table-compact">
                      <thead class="table-light">
                        <tr>
                          <th>ë‚©í’ˆì¼</th>
                          <th>ê³ ê°</th>
                          <th>í’ˆëª©</th>
                          <th class="text-end">ê¸ˆì•¡</th>
                          <th class="text-center">ì„¸ê¸ˆê³„ì‚°ì„œ</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for delivery in integrated_deliveries %}
                        <tr>
                          <td>{{delivery.date}}</td>
                          <td>
                            <span class="badge bg-secondary">{{ delivery.customer_name|default:"ë¯¸ì •" }}</span>
                          </td>
                          <td>
                            {% if delivery.items_display or delivery.has_schedule_items %}
                              {% if delivery.has_schedule_items %}
                                <!-- has_schedule_itemsì¸ ê²½ìš° Scheduleë§Œ í‘œì‹œ -->
                                <button
                                  class="btn btn-sm btn-outline-primary"
                                  onclick="showScheduleDeliveryItemsModal('{{ delivery.schedule_id }}', '{{ delivery.date }}')"
                                >
                                  <i class="fas fa-boxes me-1"></i>í’ˆëª© ë³´ê¸°
                                </button>
                              {% elif delivery.items_display %}
                                <!-- Historyë§Œ ìˆëŠ” ê²½ìš° -->
                                <button
                                  class="btn btn-sm btn-outline-primary"
                                  onclick="showDeliveryItemsModal('{{ delivery.id }}', '{{ delivery.date }}')"
                                >
                                  <i class="fas fa-boxes me-1"></i>í’ˆëª© ë³´ê¸°
                                </button>
                              {% endif %}
                            {% else %}
                              <span class="text-muted">-</span>
                            {% endif %}
                          </td>
                          <td class="text-end">
                            {% if delivery.amount %}
                              <strong class="text-success">
                                {% load currency_filters %}
                                {{ delivery.amount|currency_format }}ì›
                              </strong>
                            {% else %}
                              <span class="text-muted">-</span>
                            {% endif %}
                          </td>
                          <td class="text-center">
                            {% if delivery.type == 'history' %}
                              {% if delivery.history_tax_status.has_items %}
                                {% if delivery.history_tax_status.all_issued %}
                                  {% if not can_modify_tax_invoice %}
                                    <span class="badge bg-primary">ë°œí–‰ì™„ë£Œ</span>
                                  {% else %}
                                    <div class="tax-invoice-toggle" data-type="history" data-id="{{ delivery.id }}" style="cursor: pointer" title="í´ë¦­í•˜ì—¬ ìƒíƒœ ë³€ê²½">
                                      <span class="badge bg-primary"><i class="fas fa-check me-1"></i>ë°œí–‰ì™„ë£Œ</span>
                                    </div>
                                    <small class="text-muted d-block mt-1">í´ë¦­ì‹œ ì¼ê´„ë³€ê²½</small>
                                  {% endif %}
                                {% elif delivery.history_tax_status.none_issued %}
                                  {% if not can_modify_tax_invoice %}
                                    <span class="badge bg-secondary">ë¯¸ë°œí–‰</span>
                                  {% else %}
                                    <div class="tax-invoice-toggle" data-type="history" data-id="{{ delivery.id }}" style="cursor: pointer" title="í´ë¦­í•˜ì—¬ ìƒíƒœ ë³€ê²½">
                                      <span class="badge bg-secondary"><i class="fas fa-times me-1"></i>ë¯¸ë°œí–‰</span>
                                    </div>
                                    <small class="text-muted d-block mt-1">í´ë¦­ì‹œ ì¼ê´„ë³€ê²½</small>
                                  {% endif %}
                                {% else %}
                                  <span class="badge bg-primary">ë°œí–‰ì™„ë£Œ</span>
                                  <span class="badge bg-secondary">ë¯¸ë°œí–‰</span>
                                  {% if can_modify_tax_invoice %}
                                    <br />
                                    <button class="btn btn-sm btn-outline-primary mt-1" onclick="showDeliveryItemsModal('{{ delivery.id }}', '{{ delivery.date }}')">
                                      <i class="fas fa-edit me-1"></i>ê°œë³„ í¸ì§‘
                                    </button>
                                  {% endif %}
                                {% endif %}
                              {% else %}
                                {% if not can_modify_tax_invoice %}
                                  <span class="badge bg-{% if delivery.tax_invoice_issued %}primary{% else %}secondary{% endif %}">
                                    {% if delivery.tax_invoice_issued %}ë°œí–‰ì™„ë£Œ{% else %}ë¯¸ë°œí–‰{% endif %}
                                  </span>
                                {% else %}
                                  <div class="tax-invoice-toggle" data-type="history" data-id="{{ delivery.id }}" style="cursor: pointer" title="í´ë¦­í•˜ì—¬ ìƒíƒœ ë³€ê²½">
                                    <span class="badge bg-{% if delivery.tax_invoice_issued %}primary{% else %}secondary{% endif %}">
                                      <i class="fas fa-{% if delivery.tax_invoice_issued %}check{% else %}times{% endif %} me-1"></i>
                                      {% if delivery.tax_invoice_issued %}ë°œí–‰ì™„ë£Œ{% else %}ë¯¸ë°œí–‰{% endif %}
                                    </span>
                                  </div>
                                  <small class="text-muted d-block mt-1">í´ë¦­ì‹œ ìƒíƒœ ë³€ê²½</small>
                                {% endif %}
                              {% endif %}
                            {% else %}
                              {% if delivery.schedule_tax_status.total_count == 0 %}
                                <span class="text-muted">í’ˆëª© ì—†ìŒ</span>
                              {% else %}
                                {% if not can_modify_tax_invoice %}
                                  {% if delivery.schedule_tax_status.issued_count > 0 %}
                                    <span class="badge bg-primary">ë°œí–‰ì™„ë£Œ</span>
                                  {% endif %}
                                  {% if delivery.schedule_tax_status.total_count > delivery.schedule_tax_status.issued_count %}
                                    <span class="badge bg-secondary">ë¯¸ë°œí–‰</span>
                                  {% endif %}
                                {% else %}
                                  <div class="tax-invoice-toggle" data-type="schedule_bulk" data-id="{{ delivery.schedule_id }}" style="cursor: pointer" title="í´ë¦­í•˜ì—¬ ìƒíƒœ ë³€ê²½">
                                    <span class="badge bg-{% if delivery.schedule_tax_status.all_issued %}primary{% else %}secondary{% endif %}">
                                      <i class="fas fa-{% if delivery.schedule_tax_status.all_issued %}check{% else %}times{% endif %} me-1"></i>
                                      {% if delivery.schedule_tax_status.all_issued %}ë°œí–‰ì™„ë£Œ{% else %}ë¯¸ë°œí–‰{% endif %}
                                    </span>
                                  </div>
                                  <small class="text-muted d-block mt-1">í´ë¦­ì‹œ ìƒíƒœ ë³€ê²½</small>
                                {% endif %}
                              {% endif %}
                            {% endif %}
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                  {% else %}
                  <div class="text-center text-muted py-4">
                    <i class="fas fa-truck fa-2x mb-3"></i>
                    <p>ë‚©í’ˆ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- ì „ì²´ ë‚©í’ˆë‚´ì—­ íƒ­ -->
            <div class="tab-pane fade" id="all-delivery" role="tabpanel">
              <div class="card">
                <div class="card-body">
                  {% if integrated_deliveries %}
                  <!-- ìš”ì•½ ì •ë³´ -->
                  <div class="alert alert-info mb-4">
                    <div class="row text-center">
                      <div class="col-md-4">
                        <h5 class="mb-1">
                          <i class="fas fa-calendar-check me-2"></i>{{total_deliveries }}
                        </h5>
                        <small class="text-muted">ì´ ë‚©í’ˆ ê±´ìˆ˜</small>
                      </div>
                      <div class="col-md-4">
                        <h5 class="mb-1">
                          <i class="fas fa-boxes me-2"></i
                          ><span id="totalItemsCount">-</span>
                        </h5>
                        <small class="text-muted">ì´ í’ˆëª© ê°œìˆ˜</small>
                      </div>
                      <div class="col-md-4">
                        <h5 class="mb-1 text-success">
                          <i class="fas fa-won-sign me-2"></i
                          ><span id="totalDeliveryAmount"
                            >{{ total_amount|floatformat:0 }}</span
                          >ì›
                        </h5>
                        <small class="text-muted">ì´ ë‚©í’ˆ ê¸ˆì•¡</small>
                      </div>
                    </div>
                  </div>

                  <!-- ì „ì²´ í’ˆëª© ëª©ë¡ -->
                  <div class="table-responsive">
                    <table class="table table-hover table-compact">
                      <thead class="table-light">
                        <tr>
                          <th>í’ˆëª©ëª…</th>
                          <th class="text-center">ì´ ìˆ˜ëŸ‰</th>
                          <th class="text-end">ì´ ê¸ˆì•¡</th>
                          <th class="text-center">ë‚©í’ˆ íšŸìˆ˜</th>
                        </tr>
                      </thead>
                      <tbody id="allDeliveryItemsTable">
                        <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                      </tbody>
                    </table>
                  </div>
                  {% else %}
                  <div class="text-center text-muted py-4">
                    <i class="fas fa-boxes fa-2x mb-3"></i>
                    <p>ë‚©í’ˆ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- ë¯¸íŒ… ê¸°ë¡ íƒ­ -->
            <div class="tab-pane fade" id="meeting" role="tabpanel">
              <div class="card">
                <div class="card-body">
                  {% if meeting_histories %}
                  <div class="table-responsive">
                    <table class="table table-hover">
                      <thead class="table-light">
                        <tr>
                          <th>ë¯¸íŒ…ì¼</th>
                          <th>ê³ ê°</th>
                          <th>ë‚´ìš©</th>
                          <th>ë“±ë¡ì¼</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for history in meeting_histories %}
                        <tr>
                          <td>
                            {% if history.meeting_date %} {{history.meeting_date }} {% else %}
                            <span class="text-muted">ë¯¸ì •</span>
                            {% endif %}
                          </td>
                          <td>
                            <span class="badge bg-secondary">{{ history.followup.customer_name|default:"ë¯¸ì •" }}</span>
                          </td>
                          <td>
                            {% if history.content %} {{history.content|truncatechars:100 }} {% else %}
                            <span class="text-muted">ë‚´ìš© ì—†ìŒ</span>
                            {% endif %}
                          </td>
                          <td>
                            <small class="text-muted"
                              >{{ history.created_at|date:"Y-m-d H:i" }}</small>
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                  {% else %}
                  <div class="text-center text-muted py-4">
                    <i class="fas fa-handshake fa-2x mb-3"></i>
                    <p>ë¯¸íŒ… ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- ì „ì²´ íƒ€ì„ë¼ì¸ íƒ­ -->
            <div class="tab-pane fade" id="timeline" role="tabpanel">
              <div class="card">
                <div class="card-body">
                  {% if histories %}
                  <div class="timeline">
                    {% for history in histories %}
                    <div
                      class="timeline-item"
                      data-history-id="{{ history.id }}"
                      {% if history.schedule %}
                      data-schedule-id="{{ history.schedule.id }}"
                      {% endif %}
                    >
                      <div
                        class="timeline-marker {% if history.action_type == 'customer_meeting' %}bg-primary {% elif history.action_type == 'delivery_schedule' %}bg-success {% elif history.action_type == 'memo' %}bg-info {% else %}bg-light {% endif %}"
                      >
                        <i
                          class="fas {% if history.action_type == 'customer_meeting' %}fa-handshake {% elif history.action_type == 'delivery_schedule' %}fa-truck {% elif history.action_type == 'memo' %}fa-sticky-note {% else %}fa-circle {% endif %} text-white"
                        ></i>
                      </div>
                      <div class="timeline-content">
                        <div class="card">
                          <div class="card-body">
                            <h6 class="card-title">
                              {{ history.get_action_type_display }}
                              <span class="badge bg-secondary ms-2">{{ history.followup.customer_name|default:"ë¯¸ì •" }}</span>
                              <small class="text-muted ms-2"
                                >{{ history.created_at|date:"Y-m-d H:i"}}</small
                              >
                            </h6>
                            {% if history.content %}
                            <p class="card-text">
                              {{ history.content|linebreaks }}
                            </p>
                            {% endif %}

                            <!-- ë‚©í’ˆ ì •ë³´ -->
                            {% if history.action_type == 'delivery_schedule' %}
                            <div class="delivery-details">
                              {% if history.delivery_amount %}
                              <p class="mb-1">
                                <strong>ê¸ˆì•¡:</strong>
                                {% load currency_filters %} {{history.delivery_amount|currency_format }}ì›
                              </p>
                              {% endif %} {% if history.delivery_items %}
                              <p class="mb-1">
                                <strong>í’ˆëª©:</strong> {{ history.delivery_items}}
                              </p>
                              {% endif %} {% if history.delivery_date %}
                              <p class="mb-1">
                                <strong>ë‚©í’ˆì¼:</strong> {{history.delivery_date}}
                              </p>
                              {% endif %}
                            </div>
                            {% endif %}

                            <!-- ë¯¸íŒ… ì •ë³´ -->
                            {% if history.action_type == 'customer_meeting' and history.meeting_date %}
                              <p class="mb-1">
                                <strong>ë¯¸íŒ…ì¼:</strong> {{ history.meeting_date }}
                              </p>
                            {% endif %}
                          </div>
                        </div>
                      </div>
                    </div>
                    {% endfor %}
                  </div>
                  {% else %}
                  <div class="text-center text-muted py-4">
                    <i class="fas fa-history fa-2x mb-3"></i>
                    <p>í™œë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
      // Chart.js ì„¤ì •
      const ctx = document.getElementById('activityChart').getContext('2d');

      const chart = new Chart(ctx, {
          type: 'line',
          data: {
              labels: {{ chart_data.labels|safe }},
              datasets: [
                  {
                      label: 'ë¯¸íŒ… íšŸìˆ˜',
                      data: {{ chart_data.meetings|safe }},
                      borderColor: 'rgb(54, 162, 235)',
                      backgroundColor: 'rgba(54, 162, 235, 0.1)',
                      yAxisID: 'y'
                  },
                  {
                      label: 'ë‚©í’ˆ ê±´ìˆ˜',
                      data: {{ chart_data.deliveries|safe }},
                      borderColor: 'rgb(75, 192, 192)',
                      backgroundColor: 'rgba(75, 192, 192, 0.1)',
                      yAxisID: 'y'
                  },
                  {
                      label: 'ë‚©í’ˆ ê¸ˆì•¡ (ë§Œì›)',
                      data: {{ chart_data.amounts|safe }}.map(amount => amount / 10000),
                      borderColor: 'rgb(255, 206, 86)',
                      backgroundColor: 'rgba(255, 206, 86, 0.1)',
                      yAxisID: 'y1'
                  }
              ]
          },
          options: {
              responsive: true,
              interaction: {
                  mode: 'index',
                  intersect: false,
              },
              scales: {
                  x: {
                      display: true,
                      title: {
                          display: true,
                          text: 'ì›”'
                      }
                  },
                  y: {
                      type: 'linear',
                      display: true,
                      position: 'left',
                      title: {
                          display: true,
                          text: 'ê±´ìˆ˜/íšŸìˆ˜'
                      }
                  },
                  y1: {
                      type: 'linear',
                      display: true,
                      position: 'right',
                      title: {
                          display: true,
                          text: 'ê¸ˆì•¡ (ë§Œì›)'
                      },
                      grid: {
                          drawOnChartArea: false,
                      },
                  }
              },
              plugins: {
                  title: {
                      display: true,
                      text: 'ì›”ë³„ í™œë™ ë° ë§¤ì¶œ ì¶”ì´'
                  }
              }
          }
      });
  });
</script>

<style>
  /* 5ê°œ ì¹´ë“œ ë ˆì´ì•„ì›ƒì„ ìœ„í•œ í´ë˜ìŠ¤ */
  .col-md-2-4 {
    flex: 0 0 20%;
    max-width: 20%;
  }

  /* ëª¨ë°”ì¼ ë° íƒœë¸”ë¦¿ ë°˜ì‘í˜• (1200px ì´í•˜) */
  @media (max-width: 1200px) {
    .container {
      padding-top: 1.5rem;
    }
    
    .page-header {
      flex-direction: column;
      align-items: flex-start !important;
      gap: 1rem;
    }
    
    .page-title {
      font-size: 1.5rem;
    }
    
    .header-actions {
      width: 100%;
      display: flex;
      gap: 0.5rem;
    }
    
    .header-actions .btn {
      flex: 1;
      font-size: 0.875rem;
      padding: 0.5rem 0.75rem;
    }
    
    .col-md-2-4 {
      flex: 0 0 100%;
      max-width: 100%;
      margin-bottom: 1rem;
    }
    
    .card-body h5,
    .card-title {
      font-size: 1rem;
    }
    
    .card-body h3 {
      font-size: 1.5rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .card-body h6 {
      font-size: 0.875rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .nav-tabs .nav-link {
      font-size: 0.875rem;
      padding: 0.5rem 0.75rem;
    }
    
    .table-responsive {
      font-size: 0.875rem;
    }
    
    .table th,
    .table td {
      padding: 0.5rem;
      white-space: nowrap;
    }
    
    .btn-sm {
      font-size: 0.75rem;
      padding: 0.25rem 0.4rem;
    }
    
    canvas {
      max-height: 250px !important;
    }
  }

  @media (max-width: 768px) {
    .col-md-2-4 {
      flex: 0 0 100%;
      max-width: 100%;
    }
    
    .page-title {
      font-size: 1.25rem;
    }
    
    .card-body h3 {
      font-size: 1.25rem;
    }
    
    .card-body h6 {
      font-size: 0.8rem;
    }
    
    canvas {
      max-height: 200px !important;
    }
  }
  
  /* íƒœë¸”ë¦¿ (768px ~ 1024px) - ê°¤ëŸ­ì‹œ íƒ­ ë“± */
  @media (min-width: 768px) and (max-width: 1024px) {
    .col-md-2-4 {
      flex: 0 0 33.33%;
      max-width: 33.33%;
    }
    
    .card-body h3 {
      font-size: 1.35rem;
      white-space: nowrap;
    }
    
    .card-body h6 {
      font-size: 0.85rem;
      white-space: nowrap;
    }
    
    /* í…Œì´ë¸” ì…€ ì¤„ë°”ê¿ˆ ë°©ì§€ */
    .table th,
    .table td {
      white-space: nowrap;
      font-size: 0.85rem;
    }
    
    /* ê¸ˆì•¡ í‘œì‹œ ì¤„ë°”ê¿ˆ ë°©ì§€ */
    .text-success,
    .text-primary,
    .text-info,
    .text-warning,
    .text-danger {
      white-space: nowrap;
    }
    
    /* ë‚ ì§œ/ì‹œê°„ í‘œì‹œ ì¤„ë°”ê¿ˆ ë°©ì§€ */
    .text-muted {
      white-space: nowrap;
    }
  }
  
  /* ì†Œí˜• ëª¨ë°”ì¼ (480px ì´í•˜) */
  @media (max-width: 480px) {
    .page-title {
      font-size: 1.1rem;
    }
    
    .header-actions .btn {
      font-size: 0.75rem;
      padding: 0.4rem 0.6rem;
    }
    
    .card-body h3 {
      font-size: 1.1rem;
    }
    
    .card-body h5 {
      font-size: 0.9rem;
    }
    
    .card-body h6 {
      font-size: 0.75rem;
    }
  }

  .timeline {
    position: relative;
    padding-left: 30px;
  }

  .timeline::before {
    content: "";
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #dee2e6;
  }

  .timeline-item {
    position: relative;
    margin-bottom: 30px;
  }

  .timeline-marker {
    position: absolute;
    left: -22px;
    top: 10px;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .timeline-content {
    margin-left: 15px;
  }

  .delivery-details p {
    font-size: 0.9em;
    margin-bottom: 0.25rem;
  }

  .nav-tabs .nav-link {
    color: #6c757d;
  }

  .nav-tabs .nav-link.active {
    color: #007bff;
    font-weight: 500;
  }

  /* ëª¨ë‹¬ z-index ìˆ˜ì • - ì‚¬ì´ë“œë°”ë³´ë‹¤ ìœ„ì— í‘œì‹œ */
  .modal {
    z-index: 10000 !important;
    position: fixed !important;
  }
  
  .modal-backdrop {
    z-index: 9999 !important;
    pointer-events: none !important;
  }
  
  .modal-dialog {
    z-index: 10001 !important;
    position: relative !important;
    pointer-events: auto !important;
  }
  
  .modal-content {
    z-index: 10002 !important;
    position: relative !important;
    pointer-events: auto !important;
  }
  
  /* ì‚¬ì´ë“œë°” z-index ê°•ì œ ì¡°ì • */
  .sidebar, #sidebar, .offcanvas, .navbar {
    z-index: 9998 !important;
  }
  
  /* ëª¨ë‹¬ì´ ëª¨ë“  ê²ƒ ìœ„ì— í‘œì‹œë˜ë„ë¡ ê°•ì œ */
  .modal.show {
    z-index: 10000 !important;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    pointer-events: auto !important;
  }
  
  .modal.show .modal-dialog {
    z-index: 10001 !important;
    pointer-events: auto !important;
    position: relative !important;
  }
  
  .modal.show .modal-content {
    z-index: 10002 !important;
    pointer-events: auto !important;
    position: relative !important;
  }
  
  /* ë‹¤ë¥¸ ëª¨ë“  ìš”ì†Œë“¤ë³´ë‹¤ ìœ„ì— í‘œì‹œ */
  body > *:not(.modal):not(.modal-backdrop) {
    position: relative;
    z-index: 9997 !important;
  }
</style>

<!-- ë‚©í’ˆ í’ˆëª© ìƒì„¸ ëª¨ë‹¬ -->
<div
  class="modal fade"
  id="deliveryItemsModal"
  tabindex="-1"
  aria-labelledby="deliveryItemsModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="deliveryItemsModalLabel">
          <i class="fas fa-boxes me-2"></i>ë‚©í’ˆ í’ˆëª© ìƒì„¸
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div id="modalDeliveryDate" class="alert alert-light mb-3">
          <strong>ë‚©í’ˆì¼:</strong> <span id="deliveryDateText"></span>
        </div>
        <div id="modalDeliveryItems" class="delivery-items-content">
          <!-- ë‚©í’ˆ í’ˆëª© ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          ë‹«ê¸°
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // ë‚©í’ˆ í’ˆëª© ëª¨ë‹¬ì„ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜ (ì „ì—­ í•¨ìˆ˜ë¡œ ì •ì˜)
  function showDeliveryItemsModal(historyId, deliveryDate) {
    
    // ë‚©í’ˆì¼ ì„¤ì •
    const deliveryDateElement = document.getElementById('deliveryDateText');
    if (deliveryDateElement) {
      deliveryDateElement.textContent = deliveryDate;
    }

    // Historyì˜ DeliveryItem ì •ë³´ë¥¼ ê°€ì ¸ì™€ì„œ í‘œì‹œ
    fetch(`/reporting/histories/${historyId}/delivery-items-api/`)
      .then(response => response.json())
      .then(data => {
        const contentDiv = document.getElementById('modalDeliveryItems');

        if (!contentDiv) {
          return;
        }

        if (data.success && data.items && data.items.length > 0) {
          let totalAmount = 0;

          // í’ˆëª© ìƒíƒœ ì •ë³´ í‘œì‹œ (í†µí•© í‘œì‹œ ì œê±°)
          let infoHtml = '';
          if (data.is_legacy_data) {
            infoHtml = `
              <div class="alert alert-warning mb-3">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>ë ˆê±°ì‹œ ë°ì´í„°</strong> - ê¸°ì¡´ í…ìŠ¤íŠ¸ í˜•íƒœì˜ í’ˆëª© ì •ë³´ì…ë‹ˆë‹¤.
              </div>
            `;
          }
          let tableHtml = `
            <div class="table-responsive">
              <table class="table table-sm table-bordered">
                <thead class="table-primary">
                  <tr>
                    <th>í’ˆëª©ëª…</th>
                    <th class="text-center">ìˆ˜ëŸ‰</th>
                    <th class="text-end">ë‹¨ê°€</th>
                    <th class="text-end">ì´ì•¡ (ë¶€ê°€ì„¸ í¬í•¨)</th>
                    <th class="text-center">ì„¸ê¸ˆê³„ì‚°ì„œ</th>
                  </tr>
                </thead>
                <tbody>
          `;

          data.items.forEach(item => {
            const itemTotal = item.total_price || (item.quantity * item.unit_price * 1.1);
            totalAmount += itemTotal;

            tableHtml += `
              <tr>
                <td>${item.item_name || ''}</td>
                <td class="text-center">${item.quantity || 0}</td>
                <td class="text-end">${parseInt(item.unit_price || 0).toLocaleString()}ì›</td>
                <td class="text-end"><strong class="text-primary">${parseInt(itemTotal).toLocaleString()}ì›</strong></td>
                <td class="text-center">
                  ${item.tax_invoice_issued
                    ? '<span class="badge bg-primary">ë°œí–‰ì™„ë£Œ</span>'
                    : '<span class="badge bg-secondary">ë¯¸ë°œí–‰</span>'}
                </td>
              </tr>
            `;
          });

          tableHtml += `
                </tbody>
                <tfoot class="table-secondary">
                  <tr>
                    <th colspan="4" class="text-end">ì´ ê¸ˆì•¡:</th>
                    <th class="text-end text-success">${parseInt(totalAmount).toLocaleString()}ì›</th>
                  </tr>
                </tfoot>
              </table>
            </div>
          `;

          contentDiv.innerHTML = tableHtml;
        } else {
          contentDiv.innerHTML = `
            <div class="text-center text-muted py-3">
              <i class="fas fa-box-open me-2"></i>í’ˆëª© ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.
              ${data.error ? `<br><small class="text-danger">${data.error}</small>` : ''}
            </div>
          `;
        }
      })
      .catch(error => {
        const contentDiv = document.getElementById('modalDeliveryItems');
        if (contentDiv) {
          contentDiv.innerHTML = `
            <div class="text-center text-danger py-3">
              <i class="fas fa-exclamation-triangle me-2"></i>í’ˆëª© ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
              <br><small>${error.message}</small>
            </div>
          `;
        }
      });

    // ëª¨ë‹¬ í‘œì‹œ
    const modalElement = document.getElementById('deliveryItemsModal');
    const modal = new bootstrap.Modal(modalElement);
    
    // ê°•ì œë¡œ z-indexì™€ pointer-events ì„¤ì •
    modalElement.style.cssText = 'z-index: 10000 !important; position: fixed !important;';
    
    // ë°±ë“œë¡­ ì²˜ë¦¬ë¥¼ ìœ„í•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    modalElement.addEventListener('show.bs.modal', function() {
      // ëª¨ë“  ì‚¬ì´ë“œë°”ì™€ ë„¤ë¹„ê²Œì´ì…˜ ìš”ì†Œë“¤ì˜ z-indexë¥¼ ë‚®ì¶¤
      const sidebarElements = document.querySelectorAll('.sidebar, #sidebar, .offcanvas, .navbar, nav');
      sidebarElements.forEach(el => {
        el.style.zIndex = '9998';
      });
    });
    
    modal.show();
    
    // ê°•ë ¥í•œ z-index í•´ê²°
    forceModalToFront('deliveryItemsModal');
  }

  // í†µí•© ë‚©í’ˆ í’ˆëª© ëª¨ë‹¬ì„ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜ (Historyì™€ Schedule í†µí•©)
  function showIntegratedDeliveryItemsModal(historyId, scheduleId, deliveryDate) {
    // ë‚©í’ˆì¼ ì„¤ì •
    const deliveryDateElement = document.getElementById('deliveryDateText');
    if (deliveryDateElement) {
      deliveryDateElement.textContent = deliveryDate;
    }

    const contentDiv = document.getElementById('modalDeliveryItems');
    if (!contentDiv) {
      return;
    }

    // ë¡œë”© í‘œì‹œ
    contentDiv.innerHTML = `
      <div class="text-center py-3">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">í†µí•© í’ˆëª© ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
      </div>
    `;

    // ëª¨ë‹¬ ë¨¼ì € í‘œì‹œ
    const modalElement = document.getElementById('deliveryItemsModal');
    const modal = new bootstrap.Modal(modalElement);
    
    // ê°•ì œë¡œ z-indexì™€ pointer-events ì„¤ì •
    modalElement.style.cssText = 'z-index: 10000 !important; position: fixed !important;';
    
    // ë°±ë“œë¡­ ì²˜ë¦¬ë¥¼ ìœ„í•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    modalElement.addEventListener('show.bs.modal', function() {
      // ëª¨ë“  ì‚¬ì´ë“œë°”ì™€ ë„¤ë¹„ê²Œì´ì…˜ ìš”ì†Œë“¤ì˜ z-indexë¥¼ ë‚®ì¶¤
      const sidebarElements = document.querySelectorAll('.sidebar, #sidebar, .offcanvas, .navbar, nav');
      sidebarElements.forEach(el => {
        el.style.zIndex = '9998';
      });
    });
    
    modal.show();
    
    // ë°±ë“œë¡­ê³¼ ëª¨ë‹¬ ì»¨í…ì¸  ê°•ì œ ì¡°ì •
    setTimeout(() => {
      const backdrop = document.querySelector('.modal-backdrop');
      const dialog = modalElement.querySelector('.modal-dialog');
      const content = modalElement.querySelector('.modal-content');
      
      if (backdrop) {
        backdrop.style.cssText = 'z-index: 9999 !important; pointer-events: none !important;';
      }
      if (dialog) {
        dialog.style.cssText = 'z-index: 10001 !important; pointer-events: auto !important; position: relative !important;';
      }
      if (content) {
        content.style.cssText = 'z-index: 10002 !important; pointer-events: auto !important; position: relative !important;';
      }
      
      // ëª¨ë‹¬ì´ í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡ ê°•ì œ ì„¤ì •
      modalElement.style.pointerEvents = 'auto';
    }, 150);

    // ê°•ë ¥í•œ z-index í•´ê²°ë¡œ ë³€ê²½
    forceModalToFront('deliveryItemsModal');

    // Historyì™€ Schedule ë°ì´í„°ë¥¼ ëª¨ë‘ ê°€ì ¸ì™€ì„œ í†µí•© í‘œì‹œ
    Promise.all([
      // History DeliveryItem ê°€ì ¸ì˜¤ê¸°
      historyId ? fetch(`/reporting/histories/${historyId}/delivery-items-api/`)
        .then(response => response.ok ? response.json() : { success: false, items: [] })
        .catch(error => {
          return { success: false, items: [] };
        }) : Promise.resolve({ success: false, items: [] }),

      // Schedule DeliveryItem ê°€ì ¸ì˜¤ê¸°
      scheduleId ? fetch(`/reporting/schedules/${scheduleId}/delivery-items-api/`)
        .then(response => response.ok ? response.json() : { success: false, items: [] })
        .catch(error => {
          return { success: false, items: [] };
        }) : Promise.resolve({ success: false, items: [] })
    ])
    .then(([historyData, scheduleData]) => {
      const historyItems = (historyData.success && historyData.items) ? historyData.items : [];
      const scheduleItems = (scheduleData.success && scheduleData.items) ? scheduleData.items : [];
      const allItems = [...historyItems, ...scheduleItems];

      if (allItems.length > 0) {
        let totalAmount = 0;

        // í†µí•© í’ˆëª© ìƒíƒœ ì •ë³´ í‘œì‹œ
        let infoHtml = `
          <div class="alert alert-info mb-3">
            <i class="fas fa-info-circle me-2"></i>
            <strong>í†µí•© í’ˆëª© ë‚´ì—­</strong> - í™œë™ê¸°ë¡ê³¼ ì—°ê²°ëœ ì¼ì •ì˜ í’ˆëª©ë“¤ì´ í•¨ê»˜ í‘œì‹œë©ë‹ˆë‹¤.
            <br><small>History í’ˆëª© ${historyItems.length}ê°œ + Schedule í’ˆëª© ${scheduleItems.length}ê°œ</small>
          </div>
        `;

        let tableHtml = `
          ${infoHtml}
          <div class="table-responsive">
            <table class="table table-sm table-bordered">
              <thead class="table-primary">
                <tr>
                  <th>í’ˆëª©ëª…</th>
                  <th class="text-center">ìˆ˜ëŸ‰</th>
                  <th class="text-end">ë‹¨ê°€</th>
                  <th class="text-end">ì´ì•¡ (ë¶€ê°€ì„¸ í¬í•¨)</th>
                  <th class="text-center">ì„¸ê¸ˆê³„ì‚°ì„œ</th>
                </tr>
              </thead>
              <tbody>
        `;

        allItems.forEach(item => {
          const itemTotal = item.total_price || (item.quantity * item.unit_price * 1.1);
          totalAmount += itemTotal;

          tableHtml += `
            <tr>
              <td>${item.item_name || ''}</td>
              <td class="text-center">${item.quantity || 0}</td>
              <td class="text-end">${parseInt(item.unit_price || 0).toLocaleString()}ì›</td>
              <td class="text-end"><strong class="text-primary">${parseInt(itemTotal).toLocaleString()}ì›</strong></td>
              <td class="text-center">
                ${item.tax_invoice_issued
                  ? '<span class="badge bg-primary">ë°œí–‰ì™„ë£Œ</span>'
                  : '<span class="badge bg-secondary">ë¯¸ë°œí–‰</span>'}
              </td>
            </tr>
          `;
        });

        tableHtml += `
              </tbody>
              <tfoot class="table-secondary">
                <tr>
                  <th colspan="4" class="text-end">ì´ ê¸ˆì•¡:</th>
                  <th class="text-end text-success">${parseInt(totalAmount).toLocaleString()}ì›</th>
                </tr>
              </tfoot>
            </table>
          </div>
        `;

        contentDiv.innerHTML = tableHtml;
      } else {
        contentDiv.innerHTML = `
          <div class="text-center text-muted py-3">
            <i class="fas fa-box-open me-2"></i>í’ˆëª© ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.
            <br><small>History ID: ${historyId}, Schedule ID: ${scheduleId}</small>
          </div>
        `;
      }
    })
    .catch(error => {
      contentDiv.innerHTML = `
        <div class="text-center text-danger py-3">
          <i class="fas fa-exclamation-triangle me-2"></i>í†µí•© í’ˆëª© ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
          <br><small>${error.message}</small>
        </div>
      `;
    });
  }

  // Schedule ê¸°ë°˜ ë‚©í’ˆ í’ˆëª© ìƒì„¸ ëª¨ë‹¬ í‘œì‹œ í•¨ìˆ˜
  function showScheduleDeliveryItemsModal(scheduleId, deliveryDate) {
    // ë‚©í’ˆì¼ ì„¤ì •
    const deliveryDateElement = document.getElementById('deliveryDateText');
    if (deliveryDateElement) {
      deliveryDateElement.textContent = deliveryDate;
    }

    // Scheduleì˜ DeliveryItem ì •ë³´ë¥¼ ê°€ì ¸ì™€ì„œ í‘œì‹œ
    fetch(`/reporting/schedules/${scheduleId}/delivery-items-api/`)
      .then(response => response.json())
      .then(data => {
        const contentDiv = document.getElementById('modalDeliveryItems');

        if (!contentDiv) {
          return;
        }

        if (data.success && data.items && data.items.length > 0) {
          let totalAmount = 0;

          // ì¼ì • í’ˆëª© ì •ë³´ í‘œì‹œ
          let infoHtml = `
            <div class="alert alert-warning mb-3">
              <i class="fas fa-calendar-alt me-2"></i>
              <strong>ì¼ì • í’ˆëª© ë‚´ì—­</strong> - ë‚©í’ˆ ì¼ì •ì— ë“±ë¡ëœ í’ˆëª©ë“¤ì…ë‹ˆë‹¤.
            </div>
          `;

          let tableHtml = `
            ${infoHtml}
            <div class="table-responsive">
              <table class="table table-sm table-bordered">
                <thead class="table-warning">
                  <tr>
                    <th>í’ˆëª©ëª…</th>
                    <th class="text-center">ìˆ˜ëŸ‰</th>
                    <th class="text-end">ë‹¨ê°€</th>
                    <th class="text-end">ì´ì•¡ (ë¶€ê°€ì„¸ í¬í•¨)</th>
                    <th class="text-center">ì„¸ê¸ˆê³„ì‚°ì„œ</th>
                  </tr>
                </thead>
                <tbody>
          `;

          data.items.forEach(item => {
            const itemTotal = item.total_price || (item.quantity * item.unit_price * 1.1);
            totalAmount += itemTotal;

            tableHtml += `
              <tr>
                <td>${item.item_name || ''}</td>
                <td class="text-center">${item.quantity || 0}</td>
                <td class="text-end">${parseInt(item.unit_price || 0).toLocaleString()}ì›</td>
                <td class="text-end"><strong class="text-success">${parseInt(itemTotal).toLocaleString()}ì›</strong></td>
                <td class="text-center">
                  ${item.tax_invoice_issued
                    ? '<span class="badge bg-primary">ë°œí–‰ì™„ë£Œ</span>'
                    : '<span class="badge bg-secondary">ë¯¸ë°œí–‰</span>'}
                </td>
              </tr>
            `;
          });

          tableHtml += `
                </tbody>
                <tfoot class="table-secondary">
                  <tr>
                    <th colspan="4" class="text-end">ì´ ê¸ˆì•¡:</th>
                    <th class="text-end text-success">${parseInt(totalAmount).toLocaleString()}ì›</th>
                  </tr>
                </tfoot>
              </table>
            </div>
          `;

          contentDiv.innerHTML = tableHtml;
        } else {
          contentDiv.innerHTML = `
            <div class="text-center text-muted py-3">
              <i class="fas fa-calendar-times me-2"></i>ì¼ì • í’ˆëª© ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.
              ${data.error ? `<br><small class="text-danger">${data.error}</small>` : ''}
            </div>
          `;
        }
      })
      .catch(error => {
        const contentDiv = document.getElementById('modalDeliveryItems');
        if (contentDiv) {
          contentDiv.innerHTML = `
            <div class="text-center text-danger py-3">
              <i class="fas fa-exclamation-triangle me-2"></i>ì¼ì • í’ˆëª© ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
              <br><small>${error.message}</small>
            </div>
          `;
        }
      });

    // ëª¨ë‹¬ í‘œì‹œ
    const modalElement = document.getElementById('deliveryItemsModal');
    const modal = new bootstrap.Modal(modalElement);
    
    // ê°•ì œë¡œ z-indexì™€ pointer-events ì„¤ì •
    modalElement.style.cssText = 'z-index: 10000 !important; position: fixed !important;';
    
    // ë°±ë“œë¡­ ì²˜ë¦¬ë¥¼ ìœ„í•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    modalElement.addEventListener('show.bs.modal', function() {
      // ëª¨ë“  ì‚¬ì´ë“œë°”ì™€ ë„¤ë¹„ê²Œì´ì…˜ ìš”ì†Œë“¤ì˜ z-indexë¥¼ ë‚®ì¶¤
      const sidebarElements = document.querySelectorAll('.sidebar, #sidebar, .offcanvas, .navbar, nav');
      sidebarElements.forEach(el => {
        el.style.zIndex = '9998';
      });
    });
    
    modal.show();
    
    // ë°±ë“œë¡­ê³¼ ëª¨ë‹¬ ì»¨í…ì¸  ê°•ì œ ì¡°ì •
    setTimeout(() => {
      const backdrop = document.querySelector('.modal-backdrop');
      const dialog = modalElement.querySelector('.modal-dialog');
      const content = modalElement.querySelector('.modal-content');
      
      if (backdrop) {
        backdrop.style.cssText = 'z-index: 9999 !important; pointer-events: none !important;';
      }
      if (dialog) {
        dialog.style.cssText = 'z-index: 10001 !important; pointer-events: auto !important; position: relative !important;';
      }
      if (content) {
        content.style.cssText = 'z-index: 10002 !important; pointer-events: auto !important; position: relative !important;';
      }
      
      // ëª¨ë‹¬ì´ í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡ ê°•ì œ ì„¤ì •
      modalElement.style.pointerEvents = 'auto';
    }, 150);

    // ê°•ë ¥í•œ z-index í•´ê²°ë¡œ ë³€ê²½
    forceModalToFront('deliveryItemsModal');
  }

  // ì „ì²´ ë‚©í’ˆë‚´ì—­ ë°ì´í„° ì²˜ë¦¬ í•¨ìˆ˜
  async function processAllDeliveryData() {
    try {
      // ì„œë²„ì—ì„œ ì „ë‹¬ëœ í†µí•© ë‚©í’ˆ ë°ì´í„°
      let integratedDeliveryData = [];
      try {
        // Djangoì˜ json_scriptë¥¼ í†µí•œ ì•ˆì „í•œ JSON ë°ì´í„° ì „ë‹¬
        const jsonElement = document.getElementById('integrated-deliveries-data');
        if (jsonElement && jsonElement.textContent) {
          integratedDeliveryData = JSON.parse(jsonElement.textContent);
        }
      } catch (error) {
        integratedDeliveryData = [];
      }

      // í’ˆëª©ë³„ ì§‘ê³„ ê°ì²´
      const itemsSummary = {};
      let totalItemsCount = 0;

    // í†µí•© ë‚©í’ˆ ë°ì´í„° ì²˜ë¦¬
    for (const delivery of integratedDeliveryData) {
      // has_schedule_itemsê°€ trueì´ê±°ë‚˜ scheduleIdê°€ ìˆëŠ” ê²½ìš° Scheduleë§Œ ì²˜ë¦¬
      if ((delivery.has_schedule_items || delivery.type === 'schedule_only') && delivery.scheduleId) {
        // Schedule DeliveryItemë§Œ ì²˜ë¦¬
        try {
          const response = await fetch(`/reporting/schedules/${delivery.scheduleId}/delivery-items-api/`);
          if (response.ok) {
            const data = await response.json();
            const scheduleItems = data.items || [];

            if (scheduleItems.length > 0) {
              scheduleItems.forEach(item => {
                const itemName = item.item_name; // ì¤‘ë³µ ë°©ì§€ë¥¼ ìœ„í•´ êµ¬ë¶„ ì—†ì´ ì²˜ë¦¬
                const quantity = parseFloat(item.quantity || 0);
                const amount = Math.round(item.total_price || 0);

                if (!itemsSummary[itemName]) {
                  itemsSummary[itemName] = {
                    totalQuantity: 0,
                    totalAmount: 0,
                    deliveryCount: 0
                  };
                }

                itemsSummary[itemName].totalQuantity += quantity;
                itemsSummary[itemName].totalAmount += amount;
                itemsSummary[itemName].deliveryCount += 1;
                totalItemsCount += quantity;
              });
            }
          }
        } catch (error) {
          // Schedule DeliveryItem ì²˜ë¦¬ ì‹¤íŒ¨ ì‹œ ë¬´ì‹œ
        }
      }
      // Scheduleì´ ì—†ëŠ” Historyë§Œ ìˆëŠ” ê²½ìš°ì—ë§Œ History ì²˜ë¦¬
      else if (delivery.type === 'history' && delivery.items && delivery.items.trim() && !delivery.has_schedule_items && !delivery.scheduleId) {
        processDeliveryItemsText(delivery.items, itemsSummary);
      }
    }

    // ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸ (ìš”ì†Œ ì¡´ì¬ í™•ì¸)
    const totalItemsCountElement = document.getElementById('totalItemsCount');
    if (totalItemsCountElement) {
      totalItemsCountElement.textContent = Math.round(totalItemsCount).toLocaleString();
    }
    
    // ë°±ì—”ë“œì—ì„œ ê³„ì‚°í•œ ì •í™•í•œ ì´ì•¡ ì‚¬ìš© (ì¤‘ë³µ ê³„ì‚° ë°©ì§€)
    const totalAmountFromServer = {{ total_amount|default:0 }};
    const totalDeliveryAmountElement = document.getElementById('totalDeliveryAmount');
    if (totalDeliveryAmountElement) {
      totalDeliveryAmountElement.textContent = totalAmountFromServer.toLocaleString();
    }

    // í…Œì´ë¸” ìƒì„±
    const tableBody = document.getElementById('allDeliveryItemsTable');
    if (Object.keys(itemsSummary).length > 0) {
      const tableRows = Object.entries(itemsSummary).map(([itemName, data]) => `
        <tr>
          <td>
            <i class="fas fa-box me-2 text-info"></i>
            ${itemName}
          </td>
          <td class="text-center">
            <span class="badge bg-primary">${Math.round(data.totalQuantity).toLocaleString()}ê°œ</span>
          </td>
          <td class="text-end">
            <strong class="text-success">${data.totalAmount.toLocaleString()}ì›</strong>
          </td>
          <td class="text-center">
            <span class="badge bg-secondary">${data.deliveryCount}íšŒ</span>
          </td>
        </tr>
      `).join('');

      if (tableBody) {
        tableBody.innerHTML = tableRows;
      }
    } else {
      if (tableBody) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="4" class="text-center text-muted py-3">
              <i class="fas fa-box-open me-2"></i>í’ˆëª© ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.
            </td>
          </tr>
        `;
      }
    }
    } catch (error) {
      
      // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ê°’ ì„¤ì •
      const totalItemsCountElement = document.getElementById('totalItemsCount');
      if (totalItemsCountElement) {
        totalItemsCountElement.textContent = '0';
      }
      
      const totalDeliveryAmountElement = document.getElementById('totalDeliveryAmount');
      if (totalDeliveryAmountElement) {
        const totalAmountFromServer = {{ total_amount|default:0 }};
        totalDeliveryAmountElement.textContent = totalAmountFromServer.toLocaleString();
      }
      
      const tableBody = document.getElementById('allDeliveryItemsTable');
      if (tableBody) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="4" class="text-center text-muted py-3">
              <i class="fas fa-exclamation-triangle me-2"></i>í’ˆëª© ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
            </td>
          </tr>
        `;
      }
    }
  }

  // History delivery_items í…ìŠ¤íŠ¸ íŒŒì‹± í•¨ìˆ˜
  function processDeliveryItemsText(itemsText, itemsSummary) {
    // ì¤„ë°”ê¿ˆ ë¬¸ì ì²˜ë¦¬
    let processedItems = itemsText
      .replace(/\\n/g, '\n')
      .replace(/\\r\\n/g, '\n')
      .replace(/\\r/g, '\n')
      .replace(/\r\n/g, '\n')
      .replace(/\r/g, '\n')
      .trim();

    // ê° ë¼ì¸ ì²˜ë¦¬
    const lines = processedItems.split('\n')
      .map(line => line.trim())
      .filter(line => line);

    lines.forEach(line => {
      // "í’ˆëª©ëª…: ìˆ˜ëŸ‰ê°œ (ê¸ˆì•¡ì›)" íŒ¨í„´ íŒŒì‹±
      const match = line.match(/^(.+?):\s*(\d+(?:\.\d+)?)ê°œ\s*\((.+?)ì›\)$/);
      if (match) {
        const itemName = match[1].trim();
        const quantity = parseFloat(match[2]);
        const amountStr = match[3].replace(/[,\s]/g, '');
        const amount = parseInt(amountStr);

        if (!itemsSummary[itemName]) {
          itemsSummary[itemName] = {
            totalQuantity: 0,
            totalAmount: 0,
            deliveryCount: 0
          };
        }

        itemsSummary[itemName].totalQuantity += quantity;
        itemsSummary[itemName].totalAmount += amount;
        itemsSummary[itemName].deliveryCount += 1;

        // ì „ì—­ totalItemsCountì—ë„ ì¶”ê°€
        totalItemsCount += quantity;
      }
    });
  }

  // Schedule ê¸°ë°˜ ë‚©í’ˆ í’ˆëª© ìƒì„¸ ëª¨ë‹¬ í‘œì‹œ í•¨ìˆ˜
  // íƒ­ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
  document.addEventListener('DOMContentLoaded', function() {
    const allDeliveryTab = document.getElementById('all-delivery-tab');
    if (allDeliveryTab) {
      allDeliveryTab.addEventListener('shown.bs.tab', function() {
        try {
          processAllDeliveryData();
        } catch (error) {
        }
      });
    }

    // ì „ì²´ íƒ€ì„ë¼ì¸ íƒ­ ì´ë²¤íŠ¸
    const timelineTab = document.getElementById('timeline-tab');
    if (timelineTab) {
      timelineTab.addEventListener('shown.bs.tab', function() {
        try {
          enhanceTimelineWithScheduleData();
        } catch (error) {
        }
      });
    }
  });

  // ì „ì²´ íƒ€ì„ë¼ì¸ì— Schedule DeliveryItem ì •ë³´ ì¶”ê°€
  async function enhanceTimelineWithScheduleData() {
    // í†µí•© ë‚©í’ˆ ë°ì´í„°ì—ì„œ has_schedule_items ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ê¸°
    let integratedDeliveryData = [];
    try {
      const jsonElement = document.getElementById('integrated-deliveries-data');
      if (jsonElement) {
        integratedDeliveryData = JSON.parse(jsonElement.textContent);
      }
    } catch (error) {
      integratedDeliveryData = [];
    }

    // historyIdë³„ has_schedule_items ë§¤í•‘ ìƒì„±
    const hasScheduleItemsMap = {};
    integratedDeliveryData.forEach(delivery => {
      if (delivery.id && delivery.type === 'history') {
        hasScheduleItemsMap[delivery.id] = delivery.has_schedule_items;
      }
    });

    // ëª¨ë“  ë‚©í’ˆ ì¼ì • íƒ€ì…ì˜ íƒ€ì„ë¼ì¸ ì•„ì´í…œë“¤ ì°¾ê¸°
    const deliveryTimelineItems = document.querySelectorAll('.timeline-item[data-history-id]');

    for (const item of deliveryTimelineItems) {
      const historyId = item.getAttribute('data-history-id');
      const scheduleId = item.getAttribute('data-schedule-id');
      const deliveryDetails = item.querySelector('.delivery-details');

      if (!deliveryDetails) {
        continue; // ë‚©í’ˆ ì¼ì •ì´ ì•„ë‹ˆë©´ ê±´ë„ˆë›°ê¸°
      }

      // has_schedule_items í™•ì¸
      const hasScheduleItems = hasScheduleItemsMap[historyId] || false;

      // ê¸°ì¡´ ë‚©í’ˆ ì •ë³´ë¥¼ êµ¬ì¡°í™”ëœ í˜•íƒœë¡œ ë³€í™˜
      // CSS :contains() selectorëŠ” í‘œì¤€ì´ ì•„ë‹ˆë¯€ë¡œ ë‹¤ë¥¸ ë°©ì‹ìœ¼ë¡œ ìš”ì†Œ ì°¾ê¸°
      const allPElements = deliveryDetails.querySelectorAll('p');
      let amountText = '';
      let itemsText = '';
      let dateText = '';

      allPElements.forEach(p => {
        const text = p.textContent;
        if (text.includes('ê¸ˆì•¡:')) {
          amountText = text.replace('ê¸ˆì•¡:', '').replace('ì›', '').trim();
        } else if (text.includes('í’ˆëª©:')) {
          itemsText = text.replace('í’ˆëª©:', '').trim();
        } else if (text.includes('ë‚©í’ˆì¼:')) {
          dateText = text.replace('ë‚©í’ˆì¼:', '').trim();
        }
      });

      // History DeliveryItem íŒŒì‹± ë° í‘œì‹œ (has_schedule_itemsê°€ falseì¸ ê²½ìš°ì—ë§Œ)
      let historyItemsHtml = '';
      if (itemsText && !hasScheduleItems) {
        // í’ˆëª© í…ìŠ¤íŠ¸ íŒŒì‹± ("í’ˆëª©ëª…: ìˆ˜ëŸ‰ê°œ (ê¸ˆì•¡ì›)" í˜•íƒœ)
        const historyItems = parseDeliveryItemsText(itemsText);

        if (historyItems.length > 0) {
          let totalHistoryAmount = 0;

          historyItems.forEach(historyItem => {
            totalHistoryAmount += historyItem.amount;
            historyItemsHtml += `
              <div class="history-delivery-item mb-2 p-2 bg-light rounded border-start border-info border-3">
                <div class="row align-items-center">
                  <div class="col-md-8">
                    <div>
                      <strong class="text-primary">${historyItem.name}</strong>
                      <span class="text-muted ms-2">${historyItem.quantity}ê°œ</span>
                    </div>
                    <div class="small text-muted">
                      ì´ì•¡: <strong class="text-success">${historyItem.amount.toLocaleString()}ì›</strong>
                    </div>
                  </div>
                  <div class="col-md-4 text-end">
                    <span class="badge bg-info">í™œë™ê¸°ë¡</span>
                  </div>
                </div>
              </div>
            `;
          });

          if (totalHistoryAmount > 0) {
            historyItemsHtml += `
              <div class="border-top pt-2 mt-2 mb-3">
                <div class="row">
                  <div class="col text-end">
                    <small class="text-muted">í™œë™ê¸°ë¡ í’ˆëª© ì´ì•¡: </small>
                    <strong class="text-success fs-6">${totalHistoryAmount.toLocaleString()}ì›</strong>
                  </div>
                </div>
              </div>
            `;
          }
        }
      }

      // Schedule DeliveryItem ê°€ì ¸ì˜¤ê¸° ë° í‘œì‹œ (has_schedule_itemsê°€ trueì¸ ê²½ìš°ì—ë§Œ)
      let scheduleItemsHtml = '';
      if (scheduleId && hasScheduleItems) {
        try {
          const response = await fetch(`/reporting/schedules/${scheduleId}/delivery-items-api/`);
          if (response.ok) {
            const data = await response.json();
            const scheduleItems = data.items || [];

            if (scheduleItems.length > 0) {
              let totalScheduleAmount = 0;

              scheduleItems.forEach(item => {
                const itemTotal = Math.round(item.total_price || 0);
                totalScheduleAmount += itemTotal;

                scheduleItemsHtml += `
                  <div class="schedule-delivery-item mb-2 p-2 bg-light rounded border-start border-warning border-3">
                    <div class="row align-items-center">
                      <div class="col-md-8">
                        <div>
                          <strong class="text-primary">${item.item_name}</strong>
                          <span class="text-muted ms-2">${item.quantity}ê°œ</span>
                        </div>
                        <div class="small text-muted">
                          ë‹¨ê°€: ${parseInt(item.unit_price || 0).toLocaleString()}ì›
                          | ì´ì•¡: <strong class="text-success">${itemTotal.toLocaleString()}ì›</strong>
                        </div>
                      </div>
                      <div class="col-md-4 text-end">
                        ${item.tax_invoice_issued
                          ? '<span class="badge bg-primary">ì„¸ê¸ˆê³„ì‚°ì„œ ë°œí–‰</span>'
                          : '<span class="badge bg-secondary">ì„¸ê¸ˆê³„ì‚°ì„œ ë¯¸ë°œí–‰</span>'}
                        <div class="small text-muted mt-1">
                          <i class="fas fa-calendar me-1"></i>ì¼ì •ì—ì„œ ì¶”ê°€
                        </div>
                      </div>
                    </div>
                  </div>
                `;
              });

              if (totalScheduleAmount > 0) {
                scheduleItemsHtml += `
                  <div class="border-top pt-2 mt-2">
                    <div class="row">
                      <div class="col text-end">
                        <small class="text-muted">ì¼ì • í’ˆëª© ì´ì•¡: </small>
                        <strong class="text-success fs-6">${totalScheduleAmount.toLocaleString()}ì›</strong>
                      </div>
                    </div>
                  </div>
                `;
              }
            }
          }
        } catch (error) {
          // Schedule ì²˜ë¦¬ ì‹¤íŒ¨ ì‹œ ë¬´ì‹œ
        }
      }

      // ê¸°ì¡´ ë‚©í’ˆ ì •ë³´ë¥¼ êµ¬ì¡°í™”ëœ í˜•íƒœë¡œ êµì²´
      if (historyItemsHtml || scheduleItemsHtml) {
        const enhancedDeliveryHtml = `
          <div class="enhanced-delivery-section">
            ${historyItemsHtml ? `
              <div class="history-items-section mb-3">
                <h6 class="text-muted mb-2">
                  <i class="fas fa-history me-1"></i>í™œë™ê¸°ë¡ ë‚©í’ˆ í’ˆëª©
                </h6>
                ${historyItemsHtml}
              </div>
            ` : ''}

            ${scheduleItemsHtml ? `
              <div class="schedule-items-section">
                <h6 class="text-muted mb-2">
                  <i class="fas fa-calendar-plus me-1"></i>ì¼ì • ë‚©í’ˆ í’ˆëª©
                </h6>
                ${scheduleItemsHtml}
              </div>
            ` : ''}
          </div>
        `;

        deliveryDetails.innerHTML = enhancedDeliveryHtml;
      } else if (hasScheduleItems && !scheduleId) {
        // has_schedule_itemsëŠ” trueì´ì§€ë§Œ scheduleIdê°€ ì—†ëŠ” ê²½ìš° ë©”ì‹œì§€ í‘œì‹œ
        const noScheduleHtml = `
          <div class="enhanced-delivery-section">
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle me-2"></i>
              ì—°ê²°ëœ ì¼ì • ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
            </div>
          </div>
        `;
        deliveryDetails.innerHTML = noScheduleHtml;
      }
    }
  }

  // ë‚©í’ˆ í’ˆëª© í…ìŠ¤íŠ¸ íŒŒì‹± í•¨ìˆ˜
  function parseDeliveryItemsText(itemsText) {
    const items = [];

    // ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„ëœ í’ˆëª©ë“¤ ì²˜ë¦¬
    const lines = itemsText.split('\n').map(line => line.trim()).filter(line => line);

    lines.forEach(line => {
      // "í’ˆëª©ëª…: ìˆ˜ëŸ‰ê°œ (ê¸ˆì•¡ì›)" íŒ¨í„´ íŒŒì‹±
      const match = line.match(/^(.+?):\s*(\d+(?:\.\d+)?)ê°œ\s*\((.+?)ì›\)$/);
      if (match) {
        const name = match[1].trim();
        const quantity = parseFloat(match[2]);
        const amountStr = match[3].replace(/[,\s]/g, '');
        const amount = parseInt(amountStr) || 0;

        items.push({
          name: name,
          quantity: quantity,
          amount: amount
        });
      }
    });

    return items;
  }
</script>

<style>
  .delivery-items-content {
    max-height: 400px;
    overflow-y: auto;
  }

  .delivery-item {
    border-left: 4px solid #17a2b8 !important;
    background-color: #f8f9fa !important;
  }

  .delivery-item:hover {
    background-color: #e9ecef !important;
    transition: background-color 0.2s ease;
  }

  /* ë‚©í’ˆ ë‚´ì—­ í…Œì´ë¸” ì»´íŒ©íŠ¸ ìŠ¤íƒ€ì¼ */
  .table-compact td {
    padding: 0.5rem 0.75rem !important;
    line-height: 1.2 !important;
    font-size: 0.9rem !important;
    white-space: nowrap;
    vertical-align: middle;
  }

  .table-compact th {
    padding: 0.75rem !important;
    font-size: 0.9rem !important;
    font-weight: 600;
    white-space: nowrap;
  }

  .table-compact .btn-sm {
    font-size: 0.8rem !important;
    padding: 0.25rem 0.5rem !important;
  }

  .table-compact .badge {
    font-size: 0.75rem !important;
  }

  .table-compact .text-success {
    font-size: 0.9rem !important;
  }

  /* í´ë¦­ ê°€ëŠ¥í•œ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
  .clickable-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    transition: all 0.3s ease;
  }

  /* ì „ì²´ ë‚©í’ˆ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
  .all-delivery-items-content {
    max-height: 70vh;
    overflow-y: auto;
  }

  .delivery-record {
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .delivery-record-header {
    background-color: #f8f9fa !important;
    border-bottom: 2px solid #dee2e6;
  }

  .delivery-item-card {
    border-left: 4px solid #17a2b8 !important;
    background-color: #f8f9fa !important;
    transition: background-color 0.2s ease;
  }

  .delivery-item-card:hover {
    background-color: #e9ecef !important;
  }
</style>

<!-- ì„¸ê¸ˆê³„ì‚°ì„œ í¸ì§‘ ëª¨ë‹¬ -->
<div
  class="modal fade"
  id="taxInvoiceModal"
  tabindex="-1"
  aria-labelledby="taxInvoiceModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="taxInvoiceModalLabel">
          <i class="fas fa-file-invoice me-2"></i>ì„¸ê¸ˆê³„ì‚°ì„œ ìƒíƒœ í¸ì§‘
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div id="taxInvoiceContent">
          <!-- ë™ì ìœ¼ë¡œ ë‚´ìš©ì´ ì±„ì›Œì§ -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          ì·¨ì†Œ
        </button>
        <button type="button" class="btn btn-primary" id="saveTaxInvoiceBtn">
          <i class="fas fa-save me-1"></i>ì €ì¥
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // CSRF í† í° ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  document.addEventListener("DOMContentLoaded", function () {
    console.log('ì„¸ê¸ˆê³„ì‚°ì„œ í† ê¸€ ì´ë²¤íŠ¸ ë“±ë¡ ì‹œì‘');
    console.log('í† ê¸€ ìš”ì†Œ ê°œìˆ˜:', document.querySelectorAll(".tax-invoice-toggle").length);
    
    // ì„¸ê¸ˆê³„ì‚°ì„œ ìƒíƒœ ì¼ê´„ í† ê¸€ (ë‚©í’ˆì¼ë³„)
    document
      .querySelectorAll(".tax-invoice-toggle")
      .forEach(function (element) {
        console.log('í† ê¸€ ìš”ì†Œ ë“±ë¡:', element);
        element.addEventListener("click", function (e) {
          e.preventDefault();
          e.stopPropagation();
          
          console.log('í† ê¸€ í´ë¦­ë¨:', this);
          
          const type = this.dataset.type;
          const id = this.dataset.id;
          const scheduleId = this.dataset.scheduleId;
          const badge = this.querySelector(".badge");
          const currentStatus = badge ? badge.classList.contains("bg-primary") : false;

          console.log('type:', type, 'id:', id, 'currentStatus:', currentStatus);

          // í™•ì¸ ë©”ì‹œì§€
          const statusText = currentStatus ? "ë¯¸ë°œí–‰" : "ë°œí–‰ì™„ë£Œ";
          let message;

          if (type === "history") {
            message = `ì´ ë‚©í’ˆì¼ì˜ ëª¨ë“  í’ˆëª©ì„ "${statusText}"ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
          } else if (type === "schedule_bulk") {
            message = `ì´ ì¼ì •ì˜ ëª¨ë“  í’ˆëª©ì„ "${statusText}"ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
          } else {
            message = `ëª¨ë“  í’ˆëª©ì„ "${statusText}"ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
          }

          if (confirm(message)) {
            updateTaxInvoiceStatus(type, id, !currentStatus);
          }
        });
      });

    // ì„¸ê¸ˆê³„ì‚°ì„œ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateTaxInvoiceStatus(type, id, status) {
      console.log('updateTaxInvoiceStatus í˜¸ì¶œ:', type, id, status);
      
      // ë¡œë”© í‘œì‹œ
      const loadingText = status ? "ë°œí–‰ ì²˜ë¦¬ì¤‘..." : "ë¯¸ë°œí–‰ ì²˜ë¦¬ì¤‘...";
      const loadingDiv = document.createElement("div");
      loadingDiv.className = "alert alert-info";
      loadingDiv.textContent = loadingText;
      document.body.appendChild(loadingDiv);

      console.log('fetch ìš”ì²­ ì‹œì‘:', '{% url "reporting:update_tax_invoice_status" %}');
      fetch('{% url "reporting:update_tax_invoice_status" %}', {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie('csrftoken'),
        },
        body: JSON.stringify({
          type: type,
          id: parseInt(id),
          tax_invoice_issued: status,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            // ì„±ê³µ ë©”ì‹œì§€ì™€ í•¨ê»˜ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
            if (data.updated_count) {
              alert(
                `ì„±ê³µ: ${data.updated_count}ê°œ í’ˆëª©ì˜ ì„¸ê¸ˆê³„ì‚°ì„œ ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`
              );
            } else {
              alert("ì„¸ê¸ˆê³„ì‚°ì„œ ìƒíƒœê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
            window.location.reload();
          } else {
            if (data.error.includes("ê¶Œí•œ")) {
              alert(
                "ê¶Œí•œ ì˜¤ë¥˜: ë§¤ë‹ˆì € ê³„ì •ì€ ì„¸ê¸ˆê³„ì‚°ì„œë¥¼ í¸ì§‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìë‚˜ ì˜ì—…ì‚¬ì›ì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”."
              );
            } else {
              alert("ì˜¤ë¥˜: " + data.error);
            }
          }
        })
        .catch((error) => {
          if (error.message.includes("403")) {
            alert("ê¶Œí•œ ì˜¤ë¥˜: ë§¤ë‹ˆì € ê³„ì •ì€ ì„¸ê¸ˆê³„ì‚°ì„œë¥¼ í¸ì§‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          } else {
            alert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          }
        })
        .finally(() => {
          // ë¡œë”© í‘œì‹œ ì œê±°
          if (loadingDiv.parentNode) {
            loadingDiv.parentNode.removeChild(loadingDiv);
          }
        });
    }

    // Schedule íƒ€ì… ì„¸ê¸ˆê³„ì‚°ì„œ í¸ì§‘ í•¨ìˆ˜
    window.editScheduleTaxInvoice = function (scheduleId) {
      fetch(`/reporting/api/schedules/${scheduleId}/delivery-items/`)
        .then((response) => {
          if (response.status === 403) {
            alert("ê¶Œí•œ ì˜¤ë¥˜: ë§¤ë‹ˆì € ê³„ì •ì€ ì„¸ê¸ˆê³„ì‚°ì„œë¥¼ í¸ì§‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }
          return response.json();
        })
        .then((data) => {
          if (data && data.success) {
            showScheduleTaxModal(scheduleId, data.items);
          } else if (data) {
            if (data.error && data.error.includes("ê¶Œí•œ")) {
              alert(
                "ê¶Œí•œ ì˜¤ë¥˜: ë§¤ë‹ˆì € ê³„ì •ì€ ì„¸ê¸ˆê³„ì‚°ì„œë¥¼ í¸ì§‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              );
            } else {
              alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
          }
        })
        .catch((error) => {
          alert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        });
    };

    // Schedule ì„¸ê¸ˆê³„ì‚°ì„œ ëª¨ë‹¬ í‘œì‹œ
    function showScheduleTaxModal(scheduleId, items) {
      const modalContent = document.getElementById("taxInvoiceContent");

      let html = `<h6 class="mb-3">ë‚©í’ˆ í’ˆëª©ë³„ ì„¸ê¸ˆê³„ì‚°ì„œ ìƒíƒœ</h6>`;
      html += `<div class="delivery-items-list">`;

      items.forEach((item) => {
        html += `
                <div class="border rounded p-3 mb-3">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <strong>${item.item_name}</strong>
                            <br><small class="text-muted">ìˆ˜ëŸ‰: ${
                              item.quantity
                            }ê°œ, ë‹¨ê°€: ${item.unit_price.toLocaleString()}ì›</small>
                            <br><small class="text-success">ì´ì•¡: ${item.total_price.toLocaleString()}ì›</small>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" 
                                       id="tax_${item.id}" 
                                       data-item-id="${item.id}"
                                       ${
                                         item.tax_invoice_issued
                                           ? "checked"
                                           : ""
                                       }>
                                <label class="form-check-label" for="tax_${
                                  item.id
                                }">
                                    ì„¸ê¸ˆê³„ì‚°ì„œ ë°œí–‰
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            `;
      });

      html += `</div>`;
      modalContent.innerHTML = html;

      // ëª¨ë‹¬ í‘œì‹œ
      const modal = new bootstrap.Modal(
        document.getElementById("taxInvoiceModal")
      );
      modal.show();

      // ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸
      document.getElementById("saveTaxInvoiceBtn").onclick = function () {
        saveBatchTaxInvoiceStatus();
      };
    }

    // ì¼ê´„ ì„¸ê¸ˆê³„ì‚°ì„œ ìƒíƒœ ì €ì¥
    function saveBatchTaxInvoiceStatus() {
      const checkboxes = document.querySelectorAll(
        '#taxInvoiceContent input[type="checkbox"]'
      );
      const updates = [];

      checkboxes.forEach((checkbox) => {
        updates.push({
          type: "delivery_item",
          id: parseInt(checkbox.dataset.itemId),
          tax_invoice_issued: checkbox.checked,
        });
      });

      Promise.all(
        updates.map((update) =>
          fetch('{% url "reporting:update_tax_invoice_status" %}', {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": document.querySelector(
                "[name=csrfmiddlewaretoken]"
              ).value,
            },
            body: JSON.stringify(update),
          }).then((response) => response.json())
        )
      )
        .then((responses) => {
          const hasError = responses.some((response) => !response.success);
          if (hasError) {
            alert("ì¼ë¶€ í•­ëª© ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          } else {
            // ëª¨ë‹¬ ë‹«ê¸° ë° í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
            bootstrap.Modal.getInstance(
              document.getElementById("taxInvoiceModal")
            ).hide();
            window.location.reload();
          }
        })
        .catch((error) => {
          alert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        });
    }
  });

  // ëª¨ë‹¬ z-index ë¬¸ì œ í•´ê²°ì„ ìœ„í•œ ì „ì—­ í•¨ìˆ˜
  function forceModalToFront(modalId) {
    
    // ê¸°ì¡´ ë°±ë“œë¡­ ì •ë¦¬
    const existingBackdrops = document.querySelectorAll('.modal-backdrop');
    if (existingBackdrops.length > 0) {
      existingBackdrops.forEach(backdrop => backdrop.remove());
    }
    
    const modalElement = document.getElementById(modalId);
    if (!modalElement) {
      return;
    }
    
    
    // ëª¨ë“  ë‹¤ë¥¸ ìš”ì†Œë“¤ì˜ z-indexë¥¼ ë‚®ì¶¤
    const elementsToLower = document.querySelectorAll('.sidebar, #sidebar, .offcanvas, .navbar, nav, .header');
    
    elementsToLower.forEach((el, index) => {
      el.style.zIndex = '9998';
    });
    
    // ëª¨ë‹¬ ìì²´ì˜ z-index ìµœê³ ë¡œ ì„¤ì •
    modalElement.style.cssText = 'z-index: 10000 !important; position: fixed !important;';
    
    // ëª¨ë‹¬ì´ í‘œì‹œëœ í›„ ë°±ë“œë¡­ ì²˜ë¦¬
    let checkCount = 0;
    const checkModal = setInterval(() => {
      checkCount++;
      
      const backdrop = document.querySelector('.modal-backdrop');
      const dialog = modalElement.querySelector('.modal-dialog');
      const content = modalElement.querySelector('.modal-content');
      
      
      if (backdrop) {
        backdrop.style.cssText = 'z-index: 9999 !important; pointer-events: none !important;';
        
        dialog.style.cssText = 'z-index: 10001 !important; pointer-events: auto !important; position: relative !important;';
        
        content.style.cssText = 'z-index: 10002 !important; pointer-events: auto !important; position: relative !important;';
        
        // ëª¨ë‹¬ ì „ì²´ì— í´ë¦­ ì´ë²¤íŠ¸ í™œì„±í™”
        modalElement.style.pointerEvents = 'auto';
        
        // í´ë¦­ ì´ë²¤íŠ¸ í…ŒìŠ¤íŠ¸ ì¶”ê°€
        
        // ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        modalElement.addEventListener('hidden.bs.modal', function() {
          
          // ëª¨ë“  ë°±ë“œë¡­ ì œê±°
          const allBackdrops = document.querySelectorAll('.modal-backdrop');
          allBackdrops.forEach(backdrop => {
            backdrop.remove();
          });
          
          // body í´ë˜ìŠ¤ ì •ë¦¬
          document.body.classList.remove('modal-open');
          document.body.style.overflow = '';
          document.body.style.paddingRight = '';
          
          // ë‹¤ë¥¸ ìš”ì†Œë“¤ì˜ z-index ë³µì›
          document.querySelectorAll('.sidebar, #sidebar, .offcanvas, .navbar, nav').forEach(el => {
            el.style.zIndex = '';
          });
          
        });
        
        // ëª¨ë“  ëª¨ë‹¬ ë‚´ë¶€ ìš”ì†Œë“¤ì— í´ë¦­ ì´ë²¤íŠ¸ í™•ì¸
        const allModalElements = modalElement.querySelectorAll('*');
        allModalElements.forEach((el, index) => {
          if (el.tagName === 'BUTTON') {
            el.addEventListener('click', function(e) {
            });
          }
        });
        
        // ëª¨ë‹¬ ë°±ë“œë¡­ í´ë¦­ í…ŒìŠ¤íŠ¸
        if (backdrop) {
          backdrop.addEventListener('click', function(e) {
          });
        }
        
        // ëª¨ë‹¬ ë‹¤ì´ì–¼ë¡œê·¸ í´ë¦­ í…ŒìŠ¤íŠ¸
        dialog.addEventListener('click', function(e) {
        });
        
        // ëª¨ë‹¬ ì»¨í…ì¸  í´ë¦­ í…ŒìŠ¤íŠ¸
        content.addEventListener('click', function(e) {
        });
        
        
        clearInterval(checkModal);
      }
      
      // ìµœëŒ€ 100íšŒ ì²´í¬ í›„ ì¤‘ë‹¨
      if (checkCount >= 100) {
        clearInterval(checkModal);
      }
    }, 50);
    
    // 5ì´ˆ í›„ ê°•ì œ ì¢…ë£Œ
    setTimeout(() => {
      clearInterval(checkModal);
    }, 5000);
  }

  // ëª¨ë‹¬ ê°•ì œ ë‹«ê¸° í•¨ìˆ˜
  function forceCloseModal(modalId) {
    
    const modalElement = document.getElementById(modalId);
    if (modalElement) {
      // Bootstrap ëª¨ë‹¬ ì¸ìŠ¤í„´ìŠ¤ ì°¾ì•„ì„œ ë‹«ê¸°
      const modalInstance = bootstrap.Modal.getInstance(modalElement);
      if (modalInstance) {
        modalInstance.hide();
      }
      
      // ê°•ì œë¡œ ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
      modalElement.style.display = 'none';
      modalElement.classList.remove('show');
      modalElement.setAttribute('aria-hidden', 'true');
      modalElement.removeAttribute('aria-modal');
      
      // ëª¨ë“  ë°±ë“œë¡­ ì œê±°
      document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
        backdrop.remove();
      });
      
      // body ìƒíƒœ ë³µì›
      document.body.classList.remove('modal-open');
      document.body.style.overflow = '';
      document.body.style.paddingRight = '';
      
    }
  }

  function ensureModalVisibility(modalElement) {
    if (!modalElement) return;
    
    // ëª¨ë‹¬ê³¼ backdropì˜ z-indexë¥¼ ê°•ì œ ì„¤ì •
    modalElement.style.zIndex = '10000';
    modalElement.style.display = 'block';
    
    // backdropì´ ìƒì„±ëœ í›„ ì²˜ë¦¬
    setTimeout(() => {
      const backdrop = document.querySelector('.modal-backdrop');
      if (backdrop) {
        backdrop.style.zIndex = '9999';
      }
      
      // ëª¨ë‹¬ ì»¨í…ì¸  ì˜ì—­ í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
      const modalDialog = modalElement.querySelector('.modal-dialog');
      if (modalDialog) {
        modalDialog.style.pointerEvents = 'auto';
        modalDialog.style.zIndex = '10001';
      }
      
      const modalContent = modalElement.querySelector('.modal-content');
      if (modalContent) {
        modalContent.style.pointerEvents = 'auto';
        modalContent.style.zIndex = '10002';
      }
    }, 100);
  }
  
  // í˜ì´ì§€ ë¡œë“œ ì‹œ ìƒíƒœ í™•ì¸
  document.addEventListener('DOMContentLoaded', function() {
    
    // ëª¨ë‹¬ ìš”ì†Œ í™•ì¸
    const modal = document.getElementById('deliveryItemsModal');
    
    // ì‚¬ì´ë“œë°” ìš”ì†Œë“¤ í™•ì¸
    const sidebarElements = document.querySelectorAll('.sidebar, #sidebar, .offcanvas, .navbar, nav');
    
    sidebarElements.forEach((el, index) => {
      const computedStyle = window.getComputedStyle(el);
    });
    
    // Bootstrap ë²„ì „ í™•ì¸
    
    // í…ŒìŠ¤íŠ¸ ë²„íŠ¼ í™•ì¸
    const testBtn = document.querySelector('.test-modal-btn');
    
    // ESC í‚¤ë¡œ ëª¨ë‹¬ ê°•ì œ ë‹«ê¸°
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        forceCloseModal('deliveryItemsModal');
      }
    });
  });
</script>

{% csrf_token %} {% endblock %}
