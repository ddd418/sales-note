{% extends 'reporting/base.html' %}
{% load static %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
    @keyframes fadeInDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .page-header-gradient {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        color: white;
        padding: 2.5rem;
        border-radius: 20px;
        box-shadow: 0 8px 25px rgba(23, 162, 184, 0.3);
        animation: fadeInDown 0.6s ease-out;
    }
    
    .analytics-card {
        border-radius: 20px;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.08);
        background: white;
        margin-bottom: 20px;
        padding: 1.5rem;
        border: 1px solid #f0f0f0;
        transition: all 0.3s ease;
        overflow: hidden;
        position: relative;
    }
    
    .analytics-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, #17a2b8 0%, #138496 100%);
    }
    
    .analytics-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 12px 35px rgba(23, 162, 184, 0.25);
        border-color: #17a2b8;
    }
    
    .chart-container {
        position: relative;
        height: 350px;
        padding: 20px;
    }
    
    .conversion-item {
        padding: 18px;
        margin-bottom: 12px;
        background: white;
        border-radius: 12px;
        border-left: 5px solid #17a2b8;
        transition: all 0.3s;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .conversion-item:hover {
        transform: translateX(8px);
        box-shadow: 0 6px 20px rgba(23, 162, 184, 0.15);
    }
    
    .rate-badge {
        display: inline-block;
        padding: 8px 18px;
        border-radius: 25px;
        font-weight: 700;
        font-size: 1.15rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .rate-high {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }
    
    .rate-medium {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
    }
    
    .rate-low {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
    }
    
    .bottleneck-card {
        padding: 18px;
        margin-bottom: 15px;
        background: white;
        border-radius: 15px;
        border-left: 5px solid;
        transition: all 0.3s;
        box-shadow: 0 2px 10px rgba(0,0,0,0.06);
    }
    
    .bottleneck-card:hover {
        transform: translateY(-5px) scale(1.01);
        box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    }
    
    .severity-high {
        border-left-color: #ef4444;
        background: linear-gradient(to right, #fef2f2 0%, white 100%);
    }
    
    .severity-medium {
        border-left-color: #f59e0b;
        background: linear-gradient(to right, #fffbeb 0%, white 100%);
    }
    
    .severity-low {
        border-left-color: #10b981;
        background: linear-gradient(to right, #f0fdf4 0%, white 100%);
    }
    
    .severity-badge {
        padding: 6px 14px;
        border-radius: 18px;
        font-size: 0.9rem;
        font-weight: 700;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    
    .card-title {
        font-weight: 700;
        font-size: 1.3rem;
        color: #2d3748;
        margin-bottom: 1.5rem;
    }
    
    .card-title i {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .header-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- 프리미엄 헤더 -->
    <div class="page-header-gradient mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-2" style="font-weight: 800; font-size: 2rem;">
                    <i class="fas fa-chart-pie"></i> 펀넬 분석
                </h1>
                <p class="mb-0 opacity-90">전환율 분석 및 병목 구간 탐지로 영업 효율 극대화</p>
            </div>
            {% if users %}
            <div style="background: white; border-radius: 15px; padding: 0.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                <div class="btn-group">
                    <button type="button" class="btn btn-light dropdown-toggle" data-bs-toggle="dropdown" style="font-weight: 600;">
                        <i class="fas fa-filter"></i> 
                        {% if filter_user %}{{ filter_user.username }}{% else %}전체 사용자{% endif %}
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="?"><i class="fas fa-users me-2"></i>전체 사용자</a></li>
                        <li><hr class="dropdown-divider"></li>
                        {% for user in users %}
                        <li><a class="dropdown-item" href="?user={{ user.id }}"><i class="fas fa-user me-2"></i>{{ user.username }}</a></li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- 전환율 분석 -->
    <div class="row">
        <div class="col-lg-7">
            <div class="analytics-card">
                <div class="card-body">
                    <h5 class="card-title mb-4">
                        <i class="fas fa-exchange-alt text-primary"></i> 단계별 전환율
                    </h5>
                    <div class="chart-container">
                        <canvas id="conversionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="analytics-card">
                <div class="card-body">
                    <h5 class="card-title mb-4">
                        <i class="fas fa-percentage text-success"></i> 전환율 상세
                    </h5>
                    <div style="max-height: 350px; overflow-y: auto;">
                        {% for conv in conversion_rates %}
                        <div class="conversion-item">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <strong>{{ conv.from_stage }}</strong>
                                    <i class="fas fa-arrow-right mx-2 text-muted"></i>
                                    <strong>{{ conv.to_stage }}</strong>
                                </div>
                                <span class="rate-badge 
                                    {% if conv.rate >= 70 %}rate-high
                                    {% elif conv.rate >= 40 %}rate-medium
                                    {% else %}rate-low{% endif %}">
                                    {{ conv.rate }}%
                                </span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar 
                                    {% if conv.rate >= 70 %}bg-success
                                    {% elif conv.rate >= 40 %}bg-warning
                                    {% else %}bg-danger{% endif %}"
                                    role="progressbar" 
                                    style="width: {{ conv.rate }}%">
                                </div>
                            </div>
                            <small class="text-muted mt-1 d-block">
                                {{ conv.converted }} / {{ conv.total }} 건 전환
                            </small>
                        </div>
                        {% empty %}
                        <p class="text-center text-muted py-4">전환율 데이터가 없습니다.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 병목 분석 -->
    <div class="row mt-4">
        <div class="col-lg-7">
            <div class="analytics-card">
                <div class="card-body">
                    <h5 class="card-title mb-4">
                        <i class="fas fa-hourglass-half text-warning"></i> 단계별 체류 시간
                    </h5>
                    <div class="chart-container">
                        <canvas id="durationChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="analytics-card">
                <div class="card-body">
                    <h5 class="card-title mb-4">
                        <i class="fas fa-exclamation-triangle text-danger"></i> 병목 구간
                    </h5>
                    <div style="max-height: 350px; overflow-y: auto;">
                        {% for bottleneck in bottleneck_analysis %}
                        <div class="bottleneck-card severity-{{ bottleneck.severity }}">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="mb-1" style="color: {{ bottleneck.color }};">
                                        {{ bottleneck.stage }}
                                    </h6>
                                    <span class="severity-badge 
                                        {% if bottleneck.severity == 'high' %}bg-danger text-white
                                        {% elif bottleneck.severity == 'medium' %}bg-warning text-dark
                                        {% else %}bg-success text-white{% endif %}">
                                        {% if bottleneck.severity == 'high' %}높음
                                        {% elif bottleneck.severity == 'medium' %}보통
                                        {% else %}낮음{% endif %}
                                    </span>
                                </div>
                                <div class="text-end">
                                    <div class="text-muted small">현재 건수</div>
                                    <strong style="font-size: 1.2rem;">{{ bottleneck.count }}</strong>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-6">
                                    <small class="text-muted d-block">예상 체류 시간</small>
                                    <strong>{{ bottleneck.expected_duration }}일</strong>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted d-block">실제 체류 시간</small>
                                    <strong class="
                                        {% if bottleneck.actual_duration > bottleneck.expected_duration %}text-danger
                                        {% else %}text-success{% endif %}">
                                        {{ bottleneck.actual_duration }}일
                                    </strong>
                                </div>
                            </div>
                            {% if bottleneck.is_bottleneck %}
                            <div class="alert alert-warning border-0 mt-2 mb-0 py-2">
                                <small>
                                    <i class="fas fa-info-circle"></i>
                                    {% if bottleneck.duration_diff > 0 %}
                                    체류 시간이 예상보다 {{ bottleneck.duration_diff }}일 더 길어 병목이 발생했습니다.
                                    {% else %}
                                    현재 {{ bottleneck.count }}건이 정체되어 있습니다.
                                    {% endif %}
                                </small>
                            </div>
                            {% endif %}
                        </div>
                        {% empty %}
                        <p class="text-center text-muted py-4">병목 데이터가 없습니다.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 빠른 링크 -->
    <div class="row mt-4">
        <div class="col-12 text-center">
            <a href="{% url 'reporting:funnel_dashboard' %}" class="btn btn-lg me-2" 
               style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 15px; padding: 1rem 2rem; font-weight: 700; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                <i class="fas fa-chart-line"></i> 대시보드
            </a>
            <a href="{% url 'reporting:funnel_pipeline' %}" class="btn btn-lg me-2" 
               style="background: white; color: #667eea; border: 2px solid #667eea; border-radius: 15px; padding: 1rem 2rem; font-weight: 700; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.15);">
                <i class="fas fa-columns"></i> 파이프라인
            </a>
            <a href="{% url 'reporting:funnel_forecast' %}" class="btn btn-lg" 
               style="background: white; color: #28a745; border: 2px solid #28a745; border-radius: 15px; padding: 1rem 2rem; font-weight: 700; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.15);">
                <i class="fas fa-crystal-ball"></i> 매출 예측
            </a>
        </div>
    </div>
</div>

<script>
// 전환율 차트
const conversionData = {{ conversion_chart_data|safe }};
const conversionCtx = document.getElementById('conversionChart').getContext('2d');
new Chart(conversionCtx, {
    type: 'bar',
    data: {
        labels: conversionData.labels,
        datasets: [{
            label: '전환율 (%)',
            data: conversionData.rates,
            backgroundColor: conversionData.rates.map(rate => {
                if (rate >= 70) return 'rgba(16, 185, 129, 0.7)';
                if (rate >= 40) return 'rgba(245, 158, 11, 0.7)';
                return 'rgba(239, 68, 68, 0.7)';
            }),
            borderColor: conversionData.rates.map(rate => {
                if (rate >= 70) return 'rgb(16, 185, 129)';
                if (rate >= 40) return 'rgb(245, 158, 11)';
                return 'rgb(239, 68, 68)';
            }),
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                    callback: function(value) {
                        return value + '%';
                    }
                }
            }
        }
    }
});

// 체류 시간 차트
const durationData = {{ duration_chart_data|safe }};
const durationCtx = document.getElementById('durationChart').getContext('2d');
new Chart(durationCtx, {
    type: 'bar',
    data: {
        labels: durationData.labels,
        datasets: [{
            label: '예상 체류 시간',
            data: durationData.expected,
            backgroundColor: 'rgba(102, 126, 234, 0.5)',
            borderColor: 'rgb(102, 126, 234)',
            borderWidth: 2
        }, {
            label: '실제 체류 시간',
            data: durationData.actual,
            backgroundColor: 'rgba(118, 75, 162, 0.5)',
            borderColor: 'rgb(118, 75, 162)',
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: true,
                position: 'top'
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return value + '일';
                    }
                }
            }
        }
    }
});
</script>
{% endblock %}
