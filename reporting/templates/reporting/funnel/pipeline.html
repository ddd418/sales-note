{% extends 'reporting/base.html' %}
{% load static %}

{% block extra_css %}
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<style>
    /* 프리미엄 그라디언트 배경 */
    .page-header-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
        padding: 2rem !important;
        border-radius: 20px !important;
        margin-bottom: 2rem !important;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3) !important;
    }
    
    .pipeline-board {
        display: flex !important;
        gap: 24px !important;
        overflow-x: auto !important;
        padding: 24px 0 !important;
        min-height: 600px !important;
        scroll-behavior: smooth !important;
    }
    
    /* 스크롤바 스타일 */
    .pipeline-board::-webkit-scrollbar {
        height: 10px;
    }
    .pipeline-board::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    .pipeline-board::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
    }
    
    .pipeline-column {
        min-width: 340px !important;
        max-width: 360px !important;
        background: white !important;
        border-radius: 20px !important;
        padding: 24px !important;
        flex-shrink: 0 !important;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08) !important;
        border: 2px solid #f0f0f0 !important;
        transition: all 0.3s !important;
    }
    
    .pipeline-column:hover {
        box-shadow: 0 8px 30px rgba(0,0,0,0.12) !important;
        transform: translateY(-2px);
    }
    
    .pipeline-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 3px solid;
    }
    
    .stage-title {
        font-size: 1.2rem;
        font-weight: 800;
        display: flex;
        align-items: center;
        gap: 10px;
        letter-spacing: -0.5px;
    }
    
    .stage-title i {
        font-size: 1.3rem;
    }
    
    .stage-count {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 6px 16px;
        border-radius: 25px;
        font-size: 0.95rem;
        font-weight: 700;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        min-width: 40px;
        text-align: center;
    }
    
    .opportunity-card {
        background: white !important;
        border-radius: 16px !important;
        padding: 18px !important;
        margin-bottom: 14px !important;
        box-shadow: 0 3px 12px rgba(0,0,0,0.08) !important;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        cursor: pointer !important;
        border: 2px solid #f5f5f5 !important;
        border-left: 5px solid !important;
        position: relative !important;
        overflow: hidden !important;
    }
    
    .opportunity-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.03) 0%, rgba(118, 75, 162, 0.03) 100%);
        opacity: 0;
        transition: opacity 0.3s;
    }
    
    .opportunity-card:hover {
        transform: translateY(-5px) scale(1.02);
        box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        border-color: currentColor;
    }
    
    .opportunity-card:hover::before {
        opacity: 1;
    }
    
    .opp-customer {
        font-weight: 800;
        font-size: 1.1rem;
        margin-bottom: 6px;
        color: #1a202c;
        letter-spacing: -0.3px;
        position: relative;
        z-index: 1;
    }
    
    .opp-company {
        color: #718096;
        font-size: 0.9rem;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 6px;
        position: relative;
        z-index: 1;
    }
    
    .opp-revenue {
        font-size: 1.25rem;
        font-weight: 800;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 8px;
        position: relative;
        z-index: 1;
    }
    
    .opp-weighted {
        font-size: 0.95rem;
        color: #764ba2;
        font-weight: 700;
        background: rgba(118, 75, 162, 0.1);
        padding: 4px 10px;
        border-radius: 8px;
        display: inline-block;
        position: relative;
        z-index: 1;
    }
    
    .opp-date {
        font-size: 0.9rem;
        color: #a0aec0;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 2px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        z-index: 1;
    }
    
    .probability-bar {
        height: 8px;
        background: #e8eaf6;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 10px;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        position: relative;
        z-index: 1;
    }
    
    .probability-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        transition: width 0.5s ease;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
    }
    
    .column-total {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        padding: 16px;
        border-radius: 14px;
        margin-top: 16px;
        text-align: center;
        font-weight: 700;
        border: 2px solid rgba(102, 126, 234, 0.2);
    }
    
    .column-total-amount {
        font-size: 1.3rem;
        font-weight: 800;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .empty-stage {
        text-align: center;
        padding: 60px 20px;
        color: #cbd5e0;
    }
    
    .empty-stage i {
        opacity: 0.3;
    }
    
    .filter-section {
        background: white;
        padding: 24px;
        border-radius: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        border: 2px solid #f0f0f0;
    }
    
    /* 반응형 */
    @media (max-width: 768px) {
        .pipeline-column {
            min-width: 280px;
            max-width: 300px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- 헤더 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="filter-section">
                <div class="d-flex justify-content-between align-items-center">
                    <h2 class="mb-0">
                        <i class="fas fa-columns text-primary"></i> 파이프라인 보드
                    </h2>
                    <div class="d-flex gap-2">
                        {% if users %}
                        <div class="btn-group">
                            <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                                <i class="fas fa-filter"></i> 
                                {% if filter_user %}{{ filter_user.username }}{% else %}전체 사용자{% endif %}
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="?">전체 사용자</a></li>
                                <li><hr class="dropdown-divider"></li>
                                {% for user in users %}
                                <li><a class="dropdown-item" href="?user={{ user.id }}">{{ user.username }}</a></li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                        <a href="{% url 'reporting:funnel_dashboard' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-chart-line"></i> 대시보드
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 파이프라인 보드 -->
    <div class="pipeline-board">
        {% for stage_data in pipeline_data %}
        <div class="pipeline-column">
            <div class="pipeline-header" style="border-color: {{ stage_data.stage.color }};">
                <div class="stage-title" style="color: {{ stage_data.stage.color }};">
                    <i class="{{ stage_data.stage.icon }}"></i>
                    {{ stage_data.stage.display_name }}
                </div>
                <span class="stage-count" style="color: {{ stage_data.stage.color }};">
                    {{ stage_data.count }}
                </span>
            </div>

            <div class="opportunities-list" data-stage="{{ stage_data.stage.name }}">
                {% for opp in stage_data.opportunities %}
                <div class="opportunity-card" 
                     data-opportunity-id="{{ opp.id }}"
                     data-stage="{{ stage_data.stage.name }}"
                     style="border-left-color: {{ stage_data.stage.color }};">
                    <div class="opp-customer">{{ opp.customer_name }}</div>
                    <div class="opp-company">
                        <i class="fas fa-building"></i> {{ opp.company_name }}
                    </div>
                    <div class="opp-revenue">
                        {{ opp.expected_revenue|floatformat:0 }}원
                    </div>
                    <div class="opp-weighted">
                        가중: {{ opp.weighted_revenue|floatformat:0 }}원
                    </div>
                    <div class="probability-bar">
                        <div class="probability-fill" style="width: {{ opp.probability }}%;"></div>
                    </div>
                    <div class="opp-date">
                        <span>
                            <i class="fas fa-calendar-alt"></i> {{ opp.expected_close_date|date:"Y-m-d" }}
                        </span>
                        <span style="font-weight: 600;">
                            <i class="fas fa-user-circle"></i> {{ opp.user }}
                        </span>
                    </div>
                    <!-- 클릭 시 상세 페이지 이동 버튼 -->
                    <button class="btn btn-sm btn-outline-primary mt-2 w-100 view-detail-btn" 
                            onclick="location.href='{% url 'reporting:followup_detail' opp.followup_id %}'; event.stopPropagation();">
                        <i class="fas fa-eye"></i> 상세보기
                    </button>
                </div>
                {% empty %}
                <div class="empty-stage">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <p>영업 기회가 없습니다</p>
                </div>
                {% endfor %}
            </div>

            {% if stage_data.opportunities %}
            <div class="column-total">
                <div class="text-muted small mb-2" style="font-weight: 600;">
                    <i class="fas fa-calculator"></i> 단계 합계
                </div>
                <div class="column-total-amount">
                    {{ stage_data.total_weighted|floatformat:0 }}원
                </div>
                <div class="text-muted small mt-1">
                    (가중치 적용)
                </div>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <!-- 안내 -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="alert alert-success border-0" style="background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%);">
                <i class="fas fa-hand-pointer"></i>
                <strong>드래그앤드롭:</strong> 카드를 드래그하여 다른 단계로 이동시킬 수 있습니다. 
                카드를 클릭하면 상세 페이지로 이동합니다.
            </div>
        </div>
    </div>
</div>

<!-- Sortable.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 모든 opportunities-list에 Sortable 적용
    const lists = document.querySelectorAll('.opportunities-list');
    
    lists.forEach(list => {
        new Sortable(list, {
            group: 'pipeline', // 같은 그룹끼리만 이동 가능
            animation: 200,
            ghostClass: 'sortable-ghost',
            dragClass: 'sortable-drag',
            chosenClass: 'sortable-chosen',
            forceFallback: true,
            fallbackClass: 'sortable-fallback',
            
            // 드래그 시작
            onStart: function(evt) {
                evt.item.style.opacity = '0.5';
            },
            
            // 드래그 종료
            onEnd: function(evt) {
                evt.item.style.opacity = '1';
                
                // 같은 위치로 돌아온 경우 무시
                if (evt.from === evt.to && evt.oldIndex === evt.newIndex) {
                    return;
                }
                
                const card = evt.item;
                const opportunityId = card.getAttribute('data-opportunity-id');
                const newStage = evt.to.getAttribute('data-stage');
                const oldStage = evt.from.getAttribute('data-stage');
                
                // 서버에 단계 변경 요청
                updateOpportunityStage(opportunityId, newStage, oldStage, card, evt);
            },
        });
    });
    
    // 단계 업데이트 함수
    function updateOpportunityStage(opportunityId, newStage, oldStage, card, evt) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value || 
                         document.querySelector('meta[name="csrf-token"]').content;
        
        fetch(`/reporting/api/funnel/update-stage/${opportunityId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                stage: newStage
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 성공 메시지 표시
                showToast('success', data.message || '단계가 변경되었습니다.');
                
                // 카드의 data-stage 속성 업데이트
                card.setAttribute('data-stage', newStage);
                
                // 카운트 업데이트 (페이지 새로고침 없이)
                updateStageCounts();
            } else {
                // 실패 시 원래 위치로 되돌리기
                showToast('error', data.error || '단계 변경에 실패했습니다.');
                
                // 원래 위치로 복구
                if (evt.oldIndex !== undefined) {
                    evt.from.insertBefore(card, evt.from.children[evt.oldIndex]);
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('error', '서버 오류가 발생했습니다.');
            
            // 원래 위치로 복구
            if (evt.oldIndex !== undefined) {
                evt.from.insertBefore(card, evt.from.children[evt.oldIndex]);
            }
        });
    }
    
    // 단계별 카운트 업데이트
    function updateStageCounts() {
        document.querySelectorAll('.pipeline-column').forEach(column => {
            const list = column.querySelector('.opportunities-list');
            const countBadge = column.querySelector('.stage-count');
            const cards = list.querySelectorAll('.opportunity-card');
            const emptyStage = list.querySelector('.empty-stage');
            
            if (cards.length > 0) {
                countBadge.textContent = cards.length;
                if (emptyStage) emptyStage.remove();
            } else {
                countBadge.textContent = '0';
                if (!emptyStage) {
                    list.innerHTML = `
                        <div class="empty-stage">
                            <i class="fas fa-inbox fa-3x mb-3"></i>
                            <p>영업 기회가 없습니다</p>
                        </div>
                    `;
                }
            }
        });
    }
    
    // Toast 알림 표시
    function showToast(type, message) {
        // Bootstrap Toast가 없으면 간단한 알림으로 대체
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const icon = type === 'success' ? 'check-circle' : 'exclamation-circle';
        
        const toast = document.createElement('div');
        toast.className = `alert ${alertClass} position-fixed top-0 end-0 m-3`;
        toast.style.zIndex = '9999';
        toast.innerHTML = `
            <i class="fas fa-${icon} me-2"></i>${message}
        `;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transition = 'opacity 0.5s';
            setTimeout(() => toast.remove(), 500);
        }, 3000);
    }
});
</script>

<style>
/* Sortable 드래그 스타일 */
.sortable-ghost {
    opacity: 0.4 !important;
    background: #f0f0f0 !important;
}

.sortable-drag {
    opacity: 1 !important;
    cursor: grabbing !important;
    transform: rotate(3deg) !important;
}

.sortable-chosen {
    cursor: grab !important;
}

.sortable-fallback {
    opacity: 0.8 !important;
}

.opportunity-card {
    cursor: grab !important;
}

.opportunity-card:active {
    cursor: grabbing !important;
}

.view-detail-btn {
    cursor: pointer !important;
}
</style>
{% endblock %}
