{% extends "reporting/base.html" %}
{% block title %}{{ page_title }} - ì˜ì—… ë³´ê³  ì‹œìŠ¤í…œ{% endblock %}

{% block extra_css %}
<style>
/* ============================================
   ëª¨ë‹¬ Z-INDEX ë° ì˜¤ë²„ë ˆì´ ìˆ˜ì • (CRITICAL FIX)
   ============================================ */

/* backdropì„ ì™„ì „íˆ íˆ¬ëª…í•˜ê²Œ (ë°°ê²½ ì—†ìŒ) */
.modal-backdrop {
  display: none !important; /* backdrop ìì²´ë¥¼ ìˆ¨ê¹€ */
}

/* ëª¨ë‹¬ ìì²´ëŠ” backdropë³´ë‹¤ ë†’ê²Œ */
.modal {
  z-index: 1055 !important;
  pointer-events: none !important; /* ëª¨ë‹¬ ì»¨í…Œì´ë„ˆë„ íˆ¬ëª…í•˜ê²Œ */
}

/* ëª¨ë‹¬ ë‹¤ì´ì–¼ë¡œê·¸ë§Œ í´ë¦­ ê°€ëŠ¥í•˜ê²Œ */
.modal-dialog {
  z-index: 1056 !important;
  pointer-events: auto !important; /* ë‹¤ì´ì–¼ë¡œê·¸ëŠ” í´ë¦­ ê°€ëŠ¥ */
}

/* ëª¨ë‹¬ ì»¨í…ì¸ ë¥¼ í™•ì‹¤íˆ í´ë¦­ ê°€ëŠ¥í•˜ê²Œ */
.modal-content {
  position: relative;
  z-index: 1057 !important;
  pointer-events: auto !important; /* ì»¨í…ì¸  í´ë¦­ ê°€ëŠ¥ */
  background-color: var(--surface) !important;
  border: 1px solid var(--border) !important;
  border-radius: 0.3rem;
  box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.5) !important; /* ëª¨ë‹¬ì— ê·¸ë¦¼ì ì¶”ê°€ */
}

/* ëª¨ë‹¬ ë‚´ë¶€ì˜ ëª¨ë“  ìš”ì†Œê°€ í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡ */
.modal-header,
.modal-body,
.modal-footer,
.modal-header *,
.modal-body *,
.modal-footer * {
  pointer-events: auto !important;
}

/* ============================================
   ğŸŒ™ ë‹¤í¬ ëª¨ë“œ ìŠ¤íƒ€ì¼
   ============================================ */

/* í˜ì´ì§€ íƒ€ì´í‹€ */
.page-title {
  color: var(--text-primary) !important;
}

/* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
.card {
  background: var(--surface) !important;
  border-color: var(--border) !important;
}

.card-header {
  background: var(--surface-hover) !important;
  border-color: var(--border) !important;
}

.card-body {
  background: var(--surface) !important;
  color: var(--text-primary) !important;
}

.card-title {
  color: var(--text-primary) !important;
}

/* í†µê³„ ì¹´ë“œ ì œëª© ìƒ‰ìƒ ìœ ì§€ */
.card-title.text-success {
  color: #10b981 !important;
}

.card-title.text-info {
  color: #3b82f6 !important;
}

.card-title.text-warning {
  color: #f59e0b !important;
}

.card-title.text-danger {
  color: #ef4444 !important;
}

.card-title.text-primary {
  color: var(--primary) !important;
}

/* í¼ ì»¨íŠ¸ë¡¤ */
.form-control,
.form-select {
  background: var(--surface) !important;
  border-color: var(--border) !important;
  color: var(--text-primary) !important;
}

.form-control::placeholder {
  color: var(--text-muted) !important;
}

.form-control:focus,
.form-select:focus {
  background: var(--surface) !important;
  border-color: var(--primary) !important;
  color: var(--text-primary) !important;
}

.form-label {
  color: var(--text-primary) !important;
}

/* í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
.text-muted {
  color: var(--text-muted) !important;
}

/* ë“œë¡­ë‹¤ìš´ */
.dropdown-menu {
  background: var(--surface) !important;
  border-color: var(--border) !important;
}

.dropdown-item {
  color: var(--text-primary) !important;
}

.dropdown-item:hover {
  background: var(--surface-hover) !important;
}

.dropdown-item.active {
  background: var(--primary) !important;
  color: white !important;
}

/* í…Œì´ë¸” */
.table {
  color: var(--text-primary) !important;
}

.table thead th {
  background: var(--surface-hover) !important;
  border-color: var(--border) !important;
  color: var(--text-primary) !important;
}

.table tbody td {
  background: var(--surface) !important;
  border-color: var(--border) !important;
  color: var(--text-primary) !important;
}

.table-hover tbody tr:hover td {
  background: var(--surface-hover) !important;
}

/* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
.btn-outline-secondary {
  color: var(--text-secondary) !important;
  border-color: var(--border) !important;
}

.btn-outline-secondary:hover {
  background: var(--surface-hover) !important;
  color: var(--text-primary) !important;
}

/* ë§í¬ ìƒ‰ìƒ */
a.text-decoration-none {
  color: var(--primary) !important;
}

/* ê³ ê° ì´ë¦„ ë±ƒì§€ í°ìƒ‰ í…ìŠ¤íŠ¸ */
.badge.bg-secondary.text-decoration-none {
  color: #ffffff !important;
}

/* ì•„ì½”ë””ì–¸/ì»¬ë©ìŠ¤ */
.accordion-item {
  background: var(--surface) !important;
  border-color: var(--border) !important;
}

.accordion-button {
  background: var(--surface-hover) !important;
  color: var(--text-primary) !important;
}

.accordion-button:not(.collapsed) {
  background: var(--surface-hover) !important;
  color: var(--primary) !important;
}

.accordion-body {
  background: var(--surface) !important;
  color: var(--text-primary) !important;
}

/* progress bar ë°°ê²½ */
.progress {
  background: var(--surface-hover) !important;
}

/* ë¦¬ìŠ¤íŠ¸ ê·¸ë£¹ */
.list-group-item {
  background: var(--surface) !important;
  border-color: var(--border) !important;
  color: var(--text-primary) !important;
}
</style>
{% endblock %}

{% block content %}

<div class="container-fluid">
  <div class="row justify-content-center">
    <div class="col-12">
      <!-- í—¤ë” ì„¹ì…˜ -->
      <div class="page-header d-flex justify-content-between align-items-center mb-4">
        <h1 class="page-title mb-0">
          <i class="fas fa-chart-bar me-2"></i>{{ page_title }}
          {% if is_viewing_others %}
            <span class="badge bg-warning text-dark ms-2" style="font-size: 0.5em; vertical-align: middle;">
              <i class="fas fa-eye me-1"></i>ì¡°íšŒ ì „ìš©
            </span>
          {% endif %}
        </h1>
      </div>

      <!-- ë°ì´í„° í•„í„° ì„¹ì…˜ -->
      <div class="row mb-4" style="position: relative; z-index: 1050;">
        <div class="col-12">
          <div class="card border-primary" style="overflow: visible;">
            <div class="card-body py-2" style="overflow: visible;">
              <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div class="d-flex align-items-center gap-2">
                  <!-- ë…„ë„ í•„í„° -->
                  <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                      <i class="fas fa-calendar-alt me-1"></i>{{ selected_year }}ë…„
                    </button>
                    <ul class="dropdown-menu">
                      {% for year in year_range %}
                      <li>
                        <a class="dropdown-item {% if selected_year == year %}active{% endif %}" 
                           href="?year={{ year }}{% if data_filter %}&data_filter={{ data_filter }}{% endif %}{% if filter_user_id %}&filter_user={{ filter_user_id }}{% endif %}{% if category_id %}&category={{ category_id }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}{% if sort_order %}&order={{ sort_order }}{% endif %}">
                          {{ year }}ë…„
                        </a>
                      </li>
                      {% endfor %}
                    </ul>
                  </div>
                  
                  <!-- ë°ì´í„° ë²”ìœ„ -->
                  <span class="me-2"><i class="fas fa-users me-1"></i>ë°ì´í„° ë²”ìœ„:</span>
                  <div class="btn-group" role="group">
                    <a href="?data_filter=me{% if selected_year %}&year={{ selected_year }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}{% if sort_order %}&order={{ sort_order }}{% endif %}{% if category_id %}&category={{ category_id }}{% endif %}" 
                       class="btn btn-sm {% if data_filter == 'me' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                      <i class="fas fa-user me-1"></i>ë‚˜
                    </a>
                    <a href="?data_filter=all{% if selected_year %}&year={{ selected_year }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}{% if sort_order %}&order={{ sort_order }}{% endif %}{% if category_id %}&category={{ category_id }}{% endif %}" 
                       class="btn btn-sm {% if data_filter == 'all' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                      <i class="fas fa-users me-1"></i>ì „ì²´
                    </a>
                  </div>
                  {% if company_users %}
                  <div class="dropdown ms-2">
                    <button class="btn btn-sm {% if data_filter == 'user' %}btn-primary{% else %}btn-outline-primary{% endif %} dropdown-toggle" type="button" data-bs-toggle="dropdown">
                      {% if selected_filter_user %}
                        {{ selected_filter_user.first_name }}{{ selected_filter_user.last_name }}{% if not selected_filter_user.last_name and not selected_filter_user.first_name %}{{ selected_filter_user.username }}{% endif %}
                      {% else %}
                        ì§ì› ì„ íƒ
                      {% endif %}
                    </button>
                    <ul class="dropdown-menu">
                      {% for user_item in company_users %}
                      <li>
                        <a class="dropdown-item {% if selected_filter_user.id == user_item.id %}active{% endif %}" 
                           href="?data_filter=user&filter_user={{ user_item.id }}{% if selected_year %}&year={{ selected_year }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}{% if sort_order %}&order={{ sort_order }}{% endif %}{% if category_id %}&category={{ category_id }}{% endif %}">
                          {{ user_item.first_name }}{{ user_item.last_name }}{% if not user_item.last_name and not user_item.first_name %}{{ user_item.username }}{% endif %}
                        </a>
                      </li>
                      {% endfor %}
                    </ul>
                  </div>
                  {% endif %}
                </div>
                <div>
                  {% if data_filter == 'all' %}
                    <span class="badge bg-info"><i class="fas fa-building me-1"></i>íšŒì‚¬ ì „ì²´ ë°ì´í„°</span>
                  {% elif selected_filter_user %}
                    <span class="badge bg-info"><i class="fas fa-user me-1"></i>{{ selected_filter_user.first_name }}{{ selected_filter_user.last_name }}{% if not selected_filter_user.last_name and not selected_filter_user.first_name %}{{ selected_filter_user.username }}{% endif %} ë°ì´í„°</span>
                  {% else %}
                    <span class="badge bg-secondary"><i class="fas fa-user me-1"></i>ë‚´ ë°ì´í„°</span>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ì „ì²´ í†µê³„ ì¹´ë“œ -->
      <div class="row mb-4">
        <div class="col-md-2-4">
          <div class="card text-center">
            <div class="card-body">
              <h6 class="card-title text-success" style="font-size: 0.85rem;">
                <i class="fas fa-handshake"></i> ì´ ë¯¸íŒ… ìˆ˜
              </h6>
              <h3 class="text-success">{{ total_meetings_sum }}íšŒ</h3>
            </div>
          </div>
        </div>
        <div class="col-md-2-4">
          <div class="card text-center">
            <div class="card-body">
              <h6 class="card-title text-info" style="font-size: 0.85rem;">
                <i class="fas fa-truck"></i> ì´ ë‚©í’ˆ ìˆ˜
              </h6>
              <h3 class="text-info">{{ total_deliveries_sum }}ê±´</h3>
            </div>
          </div>
        </div>
        <div class="col-md-2-4">
          <div class="card text-center">
            <div class="card-body">
              <h6 class="card-title text-warning" style="font-size: 0.85rem;">
                <i class="fas fa-won-sign"></i> ì´ ë‚©í’ˆ ê¸ˆì•¡
              </h6>
              <h3 class="text-warning" id="customer-report-total-amount">
                {% load currency_filters %}
                {{ total_amount_sum|currency_format }}ì›
              </h3>
            </div>
          </div>
        </div>
        <div class="col-md-2-4">
          <div class="card text-center">
            <div class="card-body">
              <h6 class="card-title text-danger" style="font-size: 0.85rem;">
                <i class="fas fa-exclamation-triangle" style="font-size: 0.8rem;"></i> ì´ ë¯¸ê²°ì œê±´
              </h6>
              <h3 class="text-danger">{{ total_unpaid_sum }}ê±´</h3>
            </div>
          </div>
        </div>
        <div class="col-md-2-4">
          <div class="card text-center">
            <div class="card-body">
              <h6 class="card-title text-info" style="font-size: 0.85rem;">
                <i class="fas fa-piggy-bank"></i> ì„ ê²°ì œ ê³ ê°
              </h6>
              <h3 class="text-info">{{ total_prepayment_customers }}ëª…</h3>
            </div>
          </div>
        </div>
      </div>

      <!-- ê²€ìƒ‰ ë° í•„í„° ì„¹ì…˜ -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="card-title mb-0">
                  <i class="fas fa-search me-2"></i>ê²€ìƒ‰ ë° í•„í„°
                </h6>
                <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#categoryModal">
                  <i class="fas fa-tags me-1"></i>ì¹´í…Œê³ ë¦¬ ê´€ë¦¬
                </button>
              </div>
              <form method="GET" action="{% url 'reporting:customer_report' %}">
                <!-- íˆë“  í•„ë“œë¡œ ê¸°ì¡´ í•„í„° ìœ ì§€ -->
                {% if data_filter %}<input type="hidden" name="data_filter" value="{{ data_filter }}">{% endif %}
                {% if filter_user_id %}<input type="hidden" name="filter_user" value="{{ filter_user_id }}">{% endif %}
                {% if sort_by %}<input type="hidden" name="sort" value="{{ sort_by }}">{% endif %}
                {% if sort_order %}<input type="hidden" name="order" value="{{ sort_order }}">{% endif %}
                {% if selected_year %}<input type="hidden" name="year" value="{{ selected_year }}">{% endif %}
                
                <div class="row g-3">
                  <!-- ì¹´í…Œê³ ë¦¬ í•„í„° -->
                  <div class="col-md-4">
                    <label for="category" class="form-label">
                      <i class="fas fa-tag me-1"></i>ì¹´í…Œê³ ë¦¬
                    </label>
                    <select class="form-select" name="category" id="category" onchange="this.form.submit()">
                      <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
                      {% for parent, children in categories_dict.items %}
                      <option value="{{ parent.id }}" {% if selected_category and selected_category.id == parent.id %}selected{% endif %}>
                        {{ parent.name }}
                      </option>
                      {% for child in children %}
                      <option value="{{ child.id }}" {% if selected_category and selected_category.id == child.id %}selected{% endif %}>
                        &nbsp;&nbsp;â”” {{ child.name }}
                      </option>
                      {% endfor %}
                      {% endfor %}
                    </select>
                  </div>
                  
                  <!-- ê²€ìƒ‰ì–´ -->
                  <div class="col-md-5">
                    <label for="search" class="form-label">ê²€ìƒ‰ì–´</label>
                    <input 
                      type="text" 
                      class="form-control" 
                      id="search"
                      name="search" 
                      value="{{ search_query|default:'' }}"
                      placeholder="ê³ ê°ëª…, ì—…ì²´ëª…, ì±…ì„ì..."
                    >
                  </div>
                  
                  <!-- ë²„íŠ¼ë“¤ -->
                  <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <div class="btn-group w-100">
                      <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i> ê²€ìƒ‰
                      </button>
                      <a href="{% url 'reporting:customer_report' %}?data_filter={{ data_filter }}{% if filter_user_id %}&filter_user={{ filter_user_id }}{% endif %}" class="btn btn-outline-secondary">
                        <i class="fas fa-times"></i> ì´ˆê¸°í™”
                      </a>
                    </div>
                  </div>
                </div>
                
                <!-- í˜„ì¬ í•„í„° ìœ ì§€ -->
                <input type="hidden" name="data_filter" value="{{ data_filter }}">
                {% if filter_user_id %}
                <input type="hidden" name="filter_user" value="{{ filter_user_id }}">
                {% endif %}
                
                <!-- ê²€ìƒ‰ ê²°ê³¼ ì •ë³´ -->
                {% if search_query or selected_category %}
                <div class="mt-3">
                  <small class="text-muted">
                    ê²€ìƒ‰ ê²°ê³¼: {{ total_customers }}ê±´
                    {% if search_query %} | ê²€ìƒ‰ì–´: "<strong>{{ search_query }}</strong>"{% endif %}
                    {% if selected_category %} | ì¹´í…Œê³ ë¦¬: <span class="badge" style="background-color: {{ selected_category.color }};">{{ selected_category.get_full_path }}</span>{% endif %}
                  </small>
                </div>
                {% endif %}
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- ë¶€ì„œë³„ ë¦¬í¬íŠ¸ í…Œì´ë¸” -->
      {% if departments %}
      <div class="row">
        <div class="col-12">
          <div class="card customer-report-table-card">
            <div class="card-body">
              <h6 class="card-title mb-3">
                <i class="fas fa-building me-2"></i>ë¶€ì„œë³„ í™œë™ ìš”ì•½
                <span class="badge bg-secondary ms-2">{{ total_departments }}ê°œ ë¶€ì„œ / {{ total_customers }}ëª… ê³ ê°</span>
              </h6>
              <div class="table-responsive">
                <table class="table table-hover" id="customerTable">
                  <thead class="table-light">
                    <tr>
                      <th>
                        <a href="?sort=company&order={% if sort_by == 'company' and sort_order == 'asc' %}desc{% else %}asc{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}&data_filter={{ data_filter }}{% if filter_user_id %}&filter_user={{ filter_user_id }}{% endif %}" class="text-decoration-none text-dark">
                          ì—…ì²´/ë¶€ì„œ 
                          {% if sort_by == 'company' %}
                            <i class="fas fa-sort-{% if sort_order == 'asc' %}up{% else %}down{% endif %}"></i>
                          {% else %}
                            <i class="fas fa-sort text-muted"></i>
                          {% endif %}
                        </a>
                      </th>
                      <th>ì†Œì† ê³ ê°</th>
                      <th class="text-center">
                        <a href="?sort=meetings&order={% if sort_by == 'meetings' and sort_order == 'asc' %}desc{% else %}asc{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}&data_filter={{ data_filter }}{% if filter_user_id %}&filter_user={{ filter_user_id }}{% endif %}" class="text-decoration-none text-dark">
                          ë¯¸íŒ… 
                          {% if sort_by == 'meetings' %}
                            <i class="fas fa-sort-{% if sort_order == 'asc' %}up{% else %}down{% endif %}"></i>
                          {% else %}
                            <i class="fas fa-sort text-muted"></i>
                          {% endif %}
                        </a>
                      </th>
                      <th class="text-center">
                        <a href="?sort=deliveries&order={% if sort_by == 'deliveries' and sort_order == 'asc' %}desc{% else %}asc{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}&data_filter={{ data_filter }}{% if filter_user_id %}&filter_user={{ filter_user_id }}{% endif %}" class="text-decoration-none text-dark">
                          ë‚©í’ˆ 
                          {% if sort_by == 'deliveries' %}
                            <i class="fas fa-sort-{% if sort_order == 'asc' %}up{% else %}down{% endif %}"></i>
                          {% else %}
                            <i class="fas fa-sort text-muted"></i>
                          {% endif %}
                        </a>
                      </th>
                      <th class="text-end">
                        <a href="?sort=amount&order={% if sort_by == 'amount' and sort_order == 'asc' %}desc{% else %}asc{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}&data_filter={{ data_filter }}{% if filter_user_id %}&filter_user={{ filter_user_id }}{% endif %}" class="text-decoration-none text-dark">
                          ì´ ê¸ˆì•¡ 
                          {% if sort_by == 'amount' %}
                            <i class="fas fa-sort-{% if sort_order == 'asc' %}up{% else %}down{% endif %}"></i>
                          {% else %}
                            <i class="fas fa-sort text-muted"></i>
                          {% endif %}
                        </a>
                      </th>
                      <th class="text-center">
                        <a href="?sort=prepayment&order={% if sort_by == 'prepayment' and sort_order == 'asc' %}desc{% else %}asc{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}&data_filter={{ data_filter }}{% if filter_user_id %}&filter_user={{ filter_user_id }}{% endif %}" class="text-decoration-none text-dark">
                          ì„ ê²°ì œ 
                          {% if sort_by == 'prepayment' %}
                            <i class="fas fa-sort-{% if sort_order == 'asc' %}up{% else %}down{% endif %}"></i>
                          {% else %}
                            <i class="fas fa-sort text-muted"></i>
                          {% endif %}
                        </a>
                      </th>
                      <th class="text-center">
                        <a href="?sort=unpaid&order={% if sort_by == 'unpaid' and sort_order == 'asc' %}desc{% else %}asc{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}&data_filter={{ data_filter }}{% if filter_user_id %}&filter_user={{ filter_user_id }}{% endif %}" class="text-decoration-none text-dark">
                          ì„¸ê¸ˆê³„ì‚°ì„œ 
                          {% if sort_by == 'unpaid' %}
                            <i class="fas fa-sort-{% if sort_order == 'asc' %}up{% else %}down{% endif %}"></i>
                          {% else %}
                            <i class="fas fa-sort text-muted"></i>
                          {% endif %}
                        </a>
                      </th>
                      <th class="text-center">
                        <a href="?sort=last_contact&order={% if sort_by == 'last_contact' and sort_order == 'asc' %}desc{% else %}asc{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}&data_filter={{ data_filter }}{% if filter_user_id %}&filter_user={{ filter_user_id }}{% endif %}" class="text-decoration-none text-dark">
                          ìµœê·¼ ì ‘ì´‰ 
                          {% if sort_by == 'last_contact' %}
                            <i class="fas fa-sort-{% if sort_order == 'asc' %}up{% else %}down{% endif %}"></i>
                          {% else %}
                            <i class="fas fa-sort text-muted"></i>
                          {% endif %}
                        </a>
                      </th>
                      <th class="text-center">ì•¡ì…˜</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for dept in departments %}
                    <tr>
                      <td>
                        <div class="dept-info">
                          <strong class="text-primary">
                            <i class="fas fa-building me-1"></i>{{ dept.company.name }}
                          </strong>
                          <br>
                          <span class="text-muted ms-3">
                            <i class="fas fa-flask me-1"></i>{{ dept.department.name }}
                          </span>
                        </div>
                      </td>
                      <td>
                        <div class="d-flex align-items-center gap-2">
                          <!-- ë¶€ì„œ ì¹´í…Œê³ ë¦¬ í‘œì‹œ -->
                          <div class="dropdown">
                            <button class="btn btn-sm p-0 border-0" type="button" data-bs-toggle="dropdown" aria-expanded="false" style="background: none;">
                              <span class="badge category-badge" data-bg-color="{% if dept.department.category %}{{ dept.department.category.color }}{% else %}#6c757d{% endif %}" style="background-color: {% if dept.department.category %}{{ dept.department.category.color }}{% else %}#6c757d{% endif %}; font-size: 0.75rem; cursor: pointer;" title="ë¶€ì„œ ì¹´í…Œê³ ë¦¬ ë³€ê²½">
                                <i class="fas fa-tag"></i>
                                {% if dept.department.category %}
                                  {{ dept.department.category.get_full_path }}
                                {% else %}
                                  ì¹´í…Œê³ ë¦¬ ì—†ìŒ
                                {% endif %}
                              </span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-start" style="min-width: 200px;">
                              <li><h6 class="dropdown-header">ë¶€ì„œ ì¹´í…Œê³ ë¦¬ ì„ íƒ</h6></li>
                              <li><a class="dropdown-item" href="#" onclick="assignDepartmentCategory({{ dept.department.id }}, '', 'ì—†ìŒ'); return false;">
                                <span class="badge bg-secondary me-2"><i class="fas fa-times"></i></span>ì—†ìŒ
                              </a></li>
                              <li><hr class="dropdown-divider"></li>
                              {% for parent, children in categories_dict.items %}
                              <li><a class="dropdown-item {% if dept.department.category.id == parent.id %}active{% endif %}" href="#" onclick="assignDepartmentCategory({{ dept.department.id }}, {{ parent.id }}, '{{ parent.name }}'); return false;">
                                <span class="badge category-badge me-2" data-bg-color="{{ parent.color }}" style="background-color: {{ parent.color }};"><i class="fas fa-tag"></i></span>{{ parent.name }}
                              </a></li>
                              {% for child in children %}
                              <li><a class="dropdown-item ps-4 {% if dept.department.category.id == child.id %}active{% endif %}" href="#" onclick="assignDepartmentCategory({{ dept.department.id }}, {{ child.id }}, '{{ child.get_full_path }}'); return false;">
                                <span class="badge category-badge me-2" data-bg-color="{{ child.color }}" style="background-color: {{ child.color }};"><i class="fas fa-tag"></i></span>{{ parent.name }} <i class="fas fa-chevron-right mx-1" style="font-size: 0.7rem;"></i> {{ child.name }}
                              </a></li>
                              {% endfor %}
                              {% endfor %}
                            </ul>
                          </div>
                          <!-- ê³ ê° ëª©ë¡ -->
                          <div class="d-flex flex-wrap gap-1">
                            {% for customer in dept.customers %}
                            <a href="{% url 'reporting:followup_detail' customer.id %}" 
                               class="badge bg-secondary text-decoration-none" 
                               title="{{ customer.user.username }} ë‹´ë‹¹">
                              {{ customer.customer_name|default:"ë¯¸ì •" }}
                            </a>
                            {% endfor %}
                          </div>
                        </div>
                      </td>
                      <td class="text-center">
                        <span class="badge bg-primary">{{ dept.total_meetings }}íšŒ</span>
                      </td>
                      <td class="text-center">
                        <span class="badge bg-success">{{ dept.total_deliveries }}ê±´</span>
                      </td>
                      <td class="text-end">
                        <strong class="text-warning">
                          {% if dept.total_amount %}
                            {% load currency_filters %}
                            {{ dept.total_amount|currency_format }}ì›
                          {% else %}
                            -
                          {% endif %}
                        </strong>
                      </td>
                      <td class="text-center">
                        {% if dept.prepayment_balance > 0 %}
                          <strong class="text-info">
                            {% load currency_filters %}
                            {{ dept.prepayment_balance|currency_format }}ì›
                          </strong>
                        {% else %}
                          <span class="text-muted">-</span>
                        {% endif %}
                      </td>
                      <td class="text-center">
                        {% if dept.tax_invoices_issued > 0 or dept.tax_invoices_pending > 0 %}
                          {% if dept.tax_invoices_issued > 0 %}
                            <span class="badge bg-primary me-1">ë°œí–‰ {{ dept.tax_invoices_issued }}</span>
                          {% endif %}
                          {% if dept.tax_invoices_pending > 0 %}
                            <span class="badge bg-danger">ë¯¸ë°œí–‰ {{ dept.tax_invoices_pending }}</span>
                          {% endif %}
                        {% else %}
                          <span class="text-muted">-</span>
                        {% endif %}
                      </td>
                      <td class="text-center">
                        {% if dept.last_contact %}
                          <small>{{ dept.last_contact|date:"Y-m-d" }}</small>
                        {% else %}
                          <span class="text-muted">-</span>
                        {% endif %}
                      </td>
                      <td class="text-center">
                        {% with first_customer=dept.customers.0 %}
                        <a href="{% url 'reporting:customer_detail_report' first_customer.id %}?data_filter={{ data_filter }}{% if filter_user_id %}&filter_user={{ filter_user_id }}{% endif %}" 
                           class="btn btn-sm btn-outline-primary" title="ë¶€ì„œ ìƒì„¸ ë¦¬í¬íŠ¸">
                          <i class="fas fa-chart-line"></i>
                        </a>
                        {% endwith %}
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
      {% include 'reporting/components/pagination.html' %}
      
      {% else %}
      <div class="row">
        <div class="col-12">
          <div class="alert alert-info text-center">
            <i class="fas fa-info-circle me-2"></i>
            {% if search_query %}
              ê²€ìƒ‰ ì¡°ê±´ì— ë§ëŠ” ë¶€ì„œê°€ ì—†ìŠµë‹ˆë‹¤.
            {% else %}
              ë“±ë¡ëœ ë¶€ì„œê°€ ì—†ìŠµë‹ˆë‹¤.
            {% endif %}
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<style>
/* ì „ì—­ overflow ë°©ì§€ */
html, body {
  overflow-x: hidden;
  max-width: 100%;
}

* {
  box-sizing: border-box;
}

/* ì „ì²´ ì»¨í…Œì´ë„ˆ ì¤‘ì•™ ì •ë ¬ */
.container-fluid {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 20px;
}

/* ì¹´ë“œ ì»¨í…Œì´ë„ˆë„ ì¤‘ì•™ ì •ë ¬ */
.row {
  justify-content: center;
}

.table td {
  vertical-align: middle;
}

/* í˜ì´ì§€ í—¤ë” */
.page-header {
  flex-wrap: wrap;
  gap: 1rem;
}

.page-title {
  font-size: 1.75rem;
  word-break: break-word;
}

/* ì´ ë‚©í’ˆ ê¸ˆì•¡ ë™ì  í…ìŠ¤íŠ¸ í¬ê¸° ì¡°ì • */
#customer-report-total-amount {
  transition: font-size 0.3s ease;
  word-wrap: break-word;
  word-break: keep-all;
  line-height: 1.2;
  min-height: 2.4rem;
  display: flex;
  align-items: center;
  justify-content: center;
}

#customer-report-total-amount.small-amount {
  font-size: 1.3rem !important;
}

#customer-report-total-amount.smaller-amount {
  font-size: 1.0rem !important;
}

#customer-report-total-amount.smallest-amount {
  font-size: 0.8rem !important;
}

/* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
.card {
  margin-bottom: 1rem;
  overflow: hidden;
}

.card-body {
  min-height: 120px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  padding: 1rem 0.5rem;
}

.card-title {
  word-break: break-word;
}

/* 5ê°œ ì¹´ë“œ ë ˆì´ì•„ì›ƒì„ ìœ„í•œ í´ë˜ìŠ¤ - í•œ ì¤„ë¡œ ë°°ì¹˜ */
.col-md-2-4 {
  flex: 0 0 20%;
  max-width: 20%;
}

/* í†µê³„ ì¹´ë“œ h3 í¬ê¸° ì¡°ì • */
.card-body h3 {
  font-size: 2rem;
  margin: 0;
  word-break: break-word;
}

.card-body h6 {
  word-break: break-word;
}

/* ë°°ì§€ ìŠ¤íƒ€ì¼ */
.badge {
  font-size: 0.75em;
  white-space: nowrap;
}

/* í…Œì´ë¸” ì •ë ¬ ë§í¬ ìŠ¤íƒ€ì¼ */
.table thead th a {
  color: inherit;
  text-decoration: none;
  display: inline-block;
}

.table thead th a:hover {
  color: #667eea;
}

.table thead th a i {
  margin-left: 5px;
  font-size: 0.8em;
}

/* í…Œì´ë¸”ì´ í™”ë©´ì— ë§ë„ë¡ ìë™ ì¡°ì • */
.table {
  width: 100%;
  table-layout: auto;
  margin-bottom: 0;
}

/* ê³ ê° ë¦¬í¬íŠ¸ í…Œì´ë¸”ì„ í¬í•¨í•˜ëŠ” ì¹´ë“œ ì „ìš© ìŠ¤íƒ€ì¼ */
.customer-report-table-card {
  width: 100%;
  margin: 0 auto;
  overflow-x: auto;
}

.customer-report-table-card .card-body {
  padding: 0;
  overflow-x: auto;
}

.customer-report-table-card .table-responsive {
  overflow-x: auto;
  margin: 0;
}

/* í…Œì´ë¸” í—¤ë”ì— íŒ¨ë”© ë³µì› */
.customer-report-table-card .card-body h6 {
  padding: 20px 20px 15px 20px;
  margin-bottom: 0;
}

/* í…Œì´ë¸” ìì²´ëŠ” ì¹´ë“œ ë‚´ë¶€ì—ì„œ ê½‰ ì°¨ê²Œ */
.customer-report-table-card .table {
  margin: 0;
  border-radius: 0;
  min-width: 1200px;
  width: auto;
}

/* í…Œì´ë¸” ë°˜ì‘í˜• ìŠ¤í¬ë¡¤ í™œì„±í™” */
.table-responsive {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  margin: 0;
  width: 100%;
}

/* í…ìŠ¤íŠ¸ ì˜¤ë²„í”Œë¡œìš° ì²˜ë¦¬ - ì¤‘ìš”í•œ ì—´ë§Œ ì ìš© */
.table th,
.table td {
  padding: 12px 8px;
}

/* ê³ ê°ì •ë³´ ì—´ - í•œ ì¤„ í‘œì‹œ */
.customer-info {
  min-width: 200px;
  display: flex;
  align-items: center;
  white-space: nowrap;
}

.customer-name {
  font-size: 14px;
  font-weight: 600;
}

.company-info {
  font-size: 13px;
  overflow: hidden;
  text-overflow: ellipsis;
  flex-shrink: 1;
}

.customer-info span {
  display: inline-block;
}

/* ê³ ê°ì •ë³´ê°€ ë„ˆë¬´ ê¸¸ ê²½ìš° ë§ì¤„ì„ ì²˜ë¦¬ */
.customer-info {
  overflow: hidden;
  text-overflow: ellipsis;
}

/* ìˆ«ì ì—´ë“¤ì€ ë” ì‘ê²Œ */
.table .text-center {
  white-space: nowrap;
}

/* ê¸ˆì•¡ ì—´ */
.table .text-end {
  white-space: nowrap;
  min-width: 120px;
}

/* ì•¡ì…˜ ë²„íŠ¼ */
.btn-group {
  white-space: nowrap;
}

.btn-group .btn {
  padding: 0.25rem 0.5rem;
  font-size: 0.875rem;
}

/* í†µê³„ ì¹´ë“œë“¤ë„ ì¤‘ì•™ ì •ë ¬ */
.row.mb-4 {
  justify-content: center;
}

/* ê²€ìƒ‰ ì„¹ì…˜ë„ ì¤‘ì•™ ì •ë ¬ */
.row.mb-4 .col-12 .card {
  max-width: 100%;
  margin: 0 auto;
}

/* í° í™”ë©´ì—ì„œ ì»¨í…Œì´ë„ˆ ìµœì í™” */
@media (min-width: 1200px) {
  .container-fluid {
    max-width: 1600px;
  }
}

/* íƒœë¸”ë¦¿ (769px ~ 1024px) */
@media (min-width: 769px) and (max-width: 1024px) {
  .container-fluid {
    max-width: 100%;
    padding: 0 1rem;
  }

  .page-title {
    font-size: 1.5rem;
  }

  /* í†µê³„ ì¹´ë“œ 2-3-2-3 ë°°ì¹˜ */
  .col-md-2-4:nth-child(1),
  .col-md-2-4:nth-child(2) {
    flex: 0 0 50%;
    max-width: 50%;
  }

  .col-md-2-4:nth-child(3),
  .col-md-2-4:nth-child(4),
  .col-md-2-4:nth-child(5) {
    flex: 0 0 33.333%;
    max-width: 33.333%;
  }

  .card-body {
    min-height: 100px;
    padding: 0.875rem 0.5rem;
  }

  .card-body h3 {
    font-size: 1.5rem;
  }

  .card-body h6 {
    font-size: 0.75rem;
  }

  /* ê²€ìƒ‰ í•„í„° */
  .form-label {
    font-size: 0.875rem;
    margin-bottom: 0.25rem;
  }

  .form-control,
  .btn {
    font-size: 0.875rem;
    padding: 0.5rem 0.75rem;
  }

  /* í…Œì´ë¸” */
  .customer-report-table-card .table {
    min-width: 1000px;
    font-size: 0.875rem;
  }

  .table th,
  .table td {
    padding: 10px 6px;
  }

  .customer-name {
    font-size: 13px;
  }

  .company-info {
    font-size: 12px;
  }

  .badge {
    font-size: 0.7em;
    padding: 0.25em 0.5em;
  }

  .btn-group .btn {
    padding: 0.2rem 0.4rem;
    font-size: 0.8rem;
  }
}

/* ëª¨ë°”ì¼ ë° íƒœë¸”ë¦¿ (1200px ì´í•˜) */
@media (max-width: 1200px) {
  .container-fluid {
    max-width: 100%;
    padding: 0 0.75rem;
  }

  .page-header {
    margin-bottom: 1rem !important;
  }

  .page-title {
    font-size: 1.25rem;
  }

  /* í†µê³„ ì¹´ë“œ 2ì—´ */
  .col-md-2-4 {
    flex: 0 0 50%;
    max-width: 50%;
  }

  .card-body {
    min-height: 90px;
    padding: 0.75rem 0.5rem;
  }

  .card-body h3 {
    font-size: 1.25rem;
  }

  .card-body h6 {
    font-size: 0.7rem;
  }

  /* ê²€ìƒ‰ í•„í„° ê°„ê²© ì¤„ì´ê¸° */
  .row.g-3 {
    --bs-gutter-x: 0.75rem;
    --bs-gutter-y: 0.75rem;
  }

  .form-label {
    font-size: 0.8rem;
    margin-bottom: 0.25rem;
  }

  .form-control,
  .btn {
    font-size: 0.8rem;
    padding: 0.4rem 0.6rem;
  }

  /* í…Œì´ë¸” */
  .table-responsive {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  .customer-report-table-card .table {
    min-width: 900px;
    font-size: 0.8rem;
  }

  .table th,
  .table td {
    padding: 8px 5px;
  }

  .customer-info {
    min-width: 180px;
  }

  .customer-name {
    font-size: 12px;
  }

  .company-info {
    font-size: 11px;
  }

  .badge {
    font-size: 0.65em;
    padding: 0.2em 0.4em;
  }

  .btn-group .btn {
    padding: 0.15rem 0.3rem;
    font-size: 0.75rem;
  }

  /* ê²€ìƒ‰ ê²°ê³¼ ì •ë³´ */
  small.text-muted {
    font-size: 0.75rem;
  }
}

/* ì†Œí˜• ëª¨ë°”ì¼ (480px ì´í•˜) */
@media (max-width: 480px) {
  .container-fluid {
    padding: 0 0.5rem;
  }

  .page-title {
    font-size: 1.1rem;
  }

  .page-title i {
    font-size: 1rem;
  }

  /* í†µê³„ ì¹´ë“œ 1ì—´ */
  .col-md-2-4 {
    flex: 0 0 100%;
    max-width: 100%;
  }

  .card-body {
    min-height: 80px;
    padding: 0.5rem;
  }

  .card-body h3 {
    font-size: 1.1rem;
  }

  .card-body h6 {
    font-size: 0.65rem;
  }

  /* ê²€ìƒ‰ í•„í„° */
  .form-label {
    font-size: 0.75rem;
  }

  .form-control,
  .btn {
    font-size: 0.75rem;
    padding: 0.35rem 0.5rem;
  }

  .btn-group {
    flex-direction: column;
  }

  .btn-group .btn {
    width: 100%;
    border-radius: 0.25rem !important;
    margin-bottom: 0.25rem;
  }

  /* í…Œì´ë¸” */
  .customer-report-table-card .table {
    min-width: 800px;
    font-size: 0.75rem;
  }

  .table th,
  .table td {
    padding: 6px 4px;
  }

  .customer-info {
    min-width: 150px;
  }

  .customer-name {
    font-size: 11px;
  }

  .company-info {
    font-size: 10px;
  }

  .badge {
    font-size: 0.6em;
    padding: 0.15em 0.3em;
  }

  small.text-muted {
    font-size: 0.7rem;
  }
}
</style>

<script>
// ì´ ë‚©í’ˆ ê¸ˆì•¡ ë™ì  í…ìŠ¤íŠ¸ í¬ê¸° ì¡°ì •
function adjustCustomerReportAmountTextSize() {
  const amountElement = document.getElementById('customer-report-total-amount');
  if (!amountElement) return;
  
  const container = amountElement.parentElement;
  const maxWidth = container.offsetWidth - 20; // íŒ¨ë”© ê³ ë ¤
  
  // ì´ˆê¸° í°íŠ¸ í¬ê¸°ë¡œ ë¦¬ì…‹
  amountElement.style.fontSize = '';
  amountElement.classList.remove('small-amount', 'smaller-amount', 'smallest-amount');
  
  // ì„ì‹œë¡œ ì»¨í…Œì´ë„ˆ ë°–ì—ì„œ í¬ê¸° ì¸¡ì •
  const tempElement = amountElement.cloneNode(true);
  tempElement.style.position = 'absolute';
  tempElement.style.visibility = 'hidden';
  tempElement.style.width = 'auto';
  tempElement.style.whiteSpace = 'nowrap';
  document.body.appendChild(tempElement);
  
  let currentWidth = tempElement.offsetWidth;
  
  if (currentWidth > maxWidth) {
    // 1ë‹¨ê³„: ì‘ê²Œ
    tempElement.classList.add('small-amount');
    currentWidth = tempElement.offsetWidth;
    
    if (currentWidth > maxWidth) {
      // 2ë‹¨ê³„: ë” ì‘ê²Œ
      tempElement.classList.remove('small-amount');
      tempElement.classList.add('smaller-amount');
      currentWidth = tempElement.offsetWidth;
      
      if (currentWidth > maxWidth) {
        // 3ë‹¨ê³„: ìµœì†Œ í¬ê¸°
        tempElement.classList.remove('smaller-amount');
        tempElement.classList.add('smallest-amount');
      }
    }
    
    // ì›ë³¸ ìš”ì†Œì— í´ë˜ìŠ¤ ì ìš©
    amountElement.className = tempElement.className;
  }
  
  // ì„ì‹œ ìš”ì†Œ ì œê±°
  document.body.removeChild(tempElement);
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
document.addEventListener('DOMContentLoaded', adjustCustomerReportAmountTextSize);

// ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ì¬ì¡°ì •
window.addEventListener('resize', adjustCustomerReportAmountTextSize);
</script>

<!-- ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ ëª¨ë‹¬ -->
<div class="modal fade" id="categoryModal" tabindex="-1" aria-labelledby="categoryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="categoryModalLabel">
          <i class="fas fa-tags me-2"></i>ì¹´í…Œê³ ë¦¬ ê´€ë¦¬
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <button type="button" class="btn btn-primary" onclick="showCategoryForm()">
            <i class="fas fa-plus me-1"></i>ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€
          </button>
        </div>
        
        <!-- ì¹´í…Œê³ ë¦¬ ì¶”ê°€/ìˆ˜ì • í¼ -->
        <div id="categoryFormContainer" style="display: none;" class="mb-4">
          <div class="card">
            <div class="card-body">
              <h6 class="card-title" id="categoryFormTitle">ìƒˆ ì¹´í…Œê³ ë¦¬</h6>
              <form id="categoryForm">
                {% csrf_token %}
                <input type="hidden" id="categoryId" name="category_id">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="categoryName" class="form-label">ì¹´í…Œê³ ë¦¬ëª… *</label>
                    <input type="text" class="form-control" id="categoryName" name="name" required>
                  </div>
                  <div class="col-md-6">
                    <label for="categoryParent" class="form-label">ìƒìœ„ ì¹´í…Œê³ ë¦¬</label>
                    <select class="form-select" id="categoryParent" name="parent_id">
                      <option value="">ì—†ìŒ (ìµœìƒìœ„ ì¹´í…Œê³ ë¦¬)</option>
                      {% for parent, children in categories_dict.items %}
                      <option value="{{ parent.id }}">{{ parent.name }}</option>
                      {% endfor %}
                    </select>
                    <small class="text-muted">í•˜ìœ„ ì¹´í…Œê³ ë¦¬ë¡œ ë§Œë“¤ë ¤ë©´ ìƒìœ„ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</small>
                  </div>
                  <div class="col-md-6">
                    <label for="categoryColor" class="form-label">ìƒ‰ìƒ</label>
                    <input type="color" class="form-control form-control-color" id="categoryColor" name="color" value="#007bff">
                  </div>
                  <div class="col-md-6">
                    <label for="categoryOrder" class="form-label">ì •ë ¬ìˆœì„œ</label>
                    <input type="number" class="form-control" id="categoryOrder" name="order" value="0">
                  </div>
                  <div class="col-12">
                    <label for="categoryDescription" class="form-label">ì„¤ëª…</label>
                    <textarea class="form-control" id="categoryDescription" name="description" rows="2"></textarea>
                  </div>
                  <div class="col-12">
                    <button type="submit" class="btn btn-primary me-2">
                      <i class="fas fa-save me-1"></i>ì €ì¥
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="hideCategoryForm()">
                      ì·¨ì†Œ
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
        
        <!-- ì¹´í…Œê³ ë¦¬ ëª©ë¡ -->
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th style="width: 50px;">ìƒ‰ìƒ</th>
                <th>ì¹´í…Œê³ ë¦¬ëª…</th>
                <th>ì„¤ëª…</th>
                <th>ìˆœì„œ</th>
                <th style="width: 150px;">ì‘ì—…</th>
              </tr>
            </thead>
            <tbody id="categoryList">
              {% for parent, children in categories_dict.items %}
              <tr data-category-id="{{ parent.id }}" style="font-weight: bold;">
                <td><span class="badge" style="background-color: {{ parent.color }};">&nbsp;&nbsp;&nbsp;</span></td>
                <td>
                  <i class="fas fa-folder me-1"></i>{{ parent.name }}
                  {% if children %}<span class="badge bg-secondary ms-2">{{ children|length }}</span>{% endif %}
                </td>
                <td><small class="text-muted">{{ parent.description|default:"-" }}</small></td>
                <td>{{ parent.order }}</td>
                <td>
                  <button class="btn btn-sm btn-outline-primary" onclick="editCategory({{ parent.id }}, '{{ parent.name }}', '{{ parent.color }}', {{ parent.order }}, '{{ parent.description|default:"" }}', '')">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory({{ parent.id }}, '{{ parent.name }}')">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
              {% for child in children %}
              <tr data-category-id="{{ child.id }}">
                <td><span class="badge" style="background-color: {{ child.color }};">&nbsp;&nbsp;&nbsp;</span></td>
                <td class="ps-4">
                  <i class="fas fa-file me-1"></i>{{ child.name }}
                </td>
                <td><small class="text-muted">{{ child.description|default:"-" }}</small></td>
                <td>{{ child.order }}</td>
                <td>
                  <button class="btn btn-sm btn-outline-primary" onclick="editCategory({{ child.id }}, '{{ child.name }}', '{{ child.color }}', {{ child.order }}, '{{ child.description|default:"" }}', '{{ parent.id }}')">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory({{ child.id }}, '{{ child.name }}')">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
              {% endfor %}
              {% empty %}
              <tr>
                <td colspan="5" class="text-center text-muted">ë“±ë¡ëœ ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ìƒ‰ìƒ ëª…ë„ ê³„ì‚°í•˜ì—¬ í…ìŠ¤íŠ¸ ìƒ‰ìƒ ê²°ì • (ë°ì€ ë°°ê²½ = ê²€ì€ìƒ‰, ì–´ë‘ìš´ ë°°ê²½ = í°ìƒ‰)
function getTextColorForBackground(hexColor) {
  // HEXë¥¼ RGBë¡œ ë³€í™˜
  const r = parseInt(hexColor.substr(1, 2), 16);
  const g = parseInt(hexColor.substr(3, 2), 16);
  const b = parseInt(hexColor.substr(5, 2), 16);
  
  // ëª…ë„ ê³„ì‚° (0~1 ì‚¬ì´ ê°’)
  const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
  
  // 0.5 ì´ìƒì´ë©´ ë°ì€ ìƒ‰ìƒì´ë¯€ë¡œ ê²€ì€ìƒ‰ í…ìŠ¤íŠ¸, ì•„ë‹ˆë©´ í°ìƒ‰
  return luminance > 0.5 ? '#000000' : '#ffffff';
}

// ëª¨ë“  ì¹´í…Œê³ ë¦¬ ë±ƒì§€ì— ì ì ˆí•œ í…ìŠ¤íŠ¸ ìƒ‰ìƒ ì ìš©
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.category-badge').forEach(badge => {
    const bgColor = badge.getAttribute('data-bg-color');
    if (bgColor) {
      badge.style.color = getTextColorForBackground(bgColor);
    }
  });
});

// ëª¨ë“  ì¹´í…Œê³ ë¦¬ ë°ì´í„° (ì„œë²„ì—ì„œ ì „ë‹¬)
const allCategories = [
  {% for parent, children in categories_dict.items %}
  { name: '{{ parent.name }}', color: '{{ parent.color }}' },
  {% for child in children %}
  { name: '{{ child.name }}', color: '{{ child.color }}' },
  {% endfor %}
  {% endfor %}
];

// ì¹´í…Œê³ ë¦¬ í¼ í‘œì‹œ/ìˆ¨ê¹€
function showCategoryForm() {
  document.getElementById('categoryFormContainer').style.display = 'block';
  document.getElementById('categoryFormTitle').textContent = 'ìƒˆ ì¹´í…Œê³ ë¦¬';
  document.getElementById('categoryForm').reset();
  document.getElementById('categoryId').value = '';
  
  // ëª¨ë“  ìƒìœ„ ì¹´í…Œê³ ë¦¬ ì˜µì…˜ í™œì„±í™”
  const parentSelect = document.getElementById('categoryParent');
  Array.from(parentSelect.options).forEach(option => {
    option.disabled = false;
    option.style.display = '';
  });
  
  // ì¹´í…Œê³ ë¦¬ëª… ì…ë ¥ ì‹œ ê°™ì€ ì´ë¦„ì˜ ìƒ‰ìƒ ìë™ ì ìš©
  const nameInput = document.getElementById('categoryName');
  const colorInput = document.getElementById('categoryColor');
  
  nameInput.addEventListener('blur', function autoFillColor() {
    const inputName = this.value.trim();
    if (inputName && !document.getElementById('categoryId').value) {
      // ìƒˆ ì¹´í…Œê³ ë¦¬ ìƒì„± ì‹œì—ë§Œ
      const existingCategory = allCategories.find(cat => cat.name === inputName);
      if (existingCategory) {
        colorInput.value = existingCategory.color;
      }
    }
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€)
    nameInput.removeEventListener('blur', autoFillColor);
  });
}

function hideCategoryForm() {
  document.getElementById('categoryFormContainer').style.display = 'none';
  document.getElementById('categoryForm').reset();
}

// ì¹´í…Œê³ ë¦¬ í¸ì§‘
function editCategory(id, name, color, order, description, parentId) {
  document.getElementById('categoryFormContainer').style.display = 'block';
  document.getElementById('categoryFormTitle').textContent = 'ì¹´í…Œê³ ë¦¬ ìˆ˜ì •';
  document.getElementById('categoryId').value = id;
  document.getElementById('categoryName').value = name;
  document.getElementById('categoryColor').value = color;
  document.getElementById('categoryOrder').value = order;
  document.getElementById('categoryDescription').value = description;
  document.getElementById('categoryParent').value = parentId || '';
  
  // ìê¸° ìì‹ ì„ ìƒìœ„ ì¹´í…Œê³ ë¦¬ë¡œ ì„ íƒí•  ìˆ˜ ì—†ë„ë¡ ì˜µì…˜ ë¹„í™œì„±í™”
  const parentSelect = document.getElementById('categoryParent');
  Array.from(parentSelect.options).forEach(option => {
    if (option.value == id) {
      option.disabled = true;
      option.style.display = 'none';
    } else {
      option.disabled = false;
      option.style.display = '';
    }
  });
}

// ì¹´í…Œê³ ë¦¬ ì €ì¥
document.getElementById('categoryForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const categoryId = document.getElementById('categoryId').value;
  const url = categoryId ? `/reporting/category/${categoryId}/update/` : '/reporting/category/create/';
  
  fetch(url, {
    method: 'POST',
    credentials: 'same-origin', // ì„¸ì…˜ ì¿ í‚¤ í¬í•¨
    headers: {
      'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
      'X-Requested-With': 'XMLHttpRequest' // AJAX ìš”ì²­ì„ì„ í‘œì‹œ
    },
    body: formData
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ' + response.status);
    }
    return response.json();
  })
  .then(data => {
    if (data.success) {
      alert(categoryId ? 'ì¹´í…Œê³ ë¦¬ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì¹´í…Œê³ ë¦¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
      location.reload();
    } else {
      alert('ì˜¤ë¥˜: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
  });
});

// ì¹´í…Œê³ ë¦¬ ì‚­ì œ
function deleteCategory(id, name) {
  if (!confirm(`"${name}" ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì¹´í…Œê³ ë¦¬ì— ì†í•œ ê³ ê°ë“¤ì€ ì¹´í…Œê³ ë¦¬ ì—†ìŒìœ¼ë¡œ ë³€ê²½ë©ë‹ˆë‹¤.`)) {
    return;
  }
  
  fetch(`/reporting/category/${id}/delete/`, {
    method: 'POST',
    credentials: 'same-origin', // ì„¸ì…˜ ì¿ í‚¤ í¬í•¨
    headers: {
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
      'X-Requested-With': 'XMLHttpRequest' // AJAX ìš”ì²­ì„ì„ í‘œì‹œ
    }
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ' + response.status);
    }
    return response.json();
  })
  .then(data => {
    if (data.success) {
      alert('ì¹´í…Œê³ ë¦¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
      location.reload();
    } else {
      alert('ì˜¤ë¥˜: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
  });
}

// ë¶€ì„œì— ì¹´í…Œê³ ë¦¬ í• ë‹¹
function assignDepartmentCategory(departmentId, categoryId, categoryName) {
  const formData = new FormData();
  formData.append('category_id', categoryId);
  
  fetch(`/reporting/departments/${departmentId}/assign-category/`, {
    method: 'POST',
    credentials: 'same-origin',
    headers: {
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
      'X-Requested-With': 'XMLHttpRequest'
    },
    body: formData
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ' + response.status);
    }
    return response.json();
  })
  .then(data => {
    if (data.success) {
      // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ UI ì—…ë°ì´íŠ¸
      location.reload();
    } else {
      alert('ì˜¤ë¥˜: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('ì¹´í…Œê³ ë¦¬ í• ë‹¹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
  });
}
</script>

{% endblock %}
