{% extends "reporting/base.html" %}
{% block title %}{{ page_title }} - 영업 보고 시스템{% endblock %}
{% block content %}

<div class="container-fluid">
  <div class="row justify-content-center">
    <div class="col-12">
      <!-- 헤더 섹션 -->
      <div class="page-header d-flex justify-content-between align-items-center mb-4">
        <h1 class="page-title mb-0">
          <i class="fas fa-chart-bar me-2"></i>{{ page_title }}
        </h1>
      </div>

      <!-- 전체 통계 카드 -->
      <div class="row mb-4">
        <div class="col-md-2-4">
          <div class="card text-center">
            <div class="card-body">
              <h6 class="card-title text-primary" style="font-size: 0.85rem;">
                <i class="fas fa-users"></i> 총 고객 수
              </h6>
              <h3 class="text-primary">{{ total_customers }}명</h3>
            </div>
          </div>
        </div>
        <div class="col-md-2-4">
          <div class="card text-center">
            <div class="card-body">
              <h6 class="card-title text-success" style="font-size: 0.85rem;">
                <i class="fas fa-handshake"></i> 총 미팅 수
              </h6>
              <h3 class="text-success">{{ total_meetings_sum }}회</h3>
            </div>
          </div>
        </div>
        <div class="col-md-2-4">
          <div class="card text-center">
            <div class="card-body">
              <h6 class="card-title text-info" style="font-size: 0.85rem;">
                <i class="fas fa-truck"></i> 총 납품 수
              </h6>
              <h3 class="text-info">{{ total_deliveries_sum }}건</h3>
            </div>
          </div>
        </div>
        <div class="col-md-2-4">
          <div class="card text-center">
            <div class="card-body">
              <h6 class="card-title text-warning" style="font-size: 0.85rem;">
                <i class="fas fa-won-sign"></i> 총 납품 금액
              </h6>
              <h3 class="text-warning" id="customer-report-total-amount">
                {% load currency_filters %}
                {{ total_amount_sum|currency_format }}원
              </h3>
            </div>
          </div>
        </div>
        <div class="col-md-2-4">
          <div class="card text-center">
            <div class="card-body">
              <h6 class="card-title text-danger" style="font-size: 0.85rem;">
                <i class="fas fa-exclamation-triangle" style="font-size: 0.8rem;"></i> 총 미결제건
              </h6>
              <h3 class="text-danger">{{ total_unpaid_sum }}건</h3>
            </div>
          </div>
        </div>
      </div>

      <!-- 검색 및 필터 섹션 -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-body">
              <h6 class="card-title mb-3">
                <i class="fas fa-search me-2"></i>검색 및 필터
              </h6>
              <form method="GET" action="{% url 'reporting:customer_report' %}">
                <div class="row g-3">
                  <!-- 검색어 -->
                  {% if user.userprofile.role in 'admin,manager' %}
                  <div class="col-md-6">
                  {% else %}
                  <div class="col-md-8">
                  {% endif %}
                    <label for="search" class="form-label">검색어</label>
                    <input 
                      type="text" 
                      class="form-control" 
                      id="search"
                      name="search" 
                      value="{{ search_query|default:'' }}"
                      placeholder="고객명, 업체명, 책임자..."
                    >
                  </div>
                  
                  <!-- 담당자 필터 (매니저/어드민만) -->
                  {% if user.userprofile.role in 'admin,manager' %}
                  <div class="col-md-2">
                    <label for="user" class="form-label">담당자</label>
                    <select class="form-control" id="user" name="user">
                      <option value="">전체</option>
                      {% for user_option in users %}
                      <option value="{{ user_option.id }}" {% if user_filter == user_option.id|stringformat:"s" %}selected{% endif %}>
                        {{ user_option.username }}
                      </option>
                      {% endfor %}
                    </select>
                  </div>
                  {% endif %}
                  
                  <!-- 버튼들 -->
                  <div class="col-md-4">
                    <label class="form-label">&nbsp;</label>
                    <div class="btn-group w-100">
                      <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i> 검색
                      </button>
                      <a href="{% url 'reporting:customer_report' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-times"></i> 초기화
                      </a>
                    </div>
                  </div>
                </div>
                
                <!-- 검색 결과 정보 -->
                {% if search_query or user_filter %}
                <div class="mt-3">
                  <small class="text-muted">
                    검색 결과: {{ total_customers }}건
                    {% if search_query %} | 검색어: "<strong>{{ search_query }}</strong>"{% endif %}
                    {% if selected_user %} | 담당자: <strong>{{ selected_user.username }}</strong>{% endif %}
                  </small>
                </div>
                {% endif %}
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- 고객 리포트 테이블 -->
      {% if followups %}
      <div class="row">
        <div class="col-12">
          <div class="card customer-report-table-card">
            <div class="card-body">
              <h6 class="card-title mb-3">
                <i class="fas fa-table me-2"></i>고객별 활동 요약
              </h6>
              <div class="table-responsive">
                <table class="table table-hover" id="customerTable">
                  <thead class="table-light">
                    <tr>
                      <th class="sortable" data-column="0" data-type="text">
                        고객정보 <i class="fas fa-sort sort-icon"></i>
                      </th>
                      <th class="text-center sortable" data-column="1" data-type="number">
                        미팅 횟수 <i class="fas fa-sort sort-icon"></i>
                      </th>
                      <th class="text-center sortable" data-column="2" data-type="number">
                        납품 횟수 <i class="fas fa-sort sort-icon"></i>
                      </th>
                      <th class="text-end sortable" data-column="3" data-type="currency">
                        총 납품 금액 <i class="fas fa-sort sort-icon"></i>
                      </th>
                      <th class="text-center sortable" data-column="4" data-type="number">
                        세금계산서 <i class="fas fa-sort sort-icon"></i>
                      </th>
                      <th class="text-center sortable" data-column="5" data-type="date">
                        최근 접촉일 <i class="fas fa-sort sort-icon"></i>
                      </th>
                      {% if user.userprofile.role in 'admin,manager' %}
                      <th class="text-center sortable" data-column="6" data-type="text">
                        담당자 <i class="fas fa-sort sort-icon"></i>
                      </th>
                      {% endif %}
                      <th class="text-center">액션</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for followup in followups %}
                    <tr>
                      <td>
                        <div class="customer-info">
                          <span class="customer-name">
                            <strong>{{ followup.customer_name|default:"고객명 미정" }}</strong>
                          </span>
                          <span class="company-info text-muted ms-2">
                            {{ followup.company.name }}{% if followup.department %} / {{ followup.department.name }}{% endif %}
                          </span>
                        </div>
                      </td>
                      <td class="text-center">
                        <span class="badge bg-primary">{{ followup.total_meetings }}회</span>
                      </td>
                      <td class="text-center">
                        <span class="badge bg-success">{{ followup.total_deliveries }}건</span>
                      </td>
                      <td class="text-end">
                        <strong class="text-warning">
                          {% if followup.total_amount %}
                            {% load currency_filters %}
                            {{ followup.total_amount|currency_format }}원
                          {% else %}
                            -
                          {% endif %}
                        </strong>
                      </td>
                      <td class="text-center">
                        {% if followup.tax_invoices_issued > 0 or followup.tax_invoices_pending > 0 %}
                          {% if followup.tax_invoices_issued > 0 %}
                            <span class="badge bg-primary me-1">발행 {{ followup.tax_invoices_issued }}건</span>
                          {% endif %}
                          {% if followup.tax_invoices_pending > 0 %}
                            <span class="badge bg-danger">미발행 {{ followup.tax_invoices_pending }}건</span>
                          {% endif %}
                        {% else %}
                          <span class="text-muted">-</span>
                        {% endif %}
                      </td>
                      <td class="text-center">
                        {% if followup.last_contact %}
                          <small>{{ followup.last_contact|date:"Y-m-d" }}</small>
                        {% else %}
                          <span class="text-muted">-</span>
                        {% endif %}
                      </td>
                      {% if user.userprofile.role in 'admin,manager' %}
                      <td class="text-center">
                        <small class="text-muted">{{ followup.user.username }}</small>
                      </td>
                      {% endif %}
                      <td class="text-center">
                        <div class="btn-group" role="group">
                          <a href="{% url 'reporting:customer_detail_report' followup.id %}" 
                             class="btn btn-sm btn-outline-primary" title="상세 리포트">
                            <i class="fas fa-chart-line"></i>
                          </a>
                          <a href="{% url 'reporting:followup_detail' followup.id %}" 
                             class="btn btn-sm btn-outline-info" title="고객 정보">
                            <i class="fas fa-user"></i>
                          </a>
                        </div>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% else %}
      <div class="row">
        <div class="col-12">
          <div class="alert alert-info text-center">
            <i class="fas fa-info-circle me-2"></i>
            {% if search_query or user_filter %}
              검색 조건에 맞는 고객이 없습니다.
            {% else %}
              등록된 고객이 없습니다.
            {% endif %}
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<style>
/* 전체 컨테이너 중앙 정렬 */
.container-fluid {
  max-width: 1400px; /* 최대 너비 설정 */
  margin: 0 auto; /* 중앙 정렬 */
  padding: 0 20px; /* 좌우 여백 */
}

/* 카드 컨테이너도 중앙 정렬 */
.row {
  justify-content: center;
}

.table td {
  vertical-align: middle;
}

/* 총 납품 금액 동적 텍스트 크기 조정 */
#customer-report-total-amount {
  transition: font-size 0.3s ease;
  word-wrap: break-word;
  word-break: keep-all;
  line-height: 1.2;
  min-height: 2.4rem;
  display: flex;
  align-items: center;
  justify-content: center;
}

#customer-report-total-amount.small-amount {
  font-size: 1.3rem !important;
}

#customer-report-total-amount.smaller-amount {
  font-size: 1.0rem !important;
}

#customer-report-total-amount.smallest-amount {
  font-size: 0.8rem !important;
}

/* 카드 body 조정 */
.card-body {
  min-height: 120px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  padding: 1rem 0.5rem;
}

/* 5개 카드 레이아웃을 위한 클래스 */
.col-md-2-4 {
  flex: 0 0 20%;
  max-width: 20%;
}

.badge {
  font-size: 0.75em;
}

/* 정렬 가능한 헤더 스타일 */
.sortable {
  cursor: pointer;
  user-select: none;
  position: relative;
  transition: background-color 0.2s;
}

.sortable:hover {
  background-color: rgba(0, 123, 255, 0.1);
}

.sort-icon {
  margin-left: 5px;
  opacity: 0.5;
  font-size: 0.8em;
}

.sortable.asc .sort-icon:before {
  content: "\f0de"; /* fa-sort-up */
  opacity: 1;
  color: #007bff;
}

.sortable.desc .sort-icon:before {
  content: "\f0dd"; /* fa-sort-down */
  opacity: 1;
  color: #007bff;
}

/* 테이블이 화면에 맞도록 자동 조정 */
.table {
  width: 100%;
  table-layout: auto;
  margin-bottom: 0;
  min-width: 100%; /* 카드 너비에 맞게 최소 너비 설정 */
}

/* 고객 리포트 테이블을 포함하는 카드 전용 스타일 */
.customer-report-table-card {
  width: max-content; /* 내용에 맞게 카드 크기 조정 */
  min-width: 100%;
  margin: 0 auto;
  overflow: visible;
}

.customer-report-table-card .card-body {
  padding: 0; /* 테이블이 카드 경계에 딱 맞도록 패딩 제거 */
  overflow: visible;
}

.customer-report-table-card .table-responsive {
  overflow: visible;
  margin: 0;
}

/* 테이블 헤더에 패딩 복원 */
.customer-report-table-card .card-body h6 {
  padding: 20px 20px 15px 20px;
  margin-bottom: 0;
}

/* 테이블 자체는 카드 내부에서 꽉 차게 */
.customer-report-table-card .table {
  margin: 0;
  border-radius: 0;
}

/* 테이블 반응형 스크롤 제거 */
.table-responsive {
  overflow-x: visible;
  margin: -1px; /* 테이블이 카드 경계에 딱 맞도록 */
}

/* 텍스트 오버플로우 처리 - 중요한 열만 적용 */
.table th,
.table td {
  padding: 12px 8px; /* 패딩 조정으로 공간 확보 */
}

/* 고객정보 열 - 한 줄 표시 */
.customer-info {
  min-width: 200px;
  display: flex;
  align-items: center;
  white-space: nowrap;
}

.customer-name {
  font-size: 14px;
  font-weight: 600;
}

.company-info {
  font-size: 13px;
  overflow: hidden;
  text-overflow: ellipsis;
  flex-shrink: 1;
}

.customer-info span {
  display: inline-block;
}

/* 고객정보가 너무 길 경우 말줄임 처리 */
.customer-info {
  overflow: hidden;
  text-overflow: ellipsis;
}

/* 숫자 열들은 더 작게 */
.table .text-center {
  white-space: nowrap;
}

/* 금액 열 */
.table .text-end {
  white-space: nowrap;
  min-width: 120px;
}

/* 액션 버튼 */
.btn-group {
  white-space: nowrap;
}

/* 통계 카드들도 중앙 정렬 */
.row.mb-4 {
  justify-content: center;
}

/* 검색 섹션도 중앙 정렬 */
.row.mb-4 .col-12 .card {
  max-width: 100%;
  margin: 0 auto;
}

/* 모바일에서는 스크롤 허용 */
@media (max-width: 768px) {
  .container-fluid {
    max-width: 100%;
    padding: 0 15px;
  }
  
  .table-responsive {
    overflow-x: auto;
  }
  
  .table {
    min-width: 700px;
  }
}

/* 큰 화면에서 컨테이너 최적화 */
@media (min-width: 1200px) {
  .container-fluid {
    max-width: 1600px; /* 큰 화면에서 더 넓게 */
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('customerTable');
    
    // 테이블이 존재하지 않으면 종료
    if (!table) {
        return;
    }
    
    const headers = table.querySelectorAll('.sortable');
    const isManager = {% if user.userprofile.role in 'admin,manager' %}true{% else %}false{% endif %};
    
    headers.forEach(header => {
        header.addEventListener('click', function() {
            const column = parseInt(this.dataset.column);
            const type = this.dataset.type;
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // 현재 정렬 상태 확인
            const isAsc = this.classList.contains('asc');
            
            // 모든 헤더에서 정렬 클래스 제거
            headers.forEach(h => h.classList.remove('asc', 'desc'));
            
            // 현재 헤더에 정렬 클래스 추가
            this.classList.add(isAsc ? 'desc' : 'asc');
            
            // 행 정렬
            rows.sort((a, b) => {
                let aVal = getCellValue(a, column, type);
                let bVal = getCellValue(b, column, type);
                
                if (type === 'number' || type === 'currency') {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                } else if (type === 'date') {
                    aVal = new Date(aVal || '1900-01-01');
                    bVal = new Date(bVal || '1900-01-01');
                }
                
                if (aVal < bVal) return isAsc ? 1 : -1;
                if (aVal > bVal) return isAsc ? -1 : 1;
                return 0;
            });
            
            // 정렬된 행들을 테이블에 다시 추가
            rows.forEach(row => tbody.appendChild(row));
        });
    });
    
    function getCellValue(row, column, type) {
        // 매니저가 아닌 경우 담당자 열이 없으므로 마지막 액션 열 제외하고 접근
        const cell = row.cells[column];
        if (!cell) return '';
        
        let value = cell.textContent.trim();
        
        if (type === 'number') {
            // 숫자 추출 (예: "5회" -> "5")
            const match = value.match(/(\d+)/);
            return match ? match[1] : '0';
        } else if (type === 'currency') {
            // 금액에서 숫자만 추출 (예: "1,000,000원" -> "1000000")
            if (value === '-') return '0';
            return value.replace(/[^\d]/g, '');
        } else if (type === 'date') {
            // 날짜 형식 처리 (예: "2024-01-15")
            if (value === '-') return '';
            return value;
        } else {
            // 텍스트의 경우 고객명만 추출
            if (column === 0) {
                const strongTag = cell.querySelector('strong');
                return strongTag ? strongTag.textContent.trim() : value;
            }
            return value;
        }
    }
});

// 총 납품 금액 동적 텍스트 크기 조정
function adjustCustomerReportAmountTextSize() {
  const amountElement = document.getElementById('customer-report-total-amount');
  if (!amountElement) return;
  
  const container = amountElement.parentElement;
  const maxWidth = container.offsetWidth - 20; // 패딩 고려
  
  // 초기 폰트 크기로 리셋
  amountElement.style.fontSize = '';
  amountElement.classList.remove('small-amount', 'smaller-amount', 'smallest-amount');
  
  // 임시로 컨테이너 밖에서 크기 측정
  const tempElement = amountElement.cloneNode(true);
  tempElement.style.position = 'absolute';
  tempElement.style.visibility = 'hidden';
  tempElement.style.width = 'auto';
  tempElement.style.whiteSpace = 'nowrap';
  document.body.appendChild(tempElement);
  
  let currentWidth = tempElement.offsetWidth;
  
  if (currentWidth > maxWidth) {
    // 1단계: 작게
    tempElement.classList.add('small-amount');
    currentWidth = tempElement.offsetWidth;
    
    if (currentWidth > maxWidth) {
      // 2단계: 더 작게
      tempElement.classList.remove('small-amount');
      tempElement.classList.add('smaller-amount');
      currentWidth = tempElement.offsetWidth;
      
      if (currentWidth > maxWidth) {
        // 3단계: 최소 크기
        tempElement.classList.remove('smaller-amount');
        tempElement.classList.add('smallest-amount');
      }
    }
    
    // 원본 요소에 클래스 적용
    amountElement.className = tempElement.className;
  }
  
  // 임시 요소 제거
  document.body.removeChild(tempElement);
}

// 페이지 로드 시 실행
document.addEventListener('DOMContentLoaded', adjustCustomerReportAmountTextSize);

// 윈도우 리사이즈 시 재조정
window.addEventListener('resize', adjustCustomerReportAmountTextSize);
</script>

{% endblock %}
