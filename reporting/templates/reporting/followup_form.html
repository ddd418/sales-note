{% extends "reporting/base.html" %} 
{% block title %}{{ page_title }} - 영업 보고 시스템{% endblock %} 
{% block content %}

<style>
/* 프리미엄 페이지 헤더 */
.followup-form-page-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2.5rem 2rem;
    border-radius: 16px;
    margin-bottom: 2rem;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
}

.followup-form-page-header h1 {
    font-size: 2rem;
    font-weight: 700;
    margin: 0 0 0.5rem 0;
    color: white;
}

.followup-form-page-header p {
    margin: 0;
    opacity: 0.95;
    font-size: 1rem;
}

/* 프리미엄 폼 카드 */
.premium-form-card {
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    overflow: hidden;
    margin-bottom: 2rem;
}

.premium-form-section {
    padding: 2rem;
    border-bottom: 1px solid #f0f0f0;
}

.premium-form-section:last-child {
    border-bottom: none;
}

.premium-form-section h3 {
    font-size: 1.25rem;
    font-weight: 700;
    color: #2d3748;
    margin-bottom: 1.5rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid #667eea;
    display: inline-block;
}

/* 폼 그리드 레이아웃 */
.form-grid-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
}

.form-grid-1 {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
}

/* 프리미엄 폼 그룹 */
.premium-form-group {
    margin-bottom: 1.5rem;
}

.premium-form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #2d3748;
    font-size: 0.95rem;
}

.premium-form-group label .required {
    color: #e53e3e;
    margin-left: 0.25rem;
}

.premium-form-group .form-help {
    display: block;
    margin-top: 0.5rem;
    font-size: 0.85rem;
    color: #718096;
}

.premium-form-group .input-wrapper {
    position: relative;
}

/* 프리미엄 인풋 스타일 */
.premium-input {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    font-size: 0.95rem;
    color: #2d3748;
    background-color: #ffffff;
    transition: all 0.3s ease;
}

.premium-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.premium-input:disabled {
    background-color: #f7fafc;
    cursor: not-allowed;
    opacity: 0.6;
}

/* 프리미엄 Select */
select.premium-input {
    cursor: pointer;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23667eea' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    background-size: 12px;
    padding-right: 2.5rem;
    appearance: none;
}

/* 프리미엄 Textarea */
textarea.premium-input {
    min-height: 120px;
    resize: vertical;
    font-family: inherit;
}

/* 인풋 아이콘 버튼 */
.input-icon-btn {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    padding: 0.375rem 0.75rem;
    font-size: 0.75rem;
    border: 1px solid #667eea;
    background: white;
    color: #667eea;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 600;
}

.input-icon-btn:hover {
    background: #667eea;
    color: white;
    transform: translateY(-50%) translateY(-1px);
}

.input-icon-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* 자동완성 제안 */
.autocomplete-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 2px solid #667eea;
    border-top: none;
    border-radius: 0 0 10px 10px;
    max-height: 250px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 10px 25px rgba(102, 126, 234, 0.2);
    margin-top: -2px;
}

.autocomplete-suggestion {
    padding: 0.875rem 1rem;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    transition: all 0.2s ease;
    font-size: 0.95rem;
    color: #2d3748;
}

.autocomplete-suggestion:hover,
.autocomplete-suggestion.active {
    background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
    color: #667eea;
    font-weight: 500;
}

.autocomplete-suggestion:last-child {
    border-bottom: none;
}

.autocomplete-no-results {
    padding: 1rem;
    color: #718096;
    font-style: italic;
    text-align: center;
}

/* 에러 메시지 */
.premium-error-box {
    background: linear-gradient(135deg, #fee 0%, #fcc 100%);
    color: #c62828;
    padding: 1.25rem 1.5rem;
    border-radius: 12px;
    margin-bottom: 2rem;
    border-left: 4px solid #f44336;
    box-shadow: 0 4px 12px rgba(244, 67, 54, 0.15);
}

.premium-error-box strong {
    display: block;
    font-size: 1.1rem;
    margin-bottom: 0.75rem;
}

.premium-error-box ul {
    margin: 0;
    padding-left: 1.5rem;
}

.premium-error-box li {
    margin: 0.5rem 0;
}

/* 프리미엄 버튼 */
.btn-premium-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 0.875rem 2.5rem;
    border-radius: 10px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.btn-premium-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

.btn-premium-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.btn-premium-secondary {
    background: white;
    color: #667eea;
    border: 2px solid #667eea;
    padding: 0.875rem 2rem;
    border-radius: 10px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-premium-secondary:hover {
    background: #667eea;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
}

/* 폼 액션 */
.form-actions {
    text-align: center;
    padding: 2rem;
    gap: 1rem;
    display: flex;
    justify-content: center;
    align-items: center;
}

/* 반응형 */
@media (max-width: 768px) {
    .form-grid-2 {
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }
    
    .followup-form-page-header {
        padding: 2rem 1.5rem;
    }
    
    .followup-form-page-header h1 {
        font-size: 1.5rem;
    }
    
    .premium-form-section {
        padding: 1.5rem;
    }
    
    .form-actions {
        flex-direction: column;
        padding: 1.5rem;
    }
    
    .btn-premium-primary,
    .btn-premium-secondary {
        width: 100%;
    }
}
</style>

<div class="followup-form-page-header">
    <h1>
        <i class="fas fa-user-plus me-2"></i>
        {{ page_title }}
    </h1>
    <p>
        {% if followup %}
        팔로우업 정보를 수정합니다
        {% else %}
        새로운 팔로우업을 등록합니다
        {% endif %}
    </p>
</div>

<div class="premium-form-card">
  <form method="post">
    {% csrf_token %} 
    
    {% if form.errors %}
    <div class="premium-form-section">
      <div class="premium-error-box">
        <strong><i class="fas fa-exclamation-triangle me-2"></i>오류가 발생했습니다:</strong>
        <ul>
          {% for field, errors in form.errors.items %} 
          {% for error in errors %}
          <li>{{ error }}</li>
          {% endfor %} 
          {% endfor %}
        </ul>
      </div>
    </div>
    {% endif %}

    <!-- 기본 정보 섹션 -->
    <div class="premium-form-section">
      <div class="form-grid-2">
        <div>
          <h3><i class="fas fa-info-circle me-2"></i>기본 정보</h3>
          
          <div class="premium-form-group">
            <label for="id_customer_name">
              고객명
            </label>
            <input type="text" id="id_customer_name" name="customer_name" 
                   value="{{ form.customer_name.value|default:'' }}"
                   class="premium-input" placeholder="고객명을 입력하세요">
            <small class="form-help">선택사항입니다</small>
          </div>

          <div class="premium-form-group">
            <label for="company-search">
              업체/학교명 <span class="required">*</span>
            </label>
            <div class="input-wrapper">
              <input type="text" id="company-search" class="premium-input" 
                     placeholder="업체/학교명을 입력하세요..." autocomplete="off">
              <input type="hidden" id="id_company" name="company" value="{{ form.company.value|default:'' }}">
              <div id="company-suggestions" class="autocomplete-suggestions" style="display: none;"></div>
              <button type="button" id="add-new-company" class="input-icon-btn">
                <i class="fas fa-plus me-1"></i>새로 추가
              </button>
            </div>
          </div>

          <div class="premium-form-group">
            <label for="department-search">
              부서/연구실명
            </label>
            <div class="input-wrapper">
              <input type="text" id="department-search" class="premium-input" 
                     placeholder="먼저 업체/학교를 선택하세요..." autocomplete="off" disabled>
              <input type="hidden" id="id_department" name="department" value="{{ form.department.value|default:'' }}">
              <div id="department-suggestions" class="autocomplete-suggestions" style="display: none;"></div>
              <button type="button" id="add-new-department" class="input-icon-btn" style="display: none;">
                <i class="fas fa-plus me-1"></i>새로 추가
              </button>
            </div>
          </div>
        </div>

        <div>
          <h3><i class="fas fa-address-book me-2"></i>연락처 정보</h3>
          
          <div class="premium-form-group">
            <label for="id_manager">
              담당자
            </label>
            <input type="text" id="id_manager" name="manager" 
                   value="{{ form.manager.value|default:'' }}"
                   class="premium-input" placeholder="담당자명을 입력하세요">
            <small class="form-help">선택사항입니다</small>
          </div>

          <div class="premium-form-group">
            <label for="id_phone_number">
              전화번호
            </label>
            <input type="text" id="id_phone_number" name="phone_number" 
                   value="{{ form.phone_number.value|default:'' }}"
                   class="premium-input" placeholder="010-1234-5678">
            <small class="form-help">선택사항입니다</small>
          </div>

          <div class="premium-form-group">
            <label for="id_email">
              이메일
            </label>
            <input type="email" id="id_email" name="email" 
                   value="{{ form.email.value|default:'' }}"
                   class="premium-input" placeholder="example@email.com">
            <small class="form-help">선택사항입니다</small>
          </div>
        </div>
      </div>
    </div>

    <!-- 상태 정보 섹션 -->
    <div class="premium-form-section">
      <h3><i class="fas fa-tasks me-2"></i>상태 정보</h3>
      
      <div class="form-grid-1">
        <div class="premium-form-group">
          <label for="id_priority">
            우선순위 <span class="required">*</span>
          </label>
          {{ form.priority }}
        </div>
      </div>
    </div>

    <!-- 추가 정보 섹션 -->
    <div class="premium-form-section">
      <h3><i class="fas fa-clipboard me-2"></i>추가 정보</h3>
      
      <div class="form-grid-1">
        <div class="premium-form-group">
          <label for="id_address">
            주소
          </label>
          <input type="text" id="id_address" name="address" 
                 value="{{ form.address.value|default:'' }}"
                 class="premium-input" placeholder="주소를 입력하세요">
          <small class="form-help">선택사항입니다</small>
        </div>

        <div class="premium-form-group">
          <label for="id_notes">
            상세 내용
          </label>
          <textarea id="id_notes" name="notes" class="premium-input" 
                    placeholder="팔로우업에 대한 상세 내용을 입력하세요">{{ form.notes.value|default:'' }}</textarea>
          <small class="form-help">팔로우업에 대한 상세 내용을 입력하세요 (선택사항)</small>
        </div>
      </div>
    </div>

    <!-- 폼 액션 -->
    <div class="form-actions">
      <button type="submit" class="btn-premium-primary">
        <i class="fas fa-save me-2"></i>
        {% if followup %}수정하기{% else %}생성하기{% endif %}
      </button>
      {% if followup %}
      <a href="{% url 'reporting:followup_detail' followup.pk %}" class="btn-premium-secondary">
        <i class="fas fa-times me-2"></i>취소
      </a>
      {% else %}
      <a href="{% url 'reporting:followup_list' %}" class="btn-premium-secondary">
        <i class="fas fa-times me-2"></i>취소
      </a>
      {% endif %}
    </div>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // CSRF 토큰 가져오기
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');

    // Select 요소에 premium-input 클래스 추가
    document.querySelectorAll('select').forEach(select => {
        select.classList.add('premium-input');
    });

    // 자동완성 기능 구현
    function setupAutocomplete(inputId, suggestionsId, hiddenInputId, apiUrl, onSelect, minLength = 1) {
        const input = document.getElementById(inputId);
        const suggestions = document.getElementById(suggestionsId);
        const hiddenInput = document.getElementById(hiddenInputId);
        let timeoutId = null;
        let currentSelectedIndex = -1;
        let suggestionItems = [];

        input.addEventListener('input', function() {
            const query = this.value.trim();
            currentSelectedIndex = -1;
            
            if (query.length < minLength) {
                suggestions.style.display = 'none';
                hiddenInput.value = '';
                return;
            }

            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => {
                fetch(`${apiUrl}?q=${encodeURIComponent(query)}${apiUrl.includes('department') && selectedCompanyId ? '&company_id=' + selectedCompanyId : ''}`)
                    .then(response => response.json())
                    .then(data => {
                        suggestions.innerHTML = '';
                        suggestionItems = [];
                        
                        if (data.results && data.results.length > 0) {
                            data.results.forEach((item, index) => {
                                const div = document.createElement('div');
                                div.className = 'autocomplete-suggestion';
                                div.textContent = item.text;
                                div.addEventListener('click', () => {
                                    selectItem(item);
                                });
                                suggestions.appendChild(div);
                                suggestionItems.push(item);
                            });
                            suggestions.style.display = 'block';
                        } else {
                            const div = document.createElement('div');
                            div.className = 'autocomplete-no-results';
                            div.innerHTML = '<i class="fas fa-search me-2"></i>검색 결과가 없습니다.';
                            suggestions.appendChild(div);
                            suggestions.style.display = 'block';
                        }
                    })
                    .catch(error => {
                        suggestions.style.display = 'none';
                    });
            }, 300);
        });

        // 키보드 이벤트 처리
        input.addEventListener('keydown', function(e) {
            const suggestionElements = suggestions.querySelectorAll('.autocomplete-suggestion:not(.autocomplete-no-results)');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                currentSelectedIndex = Math.min(currentSelectedIndex + 1, suggestionElements.length - 1);
                updateSelection(suggestionElements);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                currentSelectedIndex = Math.max(currentSelectedIndex - 1, -1);
                updateSelection(suggestionElements);
            } else if (e.key === 'Enter') {
                if (suggestions.style.display === 'block' && currentSelectedIndex >= 0 && suggestionItems[currentSelectedIndex]) {
                    e.preventDefault();
                    selectItem(suggestionItems[currentSelectedIndex]);
                }
            } else if (e.key === 'Escape') {
                suggestions.style.display = 'none';
                currentSelectedIndex = -1;
            }
        });

        function updateSelection(elements) {
            elements.forEach((el, index) => {
                if (index === currentSelectedIndex) {
                    el.classList.add('active');
                } else {
                    el.classList.remove('active');
                }
            });
        }

        function selectItem(item) {
            input.value = apiUrl.includes('department') ? item.department_name : item.text;
            hiddenInput.value = item.id;
            suggestions.style.display = 'none';
            currentSelectedIndex = -1;
            if (onSelect) onSelect(item);
        }

        // 외부 클릭 시 자동완성 숨기기
        document.addEventListener('click', function(e) {
            if (!input.contains(e.target) && !suggestions.contains(e.target)) {
                suggestions.style.display = 'none';
                currentSelectedIndex = -1;
            }
        });
    }

    let selectedCompanyId = null;

    // 회사 자동완성 설정
    setupAutocomplete('company-search', 'company-suggestions', 'id_company', '/reporting/api/companies/autocomplete/', function(item) {
        selectedCompanyId = item.id;
        // 부서 입력 활성화
        const deptInput = document.getElementById('department-search');
        const deptAddBtn = document.getElementById('add-new-department');
        deptInput.disabled = false;
        deptInput.placeholder = '부서/연구실명을 입력하세요...';
        deptAddBtn.style.display = 'block';
        
        // 기존 부서 선택 초기화
        document.getElementById('department-search').value = '';
        document.getElementById('id_department').value = '';
    });

    // 부서 자동완성 설정
    setupAutocomplete('department-search', 'department-suggestions', 'id_department', '/reporting/api/departments/autocomplete/');

    // 새 회사 추가 기능
    document.getElementById('add-new-company').addEventListener('click', function() {
        const companyName = document.getElementById('company-search').value.trim();
        if (!companyName) {
            alert('업체/학교명을 입력해주세요.');
            return;
        }

        const formData = new FormData();
        formData.append('name', companyName);

        // 버튼 비활성화
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>처리중...';

        fetch('/reporting/api/companies/create/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrftoken,
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                document.getElementById('id_company').value = data.company.id;
                selectedCompanyId = data.company.id;
                
                // 부서 입력 활성화
                const deptInput = document.getElementById('department-search');
                const deptAddBtn = document.getElementById('add-new-department');
                deptInput.disabled = false;
                deptInput.placeholder = '부서/연구실명을 입력하세요...';
                deptAddBtn.style.display = 'block';
                
                alert(data.message);
            } else {
                alert(data.error || '오류가 발생했습니다.');
            }
        })
        .catch(error => {
            alert('서버와의 통신 중 오류가 발생했습니다. 다시 시도해주세요.');
        })
        .finally(() => {
            // 버튼 다시 활성화
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-plus me-1"></i>새로 추가';
        });
    });

    // 새 부서 추가 기능
    document.getElementById('add-new-department').addEventListener('click', function() {
        const departmentName = document.getElementById('department-search').value.trim();
        if (!departmentName) {
            alert('부서/연구실명을 입력해주세요.');
            return;
        }
        
        if (!selectedCompanyId) {
            alert('먼저 업체/학교를 선택해주세요.');
            return;
        }

        const formData = new FormData();
        formData.append('name', departmentName);
        formData.append('company_id', selectedCompanyId);

        // 버튼 비활성화
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>처리중...';

        fetch('/reporting/api/departments/create/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrftoken,
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                document.getElementById('id_department').value = data.department.id;
                alert(data.message);
            } else {
                alert(data.error || '오류가 발생했습니다.');
            }
        })
        .catch(error => {
            alert('서버와의 통신 중 오류가 발생했습니다. 다시 시도해주세요.');
        })
        .finally(() => {
            // 버튼 다시 활성화
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-plus me-1"></i>새로 추가';
        });
    });

    // 폼 제출 시 처리
    document.querySelector('form').addEventListener('submit', function(e) {
        const submitBtn = this.querySelector('button[type="submit"]');
        
        // 제출 버튼 비활성화 (중복 제출 방지)
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>처리중...';
            
            // 3초 후에 다시 활성화 (네트워크 오류 등을 대비)
            setTimeout(function() {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>{% if followup %}수정하기{% else %}생성하기{% endif %}';
                }
            }, 3000);
        }
        
        return true;
    });

    // 폼 수정 시 기존 값 설정 또는 POST 데이터 복원
    {% if followup %}
        {% if followup.company %}
            document.getElementById('company-search').value = '{{ followup.company.name|escapejs }}';
            selectedCompanyId = {{ followup.company.id }};
            
            // 부서 입력 활성화
            const deptInput = document.getElementById('department-search');
            const deptAddBtn = document.getElementById('add-new-department');
            deptInput.disabled = false;
            deptInput.placeholder = '부서/연구실명을 입력하세요...';
            deptAddBtn.style.display = 'block';
        {% endif %}
        
        {% if followup.department %}
            document.getElementById('department-search').value = '{{ followup.department.name|escapejs }}';
        {% endif %}
    {% else %}
        // POST 데이터 복원 (유효성 검사 실패 시)
        {% if form.company.value %}
            // 회사 정보 복원
            fetch('/reporting/api/companies/{{ form.company.value }}/')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('company-search').value = data.company.name;
                        selectedCompanyId = data.company.id;
                        
                        // 부서 입력 활성화
                        const deptInput = document.getElementById('department-search');
                        const deptAddBtn = document.getElementById('add-new-department');
                        deptInput.disabled = false;
                        deptInput.placeholder = '부서/연구실명을 입력하세요...';
                        deptAddBtn.style.display = 'block';
                    }
                })
        {% endif %}
        
        {% if form.department.value %}
            // 부서 정보 복원
            fetch('/reporting/api/departments/{{ form.department.value }}/')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('department-search').value = data.department.name;
                    }
                })
        {% endif %}
    {% endif %}
});
</script>
{% endblock %}
